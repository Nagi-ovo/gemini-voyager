{"type":"file-history-snapshot","messageId":"c6697242-b4f3-44c2-a763-d68840cb8cee","snapshot":{"messageId":"c6697242-b4f3-44c2-a763-d68840cb8cee","trackedFileBackups":{},"timestamp":"2026-02-15T23:59:29.112Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","type":"progress","data":{"type":"hook_progress","hookEvent":"SessionStart","hookName":"SessionStart:startup","command":"entire hooks claude-code session-start"},"parentToolUseID":"eda5fd8e-e342-487c-93db-d997f32f95fb","toolUseID":"eda5fd8e-e342-487c-93db-d997f32f95fb","timestamp":"2026-02-15T23:51:29.139Z","uuid":"4aa01a02-6481-4730-a877-266808d0c535"}
{"parentUuid":"4aa01a02-6481-4730-a877-266808d0c535","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","type":"user","message":{"role":"user","content":"æ›´æ–° CLAUDE.mdã€‚æ›´æ–°ååŒæ­¥ AGENTS.md"},"uuid":"c6697242-b4f3-44c2-a763-d68840cb8cee","timestamp":"2026-02-15T23:59:26.029Z","thinkingMetadata":{"maxThinkingTokens":31999},"todos":[],"permissionMode":"default"}
{"parentUuid":"c6697242-b4f3-44c2-a763-d68840cb8cee","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","message":{"model":"claude-opus-4-6","id":"msg_01Mw4m3bBbsxRnBnrrrhMFE7","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6326,"cache_read_input_tokens":17862,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6326},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmE1oijxbf9dVbCyzBm","type":"assistant","uuid":"09a30996-116a-4361-96c2-86dea1d61260","timestamp":"2026-02-15T23:59:31.402Z"}
{"parentUuid":"09a30996-116a-4361-96c2-86dea1d61260","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","message":{"model":"claude-opus-4-6","id":"msg_01Mw4m3bBbsxRnBnrrrhMFE7","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to update CLAUDE.md and then sync it with AGENTS.md. Let me first read both files to understand their current state.","signature":"Eq8CCkYICxgCKkDsyRrDpbFHvidbTvPvv7nagQcf440P7qRP0MzSuOf3RVf557TRMBf509A9LAbjojFshFGTIE8IWVxzBuJm0hI0EgzCyBVrtXMo1B7YOB0aDKclu7nGrov5qAv7EyIwE3ZDQsCclIUmC7rmf7kUa7LWVLJDPCW9SXOBQ0cDIrcDMm/b8WUn0GU8pc2dauzCKpYBQnKTQ3D4lcgt4TbsJiZEgNTNPBymbOdzBZ6qlPyecxPtxwXxgcs0xHZqBHUaiyOvJWj2mEzRB9R1XZtyyUVkOvZJWRVn+rsgWbblwl8bu7t9etHwrz0ToMReYD3aOCMn9PDQkEKygQP6SLmwiY6+4cITyRspt3cIDNQQu+UbdZYYbsbWF0CfFGtlRLCrKuwTVdoNL8stGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6326,"cache_read_input_tokens":17862,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6326},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmE1oijxbf9dVbCyzBm","type":"assistant","uuid":"ec20231b-743a-42ab-9caa-33a247f9a1ec","timestamp":"2026-02-15T23:59:31.888Z"}
{"parentUuid":"ec20231b-743a-42ab-9caa-33a247f9a1ec","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","message":{"model":"claude-opus-4-6","id":"msg_01Mw4m3bBbsxRnBnrrrhMFE7","type":"message","role":"assistant","content":[{"type":"text","text":"Let me read both files first."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6326,"cache_read_input_tokens":17862,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6326},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmE1oijxbf9dVbCyzBm","type":"assistant","uuid":"5f43cce4-c3e1-4cc6-afe9-575b04f608d3","timestamp":"2026-02-15T23:59:32.132Z"}
{"parentUuid":"5f43cce4-c3e1-4cc6-afe9-575b04f608d3","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01Mw4m3bBbsxRnBnrrrhMFE7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01He1LmW2WC3fyTVT5jicqo1","name":"Read","input":{"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6326,"cache_read_input_tokens":17862,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6326},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmE1oijxbf9dVbCyzBm","type":"assistant","uuid":"6182e7fd-290c-4597-88e9-4cc1abb75ec8","timestamp":"2026-02-15T23:59:33.174Z"}
{"parentUuid":"6182e7fd-290c-4597-88e9-4cc1abb75ec8","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01He1LmW2WC3fyTVT5jicqo1","toolUseID":"toolu_01He1LmW2WC3fyTVT5jicqo1","timestamp":"2026-02-15T23:59:33.188Z","uuid":"7cabe08e-fa2f-4d6d-8e2c-9e0721a9f812"}
{"parentUuid":"6182e7fd-290c-4597-88e9-4cc1abb75ec8","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01He1LmW2WC3fyTVT5jicqo1","type":"tool_result","content":"     1â†’# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n     2â†’\n     3â†’> **Last Updated**: 2026-02-09\n     4â†’> **Version**: 1.2.2\n     5â†’> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n     6â†’\n     7â†’---\n     8â†’\n     9â†’## 1. Role & Core Mandates\n    10â†’\n    11â†’**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n    12â†’\n    13â†’**Core Mandates**:\n    14â†’\n    15â†’1.  **Safety First**: Never commit secrets. Validate all system operations.\n    16â†’2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n    17â†’3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n    18â†’4.  **Testing**: Every feature and fix must include tests.\n    19â†’5.  **Documentation**: Keep documentation and translations in sync with code changes.\n    20â†’\n    21â†’---\n    22â†’\n    23â†’## 2. Operational Methodology\n    24â†’\n    25â†’Before writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n    26â†’\n    27â†’### Phase 1: The Three Questions\n    28â†’\n    29â†’Ask yourself before starting:\n    30â†’\n    31â†’1.  **\"Is this a real problem?\"** - Reject over-engineering.\n    32â†’2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n    33â†’3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n    34â†’\n    35â†’### Phase 2: Requirements Analysis\n    36â†’\n    37â†’When analyzing a request:\n    38â†’\n    39â†’1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    40â†’    - What is the core data? Who owns it?\n    41â†’    - Can we redesign data structures to eliminate branches/complexity?\n    42â†’2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    43â†’    - Identify `if/else` branches that patch bad design.\n    44â†’    - Refactor to make the \"special case\" the normal case.\n    45â†’3.  **Destructive Analysis**:\n    46â†’    - List all existing features that might be affected.\n    47â†’    - Ensure zero destructiveness to user data (especially `localStorage`).\n    48â†’\n    49â†’### Phase 3: Decision Output\n    50â†’\n    51â†’If a task is complex or ambiguous, present your analysis in this format:\n    52â†’\n    53â†’```text\n    54â†’ã€Core Judgmentã€‘\n    55â†’âœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n    56â†’\n    57â†’ã€Key Insightsã€‘\n    58â†’- Data structure: [most critical data relationships]\n    59â†’- Complexity: [complexity that can be eliminated]\n    60â†’- Risks: [potential breaking changes]\n    61â†’\n    62â†’ã€Planã€‘\n    63â†’1. Simplify data structures...\n    64â†’2. Eliminate special cases...\n    65â†’3. Implementation steps...\n    66â†’```\n    67â†’\n    68â†’---\n    69â†’\n    70â†’## 3. Tool Usage & Verification Protocols\n    71â†’\n    72â†’Strictly adhere to these protocols to prevent errors and ensure data integrity.\n    73â†’\n    74â†’### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n    75â†’\n    76â†’1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    77â†’    - _Tool_: `read_file`\n    78â†’2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    79â†’    - _Tool_: `write_file` or `replace`\n    80â†’3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    81â†’    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n    82â†’\n    83â†’### ğŸš¨ Critical Safety Checks\n    84â†’\n    85â†’- **Never** modify `dist_*` folders directly.\n    86â†’- **Never** commit `.env` or secrets.\n    87â†’- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n    88â†’- **Always** run `bun run lint` before finishing.\n    89â†’\n    90â†’---\n    91â†’\n    92â†’## 4. Module Glossary & Complexity Hotspots\n    93â†’\n    94â†’| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n    95â†’| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n    96â†’| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n    97â†’| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n    98â†’| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n    99â†’| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n   100â†’| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n   101â†’| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n   102â†’| `pages/content`                        | **DOM Injection** (22 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n   103â†’| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n   104â†’| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n   105â†’\n   106â†’---\n   107â†’\n   108â†’## 5. Development Standards & Anti-Patterns\n   109â†’\n   110â†’### âœ… DOs\n   111â†’\n   112â†’- **Prefer Plain Objects**: Use interfaces/types for data structures.\n   113â†’- **Immutability**: Use `map`, `filter`, `reduce`.\n   114â†’- **Encapsulation**: Use `private`/`protected` in classes.\n   115â†’- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n   116â†’- **Named Exports**: `export function X` (easier refactoring).\n   117â†’- **Functional React**: Hooks at top level, strictly functional components.\n   118â†’\n   119â†’### âŒ DON'Ts (Anti-Patterns)\n   120â†’\n   121â†’- **Global State Pollution**: Never use global variables outside of defined Services.\n   122â†’- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n   123â†’- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n   124â†’- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n   125â†’- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n   126â†’- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n   127â†’\n   128â†’---\n   129â†’\n   130â†’## 6. Testing Strategy\n   131â†’\n   132â†’**Framework**: Vitest 4.0.6 (jsdom environment)\n   133â†’\n   134â†’### TDD Workflow Guidelines\n   135â†’\n   136â†’1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n   137â†’2.  **Fail**: Ensure the test fails (validates the test itself).\n   138â†’3.  **Implement**: Write the minimal code to pass the test.\n   139â†’4.  **Refactor**: Clean up the code while keeping tests green.\n   140â†’\n   141â†’### Mocking Patterns\n   142â†’\n   143â†’This project relies heavily on `vi.mock` for Chrome APIs and external services.\n   144â†’\n   145â†’**Mocking Chrome API**:\n   146â†’The global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n   147â†’\n   148â†’```typescript\n   149â†’// Example: Mocking specific storage behavior for a test\n   150â†’beforeEach(() => {\n   151â†’  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n   152â†’});\n   153â†’```\n   154â†’\n   155â†’**Running Tests**:\n   156â†’\n   157â†’```bash\n   158â†’bun run test                # Run all tests\n   159â†’bun run test <filename>     # Run specific test file\n   160â†’bun run test:watch          # Interactive mode\n   161â†’bun run test:coverage       # Check coverage\n   162â†’```\n   163â†’\n   164â†’---\n   165â†’\n   166â†’## 7. Workflows & Definition of Done\n   167â†’\n   168â†’### Setup\n   169â†’\n   170â†’```bash\n   171â†’bun install\n   172â†’```\n   173â†’\n   174â†’### Development\n   175â†’\n   176â†’```bash\n   177â†’# Start Dev Server\n   178â†’bun run dev:chrome\n   179â†’bun run dev:firefox\n   180â†’bun run dev:safari\n   181â†’\n   182â†’# Build for production\n   183â†’bun run build:chrome\n   184â†’bun run build:firefox\n   185â†’bun run build:safari\n   186â†’bun run build:edge        # Repackages Chrome build for Edge\n   187â†’bun run build:all         # Build all platforms\n   188â†’\n   189â†’# Documentation site (VitePress)\n   190â†’bun run docs:dev\n   191â†’bun run docs:build\n   192â†’```\n   193â†’\n   194â†’_Note: Uses Nodemon for hot-reloading content scripts._\n   195â†’\n   196â†’### Commit Messages (commitlint)\n   197â†’\n   198â†’Use Conventional Commits format:\n   199â†’\n   200â†’```\n   201â†’<type>(<scope>): <imperative summary>\n   202â†’```\n   203â†’\n   204â†’- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n   205â†’- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n   206â†’- summary: lowercase, imperative, no trailing period\n   207â†’\n   208â†’Examples:\n   209â†’\n   210â†’- `fix(copy): handle clipboard fallback`\n   211â†’- `refactor(copy): introduce temml to convert tex2mathml`\n   212â†’- `chore: update sponsors.svg`\n   213â†’\n   214â†’### Definition of Done (DoD)\n   215â†’\n   216â†’Before claiming a task is complete, verify:\n   217â†’\n   218â†’1.  **Functionality**: Does it meet the requirements?\n   219â†’2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n   220â†’3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n   221â†’4.  **Linting**: Code formatted and linted (`bun run lint`)?\n   222â†’5.  **Build**: Does it build without error (`bun run build`)?\n   223â†’6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n   224â†’\n   225â†’---\n   226â†’\n   227â†’## 8. Repository Structure & File Map\n   228â†’\n   229â†’```\n   230â†’gemini-voyager/\n   231â†’â”œâ”€â”€ src/\n   232â†’â”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\n   233â†’â”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\n   234â†’â”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\n   235â†’â”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\n   236â†’â”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\n   237â†’â”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\n   238â†’â”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\n   239â†’â”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\n   240â†’â”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\n   241â†’â”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\n   242â†’â”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\n   243â†’â”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\n   244â†’â”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\n   245â†’â”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\n   246â†’â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\n   247â†’â”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\n   248â†’â”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\n   249â†’â”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\n   250â†’â”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\n   251â†’â”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\n   252â†’â”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\n   253â†’â”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\n   254â†’â”‚   â”‚\n   255â†’â”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\n   256â†’â”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\n   257â†’â”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\n   258â†’â”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\n   259â†’â”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\n   260â†’â”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\n   261â†’â”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\n   262â†’â”‚   â”‚\n   263â†’â”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\n   264â†’â”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\n   265â†’â”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\n   266â†’â”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\n   267â†’â”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\n   268â†’â”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\n   269â†’â”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\n   270â†’â”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\n   271â†’â”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\n   272â†’â”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\n   273â†’â”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\n   274â†’â”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\n   275â†’â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\n   276â†’â”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\n   277â†’â”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\n   278â†’â”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\n   279â†’â”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\n   280â†’â”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\n   281â†’â”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\n   282â†’â”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\n   283â†’â”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\n   284â†’â”‚   â”‚\n   285â†’â”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\n   286â†’â”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\n   287â†’â”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\n   288â†’â”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\n   289â†’â”‚   â”‚\n   290â†’â”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\n   291â†’â”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\n   292â†’â”‚   â”‚\n   293â†’â”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\n   294â†’â”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\n   295â†’â”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\n   296â†’â”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\n   297â†’â”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\n   298â†’â”‚   â”‚\n   299â†’â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\n   300â†’â”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\n   301â†’â”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\n   302â†’â”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)\n   303â†’â”‚   â”‚\n   304â†’â”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\n   305â†’â”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\n   306â†’â”‚\n   307â†’â”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\n   308â†’â”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\n   309â†’â”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\n   310â†’â”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\n   311â†’â”‚\n   312â†’â”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\n   313â†’â”‚\n   314â†’â””â”€â”€ ... (config files)\n   315â†’```\n   316â†’\n   317â†’### ğŸ“ Where to Look (Task Map)\n   318â†’\n   319â†’| Task                      | File Path / Directory                                              |\n   320â†’| ------------------------- | ------------------------------------------------------------------ |\n   321â†’| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n   322â†’| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n   323â†’| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n   324â†’| **Modify export format**  | `src/features/export/services/`                                    |\n   325â†’| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n   326â†’| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n   327â†’| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n   328â†’| **Change DOM injection**  | `src/pages/content/`                                               |\n   329â†’| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n   330â†’| **Modify popup settings** | `src/pages/popup/components/`                                      |\n   331â†’| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n   332â†’\n   333â†’---\n   334â†’\n   335â†’## 9. Important Files\n   336â†’\n   337â†’- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n   338â†’- `vite.config.base.ts`: Shared build configuration.\n   339â†’- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n   340â†’- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n   341â†’- `src/core/services/StorageService.ts`: Data persistence layer.\n   342â†’- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n   343â†’- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n   344â†’- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n   345â†’- `src/locales/*`: Translation files (11 languages).\n   346â†’- `public/contentStyle.css`: Injected CSS styles for content scripts.\n   347â†’\n   348â†’---\n   349â†’\n   350â†’## 10. Troubleshooting\n   351â†’\n   352â†’- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n   353â†’- **HMR Issues**: Reload the extension in `chrome://extensions`.\n   354â†’- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n   355â†’- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n   356â†’- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n   357â†’\n   358â†’---\n   359â†’"}]},"uuid":"86d07aec-1add-4781-a3a9-7d6b043e4bdd","timestamp":"2026-02-15T23:59:33.187Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","content":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-09\n> **Version**: 1.2.2\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (22 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","numLines":359,"startLine":1,"totalLines":359}},"sourceToolAssistantUUID":"6182e7fd-290c-4597-88e9-4cc1abb75ec8"}
{"parentUuid":"86d07aec-1add-4781-a3a9-7d6b043e4bdd","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01Mw4m3bBbsxRnBnrrrhMFE7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XQhgjeVL7kVRdrSooqyT5A","name":"Glob","input":{"pattern":"AGENTS.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6326,"cache_read_input_tokens":17862,"output_tokens":173,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":6326,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmE1oijxbf9dVbCyzBm","type":"assistant","uuid":"7c000baa-884c-42f3-a145-4d1289894fcc","timestamp":"2026-02-15T23:59:33.401Z"}
{"parentUuid":"7c000baa-884c-42f3-a145-4d1289894fcc","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_01XQhgjeVL7kVRdrSooqyT5A","toolUseID":"toolu_01XQhgjeVL7kVRdrSooqyT5A","timestamp":"2026-02-15T23:59:33.936Z","uuid":"75ac391a-6b01-412b-9ff4-57b0ddbbd012"}
{"parentUuid":"7c000baa-884c-42f3-a145-4d1289894fcc","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XQhgjeVL7kVRdrSooqyT5A","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md"}]},"uuid":"aeb4792c-4697-4e34-be22-e08e7d2fd265","timestamp":"2026-02-15T23:59:33.935Z","toolUseResult":{"filenames":["/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md"],"durationMs":528,"numFiles":1,"truncated":false},"sourceToolAssistantUUID":"7c000baa-884c-42f3-a145-4d1289894fcc"}
{"parentUuid":"aeb4792c-4697-4e34-be22-e08e7d2fd265","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01RgHWyCmBn6aGwv8WpCVK7T","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Nr91LbLg8Spr9xmRph46Uo","name":"Read","input":{"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":6237,"cache_read_input_tokens":24188,"output_tokens":79,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":6237,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmEN86Yz1VBWgpRqaNX","type":"assistant","uuid":"6c51b257-715d-41de-846a-704916d1030f","timestamp":"2026-02-15T23:59:36.694Z"}
{"parentUuid":"6c51b257-715d-41de-846a-704916d1030f","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01Nr91LbLg8Spr9xmRph46Uo","toolUseID":"toolu_01Nr91LbLg8Spr9xmRph46Uo","timestamp":"2026-02-15T23:59:36.702Z","uuid":"2ca55399-4a0c-4345-b61b-cae4ccab7249"}
{"parentUuid":"6c51b257-715d-41de-846a-704916d1030f","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Nr91LbLg8Spr9xmRph46Uo","type":"tool_result","content":"     1â†’---\n     2â†’trigger: always_on\n     3â†’---\n     4â†’\n     5â†’# AGENTS.md - AI Assistant Guide for Gemini Voyager\n     6â†’\n     7â†’<!--\n     8â†’This file is generated from AI_GUIDE.template.md.\n     9â†’Do not edit directly; update the template and run `bun run generate:ai-guides`.\n    10â†’-->\n    11â†’\n    12â†’> **Last Updated**: 2026-02-04\n    13â†’> **Version**: 1.1.9\n    14â†’> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n    15â†’\n    16â†’---\n    17â†’\n    18â†’## 1. Role & Core Mandates\n    19â†’\n    20â†’**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n    21â†’\n    22â†’**Core Mandates**:\n    23â†’\n    24â†’1.  **Safety First**: Never commit secrets. Validate all system operations.\n    25â†’2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n    26â†’3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n    27â†’4.  **Testing**: Every feature and fix must include tests.\n    28â†’5.  **Documentation**: Keep documentation and translations in sync with code changes.\n    29â†’\n    30â†’---\n    31â†’\n    32â†’## 2. Operational Methodology\n    33â†’\n    34â†’Before writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n    35â†’\n    36â†’### Phase 1: The Three Questions\n    37â†’\n    38â†’Ask yourself before starting:\n    39â†’\n    40â†’1.  **\"Is this a real problem?\"** - Reject over-engineering.\n    41â†’2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n    42â†’3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n    43â†’\n    44â†’### Phase 2: Requirements Analysis\n    45â†’\n    46â†’When analyzing a request:\n    47â†’\n    48â†’1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    49â†’    - What is the core data? Who owns it?\n    50â†’    - Can we redesign data structures to eliminate branches/complexity?\n    51â†’2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    52â†’    - Identify `if/else` branches that patch bad design.\n    53â†’    - Refactor to make the \"special case\" the normal case.\n    54â†’3.  **Destructive Analysis**:\n    55â†’    - List all existing features that might be affected.\n    56â†’    - Ensure zero destructiveness to user data (especially `localStorage`).\n    57â†’\n    58â†’### Phase 3: Decision Output\n    59â†’\n    60â†’If a task is complex or ambiguous, present your analysis in this format:\n    61â†’\n    62â†’```text\n    63â†’ã€Core Judgmentã€‘\n    64â†’âœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n    65â†’\n    66â†’ã€Key Insightsã€‘\n    67â†’- Data structure: [most critical data relationships]\n    68â†’- Complexity: [complexity that can be eliminated]\n    69â†’- Risks: [potential breaking changes]\n    70â†’\n    71â†’ã€Planã€‘\n    72â†’1. Simplify data structures...\n    73â†’2. Eliminate special cases...\n    74â†’3. Implementation steps...\n    75â†’```\n    76â†’\n    77â†’---\n    78â†’\n    79â†’## 3. Tool Usage & Verification Protocols\n    80â†’\n    81â†’Strictly adhere to these protocols to prevent errors and ensure data integrity.\n    82â†’\n    83â†’### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n    84â†’\n    85â†’1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    86â†’    - _Tool_: `read_file`\n    87â†’2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    88â†’    - _Tool_: `write_file` or `replace`\n    89â†’3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    90â†’    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n    91â†’\n    92â†’### ğŸš¨ Critical Safety Checks\n    93â†’\n    94â†’- **Never** modify `dist_*` folders directly.\n    95â†’- **Never** commit `.env` or secrets.\n    96â†’- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n    97â†’- **Always** run `bun run lint` before finishing.\n    98â†’\n    99â†’---\n   100â†’\n   101â†’## 4. Module Glossary & Complexity Hotspots\n   102â†’\n   103â†’| Module (Path)                     | Responsibility                              | Complexity | Notes                                                                          |\n   104â†’| --------------------------------- | ------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n   105â†’| `core/services/StorageService`    | **Single Source of Truth** for persistence. | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n   106â†’| `core/services/DataBackupService` | Multi-layer backup protection.              | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n   107â†’| `features/folder`                 | Drag-and-drop folder logic.                 | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n   108â†’| `features/export`                 | Chat export (JSON/MD/PDF).                  | ğŸŸ¡ Medium  | PDF generation relies on specific DOM structure. Fragile to Gemini UI changes. |\n   109â†’| `features/backup`                 | File System Access API.                     | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n   110â†’| `pages/content`                   | **DOM Injection**.                          | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension.                                        |\n   111â†’\n   112â†’---\n   113â†’\n   114â†’## 5. Development Standards & Anti-Patterns\n   115â†’\n   116â†’### âœ… DOs\n   117â†’\n   118â†’- **Prefer Plain Objects**: Use interfaces/types for data structures.\n   119â†’- **Immutability**: Use `map`, `filter`, `reduce`.\n   120â†’- **Encapsulation**: Use `private`/`protected` in classes.\n   121â†’- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n   122â†’- **Named Exports**: `export function X` (easier refactoring).\n   123â†’- **Functional React**: Hooks at top level, strictly functional components.\n   124â†’\n   125â†’### âŒ DON'Ts (Anti-Patterns)\n   126â†’\n   127â†’- **Global State Pollution**: Never use global variables outside of defined Services.\n   128â†’- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n   129â†’- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n   130â†’- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n   131â†’- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n   132â†’- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n   133â†’\n   134â†’---\n   135â†’\n   136â†’## 6. Testing Strategy\n   137â†’\n   138â†’**Framework**: Vitest 4.0.6 (jsdom environment)\n   139â†’\n   140â†’### TDD Workflow Guidelines\n   141â†’\n   142â†’1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n   143â†’2.  **Fail**: Ensure the test fails (validates the test itself).\n   144â†’3.  **Implement**: Write the minimal code to pass the test.\n   145â†’4.  **Refactor**: Clean up the code while keeping tests green.\n   146â†’\n   147â†’### Mocking Patterns\n   148â†’\n   149â†’This project relies heavily on `vi.mock` for Chrome APIs and external services.\n   150â†’\n   151â†’**Mocking Chrome API**:\n   152â†’The global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n   153â†’\n   154â†’```typescript\n   155â†’// Example: Mocking specific storage behavior for a test\n   156â†’beforeEach(() => {\n   157â†’  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n   158â†’});\n   159â†’```\n   160â†’\n   161â†’**Running Tests**:\n   162â†’\n   163â†’```bash\n   164â†’bun run test                # Run all tests\n   165â†’bun run test <filename>     # Run specific test file\n   166â†’bun run test:watch          # Interactive mode\n   167â†’bun run test:coverage       # Check coverage\n   168â†’```\n   169â†’\n   170â†’---\n   171â†’\n   172â†’## 7. Workflows & Definition of Done\n   173â†’\n   174â†’### Setup\n   175â†’\n   176â†’```bash\n   177â†’bun install\n   178â†’```\n   179â†’\n   180â†’### Development\n   181â†’\n   182â†’```bash\n   183â†’# Start Dev Server (Chrome)\n   184â†’bun run dev:chrome\n   185â†’\n   186â†’# Start Dev Server (Firefox)\n   187â†’bun run dev:firefox\n   188â†’```\n   189â†’\n   190â†’_Note: Uses Nodemon for hot-reloading content scripts._\n   191â†’\n   192â†’### Commit Messages (commitlint)\n   193â†’\n   194â†’Use Conventional Commits format:\n   195â†’\n   196â†’```\n   197â†’<type>(<scope>): <imperative summary>\n   198â†’```\n   199â†’\n   200â†’- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n   201â†’- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n   202â†’- summary: lowercase, imperative, no trailing period\n   203â†’\n   204â†’Examples:\n   205â†’\n   206â†’- `fix(copy): handle clipboard fallback`\n   207â†’- `refactor(copy): introduce temml to convert tex2mathml`\n   208â†’- `chore: update sponsors.svg`\n   209â†’\n   210â†’### Definition of Done (DoD)\n   211â†’\n   212â†’Before claiming a task is complete, verify:\n   213â†’\n   214â†’1.  **Functionality**: Does it meet the requirements?\n   215â†’2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n   216â†’3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n   217â†’4.  **Linting**: Code formatted and linted (`bun run lint`)?\n   218â†’5.  **Build**: Does it build without error (`bun run build`)?\n   219â†’6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n   220â†’\n   221â†’---\n   222â†’\n   223â†’## 8. Repository Structure & File Map\n   224â†’\n   225â†’```\n   226â†’gemini-voyager/\n   227â†’â”œâ”€â”€ src/\n   228â†’â”‚   â”œâ”€â”€ core/                     # ğŸ§  CORE LOGIC (Foundation)\n   229â†’â”‚   â”‚   â”œâ”€â”€ services/             # Singleton Services\n   230â†’â”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts #   - Central persistence layer\n   231â†’â”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts     #   - Safe DOM manipulation\n   232â†’â”‚   â”‚   â”‚   â”œâ”€â”€ LoggerService.ts  #   - Structured logging\n   233â†’â”‚   â”‚   â”‚   â””â”€â”€ ...\n   234â†’â”‚   â”‚   â”œâ”€â”€ utils/                # Core utilities (hashing, concurrency)\n   235â†’â”‚   â”‚   â””â”€â”€ types/                # Global type definitions\n   236â†’â”‚   â”‚\n   237â†’â”‚   â”œâ”€â”€ features/                 # ğŸ§© FEATURES (Domain Logic)\n   238â†’â”‚   â”‚   â”œâ”€â”€ export/               #   - Export (JSON/MD/PDF)\n   239â†’â”‚   â”‚   â”œâ”€â”€ folder/               #   - Folder organization\n   240â†’â”‚   â”‚   â”œâ”€â”€ backup/               #   - File System backup\n   241â†’â”‚   â”‚   â””â”€â”€ formulaCopy/          #   - LaTeX copy\n   242â†’â”‚   â”‚\n   243â†’â”‚   â”œâ”€â”€ pages/                    # ğŸšª ENTRY POINTS (Application)\n   244â†’â”‚   â”‚   â”œâ”€â”€ background/           #   - Service Worker\n   245â†’â”‚   â”‚   â”œâ”€â”€ popup/                #   - Settings UI\n   246â†’â”‚   â”‚   â””â”€â”€ content/              #   - Content Scripts (Gemini Injection)\n   247â†’â”‚   â”‚       â”œâ”€â”€ timeline/         #       * Timeline navigation\n   248â†’â”‚   â”‚       â”œâ”€â”€ prompt/           #       * Prompt manager\n   249â†’â”‚   â”‚       â”œâ”€â”€ deepResearch/     #       * Deep research tool\n   250â†’â”‚   â”‚       â””â”€â”€ ...               #       * (Feature integrations)\n   251â†’â”‚   â”‚\n   252â†’â”‚   â”œâ”€â”€ components/               # ğŸ§± UI COMPONENTS (Presentation)\n   253â†’â”‚   â”‚   â””â”€â”€ ui/                   #   - Generic UI (Buttons, Dialogs)\n   254â†’â”‚   â”‚\n   255â†’â”‚   â”œâ”€â”€ locales/                  # ğŸŒ TRANSLATIONS\n   256â†’â”‚   â”‚   â”œâ”€â”€ en/messages.json      #   - English\n   257â†’â”‚   â”‚   â””â”€â”€ zh/messages.json      #   - Chinese\n   258â†’â”‚   â”‚\n   259â†’â”‚   â””â”€â”€ tests/                    # ğŸ§ª GLOBAL TESTS\n   260â†’â”‚       â””â”€â”€ setup.ts              #   - Vitest setup & mocks\n   261â†’â”‚\n   262â†’â”œâ”€â”€ public/                       # ğŸ“¦ STATIC ASSETS\n   263â†’â”‚   â”œâ”€â”€ katex-config.js           #   - KaTeX configuration\n   264â†’â”‚   â””â”€â”€ fetchInterceptor.js       #   - Network interception\n   265â†’â”‚\n   266â†’â””â”€â”€ ... (config files)\n   267â†’```\n   268â†’\n   269â†’### ğŸ“ Where to Look (Task Map)\n   270â†’\n   271â†’| Task                     | File Path / Directory                                              |\n   272â†’| ------------------------ | ------------------------------------------------------------------ |\n   273â†’| **Add new storage key**  | `src/core/types/common.ts` (StorageKeys)                           |\n   274â†’| **Change storage logic** | `src/core/services/StorageService.ts`                              |\n   275â†’| **Update translations**  | `src/locales/{en,zh}/messages.json`                                |\n   276â†’| **Modify export format** | `src/features/export/services/`                                    |\n   277â†’| **Fix backup issues**    | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n   278â†’| **Adjust UI styles**     | `src/components/ui/` or `src/assets/styles/`                       |\n   279â†’| **Change DOM injection** | `src/pages/content/`                                               |\n   280â†’\n   281â†’---\n   282â†’\n   283â†’## 9. Important Files\n   284â†’\n   285â†’- `manifest.json` / `manifest.dev.json`: Extension capabilities.\n   286â†’- `vite.config.*.ts`: Build configurations.\n   287â†’- `src/core/types/common.ts`: Centralized types and constants.\n   288â†’- `src/core/services/StorageService.ts`: Data persistence layer.\n   289â†’- `src/locales/*`: Translation files.\n   290â†’\n   291â†’---\n   292â†’\n   293â†’## 10. Troubleshooting\n   294â†’\n   295â†’- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n   296â†’- **HMR Issues**: Reload the extension in `chrome://extensions`.\n   297â†’- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n   298â†’\n   299â†’---\n   300â†’"}]},"uuid":"15910e00-f10a-404e-974c-931b43daf33b","timestamp":"2026-02-15T23:59:36.701Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md","content":"---\ntrigger: always_on\n---\n\n# AGENTS.md - AI Assistant Guide for Gemini Voyager\n\n<!--\nThis file is generated from AI_GUIDE.template.md.\nDo not edit directly; update the template and run `bun run generate:ai-guides`.\n-->\n\n> **Last Updated**: 2026-02-04\n> **Version**: 1.1.9\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                     | Responsibility                              | Complexity | Notes                                                                          |\n| --------------------------------- | ------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`    | **Single Source of Truth** for persistence. | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService` | Multi-layer backup protection.              | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `features/folder`                 | Drag-and-drop folder logic.                 | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                 | Chat export (JSON/MD/PDF).                  | ğŸŸ¡ Medium  | PDF generation relies on specific DOM structure. Fragile to Gemini UI changes. |\n| `features/backup`                 | File System Access API.                     | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                   | **DOM Injection**.                          | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension.                                        |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server (Chrome)\nbun run dev:chrome\n\n# Start Dev Server (Firefox)\nbun run dev:firefox\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                     # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/             # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts     #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ LoggerService.ts  #   - Structured logging\nâ”‚   â”‚   â”‚   â””â”€â”€ ...\nâ”‚   â”‚   â”œâ”€â”€ utils/                # Core utilities (hashing, concurrency)\nâ”‚   â”‚   â””â”€â”€ types/                # Global type definitions\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                 # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/               #   - Export (JSON/MD/PDF)\nâ”‚   â”‚   â”œâ”€â”€ folder/               #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/               #   - File System backup\nâ”‚   â”‚   â””â”€â”€ formulaCopy/          #   - LaTeX copy\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                    # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/           #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                #   - Settings UI\nâ”‚   â”‚   â””â”€â”€ content/              #   - Content Scripts (Gemini Injection)\nâ”‚   â”‚       â”œâ”€â”€ timeline/         #       * Timeline navigation\nâ”‚   â”‚       â”œâ”€â”€ prompt/           #       * Prompt manager\nâ”‚   â”‚       â”œâ”€â”€ deepResearch/     #       * Deep research tool\nâ”‚   â”‚       â””â”€â”€ ...               #       * (Feature integrations)\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/               # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â””â”€â”€ ui/                   #   - Generic UI (Buttons, Dialogs)\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                  # ğŸŒ TRANSLATIONS\nâ”‚   â”‚   â”œâ”€â”€ en/messages.json      #   - English\nâ”‚   â”‚   â””â”€â”€ zh/messages.json      #   - Chinese\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                    # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts              #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                       # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ katex-config.js           #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js       #   - Network interception\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                     | File Path / Directory                                              |\n| ------------------------ | ------------------------------------------------------------------ |\n| **Add new storage key**  | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic** | `src/core/services/StorageService.ts`                              |\n| **Update translations**  | `src/locales/{en,zh}/messages.json`                                |\n| **Modify export format** | `src/features/export/services/`                                    |\n| **Fix backup issues**    | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Adjust UI styles**     | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection** | `src/pages/content/`                                               |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities.\n- `vite.config.*.ts`: Build configurations.\n- `src/core/types/common.ts`: Centralized types and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/locales/*`: Translation files.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n\n---\n","numLines":300,"startLine":1,"totalLines":300}},"sourceToolAssistantUUID":"6c51b257-715d-41de-846a-704916d1030f"}
{"parentUuid":"15910e00-f10a-404e-974c-931b43daf33b","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01CBR5QCE6mWt6KubeKbh8LZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I can see the differences. AGENTS.md is outdated (v1.1.9, 2026-02-04) compared to CLAUDE.md (v1.2.2, 2026-02-09). I also notice the comment says it's generated from a template. But the user wants me to update CLAUDE.md first, then sync AGENTS.md.\n\nWait, let me re-read the request: \"æ›´æ–° CLAUDE.mdã€‚æ›´æ–°ååŒæ­¥ AGENTS.md\" - \"Update CLAUDE.md. After updating, sync AGENTS.md.\"\n\nBut what should I update in CLAUDE.md? The user didn't specify what to update. \n\nI see now - AGENTS.md has a header indicating it's generated from a template file using a build script. Let me look for that template and the generation command to understand the proper workflow.","signature":"EqEHCkYICxgCKkBqdCvIosfQva70flW/tNynIZWfT0qr2HCODs691xJMPmF2hSmTBwc7nz0IIcmznlMuT9nVWqrV6WfTbTq+uCN9EgzIqpxjd+njyWeYe30aDD87xp6gUxmwOe+ExyIw4QVmpsPcv1cXBn2nZsdcV+ROMQi4PZS70leogR9omotbnTGgexzpwSKb+5lM3VdwKogGk8k4TvL9KWDsio2FKBx8+b+Cs/g9Iu2+nC/vUzHvwTjSbXxL0rL2bWvAsqLsNJUYyNmrxivpDivWhlQQbF/XiaV4D84+/dKsU8U8wzyEDmPkPH9ijbudToXaVXNaYg2mTjdO9E40QOoGJxveUz7EluJF5ak6UeAtG7NKCnPcSESDsBo637QrLfblwTMEFADmIPmVB/U4V4hQdLoJjgOECX9ACpcYl3TAkRO1nOeAsU7txomUPpVUZSgCMuZvq0hqKPb+M9cdNohrU+aOkGMsT3Ue0EgnecuXpDavpNEByzf5qJlL2sfVatfbZJ085xdUYeS/U781tRy4zDBrNmNDCXPT11L/9UDoPGRFQjCUi2cyVR/f+LKv5Dmqc0ne+fD3gNqZwnSDFCoP2Y0UQaF4x1Gq/N6L//zaTpctDVJPIydYc12X5JaGzgV2JT1TcObEkqVlGu9IjfVRAfmzUeIr31N1jOB4pDic9Nzkndy0nxdFALjvhCqhP4hVmaQIemtV42YxHlrhZhoAyFR8MaPo9K6ZMAR7vaKBhsX44Ck3cBoyLENC1zZJkMS5U/NeAUu4NrD6zIBVU0SmSfMyy/K5k8yRvrLEvSun+uzhF4phfU2+hKC0kwI7tT9f+hsRb2q3B3iVE3jZzLtH4/7saT2zRRv0hgrAGGsAfcWBiDvM74nPsyJ5EuQZsKI81Msr2pJIRdFSuuyj1nBz9rrt4LPQw/hxD5HUS/MtLsWe+N1+WfVeByLJOfMOV2WGHKjkDXm60kYIaeLoGEGKPUIQyz6vCiCim74RnLCq0UPEoMlVpYJ5v8QBLOPYb8efL4zk0jmXNupvDzCqZDAUy6JaxZaG5nU25+8pHVjq8JqAhaOj19OiovQ8xfbStmPXCNqZQgjU0XscrafIF9tys73oYaIgE3Mc2gVS+BAdNluzPRPOZAA+OqWQhCxZD3HJQgKvWWuT1yPE2Cdeh9ysY/6wf5HAewT7NY4cN6tJjkIpRV0SL6bmkulkNdsOs04sSCJBWCvY9ih59KOG8SwYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4331,"cache_read_input_tokens":30425,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4331},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmEZj6fEUt4kAQ1pq3z","type":"assistant","uuid":"9b8082a6-e021-4327-8c2f-e8f2464f7650","timestamp":"2026-02-15T23:59:45.418Z"}
{"parentUuid":"9b8082a6-e021-4327-8c2f-e8f2464f7650","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01CBR5QCE6mWt6KubeKbh8LZ","type":"message","role":"assistant","content":[{"type":"text","text":"I see AGENTS.md mentions it's generated from `AI_GUIDE.template.md`. Let me check if that template and the generation script exist."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4331,"cache_read_input_tokens":30425,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4331},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmEZj6fEUt4kAQ1pq3z","type":"assistant","uuid":"e8b9c2c4-a9d5-4a21-b94c-dbb725073da9","timestamp":"2026-02-15T23:59:45.556Z"}
{"parentUuid":"e8b9c2c4-a9d5-4a21-b94c-dbb725073da9","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01CBR5QCE6mWt6KubeKbh8LZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RdtNNovEiLrrrbDTgwUZc1","name":"Glob","input":{"pattern":"**/AI_GUIDE.template.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4331,"cache_read_input_tokens":30425,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4331},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmEZj6fEUt4kAQ1pq3z","type":"assistant","uuid":"2cbc9f42-49ee-475b-bce2-b97ea8985c7f","timestamp":"2026-02-15T23:59:45.992Z"}
{"parentUuid":"2cbc9f42-49ee-475b-bce2-b97ea8985c7f","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_01RdtNNovEiLrrrbDTgwUZc1","toolUseID":"toolu_01RdtNNovEiLrrrbDTgwUZc1","timestamp":"2026-02-15T23:59:46.427Z","uuid":"c296538b-a72a-409e-83af-7a61e1aa5ed7"}
{"parentUuid":"2cbc9f42-49ee-475b-bce2-b97ea8985c7f","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RdtNNovEiLrrrbDTgwUZc1","type":"tool_result","content":"No files found"}]},"uuid":"5beffb50-1163-49cd-82d3-aa846e0d2d6d","timestamp":"2026-02-15T23:59:46.426Z","toolUseResult":{"filenames":[],"durationMs":432,"numFiles":0,"truncated":false},"sourceToolAssistantUUID":"2cbc9f42-49ee-475b-bce2-b97ea8985c7f"}
{"parentUuid":"5beffb50-1163-49cd-82d3-aa846e0d2d6d","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01CBR5QCE6mWt6KubeKbh8LZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VNCCxRykzUUu1Aiwg3QMH9","name":"Grep","input":{"pattern":"generate:ai-guides","glob":"package.json","output_mode":"content"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4331,"cache_read_input_tokens":30425,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":4331},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmEZj6fEUt4kAQ1pq3z","type":"assistant","uuid":"c563937d-abc0-4162-8e27-e57d341acd90","timestamp":"2026-02-15T23:59:46.744Z"}
{"parentUuid":"c563937d-abc0-4162-8e27-e57d341acd90","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01VNCCxRykzUUu1Aiwg3QMH9","toolUseID":"toolu_01VNCCxRykzUUu1Aiwg3QMH9","timestamp":"2026-02-15T23:59:47.044Z","uuid":"23a22628-a308-4ddf-b4c5-54892e7ad7cc"}
{"parentUuid":"c563937d-abc0-4162-8e27-e57d341acd90","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VNCCxRykzUUu1Aiwg3QMH9","type":"tool_result","content":"No matches found"}]},"uuid":"cc5bbb1c-2703-4c82-8914-abe9fe6b2930","timestamp":"2026-02-15T23:59:47.043Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"c563937d-abc0-4162-8e27-e57d341acd90"}
{"parentUuid":"cc5bbb1c-2703-4c82-8914-abe9fe6b2930","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01AXU7EvaFWDQzZfbPnGAQ8i","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The template file and the generation script don't exist. So the AGENTS.md comment is outdated/incorrect. The user wants me to:\n\n1. Update CLAUDE.md (but what updates? Maybe just the date?)\n2. Sync AGENTS.md to match CLAUDE.md\n\nActually, I think the user wants me to update CLAUDE.md's date to today (2026-02-15), and then make AGENTS.md match CLAUDE.md's content. Let me also check if there are any actual changes in the codebase that should be reflected in CLAUDE.md - but the user's request seems straightforward: update CLAUDE.md and sync AGENTS.md.\n\n\nNow I'm comparing the two files and seeing that AGENTS.md is significantly out of syncâ€”it's missing several services like GoogleDriveSyncService, module glossary entries like mermaid and watermarkRemover, Safari dev/build commands, troubleshooting sections, and a bunch of important files from the repository structure. I should check the actual codebase to see what's current before updating CLAUDE.md beyond just the date.","signature":"EqcKCkYICxgCKkDeFWTrPmAvEQpemePUwRIUBC+XSkf/wHUHePwejONDazEypVQGOjHecsP5KYISFjclJrjZodMBD56p3vERIHISEgwAdkzFQ40NoFfLawwaDCfI7k6e/rEa5kXkzSIwqLggFytYz2hDZmcxMVsdF8HwMulSu0bxSptlclVx9nh76xyyvY6Y5Q+XgDHoYFYuKo4JBrm/tw3XVsw99O98aKOGI2eE3U+cPn6GxIW9f1x18DWnj7h8GmLqDJ7q565DuiYlePrzAemSbYhXP3CK2QuMxAd99qxhOEX6Y3JHUiH10bgRli8CDVt3uaMm5OEr5ZS4IewZm69yAziQ3FNYg38FFB8f051dGAtmd7k0EFSoDPwU8/Sh8HEryd+DZynBMIsmlyL7j5WsRFFFhjbRYK5YopibhXl96b37d7fqzw7gvJw2mGosFgPjlZo+UYLPKfXG6Soum+2O5RVyApxtVq0DYgFMzDTC7WxDViRk/enfe3BnjpKITqT4StDL9kZtd0mEJ1cafCueS8+VTx+H9y74F5HaD+LrJKddL17vhsL2FnheplTj/jLY5L/5cQeuAQIEQGC43WPgOTm0Eg6VA87Tk7u1E4Dc/jaOkBnU1d9lYPK+6ekVWSNCodPn31IduENWxD7sPqx98HnmBZjIxL4MYnPVfLSMmhKjsmhSONwjjVaTFc2ImTC3BbzwykUO0HNJ8rKMOUbvcH806VmH/nS/je4D0Be0ywl42ekC2u8jGddFKJxtMAmXH6bWKGNaB9gily0wzMBhKoaB3lBeubxnJVNjkXe6mb4JH1Dvow8Yn93bqSELjKt360JJSHOB0tnjGQouazuGxSSLX9WEnRv7hoB+Z/bzd2oHNPIyfSrVQK5BD3lPTVKKgWpcxRb1OYr0yy8QJKsWSMYlwNCumE6ACS9eJcH6FfFmb/TtXSeclVFXF+ojOSFZTOK4d8C77D8eO+EHUsKWdSCGgCG48HlDSyZurbUKCOCJSPP1mml2CscwOdOfsJiyyoKSORpPTPBGCl65VmEEXYaTnIPMvv4HoX+KjgfAXLHwbtiI8q+rFS8ao/Arjxmmjr4vT61G4VVgU4W6uakqP66hiodzniidJVVnBoVSsrl9L73vOaA5kBIxFO9lZfhJuoFPq3WutcEw+S+x9t/gvjuyxPu+iMX2IQmGBtdW0T+Wl1oqYfrYfD0XnicNViPGYy0Q44FPJlgv/lU+CY3rvPER0LCK8iwr7kHcOCe0WfvCdINwkuO7CVMbU/pimdxTOn3p6ct7gCu/8qdEJZgk4A0Bqx87BP4NLec0S6VUc1w8NLl/3U7w2z9599oVbH4W7NNvcmnTUFBb9nY2I7eeZ2YKn9wc1Qu7LGmW2+9zoWoV2nrBqCUPsxY4nJ2Q+lQ98kf/C+cnrjuBr0plRg5e//dgrVRj3kz+cfDlGnS3ikVSoOCXAc37uZ83r+Cjh01+v6MBcXpUBP3+Kx5Y2vBo5CEFQaRCucgrsQla80R2F25HeE5CmKiH3BfLBlReiFqDDwx8f3ON0Nihhi1yWlMyeLOm1xjM3uP9hbk4FFL+cXKT69fpIS1L8UFTbpfBsTFo1ko4NKw5Bw/BOimnw/W/5N3PpP4ZwDMOu+cz5KQG95T7U7eSbE+qxjGyKOu+UBHEjRCRITDPt+SkxXJyU6rLEyeqhfG3VAzCxEDo+7HF3HAPVsuV7d7sKOvjbUUMtnstwu8HIgTggshKUJTykAbHqxccPP5qXt0YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":481,"cache_read_input_tokens":34756,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":481},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmFL4btbJqT2wPvzPDi","type":"assistant","uuid":"3c9d3ace-5cf2-41ee-8c62-643d13ed2a98","timestamp":"2026-02-15T23:59:57.925Z"}
{"parentUuid":"3c9d3ace-5cf2-41ee-8c62-643d13ed2a98","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01AXU7EvaFWDQzZfbPnGAQ8i","type":"message","role":"assistant","content":[{"type":"text","text":"The template and generation script don't exist. Let me check the current codebase to see if CLAUDE.md needs content updates beyond the date."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":481,"cache_read_input_tokens":34756,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":481},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmFL4btbJqT2wPvzPDi","type":"assistant","uuid":"65762649-481f-4d19-897f-c574f41cff3e","timestamp":"2026-02-15T23:59:57.937Z"}
{"parentUuid":"65762649-481f-4d19-897f-c574f41cff3e","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01AXU7EvaFWDQzZfbPnGAQ8i","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","name":"Task","input":{"description":"Audit codebase vs CLAUDE.md","subagent_type":"Explore","model":"haiku","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each."},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":481,"cache_read_input_tokens":34756,"output_tokens":624,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":481,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmFL4btbJqT2wPvzPDi","type":"assistant","uuid":"3150d16a-bebf-4833-9350-1873b62abcb9","timestamp":"2026-02-16T00:00:00.581Z"}
{"parentUuid":"3150d16a-bebf-4833-9350-1873b62abcb9","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Task","command":"entire hooks claude-code pre-task"},"toolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"23c75d21-ec61-4f51-b2a8-6c4c42ffce4b","timestamp":"2026-02-16T00:00:00.587Z"}
{"parentUuid":"23c75d21-ec61-4f51-b2a8-6c4c42ffce4b","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"type":"text","text":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each."}]},"uuid":"eaa52608-c44b-415e-987b-b750cb7faefa","timestamp":"2026-02-16T00:00:01.649Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"465917ca-6ac3-4762-a5a6-575b51d2244e","timestamp":"2026-02-16T00:00:01.650Z"}
{"parentUuid":"465917ca-6ac3-4762-a5a6-575b51d2244e","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:03.900Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JmzTgFEHp4UypE5uhNPkqQ","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features -maxdepth 1 -type d | sort","description":"List all directories under src/features/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"c09e3350-d24d-403b-96aa-cddc9df94ad6"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"4115bb93-c2f9-4b97-bb8e-e36fc83e80c7","timestamp":"2026-02-16T00:00:03.901Z"}
{"parentUuid":"4115bb93-c2f9-4b97-bb8e-e36fc83e80c7","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:04.291Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HLSfSZymNatnvDYk9JadAt","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services -maxdepth 1 -type f -name \"*.ts\" | sort","description":"List all files under src/core/services/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"3aa8e51e-5114-476c-adb7-20821da0a717"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"64a16ede-d715-4001-8961-7d8df33763ba","timestamp":"2026-02-16T00:00:04.291Z"}
{"parentUuid":"64a16ede-d715-4001-8961-7d8df33763ba","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:04.625Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013JprNRKVnmUhgWL1F4hj5K","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content -maxdepth 1 -type d | sort","description":"List all directories under src/pages/content/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"15e0e760-e539-42b4-9182-b02cb34ad8f6"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"0148dd8e-ce16-42c2-acd2-a8d188839b58","timestamp":"2026-02-16T00:00:04.625Z"}
{"parentUuid":"0148dd8e-ce16-42c2-acd2-a8d188839b58","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:04.961Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LKBymQD3QDQbNj2x1XcTMw","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales -maxdepth 1 -type d | sort","description":"List all directories under src/locales/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"32f684fd-1a07-4c66-afe1-0c9e0719c528"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"d3d90555-433d-46ec-a2c4-e6c0b45a2114","timestamp":"2026-02-16T00:00:04.961Z"}
{"parentUuid":"d3d90555-433d-46ec-a2c4-e6c0b45a2114","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JmzTgFEHp4UypE5uhNPkqQ","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features/backup\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features/contextSync\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features/export\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features/folder\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features/formulaCopy\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/features/tableCopy","is_error":false}]},"uuid":"4d6d1dbc-b0e1-4e0c-81b2-1a96c731ab83","timestamp":"2026-02-16T00:00:04.996Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"a31c9e87-a87a-4f35-9e26-d0a457e7bbdd","timestamp":"2026-02-16T00:00:05.199Z"}
{"parentUuid":"a31c9e87-a87a-4f35-9e26-d0a457e7bbdd","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HLSfSZymNatnvDYk9JadAt","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services/DOMService.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services/DataBackupService.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services/GoogleDriveSyncService.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services/KeyboardShortcutService.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services/LoggerService.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services/StorageMonitor.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/services/StorageService.ts","is_error":false}]},"uuid":"0a1df832-447c-4bb0-a856-3f9467ae327b","timestamp":"2026-02-16T00:00:05.005Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"0ea7d565-74eb-4d57-9076-beedc23fcf77","timestamp":"2026-02-16T00:00:05.199Z"}
{"parentUuid":"0ea7d565-74eb-4d57-9076-beedc23fcf77","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013JprNRKVnmUhgWL1F4hj5K","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/announcement\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/chatWidth\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/contextSync\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/deepResearch\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/defaultModel\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/editInputWidth\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/export\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/folder\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/folderSpacing\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/gemsHider\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/inputCollapse\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/katexConfig\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/markdownPatcher\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/mermaid\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/prompt\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/quoteReply\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/recentsHider\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/sendBehavior\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/shared\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/sidebarAutoHide\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/sidebarWidth\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/timeline\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/titleUpdater\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content/watermarkRemover","is_error":false}]},"uuid":"ea56c693-2183-4e4e-87b6-6ab90b296b10","timestamp":"2026-02-16T00:00:05.003Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"d293c4dd-43fa-48d7-b537-32899dc11c22","timestamp":"2026-02-16T00:00:05.199Z"}
{"parentUuid":"d293c4dd-43fa-48d7-b537-32899dc11c22","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LKBymQD3QDQbNj2x1XcTMw","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/__tests__\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/ar\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/en\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/es\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/fr\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/ja\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/ko\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/pt\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/ru\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/zh\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/zh_TW","is_error":false}]},"uuid":"abe980dd-b4da-4f49-ade1-a5959a1916c7","timestamp":"2026-02-16T00:00:05.037Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"63b68df6-a6c2-4290-986d-c1b0f0c6f901","timestamp":"2026-02-16T00:00:05.199Z"}
{"parentUuid":"63b68df6-a6c2-4290-986d-c1b0f0c6f901","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:05.347Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JG5MR8LQFuxrUyCseBRMAH","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils -maxdepth 1 -type f -name \"*.ts\" | sort","description":"List all files under src/core/utils/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"fb32b188-fb5f-4bd5-ac33-33b1e015d682"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"8b817b35-6cbc-4b0e-bf70-b35cef64efa4","timestamp":"2026-02-16T00:00:05.348Z"}
{"parentUuid":"8b817b35-6cbc-4b0e-bf70-b35cef64efa4","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JG5MR8LQFuxrUyCseBRMAH","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/array.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/async.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/browser.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/concurrency.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/extensionContext.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/gemini.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/hash.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/safariStorage.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/selectors.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/storageMigration.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/text.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/updateReminder.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/utils/version.ts","is_error":false}]},"uuid":"d2b4ed30-52f1-4be4-9d52-4e20305a4873","timestamp":"2026-02-16T00:00:05.436Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"8caa2af3-0759-4c76-89be-22acef1fed57","timestamp":"2026-02-16T00:00:05.568Z"}
{"parentUuid":"8caa2af3-0759-4c76-89be-22acef1fed57","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:05.681Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014jbcRNntUnuMnzLoe8NR1Y","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/types -maxdepth 1 -type f -name \"*.ts\" | sort","description":"List all files under src/core/types/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"24b7d01d-8506-4fdd-8136-2e36d95f5942"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"7f73a42c-85bd-4c7e-b21d-8ae9dcd8d02a","timestamp":"2026-02-16T00:00:05.681Z"}
{"parentUuid":"7f73a42c-85bd-4c7e-b21d-8ae9dcd8d02a","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014jbcRNntUnuMnzLoe8NR1Y","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/types/common.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/types/folder.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/types/keyboardShortcut.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/types/sync.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/core/types/timeline.ts","is_error":false}]},"uuid":"731f802e-2429-4c55-9570-acceea70f672","timestamp":"2026-02-16T00:00:05.756Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"b61d7865-d42a-427d-8ad9-c950685cf705","timestamp":"2026-02-16T00:00:05.886Z"}
{"parentUuid":"b61d7865-d42a-427d-8ad9-c950685cf705","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:06.000Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PCN54ESGxdtC93vEYrQWVa","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages -maxdepth 1 -type d | sort","description":"List all directories under src/pages/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"5fd41009-843a-432d-bf00-624b5de10a40"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"99a6bd33-bbf4-45e5-8d21-0efd396b9edc","timestamp":"2026-02-16T00:00:06.000Z"}
{"parentUuid":"99a6bd33-bbf4-45e5-8d21-0efd396b9edc","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PCN54ESGxdtC93vEYrQWVa","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/background\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/content\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/devtools\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/options\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/panel\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/pages/popup","is_error":false}]},"uuid":"0bfd1c79-7b15-4117-962c-e29c4782e2d4","timestamp":"2026-02-16T00:00:06.063Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"6dd62964-ac66-403d-8118-e86af757f532","timestamp":"2026-02-16T00:00:06.253Z"}
{"parentUuid":"6dd62964-ac66-403d-8118-e86af757f532","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:06.364Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WfZhXrHmLPaiFTES6FAnqA","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public -maxdepth 1 -type f | sort","description":"List all files under public/"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"c6d2ff83-c575-41e0-a258-4b3786327422"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"47a8e83c-dba9-43f9-bddd-ff8e3ad0620c","timestamp":"2026-02-16T00:00:06.364Z"}
{"parentUuid":"47a8e83c-dba9-43f9-bddd-ff8e3ad0620c","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WfZhXrHmLPaiFTES6FAnqA","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/.DS_Store\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/contentStyle.css\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/dev-icon-128.png\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/dev-icon-32.png\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/fetchInterceptor.js\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/icon-128.png\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/icon-32.png\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/public/katex-config.js","is_error":false}]},"uuid":"a15fc90a-f2e0-4d1c-9e2c-107a0a65c54e","timestamp":"2026-02-16T00:00:06.453Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"b11cb5fd-ca25-4fa9-8b4e-227b8deba20d","timestamp":"2026-02-16T00:00:06.608Z"}
{"parentUuid":"b11cb5fd-ca25-4fa9-8b4e-227b8deba20d","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:06.763Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QbknC5hGnahxMZhTTdPbES","name":"Bash","input":{"command":"grep \"vitest\" /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/package.json","description":"Check vitest version in package.json"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"df21a0b7-12dc-4865-8134-96aebd5d1f6b"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"8c642a83-36a6-4917-956e-7920c56afeb8","timestamp":"2026-02-16T00:00:06.763Z"}
{"parentUuid":"8c642a83-36a6-4917-956e-7920c56afeb8","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QbknC5hGnahxMZhTTdPbES","type":"tool_result","content":"    \"test\": \"vitest run\",\n    \"test:ui\": \"vitest --ui\",\n    \"test:coverage\": \"vitest run --coverage\",\n    \"test:watch\": \"vitest watch\",\n    \"@vitest/coverage-v8\": \"^4.0.6\",\n    \"@vitest/ui\": \"^4.0.6\",\n    \"vitest\": \"^4.0.6\",","is_error":false}]},"uuid":"21e28b95-5b9c-43ea-b44f-5d8e60dd49f0","timestamp":"2026-02-16T00:00:06.841Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"b7f552d5-59f4-4caa-9ae0-c79684442ab6","timestamp":"2026-02-16T00:00:07.113Z"}
{"parentUuid":"b7f552d5-59f4-4caa-9ae0-c79684442ab6","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"assistant","timestamp":"2026-02-16T00:00:07.229Z","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Am9GLn3NGwoXudZ2afzEVo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FQMyn3urjNmM8Y82x1atep","name":"Bash","input":{"command":"find /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager -maxdepth 1 -name \"vite.config.*.ts\" -type f | sort","description":"List all vite.config.*.ts files in the root"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":15605,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":15605},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"requestId":"req_011CYAmGQJNQVQVpuqJLZcKj","uuid":"21b1ed89-d0b4-45f9-b5a5-58d56bd48c22"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"97c83c50-dd23-459a-aaea-f7f718cc41fc","timestamp":"2026-02-16T00:00:07.229Z"}
{"parentUuid":"97c83c50-dd23-459a-aaea-f7f718cc41fc","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"message":{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FQMyn3urjNmM8Y82x1atep","type":"tool_result","content":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/vite.config.base.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/vite.config.chrome.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/vite.config.firefox.ts\n/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/vite.config.safari.ts","is_error":false}]},"uuid":"e13159ac-397b-4117-a6ed-114a2ddcc251","timestamp":"2026-02-16T00:00:07.306Z"},"normalizedMessages":[],"type":"agent_progress","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618"},"toolUseID":"agent_msg_01AXU7EvaFWDQzZfbPnGAQ8i","parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","uuid":"9a057e43-4f39-4b05-8bca-1b60981faf74","timestamp":"2026-02-16T00:00:07.307Z"}
{"parentUuid":"9a057e43-4f39-4b05-8bca-1b60981faf74","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Task","command":"entire hooks claude-code post-task"},"parentToolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","toolUseID":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","timestamp":"2026-02-16T00:00:20.842Z","uuid":"7bea4ffb-7798-40e2-b5d3-7311ee510d79"}
{"parentUuid":"3150d16a-bebf-4833-9350-1873b62abcb9","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HdvbzeAgwgmbZ7acRBY2KT","type":"tool_result","content":[{"type":"text","text":"Perfect! I have gathered all the information. Here's the complete audit of the codebase against CLAUDE.md:\n\n## Audit Report: Codebase vs CLAUDE.md Documentation\n\n### 1. src/features/ Directories\n**DOCUMENTED**: export, folder, backup, formulaCopy, contextSync, tableCopy\n**ACTUAL** (7 directories):\n- backup\n- contextSync\n- export\n- folder\n- formulaCopy\n- tableCopy\n\n**STATUS**: âœ… All documented features present. No undocumented features found.\n\n---\n\n### 2. src/core/services/ Files\n**DOCUMENTED**: StorageService, DataBackupService, GoogleDriveSyncService, KeyboardShortcutService, StorageMonitor, DOMService, LoggerService\n**ACTUAL** (7 files):\n- DataBackupService.ts\n- DOMService.ts\n- GoogleDriveSyncService.ts\n- KeyboardShortcutService.ts\n- LoggerService.ts\n- StorageMonitor.ts\n- StorageService.ts\n\n**STATUS**: âœ… All documented services present. Complete match.\n\n---\n\n### 3. src/pages/content/ Directories\n**DOCUMENTED**: timeline, prompt, deepResearch, mermaid, watermarkRemover, sendBehavior, folder, export, chatWidth, defaultModel, folderSpacing, gemsHider, inputCollapse, katexConfig, markdownPatcher, quoteReply, recentsHider, sidebarAutoHide, sidebarWidth, titleUpdater, editInputWidth, contextSync\n**ACTUAL** (25 directories):\n- announcement (UNDOCUMENTED)\n- chatWidth\n- contextSync\n- deepResearch\n- defaultModel\n- editInputWidth\n- export\n- folder\n- folderSpacing\n- gemsHider\n- inputCollapse\n- katexConfig\n- markdownPatcher\n- mermaid\n- prompt\n- quoteReply\n- recentsHider\n- sendBehavior\n- shared (UNDOCUMENTED)\n- sidebarAutoHide\n- sidebarWidth\n- timeline\n- titleUpdater\n- watermarkRemover\n\n**STATUS**: âš ï¸ Two undocumented modules: `announcement` and `shared`. CLAUDE.md is missing these entries.\n\n---\n\n### 4. src/locales/ Directories\n**DOCUMENTED**: en, ar, es, fr, ja, ko, pt, ru, zh, zh_CN, zh_TW\n**ACTUAL** (11 locale directories + 1 test directory):\n- __tests__ (UNDOCUMENTED)\n- ar\n- en\n- es\n- fr\n- ja\n- ko\n- pt\n- ru\n- zh\n- zh_TW\n\n**STATUS**: âš ï¸ Missing zh_CN directory in actual codebase. Only 10 locales found instead of 11. __tests__ directory is undocumented.\n\n---\n\n### 5. src/core/utils/ Files\n**DOCUMENTED**: browser, extensionContext, concurrency, hash, storageMigration, array, async, gemini, selectors, text, version\n**ACTUAL** (13 files):\n- array.ts\n- async.ts\n- browser.ts\n- concurrency.ts\n- extensionContext.ts\n- gemini.ts\n- hash.ts\n- safariStorage.ts (UNDOCUMENTED)\n- selectors.ts\n- storageMigration.ts\n- text.ts\n- updateReminder.ts (UNDOCUMENTED)\n- version.ts\n\n**STATUS**: âš ï¸ Two additional utilities not documented: `safariStorage.ts` and `updateReminder.ts`.\n\n---\n\n### 6. src/core/types/ Files\n**DOCUMENTED**: common, folder, timeline, keyboardShortcut, sync\n**ACTUAL** (5 files):\n- common.ts\n- folder.ts\n- keyboardShortcut.ts\n- sync.ts\n- timeline.ts\n\n**STATUS**: âœ… All documented types present. Complete match.\n\n---\n\n### 7. src/pages/ Top-Level Directories\n**DOCUMENTED**: background, popup, content, devtools, options, panel\n**ACTUAL** (6 directories):\n- background\n- content\n- devtools\n- options\n- panel\n- popup\n\n**STATUS**: âœ… All documented pages present. Complete match.\n\n---\n\n### 8. public/ Files\n**DOCUMENTED**: contentStyle.css, katex-config.js, fetchInterceptor.js\n**ACTUAL** (8 items):\n- .DS_Store (system file, not relevant)\n- contentStyle.css\n- dev-icon-128.png (UNDOCUMENTED)\n- dev-icon-32.png (UNDOCUMENTED)\n- fetchInterceptor.js\n- icon-128.png (UNDOCUMENTED)\n- icon-32.png (UNDOCUMENTED)\n- katex-config.js\n\n**STATUS**: âš ï¸ Icon files are present but not documented. These are expected static assets.\n\n---\n\n### 9. Vitest Version\n**DOCUMENTED**: Vitest 4.0.6 (jsdom environment)\n**ACTUAL**: Vitest 4.0.6 (with @vitest/coverage-v8 and @vitest/ui also at 4.0.6)\n\n**STATUS**: âœ… Version matches documentation exactly.\n\n---\n\n### 10. Vite Configuration Files\n**DOCUMENTED**: vite.config.base.ts, vite.config.chrome.ts, vite.config.firefox.ts, vite.config.safari.ts\n**ACTUAL** (4 files):\n- vite.config.base.ts\n- vite.config.chrome.ts\n- vite.config.firefox.ts\n- vite.config.safari.ts\n\n**STATUS**: âœ… All documented config files present. Note: vite.config.edge.ts not found (Edge uses Chrome build repackaging per docs).\n\n---\n\n## Summary of Discrepancies\n\n**GAPS IN DOCUMENTATION**:\n1. Missing `src/pages/content/announcement` module\n2. Missing `src/pages/content/shared` module\n3. Missing `src/core/utils/safariStorage.ts` utility\n4. Missing `src/core/utils/updateReminder.ts` utility\n5. Public icons not listed (dev-icon-*, icon-*)\n6. `src/locales/__tests__` directory not mentioned\n\n**GAPS IN ACTUAL CODEBASE**:\n1. `src/locales/zh_CN` directory documented but not found (only `zh_TW` exists)\n\nThe codebase is largely aligned with CLAUDE.md, with minor undocumented additions that appear to be legitimate features/utilities."},{"type":"text","text":"agentId: a355618 (for resuming to continue this agent's work if needed)\n<usage>total_tokens: 21636\ntool_uses: 10\nduration_ms: 19189</usage>"}]}]},"uuid":"50f2b36e-f1c2-41c7-9015-63b682cfe296","timestamp":"2026-02-16T00:00:20.840Z","toolUseResult":{"status":"completed","prompt":"I need to audit the current codebase against what's documented in CLAUDE.md. Please check these things:\n\n1. List all directories under src/features/ \n2. List all files under src/core/services/\n3. List all directories under src/pages/content/\n4. List all directories under src/locales/\n5. List all files under src/core/utils/\n6. List all files under src/core/types/\n7. List all directories under src/pages/ (top-level only)\n8. List files in public/\n9. Check package.json for the vitest version\n10. List all vite.config.*.ts files in the root\n\nPlease provide the full listing for each.","agentId":"a355618","content":[{"type":"text","text":"Perfect! I have gathered all the information. Here's the complete audit of the codebase against CLAUDE.md:\n\n## Audit Report: Codebase vs CLAUDE.md Documentation\n\n### 1. src/features/ Directories\n**DOCUMENTED**: export, folder, backup, formulaCopy, contextSync, tableCopy\n**ACTUAL** (7 directories):\n- backup\n- contextSync\n- export\n- folder\n- formulaCopy\n- tableCopy\n\n**STATUS**: âœ… All documented features present. No undocumented features found.\n\n---\n\n### 2. src/core/services/ Files\n**DOCUMENTED**: StorageService, DataBackupService, GoogleDriveSyncService, KeyboardShortcutService, StorageMonitor, DOMService, LoggerService\n**ACTUAL** (7 files):\n- DataBackupService.ts\n- DOMService.ts\n- GoogleDriveSyncService.ts\n- KeyboardShortcutService.ts\n- LoggerService.ts\n- StorageMonitor.ts\n- StorageService.ts\n\n**STATUS**: âœ… All documented services present. Complete match.\n\n---\n\n### 3. src/pages/content/ Directories\n**DOCUMENTED**: timeline, prompt, deepResearch, mermaid, watermarkRemover, sendBehavior, folder, export, chatWidth, defaultModel, folderSpacing, gemsHider, inputCollapse, katexConfig, markdownPatcher, quoteReply, recentsHider, sidebarAutoHide, sidebarWidth, titleUpdater, editInputWidth, contextSync\n**ACTUAL** (25 directories):\n- announcement (UNDOCUMENTED)\n- chatWidth\n- contextSync\n- deepResearch\n- defaultModel\n- editInputWidth\n- export\n- folder\n- folderSpacing\n- gemsHider\n- inputCollapse\n- katexConfig\n- markdownPatcher\n- mermaid\n- prompt\n- quoteReply\n- recentsHider\n- sendBehavior\n- shared (UNDOCUMENTED)\n- sidebarAutoHide\n- sidebarWidth\n- timeline\n- titleUpdater\n- watermarkRemover\n\n**STATUS**: âš ï¸ Two undocumented modules: `announcement` and `shared`. CLAUDE.md is missing these entries.\n\n---\n\n### 4. src/locales/ Directories\n**DOCUMENTED**: en, ar, es, fr, ja, ko, pt, ru, zh, zh_CN, zh_TW\n**ACTUAL** (11 locale directories + 1 test directory):\n- __tests__ (UNDOCUMENTED)\n- ar\n- en\n- es\n- fr\n- ja\n- ko\n- pt\n- ru\n- zh\n- zh_TW\n\n**STATUS**: âš ï¸ Missing zh_CN directory in actual codebase. Only 10 locales found instead of 11. __tests__ directory is undocumented.\n\n---\n\n### 5. src/core/utils/ Files\n**DOCUMENTED**: browser, extensionContext, concurrency, hash, storageMigration, array, async, gemini, selectors, text, version\n**ACTUAL** (13 files):\n- array.ts\n- async.ts\n- browser.ts\n- concurrency.ts\n- extensionContext.ts\n- gemini.ts\n- hash.ts\n- safariStorage.ts (UNDOCUMENTED)\n- selectors.ts\n- storageMigration.ts\n- text.ts\n- updateReminder.ts (UNDOCUMENTED)\n- version.ts\n\n**STATUS**: âš ï¸ Two additional utilities not documented: `safariStorage.ts` and `updateReminder.ts`.\n\n---\n\n### 6. src/core/types/ Files\n**DOCUMENTED**: common, folder, timeline, keyboardShortcut, sync\n**ACTUAL** (5 files):\n- common.ts\n- folder.ts\n- keyboardShortcut.ts\n- sync.ts\n- timeline.ts\n\n**STATUS**: âœ… All documented types present. Complete match.\n\n---\n\n### 7. src/pages/ Top-Level Directories\n**DOCUMENTED**: background, popup, content, devtools, options, panel\n**ACTUAL** (6 directories):\n- background\n- content\n- devtools\n- options\n- panel\n- popup\n\n**STATUS**: âœ… All documented pages present. Complete match.\n\n---\n\n### 8. public/ Files\n**DOCUMENTED**: contentStyle.css, katex-config.js, fetchInterceptor.js\n**ACTUAL** (8 items):\n- .DS_Store (system file, not relevant)\n- contentStyle.css\n- dev-icon-128.png (UNDOCUMENTED)\n- dev-icon-32.png (UNDOCUMENTED)\n- fetchInterceptor.js\n- icon-128.png (UNDOCUMENTED)\n- icon-32.png (UNDOCUMENTED)\n- katex-config.js\n\n**STATUS**: âš ï¸ Icon files are present but not documented. These are expected static assets.\n\n---\n\n### 9. Vitest Version\n**DOCUMENTED**: Vitest 4.0.6 (jsdom environment)\n**ACTUAL**: Vitest 4.0.6 (with @vitest/coverage-v8 and @vitest/ui also at 4.0.6)\n\n**STATUS**: âœ… Version matches documentation exactly.\n\n---\n\n### 10. Vite Configuration Files\n**DOCUMENTED**: vite.config.base.ts, vite.config.chrome.ts, vite.config.firefox.ts, vite.config.safari.ts\n**ACTUAL** (4 files):\n- vite.config.base.ts\n- vite.config.chrome.ts\n- vite.config.firefox.ts\n- vite.config.safari.ts\n\n**STATUS**: âœ… All documented config files present. Note: vite.config.edge.ts not found (Edge uses Chrome build repackaging per docs).\n\n---\n\n## Summary of Discrepancies\n\n**GAPS IN DOCUMENTATION**:\n1. Missing `src/pages/content/announcement` module\n2. Missing `src/pages/content/shared` module\n3. Missing `src/core/utils/safariStorage.ts` utility\n4. Missing `src/core/utils/updateReminder.ts` utility\n5. Public icons not listed (dev-icon-*, icon-*)\n6. `src/locales/__tests__` directory not mentioned\n\n**GAPS IN ACTUAL CODEBASE**:\n1. `src/locales/zh_CN` directory documented but not found (only `zh_TW` exists)\n\nThe codebase is largely aligned with CLAUDE.md, with minor undocumented additions that appear to be legitimate features/utilities."}],"totalDurationMs":19189,"totalTokens":21636,"totalToolUseCount":10,"usage":{"input_tokens":7,"cache_creation_input_tokens":4407,"cache_read_input_tokens":15605,"output_tokens":1617,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":4407,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"sourceToolAssistantUUID":"3150d16a-bebf-4833-9350-1873b62abcb9"}
{"parentUuid":"50f2b36e-f1c2-41c7-9015-63b682cfe296","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01MPmQkgrmWfqt3Zw6YhUAdy","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2408,"cache_read_input_tokens":35237,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2408},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmHuBieWk4g8nwbKAF9","type":"assistant","uuid":"49ed97bb-f861-422d-ba9f-4130e14404cf","timestamp":"2026-02-16T00:00:23.954Z"}
{"parentUuid":"49ed97bb-f861-422d-ba9f-4130e14404cf","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01MPmQkgrmWfqt3Zw6YhUAdy","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a clear picture of what needs updating. Let me summarize the discrepancies:\n\n1. CLAUDE.md says \"22 content script modules\" but there are actually 24 directories (including `announcement` and `shared`) under `src/pages/content/`\n2. `zh_CN` locale is documented but doesn't exist - only 10 locales (not 11)\n3. Missing `safariStorage.ts` and `updateReminder.ts` in core/utils documentation\n4. The date needs updating to 2026-02-15\n\nLet me update CLAUDE.md with these fixes, then sync AGENTS.md to match.","signature":"EqQFCkYICxgCKkBJLTt+/J2HyrPqgbP24QdvEEg0ZIu6m7S31v5L12VTaG9kPhecrcfzZUfB0oQAMYqplE9A6m78GxGIcwCApCYkEgxO5gpHa4XfwTdJIn0aDNCE6OLFCsgb7R7wbyIwenk7mJMUXDh5mJqt9DEf+3YQZA+Af97qM1LOtNrKJ7BVjBMFMRoTIVK09WReizP2KosERzdzdGlnepI9vnSpY3Hie16QdbVEDiKnYpeD18+tfaXwlkGOkyftTE6gN+36ZPaR4DL0GK5ioxYdd60oSdKw4aVeEV6eKcFTpHALUQOZNYt5cNYJIijxdSuDeVv0oEohYqc6cqJCOrPiUsT8tO9q5xu6N7a0RLDVhIGum7o/79CZ6TWOv8mOJzF6rQn9kb9+TNFkFQTD7GAvj0tYxaP9vx9ZO7pWgY2LuuEvjCn1Z/8aLN3WtVBCr9sFaX+ATOiOssYpZQBUexqSEn9dEpnVANS9I85vF0XYQBMOZOML+nbfJyu+5WTU0Nbg3V+tm6DRMXuFGvK8scSyjwTFlt8dPaaCB/erOfJjtydakKndUdgULLypNxdQxUT0GG4ePA8gWtrNiudOEJYpqaaLB/pPhsxg8/QNhBtqJNYHx4/50xjpsZVistT9S/PgJOWFdvXAgLGZPaH4do8M+GUdOlWGJP+/KxU6G98+luSlnwF4mKYZPtar1S6XE0Qtr8SZGwT/nw0/Krv5r7SJXqjE70Elw0WiDnYipRgvgbV2+bWXgfkwzVbMD5UoBS3xwIICcYHesFhz8EP283vbxKZXW+5LEKXoZYSxrrANXubsiBCkPZ7nmwZJ3SBV9UXc7dQeqEbw0B7rw6DAk9Subka2CS83YgCQC28Aa5W+WF3KzD7KKVf/Hq8GeL9laYOH9BgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2408,"cache_read_input_tokens":35237,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2408},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmHuBieWk4g8nwbKAF9","type":"assistant","uuid":"b66a0018-3786-4f8e-9851-2094ebe23582","timestamp":"2026-02-16T00:00:26.668Z"}
{"parentUuid":"b66a0018-3786-4f8e-9851-2094ebe23582","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01MPmQkgrmWfqt3Zw6YhUAdy","type":"message","role":"assistant","content":[{"type":"text","text":"Good, I have the full audit. Here are the discrepancies to fix:\n\n1. `pages/content` says \"22 modules\" but there are 24 dirs (missing `announcement`, `shared`)\n2. `zh_CN` locale documented but doesn't exist â€” only 10 locales, not 11\n3. `safariStorage.ts` and `updateReminder.ts` undocumented in core/utils\n4. Date/version need updating\n\nLet me update CLAUDE.md now."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2408,"cache_read_input_tokens":35237,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2408},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmHuBieWk4g8nwbKAF9","type":"assistant","uuid":"1f848252-0e9a-4e5b-a82b-5eb015008516","timestamp":"2026-02-16T00:00:28.346Z"}
{"parentUuid":"1f848252-0e9a-4e5b-a82b-5eb015008516","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01MPmQkgrmWfqt3Zw6YhUAdy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0156Ra1BBvJMKNGN4we1TzZR","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"> **Last Updated**: 2026-02-09\n> **Version**: 1.2.2","new_string":"> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2408,"cache_read_input_tokens":35237,"output_tokens":441,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":2408,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmHuBieWk4g8nwbKAF9","type":"assistant","uuid":"018da220-d5ef-4043-8c74-11daadbfc4ae","timestamp":"2026-02-16T00:00:30.373Z"}
{"type":"file-history-snapshot","messageId":"018da220-d5ef-4043-8c74-11daadbfc4ae","snapshot":{"messageId":"c6697242-b4f3-44c2-a763-d68840cb8cee","trackedFileBackups":{"CLAUDE.md":{"backupFileName":"6bc22c442ff258d8@v1","version":1,"backupTime":"2026-02-16T00:00:33.312Z"}},"timestamp":"2026-02-15T23:59:29.112Z"},"isSnapshotUpdate":true}
{"parentUuid":"018da220-d5ef-4043-8c74-11daadbfc4ae","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_0156Ra1BBvJMKNGN4we1TzZR","toolUseID":"toolu_0156Ra1BBvJMKNGN4we1TzZR","timestamp":"2026-02-16T00:00:33.320Z","uuid":"2d35b6ab-336b-4f35-953a-f3af6fd8070b"}
{"parentUuid":"018da220-d5ef-4043-8c74-11daadbfc4ae","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0156Ra1BBvJMKNGN4we1TzZR","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"3f18ed9c-6ebb-4cab-937c-387d1c47a088","timestamp":"2026-02-16T00:00:33.318Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"> **Last Updated**: 2026-02-09\n> **Version**: 1.2.2","newString":"> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-09\n> **Version**: 1.2.2\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (22 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":1,"oldLines":7,"newStart":1,"newLines":7,"lines":[" # CLAUDE.md - AI Assistant Guide for Gemini Voyager"," ","-> **Last Updated**: 2026-02-09","-> **Version**: 1.2.2","+> **Last Updated**: 2026-02-15","+> **Version**: 1.2.3"," > **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase"," "," ---"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"018da220-d5ef-4043-8c74-11daadbfc4ae"}
{"parentUuid":"3f18ed9c-6ebb-4cab-937c-387d1c47a088","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_011ZYwUih5WqigjbWCX34S6w","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NN5AuFQDQY6VFWscZrxTPU","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"| `pages/content`                        | **DOM Injection** (22 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |","new_string":"| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":505,"cache_read_input_tokens":37645,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":505},"output_tokens":18,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmJk4p3Uopko77LEaZm","type":"assistant","uuid":"03b263e5-0f50-482a-a685-1b05d07dcea9","timestamp":"2026-02-16T00:00:39.779Z"}
{"parentUuid":"03b263e5-0f50-482a-a685-1b05d07dcea9","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01NN5AuFQDQY6VFWscZrxTPU","toolUseID":"toolu_01NN5AuFQDQY6VFWscZrxTPU","timestamp":"2026-02-16T00:00:39.784Z","uuid":"5083c54c-03c2-457e-b5a3-e81b770654bf"}
{"parentUuid":"03b263e5-0f50-482a-a685-1b05d07dcea9","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NN5AuFQDQY6VFWscZrxTPU","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"f934f1d3-8ecf-40c4-a25a-08d7acb21c0b","timestamp":"2026-02-16T00:00:39.783Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"| `pages/content`                        | **DOM Injection** (22 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |","newString":"| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (22 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":99,"oldLines":7,"newStart":99,"newLines":7,"lines":[" | `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |"," | `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |"," | `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |","-| `pages/content`                        | **DOM Injection** (22 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |","+| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |"," | `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |"," | `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"03b263e5-0f50-482a-a685-1b05d07dcea9"}
{"parentUuid":"f934f1d3-8ecf-40c4-a25a-08d7acb21c0b","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01Ms1UnAxWDkz5ZHxundt2wQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013Y2SJnbBgZZNVQXihetLaa","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)","new_string":"â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":281,"cache_read_input_tokens":38150,"output_tokens":282,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":281,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmKDfFFKzP78jaDNSSZ","type":"assistant","uuid":"c57a3d2e-8244-4038-ad5c-253804d0d7b8","timestamp":"2026-02-16T00:00:45.205Z"}
{"parentUuid":"c57a3d2e-8244-4038-ad5c-253804d0d7b8","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_013Y2SJnbBgZZNVQXihetLaa","toolUseID":"toolu_013Y2SJnbBgZZNVQXihetLaa","timestamp":"2026-02-16T00:00:45.210Z","uuid":"5cc3a789-0145-4aae-93bc-da31e1bf3e6e"}
{"parentUuid":"c57a3d2e-8244-4038-ad5c-253804d0d7b8","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013Y2SJnbBgZZNVQXihetLaa","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"2a7884be-8a93-4304-aae2-0c54cac28d14","timestamp":"2026-02-16T00:00:45.210Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)","newString":"â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":244,"oldLines":6,"newStart":244,"newLines":8,"lines":[" â”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives"," â”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities"," â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers","+â”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers","+â”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility"," â”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)"," â”‚   â”‚   â””â”€â”€ types/                      # Global type definitions"," â”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"c57a3d2e-8244-4038-ad5c-253804d0d7b8"}
{"parentUuid":"2a7884be-8a93-4304-aae2-0c54cac28d14","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01Xk1tHxU2KtToD5PQjAYQjL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011GowwBamEi6quvAQVWeqxK","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)","new_string":"â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":327,"cache_read_input_tokens":38431,"output_tokens":448,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":327,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmKceMoYBVzajZF7fNL","type":"assistant","uuid":"2f42ca4f-2d70-44c7-a3d6-9ad14ed94dea","timestamp":"2026-02-16T00:00:51.042Z"}
{"parentUuid":"2f42ca4f-2d70-44c7-a3d6-9ad14ed94dea","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_011GowwBamEi6quvAQVWeqxK","toolUseID":"toolu_011GowwBamEi6quvAQVWeqxK","timestamp":"2026-02-16T00:00:51.048Z","uuid":"00666487-235f-491f-96cc-cea2b914fe81"}
{"parentUuid":"2f42ca4f-2d70-44c7-a3d6-9ad14ed94dea","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011GowwBamEi6quvAQVWeqxK","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"f469e9be-9d4b-4a81-9e96-e393cd6de5d2","timestamp":"2026-02-16T00:00:51.047Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)","newString":"â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":275,"oldLines":6,"newStart":275,"newLines":8,"lines":[" â”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization"," â”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management"," â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode","+â”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display","+â”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities"," â”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,"," â”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,"," â”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"2f42ca4f-2d70-44c7-a3d6-9ad14ed94dea"}
{"parentUuid":"f469e9be-9d4b-4a81-9e96-e393cd6de5d2","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01UbTpfPae7SKd6sqfLKFGUy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UFzHSsdZuWV6SrusmTDQd9","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)","new_string":"â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":493,"cache_read_input_tokens":38758,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":493},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmL3cXo5fhoYRr5KgkZ","type":"assistant","uuid":"30eb2c55-0f69-41e2-82ec-6883e3eeda15","timestamp":"2026-02-16T00:00:56.364Z"}
{"parentUuid":"30eb2c55-0f69-41e2-82ec-6883e3eeda15","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01UFzHSsdZuWV6SrusmTDQd9","toolUseID":"toolu_01UFzHSsdZuWV6SrusmTDQd9","timestamp":"2026-02-16T00:00:56.370Z","uuid":"8301bb0d-6e1b-42c1-bc4b-f6606438e554"}
{"parentUuid":"30eb2c55-0f69-41e2-82ec-6883e3eeda15","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UFzHSsdZuWV6SrusmTDQd9","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"51cab016-6188-4b52-b39b-2d3b4b537938","timestamp":"2026-02-16T00:00:56.369Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)","newString":"â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":300,"oldLines":10,"newStart":300,"newLines":10,"lines":[" â”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)"," â”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers"," â”‚   â”‚","-â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (11 languages)","+â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)"," â”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French"," â”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian","-â”‚   â”‚   â””â”€â”€ zh/    zh_CN/ zh_TW/       #   - Chinese (Traditional, Simplified, Taiwan)","+â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)"," â”‚   â”‚"," â”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS"," â”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"30eb2c55-0f69-41e2-82ec-6883e3eeda15"}
{"parentUuid":"51cab016-6188-4b52-b39b-2d3b4b537938","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01XQ5m8VbwiA9e22MXD15cvc","type":"message","role":"assistant","content":[{"type":"text","text":"Now update the locale references elsewhere in the file."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":400,"cache_read_input_tokens":39251,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":400},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmLSYuqS7VM8CqTgajH","type":"assistant","uuid":"8d43d48a-4f41-4f8f-b0e3-ab474a4623fd","timestamp":"2026-02-16T00:00:58.842Z"}
{"parentUuid":"8d43d48a-4f41-4f8f-b0e3-ab474a4623fd","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01XQ5m8VbwiA9e22MXD15cvc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Cehn1m21zzYvGneFWncm3u","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |","new_string":"| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":400,"cache_read_input_tokens":39251,"output_tokens":203,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":400,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmLSYuqS7VM8CqTgajH","type":"assistant","uuid":"e07a11b6-523d-46b3-8d5f-0ce6fef7aaa5","timestamp":"2026-02-16T00:01:00.760Z"}
{"parentUuid":"e07a11b6-523d-46b3-8d5f-0ce6fef7aaa5","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Cehn1m21zzYvGneFWncm3u","toolUseID":"toolu_01Cehn1m21zzYvGneFWncm3u","timestamp":"2026-02-16T00:01:00.769Z","uuid":"79d89e00-be55-4f25-90b2-928f30bc3bb3"}
{"parentUuid":"e07a11b6-523d-46b3-8d5f-0ce6fef7aaa5","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Cehn1m21zzYvGneFWncm3u","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"bd95a9ac-076d-4b1b-b50e-04399c10d133","timestamp":"2026-02-16T00:01:00.768Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |","newString":"| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":324,"oldLines":7,"newStart":324,"newLines":7,"lines":[" | ------------------------- | ------------------------------------------------------------------ |"," | **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |"," | **Change storage logic**  | `src/core/services/StorageService.ts`                              |","-| **Update translations**   | `src/locales/*/messages.json` (all 11 locales)                     |","+| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |"," | **Modify export format**  | `src/features/export/services/`                                    |"," | **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |"," | **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e07a11b6-523d-46b3-8d5f-0ce6fef7aaa5"}
{"parentUuid":"bd95a9ac-076d-4b1b-b50e-04399c10d133","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01UE5GuEHHhy2MNd8v8U48nU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RzjMkxXwevMB25bREpYGZK","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"- `src/locales/*`: Translation files (11 languages).","new_string":"- `src/locales/*`: Translation files (10 languages)."},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":248,"cache_read_input_tokens":39651,"output_tokens":164,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":248,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmLmDpZHzQfijqPxacd","type":"assistant","uuid":"18c5e303-88c0-4c35-9778-925fdba9746b","timestamp":"2026-02-16T00:01:04.167Z"}
{"parentUuid":"18c5e303-88c0-4c35-9778-925fdba9746b","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01RzjMkxXwevMB25bREpYGZK","toolUseID":"toolu_01RzjMkxXwevMB25bREpYGZK","timestamp":"2026-02-16T00:01:04.178Z","uuid":"83bed8f1-9a5b-4279-b732-93a302b015ba"}
{"parentUuid":"18c5e303-88c0-4c35-9778-925fdba9746b","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RzjMkxXwevMB25bREpYGZK","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"dd6fbd2d-1873-4302-9942-4dc8827c3f80","timestamp":"2026-02-16T00:01:04.177Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"- `src/locales/*`: Translation files (11 languages).","newString":"- `src/locales/*`: Translation files (10 languages).","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (11 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":346,"oldLines":7,"newStart":346,"newLines":7,"lines":[" - `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive."," - `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.)."," - `src/core/utils/extensionContext.ts`: Extension context invalidation handling.","-- `src/locales/*`: Translation files (11 languages).","+- `src/locales/*`: Translation files (10 languages)."," - `public/contentStyle.css`: Injected CSS styles for content scripts."," "," ---"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"18c5e303-88c0-4c35-9778-925fdba9746b"}
{"parentUuid":"dd6fbd2d-1873-4302-9942-4dc8827c3f80","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01PJh6VsT8ygHLgYEbpJBRnx","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me sync AGENTS.md by writing it with the same content as CLAUDE.md, but keeping the AGENTS.md frontmatter and removing the template comment."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":320,"cache_read_input_tokens":39899,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":320},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmM29WK4TwKbNCxfbR5","type":"assistant","uuid":"da2458f0-4e1b-4b75-be9a-417779ff3c1f","timestamp":"2026-02-16T00:01:07.445Z"}
{"parentUuid":"da2458f0-4e1b-4b75-be9a-417779ff3c1f","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01PJh6VsT8ygHLgYEbpJBRnx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013YLd6eXTYENPd5rAyYcKpn","name":"Read","input":{"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":320,"cache_read_input_tokens":39899,"output_tokens":117,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":320,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmM29WK4TwKbNCxfbR5","type":"assistant","uuid":"09b16650-60b9-48d3-ab02-21b8dea271a3","timestamp":"2026-02-16T00:01:08.056Z"}
{"parentUuid":"09b16650-60b9-48d3-ab02-21b8dea271a3","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_013YLd6eXTYENPd5rAyYcKpn","toolUseID":"toolu_013YLd6eXTYENPd5rAyYcKpn","timestamp":"2026-02-16T00:01:08.093Z","uuid":"750120ec-9093-471e-83d2-6c937b82e94c"}
{"parentUuid":"09b16650-60b9-48d3-ab02-21b8dea271a3","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013YLd6eXTYENPd5rAyYcKpn","type":"tool_result","content":"     1â†’# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n     2â†’\n     3â†’> **Last Updated**: 2026-02-15\n     4â†’> **Version**: 1.2.3\n     5â†’> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n     6â†’\n     7â†’---\n     8â†’\n     9â†’## 1. Role & Core Mandates\n    10â†’\n    11â†’**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n    12â†’\n    13â†’**Core Mandates**:\n    14â†’\n    15â†’1.  **Safety First**: Never commit secrets. Validate all system operations.\n    16â†’2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n    17â†’3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n    18â†’4.  **Testing**: Every feature and fix must include tests.\n    19â†’5.  **Documentation**: Keep documentation and translations in sync with code changes.\n    20â†’\n    21â†’---\n    22â†’\n    23â†’## 2. Operational Methodology\n    24â†’\n    25â†’Before writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n    26â†’\n    27â†’### Phase 1: The Three Questions\n    28â†’\n    29â†’Ask yourself before starting:\n    30â†’\n    31â†’1.  **\"Is this a real problem?\"** - Reject over-engineering.\n    32â†’2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n    33â†’3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n    34â†’\n    35â†’### Phase 2: Requirements Analysis\n    36â†’\n    37â†’When analyzing a request:\n    38â†’\n    39â†’1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    40â†’    - What is the core data? Who owns it?\n    41â†’    - Can we redesign data structures to eliminate branches/complexity?\n    42â†’2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    43â†’    - Identify `if/else` branches that patch bad design.\n    44â†’    - Refactor to make the \"special case\" the normal case.\n    45â†’3.  **Destructive Analysis**:\n    46â†’    - List all existing features that might be affected.\n    47â†’    - Ensure zero destructiveness to user data (especially `localStorage`).\n    48â†’\n    49â†’### Phase 3: Decision Output\n    50â†’\n    51â†’If a task is complex or ambiguous, present your analysis in this format:\n    52â†’\n    53â†’```text\n    54â†’ã€Core Judgmentã€‘\n    55â†’âœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n    56â†’\n    57â†’ã€Key Insightsã€‘\n    58â†’- Data structure: [most critical data relationships]\n    59â†’- Complexity: [complexity that can be eliminated]\n    60â†’- Risks: [potential breaking changes]\n    61â†’\n    62â†’ã€Planã€‘\n    63â†’1. Simplify data structures...\n    64â†’2. Eliminate special cases...\n    65â†’3. Implementation steps...\n    66â†’```\n    67â†’\n    68â†’---\n    69â†’\n    70â†’## 3. Tool Usage & Verification Protocols\n    71â†’\n    72â†’Strictly adhere to these protocols to prevent errors and ensure data integrity.\n    73â†’\n    74â†’### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n    75â†’\n    76â†’1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    77â†’    - _Tool_: `read_file`\n    78â†’2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    79â†’    - _Tool_: `write_file` or `replace`\n    80â†’3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    81â†’    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n    82â†’\n    83â†’### ğŸš¨ Critical Safety Checks\n    84â†’\n    85â†’- **Never** modify `dist_*` folders directly.\n    86â†’- **Never** commit `.env` or secrets.\n    87â†’- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n    88â†’- **Always** run `bun run lint` before finishing.\n    89â†’\n    90â†’---\n    91â†’\n    92â†’## 4. Module Glossary & Complexity Hotspots\n    93â†’\n    94â†’| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n    95â†’| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n    96â†’| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n    97â†’| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n    98â†’| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n    99â†’| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n   100â†’| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n   101â†’| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n   102â†’| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n   103â†’| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n   104â†’| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n   105â†’\n   106â†’---\n   107â†’\n   108â†’## 5. Development Standards & Anti-Patterns\n   109â†’\n   110â†’### âœ… DOs\n   111â†’\n   112â†’- **Prefer Plain Objects**: Use interfaces/types for data structures.\n   113â†’- **Immutability**: Use `map`, `filter`, `reduce`.\n   114â†’- **Encapsulation**: Use `private`/`protected` in classes.\n   115â†’- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n   116â†’- **Named Exports**: `export function X` (easier refactoring).\n   117â†’- **Functional React**: Hooks at top level, strictly functional components.\n   118â†’\n   119â†’### âŒ DON'Ts (Anti-Patterns)\n   120â†’\n   121â†’- **Global State Pollution**: Never use global variables outside of defined Services.\n   122â†’- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n   123â†’- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n   124â†’- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n   125â†’- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n   126â†’- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n   127â†’\n   128â†’---\n   129â†’\n   130â†’## 6. Testing Strategy\n   131â†’\n   132â†’**Framework**: Vitest 4.0.6 (jsdom environment)\n   133â†’\n   134â†’### TDD Workflow Guidelines\n   135â†’\n   136â†’1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n   137â†’2.  **Fail**: Ensure the test fails (validates the test itself).\n   138â†’3.  **Implement**: Write the minimal code to pass the test.\n   139â†’4.  **Refactor**: Clean up the code while keeping tests green.\n   140â†’\n   141â†’### Mocking Patterns\n   142â†’\n   143â†’This project relies heavily on `vi.mock` for Chrome APIs and external services.\n   144â†’\n   145â†’**Mocking Chrome API**:\n   146â†’The global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n   147â†’\n   148â†’```typescript\n   149â†’// Example: Mocking specific storage behavior for a test\n   150â†’beforeEach(() => {\n   151â†’  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n   152â†’});\n   153â†’```\n   154â†’\n   155â†’**Running Tests**:\n   156â†’\n   157â†’```bash\n   158â†’bun run test                # Run all tests\n   159â†’bun run test <filename>     # Run specific test file\n   160â†’bun run test:watch          # Interactive mode\n   161â†’bun run test:coverage       # Check coverage\n   162â†’```\n   163â†’\n   164â†’---\n   165â†’\n   166â†’## 7. Workflows & Definition of Done\n   167â†’\n   168â†’### Setup\n   169â†’\n   170â†’```bash\n   171â†’bun install\n   172â†’```\n   173â†’\n   174â†’### Development\n   175â†’\n   176â†’```bash\n   177â†’# Start Dev Server\n   178â†’bun run dev:chrome\n   179â†’bun run dev:firefox\n   180â†’bun run dev:safari\n   181â†’\n   182â†’# Build for production\n   183â†’bun run build:chrome\n   184â†’bun run build:firefox\n   185â†’bun run build:safari\n   186â†’bun run build:edge        # Repackages Chrome build for Edge\n   187â†’bun run build:all         # Build all platforms\n   188â†’\n   189â†’# Documentation site (VitePress)\n   190â†’bun run docs:dev\n   191â†’bun run docs:build\n   192â†’```\n   193â†’\n   194â†’_Note: Uses Nodemon for hot-reloading content scripts._\n   195â†’\n   196â†’### Commit Messages (commitlint)\n   197â†’\n   198â†’Use Conventional Commits format:\n   199â†’\n   200â†’```\n   201â†’<type>(<scope>): <imperative summary>\n   202â†’```\n   203â†’\n   204â†’- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n   205â†’- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n   206â†’- summary: lowercase, imperative, no trailing period\n   207â†’\n   208â†’Examples:\n   209â†’\n   210â†’- `fix(copy): handle clipboard fallback`\n   211â†’- `refactor(copy): introduce temml to convert tex2mathml`\n   212â†’- `chore: update sponsors.svg`\n   213â†’\n   214â†’### Definition of Done (DoD)\n   215â†’\n   216â†’Before claiming a task is complete, verify:\n   217â†’\n   218â†’1.  **Functionality**: Does it meet the requirements?\n   219â†’2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n   220â†’3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n   221â†’4.  **Linting**: Code formatted and linted (`bun run lint`)?\n   222â†’5.  **Build**: Does it build without error (`bun run build`)?\n   223â†’6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n   224â†’\n   225â†’---\n   226â†’\n   227â†’## 8. Repository Structure & File Map\n   228â†’\n   229â†’```\n   230â†’gemini-voyager/\n   231â†’â”œâ”€â”€ src/\n   232â†’â”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\n   233â†’â”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\n   234â†’â”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\n   235â†’â”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\n   236â†’â”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\n   237â†’â”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\n   238â†’â”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\n   239â†’â”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\n   240â†’â”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\n   241â†’â”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\n   242â†’â”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\n   243â†’â”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\n   244â†’â”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\n   245â†’â”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\n   246â†’â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\n   247â†’â”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\n   248â†’â”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\n   249â†’â”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\n   250â†’â”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\n   251â†’â”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\n   252â†’â”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\n   253â†’â”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\n   254â†’â”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\n   255â†’â”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\n   256â†’â”‚   â”‚\n   257â†’â”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\n   258â†’â”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\n   259â†’â”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\n   260â†’â”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\n   261â†’â”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\n   262â†’â”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\n   263â†’â”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\n   264â†’â”‚   â”‚\n   265â†’â”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\n   266â†’â”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\n   267â†’â”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\n   268â†’â”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\n   269â†’â”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\n   270â†’â”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\n   271â†’â”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\n   272â†’â”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\n   273â†’â”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\n   274â†’â”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\n   275â†’â”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\n   276â†’â”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\n   277â†’â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\n   278â†’â”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\n   279â†’â”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\n   280â†’â”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\n   281â†’â”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\n   282â†’â”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\n   283â†’â”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\n   284â†’â”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\n   285â†’â”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\n   286â†’â”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\n   287â†’â”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\n   288â†’â”‚   â”‚\n   289â†’â”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\n   290â†’â”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\n   291â†’â”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\n   292â†’â”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\n   293â†’â”‚   â”‚\n   294â†’â”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\n   295â†’â”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\n   296â†’â”‚   â”‚\n   297â†’â”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\n   298â†’â”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\n   299â†’â”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\n   300â†’â”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\n   301â†’â”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\n   302â†’â”‚   â”‚\n   303â†’â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\n   304â†’â”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\n   305â†’â”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\n   306â†’â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\n   307â†’â”‚   â”‚\n   308â†’â”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\n   309â†’â”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\n   310â†’â”‚\n   311â†’â”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\n   312â†’â”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\n   313â†’â”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\n   314â†’â”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\n   315â†’â”‚\n   316â†’â”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\n   317â†’â”‚\n   318â†’â””â”€â”€ ... (config files)\n   319â†’```\n   320â†’\n   321â†’### ğŸ“ Where to Look (Task Map)\n   322â†’\n   323â†’| Task                      | File Path / Directory                                              |\n   324â†’| ------------------------- | ------------------------------------------------------------------ |\n   325â†’| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n   326â†’| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n   327â†’| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n   328â†’| **Modify export format**  | `src/features/export/services/`                                    |\n   329â†’| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n   330â†’| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n   331â†’| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n   332â†’| **Change DOM injection**  | `src/pages/content/`                                               |\n   333â†’| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n   334â†’| **Modify popup settings** | `src/pages/popup/components/`                                      |\n   335â†’| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n   336â†’\n   337â†’---\n   338â†’\n   339â†’## 9. Important Files\n   340â†’\n   341â†’- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n   342â†’- `vite.config.base.ts`: Shared build configuration.\n   343â†’- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n   344â†’- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n   345â†’- `src/core/services/StorageService.ts`: Data persistence layer.\n   346â†’- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n   347â†’- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n   348â†’- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n   349â†’- `src/locales/*`: Translation files (10 languages).\n   350â†’- `public/contentStyle.css`: Injected CSS styles for content scripts.\n   351â†’\n   352â†’---\n   353â†’\n   354â†’## 10. Troubleshooting\n   355â†’\n   356â†’- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n   357â†’- **HMR Issues**: Reload the extension in `chrome://extensions`.\n   358â†’- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n   359â†’- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n   360â†’- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n   361â†’\n   362â†’---\n   363â†’"}]},"uuid":"61dce6e8-f3ac-41ea-b9d2-1a19ad99f6af","timestamp":"2026-02-16T00:01:08.092Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","content":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (10 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","numLines":363,"startLine":1,"totalLines":363}},"sourceToolAssistantUUID":"09b16650-60b9-48d3-ab02-21b8dea271a3"}
{"parentUuid":"61dce6e8-f3ac-41ea-b9d2-1a19ad99f6af","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01BpQQtYFLWKUuH3RiJah2CS","type":"message","role":"assistant","content":[{"type":"text","text":"CLAUDE.md looks good. Now let me write AGENTS.md with the same content, keeping the frontmatter but removing the obsolete template comment."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":6193,"cache_read_input_tokens":40219,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":6193},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmMNj1W1SJg3GA6riKP","type":"assistant","uuid":"30085ce6-ab8f-4c94-86a8-27b50934ab65","timestamp":"2026-02-16T00:01:12.653Z"}
{"type":"file-history-snapshot","messageId":"88979052-9883-44ca-96c9-460361b3a6db","snapshot":{"messageId":"c6697242-b4f3-44c2-a763-d68840cb8cee","trackedFileBackups":{"CLAUDE.md":{"backupFileName":"6bc22c442ff258d8@v1","version":1,"backupTime":"2026-02-16T00:00:33.312Z"},"AGENTS.md":{"backupFileName":"f8311644562c4f17@v1","version":1,"backupTime":"2026-02-16T00:02:26.263Z"}},"timestamp":"2026-02-15T23:59:29.112Z"},"isSnapshotUpdate":true}
{"parentUuid":"30085ce6-ab8f-4c94-86a8-27b50934ab65","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01BpQQtYFLWKUuH3RiJah2CS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015hqemNWACWw8fdq4Sru34R","name":"Write","input":{"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md","content":"---\ntrigger: always_on\n---\n\n# AGENTS.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (10 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":6193,"cache_read_input_tokens":40219,"output_tokens":5037,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":6193,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmMNj1W1SJg3GA6riKP","type":"assistant","uuid":"88979052-9883-44ca-96c9-460361b3a6db","timestamp":"2026-02-16T00:02:26.256Z"}
{"parentUuid":"88979052-9883-44ca-96c9-460361b3a6db","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Write","command":"callback"},"parentToolUseID":"toolu_015hqemNWACWw8fdq4Sru34R","toolUseID":"toolu_015hqemNWACWw8fdq4Sru34R","timestamp":"2026-02-16T00:02:26.276Z","uuid":"441de3b7-f769-4459-a579-e0a538b914b4"}
{"parentUuid":"88979052-9883-44ca-96c9-460361b3a6db","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015hqemNWACWw8fdq4Sru34R","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1â†’---\n     2â†’trigger: always_on\n     3â†’---\n     4â†’\n     5â†’# AGENTS.md - AI Assistant Guide for Gemini Voyager\n     6â†’\n     7â†’> **Last Updated**: 2026-02-15\n     8â†’> **Version**: 1.2.3\n     9â†’> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n    10â†’\n    11â†’---\n    12â†’\n    13â†’## 1. Role & Core Mandates\n    14â†’\n    15â†’**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n    16â†’\n    17â†’**Core Mandates**:\n    18â†’\n    19â†’1.  **Safety First**: Never commit secrets. Validate all system operations.\n    20â†’2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n    21â†’3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n    22â†’4.  **Testing**: Every feature and fix must include tests.\n    23â†’5.  **Documentation**: Keep documentation and translations in sync with code changes.\n    24â†’\n    25â†’---\n    26â†’\n    27â†’## 2. Operational Methodology\n    28â†’\n    29â†’Before writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n    30â†’\n    31â†’### Phase 1: The Three Questions\n    32â†’\n    33â†’Ask yourself before starting:\n    34â†’\n    35â†’1.  **\"Is this a real problem?\"** - Reject over-engineering.\n    36â†’2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n    37â†’3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n    38â†’\n    39â†’### Phase 2: Requirements Analysis\n    40â†’\n    41â†’When analyzing a request:\n    42â†’\n    43â†’1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    44â†’    - What is the core data? Who owns it?\n    45â†’    - Can we redesign data structures to eliminate branches/complexity?\n    46â†’2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    47â†’    - Identify `if/else` branches that patch bad design.\n    48â†’    - Refactor to make the \"special case\" the normal case.\n    49â†’3.  **Destructive Analysis**:\n    50â†’    - List all existing features that might be affected.\n    51â†’    - Ensure zero destructiveness to user data (especially `localStorage`).\n    52â†’\n    53â†’### Phase 3: Decision Output\n    54â†’\n    55â†’If a task is complex or ambiguous, present your analysis in this format:\n    56â†’\n    57â†’```text\n    58â†’ã€Core Judgmentã€‘\n    59â†’âœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n    60â†’\n    61â†’ã€Key Insightsã€‘\n    62â†’- Data structure: [most critical data relationships]\n    63â†’- Complexity: [complexity that can be eliminated]\n    64â†’- Risks: [potential breaking changes]\n    65â†’\n    66â†’ã€Planã€‘\n    67â†’1. Simplify data structures...\n    68â†’2. Eliminate special cases...\n    69â†’3. Implementation steps...\n    70â†’```\n    71â†’\n    72â†’---\n    73â†’\n    74â†’## 3. Tool Usage & Verification Protocols\n    75â†’\n    76â†’Strictly adhere to these protocols to prevent errors and ensure data integrity.\n    77â†’\n    78â†’### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n    79â†’\n    80â†’1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    81â†’    - _Tool_: `read_file`\n    82â†’2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    83â†’    - _Tool_: `write_file` or `replace`\n    84â†’3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    85â†’    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n    86â†’\n    87â†’### ğŸš¨ Critical Safety Checks\n    88â†’\n    89â†’- **Never** modify `dist_*` folders directly.\n    90â†’- **Never** commit `.env` or secrets.\n    91â†’- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n    92â†’- **Always** run `bun run lint` before finishing.\n    93â†’\n    94â†’---\n    95â†’\n    96â†’## 4. Module Glossary & Complexity Hotspots\n    97â†’\n    98â†’| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n    99â†’| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n   100â†’| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n   101â†’| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n   102â†’| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n   103â†’| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n   104â†’| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n   105â†’| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n   106â†’| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n   107â†’| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n   108â†’| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n   109â†’\n   110â†’---\n   111â†’\n   112â†’## 5. Development Standards & Anti-Patterns\n   113â†’\n   114â†’### âœ… DOs\n   115â†’\n   116â†’- **Prefer Plain Objects**: Use interfaces/types for data structures.\n   117â†’- **Immutability**: Use `map`, `filter`, `reduce`.\n   118â†’- **Encapsulation**: Use `private`/`protected` in classes.\n   119â†’- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n   120â†’- **Named Exports**: `export function X` (easier refactoring).\n   121â†’- **Functional React**: Hooks at top level, strictly functional components.\n   122â†’\n   123â†’### âŒ DON'Ts (Anti-Patterns)\n   124â†’\n   125â†’- **Global State Pollution**: Never use global variables outside of defined Services.\n   126â†’- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n   127â†’- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n   128â†’- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n   129â†’- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n   130â†’- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n   131â†’\n   132â†’---\n   133â†’\n   134â†’## 6. Testing Strategy\n   135â†’\n   136â†’**Framework**: Vitest 4.0.6 (jsdom environment)\n   137â†’\n   138â†’### TDD Workflow Guidelines\n   139â†’\n   140â†’1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n   141â†’2.  **Fail**: Ensure the test fails (validates the test itself).\n   142â†’3.  **Implement**: Write the minimal code to pass the test.\n   143â†’4.  **Refactor**: Clean up the code while keeping tests green.\n   144â†’\n   145â†’### Mocking Patterns\n   146â†’\n   147â†’This project relies heavily on `vi.mock` for Chrome APIs and external services.\n   148â†’\n   149â†’**Mocking Chrome API**:\n   150â†’The global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n   151â†’\n   152â†’```typescript\n   153â†’// Example: Mocking specific storage behavior for a test\n   154â†’beforeEach(() => {\n   155â†’  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n   156â†’});\n   157â†’```\n   158â†’\n   159â†’**Running Tests**:\n   160â†’\n   161â†’```bash\n   162â†’bun run test                # Run all tests\n   163â†’bun run test <filename>     # Run specific test file\n   164â†’bun run test:watch          # Interactive mode\n   165â†’bun run test:coverage       # Check coverage\n   166â†’```\n   167â†’\n   168â†’---\n   169â†’\n   170â†’## 7. Workflows & Definition of Done\n   171â†’\n   172â†’### Setup\n   173â†’\n   174â†’```bash\n   175â†’bun install\n   176â†’```\n   177â†’\n   178â†’### Development\n   179â†’\n   180â†’```bash\n   181â†’# Start Dev Server\n   182â†’bun run dev:chrome\n   183â†’bun run dev:firefox\n   184â†’bun run dev:safari\n   185â†’\n   186â†’# Build for production\n   187â†’bun run build:chrome\n   188â†’bun run build:firefox\n   189â†’bun run build:safari\n   190â†’bun run build:edge        # Repackages Chrome build for Edge\n   191â†’bun run build:all         # Build all platforms\n   192â†’\n   193â†’# Documentation site (VitePress)\n   194â†’bun run docs:dev\n   195â†’bun run docs:build\n   196â†’```\n   197â†’\n   198â†’_Note: Uses Nodemon for hot-reloading content scripts._\n   199â†’\n   200â†’### Commit Messages (commitlint)\n   201â†’\n   202â†’Use Conventional Commits format:\n   203â†’\n   204â†’```\n   205â†’<type>(<scope>): <imperative summary>\n   206â†’```\n   207â†’\n   208â†’- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n   209â†’- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n   210â†’- summary: lowercase, imperative, no trailing period\n   211â†’\n   212â†’Examples:\n   213â†’\n   214â†’- `fix(copy): handle clipboard fallback`\n   215â†’- `refactor(copy): introduce temml to convert tex2mathml`\n   216â†’- `chore: update sponsors.svg`\n   217â†’\n   218â†’### Definition of Done (DoD)\n   219â†’\n   220â†’Before claiming a task is complete, verify:\n   221â†’\n   222â†’1.  **Functionality**: Does it meet the requirements?\n   223â†’2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n   224â†’3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n   225â†’4.  **Linting**: Code formatted and linted (`bun run lint`)?\n   226â†’5.  **Build**: Does it build without error (`bun run build`)?\n   227â†’6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n   228â†’\n   229â†’---\n   230â†’\n   231â†’## 8. Repository Structure & File Map\n   232â†’\n   233â†’```\n   234â†’gemini-voyager/\n   235â†’â”œâ”€â”€ src/\n   236â†’â”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\n   237â†’â”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\n   238â†’â”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\n   239â†’â”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\n   240â†’â”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\n   241â†’â”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\n   242â†’â”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\n   243â†’â”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\n   244â†’â”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\n   245â†’â”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\n   246â†’â”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\n   247â†’â”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\n   248â†’â”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\n   249â†’â”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\n   250â†’â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\n   251â†’â”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\n   252â†’â”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\n   253â†’â”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\n   254â†’â”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\n   255â†’â”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\n   256â†’â”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\n   257â†’â”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\n   258â†’â”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\n   259â†’â”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\n   260â†’â”‚   â”‚\n   261â†’â”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\n   262â†’â”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\n   263â†’â”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\n   264â†’â”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\n   265â†’â”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\n   266â†’â”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\n   267â†’â”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\n   268â†’â”‚   â”‚\n   269â†’â”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\n   270â†’â”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\n   271â†’â”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\n   272â†’â”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\n   273â†’â”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\n   274â†’â”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\n   275â†’â”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\n   276â†’â”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\n   277â†’â”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\n   278â†’â”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\n   279â†’â”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\n   280â†’â”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\n   281â†’â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\n   282â†’â”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\n   283â†’â”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\n   284â†’â”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\n   285â†’â”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\n   286â†’â”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\n   287â†’â”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\n   288â†’â”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\n   289â†’â”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\n   290â†’â”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\n   291â†’â”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\n   292â†’â”‚   â”‚\n   293â†’â”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\n   294â†’â”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\n   295â†’â”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\n   296â†’â”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\n   297â†’â”‚   â”‚\n   298â†’â”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\n   299â†’â”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\n   300â†’â”‚   â”‚\n   301â†’â”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\n   302â†’â”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\n   303â†’â”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\n   304â†’â”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\n   305â†’â”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\n   306â†’â”‚   â”‚\n   307â†’â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\n   308â†’â”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\n   309â†’â”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\n   310â†’â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\n   311â†’â”‚   â”‚\n   312â†’â”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\n   313â†’â”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\n   314â†’â”‚\n   315â†’â”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\n   316â†’â”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\n   317â†’â”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\n   318â†’â”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\n   319â†’â”‚\n   320â†’â”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\n   321â†’â”‚\n   322â†’â””â”€â”€ ... (config files)\n   323â†’```\n   324â†’\n   325â†’### ğŸ“ Where to Look (Task Map)\n   326â†’\n   327â†’| Task                      | File Path / Directory                                              |\n   328â†’| ------------------------- | ------------------------------------------------------------------ |\n   329â†’| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n   330â†’| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n   331â†’| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n   332â†’| **Modify export format**  | `src/features/export/services/`                                    |\n   333â†’| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n   334â†’| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n   335â†’| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n   336â†’| **Change DOM injection**  | `src/pages/content/`                                               |\n   337â†’| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n   338â†’| **Modify popup settings** | `src/pages/popup/components/`                                      |\n   339â†’| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n   340â†’\n   341â†’---\n   342â†’\n   343â†’## 9. Important Files\n   344â†’\n   345â†’- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n   346â†’- `vite.config.base.ts`: Shared build configuration.\n   347â†’- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n   348â†’- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n   349â†’- `src/core/services/StorageService.ts`: Data persistence layer.\n   350â†’- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n   351â†’- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n   352â†’- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n   353â†’- `src/locales/*`: Translation files (10 languages).\n   354â†’- `public/contentStyle.css`: Injected CSS styles for content scripts.\n   355â†’\n   356â†’---\n   357â†’\n   358â†’## 10. Troubleshooting\n   359â†’\n   360â†’- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n   361â†’- **HMR Issues**: Reload the extension in `chrome://extensions`.\n   362â†’- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n   363â†’- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n   364â†’- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n   365â†’\n   366â†’---\n   367â†’"}]},"uuid":"34528171-2876-4c0f-9dda-20aaaaa2a252","timestamp":"2026-02-16T00:02:26.275Z","toolUseResult":{"type":"update","filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md","content":"---\ntrigger: always_on\n---\n\n# AGENTS.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (10 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":4,"oldLines":13,"newStart":4,"newLines":8,"lines":[" "," # AGENTS.md - AI Assistant Guide for Gemini Voyager"," ","-<!--","-This file is generated from AI_GUIDE.template.md.","-Do not edit directly; update the template and run `bun run generate:ai-guides`.","--->","-","-> **Last Updated**: 2026-02-04","-> **Version**: 1.1.9","+> **Last Updated**: 2026-02-15","+> **Version**: 1.2.3"," > **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase"," "," ---"]},{"oldStart":100,"oldLines":14,"newStart":95,"newLines":17,"lines":[" "," ## 4. Module Glossary & Complexity Hotspots"," ","-| Module (Path)                     | Responsibility                              | Complexity | Notes                                                                          |","-| --------------------------------- | ------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |","-| `core/services/StorageService`    | **Single Source of Truth** for persistence. | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |","-| `core/services/DataBackupService` | Multi-layer backup protection.              | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |","-| `features/folder`                 | Drag-and-drop folder logic.                 | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |","-| `features/export`                 | Chat export (JSON/MD/PDF).                  | ğŸŸ¡ Medium  | PDF generation relies on specific DOM structure. Fragile to Gemini UI changes. |","-| `features/backup`                 | File System Access API.                     | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |","-| `pages/content`                   | **DOM Injection**.                          | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension.                                        |","+| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |","+| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |","+| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |","+| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |","+| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |","+| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |","+| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |","+| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |","+| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |","+| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |","+| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |"," "," ---"," "]},{"oldStart":180,"oldLines":11,"newStart":178,"newLines":21,"lines":[" ### Development"," "," ```bash","-# Start Dev Server (Chrome)","+# Start Dev Server"," bun run dev:chrome","-","-# Start Dev Server (Firefox)"," bun run dev:firefox","+bun run dev:safari","+","+# Build for production","+bun run build:chrome","+bun run build:firefox","+bun run build:safari","+bun run build:edge        # Repackages Chrome build for Edge","+bun run build:all         # Build all platforms","+","+# Documentation site (VitePress)","+bun run docs:dev","+bun run docs:build"," ```"," "," _Note: Uses Nodemon for hot-reloading content scripts._"]},{"oldStart":225,"oldLines":68,"newStart":233,"newLines":125,"lines":[" ```"," gemini-voyager/"," â”œâ”€â”€ src/","-â”‚   â”œâ”€â”€ core/                     # ğŸ§  CORE LOGIC (Foundation)","-â”‚   â”‚   â”œâ”€â”€ services/             # Singleton Services","-â”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts #   - Central persistence layer","-â”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts     #   - Safe DOM manipulation","-â”‚   â”‚   â”‚   â”œâ”€â”€ LoggerService.ts  #   - Structured logging","-â”‚   â”‚   â”‚   â””â”€â”€ ...","-â”‚   â”‚   â”œâ”€â”€ utils/                # Core utilities (hashing, concurrency)","-â”‚   â”‚   â””â”€â”€ types/                # Global type definitions","+â”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)","+â”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services","+â”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer","+â”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection","+â”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)","+â”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts","+â”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring","+â”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation","+â”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging","+â”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities","+â”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)","+â”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation","+â”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives","+â”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities","+â”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers","+â”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers","+â”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility","+â”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)","+â”‚   â”‚   â””â”€â”€ types/                      # Global type definitions","+â”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types","+â”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types","+â”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types","+â”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types","+â”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types"," â”‚   â”‚","-â”‚   â”œâ”€â”€ features/                 # ğŸ§© FEATURES (Domain Logic)","-â”‚   â”‚   â”œâ”€â”€ export/               #   - Export (JSON/MD/PDF)","-â”‚   â”‚   â”œâ”€â”€ folder/               #   - Folder organization","-â”‚   â”‚   â”œâ”€â”€ backup/               #   - File System backup","-â”‚   â”‚   â””â”€â”€ formulaCopy/          #   - LaTeX copy","+â”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)","+â”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)","+â”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization","+â”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup","+â”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy","+â”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync","+â”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying"," â”‚   â”‚","-â”‚   â”œâ”€â”€ pages/                    # ğŸšª ENTRY POINTS (Application)","-â”‚   â”‚   â”œâ”€â”€ background/           #   - Service Worker","-â”‚   â”‚   â”œâ”€â”€ popup/                #   - Settings UI","-â”‚   â”‚   â””â”€â”€ content/              #   - Content Scripts (Gemini Injection)","-â”‚   â”‚       â”œâ”€â”€ timeline/         #       * Timeline navigation","-â”‚   â”‚       â”œâ”€â”€ prompt/           #       * Prompt manager","-â”‚   â”‚       â”œâ”€â”€ deepResearch/     #       * Deep research tool","-â”‚   â”‚       â””â”€â”€ ...               #       * (Feature integrations)","+â”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)","+â”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker","+â”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI","+â”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.","+â”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)","+â”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation","+â”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager","+â”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool","+â”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering","+â”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal","+â”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization","+â”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management","+â”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode","+â”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display","+â”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities","+â”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,","+â”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,","+â”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,","+â”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,","+â”‚   â”‚   â”‚                              #          editInputWidth, contextSync)","+â”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel","+â”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page","+â”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel"," â”‚   â”‚","-â”‚   â”œâ”€â”€ components/               # ğŸ§± UI COMPONENTS (Presentation)","-â”‚   â”‚   â””â”€â”€ ui/                   #   - Generic UI (Buttons, Dialogs)","+â”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)","+â”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)","+â”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle","+â”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher"," â”‚   â”‚","-â”‚   â”œâ”€â”€ locales/                  # ğŸŒ TRANSLATIONS","-â”‚   â”‚   â”œâ”€â”€ en/messages.json      #   - English","-â”‚   â”‚   â””â”€â”€ zh/messages.json      #   - Chinese","+â”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS","+â”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider"," â”‚   â”‚","-â”‚   â””â”€â”€ tests/                    # ğŸ§ª GLOBAL TESTS","-â”‚       â””â”€â”€ setup.ts              #   - Vitest setup & mocks","+â”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES","+â”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization","+â”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization","+â”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)","+â”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers","+â”‚   â”‚","+â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)","+â”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French","+â”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian","+â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","+â”‚   â”‚","+â”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS","+â”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks"," â”‚","-â”œâ”€â”€ public/                       # ğŸ“¦ STATIC ASSETS","-â”‚   â”œâ”€â”€ katex-config.js           #   - KaTeX configuration","-â”‚   â””â”€â”€ fetchInterceptor.js       #   - Network interception","+â”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS","+â”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles","+â”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration","+â”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)"," â”‚","+â”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)","+â”‚"," â””â”€â”€ ... (config files)"," ```"," "," ### ğŸ“ Where to Look (Task Map)"," ","-| Task                     | File Path / Directory                                              |","-| ------------------------ | ------------------------------------------------------------------ |","-| **Add new storage key**  | `src/core/types/common.ts` (StorageKeys)                           |","-| **Change storage logic** | `src/core/services/StorageService.ts`                              |","-| **Update translations**  | `src/locales/{en,zh}/messages.json`                                |","-| **Modify export format** | `src/features/export/services/`                                    |","-| **Fix backup issues**    | `src/core/services/DataBackupService.ts` or `src/features/backup/` |","-| **Adjust UI styles**     | `src/components/ui/` or `src/assets/styles/`                       |","-| **Change DOM injection** | `src/pages/content/`                                               |","+| Task                      | File Path / Directory                                              |","+| ------------------------- | ------------------------------------------------------------------ |","+| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |","+| **Change storage logic**  | `src/core/services/StorageService.ts`                              |","+| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |","+| **Modify export format**  | `src/features/export/services/`                                    |","+| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |","+| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |","+| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |","+| **Change DOM injection**  | `src/pages/content/`                                               |","+| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |","+| **Modify popup settings** | `src/pages/popup/components/`                                      |","+| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |"," "," ---"," "," ## 9. Important Files"," ","-- `manifest.json` / `manifest.dev.json`: Extension capabilities.","-- `vite.config.*.ts`: Build configurations.","-- `src/core/types/common.ts`: Centralized types and constants.","+- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).","+- `vite.config.base.ts`: Shared build configuration.","+- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.","+- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants."," - `src/core/services/StorageService.ts`: Data persistence layer.","-- `src/locales/*`: Translation files.","+- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.","+- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).","+- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.","+- `src/locales/*`: Translation files (10 languages).","+- `public/contentStyle.css`: Injected CSS styles for content scripts."," "," ---"," "]},{"oldStart":295,"oldLines":5,"newStart":360,"newLines":7,"lines":[" - **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`."," - **HMR Issues**: Reload the extension in `chrome://extensions`."," - **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).","+- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.","+- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully."," "," ---"]}],"originalFile":"---\ntrigger: always_on\n---\n\n# AGENTS.md - AI Assistant Guide for Gemini Voyager\n\n<!--\nThis file is generated from AI_GUIDE.template.md.\nDo not edit directly; update the template and run `bun run generate:ai-guides`.\n-->\n\n> **Last Updated**: 2026-02-04\n> **Version**: 1.1.9\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                     | Responsibility                              | Complexity | Notes                                                                          |\n| --------------------------------- | ------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`    | **Single Source of Truth** for persistence. | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService` | Multi-layer backup protection.              | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `features/folder`                 | Drag-and-drop folder logic.                 | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                 | Chat export (JSON/MD/PDF).                  | ğŸŸ¡ Medium  | PDF generation relies on specific DOM structure. Fragile to Gemini UI changes. |\n| `features/backup`                 | File System Access API.                     | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                   | **DOM Injection**.                          | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension.                                        |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server (Chrome)\nbun run dev:chrome\n\n# Start Dev Server (Firefox)\nbun run dev:firefox\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                     # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/             # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts     #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ LoggerService.ts  #   - Structured logging\nâ”‚   â”‚   â”‚   â””â”€â”€ ...\nâ”‚   â”‚   â”œâ”€â”€ utils/                # Core utilities (hashing, concurrency)\nâ”‚   â”‚   â””â”€â”€ types/                # Global type definitions\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                 # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/               #   - Export (JSON/MD/PDF)\nâ”‚   â”‚   â”œâ”€â”€ folder/               #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/               #   - File System backup\nâ”‚   â”‚   â””â”€â”€ formulaCopy/          #   - LaTeX copy\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                    # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/           #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                #   - Settings UI\nâ”‚   â”‚   â””â”€â”€ content/              #   - Content Scripts (Gemini Injection)\nâ”‚   â”‚       â”œâ”€â”€ timeline/         #       * Timeline navigation\nâ”‚   â”‚       â”œâ”€â”€ prompt/           #       * Prompt manager\nâ”‚   â”‚       â”œâ”€â”€ deepResearch/     #       * Deep research tool\nâ”‚   â”‚       â””â”€â”€ ...               #       * (Feature integrations)\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/               # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â””â”€â”€ ui/                   #   - Generic UI (Buttons, Dialogs)\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                  # ğŸŒ TRANSLATIONS\nâ”‚   â”‚   â”œâ”€â”€ en/messages.json      #   - English\nâ”‚   â”‚   â””â”€â”€ zh/messages.json      #   - Chinese\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                    # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts              #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                       # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ katex-config.js           #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js       #   - Network interception\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                     | File Path / Directory                                              |\n| ------------------------ | ------------------------------------------------------------------ |\n| **Add new storage key**  | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic** | `src/core/services/StorageService.ts`                              |\n| **Update translations**  | `src/locales/{en,zh}/messages.json`                                |\n| **Modify export format** | `src/features/export/services/`                                    |\n| **Fix backup issues**    | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Adjust UI styles**     | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection** | `src/pages/content/`                                               |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities.\n- `vite.config.*.ts`: Build configurations.\n- `src/core/types/common.ts`: Centralized types and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/locales/*`: Translation files.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n\n---\n"},"sourceToolAssistantUUID":"88979052-9883-44ca-96c9-460361b3a6db"}
{"parentUuid":"34528171-2876-4c0f-9dda-20aaaaa2a252","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_014mzKDn1RZRgmm59qAVLEh1","type":"message","role":"assistant","content":[{"type":"text","text":"Done. Both files are now synced at **v1.2.3 (2026-02-15)**. Here's what changed:\n\n| Change | Before | After |\n|--------|--------|-------|\n| Version | 1.2.2 / 1.1.9 | 1.2.3 |\n| Date | 2026-02-09 / 2026-02-04 | 2026-02-15 |\n| Content script modules | 22 | 24 (added `announcement`, `shared`) |\n| Locales | 11 (included non-existent `zh_CN`) | 10 (removed `zh_CN`) |\n| Core utils | missing 2 entries | added `safariStorage.ts`, `updateReminder.ts` |\n| AGENTS.md template comment | present (referencing non-existent template) | removed |\n| AGENTS.md content | outdated (missing GoogleDriveSyncService, mermaid, watermarkRemover, Safari commands, etc.) | fully synced with CLAUDE.md |"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":11189,"cache_read_input_tokens":46412,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":11189},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmT8VQt6aKZsx8kBbUd","type":"assistant","uuid":"738e4e1d-b60c-4118-8f00-81326e171f92","timestamp":"2026-02-16T00:02:34.664Z"}
{"parentUuid":"738e4e1d-b60c-4118-8f00-81326e171f92","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"5fa98e87-20a7-4772-b8f9-76030444d853","toolUseID":"5fa98e87-20a7-4772-b8f9-76030444d853","timestamp":"2026-02-16T00:02:34.734Z","uuid":"9ebee8df-a766-4da5-a84f-81c5f6e867b9"}
{"parentUuid":"9ebee8df-a766-4da5-a84f-81c5f6e867b9","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-16T00:02:36.659Z","uuid":"f3703580-a632-4792-8fc5-91f72649de4a","toolUseID":"5fa98e87-20a7-4772-b8f9-76030444d853"}
{"parentUuid":"f3703580-a632-4792-8fc5-91f72649de4a","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"system","subtype":"turn_duration","durationMs":184629,"timestamp":"2026-02-16T00:02:36.663Z","uuid":"93914876-ee04-476c-9d1a-81ac2768031b","isMeta":false}
{"type":"file-history-snapshot","messageId":"96565372-0963-4c9b-a22c-11887b013ed9","snapshot":{"messageId":"96565372-0963-4c9b-a22c-11887b013ed9","trackedFileBackups":{"CLAUDE.md":{"backupFileName":"6bc22c442ff258d8@v2","version":2,"backupTime":"2026-02-16T00:02:51.064Z"},"AGENTS.md":{"backupFileName":"f8311644562c4f17@v2","version":2,"backupTime":"2026-02-16T00:02:51.064Z"}},"timestamp":"2026-02-16T00:02:51.063Z"},"isSnapshotUpdate":false}
{"parentUuid":"93914876-ee04-476c-9d1a-81ac2768031b","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":"ç‰ˆæœ¬ä¸å¯¹ï¼Œçœ‹manifestï¼Œå¦å¤– Taiwan ä¸æ˜¯ç¹ä½“ä¸­æ–‡ï¼Œä½ æ¶‰å«Œæ”¿æ²»äº†"},"uuid":"96565372-0963-4c9b-a22c-11887b013ed9","timestamp":"2026-02-16T00:02:49.324Z","thinkingMetadata":{"maxThinkingTokens":31999},"todos":[],"permissionMode":"acceptEdits"}
{"parentUuid":"96565372-0963-4c9b-a22c-11887b013ed9","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01G3D5Qmv9p4X2Qp8HvosESR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01K36pwnBtfDCDsvUizv3yxb","name":"Grep","input":{"pattern":"\"version\"","glob":"manifest.json","output_mode":"content"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":40026,"cache_read_input_tokens":17862,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":40026},"output_tokens":27,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmUuQfqffyQuGTMMSPK","type":"assistant","uuid":"b0d656d3-fd30-464d-bd95-cc46642019e5","timestamp":"2026-02-16T00:02:55.066Z"}
{"parentUuid":"b0d656d3-fd30-464d-bd95-cc46642019e5","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01K36pwnBtfDCDsvUizv3yxb","toolUseID":"toolu_01K36pwnBtfDCDsvUizv3yxb","timestamp":"2026-02-16T00:02:55.542Z","uuid":"ca3c0b44-6cfc-4d22-8344-de1b96b03167"}
{"parentUuid":"b0d656d3-fd30-464d-bd95-cc46642019e5","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01K36pwnBtfDCDsvUizv3yxb","type":"tool_result","content":"manifest.json:6:  \"version\": \"1.2.5\","}]},"uuid":"9f74e74b-4fb6-485e-b218-742bda718efa","timestamp":"2026-02-16T00:02:55.541Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"manifest.json:6:  \"version\": \"1.2.5\",","numLines":1},"sourceToolAssistantUUID":"b0d656d3-fd30-464d-bd95-cc46642019e5"}
{"parentUuid":"9f74e74b-4fb6-485e-b218-742bda718efa","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01G3D5Qmv9p4X2Qp8HvosESR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KGb8Z6shc7RfwKGxoyibWM","name":"Bash","input":{"command":"ls /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/src/locales/","description":"List locale directories"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":40026,"cache_read_input_tokens":17862,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":40026},"output_tokens":27,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmUuQfqffyQuGTMMSPK","type":"assistant","uuid":"19b1641d-577b-4c0e-8dcd-1e32fa4c90a3","timestamp":"2026-02-16T00:02:56.217Z"}
{"parentUuid":"19b1641d-577b-4c0e-8dcd-1e32fa4c90a3","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KGb8Z6shc7RfwKGxoyibWM","type":"tool_result","content":"__tests__\nar\nen\nes\nfr\nja\nko\npt\nru\nzh\nzh_TW","is_error":false}]},"uuid":"7663c3ba-cb03-4665-aa0c-d26e85e01cce","timestamp":"2026-02-16T00:02:56.323Z","toolUseResult":{"stdout":"__tests__\nar\nen\nes\nfr\nja\nko\npt\nru\nzh\nzh_TW","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"19b1641d-577b-4c0e-8dcd-1e32fa4c90a3"}
{"parentUuid":"7663c3ba-cb03-4665-aa0c-d26e85e01cce","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_019vN18ADbrmQPtA5pANDJgL","type":"message","role":"assistant","content":[{"type":"text","text":"æ˜ç™½äº†ã€‚ç‰ˆæœ¬åº”è¯¥æ˜¯ `1.2.5`ï¼Œlocale çš„ `zh` æ˜¯ç®€ä½“ä¸­æ–‡ã€`zh_TW` æ˜¯ç¹ä½“ä¸­æ–‡ï¼ˆå°æ¹¾åœ°åŒºç”¨çš„ç¹ä½“ä¸­æ–‡ï¼‰ã€‚"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":281,"cache_read_input_tokens":57888,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":281},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmVHNWkkwQbpUjjduSP","type":"assistant","uuid":"a10261c1-0840-4460-afca-2a18a8754d4a","timestamp":"2026-02-16T00:02:59.482Z"}
{"parentUuid":"a10261c1-0840-4460-afca-2a18a8754d4a","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_019vN18ADbrmQPtA5pANDJgL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RxGPdDntmouHBe6pJTB5Fu","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"> **Version**: 1.2.3","new_string":"> **Version**: 1.2.5"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":281,"cache_read_input_tokens":57888,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":281},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmVHNWkkwQbpUjjduSP","type":"assistant","uuid":"56ed629d-363e-4880-90a8-85599184a555","timestamp":"2026-02-16T00:03:00.693Z"}
{"parentUuid":"56ed629d-363e-4880-90a8-85599184a555","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01RxGPdDntmouHBe6pJTB5Fu","toolUseID":"toolu_01RxGPdDntmouHBe6pJTB5Fu","timestamp":"2026-02-16T00:03:00.700Z","uuid":"ec92d8e3-13c9-41a8-b597-269b637c33f2"}
{"parentUuid":"56ed629d-363e-4880-90a8-85599184a555","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RxGPdDntmouHBe6pJTB5Fu","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"be64a0bd-143c-4477-acc9-45f59ee7df16","timestamp":"2026-02-16T00:03:00.699Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"> **Version**: 1.2.3","newString":"> **Version**: 1.2.5","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (10 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":1,"oldLines":7,"newStart":1,"newLines":7,"lines":[" # CLAUDE.md - AI Assistant Guide for Gemini Voyager"," "," > **Last Updated**: 2026-02-15","-> **Version**: 1.2.3","+> **Version**: 1.2.5"," > **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase"," "," ---"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"56ed629d-363e-4880-90a8-85599184a555"}
{"parentUuid":"be64a0bd-143c-4477-acc9-45f59ee7df16","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01FfVbp5cSYULUgP5gn9YGwA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B6kBCzckszAaWvLuUryegr","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","old_string":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","new_string":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Simplified), Chinese (Traditional)"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":260,"cache_read_input_tokens":58169,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":260},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmVcFZyw6XWVzUxZwEn","type":"assistant","uuid":"e49cb4c8-c689-46aa-ae07-b12a85519e09","timestamp":"2026-02-16T00:03:04.373Z"}
{"parentUuid":"e49cb4c8-c689-46aa-ae07-b12a85519e09","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01B6kBCzckszAaWvLuUryegr","toolUseID":"toolu_01B6kBCzckszAaWvLuUryegr","timestamp":"2026-02-16T00:03:04.378Z","uuid":"1cfa5812-d152-465c-9ef1-9e7a84fdcf52"}
{"parentUuid":"e49cb4c8-c689-46aa-ae07-b12a85519e09","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B6kBCzckszAaWvLuUryegr","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md has been updated successfully."}]},"uuid":"d4a093cb-a35e-4eb0-9ee7-8a6361ae27d3","timestamp":"2026-02-16T00:03:04.377Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/CLAUDE.md","oldString":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","newString":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Simplified), Chinese (Traditional)","originalFile":"# CLAUDE.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.5\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (10 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":303,"oldLines":7,"newStart":303,"newLines":7,"lines":[" â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)"," â”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French"," â”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian","-â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","+â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Simplified), Chinese (Traditional)"," â”‚   â”‚"," â”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS"," â”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e49cb4c8-c689-46aa-ae07-b12a85519e09"}
{"parentUuid":"d4a093cb-a35e-4eb0-9ee7-8a6361ae27d3","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01Ab4wUFjijp6yoXsnkrLTVw","type":"message","role":"assistant","content":[{"type":"text","text":"Now sync to AGENTS.md."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":339,"cache_read_input_tokens":58429,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":339},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmVsuf3hLTJ2ZhvLDf6","type":"assistant","uuid":"4ec7fa3d-b588-4ddb-ad65-afa775103f62","timestamp":"2026-02-16T00:03:06.843Z"}
{"parentUuid":"4ec7fa3d-b588-4ddb-ad65-afa775103f62","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01Ab4wUFjijp6yoXsnkrLTVw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HuYp87M6zerkc8otq9RxVU","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md","old_string":"> **Version**: 1.2.3","new_string":"> **Version**: 1.2.5"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":339,"cache_read_input_tokens":58429,"output_tokens":163,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":339,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmVsuf3hLTJ2ZhvLDf6","type":"assistant","uuid":"ab15a577-83fd-490c-92a1-471c85d17950","timestamp":"2026-02-16T00:03:08.170Z"}
{"parentUuid":"ab15a577-83fd-490c-92a1-471c85d17950","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01HuYp87M6zerkc8otq9RxVU","toolUseID":"toolu_01HuYp87M6zerkc8otq9RxVU","timestamp":"2026-02-16T00:03:08.181Z","uuid":"b246f659-c943-463a-bc53-4355cee57d04"}
{"parentUuid":"ab15a577-83fd-490c-92a1-471c85d17950","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HuYp87M6zerkc8otq9RxVU","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md has been updated successfully."}]},"uuid":"d7a43433-ce97-4bff-a0a2-d18e3880d1bb","timestamp":"2026-02-16T00:03:08.180Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md","oldString":"> **Version**: 1.2.3","newString":"> **Version**: 1.2.5","originalFile":"---\ntrigger: always_on\n---\n\n# AGENTS.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.3\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (10 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":5,"oldLines":7,"newStart":5,"newLines":7,"lines":[" # AGENTS.md - AI Assistant Guide for Gemini Voyager"," "," > **Last Updated**: 2026-02-15","-> **Version**: 1.2.3","+> **Version**: 1.2.5"," > **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase"," "," ---"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"ab15a577-83fd-490c-92a1-471c85d17950"}
{"parentUuid":"d7a43433-ce97-4bff-a0a2-d18e3880d1bb","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01TNTg3R4q6df87bpqS1pbLT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ao29DFopGFRvE2PM5C9QsV","name":"Edit","input":{"replace_all":false,"file_path":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md","old_string":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","new_string":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Simplified), Chinese (Traditional)"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":208,"cache_read_input_tokens":58768,"output_tokens":183,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":208,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"requestId":"req_011CYAmWA9U5q2sEA5hjnhvG","type":"assistant","uuid":"dd169f10-43db-46bf-bc52-56f82376e468","timestamp":"2026-02-16T00:03:11.342Z"}
{"parentUuid":"dd169f10-43db-46bf-bc52-56f82376e468","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Ao29DFopGFRvE2PM5C9QsV","toolUseID":"toolu_01Ao29DFopGFRvE2PM5C9QsV","timestamp":"2026-02-16T00:03:11.346Z","uuid":"9cb2ab4c-3dea-40bc-b6ce-81795a6b53ed"}
{"parentUuid":"dd169f10-43db-46bf-bc52-56f82376e468","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ao29DFopGFRvE2PM5C9QsV","type":"tool_result","content":"The file /Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md has been updated successfully."}]},"uuid":"7165db32-2bc3-4b06-b416-8b994c946571","timestamp":"2026-02-16T00:03:11.345Z","toolUseResult":{"filePath":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager/AGENTS.md","oldString":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","newString":"â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Simplified), Chinese (Traditional)","originalFile":"---\ntrigger: always_on\n---\n\n# AGENTS.md - AI Assistant Guide for Gemini Voyager\n\n> **Last Updated**: 2026-02-15\n> **Version**: 1.2.5\n> **Purpose**: Comprehensive guide for AI assistants working with the Gemini Voyager codebase\n\n---\n\n## 1. Role & Core Mandates\n\n**Role**: You are an expert Full-Stack Engineer and Chrome Extension Specialist working on Gemini Voyager. Your goal is to deliver high-quality, robust, and idiomatic code that enhances the Google Gemini experience.\n\n**Core Mandates**:\n\n1.  **Safety First**: Never commit secrets. Validate all system operations.\n2.  **Code Consistency**: Strictly follow the project's architectural patterns (Services, Stores, functional React).\n3.  **Type Safety**: No `any`. Use `unknown` with narrowing. Use Branded Types for IDs.\n4.  **Testing**: Every feature and fix must include tests.\n5.  **Documentation**: Keep documentation and translations in sync with code changes.\n\n---\n\n## 2. Operational Methodology\n\nBefore writing code, apply this \"Linus-style\" problem-solving framework to ensure robust and simple solutions.\n\n### Phase 1: The Three Questions\n\nAsk yourself before starting:\n\n1.  **\"Is this a real problem?\"** - Reject over-engineering.\n2.  **\"Is there a simpler way?\"** - Always seek the simplest solution (KISS).\n3.  **\"Will it break anything?\"** - Backward compatibility is an iron law.\n\n### Phase 2: Requirements Analysis\n\nWhen analyzing a request:\n\n1.  **Data Structure First**: \"Bad programmers worry about the code. Good programmers worry about data structures.\"\n    - What is the core data? Who owns it?\n    - Can we redesign data structures to eliminate branches/complexity?\n2.  **Eliminate Special Cases**: \"Good code has no special cases.\"\n    - Identify `if/else` branches that patch bad design.\n    - Refactor to make the \"special case\" the normal case.\n3.  **Destructive Analysis**:\n    - List all existing features that might be affected.\n    - Ensure zero destructiveness to user data (especially `localStorage`).\n\n### Phase 3: Decision Output\n\nIf a task is complex or ambiguous, present your analysis in this format:\n\n```text\nã€Core Judgmentã€‘\nâœ… Worth doing: [reason] / âŒ Not worth doing: [reason]\n\nã€Key Insightsã€‘\n- Data structure: [most critical data relationships]\n- Complexity: [complexity that can be eliminated]\n- Risks: [potential breaking changes]\n\nã€Planã€‘\n1. Simplify data structures...\n2. Eliminate special cases...\n3. Implementation steps...\n```\n\n---\n\n## 3. Tool Usage & Verification Protocols\n\nStrictly adhere to these protocols to prevent errors and ensure data integrity.\n\n### ğŸ›¡ï¸ The \"Read-Write-Verify\" Loop\n\n1.  **READ**: Always read the target file **before** editing. Do not rely on memory or assumptions.\n    - _Tool_: `read_file`\n2.  **WRITE**: Apply atomic changes. Use sufficient context for `replace`.\n    - _Tool_: `write_file` or `replace`\n3.  **VERIFY**: Check the file content **after** editing to ensure the change was applied correctly and didn't break syntax.\n    - _Tool_: `read_file` or `run_shell_command` (grep/cat)\n\n### ğŸš¨ Critical Safety Checks\n\n- **Never** modify `dist_*` folders directly.\n- **Never** commit `.env` or secrets.\n- **Always** run `bun run typecheck` after modifying TypeScript definitions.\n- **Always** run `bun run lint` before finishing.\n\n---\n\n## 4. Module Glossary & Complexity Hotspots\n\n| Module (Path)                          | Responsibility                                    | Complexity | Notes                                                                          |\n| -------------------------------------- | ------------------------------------------------- | ---------- | ------------------------------------------------------------------------------ |\n| `core/services/StorageService`         | **Single Source of Truth** for persistence.       | ğŸŒ¶ï¸ High    | Handles sync/local/session logic + migration. **Do not modify lightly.**       |\n| `core/services/DataBackupService`      | Multi-layer backup protection.                    | ğŸŒ¶ï¸ High    | Critical for data safety. Race conditions possible during unload.              |\n| `core/services/GoogleDriveSyncService` | Google Drive cloud sync (OAuth2).                 | ğŸŒ¶ï¸ High    | Handles folders, prompts, and starred messages sync. Requires OAuth2 identity. |\n| `features/folder`                      | Drag-and-drop folder logic + cloud sync UI.       | ğŸŒ¶ï¸ High    | DOM manipulation + State sync is tricky. Watch out for infinite loops.         |\n| `features/export`                      | Chat export (JSON/MD/PDF/Image) + Deep Research.  | ğŸŒ¶ï¸ High    | Image export, message selection, multi-browser compat. Fragile to Gemini UI.   |\n| `features/backup`                      | File System Access API.                           | ğŸŸ¡ Medium  | Browser compatibility issues (Safari fallback).                                |\n| `pages/content`                        | **DOM Injection** (24 content script modules).    | ğŸŸ¡ Medium  | Bridge between Gemini UI and Extension. Each sub-module is self-contained.     |\n| `pages/content/mermaid`                | Mermaid diagram rendering.                        | ğŸŸ¡ Medium  | Dynamic library loading with legacy fallback.                                  |\n| `pages/content/watermarkRemover`       | NanoBanana watermark removal via fetch intercept. | ğŸŸ¡ Medium  | Disabled on Safari. Uses `fetchInterceptor.js` injected into page context.     |\n\n---\n\n## 5. Development Standards & Anti-Patterns\n\n### âœ… DOs\n\n- **Prefer Plain Objects**: Use interfaces/types for data structures.\n- **Immutability**: Use `map`, `filter`, `reduce`.\n- **Encapsulation**: Use `private`/`protected` in classes.\n- **Type Guarding**: Use `unknown` + narrowing (Zod or custom guards).\n- **Named Exports**: `export function X` (easier refactoring).\n- **Functional React**: Hooks at top level, strictly functional components.\n\n### âŒ DON'Ts (Anti-Patterns)\n\n- **Global State Pollution**: Never use global variables outside of defined Services.\n- **Direct Storage Access**: Never use `chrome.storage` directly in UI components. Always use `StorageService`.\n- **God Components**: Don't put business logic in UI files. Move it to `features/xxx/services` or custom hooks.\n- **Any Type**: Explicitly banned. Use `unknown` if you must, then narrow it.\n- **Magic Strings**: Use constants or enums, especially for Storage Keys and CSS Classes.\n- **Console Logs**: Remove `console.log` in production code (use `LoggerService` for critical info).\n\n---\n\n## 6. Testing Strategy\n\n**Framework**: Vitest 4.0.6 (jsdom environment)\n\n### TDD Workflow Guidelines\n\n1.  **Write the Test First**: Define the expected behavior in `*.test.ts`.\n2.  **Fail**: Ensure the test fails (validates the test itself).\n3.  **Implement**: Write the minimal code to pass the test.\n4.  **Refactor**: Clean up the code while keeping tests green.\n\n### Mocking Patterns\n\nThis project relies heavily on `vi.mock` for Chrome APIs and external services.\n\n**Mocking Chrome API**:\nThe global `chrome` object is mocked in `src/tests/setup.ts`. You can inspect or override it in individual tests.\n\n```typescript\n// Example: Mocking specific storage behavior for a test\nbeforeEach(() => {\n  (chrome.storage.sync.get as any).mockResolvedValue({ someKey: 'value' });\n});\n```\n\n**Running Tests**:\n\n```bash\nbun run test                # Run all tests\nbun run test <filename>     # Run specific test file\nbun run test:watch          # Interactive mode\nbun run test:coverage       # Check coverage\n```\n\n---\n\n## 7. Workflows & Definition of Done\n\n### Setup\n\n```bash\nbun install\n```\n\n### Development\n\n```bash\n# Start Dev Server\nbun run dev:chrome\nbun run dev:firefox\nbun run dev:safari\n\n# Build for production\nbun run build:chrome\nbun run build:firefox\nbun run build:safari\nbun run build:edge        # Repackages Chrome build for Edge\nbun run build:all         # Build all platforms\n\n# Documentation site (VitePress)\nbun run docs:dev\nbun run docs:build\n```\n\n_Note: Uses Nodemon for hot-reloading content scripts._\n\n### Commit Messages (commitlint)\n\nUse Conventional Commits format:\n\n```\n<type>(<scope>): <imperative summary>\n```\n\n- `type`: `feat`, `fix`, `refactor`, `chore`, `docs`, `test`, `build`, `ci`, `perf`, `style`\n- `scope`: short, feature-focused (e.g., `copy`, `export`, `popup`)\n- summary: lowercase, imperative, no trailing period\n\nExamples:\n\n- `fix(copy): handle clipboard fallback`\n- `refactor(copy): introduce temml to convert tex2mathml`\n- `chore: update sponsors.svg`\n\n### Definition of Done (DoD)\n\nBefore claiming a task is complete, verify:\n\n1.  **Functionality**: Does it meet the requirements?\n2.  **Tests**: Are there new tests? Do all tests pass (`bun run test`)?\n3.  **Types**: No TypeScript errors (`bun run typecheck`)?\n4.  **Linting**: Code formatted and linted (`bun run lint`)?\n5.  **Build**: Does it build without error (`bun run build`)?\n6.  **Safety**: No secrets committed? No destructive `localStorage` operations?\n\n---\n\n## 8. Repository Structure & File Map\n\n```\ngemini-voyager/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ core/                           # ğŸ§  CORE LOGIC (Foundation)\nâ”‚   â”‚   â”œâ”€â”€ services/                   # Singleton Services\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageService.ts       #   - Central persistence layer\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DataBackupService.ts    #   - Multi-layer backup protection\nâ”‚   â”‚   â”‚   â”œâ”€â”€ GoogleDriveSyncService  #   - Google Drive cloud sync (OAuth2)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ KeyboardShortcutService #   - Global keyboard shortcuts\nâ”‚   â”‚   â”‚   â”œâ”€â”€ StorageMonitor.ts       #   - Storage usage monitoring\nâ”‚   â”‚   â”‚   â”œâ”€â”€ DOMService.ts           #   - Safe DOM manipulation\nâ”‚   â”‚   â”‚   â””â”€â”€ LoggerService.ts        #   - Structured logging\nâ”‚   â”‚   â”œâ”€â”€ utils/                      # Core utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ browser.ts             #   - Browser detection (isSafari, etc.)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ extensionContext.ts    #   - Extension context invalidation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ concurrency.ts         #   - Concurrency primitives\nâ”‚   â”‚   â”‚   â”œâ”€â”€ hash.ts                #   - Hashing utilities\nâ”‚   â”‚   â”‚   â”œâ”€â”€ storageMigration.ts    #   - Storage migration helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ safariStorage.ts      #   - Safari storage helpers\nâ”‚   â”‚   â”‚   â”œâ”€â”€ updateReminder.ts     #   - Update reminder utility\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #   - (array, async, gemini, selectors, text, version)\nâ”‚   â”‚   â””â”€â”€ types/                      # Global type definitions\nâ”‚   â”‚       â”œâ”€â”€ common.ts              #   - StorageKeys, shared types\nâ”‚   â”‚       â”œâ”€â”€ folder.ts              #   - Folder data types\nâ”‚   â”‚       â”œâ”€â”€ timeline.ts            #   - Timeline types\nâ”‚   â”‚       â”œâ”€â”€ keyboardShortcut.ts    #   - Shortcut types\nâ”‚   â”‚       â””â”€â”€ sync.ts               #   - Cloud sync types\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ features/                       # ğŸ§© FEATURES (Domain Logic)\nâ”‚   â”‚   â”œâ”€â”€ export/                     #   - Export (JSON/MD/PDF/Image/Deep Research)\nâ”‚   â”‚   â”œâ”€â”€ folder/                     #   - Folder organization\nâ”‚   â”‚   â”œâ”€â”€ backup/                     #   - File System backup\nâ”‚   â”‚   â”œâ”€â”€ formulaCopy/                #   - LaTeX copy\nâ”‚   â”‚   â”œâ”€â”€ contextSync/                #   - Context/clipboard sync\nâ”‚   â”‚   â””â”€â”€ tableCopy/                  #   - Table copying\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ pages/                          # ğŸšª ENTRY POINTS (Application)\nâ”‚   â”‚   â”œâ”€â”€ background/                 #   - Service Worker\nâ”‚   â”‚   â”œâ”€â”€ popup/                      #   - Settings UI\nâ”‚   â”‚   â”‚   â””â”€â”€ components/            #   - CloudSync, KeyboardShortcut, StarredHistory, etc.\nâ”‚   â”‚   â”œâ”€â”€ content/                    #   - Content Scripts (Gemini DOM Injection)\nâ”‚   â”‚   â”‚   â”œâ”€â”€ timeline/              #       * Timeline navigation\nâ”‚   â”‚   â”‚   â”œâ”€â”€ prompt/                #       * Prompt manager\nâ”‚   â”‚   â”‚   â”œâ”€â”€ deepResearch/          #       * Deep research tool\nâ”‚   â”‚   â”‚   â”œâ”€â”€ mermaid/               #       * Mermaid diagram rendering\nâ”‚   â”‚   â”‚   â”œâ”€â”€ watermarkRemover/      #       * NanoBanana watermark removal\nâ”‚   â”‚   â”‚   â”œâ”€â”€ sendBehavior/          #       * Send key behavior customization\nâ”‚   â”‚   â”‚   â”œâ”€â”€ folder/                #       * Folder sidebar management\nâ”‚   â”‚   â”‚   â”œâ”€â”€ export/                #       * Export button & selection mode\nâ”‚   â”‚   â”‚   â”œâ”€â”€ announcement/          #       * Announcement display\nâ”‚   â”‚   â”‚   â”œâ”€â”€ shared/                #       * Shared content script utilities\nâ”‚   â”‚   â”‚   â””â”€â”€ ...                    #       * (chatWidth, defaultModel, folderSpacing,\nâ”‚   â”‚   â”‚                              #          gemsHider, inputCollapse, katexConfig,\nâ”‚   â”‚   â”‚                              #          markdownPatcher, quoteReply, recentsHider,\nâ”‚   â”‚   â”‚                              #          sidebarAutoHide, sidebarWidth, titleUpdater,\nâ”‚   â”‚   â”‚                              #          editInputWidth, contextSync)\nâ”‚   â”‚   â”œâ”€â”€ devtools/                   #   - DevTools panel\nâ”‚   â”‚   â”œâ”€â”€ options/                    #   - Options/Settings page\nâ”‚   â”‚   â””â”€â”€ panel/                      #   - Side panel\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ components/                     # ğŸ§± UI COMPONENTS (Presentation)\nâ”‚   â”‚   â”œâ”€â”€ ui/                         #   - Generic UI (Button, Card, Select, Slider, Switch, etc.)\nâ”‚   â”‚   â”œâ”€â”€ DarkModeToggle.tsx          #   - Dark mode toggle\nâ”‚   â”‚   â””â”€â”€ LanguageSwitcher.tsx        #   - Language switcher\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ contexts/                       # ğŸ”— REACT CONTEXTS\nâ”‚   â”‚   â””â”€â”€ LanguageContext.tsx          #   - Language/i18n context provider\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ utils/                          # ğŸ”§ APPLICATION UTILITIES\nâ”‚   â”‚   â”œâ”€â”€ i18n.ts                     #   - Internationalization\nâ”‚   â”‚   â”œâ”€â”€ language.ts                 #   - Language detection/normalization\nâ”‚   â”‚   â”œâ”€â”€ merge.ts                    #   - Data merging (for cloud sync)\nâ”‚   â”‚   â””â”€â”€ translations.ts            #   - Translation helpers\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)\nâ”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French\nâ”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian\nâ”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)\nâ”‚   â”‚\nâ”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS\nâ”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks\nâ”‚\nâ”œâ”€â”€ public/                             # ğŸ“¦ STATIC ASSETS\nâ”‚   â”œâ”€â”€ contentStyle.css                #   - Injected CSS styles\nâ”‚   â”œâ”€â”€ katex-config.js                 #   - KaTeX configuration\nâ”‚   â””â”€â”€ fetchInterceptor.js             #   - Network interception (watermark)\nâ”‚\nâ”œâ”€â”€ docs/                               # ğŸ“– DOCUMENTATION (VitePress)\nâ”‚\nâ””â”€â”€ ... (config files)\n```\n\n### ğŸ“ Where to Look (Task Map)\n\n| Task                      | File Path / Directory                                              |\n| ------------------------- | ------------------------------------------------------------------ |\n| **Add new storage key**   | `src/core/types/common.ts` (StorageKeys)                           |\n| **Change storage logic**  | `src/core/services/StorageService.ts`                              |\n| **Update translations**   | `src/locales/*/messages.json` (all 10 locales)                     |\n| **Modify export format**  | `src/features/export/services/`                                    |\n| **Fix backup issues**     | `src/core/services/DataBackupService.ts` or `src/features/backup/` |\n| **Fix cloud sync issues** | `src/core/services/GoogleDriveSyncService.ts`                      |\n| **Adjust UI styles**      | `src/components/ui/` or `src/assets/styles/`                       |\n| **Change DOM injection**  | `src/pages/content/`                                               |\n| **Add keyboard shortcut** | `src/core/services/KeyboardShortcutService.ts` + types             |\n| **Modify popup settings** | `src/pages/popup/components/`                                      |\n| **Browser compatibility** | `src/core/utils/browser.ts` (detection) + feature-level guards     |\n\n---\n\n## 9. Important Files\n\n- `manifest.json` / `manifest.dev.json`: Extension capabilities (includes OAuth2 for Google Drive sync).\n- `vite.config.base.ts`: Shared build configuration.\n- `vite.config.chrome.ts` / `vite.config.firefox.ts` / `vite.config.safari.ts`: Platform-specific builds.\n- `src/core/types/common.ts`: Centralized types, StorageKeys, and constants.\n- `src/core/services/StorageService.ts`: Data persistence layer.\n- `src/core/services/GoogleDriveSyncService.ts`: Cloud sync with Google Drive.\n- `src/core/utils/browser.ts`: Browser detection helpers (`isSafari()`, etc.).\n- `src/core/utils/extensionContext.ts`: Extension context invalidation handling.\n- `src/locales/*`: Translation files (10 languages).\n- `public/contentStyle.css`: Injected CSS styles for content scripts.\n\n---\n\n## 10. Troubleshooting\n\n- **Build Errors**: Clear `dist_*` folders and `node_modules`. Run `bun install`.\n- **HMR Issues**: Reload the extension in `chrome://extensions`.\n- **Style Conflicts**: Ensure all CSS classes are prefixed (`gv-`) or use Shadow DOM (if applicable, though this project mostly uses main DOM injection with specific classes).\n- **Safari Limitations**: Some features (cloud sync, watermark removal, image export) are disabled or limited on Safari. Check `isSafari()` guards.\n- **Extension Context Invalidated**: After extension update/reload, content scripts lose access to `chrome.*` APIs. Use `isExtensionContextInvalidatedError()` to handle gracefully.\n\n---\n","structuredPatch":[{"oldStart":307,"oldLines":7,"newStart":307,"newLines":7,"lines":[" â”‚   â”œâ”€â”€ locales/                        # ğŸŒ TRANSLATIONS (10 languages)"," â”‚   â”‚   â”œâ”€â”€ en/    ar/    es/    fr/    #   - English, Arabic, Spanish, French"," â”‚   â”‚   â”œâ”€â”€ ja/    ko/    pt/    ru/    #   - Japanese, Korean, Portuguese, Russian","-â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Traditional, Taiwan)","+â”‚   â”‚   â””â”€â”€ zh/    zh_TW/              #   - Chinese (Simplified), Chinese (Traditional)"," â”‚   â”‚"," â”‚   â””â”€â”€ tests/                          # ğŸ§ª GLOBAL TESTS"," â”‚       â””â”€â”€ setup.ts                    #   - Vitest setup & mocks"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"dd169f10-43db-46bf-bc52-56f82376e468"}
{"parentUuid":"7165db32-2bc3-4b06-b416-8b994c946571","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","message":{"model":"claude-opus-4-6","id":"msg_01VjBH6ibeWAy9n65XE13PKA","type":"message","role":"assistant","content":[{"type":"text","text":"å·²ä¿®æ­£ï¼š\n\n- ç‰ˆæœ¬å·ï¼š`1.2.3` â†’ `1.2.5`ï¼ˆä¸ manifest.json ä¸€è‡´ï¼‰\n- locale æè¿°ï¼š`zh/` = ç®€ä½“ä¸­æ–‡ï¼Œ`zh_TW/` = ç¹ä½“ä¸­æ–‡ï¼Œå»æ‰äº† \"Taiwan\" çš„è¡¨è¿°"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":228,"cache_read_input_tokens":58976,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":228},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CYAmWQjZ1xrW4i3TWanSG","type":"assistant","uuid":"0a7f4edf-2b47-4a5a-a275-a764eda4911c","timestamp":"2026-02-16T00:03:15.314Z"}
{"parentUuid":"0a7f4edf-2b47-4a5a-a275-a764eda4911c","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"be5484b8-8846-46ea-ac00-e0d629fa7325","toolUseID":"be5484b8-8846-46ea-ac00-e0d629fa7325","timestamp":"2026-02-16T00:03:15.407Z","uuid":"43f44c57-744f-46d8-af79-499662879a32"}
{"parentUuid":"43f44c57-744f-46d8-af79-499662879a32","isSidechain":false,"userType":"external","cwd":"/Users/jessezhang/Desktop/Coding/side-projects/gemini-voyager","sessionId":"5f5edb65-ad65-43f4-b3ee-45a610b43e23","version":"2.1.42","gitBranch":"main","slug":"unified-sniffing-crystal","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"entire hooks claude-code stop"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-16T00:03:16.680Z","uuid":"105b1013-e9bf-42fb-bfc5-9f10c62838ab","toolUseID":"be5484b8-8846-46ea-ac00-e0d629fa7325"}
