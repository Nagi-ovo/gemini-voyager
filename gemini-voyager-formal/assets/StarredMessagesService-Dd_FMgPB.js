import{S as n}from"./common-DScLtf9v.js";function u(){const l=navigator.userAgent.toLowerCase(),t=navigator.vendor.toLowerCase().includes("apple"),s=l.includes("safari"),r=!l.includes("chrome")&&!l.includes("chromium");return t&&s&&r}const o={previous:{action:"timeline:previous",modifiers:[],key:"k"},next:{action:"timeline:next",modifiers:[],key:"j"}};class c{static instance=null;config;enabled=!0;listeners=new Set;keydownHandler=null;storageChangeHandler=null;constructor(){this.config=o}static getInstance(){return c.instance||(c.instance=new c),c.instance}async init(){await this.loadConfig(),this.attachKeyboardListener(),this.attachStorageListener()}async loadConfig(){try{if(typeof chrome<"u"&&chrome.storage?.sync){const t=(await chrome.storage.sync.get(n.TIMELINE_SHORTCUTS))[n.TIMELINE_SHORTCUTS];t?.shortcuts&&(this.config=this.validateConfig(t.shortcuts)?t.shortcuts:o,this.enabled=t.enabled??!0)}else{const e=localStorage.getItem(n.TIMELINE_SHORTCUTS);if(e){const t=JSON.parse(e);this.config=this.validateConfig(t.shortcuts)?t.shortcuts:o,this.enabled=t.enabled??!0}}}catch(e){console.warn("[KeyboardShortcut] Failed to load config, using defaults:",e),this.config=o,this.enabled=!0}}async saveConfig(e,t=this.enabled){if(!this.validateConfig(e))throw new Error("Invalid shortcut configuration");this.config=e,this.enabled=t;const s={shortcuts:e,enabled:t};try{typeof chrome<"u"&&chrome.storage?.sync?await chrome.storage.sync.set({[n.TIMELINE_SHORTCUTS]:s}):localStorage.setItem(n.TIMELINE_SHORTCUTS,JSON.stringify(s))}catch(r){throw console.error("[KeyboardShortcut] Failed to save config:",r),r}}validateConfig(e){try{return!!(e.previous&&e.next&&this.isValidShortcut(e.previous)&&this.isValidShortcut(e.next))}catch{return!1}}isValidShortcut(e){const t=["Alt","Ctrl","Shift","Meta"];return Array.isArray(e.modifiers)&&e.modifiers.every(s=>t.includes(s))&&typeof e.key=="string"&&e.key.length>0}attachKeyboardListener(){this.keydownHandler||(this.keydownHandler=e=>{if(!this.enabled||this.isTypingInInputField(e))return;const t=this.matchShortcut(e);t&&(e.preventDefault(),e.stopPropagation(),this.notifyListeners(t.action,e))},window.addEventListener("keydown",this.keydownHandler,{capture:!0}))}isTypingInInputField(e){const t=e.target;if(!t)return!1;const s=t.tagName.toLowerCase();return t.isContentEditable||(s==="input"||s==="textarea"||s==="select")}attachStorageListener(){typeof chrome<"u"&&chrome.storage?.onChanged&&(this.storageChangeHandler=(e,t)=>{if(t==="sync"&&e[n.TIMELINE_SHORTCUTS]){const s=e[n.TIMELINE_SHORTCUTS].newValue;s?.shortcuts&&(this.config=this.validateConfig(s.shortcuts)?s.shortcuts:o,this.enabled=s.enabled??!0)}},chrome.storage.onChanged.addListener(this.storageChangeHandler))}matchShortcut(e){const t=[{action:"timeline:previous",config:this.config.previous},{action:"timeline:next",config:this.config.next}];for(const{action:s,config:r}of t)if(this.isShortcutPressed(e,r))return{action:s,event:e};return null}isShortcutPressed(e,t){if(e.key!==t.key)return!1;const s=t.modifiers.includes("Alt"),r=t.modifiers.includes("Ctrl"),a=t.modifiers.includes("Shift"),i=t.modifiers.includes("Meta");return e.altKey===s&&e.ctrlKey===r&&e.shiftKey===a&&e.metaKey===i}notifyListeners(e,t){this.listeners.forEach(s=>{try{s(e,t)}catch(r){console.error("[KeyboardShortcut] Error in listener callback:",r)}})}on(e){return this.listeners.add(e),()=>this.off(e)}off(e){this.listeners.delete(e)}getConfig(){return{config:{...this.config},enabled:this.enabled}}async resetToDefaults(){await this.saveConfig(o,!0)}async setEnabled(e){this.enabled=e,await this.saveConfig(this.config,e)}formatShortcut(e){const s={ArrowUp:"↑",ArrowDown:"↓",ArrowLeft:"←",ArrowRight:"→"," ":"Space",Enter:"⏎",Tab:"⇥",Backspace:"⌫",Delete:"⌦",Escape:"Esc"}[e.key]||e.key;return e.modifiers.length===0?s:[...e.modifiers,s].join(" + ")}destroy(){this.keydownHandler&&(window.removeEventListener("keydown",this.keydownHandler,{capture:!0}),this.keydownHandler=null),this.storageChangeHandler&&typeof chrome<"u"&&chrome.storage?.onChanged&&(chrome.storage.onChanged.removeListener(this.storageChangeHandler),this.storageChangeHandler=null),this.listeners.clear()}}const y=c.getInstance();class d{static instance;listeners=new Map;constructor(){}static getInstance(){return d.instance||(d.instance=new d),d.instance}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){const s=this.listeners.get(e);s&&(s.delete(t),s.size===0&&this.listeners.delete(e))}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(r=>{try{r(t)}catch(a){console.error(`[EventBus] Error in ${e} listener:`,a)}})}clear(){this.listeners.clear()}getListenerCount(e){if(e)return this.listeners.get(e)?.size||0;let t=0;return this.listeners.forEach(s=>{t+=s.size}),t}}const h=d.getInstance();class m{static async sendMessage(e,t){return new Promise((s,r)=>{chrome.runtime.sendMessage({type:e,payload:t},a=>{if(chrome.runtime.lastError){r(new Error(chrome.runtime.lastError.message));return}if(!a||!a.ok){r(new Error(a?.error||"Operation failed"));return}s(a)})})}static async getAllStarredMessages(){try{return(await this.sendMessage("gv.starred.getAll")).data||{messages:{}}}catch(e){return console.error("[StarredMessagesService] Failed to get starred messages:",e),{messages:{}}}}static async getStarredMessagesForConversation(e){try{return(await this.sendMessage("gv.starred.getForConversation",{conversationId:e})).messages||[]}catch(t){return console.error("[StarredMessagesService] Failed to get starred messages:",t),[]}}static async addStarredMessage(e){try{(await this.sendMessage("gv.starred.add",e)).added&&(h.emit("starred:added",{conversationId:e.conversationId,turnId:e.turnId}),this.updateLegacyStorage(e.conversationId,e.turnId,"add"))}catch(t){console.error("[StarredMessagesService] Failed to add starred message:",t)}}static async removeStarredMessage(e,t){try{(await this.sendMessage("gv.starred.remove",{conversationId:e,turnId:t})).removed&&(h.emit("starred:removed",{conversationId:e,turnId:t}),this.updateLegacyStorage(e,t,"remove"))}catch(s){console.error("[StarredMessagesService] Failed to remove starred message:",s)}}static updateLegacyStorage(e,t,s){try{const r=`geminiTimelineStars:${e}`,a=localStorage.getItem(r);let i=[];if(a)try{i=JSON.parse(a),Array.isArray(i)||(i=[])}catch{i=[]}s==="add"?i.includes(t)||i.push(t):i=i.filter(g=>g!==t),localStorage.setItem(r,JSON.stringify(i))}catch(r){console.debug("[StarredMessagesService] Failed to update legacy storage:",r)}}static async isMessageStarred(e,t){return(await this.getStarredMessagesForConversation(e)).some(r=>r.turnId===t)}static async getAllStarredMessagesSorted(){const e=await this.getAllStarredMessages(),t=[];return Object.values(e.messages).forEach(s=>{t.push(...s)}),t.sort((s,r)=>r.starredAt-s.starredAt)}}export{m as S,h as e,u as i,y as k};
