import{b as _,S as A}from"./common-DScLtf9v.js";import{D as B}from"./sync-D9HwFXOO.js";import{E}from"./version-BI7FQyLD.js";const M="gemini-voyager-folders.json",D="gemini-voyager-aistudio-folders.json",C="gemini-voyager-prompts.json",L="gemini-voyager-starred.json",b="Gemini Voyager Data",f="https://www.googleapis.com/drive/v3",R="https://www.googleapis.com/upload/drive/v3",k=3,P=1e3;class j{state={...B};foldersFileId=null;aistudioFoldersFileId=null;promptsFileId=null;starredFileId=null;backupFolderId=null;stateChangeCallback=null;accessToken=null;tokenExpiry=0;stateLoadPromise=null;constructor(){this.stateLoadPromise=this.loadState()}onStateChange(e){this.stateChangeCallback=e}async getState(){return this.stateLoadPromise&&await this.stateLoadPromise,{...this.state}}async setMode(e){this.state.mode=e,await this.saveState(),this.notifyStateChange()}async authenticate(e=!0){try{if(this.updateState({isSyncing:!0,error:null}),!await this.getAuthToken(e)){if(!e)return this.updateState({isAuthenticated:!1,isSyncing:!1}),!1;throw new Error("Failed to obtain auth token")}return this.updateState({isAuthenticated:!0,isSyncing:!1}),!0}catch(t){const r=t instanceof Error?t.message:"Authentication failed";return console.error("[GoogleDriveSyncService] Authentication failed:",t),this.updateState({isAuthenticated:!1,isSyncing:!1,error:r}),!1}}async signOut(){try{this.accessToken&&await fetch(`https://accounts.google.com/o/oauth2/revoke?token=${this.accessToken}`)}catch(e){console.warn("[GoogleDriveSyncService] Sign out warning:",e)}await this.clearToken(),this.foldersFileId=null,this.promptsFileId=null,this.starredFileId=null,this.backupFolderId=null,this.updateState({isAuthenticated:!1,lastSyncTime:null,error:null}),await this.saveState()}async upload(e,t,r=null,o=!0,i="gemini"){try{this.updateState({isSyncing:!0,error:null});const s=await this.getAuthToken(o);if(!s){if(!o)return console.log("[GoogleDriveSyncService] Upload skipped: Not authenticated (non-interactive)"),this.updateState({isSyncing:!1,isAuthenticated:!1}),!1;throw new Error("Not authenticated")}const c=new Date,n={format:"gemini-voyager.folders.v1",exportedAt:c.toISOString(),version:E,data:e},l={format:"gemini-voyager.prompts.v1",exportedAt:c.toISOString(),version:E,items:t},d=i==="aistudio"?D:M,u=i==="aistudio"?"aistudio-folders":"folders";await this.ensureFileId(s,d,u);const S=i==="aistudio"?this.aistudioFoldersFileId:this.foldersFileId;if(await this.uploadFileWithRetry(s,S,n),console.log(`[GoogleDriveSyncService] ${i} folders uploaded successfully`),t.length>0&&(await this.ensureFileId(s,C,"prompts"),await this.uploadFileWithRetry(s,this.promptsFileId,l),console.log("[GoogleDriveSyncService] Prompts uploaded successfully")),i==="gemini"&&r){const v={messages:Object.fromEntries(Object.entries(r.messages).map(([U,x])=>[U,x.map(F=>({...F,content:F.content.length>60?F.content.slice(0,60)+"...":F.content}))]))},T={format:"gemini-voyager.starred.v1",exportedAt:c.toISOString(),version:E,data:v};await this.ensureFileId(s,L,"starred"),await this.uploadFileWithRetry(s,this.starredFileId,T),console.log("[GoogleDriveSyncService] Starred messages uploaded successfully")}const h=Date.now();return i==="aistudio"?this.updateState({isSyncing:!1,lastUploadTimeAIStudio:h,error:null}):this.updateState({isSyncing:!1,lastUploadTime:h,error:null}),await this.saveState(),console.log(`[GoogleDriveSyncService] Upload successful - ${i==="gemini"?r?3:2:1} file(s) for ${i}`),!0}catch(s){const c=s instanceof Error?s.message:"Upload failed";return console.error("[GoogleDriveSyncService] Upload failed:",s),this.updateState({isSyncing:!1,error:c}),!1}}async download(e=!0,t="gemini"){try{this.updateState({isSyncing:!0,error:null});const r=await this.getAuthToken(e);if(!r){if(!e)return console.log("[GoogleDriveSyncService] Download skipped: Not authenticated (non-interactive)"),this.updateState({isSyncing:!1,isAuthenticated:!1}),null;throw new Error("Not authenticated")}const o=t==="aistudio"?D:M,i=await this.findFile(r,o);let s=null;i&&(s=await this.downloadFileWithRetry(r,i),console.log(`[GoogleDriveSyncService] ${t} folders downloaded`));let c=null;const n=await this.findFile(r,C);n&&(c=await this.downloadFileWithRetry(r,n),console.log("[GoogleDriveSyncService] Prompts downloaded"));let l=null;if(t==="gemini"){const u=await this.findFile(r,L);u&&(l=await this.downloadFileWithRetry(r,u),console.log("[GoogleDriveSyncService] Starred messages downloaded"))}if(!s&&!c&&!l)return console.log(`[GoogleDriveSyncService] No sync files found for ${t}`),this.updateState({isSyncing:!1}),null;const d=Date.now();return t==="aistudio"?this.updateState({isSyncing:!1,lastSyncTimeAIStudio:d,error:null}):this.updateState({isSyncing:!1,lastSyncTime:d,error:null}),await this.saveState(),{folders:s,prompts:c,starred:l}}catch(r){const o=r instanceof Error?r.message:"Download failed";return console.error("[GoogleDriveSyncService] Download failed:",r),this.updateState({isSyncing:!1,error:o}),null}}async loadCachedToken(){try{const e=await chrome.storage.local.get(["gvAccessToken","gvTokenExpiry"]);e.gvAccessToken&&e.gvTokenExpiry&&e.gvTokenExpiry>Date.now()&&(this.accessToken=e.gvAccessToken,this.tokenExpiry=e.gvTokenExpiry,console.log("[GoogleDriveSyncService] Loaded cached token"))}catch(e){console.error("[GoogleDriveSyncService] Failed to load cached token:",e)}}async saveToken(e,t){this.accessToken=e,this.tokenExpiry=Date.now()+t*1e3-6e4;try{await chrome.storage.local.set({gvAccessToken:e,gvTokenExpiry:this.tokenExpiry})}catch(r){console.error("[GoogleDriveSyncService] Failed to save token:",r)}}async clearToken(){this.accessToken=null,this.tokenExpiry=0;try{await chrome.storage.local.remove(["gvAccessToken","gvTokenExpiry"])}catch(e){console.error("[GoogleDriveSyncService] Failed to clear token:",e)}}async getAuthToken(e){if(this.accessToken||await this.loadCachedToken(),this.accessToken&&this.tokenExpiry>Date.now())return this.accessToken;if(!e)return null;const t=chrome.runtime.getManifest(),r=t.oauth2?.client_id,o=t.oauth2?.scopes?.join(" ");if(!r||!o)return console.error("[GoogleDriveSyncService] Missing oauth2 config"),null;const i=chrome.identity.getRedirectURL();console.log("[GoogleDriveSyncService] Auth flow starting with redirectUrl:",i);const s=new URL("https://accounts.google.com/o/oauth2/v2/auth");s.searchParams.set("client_id",r),s.searchParams.set("redirect_uri",i),s.searchParams.set("response_type","token"),s.searchParams.set("scope",o);try{const c=await new Promise((S,h)=>{chrome.identity.launchWebAuthFlow({url:s.toString(),interactive:!0},y=>{chrome.runtime.lastError?h(new Error(chrome.runtime.lastError.message)):y?S(y):h(new Error("No response from auth flow"))})}),n=new URL(c),l=new URLSearchParams(n.hash.substring(1)),d=l.get("access_token"),u=parseInt(l.get("expires_in")||"3600",10);return d?(await this.saveToken(d,u),d):null}catch(c){return console.error("[GoogleDriveSyncService] Auth flow failed:",c),null}}async findFile(e,t){const r=encodeURIComponent(`name='${t}' and trashed=false`),o=`${f}/files?q=${r}&fields=files(id,name)`,i=await fetch(o,{headers:{Authorization:`Bearer ${e}`}});if(!i.ok)throw new Error(`Failed to search files: ${i.status}`);return(await i.json()).files?.[0]?.id||null}async ensureFileId(e,t,r){const o=await this.ensureBackupFolder(e),i=r==="folders"?this.foldersFileId:r==="aistudio-folders"?this.aistudioFoldersFileId:r==="prompts"?this.promptsFileId:this.starredFileId;if(i){const n=await this.getFileParents(e,i);if(n){n.includes(o)||(console.log(`[GoogleDriveSyncService] Moving ${t} to backup folder`),await this.moveFile(e,i,o,n));return}}const s=await this.findFile(e,t);if(s){r==="folders"?this.foldersFileId=s:r==="aistudio-folders"?this.aistudioFoldersFileId=s:r==="prompts"?this.promptsFileId=s:this.starredFileId=s;const n=await this.getFileParents(e,s);n&&!n.includes(o)&&(console.log(`[GoogleDriveSyncService] Moving existing ${t} to backup folder`),await this.moveFile(e,s,o,n));return}console.log(`[GoogleDriveSyncService] Creating new file ${t} in backup folder`);const c=await this.createFile(e,t,o);r==="folders"?this.foldersFileId=c:r==="aistudio-folders"?this.aistudioFoldersFileId=c:r==="prompts"?this.promptsFileId=c:this.starredFileId=c}async ensureBackupFolder(e){if(this.backupFolderId&&await this.checkFileExists(e,this.backupFolderId))return this.backupFolderId;const t=encodeURIComponent(`name='${b}' and mimeType='application/vnd.google-apps.folder' and trashed=false`),r=`${f}/files?q=${t}&fields=files(id)`,o=await fetch(r,{headers:{Authorization:`Bearer ${e}`}});if(!o.ok)throw new Error("Failed to search for backup folder");const s=(await o.json()).files?.[0]?.id;if(s)return this.backupFolderId=s,s;const c={name:b,mimeType:"application/vnd.google-apps.folder"},n=await fetch(`${f}/files`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(c)});if(!n.ok)throw new Error("Failed to create backup folder");const l=await n.json();return this.backupFolderId=l.id,console.log("[GoogleDriveSyncService] Created backup folder:",this.backupFolderId),l.id}async getFileParents(e,t){try{const r=await fetch(`${f}/files/${t}?fields=parents,trashed`,{headers:{Authorization:`Bearer ${e}`}});if(r.status===404||!r.ok)return null;const o=await r.json();return o.trashed?(console.log(`[GoogleDriveSyncService] File ${t} is in trash, will create new one`),null):o.parents||[]}catch{return null}}async moveFile(e,t,r,o){const i=o.join(","),s=`${f}/files/${t}?addParents=${r}&removeParents=${i}&fields=id,parents`,c=await fetch(s,{method:"PATCH",headers:{Authorization:`Bearer ${e}`}});c.ok||console.error("[GoogleDriveSyncService] Failed to move file:",await c.text())}async checkFileExists(e,t){try{return(await fetch(`${f}/files/${t}?fields=id`,{headers:{Authorization:`Bearer ${e}`}})).ok}catch{return!1}}async createFile(e,t,r){const o={name:t,mimeType:"application/json"};r&&(o.parents=[r]);const i=await fetch(`${f}/files`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw new Error(`Failed to create file: ${i.status}`);return(await i.json()).id}async uploadFileWithRetry(e,t,r){let o=P;for(let i=1;i<=k;i++)try{const s=`${R}/files/${t}?uploadType=media`,c=await fetch(s,{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!c.ok)throw new Error(`Upload failed: ${c.status}`);return}catch(s){if(i===k)throw s;await this.sleep(o),o*=2}}async downloadFileWithRetry(e,t){let r=P;for(let o=1;o<=k;o++)try{const i=`${f}/files/${t}?alt=media`,s=await fetch(i,{headers:{Authorization:`Bearer ${e}`}});if(!s.ok){if(s.status===404)return null;throw new Error(`Download failed: ${s.status}`)}return await s.json()}catch(i){if(o===k)throw i;await this.sleep(r),r*=2}return null}async loadState(){try{const e=await chrome.storage.local.get(["gvSyncMode","gvLastSyncTime","gvLastUploadTime","gvLastSyncTimeAIStudio","gvLastUploadTimeAIStudio","gvSyncError"]);this.state={mode:e.gvSyncMode||"disabled",lastSyncTime:e.gvLastSyncTime||null,lastUploadTime:e.gvLastUploadTime||null,lastSyncTimeAIStudio:e.gvLastSyncTimeAIStudio||null,lastUploadTimeAIStudio:e.gvLastUploadTimeAIStudio||null,error:e.gvSyncError||null,isSyncing:!1,isAuthenticated:!1};const t=await this.getAuthToken(!1);this.state.isAuthenticated=!!t}catch(e){console.error("[GoogleDriveSyncService] Failed to load state:",e)}}async saveState(){try{await chrome.storage.local.set({gvSyncMode:this.state.mode,gvLastSyncTime:this.state.lastSyncTime,gvLastUploadTime:this.state.lastUploadTime,gvLastSyncTimeAIStudio:this.state.lastSyncTimeAIStudio,gvLastUploadTimeAIStudio:this.state.lastUploadTimeAIStudio,gvSyncError:this.state.error})}catch(e){console.error("[GoogleDriveSyncService] Failed to save state:",e)}}updateState(e){this.state={...this.state,...e},this.notifyStateChange()}notifyStateChange(){this.stateChangeCallback&&this.stateChangeCallback({...this.state})}sleep(e){return new Promise(t=>setTimeout(t,e))}}const g=new j,$="gv-custom-content-script",p="gvPromptCustomWebsites",N="gv-fetch-interceptor",W=["https://gemini.google.com/*","https://aistudio.google.com/*","https://aistudio.google.cn/*"];async function G(){if(!chrome.scripting?.registerContentScripts)return;const e=(await chrome.storage.sync.get({geminiWatermarkRemoverEnabled:!0})).geminiWatermarkRemoverEnabled!==!1;try{await chrome.scripting.unregisterContentScripts({ids:[N]})}catch{}if(!e){console.log("[Background] Fetch interceptor not registered (watermark remover disabled)");return}try{await chrome.scripting.registerContentScripts([{id:N,js:["fetchInterceptor.js"],matches:W,world:"MAIN",runAt:"document_start",persistAcrossSessions:!0}]),console.log("[Background] Fetch interceptor registered for MAIN world")}catch(t){console.error("[Background] Failed to register fetch interceptor:",t)}}const z=new Set([...chrome.runtime.getManifest().host_permissions||[],...chrome.runtime.getManifest().content_scripts?.flatMap(a=>a.matches||[])||[]].map(O).filter(a=>!!a));function O(a){if(!a)return null;try{return a.replace(/^[^:]+:\/\//,"").replace(/\/.*$/,"").replace(/^\*\./,"")||null}catch{return null}}function H(a){const e=a.trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,"").replace(/^\*\./,"");return e?[`https://*.${e}/*`,`http://*.${e}/*`]:[]}function V(a){if(!Array.isArray(a))return[];const e=a.map(O).filter(t=>!!t).filter(t=>!z.has(t));return Array.from(new Set(e))}async function X(a){const e=[];for(const t of a)try{await _.permissions.contains({origins:[t]})&&e.push(t)}catch(r){console.warn("[Background] Failed to check permission for",t,r)}return e}async function I(a){if(!chrome.scripting?.registerContentScripts)return;const e=chrome.runtime.getManifest().content_scripts?.[0];if(!e)return;const t=a??(await chrome.storage.sync.get({[p]:[]}))[p],r=Array.from(new Set((Array.isArray(t)?t:[]).flatMap(H).filter(Boolean))),o=await X(r);try{await chrome.scripting.unregisterContentScripts({ids:[$]})}catch{}if(!o.length)return;const i=e.run_at==="document_start"?"document_start":e.run_at==="document_end"?"document_end":"document_idle";try{await chrome.scripting.registerContentScripts([{id:$,js:e.js||[],css:e.css,matches:o,allFrames:e.all_frames,runAt:i,persistAcrossSessions:!0}]),console.log("[Background] Custom content scripts registered for",o)}catch(s){console.error("[Background] Failed to register custom content scripts:",s)}}I();G();chrome.storage.onChanged.addListener((a,e)=>{if(e==="sync"){if(Object.prototype.hasOwnProperty.call(a,p)){const t=a[p]?.newValue,r=Array.isArray(t)?t:[];I(r)}Object.prototype.hasOwnProperty.call(a,"geminiWatermarkRemoverEnabled")&&G()}});chrome.permissions.onAdded.addListener(({origins:a})=>{const e=V(a);e.length&&_.storage.sync.get({[p]:[]}).then(t=>{const r=Array.isArray(t[p])?t[p]:[],o=Array.from(new Set([...r,...e]));if(o.length!==r.length)return _.storage.sync.set({[p]:o})}).catch(t=>{console.warn("[Background] Failed to persist domains from permissions.onAdded:",t)}),I()});chrome.permissions.onRemoved.addListener(()=>{I()});class q{operationQueue=Promise.resolve();serialize(e){const t=this.operationQueue.then(e,e);return this.operationQueue=t.catch(()=>{}),t}async getFromStorage(){try{return(await chrome.storage.local.get([A.TIMELINE_STARRED_MESSAGES]))[A.TIMELINE_STARRED_MESSAGES]||{messages:{}}}catch(e){return console.error("[Background] Failed to get starred messages:",e),{messages:{}}}}async saveToStorage(e){await chrome.storage.local.set({[A.TIMELINE_STARRED_MESSAGES]:e})}async addStarredMessage(e){return this.serialize(async()=>{const t=await this.getFromStorage();if(t.messages[e.conversationId]||(t.messages[e.conversationId]=[]),!t.messages[e.conversationId].some(o=>o.turnId===e.turnId)){const i={...e,content:e.content.length>60?e.content.slice(0,60)+"...":e.content};return t.messages[e.conversationId].push(i),await this.saveToStorage(t),!0}return!1})}async removeStarredMessage(e,t){return this.serialize(async()=>{const r=await this.getFromStorage();if(r.messages[e]){const o=r.messages[e].length;if(r.messages[e]=r.messages[e].filter(i=>i.turnId!==t),r.messages[e].length<o)return r.messages[e].length===0&&delete r.messages[e],await this.saveToStorage(r),!0}return!1})}async getAllStarredMessages(){return this.getFromStorage()}async getStarredMessagesForConversation(e){return(await this.getFromStorage()).messages[e]||[]}async isMessageStarred(e,t){return(await this.getStarredMessagesForConversation(e)).some(o=>o.turnId===t)}}const m=new q;chrome.runtime.onMessage.addListener((a,e,t)=>((async()=>{try{if(a&&a.type&&a.type.startsWith("gv.starred."))switch(a.type){case"gv.starred.add":{const n=await m.addStarredMessage(a.payload);t({ok:!0,added:n});return}case"gv.starred.remove":{const n=await m.removeStarredMessage(a.payload.conversationId,a.payload.turnId);t({ok:!0,removed:n});return}case"gv.starred.getAll":{const n=await m.getAllStarredMessages();t({ok:!0,data:n});return}case"gv.starred.getForConversation":{const n=await m.getStarredMessagesForConversation(a.payload.conversationId);t({ok:!0,messages:n});return}case"gv.starred.isStarred":{const n=await m.isMessageStarred(a.payload.conversationId,a.payload.turnId);t({ok:!0,isStarred:n});return}}if(a&&a.type&&a.type.startsWith("gv.sync."))switch(a.type){case"gv.sync.authenticate":{const n=a.payload?.interactive!==!1,l=await g.authenticate(n);t({ok:l,state:await g.getState()});return}case"gv.sync.signOut":{await g.signOut(),t({ok:!0,state:await g.getState()});return}case"gv.sync.upload":{const{folders:n,prompts:l,interactive:d,platform:u}=a.payload,S=u!=="aistudio"?await m.getAllStarredMessages():null,h=await g.upload(n,l,S,d!==!1,u||"gemini");t({ok:h,state:await g.getState()});return}case"gv.sync.download":{const n=a.payload?.interactive!==!1,l=a.payload?.platform||"gemini",d=await g.download(n,l);console.log(`[Background] Downloaded data for ${l}, returning to caller for merge`),t({ok:!0,data:d,state:await g.getState()});return}case"gv.sync.getState":{t({ok:!0,state:await g.getState()});return}case"gv.sync.setMode":{const n=a.payload?.mode;n&&await g.setMode(n),t({ok:!0,state:await g.getState()});return}}if(a&&a.type==="gv.openPopup"){try{await chrome.action.openPopup(),t({ok:!0})}catch(n){console.warn("[GV] Failed to open popup programmatically:",n),t({ok:!1,error:String(n?.message||n)})}return}if(a?.type==="gv.fetchImageViaPage"){const n=String(a.url||""),l=e?.tab?.id;if(!l||!/^https?:\/\//i.test(n)){t({ok:!1,error:"invalid"});return}if(!chrome.scripting?.executeScript){t({ok:!1,error:"scripting_api_unavailable"});return}try{const u=(await chrome.scripting.executeScript({target:{tabId:l},world:"MAIN",func:S=>fetch(S,{credentials:"include"}).then(h=>h.ok?h.blob():null).then(h=>h?new Promise(y=>{const w=new FileReader;w.onload=()=>{const v=String(w.result||""),T=v.indexOf(",");if(T<0){y(null);return}y({contentType:h.type||"application/octet-stream",base64:v.substring(T+1)})},w.onerror=()=>y(null),w.readAsDataURL(h)}):null).catch(()=>null),args:[n]}))?.[0]?.result;u?.base64?t({ok:!0,contentType:u.contentType,base64:u.base64}):t({ok:!1,error:"page_fetch_failed"})}catch(d){const u=d instanceof Error?d.message:String(d);t({ok:!1,error:u})}return}if(!a||a.type!=="gv.fetchImage")return;const r=String(a.url||"");if(!/^https?:\/\//i.test(r)){t({ok:!1,error:"invalid_url"});return}const o=await fetch(r,{credentials:"include",mode:"cors"});if(!o.ok){t({ok:!1,status:o.status});return}const i=o.headers.get("Content-Type")||"",s=await o.arrayBuffer(),c=Y(s);t({ok:!0,contentType:i,base64:c})}catch(r){try{t({ok:!1,error:String(r?.message||r)})}catch{}}})(),!0));function Y(a){let e="";const t=new Uint8Array(a),r=t.byteLength;for(let o=0;o<r;o++)e+=String.fromCharCode(t[o]);return btoa(e)}
