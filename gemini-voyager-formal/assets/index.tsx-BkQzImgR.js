const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/i18n-CcLr9W9q.js","assets/common-DScLtf9v.js","assets/mermaid.core-GTuBGjEb.js","assets/marked.esm-DKsjQqph.js","assets/index-Blnr25Sc.js","assets/katex-qrhCpa0F.js"])))=>i.map(i=>d[i]);
import{i as en,S as Zo,e as oa,k as ia}from"./StarredMessagesService-Dd_FMgPB.js";import{S as ke,b as Ce,c as Jr,g as Bd}from"./common-DScLtf9v.js";import{n as Bo,i as jr,c as $d,b as Ke,d as qd,e as zd,A as Ud,f as Hd,g as Gd,s as jd}from"./i18n-CcLr9W9q.js";import{E as Wd,i as Vd,g as Yd,a as Kd,c as Zd}from"./version-BI7FQyLD.js";const Xd=/extension context invalidated/i;function Jd(n){if(typeof n=="string")return n;if(n instanceof Error)return n.message;if(n&&typeof n=="object"&&"message"in n){const e=n.message;return typeof e=="string"?e:""}return""}function Ct(n){const e=Jd(n);return Xd.test(e)}function Ls(){try{return!!globalThis.chrome?.runtime?.id}catch{return!1}}const Qd=["enterprise","workspace","workspaces","business"],eu=new Set(["business.gemini.google"]);function qi(n){const e=n.toLowerCase();return Qd.some(t=>e.includes(t))}function tu({hostname:n,pathname:e="",search:t="",hash:r=""}){const o=n.toLowerCase();return eu.has(o)?!0:o!=="gemini.google.com"?!1:qi(`${e}${t}${r}`)}function nu(n){const e=n.documentElement,t=n.body,r=`${e?.className??""} ${t?.className??""}`.trim();if(r&&qi(r))return!0;const o=[...Object.values(e?.dataset??{}),...Object.values(t?.dataset??{})].filter(i=>typeof i=="string"&&i.length>0);return!!(o.length&&qi(o.join(" ")))}function ru(n,e){return tu(n)?!0:n.hostname.toLowerCase()!=="gemini.google.com"?!1:e?nu(e):!1}class Q{constructor(e,t){let r=" "+e,o;const i=t&&t.loc;if(i&&i.start<=i.end){const a=i.lexer.input;o=i.start;const l=i.end;o===a.length?r+=" at end of input: ":r+=" at position "+(o+1)+`: 
`;const d=a.slice(o,l).replace(/[^]/g,"$&Ì²");let u;o>15?u="â€¦"+a.slice(o-15,o):u=a.slice(0,o);let m;l+15<a.length?m=a.slice(l,l+15)+"â€¦":m=a.slice(l),r+=u+d+m}const s=new Error(r);return s.name="ParseError",s.__proto__=Q.prototype,s.position=o,s}}Q.prototype.__proto__=Error.prototype;const Zt=function(n,e){return n===void 0?e:n},ou=/([A-Z])/g,Ds=function(n){return n.replace(ou,"-$1").toLowerCase()},iu={"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#x27;"},su=/[&><"']/g;function mn(n){return String(n).replace(su,e=>iu[e])}const yo=function(n){return n.type==="ordgroup"||n.type==="color"?n.body.length===1?yo(n.body[0]):n:n.type==="font"?yo(n.body):n},$o=function(n){const e=yo(n);return e.type==="mathord"||e.type==="textord"||e.type==="atom"},au=function(n){if(!n)throw new Error("Expected non-null, but got "+String(n));return n},lu=function(n){const e=/^[\x00-\x20]*([^\\/#?]*?)(:|&#0*58|&#x0*3a|&colon)/i.exec(n);return e?e[2]!==":"||!/^[a-zA-Z][a-zA-Z0-9+\-.]*$/.test(e[1])?null:e[1].toLowerCase():"_relative"},Xo=function(n){return+n.toFixed(4)},sc="acegÄ±È·mnopqrsuvwxyzÎ±Î³ÎµÎ·Î¹ÎºÎ¼Î½Î¿Ï€ÏÏ‚ÏƒÏ„Ï…Ï‡Ï‰Ï•ğšğœğğ ğ¦ğ§ğ¨ğ©ğªğ«ğ¬ğ®ğ¯ğ°ğ±ğ²ğ³";class Ms{constructor(e){e=e||{},this.displayMode=Zt(e.displayMode,!1),this.annotate=Zt(e.annotate,!1),this.leqno=Zt(e.leqno,!1),this.throwOnError=Zt(e.throwOnError,!1),this.errorColor=Zt(e.errorColor,"#b22222"),this.macros=e.macros||{},this.wrap=Zt(e.wrap,"none"),this.xml=Zt(e.xml,!1),this.colorIsTextColor=Zt(e.colorIsTextColor,!1),this.strict=Zt(e.strict,!1),this.trust=Zt(e.trust,!1),this.maxSize=e.maxSize===void 0?[1/0,1/0]:Array.isArray(e.maxSize)?e.maxSize:[1/0,1/0],this.maxExpand=Math.max(0,Zt(e.maxExpand,1e3))}isTrusted(e){if(e.url&&!e.protocol){const r=lu(e.url);if(r==null)return!1;e.protocol=r}return!!(typeof this.trust=="function"?this.trust(e):this.trust)}}const ac={},Lo={};function ue({type:n,names:e,props:t,handler:r,mathmlBuilder:o}){const i={type:n,numArgs:t.numArgs,argTypes:t.argTypes,allowedInArgument:!!t.allowedInArgument,allowedInText:!!t.allowedInText,allowedInMath:t.allowedInMath===void 0?!0:t.allowedInMath,numOptionalArgs:t.numOptionalArgs||0,infix:!!t.infix,primitive:!!t.primitive,handler:r};for(let s=0;s<e.length;++s)ac[e[s]]=i;n&&o&&(Lo[n]=o)}function Nn({type:n,mathmlBuilder:e}){ue({type:n,names:[],props:{numArgs:0},handler(){throw new Error("Should never be called.")},mathmlBuilder:e})}const $r=function(n){return n.type==="ordgroup"&&n.body.length===1?n.body[0]:n},ht=function(n){return n.type==="ordgroup"?n.body:[n]};class Ns{constructor(e){this.children=e,this.classes=[],this.style={}}hasClass(e){return this.classes.includes(e)}toNode(){const e=document.createDocumentFragment();for(let t=0;t<this.children.length;t++)e.appendChild(this.children[t].toNode());return e}toMarkup(){let e="";for(let t=0;t<this.children.length;t++)e+=this.children[t].toMarkup();return e}toText(){const e=t=>t.toText();return this.children.map(e).join("")}}const tr=function(n){return n.filter(e=>e).join(" ")},cu=function(n,e){this.classes=n||[],this.attributes={},this.style=e||{}},du=function(n){const e=document.createElement(n);e.className=tr(this.classes);for(const t in this.style)Object.prototype.hasOwnProperty.call(this.style,t)&&(e.style[t]=this.style[t]);for(const t in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,t)&&e.setAttribute(t,this.attributes[t]);for(let t=0;t<this.children.length;t++)e.appendChild(this.children[t].toNode());return e},uu=function(n){let e=`<${n}`;this.classes.length&&(e+=` class="${mn(tr(this.classes))}"`);let t="";for(const r in this.style)Object.prototype.hasOwnProperty.call(this.style,r)&&(t+=`${Ds(r)}:${this.style[r]};`);t&&(e+=` style="${t}"`);for(const r in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,r)&&(e+=` ${r}="${mn(this.attributes[r])}"`);e+=">";for(let r=0;r<this.children.length;r++)e+=this.children[r].toMarkup();return e+=`</${n}>`,e};class lc{constructor(e,t,r){cu.call(this,e,r),this.children=t||[]}setAttribute(e,t){this.attributes[e]=t}toNode(){return du.call(this,"span")}toMarkup(){return uu.call(this,"span")}}let hu=class{constructor(e){this.text=e}toNode(){return document.createTextNode(this.text)}toMarkup(){return mn(this.text)}};class cc{constructor(e,t,r){this.href=e,this.classes=t,this.children=r||[]}toNode(){const e=document.createElement("a");e.setAttribute("href",this.href),this.classes.length>0&&(e.className=tr(this.classes));for(let t=0;t<this.children.length;t++)e.appendChild(this.children[t].toNode());return e}toMarkup(){let e=`<a href='${mn(this.href)}'`;this.classes.length>0&&(e+=` class="${mn(tr(this.classes))}"`),e+=">";for(let t=0;t<this.children.length;t++)e+=this.children[t].toMarkup();return e+="</a>",e}}class mu{constructor(e,t,r){this.alt=t,this.src=e,this.classes=["mord"],this.style=r}hasClass(e){return this.classes.includes(e)}toNode(){const e=document.createElement("img");e.src=this.src,e.alt=this.alt,e.className="mord";for(const t in this.style)Object.prototype.hasOwnProperty.call(this.style,t)&&(e.style[t]=this.style[t]);return e}toMarkup(){let e=`<img src='${this.src}' alt='${this.alt}'`,t="";for(const r in this.style)Object.prototype.hasOwnProperty.call(this.style,r)&&(t+=`${Ds(r)}:${this.style[r]};`);return t&&(e+=` style="${mn(t)}"`),e+=">",e}}function Ln(n){return new Ns(n)}class P{constructor(e,t,r,o){this.type=e,this.attributes={},this.children=t||[],this.classes=r||[],this.style=o||{},this.label=""}setAttribute(e,t){this.attributes[e]=t}getAttribute(e){return this.attributes[e]}setLabel(e){this.label=e}toNode(){const e=document.createElementNS("http://www.w3.org/1998/Math/MathML",this.type);for(const t in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,t)&&e.setAttribute(t,this.attributes[t]);this.classes.length>0&&(e.className=tr(this.classes));for(const t in this.style)Object.prototype.hasOwnProperty.call(this.style,t)&&(e.style[t]=this.style[t]);for(let t=0;t<this.children.length;t++)e.appendChild(this.children[t].toNode());return e}toMarkup(){let e="<"+this.type;for(const r in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,r)&&(e+=" "+r+'="',e+=mn(this.attributes[r]),e+='"');this.classes.length>0&&(e+=` class="${mn(tr(this.classes))}"`);let t="";for(const r in this.style)Object.prototype.hasOwnProperty.call(this.style,r)&&(t+=`${Ds(r)}:${this.style[r]};`);t&&(e+=` style="${t}"`),e+=">";for(let r=0;r<this.children.length;r++)e+=this.children[r].toMarkup();return e+="</"+this.type+">",e}toText(){return this.children.map(e=>e.toText()).join("")}}class ft{constructor(e){this.text=e}toNode(){return document.createTextNode(this.text)}toMarkup(){return mn(this.toText())}toText(){return this.text}}const Fs=n=>{let e;return n.length===1&&n[0].type==="mrow"?(e=n.pop(),e.type="mstyle"):e=new P("mstyle",n),e},Gn=n=>{let e=0;if(n.body&&Array.isArray(n.body))for(const t of n.body)e+=Gn(t);else if(n.body)e+=Gn(n.body);else if(n.type==="supsub")e+=Gn(n.base),n.sub&&(e+=.7*Gn(n.sub)),n.sup&&(e+=.7*Gn(n.sup));else if(n.type==="mathord"||n.type==="textord")for(const t of n.text.split("")){const r=t.codePointAt(0);96<r&&r<123||944<r&&r<970?e+=.56:47<r&&r<58?e+=.5:e+=.92}else e+=1;return e},pu={widehat:"^",widecheck:"Ë‡",widetilde:"~",wideparen:"âœ",utilde:"~",overleftarrow:"â†",underleftarrow:"â†",xleftarrow:"â†",overrightarrow:"â†’",underrightarrow:"â†’",xrightarrow:"â†’",underbrace:"âŸ",overbrace:"â",overbracket:"â´",underbracket:"âµ",overgroup:"â ",overparen:"âœ",undergroup:"â¡",underparen:"â",overleftrightarrow:"â†”",underleftrightarrow:"â†”",xleftrightarrow:"â†”",Overrightarrow:"â‡’",xRightarrow:"â‡’",overleftharpoon:"â†¼",xleftharpoonup:"â†¼",overrightharpoon:"â‡€",xrightharpoonup:"â‡€",xLeftarrow:"â‡",xLeftrightarrow:"â‡”",xhookleftarrow:"â†©",xhookrightarrow:"â†ª",xmapsto:"â†¦",xrightharpoondown:"â‡",xleftharpoondown:"â†½",xtwoheadleftarrow:"â†",xtwoheadrightarrow:"â† ",xlongequal:"=",xrightleftarrows:"â‡„",xtofrom:"â‡„",xleftrightharpoons:"â‡‹",xrightleftharpoons:"â‡Œ",yields:"â†’",yieldsLeft:"â†",mesomerism:"â†”",longrightharpoonup:"â‡€",longleftharpoondown:"â†½",eqrightharpoonup:"â‡€",eqleftharpoondown:"â†½","\\cdrightarrow":"â†’","\\cdleftarrow":"â†","\\cdlongequal":"=",yieldsLeftRight:"â‡„",chemequilibrium:"â‡Œ"},Os=function(n){const e=new ft(pu[n.slice(1)]),t=new P("mo",[e]);return t.setAttribute("stretchy","true"),t},fu=["\\widetilde","\\widehat","\\widecheck","\\utilde"],dc=n=>{const e=Os(n.label);if(fu.includes(n.label)){const t=Gn(n.base);1<t&&t<1.6?e.classes.push("tml-crooked-2"):1.6<=t&&t<2.5?e.classes.push("tml-crooked-3"):2.5<=t&&e.classes.push("tml-crooked-4")}return e},gu={bin:1,close:1,inner:1,open:1,punct:1,rel:1},bu={"accent-token":1,mathord:1,"op-token":1,spacing:1,textord:1},ct={math:{},text:{}};function c(n,e,t,r,o){ct[n][r]={group:e,replace:t},o&&t&&(ct[n][t]=ct[n][r])}const h="math",U="text",Fe="accent-token",H="bin",tt="close",Fn="inner",le="mathord",Ie="op-token",dt="open",Wr="punct",k="rel",pn="spacing",_="textord";c(h,k,"â‰¡","\\equiv",!0);c(h,k,"â‰º","\\prec",!0);c(h,k,"â‰»","\\succ",!0);c(h,k,"âˆ¼","\\sim",!0);c(h,k,"âŸ‚","\\perp",!0);c(h,k,"âª¯","\\preceq",!0);c(h,k,"âª°","\\succeq",!0);c(h,k,"â‰ƒ","\\simeq",!0);c(h,k,"â‰Œ","\\backcong",!0);c(h,k,"|","\\mid",!0);c(h,k,"â‰ª","\\ll",!0);c(h,k,"â‰«","\\gg",!0);c(h,k,"â‰","\\asymp",!0);c(h,k,"âˆ¥","\\parallel");c(h,k,"âŒ£","\\smile",!0);c(h,k,"âŠ‘","\\sqsubseteq",!0);c(h,k,"âŠ’","\\sqsupseteq",!0);c(h,k,"â‰","\\doteq",!0);c(h,k,"âŒ¢","\\frown",!0);c(h,k,"âˆ‹","\\ni",!0);c(h,k,"âˆŒ","\\notni",!0);c(h,k,"âˆ","\\propto",!0);c(h,k,"âŠ¢","\\vdash",!0);c(h,k,"âŠ£","\\dashv",!0);c(h,k,"âˆ‹","\\owns");c(h,k,"â‰˜","\\arceq",!0);c(h,k,"â‰™","\\wedgeq",!0);c(h,k,"â‰š","\\veeeq",!0);c(h,k,"â‰›","\\stareq",!0);c(h,k,"â‰","\\eqdef",!0);c(h,k,"â‰","\\measeq",!0);c(h,k,"â‰Ÿ","\\questeq",!0);c(h,k,"â‰ ","\\ne",!0);c(h,k,"â‰ ","\\neq");c(h,k,"â©µ","\\eqeq",!0);c(h,k,"â©¶","\\eqeqeq",!0);c(h,k,"âˆ·","\\dblcolon",!0);c(h,k,"â‰”","\\coloneqq",!0);c(h,k,"â‰•","\\eqqcolon",!0);c(h,k,"âˆ¹","\\eqcolon",!0);c(h,k,"â©´","\\Coloneqq",!0);c(h,Wr,".","\\ldotp");c(h,Wr,"Â·","\\cdotp");c(h,_,"#","\\#");c(U,_,"#","\\#");c(h,_,"&","\\&");c(U,_,"&","\\&");c(h,_,"â„µ","\\aleph",!0);c(h,_,"âˆ€","\\forall",!0);c(h,_,"â„","\\hbar",!0);c(h,_,"âˆƒ","\\exists",!0);c(h,H,"âˆ‡","\\nabla",!0);c(h,_,"â™­","\\flat",!0);c(h,_,"â„“","\\ell",!0);c(h,_,"â™®","\\natural",!0);c(h,_,"â„«","\\Angstrom",!0);c(U,_,"â„«","\\Angstrom",!0);c(h,_,"â™£","\\clubsuit",!0);c(h,_,"â™§","\\varclubsuit",!0);c(h,_,"â„˜","\\wp",!0);c(h,_,"â™¯","\\sharp",!0);c(h,_,"â™¢","\\diamondsuit",!0);c(h,_,"â™¦","\\vardiamondsuit",!0);c(h,_,"â„œ","\\Re",!0);c(h,_,"â™¡","\\heartsuit",!0);c(h,_,"â™¥","\\varheartsuit",!0);c(h,_,"â„‘","\\Im",!0);c(h,_,"â™ ","\\spadesuit",!0);c(h,_,"â™¤","\\varspadesuit",!0);c(h,_,"â™€","\\female",!0);c(h,_,"â™‚","\\male",!0);c(h,_,"Â§","\\S",!0);c(U,_,"Â§","\\S");c(h,_,"Â¶","\\P",!0);c(U,_,"Â¶","\\P");c(U,_,"â˜º","\\smiley",!0);c(h,_,"â˜º","\\smiley",!0);c(h,_,"â€ ","\\dag");c(U,_,"â€ ","\\dag");c(U,_,"â€ ","\\textdagger");c(h,_,"â€¡","\\ddag");c(U,_,"â€¡","\\ddag");c(U,_,"â€¡","\\textdaggerdbl");c(h,tt,"â±","\\rmoustache",!0);c(h,dt,"â°","\\lmoustache",!0);c(h,tt,"âŸ¯","\\rgroup",!0);c(h,dt,"âŸ®","\\lgroup",!0);c(h,H,"âˆ“","\\mp",!0);c(h,H,"âŠ–","\\ominus",!0);c(h,H,"âŠ","\\uplus",!0);c(h,H,"âŠ“","\\sqcap",!0);c(h,H,"âˆ—","\\ast");c(h,H,"âŠ”","\\sqcup",!0);c(h,H,"â—¯","\\bigcirc",!0);c(h,H,"âˆ™","\\bullet",!0);c(h,H,"â€¡","\\ddagger");c(h,H,"â‰€","\\wr",!0);c(h,H,"â¨¿","\\amalg");c(h,H,"&","\\And");c(h,H,"â«½","\\sslash",!0);c(h,k,"âŸµ","\\longleftarrow",!0);c(h,k,"â‡","\\Leftarrow",!0);c(h,k,"âŸ¸","\\Longleftarrow",!0);c(h,k,"âŸ¶","\\longrightarrow",!0);c(h,k,"â‡’","\\Rightarrow",!0);c(h,k,"âŸ¹","\\Longrightarrow",!0);c(h,k,"â†”","\\leftrightarrow",!0);c(h,k,"âŸ·","\\longleftrightarrow",!0);c(h,k,"â‡”","\\Leftrightarrow",!0);c(h,k,"âŸº","\\Longleftrightarrow",!0);c(h,k,"â†¤","\\mapsfrom",!0);c(h,k,"â†¦","\\mapsto",!0);c(h,k,"âŸ¼","\\longmapsto",!0);c(h,k,"â†—","\\nearrow",!0);c(h,k,"â†©","\\hookleftarrow",!0);c(h,k,"â†ª","\\hookrightarrow",!0);c(h,k,"â†˜","\\searrow",!0);c(h,k,"â†¼","\\leftharpoonup",!0);c(h,k,"â‡€","\\rightharpoonup",!0);c(h,k,"â†™","\\swarrow",!0);c(h,k,"â†½","\\leftharpoondown",!0);c(h,k,"â‡","\\rightharpoondown",!0);c(h,k,"â†–","\\nwarrow",!0);c(h,k,"â‡Œ","\\rightleftharpoons",!0);c(h,le,"â†¯","\\lightning",!0);c(h,le,"âˆ","\\QED",!0);c(h,le,"â€°","\\permil",!0);c(U,_,"â€°","\\permil");c(h,le,"â˜‰","\\astrosun",!0);c(h,le,"â˜¼","\\sun",!0);c(h,le,"â˜¾","\\leftmoon",!0);c(h,le,"â˜½","\\rightmoon",!0);c(h,le,"âŠ•","\\Earth");c(h,k,"â‰®","\\nless",!0);c(h,k,"âª‡","\\lneq",!0);c(h,k,"â‰¨","\\lneqq",!0);c(h,k,"â‰¨ï¸€","\\lvertneqq");c(h,k,"â‹¦","\\lnsim",!0);c(h,k,"âª‰","\\lnapprox",!0);c(h,k,"âŠ€","\\nprec",!0);c(h,k,"â‹ ","\\npreceq",!0);c(h,k,"â‹¨","\\precnsim",!0);c(h,k,"âª¹","\\precnapprox",!0);c(h,k,"â‰","\\nsim",!0);c(h,k,"âˆ¤","\\nmid",!0);c(h,k,"âˆ¤","\\nshortmid");c(h,k,"âŠ¬","\\nvdash",!0);c(h,k,"âŠ­","\\nvDash",!0);c(h,k,"â‹ª","\\ntriangleleft");c(h,k,"â‹¬","\\ntrianglelefteq",!0);c(h,k,"âŠ„","\\nsubset",!0);c(h,k,"âŠ…","\\nsupset",!0);c(h,k,"âŠŠ","\\subsetneq",!0);c(h,k,"âŠŠï¸€","\\varsubsetneq");c(h,k,"â«‹","\\subsetneqq",!0);c(h,k,"â«‹ï¸€","\\varsubsetneqq");c(h,k,"â‰¯","\\ngtr",!0);c(h,k,"âªˆ","\\gneq",!0);c(h,k,"â‰©","\\gneqq",!0);c(h,k,"â‰©ï¸€","\\gvertneqq");c(h,k,"â‹§","\\gnsim",!0);c(h,k,"âªŠ","\\gnapprox",!0);c(h,k,"âŠ","\\nsucc",!0);c(h,k,"â‹¡","\\nsucceq",!0);c(h,k,"â‹©","\\succnsim",!0);c(h,k,"âªº","\\succnapprox",!0);c(h,k,"â‰†","\\ncong",!0);c(h,k,"âˆ¦","\\nparallel",!0);c(h,k,"âˆ¦","\\nshortparallel");c(h,k,"âŠ¯","\\nVDash",!0);c(h,k,"â‹«","\\ntriangleright");c(h,k,"â‹­","\\ntrianglerighteq",!0);c(h,k,"âŠ‹","\\supsetneq",!0);c(h,k,"âŠ‹","\\varsupsetneq");c(h,k,"â«Œ","\\supsetneqq",!0);c(h,k,"â«Œï¸€","\\varsupsetneqq");c(h,k,"âŠ®","\\nVdash",!0);c(h,k,"âªµ","\\precneqq",!0);c(h,k,"âª¶","\\succneqq",!0);c(h,H,"âŠ´","\\unlhd");c(h,H,"âŠµ","\\unrhd");c(h,k,"â†š","\\nleftarrow",!0);c(h,k,"â†›","\\nrightarrow",!0);c(h,k,"â‡","\\nLeftarrow",!0);c(h,k,"â‡","\\nRightarrow",!0);c(h,k,"â†®","\\nleftrightarrow",!0);c(h,k,"â‡","\\nLeftrightarrow",!0);c(h,k,"â–³","\\vartriangle");c(h,_,"â„","\\hslash");c(h,_,"â–½","\\triangledown");c(h,_,"â—Š","\\lozenge");c(h,_,"â“ˆ","\\circledS");c(h,_,"Â®","\\circledR",!0);c(U,_,"Â®","\\circledR");c(U,_,"Â®","\\textregistered");c(h,_,"âˆ¡","\\measuredangle",!0);c(h,_,"âˆ„","\\nexists");c(h,_,"â„§","\\mho");c(h,_,"â„²","\\Finv",!0);c(h,_,"â…","\\Game",!0);c(h,_,"â€µ","\\backprime");c(h,_,"â€¶","\\backdprime");c(h,_,"â€·","\\backtrprime");c(h,_,"â–²","\\blacktriangle");c(h,_,"â–¼","\\blacktriangledown");c(h,_,"â– ","\\blacksquare");c(h,_,"â§«","\\blacklozenge");c(h,_,"â˜…","\\bigstar");c(h,_,"âˆ¢","\\sphericalangle",!0);c(h,_,"âˆ","\\complement",!0);c(h,_,"â•±","\\diagup");c(h,_,"â•²","\\diagdown");c(h,_,"â–¡","\\square");c(h,_,"â–¡","\\Box");c(h,_,"â—Š","\\Diamond");c(h,_,"Â¥","\\yen",!0);c(U,_,"Â¥","\\yen",!0);c(h,_,"âœ“","\\checkmark",!0);c(U,_,"âœ“","\\checkmark");c(h,_,"âœ—","\\ballotx",!0);c(U,_,"âœ—","\\ballotx");c(U,_,"â€¢","\\textbullet");c(h,_,"â„¶","\\beth",!0);c(h,_,"â„¸","\\daleth",!0);c(h,_,"â„·","\\gimel",!0);c(h,_,"Ï","\\digamma",!0);c(h,_,"Ï°","\\varkappa");c(h,dt,"âŒœ","\\ulcorner",!0);c(h,tt,"âŒ","\\urcorner",!0);c(h,dt,"âŒ","\\llcorner",!0);c(h,tt,"âŒŸ","\\lrcorner",!0);c(h,k,"â‰¦","\\leqq",!0);c(h,k,"â©½","\\leqslant",!0);c(h,k,"âª•","\\eqslantless",!0);c(h,k,"â‰²","\\lesssim",!0);c(h,k,"âª…","\\lessapprox",!0);c(h,k,"â‰Š","\\approxeq",!0);c(h,H,"â‹–","\\lessdot");c(h,k,"â‹˜","\\lll",!0);c(h,k,"â‰¶","\\lessgtr",!0);c(h,k,"â‹š","\\lesseqgtr",!0);c(h,k,"âª‹","\\lesseqqgtr",!0);c(h,k,"â‰‘","\\doteqdot");c(h,k,"â‰“","\\risingdotseq",!0);c(h,k,"â‰’","\\fallingdotseq",!0);c(h,k,"âˆ½","\\backsim",!0);c(h,k,"â‹","\\backsimeq",!0);c(h,k,"â«…","\\subseteqq",!0);c(h,k,"â‹","\\Subset",!0);c(h,k,"âŠ","\\sqsubset",!0);c(h,k,"â‰¼","\\preccurlyeq",!0);c(h,k,"â‹","\\curlyeqprec",!0);c(h,k,"â‰¾","\\precsim",!0);c(h,k,"âª·","\\precapprox",!0);c(h,k,"âŠ²","\\vartriangleleft");c(h,k,"âŠ´","\\trianglelefteq");c(h,k,"âŠ¨","\\vDash",!0);c(h,k,"âŠ«","\\VDash",!0);c(h,k,"âŠª","\\Vvdash",!0);c(h,k,"âŒ£","\\smallsmile");c(h,k,"âŒ¢","\\smallfrown");c(h,k,"â‰","\\bumpeq",!0);c(h,k,"â‰","\\Bumpeq",!0);c(h,k,"â‰§","\\geqq",!0);c(h,k,"â©¾","\\geqslant",!0);c(h,k,"âª–","\\eqslantgtr",!0);c(h,k,"â‰³","\\gtrsim",!0);c(h,k,"âª†","\\gtrapprox",!0);c(h,H,"â‹—","\\gtrdot");c(h,k,"â‹™","\\ggg",!0);c(h,k,"â‰·","\\gtrless",!0);c(h,k,"â‹›","\\gtreqless",!0);c(h,k,"âªŒ","\\gtreqqless",!0);c(h,k,"â‰–","\\eqcirc",!0);c(h,k,"â‰—","\\circeq",!0);c(h,k,"â‰œ","\\triangleq",!0);c(h,k,"âˆ¼","\\thicksim");c(h,k,"â‰ˆ","\\thickapprox");c(h,k,"â«†","\\supseteqq",!0);c(h,k,"â‹‘","\\Supset",!0);c(h,k,"âŠ","\\sqsupset",!0);c(h,k,"â‰½","\\succcurlyeq",!0);c(h,k,"â‹Ÿ","\\curlyeqsucc",!0);c(h,k,"â‰¿","\\succsim",!0);c(h,k,"âª¸","\\succapprox",!0);c(h,k,"âŠ³","\\vartriangleright");c(h,k,"âŠµ","\\trianglerighteq");c(h,k,"âŠ©","\\Vdash",!0);c(h,k,"âˆ£","\\shortmid");c(h,k,"âˆ¥","\\shortparallel");c(h,k,"â‰¬","\\between",!0);c(h,k,"â‹”","\\pitchfork",!0);c(h,k,"âˆ","\\varpropto");c(h,k,"â—€","\\blacktriangleleft");c(h,k,"âˆ´","\\therefore",!0);c(h,k,"âˆ","\\backepsilon");c(h,k,"â–¶","\\blacktriangleright");c(h,k,"âˆµ","\\because",!0);c(h,k,"â‹˜","\\llless");c(h,k,"â‹™","\\gggtr");c(h,H,"âŠ²","\\lhd");c(h,H,"âŠ³","\\rhd");c(h,k,"â‰‚","\\eqsim",!0);c(h,k,"â‰‘","\\Doteq",!0);c(h,k,"â¥½","\\strictif",!0);c(h,k,"â¥¼","\\strictfi",!0);c(h,H,"âˆ”","\\dotplus",!0);c(h,H,"âˆ–","\\smallsetminus");c(h,H,"â‹’","\\Cap",!0);c(h,H,"â‹“","\\Cup",!0);c(h,H,"â©","\\doublebarwedge",!0);c(h,H,"âŠŸ","\\boxminus",!0);c(h,H,"âŠ","\\boxplus",!0);c(h,H,"â§„","\\boxslash",!0);c(h,H,"â‹‡","\\divideontimes",!0);c(h,H,"â‹‰","\\ltimes",!0);c(h,H,"â‹Š","\\rtimes",!0);c(h,H,"â‹‹","\\leftthreetimes",!0);c(h,H,"â‹Œ","\\rightthreetimes",!0);c(h,H,"â‹","\\curlywedge",!0);c(h,H,"â‹","\\curlyvee",!0);c(h,H,"âŠ","\\circleddash",!0);c(h,H,"âŠ›","\\circledast",!0);c(h,H,"âŠº","\\intercal",!0);c(h,H,"â‹’","\\doublecap");c(h,H,"â‹“","\\doublecup");c(h,H,"âŠ ","\\boxtimes",!0);c(h,H,"â‹ˆ","\\bowtie",!0);c(h,H,"â‹ˆ","\\Join");c(h,H,"âŸ•","\\leftouterjoin",!0);c(h,H,"âŸ–","\\rightouterjoin",!0);c(h,H,"âŸ—","\\fullouterjoin",!0);c(h,H,"âˆ¸","\\dotminus",!0);c(h,H,"âŸ‘","\\wedgedot",!0);c(h,H,"âŸ‡","\\veedot",!0);c(h,H,"â©¢","\\doublebarvee",!0);c(h,H,"â©£","\\veedoublebar",!0);c(h,H,"â©Ÿ","\\wedgebar",!0);c(h,H,"â© ","\\wedgedoublebar",!0);c(h,H,"â©”","\\Vee",!0);c(h,H,"â©“","\\Wedge",!0);c(h,H,"â©ƒ","\\barcap",!0);c(h,H,"â©‚","\\barcup",!0);c(h,H,"â©ˆ","\\capbarcup",!0);c(h,H,"â©€","\\capdot",!0);c(h,H,"â©‡","\\capovercup",!0);c(h,H,"â©†","\\cupovercap",!0);c(h,H,"â©","\\closedvarcap",!0);c(h,H,"â©Œ","\\closedvarcup",!0);c(h,H,"â¨ª","\\minusdot",!0);c(h,H,"â¨«","\\minusfdots",!0);c(h,H,"â¨¬","\\minusrdots",!0);c(h,H,"âŠ»","\\Xor",!0);c(h,H,"âŠ¼","\\Nand",!0);c(h,H,"âŠ½","\\Nor",!0);c(h,H,"âŠ½","\\barvee");c(h,H,"â«´","\\interleave",!0);c(h,H,"â§¢","\\shuffle",!0);c(h,H,"â«¶","\\threedotcolon",!0);c(h,H,"â¦‚","\\typecolon",!0);c(h,H,"âˆ¾","\\invlazys",!0);c(h,H,"â©‹","\\twocaps",!0);c(h,H,"â©Š","\\twocups",!0);c(h,H,"â©","\\Sqcap",!0);c(h,H,"â©","\\Sqcup",!0);c(h,H,"â©–","\\veeonvee",!0);c(h,H,"â©•","\\wedgeonwedge",!0);c(h,H,"â§—","\\blackhourglass",!0);c(h,H,"â§†","\\boxast",!0);c(h,H,"â§ˆ","\\boxbox",!0);c(h,H,"â§‡","\\boxcircle",!0);c(h,H,"âŠœ","\\circledequal",!0);c(h,H,"â¦·","\\circledparallel",!0);c(h,H,"â¦¶","\\circledvert",!0);c(h,H,"â¦µ","\\circlehbar",!0);c(h,H,"âŸ¡","\\concavediamond",!0);c(h,H,"âŸ¢","\\concavediamondtickleft",!0);c(h,H,"âŸ£","\\concavediamondtickright",!0);c(h,H,"â‹„","\\diamond",!0);c(h,H,"â§–","\\hourglass",!0);c(h,H,"âŸ ","\\lozengeminus",!0);c(h,H,"âŒ½","\\obar",!0);c(h,H,"â¦¸","\\obslash",!0);c(h,H,"â¨¸","\\odiv",!0);c(h,H,"â§","\\ogreaterthan",!0);c(h,H,"â§€","\\olessthan",!0);c(h,H,"â¦¹","\\operp",!0);c(h,H,"â¨·","\\Otimes",!0);c(h,H,"â¨¶","\\otimeshat",!0);c(h,H,"â‹†","\\star",!0);c(h,H,"â–³","\\triangle",!0);c(h,H,"â¨º","\\triangleminus",!0);c(h,H,"â¨¹","\\triangleplus",!0);c(h,H,"â¨»","\\triangletimes",!0);c(h,H,"âŸ¤","\\whitesquaretickleft",!0);c(h,H,"âŸ¥","\\whitesquaretickright",!0);c(h,H,"â¨³","\\smashtimes",!0);c(h,k,"â‡¢","\\dashrightarrow",!0);c(h,k,"â‡ ","\\dashleftarrow",!0);c(h,k,"â‡‡","\\leftleftarrows",!0);c(h,k,"â‡†","\\leftrightarrows",!0);c(h,k,"â‡š","\\Lleftarrow",!0);c(h,k,"â†","\\twoheadleftarrow",!0);c(h,k,"â†¢","\\leftarrowtail",!0);c(h,k,"â†«","\\looparrowleft",!0);c(h,k,"â‡‹","\\leftrightharpoons",!0);c(h,k,"â†¶","\\curvearrowleft",!0);c(h,k,"â†º","\\circlearrowleft",!0);c(h,k,"â†°","\\Lsh",!0);c(h,k,"â‡ˆ","\\upuparrows",!0);c(h,k,"â†¿","\\upharpoonleft",!0);c(h,k,"â‡ƒ","\\downharpoonleft",!0);c(h,k,"âŠ¶","\\origof",!0);c(h,k,"âŠ·","\\imageof",!0);c(h,k,"âŠ¸","\\multimap",!0);c(h,k,"â†­","\\leftrightsquigarrow",!0);c(h,k,"â‡‰","\\rightrightarrows",!0);c(h,k,"â‡„","\\rightleftarrows",!0);c(h,k,"â† ","\\twoheadrightarrow",!0);c(h,k,"â†£","\\rightarrowtail",!0);c(h,k,"â†¬","\\looparrowright",!0);c(h,k,"â†·","\\curvearrowright",!0);c(h,k,"â†»","\\circlearrowright",!0);c(h,k,"â†±","\\Rsh",!0);c(h,k,"â‡Š","\\downdownarrows",!0);c(h,k,"â†¾","\\upharpoonright",!0);c(h,k,"â‡‚","\\downharpoonright",!0);c(h,k,"â‡","\\rightsquigarrow",!0);c(h,k,"â‡","\\leadsto");c(h,k,"â‡›","\\Rrightarrow",!0);c(h,k,"â†¾","\\restriction");c(h,_,"â€˜","`");c(h,_,"$","\\$");c(U,_,"$","\\$");c(U,_,"$","\\textdollar");c(h,_,"Â¢","\\cent");c(U,_,"Â¢","\\cent");c(h,_,"%","\\%");c(U,_,"%","\\%");c(h,_,"_","\\_");c(U,_,"_","\\_");c(U,_,"_","\\textunderscore");c(U,_,"â£","\\textvisiblespace",!0);c(h,_,"âˆ ","\\angle",!0);c(h,_,"âˆ","\\infty",!0);c(h,_,"â€²","\\prime");c(h,_,"â€³","\\dprime");c(h,_,"â€´","\\trprime");c(h,_,"â—","\\qprime");c(h,_,"â–³","\\triangle");c(U,_,"Î‘","\\Alpha",!0);c(U,_,"Î’","\\Beta",!0);c(U,_,"Î“","\\Gamma",!0);c(U,_,"Î”","\\Delta",!0);c(U,_,"Î•","\\Epsilon",!0);c(U,_,"Î–","\\Zeta",!0);c(U,_,"Î—","\\Eta",!0);c(U,_,"Î˜","\\Theta",!0);c(U,_,"Î™","\\Iota",!0);c(U,_,"Îš","\\Kappa",!0);c(U,_,"Î›","\\Lambda",!0);c(U,_,"Îœ","\\Mu",!0);c(U,_,"Î","\\Nu",!0);c(U,_,"Î","\\Xi",!0);c(U,_,"ÎŸ","\\Omicron",!0);c(U,_,"Î ","\\Pi",!0);c(U,_,"Î¡","\\Rho",!0);c(U,_,"Î£","\\Sigma",!0);c(U,_,"Î¤","\\Tau",!0);c(U,_,"Î¥","\\Upsilon",!0);c(U,_,"Î¦","\\Phi",!0);c(U,_,"Î§","\\Chi",!0);c(U,_,"Î¨","\\Psi",!0);c(U,_,"Î©","\\Omega",!0);c(h,le,"Î‘","\\Alpha",!0);c(h,le,"Î’","\\Beta",!0);c(h,le,"Î“","\\Gamma",!0);c(h,le,"Î”","\\Delta",!0);c(h,le,"Î•","\\Epsilon",!0);c(h,le,"Î–","\\Zeta",!0);c(h,le,"Î—","\\Eta",!0);c(h,le,"Î˜","\\Theta",!0);c(h,le,"Î™","\\Iota",!0);c(h,le,"Îš","\\Kappa",!0);c(h,le,"Î›","\\Lambda",!0);c(h,le,"Îœ","\\Mu",!0);c(h,le,"Î","\\Nu",!0);c(h,le,"Î","\\Xi",!0);c(h,le,"ÎŸ","\\Omicron",!0);c(h,le,"Î ","\\Pi",!0);c(h,le,"Î¡","\\Rho",!0);c(h,le,"Î£","\\Sigma",!0);c(h,le,"Î¤","\\Tau",!0);c(h,le,"Î¥","\\Upsilon",!0);c(h,le,"Î¦","\\Phi",!0);c(h,le,"Î§","\\Chi",!0);c(h,le,"Î¨","\\Psi",!0);c(h,le,"Î©","\\Omega",!0);c(h,dt,"Â¬","\\neg",!0);c(h,dt,"Â¬","\\lnot");c(h,_,"âŠ¤","\\top");c(h,_,"âŠ¥","\\bot");c(h,_,"âˆ…","\\emptyset");c(h,_,"âŒ€","\\varnothing");c(h,le,"Î±","\\alpha",!0);c(h,le,"Î²","\\beta",!0);c(h,le,"Î³","\\gamma",!0);c(h,le,"Î´","\\delta",!0);c(h,le,"Ïµ","\\epsilon",!0);c(h,le,"Î¶","\\zeta",!0);c(h,le,"Î·","\\eta",!0);c(h,le,"Î¸","\\theta",!0);c(h,le,"Î¹","\\iota",!0);c(h,le,"Îº","\\kappa",!0);c(h,le,"Î»","\\lambda",!0);c(h,le,"Î¼","\\mu",!0);c(h,le,"Î½","\\nu",!0);c(h,le,"Î¾","\\xi",!0);c(h,le,"Î¿","\\omicron",!0);c(h,le,"Ï€","\\pi",!0);c(h,le,"Ï","\\rho",!0);c(h,le,"Ïƒ","\\sigma",!0);c(h,le,"Ï„","\\tau",!0);c(h,le,"Ï…","\\upsilon",!0);c(h,le,"Ï•","\\phi",!0);c(h,le,"Ï‡","\\chi",!0);c(h,le,"Ïˆ","\\psi",!0);c(h,le,"Ï‰","\\omega",!0);c(h,le,"Îµ","\\varepsilon",!0);c(h,le,"Ï‘","\\vartheta",!0);c(h,le,"Ï–","\\varpi",!0);c(h,le,"Ï±","\\varrho",!0);c(h,le,"Ï‚","\\varsigma",!0);c(h,le,"Ï†","\\varphi",!0);c(h,le,"Ï˜","\\Coppa",!0);c(h,le,"Ï™","\\coppa",!0);c(h,le,"Ï™","\\varcoppa",!0);c(h,le,"Ï","\\Koppa",!0);c(h,le,"ÏŸ","\\koppa",!0);c(h,le,"Ï ","\\Sampi",!0);c(h,le,"Ï¡","\\sampi",!0);c(h,le,"Ïš","\\Stigma",!0);c(h,le,"Ï›","\\stigma",!0);c(h,le,"â««","\\Bot");c(h,_,"Ã°","\\eth",!0);c(U,_,"Ã°","Ã°");c(h,_,"Ã…","\\AA");c(U,_,"Ã…","\\AA",!0);c(h,_,"Ã†","\\AE",!0);c(U,_,"Ã†","\\AE",!0);c(h,_,"Ã","\\DH",!0);c(U,_,"Ã","\\DH",!0);c(h,_,"Ã","\\TH",!0);c(U,_,"Ã","\\TH",!0);c(h,_,"ÃŸ","\\ss",!0);c(U,_,"ÃŸ","\\ss",!0);c(h,_,"Ã¥","\\aa");c(U,_,"Ã¥","\\aa",!0);c(h,_,"Ã¦","\\ae",!0);c(U,_,"Ã¦","\\ae",!0);c(h,_,"Ã°","\\dh");c(U,_,"Ã°","\\dh",!0);c(h,_,"Ã¾","\\th",!0);c(U,_,"Ã¾","\\th",!0);c(h,_,"Ä","\\DJ",!0);c(U,_,"Ä","\\DJ",!0);c(h,_,"Ä‘","\\dj",!0);c(U,_,"Ä‘","\\dj",!0);c(h,_,"Å","\\L",!0);c(U,_,"Å","\\L",!0);c(h,_,"Å","\\l",!0);c(U,_,"Å","\\l",!0);c(h,_,"ÅŠ","\\NG",!0);c(U,_,"ÅŠ","\\NG",!0);c(h,_,"Å‹","\\ng",!0);c(U,_,"Å‹","\\ng",!0);c(h,_,"Å’","\\OE",!0);c(U,_,"Å’","\\OE",!0);c(h,_,"Å“","\\oe",!0);c(U,_,"Å“","\\oe",!0);c(h,H,"âˆ—","âˆ—",!0);c(h,H,"+","+");c(h,H,"âˆ—","*");c(h,H,"â„","/",!0);c(h,H,"â„","â„");c(h,H,"âˆ’","-",!0);c(h,H,"â‹…","\\cdot",!0);c(h,H,"âˆ˜","\\circ",!0);c(h,H,"Ã·","\\div",!0);c(h,H,"Â±","\\pm",!0);c(h,H,"Ã—","\\times",!0);c(h,H,"âˆ©","\\cap",!0);c(h,H,"âˆª","\\cup",!0);c(h,H,"âˆ–","\\setminus",!0);c(h,H,"âˆ§","\\land");c(h,H,"âˆ¨","\\lor");c(h,H,"âˆ§","\\wedge",!0);c(h,H,"âˆ¨","\\vee",!0);c(h,dt,"âŸ¦","\\llbracket",!0);c(h,tt,"âŸ§","\\rrbracket",!0);c(h,dt,"âŸ¨","\\langle",!0);c(h,dt,"âŸª","\\lAngle",!0);c(h,dt,"â¦‰","\\llangle",!0);c(h,dt,"|","\\lvert");c(h,dt,"â€–","\\lVert",!0);c(h,_,"!","\\oc");c(h,_,"?","\\wn");c(h,_,"â†“","\\shpos");c(h,_,"â†•","\\shift");c(h,_,"â†‘","\\shneg");c(h,tt,"?","?");c(h,tt,"!","!");c(h,tt,"â€¼","â€¼");c(h,tt,"âŸ©","\\rangle",!0);c(h,tt,"âŸ«","\\rAngle",!0);c(h,tt,"â¦Š","\\rrangle",!0);c(h,tt,"|","\\rvert");c(h,tt,"â€–","\\rVert");c(h,dt,"â¦ƒ","\\lBrace",!0);c(h,tt,"â¦„","\\rBrace",!0);c(h,k,"=","\\equal",!0);c(h,k,":",":");c(h,k,"â‰ˆ","\\approx",!0);c(h,k,"â‰…","\\cong",!0);c(h,k,"â‰¥","\\ge");c(h,k,"â‰¥","\\geq",!0);c(h,k,"â†","\\gets");c(h,k,">","\\gt",!0);c(h,k,"âˆˆ","\\in",!0);c(h,k,"âˆ‰","\\notin",!0);c(h,k,"î€ ","\\@not");c(h,k,"âŠ‚","\\subset",!0);c(h,k,"âŠƒ","\\supset",!0);c(h,k,"âŠ†","\\subseteq",!0);c(h,k,"âŠ‡","\\supseteq",!0);c(h,k,"âŠˆ","\\nsubseteq",!0);c(h,k,"âŠˆ","\\nsubseteqq");c(h,k,"âŠ‰","\\nsupseteq",!0);c(h,k,"âŠ‰","\\nsupseteqq");c(h,k,"âŠ¨","\\models");c(h,k,"â†","\\leftarrow",!0);c(h,k,"â‰¤","\\le");c(h,k,"â‰¤","\\leq",!0);c(h,k,"<","\\lt",!0);c(h,k,"â†’","\\rightarrow",!0);c(h,k,"â†’","\\to");c(h,k,"â‰±","\\ngeq",!0);c(h,k,"â‰±","\\ngeqq");c(h,k,"â‰±","\\ngeqslant");c(h,k,"â‰°","\\nleq",!0);c(h,k,"â‰°","\\nleqq");c(h,k,"â‰°","\\nleqslant");c(h,k,"â««","\\Perp",!0);c(h,pn,"Â ","\\ ");c(h,pn,"Â ","\\space");c(h,pn,"Â ","\\nobreakspace");c(U,pn,"Â ","\\ ");c(U,pn,"Â "," ");c(U,pn,"Â ","\\space");c(U,pn,"Â ","\\nobreakspace");c(h,pn,null,"\\nobreak");c(h,pn,null,"\\allowbreak");c(h,Wr,",",",");c(U,Wr,":",":");c(h,Wr,";",";");c(h,H,"âŠ¼","\\barwedge");c(h,H,"âŠ»","\\veebar");c(h,H,"âŠ™","\\odot",!0);c(h,H,"âŠ•ï¸","\\oplus");c(h,H,"âŠ—","\\otimes",!0);c(h,_,"âˆ‚","\\partial",!0);c(h,H,"âŠ˜","\\oslash",!0);c(h,H,"âŠš","\\circledcirc",!0);c(h,H,"âŠ¡","\\boxdot",!0);c(h,H,"â–³","\\bigtriangleup");c(h,H,"â–½","\\bigtriangledown");c(h,H,"â€ ","\\dagger");c(h,H,"â‹„","\\diamond");c(h,H,"â—ƒ","\\triangleleft");c(h,H,"â–¹","\\triangleright");c(h,dt,"{","\\{");c(U,_,"{","\\{");c(U,_,"{","\\textbraceleft");c(h,tt,"}","\\}");c(U,_,"}","\\}");c(U,_,"}","\\textbraceright");c(h,dt,"{","\\lbrace");c(h,tt,"}","\\rbrace");c(h,dt,"[","\\lbrack",!0);c(U,_,"[","\\lbrack",!0);c(h,tt,"]","\\rbrack",!0);c(U,_,"]","\\rbrack",!0);c(h,dt,"(","\\lparen",!0);c(h,tt,")","\\rparen",!0);c(h,dt,"â¦‡","\\llparenthesis",!0);c(h,tt,"â¦ˆ","\\rrparenthesis",!0);c(U,_,"<","\\textless",!0);c(U,_,">","\\textgreater",!0);c(h,dt,"âŒŠ","\\lfloor",!0);c(h,tt,"âŒ‹","\\rfloor",!0);c(h,dt,"âŒˆ","\\lceil",!0);c(h,tt,"âŒ‰","\\rceil",!0);c(h,_,"\\","\\backslash");c(h,_,"|","|");c(h,_,"|","\\vert");c(U,_,"|","\\textbar",!0);c(h,_,"â€–","\\|");c(h,_,"â€–","\\Vert");c(U,_,"â€–","\\textbardbl");c(U,_,"~","\\textasciitilde");c(U,_,"\\","\\textbackslash");c(U,_,"^","\\textasciicircum");c(h,k,"â†‘","\\uparrow",!0);c(h,k,"â‡‘","\\Uparrow",!0);c(h,k,"â†“","\\downarrow",!0);c(h,k,"â‡“","\\Downarrow",!0);c(h,k,"â†•","\\updownarrow",!0);c(h,k,"â‡•","\\Updownarrow",!0);c(h,Ie,"âˆ","\\coprod");c(h,Ie,"â‹","\\bigvee");c(h,Ie,"â‹€","\\bigwedge");c(h,Ie,"â¨„","\\biguplus");c(h,Ie,"â¨„","\\bigcupplus");c(h,Ie,"â¨ƒ","\\bigcupdot");c(h,Ie,"â¨‡","\\bigdoublevee");c(h,Ie,"â¨ˆ","\\bigdoublewedge");c(h,Ie,"â‹‚","\\bigcap");c(h,Ie,"â‹ƒ","\\bigcup");c(h,Ie,"âˆ«","\\int");c(h,Ie,"âˆ«","\\intop");c(h,Ie,"âˆ¬","\\iint");c(h,Ie,"âˆ­","\\iiint");c(h,Ie,"âˆ","\\prod");c(h,Ie,"âˆ‘","\\sum");c(h,Ie,"â¨‚","\\bigotimes");c(h,Ie,"â¨","\\bigoplus");c(h,Ie,"â¨€","\\bigodot");c(h,Ie,"â¨‰","\\bigtimes");c(h,Ie,"âˆ®","\\oint");c(h,Ie,"âˆ¯","\\oiint");c(h,Ie,"âˆ°","\\oiiint");c(h,Ie,"âˆ±","\\intclockwise");c(h,Ie,"âˆ²","\\varointclockwise");c(h,Ie,"â¨Œ","\\iiiint");c(h,Ie,"â¨","\\intbar");c(h,Ie,"â¨","\\intBar");c(h,Ie,"â¨","\\fint");c(h,Ie,"â¨’","\\rppolint");c(h,Ie,"â¨“","\\scpolint");c(h,Ie,"â¨•","\\pointint");c(h,Ie,"â¨–","\\sqint");c(h,Ie,"â¨—","\\intlarhk");c(h,Ie,"â¨˜","\\intx");c(h,Ie,"â¨™","\\intcap");c(h,Ie,"â¨š","\\intcup");c(h,Ie,"â¨…","\\bigsqcap");c(h,Ie,"â¨†","\\bigsqcup");c(h,Ie,"âˆ«","\\smallint");c(U,Fn,"â€¦","\\textellipsis");c(h,Fn,"â€¦","\\mathellipsis");c(U,Fn,"â€¦","\\ldots",!0);c(h,Fn,"â€¦","\\ldots",!0);c(h,Fn,"â‹°","\\iddots",!0);c(h,Fn,"â‹¯","\\@cdots",!0);c(h,Fn,"â‹±","\\ddots",!0);c(h,_,"â‹®","\\varvdots");c(U,_,"â‹®","\\varvdots");c(h,Fe,"Â´","\\acute");c(h,Fe,"`","\\grave");c(h,Fe,"Â¨","\\ddot");c(h,Fe,"â€¦","\\dddot");c(h,Fe,"â€¦.","\\ddddot");c(h,Fe,"~","\\tilde");c(h,Fe,"â€¾","\\bar");c(h,Fe,"Ë˜","\\breve");c(h,Fe,"Ë‡","\\check");c(h,Fe,"^","\\hat");c(h,Fe,"â†’","\\vec");c(h,Fe,"Ë™","\\dot");c(h,Fe,"Ëš","\\mathring");c(h,le,"Ä±","\\imath",!0);c(h,le,"È·","\\jmath",!0);c(h,_,"Ä±","Ä±");c(h,_,"È·","È·");c(U,_,"Ä±","\\i",!0);c(U,_,"È·","\\j",!0);c(U,_,"Ã¸","\\o",!0);c(h,le,"Ã¸","\\o",!0);c(U,_,"Ã˜","\\O",!0);c(h,le,"Ã˜","\\O",!0);c(U,Fe,"ËŠ","\\'");c(U,Fe,"Ë‹","\\`");c(U,Fe,"Ë†","\\^");c(U,Fe,"~","\\~");c(U,Fe,"Ë‰","\\=");c(U,Fe,"Ë˜","\\u");c(U,Fe,"Ë™","\\.");c(U,Fe,"Â¸","\\c");c(U,Fe,"Ëš","\\r");c(U,Fe,"Ë‡","\\v");c(U,Fe,"Â¨",'\\"');c(U,Fe,"Ë","\\H");c(h,Fe,"ËŠ","\\'");c(h,Fe,"Ë‹","\\`");c(h,Fe,"Ë†","\\^");c(h,Fe,"~","\\~");c(h,Fe,"Ë‰","\\=");c(h,Fe,"Ë˜","\\u");c(h,Fe,"Ë™","\\.");c(h,Fe,"Â¸","\\c");c(h,Fe,"Ëš","\\r");c(h,Fe,"Ë‡","\\v");c(h,Fe,"Â¨",'\\"');c(h,Fe,"Ë","\\H");const vu={"--":!0,"---":!0,"``":!0,"''":!0};c(U,_,"â€“","--",!0);c(U,_,"â€“","\\textendash");c(U,_,"â€”","---",!0);c(U,_,"â€”","\\textemdash");c(U,_,"â€˜","`",!0);c(U,_,"â€˜","\\textquoteleft");c(U,_,"â€™","'",!0);c(U,_,"â€™","\\textquoteright");c(U,_,"â€œ","``",!0);c(U,_,"â€œ","\\textquotedblleft");c(U,_,"â€","''",!0);c(U,_,"â€","\\textquotedblright");c(h,_,"Â°","\\degree",!0);c(U,_,"Â°","\\degree");c(U,_,"Â°","\\textdegree",!0);c(h,_,"Â£","\\pounds");c(h,_,"Â£","\\mathsterling",!0);c(U,_,"Â£","\\pounds");c(U,_,"Â£","\\textsterling",!0);c(h,_,"âœ ","\\maltese");c(U,_,"âœ ","\\maltese");c(h,_,"â‚¬","\\euro",!0);c(U,_,"â‚¬","\\euro",!0);c(U,_,"â‚¬","\\texteuro");c(h,_,"Â©","\\copyright",!0);c(U,_,"Â©","\\textcopyright");c(h,_,"âŒ€","\\diameter",!0);c(U,_,"âŒ€","\\diameter");c(h,_,"ğ›¤","\\varGamma");c(h,_,"ğ›¥","\\varDelta");c(h,_,"ğ›©","\\varTheta");c(h,_,"ğ›¬","\\varLambda");c(h,_,"ğ›¯","\\varXi");c(h,_,"ğ›±","\\varPi");c(h,_,"ğ›´","\\varSigma");c(h,_,"ğ›¶","\\varUpsilon");c(h,_,"ğ›·","\\varPhi");c(h,_,"ğ›¹","\\varPsi");c(h,_,"ğ›º","\\varOmega");c(U,_,"ğ›¤","\\varGamma");c(U,_,"ğ›¥","\\varDelta");c(U,_,"ğ›©","\\varTheta");c(U,_,"ğ›¬","\\varLambda");c(U,_,"ğ›¯","\\varXi");c(U,_,"ğ›±","\\varPi");c(U,_,"ğ›´","\\varSigma");c(U,_,"ğ›¶","\\varUpsilon");c(U,_,"ğ›·","\\varPhi");c(U,_,"ğ›¹","\\varPsi");c(U,_,"ğ›º","\\varOmega");const sa='0123456789/@."';for(let n=0;n<sa.length;n++){const e=sa.charAt(n);c(h,_,e,e)}const aa='0123456789!@*()-=+";:?/.,';for(let n=0;n<aa.length;n++){const e=aa.charAt(n);c(U,_,e,e)}const Do="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(let n=0;n<Do.length;n++){const e=Do.charAt(n);c(h,le,e,e),c(U,_,e,e)}const la="Ã‡ÃÃÃ§Ã¾â„‚â„â„•â„™â„šâ„â„¤â„â„â„Šâ„‹â„Œâ„â„‘â„’â„“â„˜â„›â„œâ„¬â„°â„±â„³â„­â„¨";for(let n=0;n<la.length;n++){const e=la.charAt(n);c(h,le,e,e),c(U,_,e,e)}let fe="";for(let n=0;n<Do.length;n++){fe=String.fromCharCode(55349,56320+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56372+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56424+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56580+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56736+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56788+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56840+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56944+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,56632+n),c(h,le,fe,fe),c(U,_,fe,fe);const e=Do.charAt(n);fe=String.fromCharCode(55349,56476+n),c(h,le,e,fe),c(U,_,e,fe)}for(let n=0;n<10;n++)fe=String.fromCharCode(55349,57294+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,57314+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,57324+n),c(h,le,fe,fe),c(U,_,fe,fe),fe=String.fromCharCode(55349,57334+n),c(h,le,fe,fe),c(U,_,fe,fe);const yu="([{âŒŠâŒˆâŸ¨âŸ®â°âŸ¦â¦ƒ",wu=")]}âŒ‹âŒ‰âŸ©âŸ¯â±âŸ¦â¦„";function xu(n,e,t){const r=[];let o=[],i=[],s=0,a=0,l=0;for(;a<n.length;){for(;n[a]instanceof Ns;)n.splice(a,1,...n[a].children);const d=n[a];if(d.attributes&&d.attributes.linebreak&&d.attributes.linebreak==="newline"){i.length>0&&o.push(new P("mrow",i)),o.push(d),i=[];const u=new P("mtd",o);u.style.textAlign="left",r.push(new P("mtr",[u])),o=[],a+=1;continue}if(i.push(d),d.type&&d.type==="mo"&&d.children.length===1&&!Object.prototype.hasOwnProperty.call(d.attributes,"movablelimits")){const u=d.children[0].text;if(yu.indexOf(u)>-1)l+=1;else if(wu.indexOf(u)>-1)l-=1;else if(l===0&&e==="="&&u==="="){if(s+=1,s>1){i.pop();const m=new P("mrow",i);o.push(m),i=[d]}}else if(l===0&&e==="tex"&&u!=="âˆ‡"){const m=a<n.length-1?n[a+1]:null;let p=!0;if(!(m&&m.type==="mtext"&&m.attributes.linebreak&&m.attributes.linebreak==="nobreak"))for(let f=a+1;f<n.length;f++){const g=n[f];if(g.type&&g.type==="mspace"&&!(g.attributes.linebreak&&g.attributes.linebreak==="newline"))i.push(g),a+=1,g.attributes&&g.attributes.linebreak&&g.attributes.linebreak==="nobreak"&&(p=!1);else break}if(p){const f=new P("mrow",i);o.push(f),i=[]}}}a+=1}if(i.length>0){const d=new P("mrow",i);o.push(d)}if(r.length>0){const d=new P("mtd",o);d.style.textAlign="left";const u=new P("mtr",[d]);r.push(u);const m=new P("mtable",r);return t||(m.setAttribute("columnalign","left"),m.setAttribute("rowspacing","0em")),m}return Ln(o)}const $t=function(n,e,t){return ct[e][n]&&ct[e][n].replace&&n.charCodeAt(0)!==55349&&!(Object.prototype.hasOwnProperty.call(vu,n)&&t&&(t.fontFamily&&t.fontFamily.slice(4,6)==="tt"||t.font&&t.font.slice(4,6)==="tt"))&&(n=ct[e][n].replace),new ft(n)},ca=(n,e)=>{if(n.children.length===0||n.children[n.children.length-1].type!=="mtext"){const t=new P("mtext",[new ft(e.children[0].text)]);n.children.push(t)}else n.children[n.children.length-1].children[0].text+=e.children[0].text},qo=n=>{if(n.type!=="mrow"&&n.type!=="mstyle"||n.children.length===0)return n;const e=new P("mrow");for(let t=0;t<n.children.length;t++){const r=n.children[t];if(r.type==="mtext"&&Object.keys(r.attributes).length===0)ca(e,r);else if(r.type==="mrow"){let o=!0;for(let i=0;i<r.children.length;i++)if(r.children[i].type!=="mtext"||Object.keys(r.attributes).length!==0){o=!1;break}if(o)for(let i=0;i<r.children.length;i++){const s=r.children[i];ca(e,s)}else e.children.push(r)}else e.children.push(r)}for(let t=0;t<e.children.length;t++)if(e.children[t].type==="mtext"){const r=e.children[t];r.children[0].text.charAt(0)===" "&&(r.children[0].text="Â "+r.children[0].text.slice(1));const o=r.children[0].text.length;o>0&&r.children[0].text.charAt(o-1)===" "&&(r.children[0].text=r.children[0].text.slice(0,-1)+"Â ");for(const[i,s]of Object.entries(n.attributes))r.attributes[i]=s}return e.children.length===1&&e.children[0].type==="mtext"?e.children[0]:e},zo=function(n,e=!1){if(n.length===1&&!(n[0]instanceof Ns))return n[0];if(!e){n[0]instanceof P&&n[0].type==="mo"&&!n[0].attributes.fence&&(n[0].attributes.lspace="0em",n[0].attributes.rspace="0em");const t=n.length-1;n[t]instanceof P&&n[t].type==="mo"&&!n[t].attributes.fence&&(n[t].attributes.lspace="0em",n[t].attributes.rspace="0em")}return new P("mrow",n)};function Jo(n){if(!n)return!1;if(n.type==="mi"&&n.children.length===1){const e=n.children[0];return e instanceof ft&&e.text==="."}else if(n.type==="mtext"&&n.children.length===1){const e=n.children[0];return e instanceof ft&&e.text==="â€ˆ"}else if(n.type==="mo"&&n.children.length===1&&n.getAttribute("separator")==="true"&&n.getAttribute("lspace")==="0em"&&n.getAttribute("rspace")==="0em"){const e=n.children[0];return e instanceof ft&&e.text===","}else return!1}const Su=(n,e)=>{const t=n[e],r=n[e+1];return t.type==="atom"&&t.text===","&&t.loc&&r.loc&&t.loc.end===r.loc.start},Qr=n=>n.type==="atom"&&n.family==="rel"||n.type==="mclass"&&n.mclass==="mrel",kt=function(n,e,t=!1){if(!t&&n.length===1){const s=qe(n[0],e);return s instanceof P&&s.type==="mo"&&(s.setAttribute("lspace","0em"),s.setAttribute("rspace","0em")),[s]}const r=[],o=[];let i;for(let s=0;s<n.length;s++)o.push(qe(n[s],e));for(let s=0;s<o.length;s++){const a=o[s];if(s<n.length-1&&Qr(n[s])&&Qr(n[s+1])&&a.setAttribute("rspace","0em"),s>0&&Qr(n[s])&&Qr(n[s-1])&&a.setAttribute("lspace","0em"),a.type==="mn"&&i&&i.type==="mn"){i.children.push(...a.children);continue}else if(Jo(a)&&i&&i.type==="mn"){i.children.push(...a.children);continue}else if(i&&i.type==="mn"&&s<o.length-1&&o[s+1].type==="mn"&&Su(n,s)){i.children.push(...a.children);continue}else if(a.type==="mn"&&Jo(i))a.children=[...i.children,...a.children],r.pop();else if((a.type==="msup"||a.type==="msub")&&a.children.length>=1&&i&&(i.type==="mn"||Jo(i))){const l=a.children[0];l instanceof P&&l.type==="mn"&&i&&(l.children=[...i.children,...l.children],r.pop())}r.push(a),i=a}return r},Tn=function(n,e,t=!1){return zo(kt(n,e,t),t)},qe=function(n,e){if(!n)return new P("mrow");if(Lo[n.type])return Lo[n.type](n,e);throw new Q("Got group of unknown type: '"+n.type+"'")},da=n=>new P("mtd",[],[],{padding:"0",width:"50%"}),Eu=["mrow","mtd","mtable","mtr"],zi=n=>{for(const e of n.children)if(e.type&&Eu.includes(e.type)){if(e.classes&&e.classes[0]==="tml-label")return e.label;{const t=zi(e);if(t)return t}}else if(!e.type){const t=zi(e);if(t)return t}},Cu=(n,e,t,r)=>{e=Tn(e[0].body,t),e=qo(e),e.classes.push("tml-tag");const o=zi(n);n=new P("mtd",[n]);const i=[da(),n,da()];i[r?0:2].children.push(e);const s=new P("mtr",i,["tml-tageqn"]);o&&s.setAttribute("id",o);const a=new P("mtable",[s]);return a.style.width="100%",a.setAttribute("displaystyle","true"),a};function Tu(n,e,t,r){let o=null;n.length===1&&n[0].type==="tag"&&(o=n[0].tag,n=n[0].body);const i=kt(n,t);if(i.length===1&&i[0]instanceof cc)return i[0];const s=r.displayMode||r.annotate?"none":r.wrap,a=i.length===0?null:i[0];let l=i.length===1&&o===null&&a instanceof P?i[0]:xu(i,s,r.displayMode);if(o&&(l=Cu(l,o,t,r.leqno)),r.annotate){const u=new P("annotation",[new ft(e)]);u.setAttribute("encoding","application/x-tex"),l=new P("semantics",[l,u])}const d=new P("math",[l]);return r.xml&&d.setAttribute("xmlns","http://www.w3.org/1998/Math/MathML"),r.displayMode&&(d.setAttribute("display","block"),d.style.display="block math",d.classes=["tml-display"]),d}const _u="DHKLUcegorsuvxyzÎ Î¥Î¨Î±Î´Î·Î¹Î¼Î½Î¿Ï„Ï…Ï‡Ïµ",ku="BCEGIMNOPQRSTXZlpqtwÎ“Î˜ÎÎ£Î¦Î©Î²ÎµÎ¶Î¸Î¾ÏÏ‚Ï†ÏˆÏ‘Ï•Ï±",Au="AFJdfÎ”Î›",uc=(n,e)=>{const t=n.isStretchy?dc(n):new P("mo",[$t(n.label,n.mode)]);n.isStretchy||t.setAttribute("stretchy","false"),n.label!=="\\vec"&&(t.style.mathDepth="0");const r=n.label==="\\c"?"munder":"mover",o=Lu.has(n.label);if(r==="mover"&&n.mode==="math"&&!n.isStretchy&&n.base.text&&n.base.text.length===1){const s=n.base.text,a=n.label==="\\vec",l=a==="\\vec"?"-vec":"";a&&t.classes.push("tml-vec");const d=a?"-vec":o?"-acc":"";_u.indexOf(s)>-1?(t.classes.push(`chr-sml${l}`),t.classes.push(`wbk-sml${d}`)):ku.indexOf(s)>-1?(t.classes.push(`chr-med${l}`),t.classes.push(`wbk-med${d}`)):Au.indexOf(s)>-1?(t.classes.push(`chr-lrg${l}`),t.classes.push(`wbk-lrg${d}`)):a?t.classes.push("wbk-vec"):o&&t.classes.push("wbk-acc")}else o&&t.classes.push("wbk-acc");return new P(r,[qe(n.base,e),t])},Iu=new Set(["\\acute","\\check","\\grave","\\ddot","\\dddot","\\ddddot","\\tilde","\\bar","\\breve","\\check","\\hat","\\vec","\\dot","\\mathring"]),Lu=new Set(["\\acute","\\bar","\\breve","\\check","\\dot","\\ddot","\\grave","\\hat","\\mathring","\\`","\\'","\\^","\\=","\\u","\\.",'\\"',"\\r","\\H","\\v"]),ua={"\\`":"Ì€","\\'":"Ì","\\^":"Ì‚","\\~":"Ìƒ","\\=":"Ì„","\\u":"Ì†","\\.":"Ì‡",'\\"':"Ìˆ","\\r":"ÌŠ","\\H":"Ì‹","\\v":"ÌŒ","\\c":"Ì§"};ue({type:"accent",names:["\\acute","\\grave","\\ddot","\\dddot","\\ddddot","\\tilde","\\bar","\\breve","\\check","\\hat","\\vec","\\dot","\\mathring","\\overparen","\\widecheck","\\widehat","\\wideparen","\\widetilde","\\overrightarrow","\\overleftarrow","\\Overrightarrow","\\overleftrightarrow","\\overgroup","\\overleftharpoon","\\overrightharpoon"],props:{numArgs:1},handler:(n,e)=>{const t=$r(e[0]),r=!Iu.has(n.funcName);return{type:"accent",mode:n.parser.mode,label:n.funcName,isStretchy:r,base:t}},mathmlBuilder:uc});ue({type:"accent",names:["\\'","\\`","\\^","\\~","\\=","\\c","\\u","\\.",'\\"',"\\r","\\H","\\v"],props:{numArgs:1,allowedInText:!0,allowedInMath:!0,argTypes:["primitive"]},handler:(n,e)=>{const t=$r(e[0]),r=n.parser.mode;return r==="math"&&n.parser.settings.strict&&console.log(`Temml parse error: Command ${n.funcName} is invalid in math mode.`),r==="text"&&t.text&&t.text.length===1&&n.funcName in ua&&sc.indexOf(t.text)>-1?{type:"textord",mode:"text",text:t.text+ua[n.funcName]}:n.funcName==="\\c"&&r==="text"&&t.text&&t.text.length===1?{type:"textord",mode:"text",text:t.text+"Ì§"}:{type:"accent",mode:r,label:n.funcName,isStretchy:!1,base:t}},mathmlBuilder:uc});ue({type:"accentUnder",names:["\\underleftarrow","\\underrightarrow","\\underleftrightarrow","\\undergroup","\\underparen","\\utilde"],props:{numArgs:1},handler:({parser:n,funcName:e},t)=>{const r=t[0];return{type:"accentUnder",mode:n.mode,label:e,base:r}},mathmlBuilder:(n,e)=>{const t=dc(n);return t.style["math-depth"]=0,new P("munder",[qe(n.base,e),t])}});const ha={pt:800/803,pc:12*800/803,dd:1238/1157*800/803,cc:14856/1157*800/803,nd:685/642*800/803,nc:1370/107*800/803,sp:1/65536*800/803,mm:25.4/72,cm:2.54/72,in:1/72,px:96/72},Du=["em","ex","mu","pt","mm","cm","in","px","bp","pc","dd","cc","nd","nc","sp"],hc=function(n){return typeof n!="string"&&(n=n.unit),Du.indexOf(n)>-1},mc=n=>{const e=Math.max(n-1,0);return[1,.7,.5][e]},an=function(n,e){let t=n.number;if(e.maxSize[0]<0&&t>0)return{number:0,unit:"em"};const r=n.unit;switch(r){case"mm":case"cm":case"in":case"px":return t*ha[r]>e.maxSize[1]?{number:e.maxSize[1],unit:"pt"}:{number:t,unit:r};case"em":case"ex":return r==="ex"&&(t*=.431),t=Math.min(t/mc(e.level),e.maxSize[0]),{number:Xo(t),unit:"em"};case"bp":return t>e.maxSize[1]&&(t=e.maxSize[1]),{number:t,unit:"pt"};case"pt":case"pc":case"dd":case"cc":case"nd":case"nc":case"sp":return t=Math.min(t*ha[r],e.maxSize[1]),{number:Xo(t),unit:"pt"};case"mu":return t=Math.min(t/18,e.maxSize[0]),{number:Xo(t),unit:"em"};default:throw new Q("Invalid unit: '"+r+"'")}},at=n=>{const e=new P("mspace");return e.setAttribute("width",n+"em"),e},eo=(n,e=.3,t=0,r=!1)=>{if(n==null&&t===0)return at(e);const o=n?[n]:[];if(e!==0&&o.unshift(at(e)),t>0&&o.push(at(t)),r){const i=new P("mpadded",o);return i.setAttribute("height","0.1px"),i}else return new P("mrow",o)},Qo=(n,e)=>Number(n)/mc(e),Ui=(n,e,t,r)=>{const o=Os(n),i=n.slice(1,3)==="eq",s=n.charAt(1)==="x"?"1.75":n.slice(2,4)==="cd"?"3.0":i?"1.0":"2.0";o.setAttribute("lspace","0"),o.setAttribute("rspace",i?"0.5em":"0");const a=r.withLevel(r.level<2?2:3),l=Qo(s,a.level),d=Qo(s,3),u=eo(null,l.toFixed(4),0),m=eo(null,d.toFixed(4),0),p=Qo(i?0:.3,a.level).toFixed(4);let f,g;const b=e&&e.body&&(e.body.body||e.body.length>0);if(b){let S=qe(e,a);S=eo(S,p,p,n==="\\\\cdrightarrow"||n==="\\\\cdleftarrow"),f=new P("mover",[S,m])}const w=t&&t.body&&(t.body.body||t.body.length>0);if(w){let S=qe(t,a);S=eo(S,p,p),g=new P("munder",[S,m])}let v;return!b&&!w?v=new P("mover",[o,u]):b&&w?v=new P("munderover",[o,g,f]):b?v=new P("mover",[o,f]):v=new P("munder",[o,g]),s==="3.0"&&(v.style.height="1em"),v.setAttribute("accent","false"),v};ue({type:"xArrow",names:["\\xleftarrow","\\xrightarrow","\\xLeftarrow","\\xRightarrow","\\xleftrightarrow","\\xLeftrightarrow","\\xhookleftarrow","\\xhookrightarrow","\\xmapsto","\\xrightharpoondown","\\xrightharpoonup","\\xleftharpoondown","\\xleftharpoonup","\\xlongequal","\\xtwoheadrightarrow","\\xtwoheadleftarrow","\\xtofrom","\\xleftrightharpoons","\\xrightleftharpoons","\\yields","\\yieldsLeft","\\mesomerism","\\longrightharpoonup","\\longleftharpoondown","\\yieldsLeftRight","\\chemequilibrium","\\\\cdrightarrow","\\\\cdleftarrow","\\\\cdlongequal"],props:{numArgs:1,numOptionalArgs:1},handler({parser:n,funcName:e},t,r){return{type:"xArrow",mode:n.mode,name:e,body:t[0],below:r[0]}},mathmlBuilder(n,e){const r=[Ui(n.name,n.body,n.below,e)];return r.unshift(at(.2778)),r.push(at(.2778)),new P("mrow",r)}});const ma={"\\equilibriumRight":["\\longrightharpoonup","\\eqleftharpoondown"],"\\equilibriumLeft":["\\eqrightharpoonup","\\longleftharpoondown"]};ue({type:"stackedArrow",names:["\\equilibriumRight","\\equilibriumLeft"],props:{numArgs:1,numOptionalArgs:1},handler({parser:n,funcName:e},t,r){const o=t[0]?{type:"hphantom",mode:n.mode,body:t[0]}:null,i=r[0]?{type:"hphantom",mode:n.mode,body:r[0]}:null;return{type:"stackedArrow",mode:n.mode,name:e,body:t[0],upperArrowBelow:i,lowerArrowBody:o,below:r[0]}},mathmlBuilder(n,e){const t=ma[n.name][0],r=ma[n.name][1],o=Ui(t,n.body,n.upperArrowBelow,e),i=Ui(r,n.lowerArrowBody,n.below,e);let s;const a=new P("mpadded",[o]);if(a.setAttribute("voffset","0.3em"),a.setAttribute("height","+0.3em"),a.setAttribute("depth","-0.3em"),n.name==="\\equilibriumLeft"){const l=new P("mpadded",[i]);l.setAttribute("width","0.5em"),s=new P("mpadded",[at(.2778),l,a,at(.2778)])}else a.setAttribute("width",n.name==="\\equilibriumRight"?"0.5em":"0"),s=new P("mpadded",[at(.2778),a,i,at(.2778)]);return s.setAttribute("voffset","-0.18em"),s.setAttribute("height","-0.18em"),s.setAttribute("depth","+0.18em"),s}});const pc={};function Wt({type:n,names:e,props:t,handler:r,mathmlBuilder:o}){const i={type:n,numArgs:t.numArgs||0,allowedInText:!1,numOptionalArgs:0,handler:r};for(let s=0;s<e.length;++s)pc[e[s]]=i;o&&(Lo[n]=o)}function _e(n,e){if(!n||n.type!==e)throw new Error(`Expected node of type ${e}, but got `+(n?`node of type ${n.type}`:String(n)));return n}function Rs(n){const e=Uo(n);if(!e)throw new Error("Expected node of symbol group type, but got "+(n?`node of type ${n.type}`:String(n)));return e}function Uo(n){return n&&(n.type==="atom"||Object.prototype.hasOwnProperty.call(bu,n.type))?n:null}const Mu={">":"\\\\cdrightarrow","<":"\\\\cdleftarrow","=":"\\\\cdlongequal",A:"\\uparrow",V:"\\downarrow","|":"\\Vert",".":"no arrow"},pa=()=>({type:"styling",body:[],mode:"math",scriptLevel:"display"}),fa=n=>n.type==="textord"&&n.text==="@",Nu=(n,e)=>(n.type==="mathord"||n.type==="atom")&&n.text===e;function Fu(n,e,t){const r=Mu[n];switch(r){case"\\\\cdrightarrow":case"\\\\cdleftarrow":return t.callFunction(r,[e[0]],[e[1]]);case"\\uparrow":case"\\downarrow":{const o=t.callFunction("\\\\cdleft",[e[0]],[]),i={type:"atom",text:r,mode:"math",family:"rel"},s=t.callFunction("\\Big",[i],[]),a=t.callFunction("\\\\cdright",[e[1]],[]),l={type:"ordgroup",mode:"math",body:[o,s,a],semisimple:!0};return t.callFunction("\\\\cdparent",[l],[])}case"\\\\cdlongequal":return t.callFunction("\\\\cdlongequal",[],[]);case"\\Vert":{const o={type:"textord",text:"\\Vert",mode:"math"};return t.callFunction("\\Big",[o],[])}default:return{type:"textord",text:" ",mode:"math"}}}function Ou(n){const e=[];for(n.gullet.beginGroup(),n.gullet.macros.set("\\cr","\\\\\\relax"),n.gullet.beginGroup();;){e.push(n.parseExpression(!1,"\\\\")),n.gullet.endGroup(),n.gullet.beginGroup();const o=n.fetch().text;if(o==="&"||o==="\\\\")n.consume();else if(o==="\\end"){e[e.length-1].length===0&&e.pop();break}else throw new Q("Expected \\\\ or \\cr or \\end",n.nextToken)}let t=[];const r=[t];for(let o=0;o<e.length;o++){const i=e[o];let s=pa();for(let a=0;a<i.length;a++)if(!fa(i[a]))s.body.push(i[a]);else{t.push(s),a+=1;const l=Rs(i[a]).text,d=new Array(2);if(d[0]={type:"ordgroup",mode:"math",body:[]},d[1]={type:"ordgroup",mode:"math",body:[]},!("=|.".indexOf(l)>-1))if("<>AV".indexOf(l)>-1)for(let m=0;m<2;m++){let p=!0;for(let f=a+1;f<i.length;f++){if(Nu(i[f],l)){p=!1,a=f;break}if(fa(i[f]))throw new Q("Missing a "+l+" character to complete a CD arrow.",i[f]);d[m].body.push(i[f])}if(p)throw new Q("Missing a "+l+" character to complete a CD arrow.",i[a])}else throw new Q('Expected one of "<>AV=|." after @.');const u=Fu(l,d,n);t.push(u),s=pa()}o%2===0?t.push(s):t.shift(),t=[],r.push(t)}return r.pop(),n.gullet.endGroup(),n.gullet.endGroup(),{type:"array",mode:"math",body:r,tags:null,labels:new Array(r.length+1).fill(""),envClasses:["jot","cd"],cols:[],hLinesBeforeRow:new Array(r.length+1).fill([])}}ue({type:"cdlabel",names:["\\\\cdleft","\\\\cdright"],props:{numArgs:1},handler({parser:n,funcName:e},t){return{type:"cdlabel",mode:n.mode,side:e.slice(4),label:t[0]}},mathmlBuilder(n,e){if(n.label.body.length===0)return new P("mrow",e);const t=qe(n.label,e);n.side==="left"&&t.classes.push("tml-shift-left");const r=new P("mtd",[t]);r.style.padding="0";const o=new P("mtr",[r]),i=new P("mtable",[o]),s=new P("mpadded",[i]);return s.setAttribute("width","0.1px"),s.setAttribute("displaystyle","false"),s.setAttribute("scriptlevel","1"),s}});ue({type:"cdlabelparent",names:["\\\\cdparent"],props:{numArgs:1},handler({parser:n},e){return{type:"cdlabelparent",mode:n.mode,fragment:e[0]}},mathmlBuilder(n,e){return new P("mrow",[qe(n.fragment,e)])}});const fc=n=>({type:"ordgroup",mode:"math",body:n,semisimple:!0}),ei=(n,e)=>({type:e,mode:"math",body:fc(n)}),Ru=(n,e)=>{const t=n.body;t[0].shift();const r=new Array(t.length-1).fill().map(()=>[]);for(let m=1;m<t.length;m++){r[m-1].push(t[m].shift());const p=[];for(let f=0;f<t[m].length;f++)p.push(t[m][f]);r[m-1].push(ei(p,"vphantom"))}const o=new Array(t.length).fill().map(()=>[]);for(let m=0;m<t[0].length;m++)o[0].push(t[0][m]);for(let m=1;m<t.length;m++)for(let p=0;p<t[0].length;p++)o[m].push(ei(t[m][p].body,"hphantom"));for(let m=0;m<t[0].length;m++)t[0][m]=ei(t[0][m].body,"hphantom");const i={type:"array",mode:"math",body:r,cols:[{type:"align",align:"c"}],rowGaps:new Array(r.length-1).fill(null),hLinesBeforeRow:new Array(r.length+1).fill().map(()=>[]),envClasses:[],scriptLevel:"text",arraystretch:1,labels:new Array(r.length).fill(""),arraycolsep:{number:.04,unit:"em"}},a={type:"styling",mode:"math",scriptLevel:"text",body:[{type:"array",mode:"math",body:o,cols:new Array(o.length).fill({type:"align",align:"c"}),rowGaps:new Array(o.length-1).fill(null),hLinesBeforeRow:new Array(o.length+1).fill().map(()=>[]),envClasses:[],scriptLevel:"text",arraystretch:1,labels:new Array(o.length).fill(""),arraycolsep:null}]},u={type:"supsub",mode:"math",stack:!0,base:{type:"op",mode:"math",limits:!0,alwaysHandleSupSub:!0,parentIsSupSub:!0,symbol:!1,suppressBaseShift:!0,body:[{type:"leftright",mode:"math",body:[n],left:e?e[0]:"(",right:e?e[1]:")",rightColor:void 0}]},sup:a,sub:null};return fc([i,u])};class Bt{constructor(e,t,r){this.lexer=e,this.start=t,this.end=r}static range(e,t){return t?!e||!e.loc||!t.loc||e.loc.lexer!==t.loc.lexer?null:new Bt(e.loc.lexer,e.loc.start,t.loc.end):e&&e.loc}}class Qt{constructor(e,t){this.text=e,this.loc=t}range(e,t){return new Qt(t,Bt.range(this,e))}}const lt={DISPLAY:0,TEXT:1,SCRIPT:2,SCRIPTSCRIPT:3},gc={};function E(n,e){gc[n]=e}const Pu=gc;E("\\noexpand",function(n){const e=n.popToken();return n.isExpandable(e.text)&&(e.noexpand=!0,e.treatAsRelax=!0),{tokens:[e],numArgs:0}});E("\\expandafter",function(n){const e=n.popToken();return n.expandOnce(!0),{tokens:[e],numArgs:0}});E("\\@firstoftwo",function(n){return{tokens:n.consumeArgs(2)[0],numArgs:0}});E("\\@secondoftwo",function(n){return{tokens:n.consumeArgs(2)[1],numArgs:0}});E("\\@ifnextchar",function(n){const e=n.consumeArgs(3);n.consumeSpaces();const t=n.future();return e[0].length===1&&e[0][0].text===t.text?{tokens:e[1],numArgs:0}:{tokens:e[2],numArgs:0}});E("\\@ifstar","\\@ifnextchar *{\\@firstoftwo{#1}}");E("\\TextOrMath",function(n){const e=n.consumeArgs(2);return n.mode==="text"?{tokens:e[0],numArgs:0}:{tokens:e[1],numArgs:0}});const Hi=n=>{let e="";for(let t=n.length-1;t>-1;t--)e+=n[t].text;return e},Ps={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,A:10,b:11,B:11,c:12,C:12,d:13,D:13,e:14,E:14,f:15,F:15},ga=n=>{const e=n.future().text;return e==="EOF"?[null,""]:[Ps[e.charAt(0)],e]},ba=(n,e,t)=>{for(let r=1;r<e.length;r++){const o=Ps[e.charAt(r)];n*=t,n+=o}return n};E("\\char",function(n){let e=n.popToken(),t,r="";if(e.text==="'")t=8,e=n.popToken();else if(e.text==='"')t=16,e=n.popToken();else if(e.text==="`")if(e=n.popToken(),e.text[0]==="\\")r=e.text.charCodeAt(1);else{if(e.text==="EOF")throw new Q("\\char` missing argument");r=e.text.charCodeAt(0)}else t=10;if(t){let o=e.text;if(r=Ps[o.charAt(0)],r==null||r>=t)throw new Q(`Invalid base-${t} digit ${e.text}`);r=ba(r,o,t);let i;for([i,o]=ga(n);i!=null&&i<t;)r*=t,r+=i,r=ba(r,o,t),n.popToken(),[i,o]=ga(n)}return`\\@char{${r}}`});function Bs(n){const e=n.consumeArgs(1)[0];let t="",r=e[e.length-1].loc.start;for(let o=e.length-1;o>=0;o--){const i=e[o].loc.start;i>r&&(t+=" ",r=i),t+=e[o].text,r+=e[o].text.length}return t}E("\\surd","\\sqrt{\\vphantom{|}}");E("âŠ•","\\oplus");E("\\long","");E("\\bgroup","{");E("\\egroup","}");E("~","\\nobreakspace");E("\\lq","`");E("\\rq","'");E("\\aa","\\r a");E("\\Bbbk","\\Bbb{k}");E("\\mathstrut","\\vphantom{(}");E("\\underbar","\\underline{\\text{#1}}");E("\\vdots","{\\varvdots\\rule{0pt}{15pt}}");E("â‹®","\\vdots");E("\\arraystretch","1");E("\\arraycolsep","6pt");E("\\substack","\\begin{subarray}{c}#1\\end{subarray}");E("\\iff","\\DOTSB\\;\\Longleftrightarrow\\;");E("\\implies","\\DOTSB\\;\\Longrightarrow\\;");E("\\impliedby","\\DOTSB\\;\\Longleftarrow\\;");const va={",":"\\dotsc","\\not":"\\dotsb","+":"\\dotsb","=":"\\dotsb","<":"\\dotsb",">":"\\dotsb","-":"\\dotsb","*":"\\dotsb",":":"\\dotsb","\\DOTSB":"\\dotsb","\\coprod":"\\dotsb","\\bigvee":"\\dotsb","\\bigwedge":"\\dotsb","\\biguplus":"\\dotsb","\\bigcap":"\\dotsb","\\bigcup":"\\dotsb","\\prod":"\\dotsb","\\sum":"\\dotsb","\\bigotimes":"\\dotsb","\\bigoplus":"\\dotsb","\\bigodot":"\\dotsb","\\bigsqcap":"\\dotsb","\\bigsqcup":"\\dotsb","\\bigtimes":"\\dotsb","\\And":"\\dotsb","\\longrightarrow":"\\dotsb","\\Longrightarrow":"\\dotsb","\\longleftarrow":"\\dotsb","\\Longleftarrow":"\\dotsb","\\longleftrightarrow":"\\dotsb","\\Longleftrightarrow":"\\dotsb","\\mapsto":"\\dotsb","\\longmapsto":"\\dotsb","\\hookrightarrow":"\\dotsb","\\doteq":"\\dotsb","\\mathbin":"\\dotsb","\\mathrel":"\\dotsb","\\relbar":"\\dotsb","\\Relbar":"\\dotsb","\\xrightarrow":"\\dotsb","\\xleftarrow":"\\dotsb","\\DOTSI":"\\dotsi","\\int":"\\dotsi","\\oint":"\\dotsi","\\iint":"\\dotsi","\\iiint":"\\dotsi","\\iiiint":"\\dotsi","\\DOTSX":"\\dotsx"};E("\\dots",function(n){let e="\\dotso";const t=n.expandAfterFuture().text;return t in va?e=va[t]:(t.slice(0,4)==="\\not"||t in ct.math&&["bin","rel"].includes(ct.math[t].group))&&(e="\\dotsb"),e});const $s={")":!0,"]":!0,"\\rbrack":!0,"\\}":!0,"\\rbrace":!0,"\\rangle":!0,"\\rceil":!0,"\\rfloor":!0,"\\rgroup":!0,"\\rmoustache":!0,"\\right":!0,"\\bigr":!0,"\\biggr":!0,"\\Bigr":!0,"\\Biggr":!0,$:!0,";":!0,".":!0,",":!0};E("\\dotso",function(n){return n.future().text in $s?"\\ldots\\,":"\\ldots"});E("\\dotsc",function(n){const e=n.future().text;return e in $s&&e!==","?"\\ldots\\,":"\\ldots"});E("\\cdots",function(n){return n.future().text in $s?"\\@cdots\\,":"\\@cdots"});E("\\dotsb","\\cdots");E("\\dotsm","\\cdots");E("\\dotsi","\\!\\cdots");E("\\idotsint","\\int\\!\\cdots\\!\\int");E("\\dotsx","\\ldots\\,");E("\\DOTSI","\\relax");E("\\DOTSB","\\relax");E("\\DOTSX","\\relax");E("\\tmspace","\\TextOrMath{\\kern#1#3}{\\mskip#1#2}\\relax");E("\\,","{\\tmspace+{3mu}{.1667em}}");E("\\thinspace","\\,");E("\\>","\\mskip{4mu}");E("\\:","{\\tmspace+{4mu}{.2222em}}");E("\\medspace","\\:");E("\\;","{\\tmspace+{5mu}{.2777em}}");E("\\thickspace","\\;");E("\\!","{\\tmspace-{3mu}{.1667em}}");E("\\negthinspace","\\!");E("\\negmedspace","{\\tmspace-{4mu}{.2222em}}");E("\\negthickspace","{\\tmspace-{5mu}{.277em}}");E("\\enspace","\\kern.5em ");E("\\enskip","\\hskip.5em\\relax");E("\\quad","\\hskip1em\\relax");E("\\qquad","\\hskip2em\\relax");E("\\AA","\\TextOrMath{\\Angstrom}{\\mathring{A}}\\relax");E("\\tag","\\@ifstar\\tag@literal\\tag@paren");E("\\tag@paren","\\tag@literal{({#1})}");E("\\tag@literal",n=>{if(n.macros.get("\\df@tag"))throw new Q("Multiple \\tag");return"\\gdef\\df@tag{\\text{#1}}"});E("\\notag","\\nonumber");E("\\nonumber","\\gdef\\@eqnsw{0}");E("\\bmod","\\mathbin{\\text{mod}}");E("\\pod","\\allowbreak\\mathchoice{\\mkern18mu}{\\mkern8mu}{\\mkern8mu}{\\mkern8mu}(#1)");E("\\pmod","\\pod{{\\rm mod}\\mkern6mu#1}");E("\\mod","\\allowbreak\\mathchoice{\\mkern18mu}{\\mkern12mu}{\\mkern12mu}{\\mkern12mu}{\\rm mod}\\,\\,#1");E("\\newline","\\\\\\relax");E("\\TeX","\\textrm{T}\\kern-.1667em\\raisebox{-.5ex}{E}\\kern-.125em\\textrm{X}");E("\\LaTeX","\\textrm{L}\\kern-.35em\\raisebox{0.2em}{\\scriptstyle A}\\kern-.15em\\TeX");E("\\Temml","\\textrm{T}\\kern-0.2em\\lower{0.2em}{\\textrm{E}}\\kern-0.08em{\\textrm{M}\\kern-0.08em\\raise{0.2em}\\textrm{M}\\kern-0.08em\\textrm{L}}");E("\\hspace","\\@ifstar\\@hspacer\\@hspace");E("\\@hspace","\\hskip #1\\relax");E("\\@hspacer","\\rule{0pt}{0pt}\\hskip #1\\relax");E("\\colon",'\\mathpunct{\\char"3a}');E("\\prescript","\\pres@cript{_{#1}^{#2}}{}{#3}");E("\\ordinarycolon",'\\char"3a');E("\\vcentcolon","\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}}");E("\\coloneq",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"2212}');E("\\Coloneq",'\\mathrel{\\char"2237\\char"2212}');E("\\Eqqcolon",'\\mathrel{\\char"3d\\char"2237}');E("\\Eqcolon",'\\mathrel{\\char"2212\\char"2237}');E("\\colonapprox",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"2248}');E("\\Colonapprox",'\\mathrel{\\char"2237\\char"2248}');E("\\colonsim",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"223c}');E("\\Colonsim",'\\mathrel{\\raisebox{0.035em}{\\ordinarycolon}\\char"223c}');E("\\ratio","\\vcentcolon");E("\\coloncolon","\\dblcolon");E("\\colonequals","\\coloneqq");E("\\coloncolonequals","\\Coloneqq");E("\\equalscolon","\\eqqcolon");E("\\equalscoloncolon","\\Eqqcolon");E("\\colonminus","\\coloneq");E("\\coloncolonminus","\\Coloneq");E("\\minuscolon","\\eqcolon");E("\\minuscoloncolon","\\Eqcolon");E("\\coloncolonapprox","\\Colonapprox");E("\\coloncolonsim","\\Colonsim");E("\\notni","\\mathrel{\\char`âˆŒ}");E("\\limsup","\\DOTSB\\operatorname*{lim\\,sup}");E("\\liminf","\\DOTSB\\operatorname*{lim\\,inf}");E("\\injlim","\\DOTSB\\operatorname*{inj\\,lim}");E("\\projlim","\\DOTSB\\operatorname*{proj\\,lim}");E("\\varlimsup","\\DOTSB\\operatorname*{\\overline{\\text{lim}}}");E("\\varliminf","\\DOTSB\\operatorname*{\\underline{\\text{lim}}}");E("\\varinjlim","\\DOTSB\\operatorname*{\\underrightarrow{\\text{lim}}}");E("\\varprojlim","\\DOTSB\\operatorname*{\\underleftarrow{\\text{lim}}}");E("\\centerdot","{\\medspace\\rule{0.167em}{0.189em}\\medspace}");E("\\argmin","\\DOTSB\\operatorname*{arg\\,min}");E("\\argmax","\\DOTSB\\operatorname*{arg\\,max}");E("\\plim","\\DOTSB\\operatorname*{plim}");E("\\leftmodels","\\mathop{\\reflectbox{$\\models$}}");E("\\bra","\\mathinner{\\langle{#1}|}");E("\\ket","\\mathinner{|{#1}\\rangle}");E("\\braket","\\mathinner{\\langle{#1}\\rangle}");E("\\Bra","\\left\\langle#1\\right|");E("\\Ket","\\left|#1\\right\\rangle");const bc=(n,e)=>{const r=`}\\,\\middle${e[0]==="|"?"\\vert":"\\Vert"}\\,{`;return n.slice(0,e.index)+r+n.slice(e.index+e[0].length)};E("\\Braket",function(n){let e=Bs(n);const t=/\|\||\||\\\|/g;let r;for(;(r=t.exec(e))!==null;)e=bc(e,r);return"\\left\\langle{"+e+"}\\right\\rangle"});E("\\Set",function(n){let e=Bs(n);const t=/\|\||\||\\\|/.exec(e);return t&&(e=bc(e,t)),"\\left\\{\\:{"+e+"}\\:\\right\\}"});E("\\set",function(n){return"\\{{"+Bs(n).replace(/\|/,"}\\mid{")+"}\\}"});E("\\angln","{\\angl n}");E("\\odv","\\@ifstar\\odv@next\\odv@numerator");E("\\odv@numerator","\\frac{\\mathrm{d}#1}{\\mathrm{d}#2}");E("\\odv@next","\\frac{\\mathrm{d}}{\\mathrm{d}#2}#1");E("\\pdv","\\@ifstar\\pdv@next\\pdv@numerator");const vc=n=>{const e=n[0][0].text,t=Hi(n[1]).split(","),r=String(t.length),o=r==="1"?"\\partial":`\\partial^${r}`;let i="";return t.map(s=>{i+="\\partial "+s.trim()+"\\,"}),[e,o,i.replace(/\\,$/,"")]};E("\\pdv@numerator",function(n){const[e,t,r]=vc(n.consumeArgs(2));return`\\frac{${t} ${e}}{${r}}`});E("\\pdv@next",function(n){const[e,t,r]=vc(n.consumeArgs(2));return`\\frac{${t}}{${r}} ${e}`});E("\\upalpha","\\up@greek{\\alpha}");E("\\upbeta","\\up@greek{\\beta}");E("\\upgamma","\\up@greek{\\gamma}");E("\\updelta","\\up@greek{\\delta}");E("\\upepsilon","\\up@greek{\\epsilon}");E("\\upzeta","\\up@greek{\\zeta}");E("\\upeta","\\up@greek{\\eta}");E("\\uptheta","\\up@greek{\\theta}");E("\\upiota","\\up@greek{\\iota}");E("\\upkappa","\\up@greek{\\kappa}");E("\\uplambda","\\up@greek{\\lambda}");E("\\upmu","\\up@greek{\\mu}");E("\\upnu","\\up@greek{\\nu}");E("\\upxi","\\up@greek{\\xi}");E("\\upomicron","\\up@greek{\\omicron}");E("\\uppi","\\up@greek{\\pi}");E("\\upalpha","\\up@greek{\\alpha}");E("\\uprho","\\up@greek{\\rho}");E("\\upsigma","\\up@greek{\\sigma}");E("\\uptau","\\up@greek{\\tau}");E("\\upupsilon","\\up@greek{\\upsilon}");E("\\upphi","\\up@greek{\\phi}");E("\\upchi","\\up@greek{\\chi}");E("\\uppsi","\\up@greek{\\psi}");E("\\upomega","\\up@greek{\\omega}");E("\\invamp",'\\mathbin{\\char"214b}');E("\\parr",'\\mathbin{\\char"214b}');E("\\with",'\\mathbin{\\char"26}');E("\\multimapinv",'\\mathrel{\\char"27dc}');E("\\multimapboth",'\\mathrel{\\char"29df}');E("\\scoh",'{\\mkern5mu\\char"2322\\mkern5mu}');E("\\sincoh",'{\\mkern5mu\\char"2323\\mkern5mu}');E("\\coh",`{\\mkern5mu\\rule{}{0.7em}\\mathrlap{\\smash{\\raise2mu{\\char"2322}}}
{\\smash{\\lower4mu{\\char"2323}}}\\mkern5mu}`);E("\\incoh",`{\\mkern5mu\\rule{}{0.7em}\\mathrlap{\\smash{\\raise2mu{\\char"2323}}}
{\\smash{\\lower4mu{\\char"2322}}}\\mkern5mu}`);E("\\standardstate","\\text{\\tiny\\char`â¦µ}");E("\\ce",function(n){return yc(n.consumeArgs(1)[0],"ce")});E("\\pu",function(n){return yc(n.consumeArgs(1)[0],"pu")});E("\\uniDash","{\\rule{0.672em}{0.06em}}");E("\\triDash","{\\rule{0.15em}{0.06em}\\kern2mu\\rule{0.15em}{0.06em}\\kern2mu\\rule{0.15em}{0.06em}}");E("\\tripleDash","\\kern0.075em\\raise0.25em{\\triDash}\\kern0.075em");E("\\tripleDashOverLine","\\kern0.075em\\mathrlap{\\raise0.125em{\\uniDash}}\\raise0.34em{\\triDash}\\kern0.075em");E("\\tripleDashOverDoubleLine","\\kern0.075em\\mathrlap{\\mathrlap{\\raise0.48em{\\triDash}}\\raise0.27em{\\uniDash}}{\\raise0.05em{\\uniDash}}\\kern0.075em");E("\\tripleDashBetweenDoubleLine","\\kern0.075em\\mathrlap{\\mathrlap{\\raise0.48em{\\uniDash}}\\raise0.27em{\\triDash}}{\\raise0.05em{\\uniDash}}\\kern0.075em");var yc=function(n,e){for(var t="",r=n.length&&n[n.length-1].loc.start,o=n.length-1;o>=0;o--)n[o].loc.start>r&&(t+=" ",r=n[o].loc.start),t+=n[o].text,r+=n[o].text.length;var i=Ve.go(J.go(t,e));return i},J={go:function(n,e){if(!n)return[];e===void 0&&(e="ce");var t="0",r={};r.parenthesisLevel=0,n=n.replace(/\n/g," "),n=n.replace(/[\u2212\u2013\u2014\u2010]/g,"-"),n=n.replace(/[\u2026]/g,"...");for(var o,i=10,s=[];;){o!==n?(i=10,o=n):i--;var a=J.stateMachines[e],l=a.transitions[t]||a.transitions["*"];e:for(var d=0;d<l.length;d++){var u=J.patterns.match_(l[d].pattern,n);if(u){for(var m=l[d].task,p=0;p<m.action_.length;p++){var f;if(a.actions[m.action_[p].type_])f=a.actions[m.action_[p].type_](r,u.match_,m.action_[p].option);else if(J.actions[m.action_[p].type_])f=J.actions[m.action_[p].type_](r,u.match_,m.action_[p].option);else throw["MhchemBugA","mhchem bug A. Please report. ("+m.action_[p].type_+")"];J.concatArray(s,f)}if(t=m.nextState||t,n.length>0){if(m.revisit||(n=u.remainder),!m.toContinue)break e}else return s}}if(i<=0)throw["MhchemBugU","mhchem bug U. Please report."]}},concatArray:function(n,e){if(e)if(Array.isArray(e))for(var t=0;t<e.length;t++)n.push(e[t]);else n.push(e)},patterns:{patterns:{empty:/^$/,else:/^./,else2:/^./,space:/^\s/,"space A":/^\s(?=[A-Z\\$])/,space$:/^\s$/,"a-z":/^[a-z]/,x:/^x/,x$:/^x$/,i$:/^i$/,letters:/^(?:[a-zA-Z\u03B1-\u03C9\u0391-\u03A9?@]|(?:\\(?:alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|Gamma|Delta|Theta|Lambda|Xi|Pi|Sigma|Upsilon|Phi|Psi|Omega)(?:\s+|\{\}|(?![a-zA-Z]))))+/,"\\greek":/^\\(?:alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|Gamma|Delta|Theta|Lambda|Xi|Pi|Sigma|Upsilon|Phi|Psi|Omega)(?:\s+|\{\}|(?![a-zA-Z]))/,"one lowercase latin letter $":/^(?:([a-z])(?:$|[^a-zA-Z]))$/,"$one lowercase latin letter$ $":/^\$(?:([a-z])(?:$|[^a-zA-Z]))\$$/,"one lowercase greek letter $":/^(?:\$?[\u03B1-\u03C9]\$?|\$?\\(?:alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega)\s*\$?)(?:\s+|\{\}|(?![a-zA-Z]))$/,digits:/^[0-9]+/,"-9.,9":/^[+\-]?(?:[0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+))/,"-9.,9 no missing 0":/^[+\-]?[0-9]+(?:[.,][0-9]+)?/,"(-)(9.,9)(e)(99)":function(n){var e=n.match(/^(\+\-|\+\/\-|\+|\-|\\pm\s?)?([0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+))?(\((?:[0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+))\))?(?:([eE]|\s*(\*|x|\\times|\u00D7)\s*10\^)([+\-]?[0-9]+|\{[+\-]?[0-9]+\}))?/);return e&&e[0]?{match_:e.splice(1),remainder:n.substr(e[0].length)}:null},"(-)(9)^(-9)":function(n){var e=n.match(/^(\+\-|\+\/\-|\+|\-|\\pm\s?)?([0-9]+(?:[,.][0-9]+)?|[0-9]*(?:\.[0-9]+)?)\^([+\-]?[0-9]+|\{[+\-]?[0-9]+\})/);return e&&e[0]?{match_:e.splice(1),remainder:n.substr(e[0].length)}:null},"state of aggregation $":function(n){var e=J.patterns.findObserveGroups(n,"",/^\([a-z]{1,3}(?=[\),])/,")","");if(e&&e.remainder.match(/^($|[\s,;\)\]\}])/))return e;var t=n.match(/^(?:\((?:\\ca\s?)?\$[amothc]\$\))/);return t?{match_:t[0],remainder:n.substr(t[0].length)}:null},"_{(state of aggregation)}$":/^_\{(\([a-z]{1,3}\))\}/,"{[(":/^(?:\\\{|\[|\()/,")]}":/^(?:\)|\]|\\\})/,", ":/^[,;]\s*/,",":/^[,;]/,".":/^[.]/,". ":/^([.\u22C5\u00B7\u2022])\s*/,"...":/^\.\.\.(?=$|[^.])/,"* ":/^([*])\s*/,"^{(...)}":function(n){return J.patterns.findObserveGroups(n,"^{","","","}")},"^($...$)":function(n){return J.patterns.findObserveGroups(n,"^","$","$","")},"^a":/^\^([0-9]+|[^\\_])/,"^\\x{}{}":function(n){return J.patterns.findObserveGroups(n,"^",/^\\[a-zA-Z]+\{/,"}","","","{","}","",!0)},"^\\x{}":function(n){return J.patterns.findObserveGroups(n,"^",/^\\[a-zA-Z]+\{/,"}","")},"^\\x":/^\^(\\[a-zA-Z]+)\s*/,"^(-1)":/^\^(-?\d+)/,"'":/^'/,"_{(...)}":function(n){return J.patterns.findObserveGroups(n,"_{","","","}")},"_($...$)":function(n){return J.patterns.findObserveGroups(n,"_","$","$","")},_9:/^_([+\-]?[0-9]+|[^\\])/,"_\\x{}{}":function(n){return J.patterns.findObserveGroups(n,"_",/^\\[a-zA-Z]+\{/,"}","","","{","}","",!0)},"_\\x{}":function(n){return J.patterns.findObserveGroups(n,"_",/^\\[a-zA-Z]+\{/,"}","")},"_\\x":/^_(\\[a-zA-Z]+)\s*/,"^_":/^(?:\^(?=_)|\_(?=\^)|[\^_]$)/,"{}":/^\{\}/,"{...}":function(n){return J.patterns.findObserveGroups(n,"","{","}","")},"{(...)}":function(n){return J.patterns.findObserveGroups(n,"{","","","}")},"$...$":function(n){return J.patterns.findObserveGroups(n,"","$","$","")},"${(...)}$":function(n){return J.patterns.findObserveGroups(n,"${","","","}$")},"$(...)$":function(n){return J.patterns.findObserveGroups(n,"$","","","$")},"=<>":/^[=<>]/,"#":/^[#\u2261]/,"+":/^\+/,"-$":/^-(?=[\s_},;\]/]|$|\([a-z]+\))/,"-9":/^-(?=[0-9])/,"- orbital overlap":/^-(?=(?:[spd]|sp)(?:$|[\s,;\)\]\}]))/,"-":/^-/,"pm-operator":/^(?:\\pm|\$\\pm\$|\+-|\+\/-)/,operator:/^(?:\+|(?:[\-=<>]|<<|>>|\\approx|\$\\approx\$)(?=\s|$|-?[0-9]))/,arrowUpDown:/^(?:v|\(v\)|\^|\(\^\))(?=$|[\s,;\)\]\}])/,"\\bond{(...)}":function(n){return J.patterns.findObserveGroups(n,"\\bond{","","","}")},"->":/^(?:<->|<-->|->|<-|<=>>|<<=>|<=>|[\u2192\u27F6\u21CC])/,CMT:/^[CMT](?=\[)/,"[(...)]":function(n){return J.patterns.findObserveGroups(n,"[","","","]")},"1st-level escape":/^(&|\\\\|\\hline)\s*/,"\\,":/^(?:\\[,\ ;:])/,"\\x{}{}":function(n){return J.patterns.findObserveGroups(n,"",/^\\[a-zA-Z]+\{/,"}","","","{","}","",!0)},"\\x{}":function(n){return J.patterns.findObserveGroups(n,"",/^\\[a-zA-Z]+\{/,"}","")},"\\ca":/^\\ca(?:\s+|(?![a-zA-Z]))/,"\\x":/^(?:\\[a-zA-Z]+\s*|\\[_&{}%])/,orbital:/^(?:[0-9]{1,2}[spdfgh]|[0-9]{0,2}sp)(?=$|[^a-zA-Z])/,others:/^[\/~|]/,"\\frac{(...)}":function(n){return J.patterns.findObserveGroups(n,"\\frac{","","","}","{","","","}")},"\\overset{(...)}":function(n){return J.patterns.findObserveGroups(n,"\\overset{","","","}","{","","","}")},"\\underset{(...)}":function(n){return J.patterns.findObserveGroups(n,"\\underset{","","","}","{","","","}")},"\\underbrace{(...)}":function(n){return J.patterns.findObserveGroups(n,"\\underbrace{","","","}_","{","","","}")},"\\color{(...)}0":function(n){return J.patterns.findObserveGroups(n,"\\color{","","","}")},"\\color{(...)}{(...)}1":function(n){return J.patterns.findObserveGroups(n,"\\color{","","","}","{","","","}")},"\\color(...){(...)}2":function(n){return J.patterns.findObserveGroups(n,"\\color","\\","",/^(?=\{)/,"{","","","}")},"\\ce{(...)}":function(n){return J.patterns.findObserveGroups(n,"\\ce{","","","}")},oxidation$:/^(?:[+-][IVX]+|\\pm\s*0|\$\\pm\$\s*0)$/,"d-oxidation$":/^(?:[+-]?\s?[IVX]+|\\pm\s*0|\$\\pm\$\s*0)$/,"roman numeral":/^[IVX]+/,"1/2$":/^[+\-]?(?:[0-9]+|\$[a-z]\$|[a-z])\/[0-9]+(?:\$[a-z]\$|[a-z])?$/,amount:function(n){var e;if(e=n.match(/^(?:(?:(?:\([+\-]?[0-9]+\/[0-9]+\)|[+\-]?(?:[0-9]+|\$[a-z]\$|[a-z])\/[0-9]+|[+\-]?[0-9]+[.,][0-9]+|[+\-]?\.[0-9]+|[+\-]?[0-9]+)(?:[a-z](?=\s*[A-Z]))?)|[+\-]?[a-z](?=\s*[A-Z])|\+(?!\s))/),e)return{match_:e[0],remainder:n.substr(e[0].length)};var t=J.patterns.findObserveGroups(n,"","$","$","");return t&&(e=t.match_.match(/^\$(?:\(?[+\-]?(?:[0-9]*[a-z]?[+\-])?[0-9]*[a-z](?:[+\-][0-9]*[a-z]?)?\)?|\+|-)\$$/),e)?{match_:e[0],remainder:n.substr(e[0].length)}:null},amount2:function(n){return this.amount(n)},"(KV letters),":/^(?:[A-Z][a-z]{0,2}|i)(?=,)/,formula$:function(n){if(n.match(/^\([a-z]+\)$/))return null;var e=n.match(/^(?:[a-z]|(?:[0-9\ \+\-\,\.\(\)]+[a-z])+[0-9\ \+\-\,\.\(\)]*|(?:[a-z][0-9\ \+\-\,\.\(\)]+)+[a-z]?)$/);return e?{match_:e[0],remainder:n.substr(e[0].length)}:null},uprightEntities:/^(?:pH|pOH|pC|pK|iPr|iBu)(?=$|[^a-zA-Z])/,"/":/^\s*(\/)\s*/,"//":/^\s*(\/\/)\s*/,"*":/^\s*[*.]\s*/},findObserveGroups:function(n,e,t,r,o,i,s,a,l,d){var u=function(v,S){if(typeof S=="string")return v.indexOf(S)!==0?null:S;var C=v.match(S);return C?C[0]:null},m=function(v,S,C){for(var L=0;S<v.length;){var I=v.charAt(S),R=u(v.substr(S),C);if(R!==null&&L===0)return{endMatchBegin:S,endMatchEnd:S+R.length};if(I==="{")L++;else if(I==="}"){if(L===0)throw["ExtraCloseMissingOpen","Extra close brace or missing open brace"];L--}S++}return L>0,null},p=u(n,e);if(p===null||(n=n.substr(p.length),p=u(n,t),p===null))return null;var f=m(n,p.length,r||o);if(f===null)return null;var g=n.substring(0,r?f.endMatchEnd:f.endMatchBegin);if(i||s){var b=this.findObserveGroups(n.substr(f.endMatchEnd),i,s,a,l);if(b===null)return null;var w=[g,b.match_];return{match_:d?w.join(""):w,remainder:b.remainder}}else return{match_:g,remainder:n.substr(f.endMatchEnd)}},match_:function(n,e){var t=J.patterns.patterns[n];if(t===void 0)throw["MhchemBugP","mhchem bug P. Please report. ("+n+")"];if(typeof t=="function")return J.patterns.patterns[n](e);var r=e.match(t);if(r){var o;return r[2]?o=[r[1],r[2]]:r[1]?o=r[1]:o=r[0],{match_:o,remainder:e.substr(r[0].length)}}return null}},actions:{"a=":function(n,e){n.a=(n.a||"")+e},"b=":function(n,e){n.b=(n.b||"")+e},"p=":function(n,e){n.p=(n.p||"")+e},"o=":function(n,e){n.o=(n.o||"")+e},"q=":function(n,e){n.q=(n.q||"")+e},"d=":function(n,e){n.d=(n.d||"")+e},"rm=":function(n,e){n.rm=(n.rm||"")+e},"text=":function(n,e){n.text_=(n.text_||"")+e},insert:function(n,e,t){return{type_:t}},"insert+p1":function(n,e,t){return{type_:t,p1:e}},"insert+p1+p2":function(n,e,t){return{type_:t,p1:e[0],p2:e[1]}},copy:function(n,e){return e},rm:function(n,e){return{type_:"rm",p1:e||""}},text:function(n,e){return J.go(e,"text")},"{text}":function(n,e){var t=["{"];return J.concatArray(t,J.go(e,"text")),t.push("}"),t},"tex-math":function(n,e){return J.go(e,"tex-math")},"tex-math tight":function(n,e){return J.go(e,"tex-math tight")},bond:function(n,e,t){return{type_:"bond",kind_:t||e}},"color0-output":function(n,e){return{type_:"color0",color:e[0]}},ce:function(n,e){return J.go(e)},"1/2":function(n,e){var t=[];e.match(/^[+\-]/)&&(t.push(e.substr(0,1)),e=e.substr(1));var r=e.match(/^([0-9]+|\$[a-z]\$|[a-z])\/([0-9]+)(\$[a-z]\$|[a-z])?$/);return r[1]=r[1].replace(/\$/g,""),t.push({type_:"frac",p1:r[1],p2:r[2]}),r[3]&&(r[3]=r[3].replace(/\$/g,""),t.push({type_:"tex-math",p1:r[3]})),t},"9,9":function(n,e){return J.go(e,"9,9")}},createTransitions:function(n){var e,t,r,o,i={};for(e in n)for(t in n[e])for(r=t.split("|"),n[e][t].stateArray=r,o=0;o<r.length;o++)i[r[o]]=[];for(e in n)for(t in n[e])for(r=n[e][t].stateArray||[],o=0;o<r.length;o++){var s=n[e][t];if(s.action_){s.action_=[].concat(s.action_);for(var a=0;a<s.action_.length;a++)typeof s.action_[a]=="string"&&(s.action_[a]={type_:s.action_[a]})}else s.action_=[];for(var l=e.split("|"),d=0;d<l.length;d++)if(r[o]==="*")for(var u in i)i[u].push({pattern:l[d],task:s});else i[r[o]].push({pattern:l[d],task:s})}return i},stateMachines:{}};J.stateMachines={ce:{transitions:J.createTransitions({empty:{"*":{action_:"output"}},else:{"0|1|2":{action_:"beginsWithBond=false",revisit:!0,toContinue:!0}},oxidation$:{0:{action_:"oxidation-output"}},CMT:{r:{action_:"rdt=",nextState:"rt"},rd:{action_:"rqt=",nextState:"rdt"}},arrowUpDown:{"0|1|2|as":{action_:["sb=false","output","operator"],nextState:"1"}},uprightEntities:{"0|1|2":{action_:["o=","output"],nextState:"1"}},orbital:{"0|1|2|3":{action_:"o=",nextState:"o"}},"->":{"0|1|2|3":{action_:"r=",nextState:"r"},"a|as":{action_:["output","r="],nextState:"r"},"*":{action_:["output","r="],nextState:"r"}},"+":{o:{action_:"d= kv",nextState:"d"},"d|D":{action_:"d=",nextState:"d"},q:{action_:"d=",nextState:"qd"},"qd|qD":{action_:"d=",nextState:"qd"},dq:{action_:["output","d="],nextState:"d"},3:{action_:["sb=false","output","operator"],nextState:"0"}},amount:{"0|2":{action_:"a=",nextState:"a"}},"pm-operator":{"0|1|2|a|as":{action_:["sb=false","output",{type_:"operator",option:"\\pm"}],nextState:"0"}},operator:{"0|1|2|a|as":{action_:["sb=false","output","operator"],nextState:"0"}},"-$":{"o|q":{action_:["charge or bond","output"],nextState:"qd"},d:{action_:"d=",nextState:"d"},D:{action_:["output",{type_:"bond",option:"-"}],nextState:"3"},q:{action_:"d=",nextState:"qd"},qd:{action_:"d=",nextState:"qd"},"qD|dq":{action_:["output",{type_:"bond",option:"-"}],nextState:"3"}},"-9":{"3|o":{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"3"}},"- orbital overlap":{o:{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"2"},d:{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"2"}},"-":{"0|1|2":{action_:[{type_:"output",option:1},"beginsWithBond=true",{type_:"bond",option:"-"}],nextState:"3"},3:{action_:{type_:"bond",option:"-"}},a:{action_:["output",{type_:"insert",option:"hyphen"}],nextState:"2"},as:{action_:[{type_:"output",option:2},{type_:"bond",option:"-"}],nextState:"3"},b:{action_:"b="},o:{action_:{type_:"- after o/d",option:!1},nextState:"2"},q:{action_:{type_:"- after o/d",option:!1},nextState:"2"},"d|qd|dq":{action_:{type_:"- after o/d",option:!0},nextState:"2"},"D|qD|p":{action_:["output",{type_:"bond",option:"-"}],nextState:"3"}},amount2:{"1|3":{action_:"a=",nextState:"a"}},letters:{"0|1|2|3|a|as|b|p|bp|o":{action_:"o=",nextState:"o"},"q|dq":{action_:["output","o="],nextState:"o"},"d|D|qd|qD":{action_:"o after d",nextState:"o"}},digits:{o:{action_:"q=",nextState:"q"},"d|D":{action_:"q=",nextState:"dq"},q:{action_:["output","o="],nextState:"o"},a:{action_:"o=",nextState:"o"}},"space A":{"b|p|bp":{}},space:{a:{nextState:"as"},0:{action_:"sb=false"},"1|2":{action_:"sb=true"},"r|rt|rd|rdt|rdq":{action_:"output",nextState:"0"},"*":{action_:["output","sb=true"],nextState:"1"}},"1st-level escape":{"1|2":{action_:["output",{type_:"insert+p1",option:"1st-level escape"}]},"*":{action_:["output",{type_:"insert+p1",option:"1st-level escape"}],nextState:"0"}},"[(...)]":{"r|rt":{action_:"rd=",nextState:"rd"},"rd|rdt":{action_:"rq=",nextState:"rdq"}},"...":{"o|d|D|dq|qd|qD":{action_:["output",{type_:"bond",option:"..."}],nextState:"3"},"*":{action_:[{type_:"output",option:1},{type_:"insert",option:"ellipsis"}],nextState:"1"}},". |* ":{"*":{action_:["output",{type_:"insert",option:"addition compound"}],nextState:"1"}},"state of aggregation $":{"*":{action_:["output","state of aggregation"],nextState:"1"}},"{[(":{"a|as|o":{action_:["o=","output","parenthesisLevel++"],nextState:"2"},"0|1|2|3":{action_:["o=","output","parenthesisLevel++"],nextState:"2"},"*":{action_:["output","o=","output","parenthesisLevel++"],nextState:"2"}},")]}":{"0|1|2|3|b|p|bp|o":{action_:["o=","parenthesisLevel--"],nextState:"o"},"a|as|d|D|q|qd|qD|dq":{action_:["output","o=","parenthesisLevel--"],nextState:"o"}},", ":{"*":{action_:["output","comma"],nextState:"0"}},"^_":{"*":{}},"^{(...)}|^($...$)":{"0|1|2|as":{action_:"b=",nextState:"b"},p:{action_:"b=",nextState:"bp"},"3|o":{action_:"d= kv",nextState:"D"},q:{action_:"d=",nextState:"qD"},"d|D|qd|qD|dq":{action_:["output","d="],nextState:"D"}},"^a|^\\x{}{}|^\\x{}|^\\x|'":{"0|1|2|as":{action_:"b=",nextState:"b"},p:{action_:"b=",nextState:"bp"},"3|o":{action_:"d= kv",nextState:"d"},q:{action_:"d=",nextState:"qd"},"d|qd|D|qD":{action_:"d="},dq:{action_:["output","d="],nextState:"d"}},"_{(state of aggregation)}$":{"d|D|q|qd|qD|dq":{action_:["output","q="],nextState:"q"}},"_{(...)}|_($...$)|_9|_\\x{}{}|_\\x{}|_\\x":{"0|1|2|as":{action_:"p=",nextState:"p"},b:{action_:"p=",nextState:"bp"},"3|o":{action_:"q=",nextState:"q"},"d|D":{action_:"q=",nextState:"dq"},"q|qd|qD|dq":{action_:["output","q="],nextState:"q"}},"=<>":{"0|1|2|3|a|as|o|q|d|D|qd|qD|dq":{action_:[{type_:"output",option:2},"bond"],nextState:"3"}},"#":{"0|1|2|3|a|as|o":{action_:[{type_:"output",option:2},{type_:"bond",option:"#"}],nextState:"3"}},"{}":{"*":{action_:{type_:"output",option:1},nextState:"1"}},"{...}":{"0|1|2|3|a|as|b|p|bp":{action_:"o=",nextState:"o"},"o|d|D|q|qd|qD|dq":{action_:["output","o="],nextState:"o"}},"$...$":{a:{action_:"a="},"0|1|2|3|as|b|p|bp|o":{action_:"o=",nextState:"o"},"as|o":{action_:"o="},"q|d|D|qd|qD|dq":{action_:["output","o="],nextState:"o"}},"\\bond{(...)}":{"*":{action_:[{type_:"output",option:2},"bond"],nextState:"3"}},"\\frac{(...)}":{"*":{action_:[{type_:"output",option:1},"frac-output"],nextState:"3"}},"\\overset{(...)}":{"*":{action_:[{type_:"output",option:2},"overset-output"],nextState:"3"}},"\\underset{(...)}":{"*":{action_:[{type_:"output",option:2},"underset-output"],nextState:"3"}},"\\underbrace{(...)}":{"*":{action_:[{type_:"output",option:2},"underbrace-output"],nextState:"3"}},"\\color{(...)}{(...)}1|\\color(...){(...)}2":{"*":{action_:[{type_:"output",option:2},"color-output"],nextState:"3"}},"\\color{(...)}0":{"*":{action_:[{type_:"output",option:2},"color0-output"]}},"\\ce{(...)}":{"*":{action_:[{type_:"output",option:2},"ce"],nextState:"3"}},"\\,":{"*":{action_:[{type_:"output",option:1},"copy"],nextState:"1"}},"\\x{}{}|\\x{}|\\x":{"0|1|2|3|a|as|b|p|bp|o|c0":{action_:["o=","output"],nextState:"3"},"*":{action_:["output","o=","output"],nextState:"3"}},others:{"*":{action_:[{type_:"output",option:1},"copy"],nextState:"3"}},else2:{a:{action_:"a to o",nextState:"o",revisit:!0},as:{action_:["output","sb=true"],nextState:"1",revisit:!0},"r|rt|rd|rdt|rdq":{action_:["output"],nextState:"0",revisit:!0},"*":{action_:["output","copy"],nextState:"3"}}}),actions:{"o after d":function(n,e){var t;if((n.d||"").match(/^[0-9]+$/)){var r=n.d;n.d=void 0,t=this.output(n),n.b=r}else t=this.output(n);return J.actions["o="](n,e),t},"d= kv":function(n,e){n.d=e,n.dType="kv"},"charge or bond":function(n,e){if(n.beginsWithBond){var t=[];return J.concatArray(t,this.output(n)),J.concatArray(t,J.actions.bond(n,e,"-")),t}else n.d=e},"- after o/d":function(n,e,t){var r=J.patterns.match_("orbital",n.o||""),o=J.patterns.match_("one lowercase greek letter $",n.o||""),i=J.patterns.match_("one lowercase latin letter $",n.o||""),s=J.patterns.match_("$one lowercase latin letter$ $",n.o||""),a=e==="-"&&(r&&r.remainder===""||o||i||s);a&&!n.a&&!n.b&&!n.p&&!n.d&&!n.q&&!r&&i&&(n.o="$"+n.o+"$");var l=[];return a?(J.concatArray(l,this.output(n)),l.push({type_:"hyphen"})):(r=J.patterns.match_("digits",n.d||""),t&&r&&r.remainder===""?(J.concatArray(l,J.actions["d="](n,e)),J.concatArray(l,this.output(n))):(J.concatArray(l,this.output(n)),J.concatArray(l,J.actions.bond(n,e,"-")))),l},"a to o":function(n){n.o=n.a,n.a=void 0},"sb=true":function(n){n.sb=!0},"sb=false":function(n){n.sb=!1},"beginsWithBond=true":function(n){n.beginsWithBond=!0},"beginsWithBond=false":function(n){n.beginsWithBond=!1},"parenthesisLevel++":function(n){n.parenthesisLevel++},"parenthesisLevel--":function(n){n.parenthesisLevel--},"state of aggregation":function(n,e){return{type_:"state of aggregation",p1:J.go(e,"o")}},comma:function(n,e){var t=e.replace(/\s*$/,""),r=t!==e;return r&&n.parenthesisLevel===0?{type_:"comma enumeration L",p1:t}:{type_:"comma enumeration M",p1:t}},output:function(n,e,t){var r;if(!n.r)r=[],!n.a&&!n.b&&!n.p&&!n.o&&!n.q&&!n.d&&!t||(n.sb&&r.push({type_:"entitySkip"}),!n.o&&!n.q&&!n.d&&!n.b&&!n.p&&t!==2?(n.o=n.a,n.a=void 0):!n.o&&!n.q&&!n.d&&(n.b||n.p)?(n.o=n.a,n.d=n.b,n.q=n.p,n.a=n.b=n.p=void 0):n.o&&n.dType==="kv"&&J.patterns.match_("d-oxidation$",n.d||"")?n.dType="oxidation":n.o&&n.dType==="kv"&&!n.q&&(n.dType=void 0),r.push({type_:"chemfive",a:J.go(n.a,"a"),b:J.go(n.b,"bd"),p:J.go(n.p,"pq"),o:J.go(n.o,"o"),q:J.go(n.q,"pq"),d:J.go(n.d,n.dType==="oxidation"?"oxidation":"bd"),dType:n.dType}));else{var o;n.rdt==="M"?o=J.go(n.rd,"tex-math"):n.rdt==="T"?o=[{type_:"text",p1:n.rd||""}]:o=J.go(n.rd);var i;n.rqt==="M"?i=J.go(n.rq,"tex-math"):n.rqt==="T"?i=[{type_:"text",p1:n.rq||""}]:i=J.go(n.rq),r={type_:"arrow",r:n.r,rd:o,rq:i}}for(var s in n)s!=="parenthesisLevel"&&s!=="beginsWithBond"&&delete n[s];return r},"oxidation-output":function(n,e){var t=["{"];return J.concatArray(t,J.go(e,"oxidation")),t.push("}"),t},"frac-output":function(n,e){return{type_:"frac-ce",p1:J.go(e[0]),p2:J.go(e[1])}},"overset-output":function(n,e){return{type_:"overset",p1:J.go(e[0]),p2:J.go(e[1])}},"underset-output":function(n,e){return{type_:"underset",p1:J.go(e[0]),p2:J.go(e[1])}},"underbrace-output":function(n,e){return{type_:"underbrace",p1:J.go(e[0]),p2:J.go(e[1])}},"color-output":function(n,e){return{type_:"color",color1:e[0],color2:J.go(e[1])}},"r=":function(n,e){n.r=e},"rdt=":function(n,e){n.rdt=e},"rd=":function(n,e){n.rd=e},"rqt=":function(n,e){n.rqt=e},"rq=":function(n,e){n.rq=e},operator:function(n,e,t){return{type_:"operator",kind_:t||e}}}},a:{transitions:J.createTransitions({empty:{"*":{}},"1/2$":{0:{action_:"1/2"}},else:{0:{nextState:"1",revisit:!0}},"$(...)$":{"*":{action_:"tex-math tight",nextState:"1"}},",":{"*":{action_:{type_:"insert",option:"commaDecimal"}}},else2:{"*":{action_:"copy"}}}),actions:{}},o:{transitions:J.createTransitions({empty:{"*":{}},"1/2$":{0:{action_:"1/2"}},else:{0:{nextState:"1",revisit:!0}},letters:{"*":{action_:"rm"}},"\\ca":{"*":{action_:{type_:"insert",option:"circa"}}},"\\x{}{}|\\x{}|\\x":{"*":{action_:"copy"}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"{(...)}":{"*":{action_:"{text}"}},else2:{"*":{action_:"copy"}}}),actions:{}},text:{transitions:J.createTransitions({empty:{"*":{action_:"output"}},"{...}":{"*":{action_:"text="}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"\\greek":{"*":{action_:["output","rm"]}},"\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:["output","copy"]}},else:{"*":{action_:"text="}}}),actions:{output:function(n){if(n.text_){var e={type_:"text",p1:n.text_};for(var t in n)delete n[t];return e}}}},pq:{transitions:J.createTransitions({empty:{"*":{}},"state of aggregation $":{"*":{action_:"state of aggregation"}},i$:{0:{nextState:"!f",revisit:!0}},"(KV letters),":{0:{action_:"rm",nextState:"0"}},formula$:{0:{nextState:"f",revisit:!0}},"1/2$":{0:{action_:"1/2"}},else:{0:{nextState:"!f",revisit:!0}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"{(...)}":{"*":{action_:"text"}},"a-z":{f:{action_:"tex-math"}},letters:{"*":{action_:"rm"}},"-9.,9":{"*":{action_:"9,9"}},",":{"*":{action_:{type_:"insert+p1",option:"comma enumeration S"}}},"\\color{(...)}{(...)}1|\\color(...){(...)}2":{"*":{action_:"color-output"}},"\\color{(...)}0":{"*":{action_:"color0-output"}},"\\ce{(...)}":{"*":{action_:"ce"}},"\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"copy"}},else2:{"*":{action_:"copy"}}}),actions:{"state of aggregation":function(n,e){return{type_:"state of aggregation subscript",p1:J.go(e,"o")}},"color-output":function(n,e){return{type_:"color",color1:e[0],color2:J.go(e[1],"pq")}}}},bd:{transitions:J.createTransitions({empty:{"*":{}},x$:{0:{nextState:"!f",revisit:!0}},formula$:{0:{nextState:"f",revisit:!0}},else:{0:{nextState:"!f",revisit:!0}},"-9.,9 no missing 0":{"*":{action_:"9,9"}},".":{"*":{action_:{type_:"insert",option:"electron dot"}}},"a-z":{f:{action_:"tex-math"}},x:{"*":{action_:{type_:"insert",option:"KV x"}}},letters:{"*":{action_:"rm"}},"'":{"*":{action_:{type_:"insert",option:"prime"}}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},"{(...)}":{"*":{action_:"text"}},"\\color{(...)}{(...)}1|\\color(...){(...)}2":{"*":{action_:"color-output"}},"\\color{(...)}0":{"*":{action_:"color0-output"}},"\\ce{(...)}":{"*":{action_:"ce"}},"\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"copy"}},else2:{"*":{action_:"copy"}}}),actions:{"color-output":function(n,e){return{type_:"color",color1:e[0],color2:J.go(e[1],"bd")}}}},oxidation:{transitions:J.createTransitions({empty:{"*":{}},"roman numeral":{"*":{action_:"roman-numeral"}},"${(...)}$|$(...)$":{"*":{action_:"tex-math"}},else:{"*":{action_:"copy"}}}),actions:{"roman-numeral":function(n,e){return{type_:"roman numeral",p1:e||""}}}},"tex-math":{transitions:J.createTransitions({empty:{"*":{action_:"output"}},"\\ce{(...)}":{"*":{action_:["output","ce"]}},"{...}|\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"o="}},else:{"*":{action_:"o="}}}),actions:{output:function(n){if(n.o){var e={type_:"tex-math",p1:n.o};for(var t in n)delete n[t];return e}}}},"tex-math tight":{transitions:J.createTransitions({empty:{"*":{action_:"output"}},"\\ce{(...)}":{"*":{action_:["output","ce"]}},"{...}|\\,|\\x{}{}|\\x{}|\\x":{"*":{action_:"o="}},"-|+":{"*":{action_:"tight operator"}},else:{"*":{action_:"o="}}}),actions:{"tight operator":function(n,e){n.o=(n.o||"")+"{"+e+"}"},output:function(n){if(n.o){var e={type_:"tex-math",p1:n.o};for(var t in n)delete n[t];return e}}}},"9,9":{transitions:J.createTransitions({empty:{"*":{}},",":{"*":{action_:"comma"}},else:{"*":{action_:"copy"}}}),actions:{comma:function(){return{type_:"commaDecimal"}}}},pu:{transitions:J.createTransitions({empty:{"*":{action_:"output"}},space$:{"*":{action_:["output","space"]}},"{[(|)]}":{"0|a":{action_:"copy"}},"(-)(9)^(-9)":{0:{action_:"number^",nextState:"a"}},"(-)(9.,9)(e)(99)":{0:{action_:"enumber",nextState:"a"}},space:{"0|a":{}},"pm-operator":{"0|a":{action_:{type_:"operator",option:"\\pm"},nextState:"0"}},operator:{"0|a":{action_:"copy",nextState:"0"}},"//":{d:{action_:"o=",nextState:"/"}},"/":{d:{action_:"o=",nextState:"/"}},"{...}|else":{"0|d":{action_:"d=",nextState:"d"},a:{action_:["space","d="],nextState:"d"},"/|q":{action_:"q=",nextState:"q"}}}),actions:{enumber:function(n,e){var t=[];return e[0]==="+-"||e[0]==="+/-"?t.push("\\pm "):e[0]&&t.push(e[0]),e[1]&&(J.concatArray(t,J.go(e[1],"pu-9,9")),e[2]&&(e[2].match(/[,.]/)?J.concatArray(t,J.go(e[2],"pu-9,9")):t.push(e[2])),e[3]=e[4]||e[3],e[3]&&(e[3]=e[3].trim(),e[3]==="e"||e[3].substr(0,1)==="*"?t.push({type_:"cdot"}):t.push({type_:"times"}))),e[3]&&t.push("10^{"+e[5]+"}"),t},"number^":function(n,e){var t=[];return e[0]==="+-"||e[0]==="+/-"?t.push("\\pm "):e[0]&&t.push(e[0]),J.concatArray(t,J.go(e[1],"pu-9,9")),t.push("^{"+e[2]+"}"),t},operator:function(n,e,t){return{type_:"operator",kind_:t||e}},space:function(){return{type_:"pu-space-1"}},output:function(n){var e,t=J.patterns.match_("{(...)}",n.d||"");t&&t.remainder===""&&(n.d=t.match_);var r=J.patterns.match_("{(...)}",n.q||"");if(r&&r.remainder===""&&(n.q=r.match_),n.d&&(n.d=n.d.replace(/\u00B0C|\^oC|\^{o}C/g,"{}^{\\circ}C"),n.d=n.d.replace(/\u00B0F|\^oF|\^{o}F/g,"{}^{\\circ}F")),n.q){n.q=n.q.replace(/\u00B0C|\^oC|\^{o}C/g,"{}^{\\circ}C"),n.q=n.q.replace(/\u00B0F|\^oF|\^{o}F/g,"{}^{\\circ}F");var o={d:J.go(n.d,"pu"),q:J.go(n.q,"pu")};n.o==="//"?e={type_:"pu-frac",p1:o.d,p2:o.q}:(e=o.d,o.d.length>1||o.q.length>1?e.push({type_:" / "}):e.push({type_:"/"}),J.concatArray(e,o.q))}else e=J.go(n.d,"pu-2");for(var i in n)delete n[i];return e}}},"pu-2":{transitions:J.createTransitions({empty:{"*":{action_:"output"}},"*":{"*":{action_:["output","cdot"],nextState:"0"}},"\\x":{"*":{action_:"rm="}},space:{"*":{action_:["output","space"],nextState:"0"}},"^{(...)}|^(-1)":{1:{action_:"^(-1)"}},"-9.,9":{0:{action_:"rm=",nextState:"0"},1:{action_:"^(-1)",nextState:"0"}},"{...}|else":{"*":{action_:"rm=",nextState:"1"}}}),actions:{cdot:function(){return{type_:"tight cdot"}},"^(-1)":function(n,e){n.rm+="^{"+e+"}"},space:function(){return{type_:"pu-space-2"}},output:function(n){var e=[];if(n.rm){var t=J.patterns.match_("{(...)}",n.rm||"");t&&t.remainder===""?e=J.go(t.match_,"pu"):e={type_:"rm",p1:n.rm}}for(var r in n)delete n[r];return e}}},"pu-9,9":{transitions:J.createTransitions({empty:{0:{action_:"output-0"},o:{action_:"output-o"}},",":{0:{action_:["output-0","comma"],nextState:"o"}},".":{0:{action_:["output-0","copy"],nextState:"o"}},else:{"*":{action_:"text="}}}),actions:{comma:function(){return{type_:"commaDecimal"}},"output-0":function(n){var e=[];if(n.text_=n.text_||"",n.text_.length>4){var t=n.text_.length%3;t===0&&(t=3);for(var r=n.text_.length-3;r>0;r-=3)e.push(n.text_.substr(r,3)),e.push({type_:"1000 separator"});e.push(n.text_.substr(0,t)),e.reverse()}else e.push(n.text_);for(var o in n)delete n[o];return e},"output-o":function(n){var e=[];if(n.text_=n.text_||"",n.text_.length>4){for(var t=n.text_.length-3,r=0;r<t;r+=3)e.push(n.text_.substr(r,3)),e.push({type_:"1000 separator"});e.push(n.text_.substr(r))}else e.push(n.text_);for(var o in n)delete n[o];return e}}}};var Ve={go:function(n,e){if(!n)return"";for(var t="",r=!1,o=0;o<n.length;o++){var i=n[o];typeof i=="string"?t+=i:(t+=Ve._go2(i),i.type_==="1st-level escape"&&(r=!0))}return!e&&!r&&t&&(t="{"+t+"}"),t},_goInner:function(n){return n&&Ve.go(n,!0)},_go2:function(n){var e;switch(n.type_){case"chemfive":e="";var t={a:Ve._goInner(n.a),b:Ve._goInner(n.b),p:Ve._goInner(n.p),o:Ve._goInner(n.o),q:Ve._goInner(n.q),d:Ve._goInner(n.d)};t.a&&(t.a.match(/^[+\-]/)&&(t.a="{"+t.a+"}"),e+=t.a+"\\,"),(t.b||t.p)&&(e+="{\\vphantom{X}}",e+="^{\\hphantom{"+(t.b||"")+"}}_{\\hphantom{"+(t.p||"")+"}}",e+="{\\vphantom{X}}",e+="^{\\vphantom{2}\\mathllap{"+(t.b||"")+"}}",e+="_{\\vphantom{2}\\mathllap{"+(t.p||"")+"}}"),t.o&&(t.o.match(/^[+\-]/)&&(t.o="{"+t.o+"}"),e+=t.o),n.dType==="kv"?((t.d||t.q)&&(e+="{\\vphantom{X}}"),t.d&&(e+="^{"+t.d+"}"),t.q&&(e+="_{"+t.q+"}")):n.dType==="oxidation"?(t.d&&(e+="{\\vphantom{X}}",e+="^{"+t.d+"}"),t.q&&(e+="{{}}",e+="_{"+t.q+"}")):(t.q&&(e+="{{}}",e+="_{"+t.q+"}"),t.d&&(e+="{{}}",e+="^{"+t.d+"}"));break;case"rm":e="\\mathrm{"+n.p1+"}";break;case"text":n.p1.match(/[\^_]/)?(n.p1=n.p1.replace(" ","~").replace("-","\\text{-}"),e="\\mathrm{"+n.p1+"}"):e="\\text{"+n.p1+"}";break;case"roman numeral":e="\\mathrm{"+n.p1+"}";break;case"state of aggregation":e="\\mskip2mu "+Ve._goInner(n.p1);break;case"state of aggregation subscript":e="\\mskip1mu "+Ve._goInner(n.p1);break;case"bond":if(e=Ve._getBond(n.kind_),!e)throw["MhchemErrorBond","mhchem Error. Unknown bond type ("+n.kind_+")"];break;case"frac":var r="\\frac{"+n.p1+"}{"+n.p2+"}";e="\\mathchoice{\\textstyle"+r+"}{"+r+"}{"+r+"}{"+r+"}";break;case"pu-frac":var o="\\frac{"+Ve._goInner(n.p1)+"}{"+Ve._goInner(n.p2)+"}";e="\\mathchoice{\\textstyle"+o+"}{"+o+"}{"+o+"}{"+o+"}";break;case"tex-math":e=n.p1+" ";break;case"frac-ce":e="\\frac{"+Ve._goInner(n.p1)+"}{"+Ve._goInner(n.p2)+"}";break;case"overset":e="\\overset{"+Ve._goInner(n.p1)+"}{"+Ve._goInner(n.p2)+"}";break;case"underset":e="\\underset{"+Ve._goInner(n.p1)+"}{"+Ve._goInner(n.p2)+"}";break;case"underbrace":e="\\underbrace{"+Ve._goInner(n.p1)+"}_{"+Ve._goInner(n.p2)+"}";break;case"color":e="{\\color{"+n.color1+"}{"+Ve._goInner(n.color2)+"}}";break;case"color0":e="\\color{"+n.color+"}";break;case"arrow":var i={rd:Ve._goInner(n.rd),rq:Ve._goInner(n.rq)},s=Ve._getArrow(n.r);i.rq&&(s+="[{\\rm "+i.rq+"}]"),i.rd?s+="{\\rm "+i.rd+"}":s+="{}",e=s;break;case"operator":e=Ve._getOperator(n.kind_);break;case"1st-level escape":e=n.p1+" ";break;case"space":e=" ";break;case"entitySkip":e="~";break;case"pu-space-1":e="~";break;case"pu-space-2":e="\\mkern3mu ";break;case"1000 separator":e="\\mkern2mu ";break;case"commaDecimal":e="{,}";break;case"comma enumeration L":e="{"+n.p1+"}\\mkern6mu ";break;case"comma enumeration M":e="{"+n.p1+"}\\mkern3mu ";break;case"comma enumeration S":e="{"+n.p1+"}\\mkern1mu ";break;case"hyphen":e="\\text{-}";break;case"addition compound":e="\\,{\\cdot}\\,";break;case"electron dot":e="\\mkern1mu \\text{\\textbullet}\\mkern1mu ";break;case"KV x":e="{\\times}";break;case"prime":e="\\prime ";break;case"cdot":e="\\cdot ";break;case"tight cdot":e="\\mkern1mu{\\cdot}\\mkern1mu ";break;case"times":e="\\times ";break;case"circa":e="{\\sim}";break;case"^":e="uparrow";break;case"v":e="downarrow";break;case"ellipsis":e="\\ldots ";break;case"/":e="/";break;case" / ":e="\\,/\\,";break;default:throw["MhchemBugT","mhchem bug T. Please report."]}return e},_getArrow:function(n){switch(n){case"->":return"\\yields";case"â†’":return"\\yields";case"âŸ¶":return"\\yields";case"<-":return"\\yieldsLeft";case"<->":return"\\mesomerism";case"<-->":return"\\yieldsLeftRight";case"<=>":return"\\chemequilibrium";case"â‡Œ":return"\\chemequilibrium";case"<=>>":return"\\equilibriumRight";case"<<=>":return"\\equilibriumLeft";default:throw["MhchemBugT","mhchem bug T. Please report."]}},_getBond:function(n){switch(n){case"-":return"{-}";case"1":return"{-}";case"=":return"{=}";case"2":return"{=}";case"#":return"{\\equiv}";case"3":return"{\\equiv}";case"~":return"{\\tripleDash}";case"~-":return"{\\tripleDashOverLine}";case"~=":return"{\\tripleDashOverDoubleLine}";case"~--":return"{\\tripleDashOverDoubleLine}";case"-~-":return"{\\tripleDashBetweenDoubleLine}";case"...":return"{{\\cdot}{\\cdot}{\\cdot}}";case"....":return"{{\\cdot}{\\cdot}{\\cdot}{\\cdot}}";case"->":return"{\\rightarrow}";case"<-":return"{\\leftarrow}";case"<":return"{<}";case">":return"{>}";default:throw["MhchemBugT","mhchem bug T. Please report."]}},_getOperator:function(n){switch(n){case"+":return" {}+{} ";case"-":return" {}-{} ";case"=":return" {}={} ";case"<":return" {}<{} ";case">":return" {}>{} ";case"<<":return" {}\\ll{} ";case">>":return" {}\\gg{} ";case"\\pm":return" {}\\pm{} ";case"\\approx":return" {}\\approx{} ";case"$\\approx$":return" {}\\approx{} ";case"v":return" \\downarrow{} ";case"(v)":return" \\downarrow{} ";case"^":return" \\uparrow{} ";case"(^)":return" \\uparrow{} ";default:throw["MhchemBugT","mhchem bug T. Please report."]}}};E("\\darr","\\downarrow");E("\\dArr","\\Downarrow");E("\\Darr","\\Downarrow");E("\\lang","\\langle");E("\\rang","\\rangle");E("\\uarr","\\uparrow");E("\\uArr","\\Uparrow");E("\\Uarr","\\Uparrow");E("\\N","\\mathbb{N}");E("\\R","\\mathbb{R}");E("\\Z","\\mathbb{Z}");E("\\alef","\\aleph");E("\\alefsym","\\aleph");E("\\bull","\\bullet");E("\\clubs","\\clubsuit");E("\\cnums","\\mathbb{C}");E("\\Complex","\\mathbb{C}");E("\\Dagger","\\ddagger");E("\\diamonds","\\diamondsuit");E("\\empty","\\emptyset");E("\\exist","\\exists");E("\\harr","\\leftrightarrow");E("\\hArr","\\Leftrightarrow");E("\\Harr","\\Leftrightarrow");E("\\hearts","\\heartsuit");E("\\image","\\Im");E("\\infin","\\infty");E("\\isin","\\in");E("\\larr","\\leftarrow");E("\\lArr","\\Leftarrow");E("\\Larr","\\Leftarrow");E("\\lrarr","\\leftrightarrow");E("\\lrArr","\\Leftrightarrow");E("\\Lrarr","\\Leftrightarrow");E("\\natnums","\\mathbb{N}");E("\\plusmn","\\pm");E("\\rarr","\\rightarrow");E("\\rArr","\\Rightarrow");E("\\Rarr","\\Rightarrow");E("\\real","\\Re");E("\\reals","\\mathbb{R}");E("\\Reals","\\mathbb{R}");E("\\sdot","\\cdot");E("\\sect","\\S");E("\\spades","\\spadesuit");E("\\sub","\\subset");E("\\sube","\\subseteq");E("\\supe","\\supseteq");E("\\thetasym","\\vartheta");E("\\weierp","\\wp");E("\\quantity","{\\left\\{ #1 \\right\\}}");E("\\qty","{\\left\\{ #1 \\right\\}}");E("\\pqty","{\\left( #1 \\right)}");E("\\bqty","{\\left[ #1 \\right]}");E("\\vqty","{\\left\\vert #1 \\right\\vert}");E("\\Bqty","{\\left\\{ #1 \\right\\}}");E("\\absolutevalue","{\\left\\vert #1 \\right\\vert}");E("\\abs","{\\left\\vert #1 \\right\\vert}");E("\\norm","{\\left\\Vert #1 \\right\\Vert}");E("\\evaluated","{\\left.#1 \\right\\vert}");E("\\eval","{\\left.#1 \\right\\vert}");E("\\order","{\\mathcal{O} \\left( #1 \\right)}");E("\\commutator","{\\left[ #1 , #2 \\right]}");E("\\comm","{\\left[ #1 , #2 \\right]}");E("\\anticommutator","{\\left\\{ #1 , #2 \\right\\}}");E("\\acomm","{\\left\\{ #1 , #2 \\right\\}}");E("\\poissonbracket","{\\left\\{ #1 , #2 \\right\\}}");E("\\pb","{\\left\\{ #1 , #2 \\right\\}}");E("\\vectorbold","{\\boldsymbol{ #1 }}");E("\\vb","{\\boldsymbol{ #1 }}");E("\\vectorarrow","{\\vec{\\boldsymbol{ #1 }}}");E("\\va","{\\vec{\\boldsymbol{ #1 }}}");E("\\vectorunit","{{\\boldsymbol{\\hat{ #1 }}}}");E("\\vu","{{\\boldsymbol{\\hat{ #1 }}}}");E("\\dotproduct","\\mathbin{\\boldsymbol\\cdot}");E("\\vdot","{\\boldsymbol\\cdot}");E("\\crossproduct","\\mathbin{\\boldsymbol\\times}");E("\\cross","\\mathbin{\\boldsymbol\\times}");E("\\cp","\\mathbin{\\boldsymbol\\times}");E("\\gradient","{\\boldsymbol\\nabla}");E("\\grad","{\\boldsymbol\\nabla}");E("\\divergence","{\\grad\\vdot}");E("\\curl","{\\grad\\cross}");E("\\laplacian","\\nabla^2");E("\\tr","{\\operatorname{tr}}");E("\\Tr","{\\operatorname{Tr}}");E("\\rank","{\\operatorname{rank}}");E("\\erf","{\\operatorname{erf}}");E("\\Res","{\\operatorname{Res}}");E("\\principalvalue","{\\mathcal{P}}");E("\\pv","{\\mathcal{P}}");E("\\PV","{\\operatorname{P.V.}}");E("\\qqtext","{\\quad\\text{ #1 }\\quad}");E("\\qq","{\\quad\\text{ #1 }\\quad}");E("\\qcomma","{\\text{,}\\quad}");E("\\qc","{\\text{,}\\quad}");E("\\qcc","{\\quad\\text{c.c.}\\quad}");E("\\qif","{\\quad\\text{if}\\quad}");E("\\qthen","{\\quad\\text{then}\\quad}");E("\\qelse","{\\quad\\text{else}\\quad}");E("\\qotherwise","{\\quad\\text{otherwise}\\quad}");E("\\qunless","{\\quad\\text{unless}\\quad}");E("\\qgiven","{\\quad\\text{given}\\quad}");E("\\qusing","{\\quad\\text{using}\\quad}");E("\\qassume","{\\quad\\text{assume}\\quad}");E("\\qsince","{\\quad\\text{since}\\quad}");E("\\qlet","{\\quad\\text{let}\\quad}");E("\\qfor","{\\quad\\text{for}\\quad}");E("\\qall","{\\quad\\text{all}\\quad}");E("\\qeven","{\\quad\\text{even}\\quad}");E("\\qodd","{\\quad\\text{odd}\\quad}");E("\\qinteger","{\\quad\\text{integer}\\quad}");E("\\qand","{\\quad\\text{and}\\quad}");E("\\qor","{\\quad\\text{or}\\quad}");E("\\qas","{\\quad\\text{as}\\quad}");E("\\qin","{\\quad\\text{in}\\quad}");E("\\differential","{\\text{d}}");E("\\dd","{\\text{d}}");E("\\derivative","{\\frac{\\text{d}{ #1 }}{\\text{d}{ #2 }}}");E("\\dv","{\\frac{\\text{d}{ #1 }}{\\text{d}{ #2 }}}");E("\\partialderivative","{\\frac{\\partial{ #1 }}{\\partial{ #2 }}}");E("\\variation","{\\delta}");E("\\var","{\\delta}");E("\\functionalderivative","{\\frac{\\delta{ #1 }}{\\delta{ #2 }}}");E("\\fdv","{\\frac{\\delta{ #1 }}{\\delta{ #2 }}}");E("\\innerproduct","{\\left\\langle {#1} \\mid { #2} \\right\\rangle}");E("\\outerproduct","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");E("\\dyad","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");E("\\ketbra","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");E("\\op","{\\left\\vert { #1 } \\right\\rangle\\left\\langle { #2} \\right\\vert}");E("\\expectationvalue","{\\left\\langle {#1 } \\right\\rangle}");E("\\expval","{\\left\\langle {#1 } \\right\\rangle}");E("\\ev","{\\left\\langle {#1 } \\right\\rangle}");E("\\matrixelement","{\\left\\langle{ #1 }\\right\\vert{ #2 }\\left\\vert{#3}\\right\\rangle}");E("\\matrixel","{\\left\\langle{ #1 }\\right\\vert{ #2 }\\left\\vert{#3}\\right\\rangle}");E("\\mel","{\\left\\langle{ #1 }\\right\\vert{ #2 }\\left\\vert{#3}\\right\\rangle}");function ya(n){const e=[];n.consumeSpaces();let t=n.fetch().text;for(t==="\\relax"&&(n.consume(),n.consumeSpaces(),t=n.fetch().text);t==="\\hline"||t==="\\hdashline";)n.consume(),e.push(t==="\\hdashline"),n.consumeSpaces(),t=n.fetch().text;return e}const Vr=n=>{if(!n.parser.settings.displayMode)throw new Q(`{${n.envName}} can be used only in display mode.`)},Bu=/([-+]?) *(\d+(?:\.\d*)?|\.\d+) *([a-z]{2})/,wc=n=>{let e=n.get("\\arraystretch");typeof e!="string"&&(e=Hi(e.tokens)),e=isNaN(e)?null:Number(e);let t=n.get("\\arraycolsep");typeof t!="string"&&(t=Hi(t.tokens));const r=Bu.exec(t),o=r?{number:+(r[1]+r[2]),unit:r[3]}:null;return[e,o]},wa=n=>{let e="";for(let t=0;t<n.length;t++)if(n[t].type==="label"){if(e)throw new Q("Multiple \\labels in one row");e=n[t].string}return e};function qs(n){if(n.indexOf("ed")===-1)return n.indexOf("*")===-1}function ln(n,{cols:e,envClasses:t,autoTag:r,singleRow:o,emptySingleRow:i,maxNumCols:s,leqno:a,arraystretch:l,arraycolsep:d},u){const m=t&&t.includes("bordermatrix")?"}":"\\end";n.gullet.beginGroup(),o||n.gullet.macros.set("\\cr","\\\\\\relax"),n.gullet.beginGroup();let p=[];const f=[p],g=[],b=[],w=[],v=r!=null?[]:void 0;function S(){r&&n.gullet.macros.set("\\@eqnsw","1",!0)}function C(){v&&(n.gullet.macros.get("\\df@tag")?(v.push(n.subparse([new Qt("\\df@tag")])),n.gullet.macros.set("\\df@tag",void 0,!0)):v.push(!!r&&n.gullet.macros.get("\\@eqnsw")==="1"))}for(S(),w.push(ya(n));;){let L=n.parseExpression(!1,o?"\\end":"\\\\");n.gullet.endGroup(),n.gullet.beginGroup(),L={type:"ordgroup",mode:n.mode,body:L,semisimple:!0},p.push(L);const I=n.fetch().text;if(I==="&"){if(s&&p.length===s)if(t.includes("array")){if(n.settings.strict)throw new Q("Too few columns specified in the {array} column argument.",n.nextToken)}else throw s===2?new Q("The split environment accepts no more than two columns",n.nextToken):new Q("The equation environment accepts only one column",n.nextToken);n.consume()}else if(I===m){C(),p.length===1&&L.body.length===0&&(f.length>1||!i)&&f.pop(),b.push(wa(L.body)),w.length<f.length+1&&w.push([]);break}else if(I==="\\\\"){n.consume();let R;n.gullet.future().text!==" "&&(R=n.parseSizeGroup(!0)),g.push(R?R.value:null),C(),b.push(wa(L.body)),w.push(ya(n)),p=[],f.push(p),S()}else throw new Q("Expected & or \\\\ or \\cr or "+m,n.nextToken)}return n.gullet.endGroup(),n.gullet.endGroup(),{type:"array",mode:n.mode,body:f,cols:e,rowGaps:g,hLinesBeforeRow:w,envClasses:t,autoTag:r,scriptLevel:u,tags:v,labels:b,leqno:a,arraystretch:l,arraycolsep:d}}function xc(n){return n.slice(0,1)==="d"?"display":"text"}const $u={c:"center ",l:"left ",r:"right "},xa=n=>{const e=new P("mtd",[]);return e.style={padding:"0",width:"50%"},n.envClasses.includes("multline")&&(e.style.width="7.5%"),e},Vt=function(n,e){const t=[],r=n.body.length,o=n.hLinesBeforeRow,i=n.tags&&n.tags.some(d=>d);for(let d=0;d<r;d++){const u=n.body[d],m=[],p=n.scriptLevel==="text"?lt.TEXT:n.scriptLevel==="script"?lt.SCRIPT:lt.DISPLAY;for(let v=0;v<u.length;v++){const S=new P("mtd",[qe(u[v],e.withLevel(p))]);if(n.envClasses.includes("multline")){const C=d===0?"left":d===r-1?"right":"center";C!=="center"&&S.classes.push("tml-"+C)}m.push(S)}const f=n.body[0].length;for(let v=0;v<f-u.length;v++)m.push(new P("mtd",[],[],e));if(i){const v=n.tags[d];let S;v===!0?S=new P("mtext",[new lc(["tml-eqn"])]):v===!1?S=new P("mtext",[],[]):(S=Tn(v[0].body,e.withLevel(p),!0),S=qo(S),S.classes=["tml-tag"]),S&&(m.unshift(xa(n)),m.push(xa(n)),n.leqno?m[0].children.push(S):m[m.length-1].children.push(S))}const g=new P("mtr",m,[]),b=n.labels.shift();b&&n.tags&&n.tags[d]&&(g.setAttribute("id",b),Array.isArray(n.tags[d])&&g.classes.push("tml-tageqn")),d===0&&o[0].length>0&&(o[0].length===2?g.children.forEach(v=>{v.style.borderTop="0.15em double"}):g.children.forEach(v=>{v.style.borderTop=o[0][0]?"0.06em dashed":"0.06em solid"})),o[d+1].length>0&&(o[d+1].length===2?g.children.forEach(v=>{v.style.borderBottom="0.15em double"}):g.children.forEach(v=>{v.style.borderBottom=o[d+1][0]?"0.06em dashed":"0.06em solid"}));let w=!0;for(let v=0;v<g.children.length;v++){const S=g.children[v].children[0];if(!(S&&S.type==="mpadded"&&S.attributes.height==="0px")){w=!1;break}}if(w)for(let v=0;v<g.children.length;v++)g.children[v].style.display="block",g.children[v].style.height="0",g.children[v].style.paddingTop="0",g.children[v].style.paddingBottom="0";t.push(g)}if(n.arraystretch&&n.arraystretch!==1){const d=String(1.4*n.arraystretch-.8)+"ex";for(let u=0;u<t.length;u++)for(let m=0;m<t[u].children.length;m++)t[u].children[m].style.paddingTop=d,t[u].children[m].style.paddingBottom=d}let s,a;if(n.envClasses.length>0&&(s=n.envClasses.includes("abut")||n.envClasses.includes("cases")?"0":n.envClasses.includes("small")?"0.1389":n.envClasses.includes("cd")?"0.25":"0.4",a="em"),n.arraycolsep){const d=an(n.arraycolsep,e);s=d.number.toFixed(4),a=d.unit}if(s){const d=t.length===0?0:t[0].children.length,u=(m,p)=>m===0&&p===0||m===d-1&&p===1?"0":n.envClasses[0]!=="align"?s:p===1?"0":i?m%2?"1":"0":m%2?"0":"1";for(let m=0;m<t.length;m++)for(let p=0;p<t[m].children.length;p++)t[m].children[p].style.paddingLeft=`${u(p,0)}${a}`,t[m].children[p].style.paddingRight=`${u(p,1)}${a}`}if(n.envClasses.length===0)for(let d=0;d<t.length;d++)t[d].children[0].style.paddingLeft="0em",t[d].children.length===t[0].children.length&&(t[d].children[t[d].children.length-1].style.paddingRight="0em");if(n.envClasses.length>0){const d=n.envClasses.includes("align")||n.envClasses.includes("alignat");for(let u=0;u<t.length;u++){const m=t[u];if(d){for(let p=0;p<m.children.length;p++)m.children[p].classes=["tml-"+(p%2?"left":"right")];if(i){const p=n.leqno?0:m.children.length-1;m.children[p].classes=[]}}if(m.children.length>1&&n.envClasses.includes("cases")&&(m.children[1].style.paddingLeft="1em"),n.envClasses.includes("cases")||n.envClasses.includes("subarray"))for(const p of m.children)p.classes.push("tml-left")}}let l=new P("mtable",t);if(n.envClasses.length>0&&(n.envClasses.includes("jot")?l.classes.push("tml-jot"):n.envClasses.includes("small")&&l.classes.push("tml-small")),n.scriptLevel==="display"&&l.setAttribute("displaystyle","true"),(n.autoTag||n.envClasses.includes("multline"))&&(l.style.width="100%"),n.cols&&n.cols.length>0){const d=n.cols;let u=!1,m=0,p=d.length;for(;d[m].type==="separator";)m+=1;for(;d[p-1].type==="separator";)p-=1;if(d[0].type==="separator"){const g=d[1].type==="separator"?"0.15em double":d[0].separator==="|"?"0.06em solid ":"0.06em dashed ";for(const b of l.children)b.children[0].style.borderLeft=g}let f=i?0:-1;for(let g=m;g<p;g++)if(d[g].type==="align"){const b=$u[d[g].align];f+=1;for(const w of l.children)b.trim()!=="center"&&f<w.children.length&&(w.children[f].classes=["tml-"+b.trim()]);u=!0}else if(d[g].type==="separator"){if(u){const b=d[g+1].type==="separator"?"0.15em double":d[g].separator==="|"?"0.06em solid":"0.06em dashed";for(const w of l.children)f<w.children.length&&(w.children[f].style.borderRight=b)}u=!1}if(d[d.length-1].type==="separator"){const g=d[d.length-2].type==="separator"?"0.15em double":d[d.length-1].separator==="|"?"0.06em solid":"0.06em dashed";for(const b of l.children)b.children[b.children.length-1].style.borderRight=g,b.children[b.children.length-1].style.paddingRight="0.4em"}}return n.envClasses.includes("small")&&(l=new P("mstyle",[l]),l.setAttribute("scriptlevel","1")),l},Sc=function(n,e){n.envName.indexOf("ed")===-1&&Vr(n);const t=n.envName==="split",r=[],o=ln(n.parser,{cols:r,emptySingleRow:!0,autoTag:t?void 0:qs(n.envName),envClasses:["abut","jot"],maxNumCols:n.envName==="split"?2:void 0,leqno:n.parser.settings.leqno},"display");let i,s=0;const a=n.envName.indexOf("at")>-1;if(e[0]&&a){let l="";for(let d=0;d<e[0].body.length;d++){const u=_e(e[0].body[d],"textord");l+=u.text}if(isNaN(l))throw new Q("The alignat enviroment requires a numeric first argument.");i=Number(l),s=i*2}o.body.forEach(function(l){if(a){const d=l.length/2;if(i<d)throw new Q(`Too many math in a row: expected ${i}, but got ${d}`,l[0])}else s<l.length&&(s=l.length)});for(let l=0;l<s;++l){let d="r";l%2===1&&(d="l"),r[l]={type:"align",align:d}}return n.envName==="split"||(a?o.envClasses.push("alignat"):o.envClasses[0]="align"),o};Wt({type:"array",names:["array","darray"],props:{numArgs:1},handler(n,e){const o=(Uo(e[0])?[e[0]]:_e(e[0],"ordgroup").body).map(function(l){const u=Rs(l).text;if("lcr".indexOf(u)!==-1)return{type:"align",align:u};if(u==="|")return{type:"separator",separator:"|"};if(u===":")return{type:"separator",separator:":"};throw new Q("Unknown column alignment: "+u,l)}),[i,s]=wc(n.parser.gullet.macros),a={cols:o,envClasses:["array"],maxNumCols:o.length,arraystretch:i,arraycolsep:s};return ln(n.parser,a,xc(n.envName))},mathmlBuilder:Vt});Wt({type:"array",names:["matrix","pmatrix","bmatrix","Bmatrix","vmatrix","Vmatrix","matrix*","pmatrix*","bmatrix*","Bmatrix*","vmatrix*","Vmatrix*"],props:{numArgs:0},handler(n){const e={matrix:null,pmatrix:["(",")"],bmatrix:["[","]"],Bmatrix:["\\{","\\}"],vmatrix:["|","|"],Vmatrix:["\\Vert","\\Vert"]}[n.envName.replace("*","")];let t="c";const r={envClasses:[],cols:[]};if(n.envName.charAt(n.envName.length-1)==="*"){const a=n.parser;if(a.consumeSpaces(),a.fetch().text==="["){if(a.consume(),a.consumeSpaces(),t=a.fetch().text,"lcr".indexOf(t)===-1)throw new Q("Expected l or c or r",a.nextToken);a.consume(),a.consumeSpaces(),a.expect("]"),a.consume(),r.cols=[]}}const o=ln(n.parser,r,"text");o.cols=o.body.length>0?new Array(o.body[0].length).fill({type:"align",align:t}):[];const[i,s]=wc(n.parser.gullet.macros);return o.arraystretch=i,s&&!(s===6&&s==="pt")&&(o.arraycolsep=s),e?{type:"leftright",mode:n.mode,body:[o],left:e[0],right:e[1],rightColor:void 0}:o},mathmlBuilder:Vt});Wt({type:"array",names:["bordermatrix"],props:{numArgs:0},handler(n){const e={cols:[],envClasses:["bordermatrix"]},t=ln(n.parser,e,"text");return t.cols=t.body.length>0?new Array(t.body[0].length).fill({type:"align",align:"c"}):[],t.envClasses=[],t.arraystretch=1,n.envName==="matrix"?t:Ru(t,n.delimiters)},mathmlBuilder:Vt});Wt({type:"array",names:["smallmatrix"],props:{numArgs:0},handler(n){const e={envClasses:["small"]};return ln(n.parser,e,"script")},mathmlBuilder:Vt});Wt({type:"array",names:["subarray"],props:{numArgs:1},handler(n,e){const o=(Uo(e[0])?[e[0]]:_e(e[0],"ordgroup").body).map(function(s){const l=Rs(s).text;if("lc".indexOf(l)!==-1)return{type:"align",align:l};throw new Q("Unknown column alignment: "+l,s)});if(o.length>1)throw new Q("{subarray} can contain only one column");let i={cols:o,envClasses:["small"]};if(i=ln(n.parser,i,"script"),i.body.length>0&&i.body[0].length>1)throw new Q("{subarray} can contain only one column");return i},mathmlBuilder:Vt});Wt({type:"array",names:["cases","dcases","rcases","drcases"],props:{numArgs:0},handler(n){const e={cols:[],envClasses:["cases"]},t=ln(n.parser,e,xc(n.envName));return{type:"leftright",mode:n.mode,body:[t],left:n.envName.indexOf("r")>-1?".":"\\{",right:n.envName.indexOf("r")>-1?"\\}":".",rightColor:void 0}},mathmlBuilder:Vt});Wt({type:"array",names:["align","align*","aligned","split"],props:{numArgs:0},handler:Sc,mathmlBuilder:Vt});Wt({type:"array",names:["alignat","alignat*","alignedat"],props:{numArgs:1},handler:Sc,mathmlBuilder:Vt});Wt({type:"array",names:["gathered","gather","gather*"],props:{numArgs:0},handler(n){n.envName!=="gathered"&&Vr(n);const e={cols:[],envClasses:["abut","jot"],autoTag:qs(n.envName),emptySingleRow:!0,leqno:n.parser.settings.leqno};return ln(n.parser,e,"display")},mathmlBuilder:Vt});Wt({type:"array",names:["equation","equation*"],props:{numArgs:0},handler(n){Vr(n);const e={autoTag:qs(n.envName),emptySingleRow:!0,singleRow:!0,maxNumCols:1,envClasses:["align"],leqno:n.parser.settings.leqno};return ln(n.parser,e,"display")},mathmlBuilder:Vt});Wt({type:"array",names:["multline","multline*"],props:{numArgs:0},handler(n){Vr(n);const e={autoTag:n.envName==="multline",maxNumCols:1,envClasses:["jot","multline"],leqno:n.parser.settings.leqno};return ln(n.parser,e,"display")},mathmlBuilder:Vt});Wt({type:"array",names:["CD"],props:{numArgs:0},handler(n){return Vr(n),Ou(n.parser)},mathmlBuilder:Vt});ue({type:"text",names:["\\hline","\\hdashline"],props:{numArgs:0,allowedInText:!0,allowedInMath:!0},handler(n,e){throw new Q(`${n.funcName} valid only within array environment`)}});const Gi=pc;ue({type:"bordermatrix",names:["\\bordermatrix","\\matrix"],props:{numArgs:0,numOptionalArgs:1},handler:({parser:n,funcName:e},t,r)=>{let o=["(",")"];if(e==="\\bordermatrix"&&r[0]&&r[0].body){const l=r[0].body;l.length===2&&l[0].type==="atom"&&l[1].type==="atom"&&l[0].family==="open"&&l[1].family==="close"&&(o=[l[0].text,l[1].text])}n.consumeSpaces(),n.consume();const i=Gi.bordermatrix,s={mode:n.mode,envName:e.slice(1),delimiters:o,parser:n},a=i.handler(s);return n.expect("}",!0),a}});ue({type:"cancelto",names:["\\cancelto"],props:{numArgs:2},handler({parser:n},e){const t=e[0],r=e[1];return{type:"cancelto",mode:n.mode,body:r,to:t,isCharacterBox:$o(r)}},mathmlBuilder(n,e){const t=new P("mrow",[qe(n.body,e)],["ff-narrow"]),r=new P("mphantom",[qe(n.body,e)]),o=new P("mrow",[r],["tml-cancelto"]);n.isCharacterBox&&sc.indexOf(n.body.body[0].text)>-1&&(o.style.left="0.1em",o.style.width="90%");const i=new P("mrow",[t,o],["menclose"]);if(!n.isCharacterBox||/[fâˆ«âˆ‘]/.test(n.body.body[0].text))r.style.paddingRight="0.2em";else{r.style.padding="0.5ex 0.1em 0 0";const m=new P("mspace",[]);m.setAttribute("height","0.85em"),t.children.push(m)}let s;if(n.isCharacterBox)s=new P("mspace",[]),s.setAttribute("height","1em");else{const m=qe(n.body,e),p=new P("mpadded",[m]);p.setAttribute("width","0.1px"),s=new P("mphantom",[p])}const a=qe(n.to,e),l=new P("mpadded",[a]);if(!n.isCharacterBox||/[fâˆ«âˆ‘]/.test(n.body.body[0].text)){const m=new P("mspace",[]);m.setAttribute("width","0.2em"),l.children.unshift(m)}l.setAttribute("width","0.1px");const d=new P("mover",[s,l]),u=new P("mrow",[],["ff-nudge-left"]);return Ln([zo([i,d]),u])}});ue({type:"textord",names:["\\@char"],props:{numArgs:1,allowedInText:!0},handler({parser:n,token:e},t){const o=_e(t[0],"ordgroup").body;let i="";for(let a=0;a<o.length;a++){const l=_e(o[a],"textord");i+=l.text}const s=parseInt(i);if(isNaN(s))throw new Q(`\\@char has non-numeric argument ${i}`,e);return{type:"textord",mode:n.mode,text:String.fromCodePoint(s)}}});const qu=/^(#[a-f0-9]{3}|#?[a-f0-9]{6})$/i,zu=/^(#[a-f0-9]{3}|#?[a-f0-9]{6}|[a-z]+)$/i,Uu=/^ *\d{1,3} *(?:, *\d{1,3} *){2}$/,Hu=/^ *[10](?:\.\d*)? *(?:, *[10](?:\.\d*)? *){2}$/,Gu=/^[a-f0-9]{6}$/i,Sa=n=>{let e=n.toString(16);return e.length===1&&(e="0"+e),e},Ea=JSON.parse(`{
  "Apricot": "#ffb484",
  "Aquamarine": "#08b4bc",
  "Bittersweet": "#c84c14",
  "blue": "#0000FF",
  "Blue": "#303494",
  "BlueGreen": "#08b4bc",
  "BlueViolet": "#503c94",
  "BrickRed": "#b8341c",
  "brown": "#BF8040",
  "Brown": "#802404",
  "BurntOrange": "#f8941c",
  "CadetBlue": "#78749c",
  "CarnationPink": "#f884b4",
  "Cerulean": "#08a4e4",
  "CornflowerBlue": "#40ace4",
  "cyan": "#00FFFF",
  "Cyan": "#08acec",
  "Dandelion": "#ffbc44",
  "darkgray": "#404040",
  "DarkOrchid": "#a8548c",
  "Emerald": "#08ac9c",
  "ForestGreen": "#089c54",
  "Fuchsia": "#90348c",
  "Goldenrod": "#ffdc44",
  "gray": "#808080",
  "Gray": "#98949c",
  "green": "#00FF00",
  "Green": "#08a44c",
  "GreenYellow": "#e0e474",
  "JungleGreen": "#08ac9c",
  "Lavender": "#f89cc4",
  "lightgray": "#c0c0c0",
  "lime": "#BFFF00",
  "LimeGreen": "#90c43c",
  "magenta": "#FF00FF",
  "Magenta": "#f0048c",
  "Mahogany": "#b0341c",
  "Maroon": "#b03434",
  "Melon": "#f89c7c",
  "MidnightBlue": "#086494",
  "Mulberry": "#b03c94",
  "NavyBlue": "#086cbc",
  "olive": "#7F7F00",
  "OliveGreen": "#407c34",
  "orange": "#FF8000",
  "Orange": "#f8843c",
  "OrangeRed": "#f0145c",
  "Orchid": "#b074ac",
  "Peach": "#f8945c",
  "Periwinkle": "#8074bc",
  "PineGreen": "#088c74",
  "pink": "#ff7f7f",
  "Plum": "#98248c",
  "ProcessBlue": "#08b4ec",
  "purple": "#BF0040",
  "Purple": "#a0449c",
  "RawSienna": "#983c04",
  "red": "#ff0000",
  "Red": "#f01c24",
  "RedOrange": "#f86434",
  "RedViolet": "#a0246c",
  "Rhodamine": "#f0549c",
  "Royallue": "#0874bc",
  "RoyalPurple": "#683c9c",
  "RubineRed": "#f0047c",
  "Salmon": "#f8948c",
  "SeaGreen": "#30bc9c",
  "Sepia": "#701404",
  "SkyBlue": "#48c4dc",
  "SpringGreen": "#c8dc64",
  "Tan": "#e09c74",
  "teal": "#007F7F",
  "TealBlue": "#08acb4",
  "Thistle": "#d884b4",
  "Turquoise": "#08b4cc",
  "violet": "#800080",
  "Violet": "#60449c",
  "VioletRed": "#f054a4",
  "WildStrawberry": "#f0246c",
  "yellow": "#FFFF00",
  "Yellow": "#fff404",
  "YellowGreen": "#98cc6c",
  "YellowOrange": "#ffa41c"
}`),nr=(n,e)=>{let t="";if(n==="HTML"){if(!qu.test(e))throw new Q("Invalid HTML input.");t=e}else if(n==="RGB"){if(!Uu.test(e))throw new Q("Invalid RGB input.");e.split(",").map(r=>{t+=Sa(Number(r.trim()))})}else{if(!Hu.test(e))throw new Q("Invalid rbg input.");e.split(",").map(r=>{const o=Number(r.trim());if(o>1)throw new Q("Color rgb input must be < 1.");t+=Sa(Number((o*255).toFixed(0)))})}return t.charAt(0)!=="#"&&(t="#"+t),t},qr=(n,e,t)=>{const r=`\\\\color@${n}`;if(!zu.exec(n))throw new Q("Invalid color: '"+n+"'",t);return Gu.test(n)?"#"+n:(n.charAt(0)==="#"||(e.has(r)?n=e.get(r).tokens[0].text:Ea[n]&&(n=Ea[n])),n)},Ec=(n,e)=>{let t=kt(n.body,e.withColor(n.color));return t.length===0&&t.push(new P("mrow")),t=t.map(r=>(r.style.color=n.color,r)),Ln(t)};ue({type:"color",names:["\\textcolor"],props:{numArgs:2,numOptionalArgs:1,allowedInText:!0,argTypes:["raw","raw","original"]},handler({parser:n,token:e},t,r){const o=r[0]&&_e(r[0],"raw").string;let i="";if(o){const a=_e(t[0],"raw").string;i=nr(o,a)}else i=qr(_e(t[0],"raw").string,n.gullet.macros,e);const s=t[1];return{type:"color",mode:n.mode,color:i,isTextColor:!0,body:ht(s)}},mathmlBuilder:Ec});ue({type:"color",names:["\\color"],props:{numArgs:1,numOptionalArgs:1,allowedInText:!0,argTypes:["raw","raw"]},handler({parser:n,breakOnTokenText:e,token:t},r,o){const i=o[0]&&_e(o[0],"raw").string;let s="";if(i){const l=_e(r[0],"raw").string;s=nr(i,l)}else s=qr(_e(r[0],"raw").string,n.gullet.macros,t);const a=n.parseExpression(!0,e,!0);return{type:"color",mode:n.mode,color:s,isTextColor:!1,body:a}},mathmlBuilder:Ec});ue({type:"color",names:["\\definecolor"],props:{numArgs:3,allowedInText:!0,argTypes:["raw","raw","raw"]},handler({parser:n,funcName:e,token:t},r){const o=_e(r[0],"raw").string;if(!/^[A-Za-z]+$/.test(o))throw new Q("Color name must be latin letters.",t);const i=_e(r[1],"raw").string;if(!["HTML","RGB","rgb"].includes(i))throw new Q("Color model must be HTML, RGB, or rgb.",t);const s=_e(r[2],"raw").string,a=nr(i,s);return n.gullet.macros.set(`\\\\color@${o}`,{tokens:[{text:a}],numArgs:0}),{type:"internal",mode:n.mode}}});ue({type:"cr",names:["\\\\"],props:{numArgs:0,numOptionalArgs:0,allowedInText:!0},handler({parser:n},e,t){const r=n.gullet.future().text==="["?n.parseSizeGroup(!0):null,o=!n.settings.displayMode;return{type:"cr",mode:n.mode,newLine:o,size:r&&_e(r,"size").value}},mathmlBuilder(n,e){const t=new P("mo");if(n.newLine&&(t.setAttribute("linebreak","newline"),n.size)){const r=an(n.size,e);t.setAttribute("height",r.number+r.unit)}return t}});const ji={"\\global":"\\global","\\long":"\\\\globallong","\\\\globallong":"\\\\globallong","\\def":"\\gdef","\\gdef":"\\gdef","\\edef":"\\xdef","\\xdef":"\\xdef","\\let":"\\\\globallet","\\futurelet":"\\\\globalfuture"},Mo=n=>{const e=n.text;if(/^(?:[\\{}$&#^_]|EOF)$/.test(e))throw new Q("Expected a control sequence",n);return e},ju=n=>{let e=n.gullet.popToken();return e.text==="="&&(e=n.gullet.popToken(),e.text===" "&&(e=n.gullet.popToken())),e},Cc=(n,e,t,r)=>{let o=n.gullet.macros.get(t.text);o==null&&(t.noexpand=!0,o={tokens:[t],numArgs:0,unexpandable:!n.gullet.isExpandable(t.text)}),n.gullet.macros.set(e,o,r)};ue({type:"internal",names:["\\global","\\long","\\\\globallong"],props:{numArgs:0,allowedInText:!0},handler({parser:n,funcName:e}){n.consumeSpaces();const t=n.fetch();if(ji[t.text])return(e==="\\global"||e==="\\\\globallong")&&(t.text=ji[t.text]),_e(n.parseFunction(),"internal");throw new Q("Invalid token after macro prefix",t)}});ue({type:"internal",names:["\\def","\\gdef","\\edef","\\xdef"],props:{numArgs:0,allowedInText:!0,primitive:!0},handler({parser:n,funcName:e}){let t=n.gullet.popToken();const r=t.text;if(/^(?:[\\{}$&#^_]|EOF)$/.test(r))throw new Q("Expected a control sequence",t);let o=0,i;const s=[[]];for(;n.gullet.future().text!=="{";)if(t=n.gullet.popToken(),t.text==="#"){if(n.gullet.future().text==="{"){i=n.gullet.future(),s[o].push("{");break}if(t=n.gullet.popToken(),!/^[1-9]$/.test(t.text))throw new Q(`Invalid argument number "${t.text}"`);if(parseInt(t.text)!==o+1)throw new Q(`Argument number "${t.text}" out of order`);o++,s.push([])}else{if(t.text==="EOF")throw new Q("Expected a macro definition");s[o].push(t.text)}let{tokens:a}=n.gullet.consumeArg();if(i&&a.unshift(i),e==="\\edef"||e==="\\xdef"){if(a=n.gullet.expandTokens(a),a.length>n.gullet.settings.maxExpand)throw new Q("Too many expansions in an "+e);a.reverse()}return n.gullet.macros.set(r,{tokens:a,numArgs:o,delimiters:s},e===ji[e]),{type:"internal",mode:n.mode}}});ue({type:"internal",names:["\\let","\\\\globallet"],props:{numArgs:0,allowedInText:!0,primitive:!0},handler({parser:n,funcName:e}){const t=Mo(n.gullet.popToken());n.gullet.consumeSpaces();const r=ju(n);return Cc(n,t,r,e==="\\\\globallet"),{type:"internal",mode:n.mode}}});ue({type:"internal",names:["\\futurelet","\\\\globalfuture"],props:{numArgs:0,allowedInText:!0,primitive:!0},handler({parser:n,funcName:e}){const t=Mo(n.gullet.popToken()),r=n.gullet.popToken(),o=n.gullet.popToken();return Cc(n,t,o,e==="\\\\globalfuture"),n.gullet.pushToken(o),n.gullet.pushToken(r),{type:"internal",mode:n.mode}}});ue({type:"internal",names:["\\newcommand","\\renewcommand","\\providecommand"],props:{numArgs:0,allowedInText:!0,primitive:!0},handler({parser:n,funcName:e}){let t="";const r=n.gullet.popToken();r.text==="{"?(t=Mo(n.gullet.popToken()),n.gullet.popToken()):t=Mo(r);const o=n.gullet.isDefined(t);if(o&&e==="\\newcommand")throw new Q(`\\newcommand{${t}} attempting to redefine ${t}; use \\renewcommand`);if(!o&&e==="\\renewcommand")throw new Q(`\\renewcommand{${t}} when command ${t} does not yet exist; use \\newcommand`);let i=0;if(n.gullet.future().text==="["){let a=n.gullet.popToken();if(a=n.gullet.popToken(),!/^[0-9]$/.test(a.text))throw new Q(`Invalid number of arguments: "${a.text}"`);if(i=parseInt(a.text),a=n.gullet.popToken(),a.text!=="]")throw new Q(`Invalid argument "${a.text}"`)}const{tokens:s}=n.gullet.consumeArg();return e==="\\providecommand"&&n.gullet.macros.has(t)||n.gullet.macros.set(t,{tokens:s,numArgs:i}),{type:"internal",mode:n.mode}}});const Wi={"\\bigl":{mclass:"mopen",size:1},"\\Bigl":{mclass:"mopen",size:2},"\\biggl":{mclass:"mopen",size:3},"\\Biggl":{mclass:"mopen",size:4},"\\bigr":{mclass:"mclose",size:1},"\\Bigr":{mclass:"mclose",size:2},"\\biggr":{mclass:"mclose",size:3},"\\Biggr":{mclass:"mclose",size:4},"\\bigm":{mclass:"mrel",size:1},"\\Bigm":{mclass:"mrel",size:2},"\\biggm":{mclass:"mrel",size:3},"\\Biggm":{mclass:"mrel",size:4},"\\big":{mclass:"mord",size:1},"\\Big":{mclass:"mord",size:2},"\\bigg":{mclass:"mord",size:3},"\\Bigg":{mclass:"mord",size:4}},Tc=["(","\\lparen",")","\\rparen","[","\\lbrack","]","\\rbrack","\\{","\\lbrace","\\}","\\rbrace","â¦‡","\\llparenthesis","â¦ˆ","\\rrparenthesis","\\lfloor","\\rfloor","âŒŠ","âŒ‹","\\lceil","\\rceil","âŒˆ","âŒ‰","<",">","\\langle","âŸ¨","\\rangle","âŸ©","\\lAngle","âŸª","\\rAngle","âŸ«","\\llangle","â¦‰","\\rrangle","â¦Š","\\lt","\\gt","\\lvert","\\rvert","\\lVert","\\rVert","\\lgroup","\\rgroup","âŸ®","âŸ¯","\\lmoustache","\\rmoustache","â°","â±","\\llbracket","\\rrbracket","âŸ¦","âŸ¦","\\lBrace","\\rBrace","â¦ƒ","â¦„","/","\\backslash","|","\\vert","\\|","\\Vert","â€–","\\uparrow","\\Uparrow","\\downarrow","\\Downarrow","\\updownarrow","\\Updownarrow","."],Wu=["}","\\left","\\middle","\\right"],Ho=n=>n.length>0&&(Tc.includes(n)||Wi[n]||Wu.includes(n)),Ca=[0,1.2,1.8,2.4,3];function zr(n,e){n.type==="ordgroup"&&n.body.length===1&&(n=n.body[0]);const t=Uo(n);if(t&&Tc.includes(t.text))return["<","\\lt"].includes(t.text)&&(t.text="âŸ¨"),[">","\\gt"].includes(t.text)&&(t.text="âŸ©"),t;throw t?new Q(`Invalid delimiter '${t.text}' after '${e.funcName}'`,n):new Q(`Invalid delimiter type '${n.type}'`,n)}const Vu=["/","\\","\\backslash","\\vert","|"];ue({type:"delimsizing",names:["\\bigl","\\Bigl","\\biggl","\\Biggl","\\bigr","\\Bigr","\\biggr","\\Biggr","\\bigm","\\Bigm","\\biggm","\\Biggm","\\big","\\Big","\\bigg","\\Bigg"],props:{numArgs:1,argTypes:["primitive"]},handler:(n,e)=>{const t=zr(e[0],n),r={type:"delimsizing",mode:n.parser.mode,size:Wi[n.funcName].size,mclass:Wi[n.funcName].mclass,delim:t.text},o=n.parser.fetch().text;return o!=="^"&&o!=="_"?r:{type:"ordgroup",mode:"math",body:[r,{type:"ordgroup",mode:"math",body:[]}]}},mathmlBuilder:n=>{const e=[];n.delim==="."&&(n.delim=""),e.push($t(n.delim,n.mode));const t=new P("mo",e);return n.mclass==="mopen"||n.mclass==="mclose"?t.setAttribute("fence","true"):t.setAttribute("fence","false"),(Vu.includes(n.delim)||n.delim.indexOf("arrow")>-1)&&t.setAttribute("stretchy","true"),t.setAttribute("symmetric","true"),t.setAttribute("minsize",Ca[n.size]+"em"),t.setAttribute("maxsize",Ca[n.size]+"em"),t}});function Yu(n){if(!n.body)throw new Error("Bug: The leftright ParseNode wasn't fully parsed.")}ue({type:"leftright-right",names:["\\right"],props:{numArgs:1,argTypes:["primitive"]},handler:(n,e)=>({type:"leftright-right",mode:n.parser.mode,delim:zr(e[0],n).text})});ue({type:"leftright",names:["\\left"],props:{numArgs:1,argTypes:["primitive"]},handler:(n,e)=>{const t=zr(e[0],n),r=n.parser;++r.leftrightDepth;let o=r.parseExpression(!1,null,!0),i=r.fetch();for(;i.text==="\\middle";){r.consume();const a=r.fetch().text;if(!ct.math[a])throw new Q(`Invalid delimiter '${a}' after '\\middle'`);zr({type:"atom",mode:"math",text:a},{funcName:"\\middle"}),o.push({type:"middle",mode:"math",delim:a}),r.consume(),o=o.concat(r.parseExpression(!1,null,!0)),i=r.fetch()}--r.leftrightDepth,r.expect("\\right",!1);const s=_e(r.parseFunction(),"leftright-right");return{type:"leftright",mode:r.mode,body:o,left:t.text,right:s.delim}},mathmlBuilder:(n,e)=>{Yu(n);const t=kt(n.body,e);n.left==="."&&(n.left="");const r=new P("mo",[$t(n.left,n.mode)]);r.setAttribute("fence","true"),r.setAttribute("form","prefix"),(n.left==="/"||n.left==="\\"||n.left.indexOf("arrow")>-1)&&r.setAttribute("stretchy","true"),t.unshift(r),n.right==="."&&(n.right="");const o=new P("mo",[$t(n.right,n.mode)]);if(o.setAttribute("fence","true"),o.setAttribute("form","postfix"),(n.right==="âˆ–"||n.right.indexOf("arrow")>-1)&&o.setAttribute("stretchy","true"),n.body.length>0){const i=n.body[n.body.length-1];i.type==="color"&&!i.isTextColor&&o.setAttribute("mathcolor",i.color)}return t.push(o),zo(t)}});ue({type:"middle",names:["\\middle"],props:{numArgs:1,argTypes:["primitive"]},handler:(n,e)=>{const t=zr(e[0],n);if(!n.parser.leftrightDepth)throw new Q("\\middle without preceding \\left",t);return{type:"middle",mode:n.parser.mode,delim:t.text}},mathmlBuilder:(n,e)=>{const t=$t(n.delim,n.mode),r=new P("mo",[t]);return r.setAttribute("fence","true"),n.delim.indexOf("arrow")>-1&&r.setAttribute("stretchy","true"),r.setAttribute("form","prefix"),r.setAttribute("lspace","0.05em"),r.setAttribute("rspace","0.05em"),r}});const Ku=["\\boxed","\\fcolorbox","\\colorbox"],Yr=(n,e)=>{const t=Ku.includes(n.label)?"mrow":"menclose",r=new P(t,[qe(n.body,e)]);switch(n.label){case"\\overline":r.setAttribute("notation","top"),r.classes.push("tml-overline");break;case"\\underline":r.setAttribute("notation","bottom"),r.classes.push("tml-underline");break;case"\\cancel":r.setAttribute("notation","updiagonalstrike"),r.children.push(new P("mrow",[],["tml-cancel","upstrike"]));break;case"\\bcancel":r.setAttribute("notation","downdiagonalstrike"),r.children.push(new P("mrow",[],["tml-cancel","downstrike"]));break;case"\\sout":r.setAttribute("notation","horizontalstrike"),r.children.push(new P("mrow",[],["tml-cancel","sout"]));break;case"\\xcancel":r.setAttribute("notation","updiagonalstrike downdiagonalstrike"),r.classes.push("tml-xcancel");break;case"\\longdiv":r.setAttribute("notation","longdiv"),r.classes.push("longdiv-top"),r.children.push(new P("mrow",[],["longdiv-arc"]));break;case"\\phase":r.setAttribute("notation","phasorangle"),r.classes.push("phasor-bottom"),r.children.push(new P("mrow",[],["phasor-angle"]));break;case"\\textcircled":r.setAttribute("notation","circle"),r.classes.push("circle-pad"),r.children.push(new P("mrow",[],["textcircle"]));break;case"\\angl":r.setAttribute("notation","actuarial"),r.classes.push("actuarial");break;case"\\boxed":r.style.padding="3pt",r.style.border="1px solid",r.setAttribute("scriptlevel","0"),r.setAttribute("displaystyle","true");break;case"\\fbox":r.setAttribute("notation","box"),r.classes.push("tml-fbox");break;case"\\fcolorbox":case"\\colorbox":{r.style.padding="0.3em",n.label==="\\fcolorbox"&&(r.style.border="0.0667em solid "+String(n.borderColor));break}}return n.backgroundColor&&r.setAttribute("mathbackground",n.backgroundColor),r};ue({type:"enclose",names:["\\colorbox"],props:{numArgs:2,numOptionalArgs:1,allowedInText:!0,argTypes:["raw","raw","text"]},handler({parser:n,funcName:e},t,r){const o=r[0]&&_e(r[0],"raw").string;let i="";if(o){const a=_e(t[0],"raw").string;i=nr(o,a)}else i=qr(_e(t[0],"raw").string,n.gullet.macros);const s=t[1];return{type:"enclose",mode:n.mode,label:e,backgroundColor:i,body:s}},mathmlBuilder:Yr});ue({type:"enclose",names:["\\fcolorbox"],props:{numArgs:3,numOptionalArgs:1,allowedInText:!0,argTypes:["raw","raw","raw","text"]},handler({parser:n,funcName:e},t,r){const o=r[0]&&_e(r[0],"raw").string;let i="",s;if(o){const l=_e(t[0],"raw").string,d=_e(t[0],"raw").string;i=nr(o,l),s=nr(o,d)}else i=qr(_e(t[0],"raw").string,n.gullet.macros),s=qr(_e(t[1],"raw").string,n.gullet.macros);const a=t[2];return{type:"enclose",mode:n.mode,label:e,backgroundColor:s,borderColor:i,body:a}},mathmlBuilder:Yr});ue({type:"enclose",names:["\\fbox"],props:{numArgs:1,argTypes:["hbox"],allowedInText:!0},handler({parser:n},e){return{type:"enclose",mode:n.mode,label:"\\fbox",body:e[0]}}});ue({type:"enclose",names:["\\angl","\\cancel","\\bcancel","\\xcancel","\\sout","\\overline","\\boxed","\\longdiv","\\phase"],props:{numArgs:1},handler({parser:n,funcName:e},t){const r=t[0];return{type:"enclose",mode:n.mode,label:e,body:r}},mathmlBuilder:Yr});ue({type:"enclose",names:["\\underline"],props:{numArgs:1,allowedInText:!0},handler({parser:n,funcName:e},t){const r=t[0];return{type:"enclose",mode:n.mode,label:e,body:r}},mathmlBuilder:Yr});ue({type:"enclose",names:["\\textcircled"],props:{numArgs:1,argTypes:["text"],allowedInArgument:!0,allowedInText:!0},handler({parser:n,funcName:e},t){const r=t[0];return{type:"enclose",mode:n.mode,label:e,body:r}},mathmlBuilder:Yr});ue({type:"environment",names:["\\begin","\\end"],props:{numArgs:1,argTypes:["text"]},handler({parser:n,funcName:e},t){const r=t[0];if(r.type!=="ordgroup")throw new Q("Invalid environment name",r);let o="";for(let i=0;i<r.body.length;++i)o+=_e(r.body[i],"textord").text;if(e==="\\begin"){if(!Object.prototype.hasOwnProperty.call(Gi,o))throw new Q("No such environment: "+o,r);const i=Gi[o],{args:s,optArgs:a}=n.parseArguments("\\begin{"+o+"}",i),l={mode:n.mode,envName:o,parser:n},d=i.handler(l,s,a);n.expect("\\end",!1);const u=n.nextToken,m=_e(n.parseFunction(),"environment");if(m.name!==o)throw new Q(`Mismatch: \\begin{${o}} matched by \\end{${m.name}}`,u);return d}return{type:"environment",mode:n.mode,name:o,nameGroup:r}}});ue({type:"envTag",names:["\\env@tag"],props:{numArgs:1,argTypes:["math"]},handler({parser:n},e){return{type:"envTag",mode:n.mode,body:e[0]}},mathmlBuilder(n,e){return new P("mrow")}});ue({type:"noTag",names:["\\env@notag"],props:{numArgs:0},handler({parser:n}){return{type:"noTag",mode:n.mode}},mathmlBuilder(n,e){return new P("mrow")}});const Zu=(n,e)=>{if(e!=="mathrm"||n.body.type!=="ordgroup"||n.body.body.length===1||n.body.body[0].type!=="mathord")return!1;for(let t=1;t<n.body.body.length;t++){const r=n.body.body[t].type;if(!(r==="mathord"||r==="textord"&&!isNaN(n.body.body[t].text)))return!1}return!0},_c=(n,e)=>{const t=n.font,r=e.withFont(t),o=qe(n.body,r);if(o.children.length===0)return o;if(t==="boldsymbol"&&["mo","mpadded","mrow"].includes(o.type))return o.style.fontWeight="bold",o;if(Zu(n,t)){const a=o.children[0].children[0].children?o.children[0].children[0]:o.children[0];delete a.attributes.mathvariant;for(let d=1;d<o.children.length;d++)a.children[0].text+=o.children[d].children[0].children?o.children[d].children[0].children[0].text:o.children[d].children[0].text;const l=new P("mpadded",[a]);return l.setAttribute("lspace","0"),l}let i=o.children[0].type==="mo";for(let a=1;a<o.children.length;a++)o.children[a].type==="mo"&&t==="boldsymbol"&&(o.children[a].style.fontWeight="bold"),o.children[a].type!=="mi"&&(i=!1),(o.children[a].attributes&&o.children[a].attributes.mathvariant||"")!=="normal"&&(i=!1);if(!i)return o;const s=o.children[0];for(let a=1;a<o.children.length;a++)s.children.push(o.children[a].children[0]);if(s.attributes.mathvariant&&s.attributes.mathvariant==="normal"){const a=new P("mtext",new ft("â€‹"));return new P("mrow",[a,s])}return s},Ta={"\\Bbb":"\\mathbb","\\bold":"\\mathbf","\\frak":"\\mathfrak","\\bm":"\\boldsymbol"};ue({type:"font",names:["\\mathrm","\\mathit","\\mathbf","\\mathnormal","\\up@greek","\\boldsymbol","\\mathbb","\\mathcal","\\mathfrak","\\mathscr","\\mathsf","\\mathsfit","\\mathtt","\\Bbb","\\bm","\\bold","\\frak"],props:{numArgs:1,allowedInArgument:!0},handler:({parser:n,funcName:e},t)=>{const r=$r(t[0]);let o=e;return o in Ta&&(o=Ta[o]),{type:"font",mode:n.mode,font:o.slice(1),body:r}},mathmlBuilder:_c});ue({type:"font",names:["\\rm","\\sf","\\tt","\\bf","\\it","\\cal"],props:{numArgs:0,allowedInText:!0},handler:({parser:n,funcName:e,breakOnTokenText:t},r)=>{const{mode:o}=n,i=n.parseExpression(!0,t,!0),s=`math${e.slice(1)}`;return{type:"font",mode:o,font:s,body:{type:"ordgroup",mode:n.mode,body:i}}},mathmlBuilder:_c});const _a=["display","text","script","scriptscript"],Xu={auto:-1,display:0,text:0,script:1,scriptscript:2},zs=(n,e)=>{const t=n.scriptLevel==="auto"?e.incrementLevel():n.scriptLevel==="display"?e.withLevel(lt.TEXT):n.scriptLevel==="text"?e.withLevel(lt.SCRIPT):e.withLevel(lt.SCRIPTSCRIPT),r=qe(n.numer,t),o=qe(n.denom,t);e.level===3&&(r.style.mathDepth="2",r.setAttribute("scriptlevel","2"),o.style.mathDepth="2",o.setAttribute("scriptlevel","2"));let i=new P("mfrac",[r,o]);if(!n.hasBarLine)i.setAttribute("linethickness","0px");else if(n.barSize){const s=an(n.barSize,e);i.setAttribute("linethickness",s.number+s.unit)}if(n.leftDelim!=null||n.rightDelim!=null){const s=[];if(n.leftDelim!=null){const a=new P("mo",[new ft(n.leftDelim.replace("\\",""))]);a.setAttribute("fence","true"),s.push(a)}if(s.push(i),n.rightDelim!=null){const a=new P("mo",[new ft(n.rightDelim.replace("\\",""))]);a.setAttribute("fence","true"),s.push(a)}i=zo(s)}return n.scriptLevel!=="auto"&&(i=new P("mstyle",[i]),i.setAttribute("displaystyle",String(n.scriptLevel==="display")),i.setAttribute("scriptlevel",Xu[n.scriptLevel])),i};ue({type:"genfrac",names:["\\dfrac","\\frac","\\tfrac","\\dbinom","\\binom","\\tbinom","\\\\atopfrac","\\\\bracefrac","\\\\brackfrac"],props:{numArgs:2,allowedInArgument:!0},handler:({parser:n,funcName:e},t)=>{const r=t[0],o=t[1];let i=!1,s=null,a=null,l="auto";switch(e){case"\\dfrac":case"\\frac":case"\\tfrac":i=!0;break;case"\\\\atopfrac":i=!1;break;case"\\dbinom":case"\\binom":case"\\tbinom":s="(",a=")";break;case"\\\\bracefrac":s="\\{",a="\\}";break;case"\\\\brackfrac":s="[",a="]";break;default:throw new Error("Unrecognized genfrac command")}switch(e){case"\\dfrac":case"\\dbinom":l="display";break;case"\\tfrac":case"\\tbinom":l="text";break}return{type:"genfrac",mode:n.mode,continued:!1,numer:r,denom:o,hasBarLine:i,leftDelim:s,rightDelim:a,scriptLevel:l,barSize:null}},mathmlBuilder:zs});ue({type:"genfrac",names:["\\cfrac"],props:{numArgs:2},handler:({parser:n,funcName:e},t)=>{const r=t[0],o=t[1];return{type:"genfrac",mode:n.mode,continued:!0,numer:r,denom:o,hasBarLine:!0,leftDelim:null,rightDelim:null,scriptLevel:"display",barSize:null}}});ue({type:"infix",names:["\\over","\\choose","\\atop","\\brace","\\brack"],props:{numArgs:0,infix:!0},handler({parser:n,funcName:e,token:t}){let r;switch(e){case"\\over":r="\\frac";break;case"\\choose":r="\\binom";break;case"\\atop":r="\\\\atopfrac";break;case"\\brace":r="\\\\bracefrac";break;case"\\brack":r="\\\\brackfrac";break;default:throw new Error("Unrecognized infix genfrac command")}return{type:"infix",mode:n.mode,replaceWith:r,token:t}}});const ka=function(n){let e=null;return n.length>0&&(e=n,e=e==="."?null:e),e};ue({type:"genfrac",names:["\\genfrac"],props:{numArgs:6,allowedInArgument:!0,argTypes:["math","math","size","text","math","math"]},handler({parser:n},e){const t=e[4],r=e[5],o=$r(e[0]),i=o.type==="atom"&&o.family==="open"?ka(o.text):null,s=$r(e[1]),a=s.type==="atom"&&s.family==="close"?ka(s.text):null,l=_e(e[2],"size");let d,u=null;l.isBlank?d=!0:(u=l.value,d=u.number>0);let m="auto",p=e[3];if(p.type==="ordgroup"){if(p.body.length>0){const f=_e(p.body[0],"textord");m=_a[Number(f.text)]}}else p=_e(p,"textord"),m=_a[Number(p.text)];return{type:"genfrac",mode:n.mode,numer:t,denom:r,continued:!1,hasBarLine:d,barSize:u,leftDelim:i,rightDelim:a,scriptLevel:m}},mathmlBuilder:zs});ue({type:"infix",names:["\\above"],props:{numArgs:1,argTypes:["size"],infix:!0},handler({parser:n,funcName:e,token:t},r){return{type:"infix",mode:n.mode,replaceWith:"\\\\abovefrac",barSize:_e(r[0],"size").value,token:t}}});ue({type:"genfrac",names:["\\\\abovefrac"],props:{numArgs:3,argTypes:["math","size","math"]},handler:({parser:n,funcName:e},t)=>{const r=t[0],o=au(_e(t[1],"infix").barSize),i=t[2],s=o.number>0;return{type:"genfrac",mode:n.mode,numer:r,denom:i,continued:!1,hasBarLine:s,barSize:o,leftDelim:null,rightDelim:null,scriptLevel:"auto"}},mathmlBuilder:zs});ue({type:"hbox",names:["\\hbox"],props:{numArgs:1,argTypes:["hbox"],allowedInArgument:!0,allowedInText:!1},handler({parser:n},e){return{type:"hbox",mode:n.mode,body:ht(e[0])}},mathmlBuilder(n,e){const t=e.withLevel(lt.TEXT),r=Tn(n.body,t);return qo(r)}});const Ju=(n,e)=>{const t=Os(n.label);return t.style["math-depth"]=0,new P(n.isOver?"mover":"munder",[qe(n.base,e),t])};ue({type:"horizBracket",names:["\\overbrace","\\underbrace","\\overbracket","\\underbracket"],props:{numArgs:1},handler({parser:n,funcName:e},t){return{type:"horizBracket",mode:n.mode,label:e,isOver:/^\\over/.test(e),base:t[0]}},mathmlBuilder:Ju});ue({type:"html",names:["\\class","\\id","\\style","\\data"],props:{numArgs:2,argTypes:["raw","original"],allowedInText:!0},handler:({parser:n,funcName:e,token:t},r)=>{const o=_e(r[0],"raw").string,i=r[1];if(n.settings.strict)throw new Q(`Function "${e}" is disabled in strict mode`,t);let s;const a={};switch(e){case"\\class":a.class=o,s={command:"\\class",class:o};break;case"\\id":a.id=o,s={command:"\\id",id:o};break;case"\\style":a.style=o,s={command:"\\style",style:o};break;case"\\data":{const l=o.split(",");for(let d=0;d<l.length;d++){const u=l[d].split("=");if(u.length!==2)throw new Q("Error parsing key-value for \\data");a["data-"+u[0].trim()]=u[1].trim()}s={command:"\\data",attributes:a};break}default:throw new Error("Unrecognized html command")}if(!n.settings.isTrusted(s))throw new Q(`Function "${e}" is not trusted`,t);return{type:"html",mode:n.mode,attributes:a,body:ht(i)}},mathmlBuilder:(n,e)=>{const t=Tn(n.body,e),r=[];n.attributes.class&&r.push(...n.attributes.class.trim().split(/\s+/)),t.classes=r;for(const o in n.attributes)o!=="class"&&Object.prototype.hasOwnProperty.call(n.attributes,o)&&t.setAttribute(o,n.attributes[o]);return t}});const ti=function(n){if(/^[-+]? *(\d+(\.\d*)?|\.\d+)$/.test(n))return{number:+n,unit:"bp"};{const e=/([-+]?) *(\d+(?:\.\d*)?|\.\d+) *([a-z]{2})/.exec(n);if(!e)throw new Q("Invalid size: '"+n+"' in \\includegraphics");const t={number:+(e[1]+e[2]),unit:e[3]};if(!hc(t))throw new Q("Invalid unit: '"+t.unit+"' in \\includegraphics.");return t}};ue({type:"includegraphics",names:["\\includegraphics"],props:{numArgs:1,numOptionalArgs:1,argTypes:["raw","url"],allowedInText:!1},handler:({parser:n,token:e},t,r)=>{let o={number:0,unit:"em"},i={number:.9,unit:"em"},s={number:0,unit:"em"},a="";if(r[0]){const u=_e(r[0],"raw").string.split(",");for(let m=0;m<u.length;m++){const p=u[m].split("=");if(p.length===2){const f=p[1].trim();switch(p[0].trim()){case"alt":a=f;break;case"width":o=ti(f);break;case"height":i=ti(f);break;case"totalheight":s=ti(f);break;default:throw new Q("Invalid key: '"+p[0]+"' in \\includegraphics.")}}}}const l=_e(t[0],"url").url;if(a===""&&(a=l,a=a.replace(/^.*[\\/]/,""),a=a.substring(0,a.lastIndexOf("."))),!n.settings.isTrusted({command:"\\includegraphics",url:l}))throw new Q('Function "\\includegraphics" is not trusted',e);return{type:"includegraphics",mode:n.mode,alt:a,width:o,height:i,totalheight:s,src:l}},mathmlBuilder:(n,e)=>{const t=an(n.height,e),r={number:0,unit:"em"};n.totalheight.number>0&&n.totalheight.unit===t.unit&&n.totalheight.number>t.number&&(r.number=n.totalheight.number-t.number,r.unit=t.unit);let o=0;n.width.number>0&&(o=an(n.width,e));const i={height:t.number+r.number+"em"};o.number>0&&(i.width=o.number+o.unit),r.number>0&&(i.verticalAlign=-r.number+r.unit);const s=new mu(n.src,n.alt,i);return s.height=t,s.depth=r,new P("mtext",[s])}});ue({type:"kern",names:["\\kern","\\mkern","\\hskip","\\mskip"],props:{numArgs:1,argTypes:["size"],primitive:!0,allowedInText:!0},handler({parser:n,funcName:e,token:t},r){const o=_e(r[0],"size");if(n.settings.strict){const i=e[1]==="m",s=o.value.unit==="mu";if(i){if(!s)throw new Q(`LaTeX's ${e} supports only mu units, not ${o.value.unit} units`,t);if(n.mode!=="math")throw new Q(`LaTeX's ${e} works only in math mode`,t)}else if(s)throw new Q(`LaTeX's ${e} doesn't support mu units`,t)}return{type:"kern",mode:n.mode,dimension:o.value}},mathmlBuilder(n,e){const t=an(n.dimension,e),r=t.number>0&&t.unit==="em"?kc(t.number):"";if(n.mode==="text"&&r.length>0){const o=new ft(r);return new P("mtext",[o])}else if(t.number>=0){const o=new P("mspace");return o.setAttribute("width",t.number+t.unit),o}else{const o=new P("mrow");return o.style.marginLeft=t.number+t.unit,o}}});const kc=function(n){return n>=.05555&&n<=.05556?"â€Š":n>=.1666&&n<=.1667?"â€‰":n>=.2222&&n<=.2223?"â€…":n>=.2777&&n<=.2778?"â€…â€Š":""},Ac=/[^A-Za-z_0-9-]/g;ue({type:"label",names:["\\label"],props:{numArgs:1,argTypes:["raw"]},handler({parser:n},e){return{type:"label",mode:n.mode,string:e[0].string.replace(Ac,"")}},mathmlBuilder(n,e){const t=new P("mrow",[],["tml-label"]);return n.string.length>0&&t.setLabel(n.string),t}});const Qu=["\\clap","\\llap","\\rlap"];ue({type:"lap",names:["\\mathllap","\\mathrlap","\\mathclap","\\clap","\\llap","\\rlap"],props:{numArgs:1,allowedInText:!0},handler:({parser:n,funcName:e,token:t},r)=>{if(Qu.includes(e)){if(n.settings.strict&&n.mode!=="text")throw new Q(`{${e}} can be used only in text mode.
 Try \\math${e.slice(1)}`,t);e=e.slice(1)}else e=e.slice(5);const o=r[0];return{type:"lap",mode:n.mode,alignment:e,body:o}},mathmlBuilder:(n,e)=>{let t;if(n.alignment==="llap"){const i=kt(ht(n.body),e),s=new P("mphantom",i);t=new P("mpadded",[s]),t.setAttribute("width","0.1px")}const r=qe(n.body,e);let o;if(n.alignment==="llap"?(r.style.position="absolute",r.style.right="0",r.style.bottom="0",o=new P("mpadded",[t,r])):o=new P("mpadded",[r]),n.alignment==="rlap")n.body.body.length>0&&n.body.body[0].type==="genfrac"&&o.setAttribute("lspace","0.16667em");else{const i=n.alignment==="llap"?"-1":"-0.5";o.setAttribute("lspace",i+"width"),n.alignment==="llap"?o.style.position="relative":(o.style.display="flex",o.style.justifyContent="center")}return o.setAttribute("width","0.1px"),o}});ue({type:"ordgroup",names:["\\(","$"],props:{numArgs:0,allowedInText:!0,allowedInMath:!1},handler({funcName:n,parser:e},t){const r=e.mode;e.switchMode("math");const o=n==="\\("?"\\)":"$",i=e.parseExpression(!1,o);return e.expect(o),e.switchMode(r),{type:"ordgroup",mode:e.mode,body:i}}});ue({type:"text",names:["\\)","\\]"],props:{numArgs:0,allowedInText:!0,allowedInMath:!1},handler(n,e){throw new Q(`Mismatched ${n.funcName}`,e)}});const eh=(n,e)=>{switch(e.level){case lt.DISPLAY:return n.display;case lt.TEXT:return n.text;case lt.SCRIPT:return n.script;case lt.SCRIPTSCRIPT:return n.scriptscript;default:return n.text}};ue({type:"mathchoice",names:["\\mathchoice"],props:{numArgs:4,primitive:!0},handler:({parser:n},e)=>({type:"mathchoice",mode:n.mode,display:ht(e[0]),text:ht(e[1]),script:ht(e[2]),scriptscript:ht(e[3])}),mathmlBuilder:(n,e)=>{const t=eh(n,e);return Tn(t,e)}});const th=["text","textord","mathord","atom"];function Ic(n,e){let t;const r=kt(n.body,e);if(n.mclass==="minner")t=new P("mpadded",r);else if(n.mclass==="mord")n.isCharacterBox||r[0].type==="mathord"?(t=r[0],t.type="mi",t.children.length===1&&t.children[0].text&&t.children[0].text==="âˆ‡"&&t.setAttribute("mathvariant","normal")):t=new P("mi",r);else{t=new P("mrow",r),n.mustPromote?(t=r[0],t.type="mo",n.isCharacterBox&&n.body[0].text&&/[A-Za-z]/.test(n.body[0].text)&&t.setAttribute("mathvariant","italic")):t=new P("mrow",r);const o=e.level<2;t.type==="mrow"?o&&(n.mclass==="mbin"?(t.children.unshift(at(.2222)),t.children.push(at(.2222))):n.mclass==="mrel"?(t.children.unshift(at(.2778)),t.children.push(at(.2778))):n.mclass==="mpunct"?t.children.push(at(.1667)):n.mclass==="minner"&&(t.children.unshift(at(.0556)),t.children.push(at(.0556)))):n.mclass==="mbin"?(t.attributes.lspace=o?"0.2222em":"0",t.attributes.rspace=o?"0.2222em":"0"):n.mclass==="mrel"?(t.attributes.lspace=o?"0.2778em":"0",t.attributes.rspace=o?"0.2778em":"0"):n.mclass==="mpunct"?(t.attributes.lspace="0em",t.attributes.rspace=o?"0.1667em":"0"):n.mclass==="mopen"||n.mclass==="mclose"?(t.attributes.lspace="0em",t.attributes.rspace="0em"):n.mclass==="minner"&&o&&(t.attributes.lspace="0.0556em",t.attributes.width="+0.1111em"),n.mclass==="mopen"||n.mclass==="mclose"||(delete t.attributes.stretchy,delete t.attributes.form)}return t}ue({type:"mclass",names:["\\mathord","\\mathbin","\\mathrel","\\mathopen","\\mathclose","\\mathpunct","\\mathinner"],props:{numArgs:1,primitive:!0},handler({parser:n,funcName:e},t){const r=t[0],o=$o(r);let i=!0;const s={type:"mathord",text:"",mode:n.mode},a=r.body?r.body:[r];for(const l of a)if(th.includes(l.type))ct[n.mode][l.text]?s.text+=ct[n.mode][l.text].replace:l.text?s.text+=l.text:l.body&&l.body.map(d=>{s.text+=d.text});else{i=!1;break}return i&&e==="\\mathord"&&s.type==="mathord"&&s.text.length>1?s:{type:"mclass",mode:n.mode,mclass:"m"+e.slice(5),body:ht(i?s:r),isCharacterBox:o,mustPromote:i}},mathmlBuilder:Ic});const Lc=n=>{const e=n.type==="ordgroup"&&n.body.length&&n.body.length===1?n.body[0]:n;return e.type==="atom"&&(e.family==="bin"||e.family==="rel")?"m"+e.family:"mord"};ue({type:"mclass",names:["\\@binrel"],props:{numArgs:2},handler({parser:n},e){return{type:"mclass",mode:n.mode,mclass:Lc(e[0]),body:ht(e[1]),isCharacterBox:$o(e[1])}}});ue({type:"mclass",names:["\\stackrel","\\overset","\\underset"],props:{numArgs:2},handler({parser:n,funcName:e},t){const r=t[1],o=t[0];let i;e!=="\\stackrel"?i=Lc(r):i="mrel";const a={type:i==="mrel"||i==="mbin"?"op":"ordgroup",mode:r.mode,limits:!0,alwaysHandleSupSub:!0,parentIsSupSub:!1,symbol:!1,suppressBaseShift:e!=="\\stackrel",body:ht(r)};return{type:"supsub",mode:o.mode,stack:!0,base:a,sup:e==="\\underset"?null:o,sub:e==="\\underset"?o:null}},mathmlBuilder:Ic});const to=(n,e,t)=>{if(!n)return t;const r=qe(n,e);return r.type==="mrow"&&r.children.length===0?t:r};ue({type:"multiscript",names:["\\sideset","\\pres@cript"],props:{numArgs:3},handler({parser:n,funcName:e,token:t},r){if(r[2].body.length===0)throw new Q(e+"cannot parse an empty base.");const o=r[2].body[0];if(n.settings.strict&&e==="\\sideset"&&!o.symbol)throw new Q("The base of \\sideset must be a big operator. Try \\prescript.");if(r[0].body.length>0&&r[0].body[0].type!=="supsub"||r[1].body.length>0&&r[1].body[0].type!=="supsub")throw new Q("\\sideset can parse only subscripts and superscripts in its first two arguments",t);const i=r[0].body.length>0?r[0].body[0]:null,s=r[1].body.length>0?r[1].body[0]:null;return!i&&!s?o:i?{type:"multiscript",mode:n.mode,isSideset:e==="\\sideset",prescripts:i,postscripts:s,base:o}:{type:"styling",mode:n.mode,scriptLevel:"text",body:[{type:"supsub",mode:n.mode,base:o,sup:s.sup,sub:s.sub}]}},mathmlBuilder(n,e){const t=qe(n.base,e),r=new P("mprescripts"),o=new P("none");let i=[];const s=to(n.prescripts.sub,e,o),a=to(n.prescripts.sup,e,o);if(n.isSideset&&(s.setAttribute("style","text-align: left;"),a.setAttribute("style","text-align: left;")),n.postscripts){const l=to(n.postscripts.sub,e,o),d=to(n.postscripts.sup,e,o);i=[t,l,d,r,s,a]}else i=[t,r,s,a];return new P("mmultiscripts",i)}});ue({type:"not",names:["\\not"],props:{numArgs:1,primitive:!0,allowedInText:!1},handler({parser:n},e){const t=$o(e[0]);let r;return t?(r=ht(e[0]),r[0].text.charAt(0)==="\\"&&(r[0].text=ct.math[r[0].text].replace),r[0].text=r[0].text.slice(0,1)+"Ì¸"+r[0].text.slice(1)):r=[{type:"textord",mode:"math",text:"Ì¸"},{type:"kern",mode:"math",dimension:{number:-.6,unit:"em"}},e[0]],{type:"not",mode:n.mode,body:r,isCharacterBox:t}},mathmlBuilder(n,e){return n.isCharacterBox?kt(n.body,e,!0)[0]:Tn(n.body,e)}});const nh=["textord","mathord","atom"],rh=["\\smallint"],Us=["textord","mathord","ordgroup","close","leftright","font"],Aa=n=>{n.attributes.lspace="0.1667em",n.attributes.rspace="0.1667em"},Kr=(n,e)=>{let t;if(n.symbol)t=new P("mo",[$t(n.name,n.mode)]),rh.includes(n.name)?t.setAttribute("largeop","false"):t.setAttribute("movablelimits","false"),n.fromMathOp&&Aa(t);else if(n.body)t=new P("mo",kt(n.body,e)),n.fromMathOp&&Aa(t);else if(t=new P("mi",[new ft(n.name.slice(1))]),!n.parentIsSupSub){const r=new P("mo",[$t("â¡","text")]),o=[t,r];if(n.needsLeadingSpace){const i=new P("mspace");i.setAttribute("width","0.1667em"),o.unshift(i)}if(!n.isFollowedByDelimiter){const i=new P("mspace");i.setAttribute("width","0.1667em"),o.push(i)}t=new P("mrow",o)}return t},oh={"âˆ":"\\prod","âˆ":"\\coprod","âˆ‘":"\\sum","â‹€":"\\bigwedge","â‹":"\\bigvee","â‹‚":"\\bigcap","â‹ƒ":"\\bigcup","â¨€":"\\bigodot","â¨":"\\bigoplus","â¨‚":"\\bigotimes","â¨„":"\\biguplus","â¨…":"\\bigsqcap","â¨†":"\\bigsqcup","â¨ƒ":"\\bigcupdot","â¨‡":"\\bigdoublevee","â¨ˆ":"\\bigdoublewedge","â¨‰":"\\bigtimes"};ue({type:"op",names:["\\coprod","\\bigvee","\\bigwedge","\\biguplus","\\bigcupplus","\\bigcupdot","\\bigcap","\\bigcup","\\bigdoublevee","\\bigdoublewedge","\\intop","\\prod","\\sum","\\bigotimes","\\bigoplus","\\bigodot","\\bigsqcap","\\bigsqcup","\\bigtimes","\\smallint","âˆ","âˆ","âˆ‘","â‹€","â‹","â‹‚","â‹ƒ","â¨€","â¨","â¨‚","â¨ƒ","â¨„","â¨…","â¨†","â¨‡","â¨ˆ","â¨‰"],props:{numArgs:0},handler:({parser:n,funcName:e},t)=>{let r=e;return r.length===1&&(r=oh[r]),{type:"op",mode:n.mode,limits:!0,parentIsSupSub:!1,symbol:!0,stack:!1,name:r}},mathmlBuilder:Kr});ue({type:"op",names:["\\mathop"],props:{numArgs:1,primitive:!0},handler:({parser:n},e)=>{const t=e[0],r=t.body?t.body:[t],o=r.length===1&&nh.includes(r[0].type);return{type:"op",mode:n.mode,limits:!0,parentIsSupSub:!1,symbol:o,fromMathOp:!0,stack:!1,name:o?r[0].text:null,body:o?null:ht(t)}},mathmlBuilder:Kr});const ih={"âˆ«":"\\int","âˆ¬":"\\iint","âˆ­":"\\iiint","âˆ®":"\\oint","âˆ¯":"\\oiint","âˆ°":"\\oiiint","âˆ±":"\\intclockwise","âˆ²":"\\varointclockwise","â¨Œ":"\\iiiint","â¨":"\\intbar","â¨":"\\intBar","â¨":"\\fint","â¨’":"\\rppolint","â¨“":"\\scpolint","â¨•":"\\pointint","â¨–":"\\sqint","â¨—":"\\intlarhk","â¨˜":"\\intx","â¨™":"\\intcap","â¨š":"\\intcup"};ue({type:"op",names:["\\arcsin","\\arccos","\\arctan","\\arctg","\\arcctg","\\arg","\\ch","\\cos","\\cosec","\\cosh","\\cot","\\cotg","\\coth","\\csc","\\ctg","\\cth","\\deg","\\dim","\\exp","\\hom","\\ker","\\lg","\\ln","\\log","\\sec","\\sin","\\sinh","\\sh","\\sgn","\\tan","\\tanh","\\tg","\\th"],props:{numArgs:0},handler({parser:n,funcName:e}){const t=n.prevAtomType,r=n.gullet.future().text;return{type:"op",mode:n.mode,limits:!1,parentIsSupSub:!1,symbol:!1,stack:!1,isFollowedByDelimiter:Ho(r),needsLeadingSpace:t.length>0&&Us.includes(t),name:e}},mathmlBuilder:Kr});ue({type:"op",names:["\\det","\\gcd","\\inf","\\lim","\\max","\\min","\\Pr","\\sup"],props:{numArgs:0},handler({parser:n,funcName:e}){const t=n.prevAtomType,r=n.gullet.future().text;return{type:"op",mode:n.mode,limits:!0,parentIsSupSub:!1,symbol:!1,stack:!1,isFollowedByDelimiter:Ho(r),needsLeadingSpace:t.length>0&&Us.includes(t),name:e}},mathmlBuilder:Kr});ue({type:"op",names:["\\int","\\iint","\\iiint","\\iiiint","\\oint","\\oiint","\\oiiint","\\intclockwise","\\varointclockwise","\\intbar","\\intBar","\\fint","\\rppolint","\\scpolint","\\pointint","\\sqint","\\intlarhk","\\intx","\\intcap","\\intcup","âˆ«","âˆ¬","âˆ­","âˆ®","âˆ¯","âˆ°","âˆ±","âˆ²","â¨Œ","â¨","â¨","â¨","â¨’","â¨“","â¨•","â¨–","â¨—","â¨˜","â¨™","â¨š"],props:{numArgs:0,allowedInArgument:!0},handler({parser:n,funcName:e}){let t=e;return t.length===1&&(t=ih[t]),{type:"op",mode:n.mode,limits:!1,parentIsSupSub:!1,symbol:!0,stack:!1,name:t}},mathmlBuilder:Kr});const sh=(n,e)=>{let t=kt(n.body,e.withFont("mathrm")),r=!0;for(let i=0;i<t.length;i++){let s=t[i];if(s instanceof P)switch((s.type==="mrow"||s.type==="mpadded")&&s.children.length===1&&s.children[0]instanceof P&&(s=s.children[0]),s.type){case"mi":case"mn":case"ms":case"mtext":break;case"mspace":if(s.attributes.width){const a=s.attributes.width.replace("em",""),l=kc(Number(a));l===""?r=!1:t[i]=new P("mtext",[new ft(l)])}break;case"mo":{const a=s.children[0];s.children.length===1&&a instanceof ft?a.text=a.text.replace(/\u2212/,"-").replace(/\u2217/,"*"):r=!1;break}default:r=!1}else r=!1}if(r){const i=t.map(s=>s.toText()).join("");t=[new ft(i)]}else if(t.length===1&&["mover","munder"].includes(t[0].type)&&(t[0].children[0].type==="mi"||t[0].children[0].type==="mtext")){if(t[0].children[0].type="mi",n.parentIsSupSub)return new P("mrow",t);{const i=new P("mo",[$t("â¡","text")]);return Ln([t[0],i])}}let o;if(r?(o=new P("mi",t),t[0].text.length===1&&o.setAttribute("mathvariant","normal")):o=new P("mrow",t),!n.parentIsSupSub){const i=new P("mo",[$t("â¡","text")]),s=[o,i];if(n.needsLeadingSpace){const a=new P("mspace");a.setAttribute("width","0.1667em"),s.unshift(a)}if(!n.isFollowedByDelimiter){const a=new P("mspace");a.setAttribute("width","0.1667em"),s.push(a)}return Ln(s)}return o};ue({type:"operatorname",names:["\\operatorname@","\\operatornamewithlimits"],props:{numArgs:1,allowedInArgument:!0},handler:({parser:n,funcName:e},t)=>{const r=t[0],o=n.prevAtomType,i=n.gullet.future().text;return{type:"operatorname",mode:n.mode,body:ht(r),alwaysHandleSupSub:e==="\\operatornamewithlimits",limits:!1,parentIsSupSub:!1,isFollowedByDelimiter:Ho(i),needsLeadingSpace:o.length>0&&Us.includes(o)}},mathmlBuilder:sh});E("\\operatorname","\\@ifstar\\operatornamewithlimits\\operatorname@");Nn({type:"ordgroup",mathmlBuilder(n,e){return Tn(n.body,e,n.semisimple)}});ue({type:"phantom",names:["\\phantom"],props:{numArgs:1,allowedInText:!0},handler:({parser:n},e)=>{const t=e[0];return{type:"phantom",mode:n.mode,body:ht(t)}},mathmlBuilder:(n,e)=>{const t=kt(n.body,e);return new P("mphantom",t)}});ue({type:"hphantom",names:["\\hphantom"],props:{numArgs:1,allowedInText:!0},handler:({parser:n},e)=>{const t=e[0];return{type:"hphantom",mode:n.mode,body:t}},mathmlBuilder:(n,e)=>{const t=kt(ht(n.body),e),r=new P("mphantom",t),o=new P("mpadded",[r]);return o.setAttribute("height","0px"),o.setAttribute("depth","0px"),o}});ue({type:"vphantom",names:["\\vphantom"],props:{numArgs:1,allowedInText:!0},handler:({parser:n},e)=>{const t=e[0];return{type:"vphantom",mode:n.mode,body:t}},mathmlBuilder:(n,e)=>{const t=kt(ht(n.body),e),r=new P("mphantom",t),o=new P("mpadded",[r]);return o.setAttribute("width","0px"),o}});ue({type:"pmb",names:["\\pmb"],props:{numArgs:1,allowedInText:!0},handler({parser:n},e){return{type:"pmb",mode:n.mode,body:ht(e[0])}},mathmlBuilder(n,e){const t=kt(n.body,e),r=Fs(t);return r.setAttribute("style","font-weight:bold"),r}});const Dc=(n,e)=>{const t=e.withLevel(lt.TEXT),r=new P("mpadded",[qe(n.body,t)]),o=an(n.dy,e);return r.setAttribute("voffset",o.number+o.unit),o.number>0?r.style.padding=o.number+o.unit+" 0 0 0":r.style.padding="0 0 "+Math.abs(o.number)+o.unit+" 0",r};ue({type:"raise",names:["\\raise","\\lower"],props:{numArgs:2,argTypes:["size","primitive"],primitive:!0},handler({parser:n,funcName:e},t){const r=_e(t[0],"size").value;e==="\\lower"&&(r.number*=-1);const o=t[1];return{type:"raise",mode:n.mode,dy:r,body:o}},mathmlBuilder:Dc});ue({type:"raise",names:["\\raisebox"],props:{numArgs:2,argTypes:["size","hbox"],allowedInText:!0},handler({parser:n,funcName:e},t){const r=_e(t[0],"size").value,o=t[1];return{type:"raise",mode:n.mode,dy:r,body:o}},mathmlBuilder:Dc});ue({type:"ref",names:["\\ref","\\eqref"],props:{numArgs:1,argTypes:["raw"]},handler({parser:n,funcName:e},t){return{type:"ref",mode:n.mode,funcName:e,string:t[0].string.replace(Ac,"")}},mathmlBuilder(n,e){const t=n.funcName==="\\ref"?["tml-ref"]:["tml-ref","tml-eqref"];return new cc("#"+n.string,t,null)}});ue({type:"reflect",names:["\\reflectbox"],props:{numArgs:1,argTypes:["hbox"],allowedInText:!0},handler({parser:n},e){return{type:"reflect",mode:n.mode,body:e[0]}},mathmlBuilder(n,e){const t=qe(n.body,e);return t.style.transform="scaleX(-1)",t}});ue({type:"internal",names:["\\relax"],props:{numArgs:0,allowedInText:!0,allowedInArgument:!0},handler({parser:n}){return{type:"internal",mode:n.mode}}});ue({type:"rule",names:["\\rule"],props:{numArgs:2,numOptionalArgs:1,allowedInText:!0,allowedInMath:!0,argTypes:["size","size","size"]},handler({parser:n},e,t){const r=t[0],o=_e(e[0],"size"),i=_e(e[1],"size");return{type:"rule",mode:n.mode,shift:r&&_e(r,"size").value,width:o.value,height:i.value}},mathmlBuilder(n,e){const t=an(n.width,e),r=an(n.height,e),o=n.shift?an(n.shift,e):{number:0,unit:"em"},i=e.color&&e.getColor()||"black",s=new P("mspace");if(t.number>0&&r.number>0&&s.setAttribute("mathbackground",i),s.setAttribute("width",t.number+t.unit),s.setAttribute("height",r.number+r.unit),o.number===0)return s;const a=new P("mpadded",[s]);return o.number>=0?a.setAttribute("height","+"+o.number+o.unit):(a.setAttribute("height",o.number+o.unit),a.setAttribute("depth","+"+-o.number+o.unit)),a.setAttribute("voffset",o.number+o.unit),a}});const Ia=/^[0-9]$/,ah={0:"â‚€",1:"â‚",2:"â‚‚",3:"â‚ƒ",4:"â‚„",5:"â‚…",6:"â‚†",7:"â‚‡",8:"â‚ˆ",9:"â‚‰"},lh={0:"â°",1:"Â¹",2:"Â²",3:"Â³",4:"â´",5:"âµ",6:"â¶",7:"â·",8:"â¸",9:"â¹"};ue({type:"sfrac",names:["\\sfrac"],props:{numArgs:2,allowedInText:!0,allowedInMath:!0},handler({parser:n},e){let t="";for(const o of e[0].body){if(o.type!=="textord"||!Ia.test(o.text))throw new Q("Numerator must be an integer.",o);t+=o.text}let r="";for(const o of e[1].body){if(o.type!=="textord"||!Ia.test(o.text))throw new Q("Denominator must be an integer.",o);r+=o.text}return{type:"sfrac",mode:n.mode,numerator:t,denominator:r}},mathmlBuilder(n,e){const t=n.numerator.split("").map(i=>lh[i]).join(""),r=n.denominator.split("").map(i=>ah[i]).join(""),o=new ft(t+"â„"+r,n.mode,e);return new P("mn",[o],["special-fraction"])}});const La={"\\tiny":.5,"\\sixptsize":.6,"\\Tiny":.6,"\\scriptsize":.7,"\\footnotesize":.8,"\\small":.9,"\\normalsize":1,"\\large":1.2,"\\Large":1.44,"\\LARGE":1.728,"\\huge":2.074,"\\Huge":2.488};ue({type:"sizing",names:["\\tiny","\\sixptsize","\\Tiny","\\scriptsize","\\footnotesize","\\small","\\normalsize","\\large","\\Large","\\LARGE","\\huge","\\Huge"],props:{numArgs:0,allowedInText:!0},handler:({breakOnTokenText:n,funcName:e,parser:t},r)=>{t.settings.strict&&t.mode==="math"&&console.log(`Temml strict-mode warning: Command ${e} is invalid in math mode.`);const o=t.parseExpression(!1,n,!0);return{type:"sizing",mode:t.mode,funcName:e,body:o}},mathmlBuilder:(n,e)=>{const t=e.withFontSize(La[n.funcName]),r=kt(n.body,t),o=Fs(r),i=(La[n.funcName]/e.fontSize).toFixed(4);return o.setAttribute("mathsize",i+"em"),o}});ue({type:"smash",names:["\\smash"],props:{numArgs:1,numOptionalArgs:1,allowedInText:!0},handler:({parser:n},e,t)=>{let r=!1,o=!1;const i=t[0]&&_e(t[0],"ordgroup");if(i){let a="";for(let l=0;l<i.body.length;++l)if(a=i.body[l].text,a==="t")r=!0;else if(a==="b")o=!0;else{r=!1,o=!1;break}}else r=!0,o=!0;const s=e[0];return{type:"smash",mode:n.mode,body:s,smashHeight:r,smashDepth:o}},mathmlBuilder:(n,e)=>{const t=new P("mpadded",[qe(n.body,e)]);return n.smashHeight&&t.setAttribute("height","0px"),n.smashDepth&&t.setAttribute("depth","0px"),t}});const ch=["a","c","e","Ä±","m","n","o","r","s","u","v","w","x","z","Î±","Îµ","Î¹","Îº","Î½","Î¿","Ï€","Ïƒ","Ï„","Ï…","Ï‰","\\alpha","\\epsilon","\\iota","\\kappa","\\nu","\\omega","\\pi","\\tau","\\omega"];ue({type:"sqrt",names:["\\sqrt"],props:{numArgs:1,numOptionalArgs:1},handler({parser:n},e,t){const r=t[0],o=e[0];return o.body&&o.body.length===1&&o.body[0].text&&ch.includes(o.body[0].text)&&o.body.push({type:"rule",mode:"math",shift:null,width:{number:0,unit:"pt"},height:{number:.5,unit:"em"}}),{type:"sqrt",mode:n.mode,body:o,index:r}},mathmlBuilder(n,e){const{body:t,index:r}=n;return r?new P("mroot",[qe(t,e),qe(r,e.incrementLevel())]):new P("msqrt",[qe(t,e)])}});const dh={display:0,text:1,script:2,scriptscript:3},uh={display:["0","true"],text:["0","false"],script:["1","false"],scriptscript:["2","false"]};ue({type:"styling",names:["\\displaystyle","\\textstyle","\\scriptstyle","\\scriptscriptstyle"],props:{numArgs:0,allowedInText:!0,primitive:!0},handler({breakOnTokenText:n,funcName:e,parser:t},r){const o=t.parseExpression(!0,n,!0),i=e.slice(1,e.length-5);return{type:"styling",mode:t.mode,scriptLevel:i,body:o}},mathmlBuilder(n,e){const t=e.withLevel(dh[n.scriptLevel]),r=kt(n.body,t),o=Fs(r),i=uh[n.scriptLevel];return o.setAttribute("scriptlevel",i[0]),o.setAttribute("displaystyle",i[1]),o}});const hh=/^m(over|under|underover)$/,mh="DHKLUcegorsuvxyzÎ Î¥Î¨Î±Î´Î·Î¹Î¼Î½Î¿Ï„Ï…Ï‡Ïµ",ph="BCEFGIMNOPQRSTXZlpqtwÎ“Î˜ÎÎ£Î¦Î©Î²ÎµÎ¶Î¸Î¾ÏÏ‚Ï†ÏˆÏ‘Ï•Ï±",fh="AJdfÎ”Î›";Nn({type:"supsub",mathmlBuilder(n,e){let t=!1,r,o,i=!1,s=!1,a=!1;n.base&&n.base.type==="horizBracket"&&(o=!!n.sup,o===n.base.isOver&&(t=!0,r=n.base.isOver)),n.base&&!n.stack&&(n.base.type==="op"||n.base.type==="operatorname")&&(n.base.parentIsSupSub=!0,i=!n.base.symbol,s=i&&!n.isFollowedByDelimiter,a=n.base.needsLeadingSpace);const l=n.stack&&n.base.body.length===1?[qe(n.base.body[0],e)]:[qe(n.base,e)],d=e.inSubOrSup();if(n.sub){const p=qe(n.sub,d);e.level===3&&p.setAttribute("scriptlevel","2"),l.push(p)}if(n.sup){const p=qe(n.sup,d);if(e.level===3&&p.setAttribute("scriptlevel","2"),n.base&&n.base.text&&n.base.text.length===1){const f=n.base.text;mh.indexOf(f)>-1?p.classes.push("tml-sml-pad"):ph.indexOf(f)>-1?p.classes.push("tml-med-pad"):fh.indexOf(f)>-1&&p.classes.push("tml-lrg-pad")}l.push(p)}let u;if(t)u=r?"mover":"munder";else if(n.sub)if(n.sup){const p=n.base;p&&(p.type==="op"&&p.limits||p.type==="multiscript")&&(e.level===lt.DISPLAY||p.alwaysHandleSupSub)||p&&p.type==="operatorname"&&p.alwaysHandleSupSub&&(e.level===lt.DISPLAY||p.limits)?u="munderover":u="msubsup"}else{const p=n.base;n.stack||p&&p.type==="op"&&p.limits&&(e.level===lt.DISPLAY||p.alwaysHandleSupSub)||p&&p.type==="operatorname"&&p.alwaysHandleSupSub&&(p.limits||e.level===lt.DISPLAY)?u="munder":u="msub"}else{const p=n.base;p&&p.type==="op"&&p.limits&&(e.level===lt.DISPLAY||p.alwaysHandleSupSub)||p&&p.type==="operatorname"&&p.alwaysHandleSupSub&&(p.limits||e.level===lt.DISPLAY)?u="mover":u="msup"}let m=new P(u,l);if(i){const p=new P("mo",[$t("â¡","text")]);if(a){const f=new P("mspace");f.setAttribute("width","0.1667em"),m=Ln([f,m,p])}else m=Ln([m,p]);if(s){const f=new P("mspace");f.setAttribute("width","0.1667em"),m.children.push(f)}}else hh.test(u)&&(m=new P("mrow",[m]));return m}});const gh=["\\shortmid","\\nshortmid","\\shortparallel","\\nshortparallel","\\smallsetminus"],bh=["\\Rsh","\\Lsh","\\restriction"],vh=n=>{if(n.length===1){const e=n.codePointAt(0);return 8591<e&&e<8704}return n.indexOf("arrow")>-1||n.indexOf("harpoon")>-1||bh.includes(n)};Nn({type:"atom",mathmlBuilder(n,e){const t=new P("mo",[$t(n.text,n.mode)]);if(n.family==="punct")t.setAttribute("separator","true");else if(n.family==="open"||n.family==="close")n.family==="open"?(t.setAttribute("form","prefix"),t.setAttribute("stretchy","false")):n.family==="close"&&(t.setAttribute("form","postfix"),t.setAttribute("stretchy","false"));else if(n.text==="\\mid")t.setAttribute("lspace","0.22em"),t.setAttribute("rspace","0.22em"),t.setAttribute("stretchy","false");else if(n.family==="rel"&&vh(n.text))t.setAttribute("stretchy","false");else if(gh.includes(n.text))t.setAttribute("mathsize","70%");else if(n.text===":")t.attributes.lspace="0.2222em",t.attributes.rspace="0.2222em";else if(n.needsSpacing)return n.family==="bin"?new P("mrow",[at(.222),t,at(.222)]):new P("mrow",[at(.2778),t,at(.2778)]);return t}});const Da={mathbf:"bold",mathrm:"normal",textit:"italic",mathit:"italic",mathnormal:"italic",mathbb:"double-struck",mathcal:"script",mathfrak:"fraktur",mathscr:"script",mathsf:"sans-serif",mathtt:"monospace"},Mc=function(n,e){if(e.fontFamily==="texttt")return"monospace";if(e.fontFamily==="textsc")return"normal";if(e.fontFamily==="textsf")return e.fontShape==="textit"&&e.fontWeight==="textbf"?"sans-serif-bold-italic":e.fontShape==="textit"?"sans-serif-italic":e.fontWeight==="textbf"?"sans-serif-bold":"sans-serif";if(e.fontShape==="textit"&&e.fontWeight==="textbf")return"bold-italic";if(e.fontShape==="textit")return"italic";if(e.fontWeight==="textbf")return"bold";const t=e.font;if(!t||t==="mathnormal")return null;const r=n.mode;switch(t){case"mathit":return"italic";case"mathrm":{const i=n.text.codePointAt(0);return 939<i&&i<975?"italic":"normal"}case"greekItalic":return"italic";case"up@greek":return"normal";case"boldsymbol":case"mathboldsymbol":return"bold-italic";case"mathbf":return"bold";case"mathbb":return"double-struck";case"mathfrak":return"fraktur";case"mathscr":case"mathcal":return"script";case"mathsf":return"sans-serif";case"mathsfit":return"sans-serif-italic";case"mathtt":return"monospace"}let o=n.text;return ct[r][o]&&ct[r][o].replace&&(o=ct[r][o].replace),Object.prototype.hasOwnProperty.call(Da,t)?Da[t]:null},Ma=Object.freeze({B:8426,E:8427,F:8427,H:8387,I:8391,L:8390,M:8422,R:8393,e:8394,g:8355,o:8389}),yh=Object.freeze({C:8426,H:8388,I:8392,R:8394,Z:8398}),wh=Object.freeze({C:8383,H:8389,N:8391,P:8393,Q:8393,R:8395,Z:8394}),Nc=Object.freeze({"Ïµ":119527,Ï‘:119564,Ï°:119534,Ï†:119577,Ï±:119535,Ï–:119563}),xh=Object.freeze({"Ïµ":119643,Ï‘:119680,Ï°:119650,Ï†:119693,Ï±:119651,Ï–:119679}),Na=Object.freeze({"Ïµ":119701,Ï‘:119738,Ï°:119708,Ï†:119751,Ï±:119709,Ï–:119737}),Sh=Object.freeze({"Ïµ":119759,Ï‘:119796,Ï°:119766,Ï†:119809,Ï±:119767,Ï–:119795}),Eh=Object.freeze({upperCaseLatin:{normal:n=>0,bold:n=>119743,italic:n=>119795,"bold-italic":n=>119847,script:n=>Ma[n]||119899,"script-bold":n=>119951,fraktur:n=>yh[n]||120003,"fraktur-bold":n=>120107,"double-struck":n=>wh[n]||120055,"sans-serif":n=>120159,"sans-serif-bold":n=>120211,"sans-serif-italic":n=>120263,"sans-serif-bold-italic":n=>120380,monospace:n=>120367},lowerCaseLatin:{normal:n=>0,bold:n=>119737,italic:n=>n==="h"?8358:119789,"bold-italic":n=>119841,script:n=>Ma[n]||119893,"script-bold":n=>119945,fraktur:n=>119997,"fraktur-bold":n=>120101,"double-struck":n=>120049,"sans-serif":n=>120153,"sans-serif-bold":n=>120205,"sans-serif-italic":n=>120257,"sans-serif-bold-italic":n=>120309,monospace:n=>120361},upperCaseGreek:{normal:n=>0,bold:n=>119575,italic:n=>119633,"bold-italic":n=>119575,script:n=>0,"script-bold":n=>0,fraktur:n=>0,"fraktur-bold":n=>0,"double-struck":n=>0,"sans-serif":n=>119749,"sans-serif-bold":n=>119749,"sans-serif-italic":n=>0,"sans-serif-bold-italic":n=>119807,monospace:n=>0},lowerCaseGreek:{normal:n=>0,bold:n=>119569,italic:n=>119627,"bold-italic":n=>n==="Ï•"?119678:119685,script:n=>0,"script-bold":n=>0,fraktur:n=>0,"fraktur-bold":n=>0,"double-struck":n=>0,"sans-serif":n=>119743,"sans-serif-bold":n=>119743,"sans-serif-italic":n=>0,"sans-serif-bold-italic":n=>119801,monospace:n=>0},varGreek:{normal:n=>0,bold:n=>Nc[n]||-51,italic:n=>0,"bold-italic":n=>xh[n]||58,script:n=>0,"script-bold":n=>0,fraktur:n=>0,"fraktur-bold":n=>0,"double-struck":n=>0,"sans-serif":n=>Na[n]||116,"sans-serif-bold":n=>Na[n]||116,"sans-serif-italic":n=>0,"sans-serif-bold-italic":n=>Sh[n]||174,monospace:n=>0},numeral:{normal:n=>0,bold:n=>120734,italic:n=>0,"bold-italic":n=>0,script:n=>0,"script-bold":n=>0,fraktur:n=>0,"fraktur-bold":n=>0,"double-struck":n=>120744,"sans-serif":n=>120754,"sans-serif-bold":n=>120764,"sans-serif-italic":n=>0,"sans-serif-bold-italic":n=>0,monospace:n=>120774}}),Ar=(n,e)=>{const t=n.codePointAt(0),r=64<t&&t<91?"upperCaseLatin":96<t&&t<123?"lowerCaseLatin":912<t&&t<938?"upperCaseGreek":944<t&&t<970||n==="Ï•"?"lowerCaseGreek":120545<t&&t<120572||Nc[n]?"varGreek":47<t&&t<58?"numeral":"other";return r==="other"?n:String.fromCodePoint(t+Eh[r][e](n))},Ch=Object.freeze({a:"á´€",b:"Ê™",c:"á´„",d:"á´…",e:"á´‡",f:"êœ°",g:"É¢",h:"Êœ",i:"Éª",j:"á´Š",k:"á´‹",l:"ÊŸ",m:"á´",n:"É´",o:"á´",p:"á´˜",q:"Ç«",r:"Ê€",s:"s",t:"á´›",u:"á´œ",v:"á´ ",w:"á´¡",x:"x",y:"Ê",z:"á´¢"}),Th=/^\d(?:[\d,.]*\d)?$/,_h=/[A-Ba-z]/,kh=new Set(["\\prime","\\dprime","\\trprime","\\qprime","\\backprime","\\backdprime","\\backtrprime"]),Ah=(n,e,t)=>{const r=new P(t,[n]),o=new P("mstyle",[r]);return o.style["font-style"]="italic",o.style["font-family"]="Cambria, 'Times New Roman', serif",e==="bold-italic"&&(o.style["font-weight"]="bold"),o};Nn({type:"mathord",mathmlBuilder(n,e){const t=$t(n.text,n.mode,e),r=t.text.codePointAt(0),o=912<r&&r<938?"normal":"italic",i=Mc(n,e)||o;if(i==="script")return t.text=Ar(t.text,i),new P("mi",[t],[e.font]);i!=="italic"&&(t.text=Ar(t.text,i));let s=new P("mi",[t]);return i==="normal"&&(s.setAttribute("mathvariant","normal"),t.text.length===1&&(s=new P("mpadded",[s]),s.setAttribute("lspace","0"))),s}});Nn({type:"textord",mathmlBuilder(n,e){let t=n.text;const r=t.codePointAt(0);e.fontFamily==="textsc"&&96<r&&r<123&&(t=Ch[t]);const o=$t(t,n.mode,e),i=Mc(n,e)||"normal";let s;if(Th.test(n.text)){const a=n.mode==="text"?"mtext":"mn";if(i==="italic"||i==="bold-italic")return Ah(o,i,a);i!=="normal"&&(o.text=o.text.split("").map(l=>Ar(l,i)).join("")),s=new P(a,[o])}else if(n.mode==="text")i!=="normal"&&(o.text=Ar(o.text,i)),s=new P("mtext",[o]);else if(kh.has(n.text))s=new P("mo",[o]),s.classes.push("tml-prime");else{const a=o.text;i!=="italic"&&(o.text=Ar(o.text,i)),s=new P("mi",[o]),o.text===a&&_h.test(a)&&s.setAttribute("mathvariant","italic")}return s}});const Ih={"\\nobreak":"nobreak","\\allowbreak":"allowbreak"},Lh={" ":{},"\\ ":{},"~":{className:"nobreak"},"\\space":{},"\\nobreakspace":{className:"nobreak"}};Nn({type:"spacing",mathmlBuilder(n,e){let t;if(Object.prototype.hasOwnProperty.call(Lh,n.text))t=new P("mtext",[new ft("Â ")]);else if(Object.prototype.hasOwnProperty.call(Ih,n.text))t=new P("mo"),n.text==="\\nobreak"&&t.setAttribute("linebreak","nobreak");else throw new Q(`Unknown type of space "${n.text}"`);return t}});Nn({type:"tag"});const Fa={"\\text":void 0,"\\textrm":"textrm","\\textsf":"textsf","\\texttt":"texttt","\\textnormal":"textrm","\\textsc":"textsc"},Oa={"\\textbf":"textbf","\\textmd":"textmd"},Dh={"\\textit":"textit","\\textup":"textup"},Mh=(n,e)=>{const t=n.font;if(t){if(Fa[t])return e.withTextFontFamily(Fa[t]);if(Oa[t])return e.withTextFontWeight(Oa[t]);if(t==="\\emph")return e.fontShape==="textit"?e.withTextFontShape("textup"):e.withTextFontShape("textit")}else return e;return e.withTextFontShape(Dh[t])};ue({type:"text",names:["\\text","\\textrm","\\textsf","\\texttt","\\textnormal","\\textsc","\\textbf","\\textmd","\\textit","\\textup","\\emph"],props:{numArgs:1,argTypes:["text"],allowedInArgument:!0,allowedInText:!0},handler({parser:n,funcName:e},t){const r=t[0];return{type:"text",mode:n.mode,body:ht(r),font:e}},mathmlBuilder(n,e){const t=Mh(n,e),r=Tn(n.body,t);return qo(r)}});ue({type:"vcenter",names:["\\vcenter"],props:{numArgs:1,argTypes:["original"],allowedInText:!1},handler({parser:n},e){return{type:"vcenter",mode:n.mode,body:e[0]}},mathmlBuilder(n,e){const t=new P("mtd",[qe(n.body,e)]);t.style.padding="0";const r=new P("mtr",[t]);return new P("mtable",[r])}});ue({type:"verb",names:["\\verb"],props:{numArgs:0,allowedInText:!0},handler(n,e,t){throw new Q("\\verb ended by end of line instead of matching delimiter")},mathmlBuilder(n,e){const t=new ft(Nh(n)),r=new P("mtext",[t]);return r.setAttribute("mathvariant","monospace"),r}});const Nh=n=>n.body.replace(/ /g,n.star?"â£":"Â "),kn=ac,Fc=`[ \r
	]`,Fh="\\\\[a-zA-Z@]+",Oh="\\\\[^\uD800-\uDFFF]",Rh=`(${Fh})${Fc}*`,Ph=`\\\\(
|[ \r	]+
?)[ \r	]*`,Vi="[Ì€-Í¯]",Ra=new RegExp(`${Vi}+$`),Bh=`(${Fc}+)|${Ph}|([!-\\[\\]-â€§â€ª-íŸ¿ï¤€-ï¿¿]${Vi}*|[\uD800-\uDBFF][\uDC00-\uDFFF]${Vi}*|\\\\verb\\*([^]).*?\\4|\\\\verb([^*a-zA-Z]).*?\\5|${Rh}|${Oh})`;class Pa{constructor(e,t){this.input=e,this.settings=t,this.tokenRegex=new RegExp(Bh,"g"),this.catcodes={"%":14,"~":13}}setCatcode(e,t){this.catcodes[e]=t}lex(){const e=this.input,t=this.tokenRegex.lastIndex;if(t===e.length)return new Qt("EOF",new Bt(this,t,t));const r=this.tokenRegex.exec(e);if(r===null||r.index!==t)throw new Q(`Unexpected character: '${e[t]}'`,new Qt(e[t],new Bt(this,t,t+1)));const o=r[6]||r[3]||(r[2]?"\\ ":" ");if(this.catcodes[o]===14){const i=e.indexOf(`
`,this.tokenRegex.lastIndex);if(i===-1){if(this.tokenRegex.lastIndex=e.length,this.settings.strict)throw new Q("% comment has no terminating newline; LaTeX would fail because of commenting the end of math mode")}else this.tokenRegex.lastIndex=i+1;return this.lex()}return new Qt(o,new Bt(this,t,this.tokenRegex.lastIndex))}}class $h{constructor(e={},t={}){this.current=t,this.builtins=e,this.undefStack=[]}beginGroup(){this.undefStack.push({})}endGroup(){if(this.undefStack.length===0)throw new Q("Unbalanced namespace destruction: attempt to pop global namespace; please report this as a bug");const e=this.undefStack.pop();for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(e[t]===void 0?delete this.current[t]:this.current[t]=e[t])}has(e){return Object.prototype.hasOwnProperty.call(this.current,e)||Object.prototype.hasOwnProperty.call(this.builtins,e)}get(e){return Object.prototype.hasOwnProperty.call(this.current,e)?this.current[e]:this.builtins[e]}set(e,t,r=!1){if(r){for(let o=0;o<this.undefStack.length;o++)delete this.undefStack[o][e];this.undefStack.length>0&&(this.undefStack[this.undefStack.length-1][e]=t)}else{const o=this.undefStack[this.undefStack.length-1];o&&!Object.prototype.hasOwnProperty.call(o,e)&&(o[e]=this.current[e])}this.current[e]=t}}const Oc={"^":!0,_:!0,"\\limits":!0,"\\nolimits":!0};class qh{constructor(e,t,r){this.settings=t,this.expansionCount=0,this.feed(e),this.macros=new $h(Pu,t.macros),this.mode=r,this.stack=[]}feed(e){this.lexer=new Pa(e,this.settings)}switchMode(e){this.mode=e}beginGroup(){this.macros.beginGroup()}endGroup(){this.macros.endGroup()}future(){return this.stack.length===0&&this.pushToken(this.lexer.lex()),this.stack[this.stack.length-1]}popToken(){return this.future(),this.stack.pop()}pushToken(e){this.stack.push(e)}pushTokens(e){this.stack.push(...e)}scanArgument(e){let t,r,o;if(e){if(this.consumeSpaces(),this.future().text!=="[")return null;t=this.popToken(),{tokens:o,end:r}=this.consumeArg(["]"])}else({tokens:o,start:t,end:r}=this.consumeArg());return this.pushToken(new Qt("EOF",r.loc)),this.pushTokens(o),t.range(r,"")}consumeSpaces(){for(;this.future().text===" ";)this.stack.pop()}consumeArg(e){const t=[],r=e&&e.length>0;r||this.consumeSpaces();const o=this.future();let i,s=0,a=0;do{if(i=this.popToken(),t.push(i),i.text==="{")++s;else if(i.text==="}"){if(--s,s===-1)throw new Q("Extra }",i)}else if(i.text==="EOF")throw new Q("Unexpected end of input in a macro argument, expected '"+(e&&r?e[a]:"}")+"'",i);if(e&&r)if((s===0||s===1&&e[a]==="{")&&i.text===e[a]){if(++a,a===e.length){t.splice(-a,a);break}}else a=0}while(s!==0||r);return o.text==="{"&&t[t.length-1].text==="}"&&(t.pop(),t.shift()),t.reverse(),{tokens:t,start:o,end:i}}consumeArgs(e,t){if(t){if(t.length!==e+1)throw new Q("The length of delimiters doesn't match the number of args!");const o=t[0];for(let i=0;i<o.length;i++){const s=this.popToken();if(o[i]!==s.text)throw new Q("Use of the macro doesn't match its definition",s)}}const r=[];for(let o=0;o<e;o++)r.push(this.consumeArg(t&&t[o+1]).tokens);return r}expandOnce(e){const t=this.popToken(),r=t.text,o=t.noexpand?null:this._getExpansion(r);if(o==null||e&&o.unexpandable){if(e&&o==null&&r[0]==="\\"&&!this.isDefined(r))throw new Q("Undefined control sequence: "+r);return this.pushToken(t),!1}if(this.expansionCount++,this.expansionCount>this.settings.maxExpand)throw new Q("Too many expansions: infinite loop or need to increase maxExpand setting");let i=o.tokens;const s=this.consumeArgs(o.numArgs,o.delimiters);if(o.numArgs){i=i.slice();for(let a=i.length-1;a>=0;--a){let l=i[a];if(l.text==="#"){if(a===0)throw new Q("Incomplete placeholder at end of macro body",l);if(l=i[--a],l.text==="#")i.splice(a+1,1);else if(/^[1-9]$/.test(l.text))i.splice(a,2,...s[+l.text-1]);else throw new Q("Not a valid argument number",l)}}}return this.pushTokens(i),i.length}expandAfterFuture(){return this.expandOnce(),this.future()}expandNextToken(){for(;;)if(this.expandOnce()===!1){const e=this.stack.pop();return e.treatAsRelax&&(e.text="\\relax"),e}throw new Error}expandMacro(e){return this.macros.has(e)?this.expandTokens([new Qt(e)]):void 0}expandTokens(e){const t=[],r=this.stack.length;for(this.pushTokens(e);this.stack.length>r;)if(this.expandOnce(!0)===!1){const o=this.stack.pop();o.treatAsRelax&&(o.noexpand=!1,o.treatAsRelax=!1),t.push(o)}return t}expandMacroAsText(e){const t=this.expandMacro(e);return t&&t.map(r=>r.text).join("")}_getExpansion(e){const t=this.macros.get(e);if(t==null)return t;if(e.length===1){const o=this.lexer.catcodes[e];if(o!=null&&o!==13)return}const r=typeof t=="function"?t(this):t;if(typeof r=="string"){let o=0;if(r.indexOf("#")!==-1){const d=r.replace(/##/g,"");for(;d.indexOf("#"+(o+1))!==-1;)++o}const i=new Pa(r,this.settings),s=[];let a=i.lex();for(;a.text!=="EOF";)s.push(a),a=i.lex();return s.reverse(),{tokens:s,numArgs:o}}return r}isDefined(e){return this.macros.has(e)||Object.prototype.hasOwnProperty.call(kn,e)||Object.prototype.hasOwnProperty.call(ct.math,e)||Object.prototype.hasOwnProperty.call(ct.text,e)||Object.prototype.hasOwnProperty.call(Oc,e)}isExpandable(e){const t=this.macros.get(e);return t!=null?typeof t=="string"||typeof t=="function"||!t.unexpandable:Object.prototype.hasOwnProperty.call(kn,e)&&!kn[e].primitive}}const Ba=/^[â‚Šâ‚‹â‚Œâ‚â‚â‚€â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰â‚â‚‘â‚•áµ¢â±¼â‚–â‚—â‚˜â‚™â‚’â‚šáµ£â‚›â‚œáµ¤áµ¥â‚“áµ¦áµ§áµ¨áµ©áµª]/,no=Object.freeze({"â‚Š":"+","â‚‹":"-","â‚Œ":"=","â‚":"(","â‚":")","â‚€":"0","â‚":"1","â‚‚":"2","â‚ƒ":"3","â‚„":"4","â‚…":"5","â‚†":"6","â‚‡":"7","â‚ˆ":"8","â‚‰":"9","â‚":"a","â‚‘":"e","â‚•":"h","áµ¢":"i","â±¼":"j","â‚–":"k","â‚—":"l","â‚˜":"m","â‚™":"n","â‚’":"o","â‚š":"p","áµ£":"r","â‚›":"s","â‚œ":"t","áµ¤":"u","áµ¥":"v","â‚“":"x","áµ¦":"Î²","áµ§":"Î³","áµ¨":"Ï","áµ©":"Ï•","áµª":"Ï‡","âº":"+","â»":"-","â¼":"=","â½":"(","â¾":")","â°":"0","Â¹":"1","Â²":"2","Â³":"3","â´":"4","âµ":"5","â¶":"6","â·":"7","â¸":"8","â¹":"9","á´¬":"A","á´®":"B","á´°":"D","á´±":"E","á´³":"G","á´´":"H","á´µ":"I","á´¶":"J","á´·":"K","á´¸":"L","á´¹":"M","á´º":"N","á´¼":"O","á´¾":"P","á´¿":"R","áµ€":"T","áµ":"U","â±½":"V","áµ‚":"W","áµƒ":"a","áµ‡":"b","á¶œ":"c","áµˆ":"d","áµ‰":"e","á¶ ":"f","áµ":"g",Ê°:"h","â±":"i",Ê²:"j","áµ":"k",Ë¡:"l","áµ":"m",â¿:"n","áµ’":"o","áµ–":"p",Ê³:"r",Ë¢:"s","áµ—":"t","áµ˜":"u","áµ›":"v",Ê·:"w",Ë£:"x",Ê¸:"y","á¶»":"z","áµ":"Î²","áµ":"Î³","áµŸ":"Î´","áµ ":"Ï•","áµ¡":"Ï‡","á¶¿":"Î¸"}),$a=Object.freeze({"ğ’œ":"A",â„¬:"B","ğ’":"C","ğ’Ÿ":"D",â„°:"E",â„±:"F","ğ’¢":"G",â„‹:"H",â„:"I","ğ’¥":"J","ğ’¦":"K",â„’:"L",â„³:"M","ğ’©":"N","ğ’ª":"O","ğ’«":"P","ğ’¬":"Q",â„›:"R","ğ’®":"S","ğ’¯":"T","ğ’°":"U","ğ’±":"V","ğ’²":"W","ğ’³":"X","ğ’´":"Y","ğ’µ":"Z"});var ni={"Ì":{text:"\\'",math:"\\acute"},"Ì€":{text:"\\`",math:"\\grave"},"Ìˆ":{text:'\\"',math:"\\ddot"},"Ìƒ":{text:"\\~",math:"\\tilde"},"Ì„":{text:"\\=",math:"\\bar"},"Ì†":{text:"\\u",math:"\\breve"},"ÌŒ":{text:"\\v",math:"\\check"},"Ì‚":{text:"\\^",math:"\\hat"},"Ì‡":{text:"\\.",math:"\\dot"},"ÌŠ":{text:"\\r",math:"\\mathring"},"Ì‹":{text:"\\H"},"Ì§":{text:"\\c"}},qa={Ã¡:"aÌ",Ã :"aÌ€",Ã¤:"aÌˆ",ÇŸ:"aÌˆÌ„",Ã£:"aÌƒ",Ä:"aÌ„",Äƒ:"aÌ†",áº¯:"aÌ†Ì",áº±:"aÌ†Ì€",áºµ:"aÌ†Ìƒ",Ç:"aÌŒ",Ã¢:"aÌ‚",áº¥:"aÌ‚Ì",áº§:"aÌ‚Ì€",áº«:"aÌ‚Ìƒ",È§:"aÌ‡",Ç¡:"aÌ‡Ì„",Ã¥:"aÌŠ",Ç»:"aÌŠÌ",á¸ƒ:"bÌ‡",Ä‡:"cÌ",Ä:"cÌŒ",Ä‰:"cÌ‚",Ä‹:"cÌ‡",Ä:"dÌŒ",á¸‹:"dÌ‡",Ã©:"eÌ",Ã¨:"eÌ€",Ã«:"eÌˆ",áº½:"eÌƒ",Ä“:"eÌ„",á¸—:"eÌ„Ì",á¸•:"eÌ„Ì€",Ä•:"eÌ†",Ä›:"eÌŒ",Ãª:"eÌ‚",áº¿:"eÌ‚Ì",á»:"eÌ‚Ì€",á»…:"eÌ‚Ìƒ",Ä—:"eÌ‡",á¸Ÿ:"fÌ‡",Çµ:"gÌ",á¸¡:"gÌ„",ÄŸ:"gÌ†",Ç§:"gÌŒ",Ä:"gÌ‚",Ä¡:"gÌ‡",á¸§:"hÌˆ",ÈŸ:"hÌŒ",Ä¥:"hÌ‚",á¸£:"hÌ‡",Ã­:"iÌ",Ã¬:"iÌ€",Ã¯:"iÌˆ",á¸¯:"iÌˆÌ",Ä©:"iÌƒ",Ä«:"iÌ„",Ä­:"iÌ†",Ç:"iÌŒ",Ã®:"iÌ‚",Ç°:"jÌŒ",Äµ:"jÌ‚",á¸±:"kÌ",Ç©:"kÌŒ",Äº:"lÌ",Ä¾:"lÌŒ",á¸¿:"mÌ",á¹:"mÌ‡",Å„:"nÌ",Ç¹:"nÌ€",Ã±:"nÌƒ",Åˆ:"nÌŒ",á¹…:"nÌ‡",Ã³:"oÌ",Ã²:"oÌ€",Ã¶:"oÌˆ",È«:"oÌˆÌ„",Ãµ:"oÌƒ",á¹:"oÌƒÌ",á¹:"oÌƒÌˆ",È­:"oÌƒÌ„",Å:"oÌ„",á¹“:"oÌ„Ì",á¹‘:"oÌ„Ì€",Å:"oÌ†",Ç’:"oÌŒ",Ã´:"oÌ‚",á»‘:"oÌ‚Ì",á»“:"oÌ‚Ì€",á»—:"oÌ‚Ìƒ",È¯:"oÌ‡",È±:"oÌ‡Ì„",Å‘:"oÌ‹",á¹•:"pÌ",á¹—:"pÌ‡",Å•:"rÌ",Å™:"rÌŒ",á¹™:"rÌ‡",Å›:"sÌ",á¹¥:"sÌÌ‡",Å¡:"sÌŒ",á¹§:"sÌŒÌ‡",Å:"sÌ‚",á¹¡:"sÌ‡",áº—:"tÌˆ",Å¥:"tÌŒ",á¹«:"tÌ‡",Ãº:"uÌ",Ã¹:"uÌ€",Ã¼:"uÌˆ",Ç˜:"uÌˆÌ",Çœ:"uÌˆÌ€",Ç–:"uÌˆÌ„",Çš:"uÌˆÌŒ",Å©:"uÌƒ",á¹¹:"uÌƒÌ",Å«:"uÌ„",á¹»:"uÌ„Ìˆ",Å­:"uÌ†",Ç”:"uÌŒ",Ã»:"uÌ‚",Å¯:"uÌŠ",Å±:"uÌ‹",á¹½:"vÌƒ",áºƒ:"wÌ",áº:"wÌ€",áº…:"wÌˆ",Åµ:"wÌ‚",áº‡:"wÌ‡",áº˜:"wÌŠ",áº:"xÌˆ",áº‹:"xÌ‡",Ã½:"yÌ",á»³:"yÌ€",Ã¿:"yÌˆ",á»¹:"yÌƒ",È³:"yÌ„",Å·:"yÌ‚",áº:"yÌ‡",áº™:"yÌŠ",Åº:"zÌ",Å¾:"zÌŒ",áº‘:"zÌ‚",Å¼:"zÌ‡",Ã:"AÌ",Ã€:"AÌ€",Ã„:"AÌˆ",Ç:"AÌˆÌ„",Ãƒ:"AÌƒ",Ä€:"AÌ„",Ä‚:"AÌ†",áº®:"AÌ†Ì",áº°:"AÌ†Ì€",áº´:"AÌ†Ìƒ",Ç:"AÌŒ",Ã‚:"AÌ‚",áº¤:"AÌ‚Ì",áº¦:"AÌ‚Ì€",áºª:"AÌ‚Ìƒ",È¦:"AÌ‡",Ç :"AÌ‡Ì„",Ã…:"AÌŠ",Çº:"AÌŠÌ",á¸‚:"BÌ‡",Ä†:"CÌ",ÄŒ:"CÌŒ",Äˆ:"CÌ‚",ÄŠ:"CÌ‡",Ä:"DÌŒ",á¸Š:"DÌ‡",Ã‰:"EÌ",Ãˆ:"EÌ€",Ã‹:"EÌˆ",áº¼:"EÌƒ",Ä’:"EÌ„",á¸–:"EÌ„Ì",á¸”:"EÌ„Ì€",Ä”:"EÌ†",Äš:"EÌŒ",ÃŠ:"EÌ‚",áº¾:"EÌ‚Ì",á»€:"EÌ‚Ì€",á»„:"EÌ‚Ìƒ",Ä–:"EÌ‡",á¸:"FÌ‡",Ç´:"GÌ",á¸ :"GÌ„",Ä:"GÌ†",Ç¦:"GÌŒ",Äœ:"GÌ‚",Ä :"GÌ‡",á¸¦:"HÌˆ",È:"HÌŒ",Ä¤:"HÌ‚",á¸¢:"HÌ‡",Ã:"IÌ",ÃŒ:"IÌ€",Ã:"IÌˆ",á¸®:"IÌˆÌ",Ä¨:"IÌƒ",Äª:"IÌ„",Ä¬:"IÌ†",Ç:"IÌŒ",Ã:"IÌ‚",Ä°:"IÌ‡",Ä´:"JÌ‚",á¸°:"KÌ",Ç¨:"KÌŒ",Ä¹:"LÌ",Ä½:"LÌŒ",á¸¾:"MÌ",á¹€:"MÌ‡",Åƒ:"NÌ",Ç¸:"NÌ€",Ã‘:"NÌƒ",Å‡:"NÌŒ",á¹„:"NÌ‡",Ã“:"OÌ",Ã’:"OÌ€",Ã–:"OÌˆ",Èª:"OÌˆÌ„",Ã•:"OÌƒ",á¹Œ:"OÌƒÌ",á¹:"OÌƒÌˆ",È¬:"OÌƒÌ„",ÅŒ:"OÌ„",á¹’:"OÌ„Ì",á¹:"OÌ„Ì€",Å:"OÌ†",Ç‘:"OÌŒ",Ã”:"OÌ‚",á»:"OÌ‚Ì",á»’:"OÌ‚Ì€",á»–:"OÌ‚Ìƒ",È®:"OÌ‡",È°:"OÌ‡Ì„",Å:"OÌ‹",á¹”:"PÌ",á¹–:"PÌ‡",Å”:"RÌ",Å˜:"RÌŒ",á¹˜:"RÌ‡",Åš:"SÌ",á¹¤:"SÌÌ‡",Å :"SÌŒ",á¹¦:"SÌŒÌ‡",Åœ:"SÌ‚",á¹ :"SÌ‡",Å¤:"TÌŒ",á¹ª:"TÌ‡",Ãš:"UÌ",Ã™:"UÌ€",Ãœ:"UÌˆ",Ç—:"UÌˆÌ",Ç›:"UÌˆÌ€",Ç•:"UÌˆÌ„",Ç™:"UÌˆÌŒ",Å¨:"UÌƒ",á¹¸:"UÌƒÌ",Åª:"UÌ„",á¹º:"UÌ„Ìˆ",Å¬:"UÌ†",Ç“:"UÌŒ",Ã›:"UÌ‚",Å®:"UÌŠ",Å°:"UÌ‹",á¹¼:"VÌƒ",áº‚:"WÌ",áº€:"WÌ€",áº„:"WÌˆ",Å´:"WÌ‚",áº†:"WÌ‡",áºŒ:"XÌˆ",áºŠ:"XÌ‡",Ã:"YÌ",á»²:"YÌ€",Å¸:"YÌˆ",á»¸:"YÌƒ",È²:"YÌ„",Å¶:"YÌ‚",áº:"YÌ‡",Å¹:"ZÌ",Å½:"ZÌŒ",áº:"ZÌ‚",Å»:"ZÌ‡",Î¬:"Î±Ì",á½°:"Î±Ì€",á¾±:"Î±Ì„",á¾°:"Î±Ì†",Î­:"ÎµÌ",á½²:"ÎµÌ€",Î®:"Î·Ì",á½´:"Î·Ì€",Î¯:"Î¹Ì",á½¶:"Î¹Ì€",ÏŠ:"Î¹Ìˆ",Î:"Î¹ÌˆÌ",á¿’:"Î¹ÌˆÌ€",á¿‘:"Î¹Ì„",á¿:"Î¹Ì†",ÏŒ:"Î¿Ì",á½¸:"Î¿Ì€",Ï:"Ï…Ì",á½º:"Ï…Ì€",Ï‹:"Ï…Ìˆ",Î°:"Ï…ÌˆÌ",á¿¢:"Ï…ÌˆÌ€",á¿¡:"Ï…Ì„",á¿ :"Ï…Ì†",Ï:"Ï‰Ì",á½¼:"Ï‰Ì€",Î:"Î¥Ì",á¿ª:"Î¥Ì€",Î«:"Î¥Ìˆ",á¿©:"Î¥Ì„",á¿¨:"Î¥Ì†",Î:"Î©Ì",á¿º:"Î©Ì€"};const zh=["bin","op","open","punct","rel"],Uh=/([-+]?) *(\d+(?:\.\d*)?|\.\d+) *([a-z]{2})/,Hh=/^ *\\text/;class Go{constructor(e,t,r=!1){this.mode="math",this.gullet=new qh(e,t,this.mode),this.settings=t,this.isPreamble=r,this.leftrightDepth=0,this.prevAtomType=""}expect(e,t=!0){if(this.fetch().text!==e)throw new Q(`Expected '${e}', got '${this.fetch().text}'`,this.fetch());t&&this.consume()}consume(){this.nextToken=null}fetch(){return this.nextToken==null&&(this.nextToken=this.gullet.expandNextToken()),this.nextToken}switchMode(e){this.mode=e,this.gullet.switchMode(e)}parse(){this.gullet.beginGroup(),this.settings.colorIsTextColor&&this.gullet.macros.set("\\color","\\textcolor");const e=this.parseExpression(!1);if(this.expect("EOF"),this.isPreamble){const r=Object.create(null);return Object.entries(this.gullet.macros.current).forEach(([o,i])=>{r[o]=i}),this.gullet.endGroup(),r}const t=this.gullet.macros.get("\\df@tag");return this.gullet.endGroup(),t&&(this.gullet.macros.current["\\df@tag"]=t),e}static get endOfExpression(){return["}","\\endgroup","\\end","\\right","\\endtoggle","&"]}subparse(e){const t=this.nextToken;this.consume(),this.gullet.pushToken(new Qt("}")),this.gullet.pushTokens(e);const r=this.parseExpression(!1);return this.expect("}"),this.nextToken=t,r}parseExpression(e,t,r){const o=[];for(this.prevAtomType="";;){this.mode==="math"&&this.consumeSpaces();const i=this.fetch();if(Go.endOfExpression.indexOf(i.text)!==-1||t&&i.text===t||r&&i.text==="\\middle"||e&&kn[i.text]&&kn[i.text].infix)break;const s=this.parseAtom(t);if(s){if(s.type==="internal")continue}else break;o.push(s),this.prevAtomType=s.type==="atom"?s.family:s.type}return this.mode==="text"&&this.formLigatures(o),this.handleInfixNodes(o)}handleInfixNodes(e){let t=-1,r;for(let o=0;o<e.length;o++)if(e[o].type==="infix"){if(t!==-1)throw new Q("only one infix operator per group",e[o].token);t=o,r=e[o].replaceWith}if(t!==-1&&r){let o,i;const s=e.slice(0,t),a=e.slice(t+1);s.length===1&&s[0].type==="ordgroup"?o=s[0]:o={type:"ordgroup",mode:this.mode,body:s},a.length===1&&a[0].type==="ordgroup"?i=a[0]:i={type:"ordgroup",mode:this.mode,body:a};let l;return r==="\\\\abovefrac"?l=this.callFunction(r,[o,e[t],i],[]):l=this.callFunction(r,[o,i],[]),[l]}else return e}handleSupSubscript(e){const t=this.fetch(),r=t.text;this.consume(),this.consumeSpaces();let o;do o=this.parseGroup(e);while(o.type&&o.type==="internal");if(!o)throw new Q("Expected group after '"+r+"'",t);return o}formatUnsupportedCmd(e){const t=[];for(let i=0;i<e.length;i++)t.push({type:"textord",mode:"text",text:e[i]});const r={type:"text",mode:this.mode,body:t};return{type:"color",mode:this.mode,color:this.settings.errorColor,body:[r]}}parseAtom(e){const t=this.parseGroup("atom",e);if(t&&t.type==="internal"||this.mode==="text")return t;let r,o;for(;;){this.consumeSpaces();const i=this.fetch();if(i.text==="\\limits"||i.text==="\\nolimits"){if(t&&t.type==="op"){const s=i.text==="\\limits";t.limits=s,t.alwaysHandleSupSub=!0}else if(t&&t.type==="operatorname")t.alwaysHandleSupSub&&(t.limits=i.text==="\\limits");else throw new Q("Limit controls must follow a math operator",i);this.consume()}else if(i.text==="^"){if(r)throw new Q("Double superscript",i);r=this.handleSupSubscript("superscript")}else if(i.text==="_"){if(o)throw new Q("Double subscript",i);o=this.handleSupSubscript("subscript")}else if(i.text==="'"){if(r)throw new Q("Double superscript",i);const s={type:"textord",mode:this.mode,text:"\\prime"},a=[s];for(this.consume();this.fetch().text==="'";)a.push(s),this.consume();this.fetch().text==="^"&&a.push(this.handleSupSubscript("superscript")),r={type:"ordgroup",mode:this.mode,body:a}}else if(no[i.text]){const s=Ba.test(i.text),a=[];for(a.push(new Qt(no[i.text])),this.consume();;){const d=this.fetch().text;if(!no[d]||Ba.test(d)!==s)break;a.unshift(new Qt(no[d])),this.consume()}const l=this.subparse(a);s?o={type:"ordgroup",mode:"math",body:l}:r={type:"ordgroup",mode:"math",body:l}}else break}if(r||o){if(t&&t.type==="multiscript"&&!t.postscripts)return t.postscripts={sup:r,sub:o},t;{const i=!t||t.type!=="op"&&t.type!=="operatorname"?void 0:Ho(this.nextToken.text);return{type:"supsub",mode:this.mode,base:t,sup:r,sub:o,isFollowedByDelimiter:i}}}else return t}parseFunction(e,t){const r=this.fetch(),o=r.text,i=kn[o];if(!i)return null;if(this.consume(),t&&t!=="atom"&&!i.allowedInArgument)throw new Q("Got function '"+o+"' with no arguments"+(t?" as "+t:""),r);if(this.mode==="text"&&!i.allowedInText)throw new Q("Can't use function '"+o+"' in text mode",r);if(this.mode==="math"&&i.allowedInMath===!1)throw new Q("Can't use function '"+o+"' in math mode",r);const s=this.prevAtomType,{args:a,optArgs:l}=this.parseArguments(o,i);return this.prevAtomType=s,this.callFunction(o,a,l,r,e)}callFunction(e,t,r,o,i){const s={funcName:e,parser:this,token:o,breakOnTokenText:i},a=kn[e];if(a&&a.handler)return a.handler(s,t,r);throw new Q(`No function handler for ${e}`)}parseArguments(e,t){const r=t.numArgs+t.numOptionalArgs;if(r===0)return{args:[],optArgs:[]};const o=[],i=[];for(let s=0;s<r;s++){let a=t.argTypes&&t.argTypes[s];const l=s<t.numOptionalArgs;(t.primitive&&a==null||t.type==="sqrt"&&s===1&&i[0]==null)&&(a="primitive");const d=this.parseGroupOfType(`argument to '${e}'`,a,l);if(l)i.push(d);else if(d!=null)o.push(d);else throw new Q("Null argument, please report this as a bug")}return{args:o,optArgs:i}}parseGroupOfType(e,t,r){switch(t){case"size":return this.parseSizeGroup(r);case"url":return this.parseUrlGroup(r);case"math":case"text":return this.parseArgumentGroup(r,t);case"hbox":{const o=this.parseArgumentGroup(r,"text");return o!=null?{type:"styling",mode:o.mode,body:[o],scriptLevel:"text"}:null}case"raw":{const o=this.parseStringGroup("raw",r);return o!=null?{type:"raw",mode:"text",string:o.text}:null}case"primitive":{if(r)throw new Q("A primitive argument cannot be optional");const o=this.parseGroup(e);if(o==null)throw new Q("Expected group as "+e,this.fetch());return o}case"original":case null:case void 0:return this.parseArgumentGroup(r);default:throw new Q("Unknown group type as "+e,this.fetch())}}consumeSpaces(){for(;;){const e=this.fetch().text;if(e===" "||e==="Â "||e==="ï¸")this.consume();else break}}parseStringGroup(e,t){const r=this.gullet.scanArgument(t);if(r==null)return null;let o="",i;for(;(i=this.fetch()).text!=="EOF";)o+=i.text,this.consume();return this.consume(),r.text=o,r}parseRegexGroup(e,t){const r=this.fetch();let o=r,i="",s;for(;(s=this.fetch()).text!=="EOF"&&e.test(i+s.text);)o=s,i+=o.text,this.consume();if(i==="")throw new Q("Invalid "+t+": '"+r.text+"'",r);return r.range(o,i)}parseSizeGroup(e){let t,r=!1;if(this.gullet.consumeSpaces(),!e&&this.gullet.future().text!=="{"?t=this.parseRegexGroup(/^[-+]? *(?:$|\d+|\d+\.\d*|\.\d*) *[a-z]{0,2} *$/,"size"):t=this.parseStringGroup("size",e),!t)return null;!e&&t.text.length===0&&(t.text="0pt",r=!0);const o=Uh.exec(t.text);if(!o)throw new Q("Invalid size: '"+t.text+"'",t);const i={number:+(o[1]+o[2]),unit:o[3]};if(!hc(i))throw new Q("Invalid unit: '"+i.unit+"'",t);return{type:"size",mode:this.mode,value:i,isBlank:r}}parseUrlGroup(e){this.gullet.lexer.setCatcode("%",13),this.gullet.lexer.setCatcode("~",12);const t=this.parseStringGroup("url",e);if(this.gullet.lexer.setCatcode("%",14),this.gullet.lexer.setCatcode("~",13),t==null)return null;let r=t.text.replace(/\\([#$%&~_^{}])/g,"$1");return r=t.text.replace(/{\u2044}/g,"/"),{type:"url",mode:this.mode,url:r}}parseArgumentGroup(e,t){const r=this.gullet.scanArgument(e);if(r==null)return null;const o=this.mode;t&&this.switchMode(t),this.gullet.beginGroup();const i=this.parseExpression(!1,"EOF");this.expect("EOF"),this.gullet.endGroup();const s={type:"ordgroup",mode:this.mode,loc:r.loc,body:i};return t&&this.switchMode(o),s}parseGroup(e,t){const r=this.fetch(),o=r.text;let i;if(o==="{"||o==="\\begingroup"||o==="\\toggle"){this.consume();const s=o==="{"?"}":o==="\\begingroup"?"\\endgroup":"\\endtoggle";this.gullet.beginGroup();const a=this.parseExpression(!1,s),l=this.fetch();this.expect(s),this.gullet.endGroup(),i={type:l.text==="\\endtoggle"?"toggle":"ordgroup",mode:this.mode,loc:Bt.range(r,l),body:a,semisimple:o==="\\begingroup"||void 0}}else if(i=this.parseFunction(t,e)||this.parseSymbol(),i==null&&o[0]==="\\"&&!Object.prototype.hasOwnProperty.call(Oc,o)){if(this.settings.throwOnError)throw new Q("Unsupported function name: "+o,r);i=this.formatUnsupportedCmd(o),this.consume()}return i}formLigatures(e){let t=e.length-1;for(let r=0;r<t;++r){const o=e[r],i=o.text;i==="-"&&e[r+1].text==="-"&&(r+1<t&&e[r+2].text==="-"?(e.splice(r,3,{type:"textord",mode:"text",loc:Bt.range(o,e[r+2]),text:"---"}),t-=2):(e.splice(r,2,{type:"textord",mode:"text",loc:Bt.range(o,e[r+1]),text:"--"}),t-=1)),(i==="'"||i==="`")&&e[r+1].text===i&&(e.splice(r,2,{type:"textord",mode:"text",loc:Bt.range(o,e[r+1]),text:i+i}),t-=1)}}parseSymbol(){const e=this.fetch();let t=e.text;if(/^\\verb[^a-zA-Z]/.test(t)){this.consume();let i=t.slice(5);const s=i.charAt(0)==="*";if(s&&(i=i.slice(1)),i.length<2||i.charAt(0)!==i.slice(-1))throw new Q(`\\verb assertion failed --
                    please report what input caused this bug`);return i=i.slice(1,-1),{type:"verb",mode:"text",body:i,star:s}}if(Object.prototype.hasOwnProperty.call(qa,t[0])&&this.mode==="math"&&!ct[this.mode][t[0]]){if(this.settings.strict&&this.mode==="math")throw new Q(`Accented Unicode text character "${t[0]}" used in math mode`,e);t=qa[t[0]]+t.slice(1)}const r=this.mode==="math"?Ra.exec(t):null;r&&(t=t.substring(0,r.index),t==="i"?t="Ä±":t==="j"&&(t="È·"));let o;if(ct[this.mode][t]){let i=ct[this.mode][t].group;i==="bin"&&zh.includes(this.prevAtomType)&&(i="open");const s=Bt.range(e);let a;if(Object.prototype.hasOwnProperty.call(gu,i)){const l=i;a={type:"atom",mode:this.mode,family:l,loc:s,text:t},(l==="rel"||l==="bin")&&this.prevAtomType==="text"&&Hh.test(s.lexer.input.slice(s.end))&&(a.needsSpacing=!0)}else{if($a[t]){this.consume();const l=this.fetch().text.charCodeAt(0),d=l===65025?"mathscr":"mathcal";return(l===65024||l===65025)&&this.consume(),{type:"font",mode:"math",font:d,body:{type:"mathord",mode:"math",loc:s,text:$a[t]}}}a={type:i,mode:this.mode,loc:s,text:t}}o=a}else if(t.charCodeAt(0)>=128||Ra.exec(t)){if(this.settings.strict&&this.mode==="math")throw new Q(`Unicode text character "${t[0]}" used in math mode`,e);o={type:"textord",mode:"text",loc:Bt.range(e),text:t}}else return null;if(this.consume(),r)for(let i=0;i<r[0].length;i++){const s=r[0][i];if(!ni[s])throw new Q(`Unknown accent ' ${s}'`,e);const a=ni[s][this.mode]||ni[s].text;if(!a)throw new Q(`Accent ${s} unsupported in ${this.mode} mode`,e);o={type:"accent",mode:this.mode,loc:Bt.range(e),label:a,isStretchy:!1,base:o}}return o}}const Rc=function(n,e){if(!(typeof n=="string"||n instanceof String))throw new TypeError("Temml can only parse string typed expression");const t=new Go(n,e);delete t.gullet.macros.current["\\df@tag"];let r=t.parse();if(!(r.length>0&&r[0].type&&r[0].type==="array"&&r[0].addEqnNum)&&t.gullet.macros.get("\\df@tag")){if(!e.displayMode)throw new Q("\\tag works only in display mode");t.gullet.feed("\\df@tag"),r=[{type:"tag",mode:"text",body:r,tag:t.parse()}]}return r},Gh=[2,2,3,3];class Hs{constructor(e){this.level=e.level,this.color=e.color,this.font=e.font||"",this.fontFamily=e.fontFamily||"",this.fontSize=e.fontSize||1,this.fontWeight=e.fontWeight||"",this.fontShape=e.fontShape||"",this.maxSize=e.maxSize}extend(e){const t={level:this.level,color:this.color,font:this.font,fontFamily:this.fontFamily,fontSize:this.fontSize,fontWeight:this.fontWeight,fontShape:this.fontShape,maxSize:this.maxSize};for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return new Hs(t)}withLevel(e){return this.extend({level:e})}incrementLevel(){return this.extend({level:Math.min(this.level+1,3)})}inSubOrSup(){return this.extend({level:Gh[this.level]})}withColor(e){return this.extend({color:e})}withFont(e){return this.extend({font:e})}withTextFontFamily(e){return this.extend({fontFamily:e,font:""})}withFontSize(e){return this.extend({fontSize:e})}withTextFontWeight(e){return this.extend({fontWeight:e,font:""})}withTextFontShape(e){return this.extend({fontShape:e,font:""})}getColor(){return this.color}}const jh="0.13.01";function Pc(n){const e={};let t=0;const r=document.getElementsByClassName("tml-eqn");for(let s of r)for(t+=1,s.setAttribute("id","tml-eqn-"+String(t));s.tagName!=="mtable";)if(s.getElementsByClassName("tml-label").length>0){const l=s.attributes.id.value;e[l]=String(t);break}else s=s.parentElement;const o=document.getElementsByClassName("tml-tageqn");for(const s of o)if(s.getElementsByClassName("tml-label").length>0){const l=s.getElementsByClassName("tml-tag");if(l.length>0){const d=s.attributes.id.value;e[d]=l[0].textContent}}[...n.getElementsByClassName("tml-ref")].forEach(s=>{const a=s.getAttribute("href");let l=e[a.slice(1)];s.className.indexOf("tml-eqref")===-1?(l=l.replace(/^\(/,""),l=l.replace(/\)$/,"")):(l.charAt(0)!=="("&&(l="("+l),l.slice(-1)!==")"&&(l=l+")"));const d=document.createElementNS("http://www.w3.org/1998/Math/MathML","mtext");d.appendChild(document.createTextNode(l));const u=document.createElementNS("http://www.w3.org/1998/Math/MathML","math");u.appendChild(d),s.textContent="",s.appendChild(u)})}const Wh=function(n,e,t){let r=t,o=0;const i=n.length;for(;r<e.length;){const s=e[r];if(o<=0&&e.slice(r,r+i)===n)return r;s==="\\"?r++:s==="{"?o++:s==="}"&&o--,r++}return-1},Vh=function(n){return n.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},Yh=/^\\(?:begin|(?:eq)?ref){/,Kh=function(n,e){let t;const r=[],o=new RegExp("("+e.map(i=>Vh(i.left)).join("|")+")");for(;t=n.search(o),t!==-1;){t>0&&(r.push({type:"text",data:n.slice(0,t)}),n=n.slice(t));const i=e.findIndex(l=>n.startsWith(l.left));if(t=Wh(e[i].right,n,e[i].left.length),t===-1)break;const s=n.slice(0,t+e[i].right.length),a=Yh.test(s)?s:n.slice(e[i].left.length,t);r.push({type:"math",data:a,rawData:s,display:e[i].display}),n=n.slice(t+e[i].right.length)}return n!==""&&r.push({type:"text",data:n}),r},Bc=[{left:"$$",right:"$$",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{equation*}",right:"\\end{equation*}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{align*}",right:"\\end{align*}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{alignat*}",right:"\\end{alignat*}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\begin{gather*}",right:"\\end{gather*}",display:!0},{left:"\\begin{CD}",right:"\\end{CD}",display:!0},{left:"\\ref{",right:"}",display:!1},{left:"\\eqref{",right:"}",display:!1},{left:"\\[",right:"\\]",display:!0}],ro={$:[{left:"$$",right:"$$",display:!0},{left:"$`",right:"`$",display:!1},{left:"$",right:"$",display:!1}],"(":[{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1}]},ri=[{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{equation*}",right:"\\end{equation*}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{align*}",right:"\\end{align*}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{alignat*}",right:"\\end{alignat*}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\begin{gather*}",right:"\\end{gather*}",display:!0},{left:"\\begin{CD}",right:"\\end{CD}",display:!0},{left:"\\ref{",right:"}",display:!1},{left:"\\eqref{",right:"}",display:!1}],Zh=n=>n==="$"||n==="("?ro[n]:n==="$+"||n==="(+"?ro[n.slice(0,1)].concat(ri):n==="ams"?ri:n==="all"?ro["("].concat(ro.$).concat(ri):Bc,Xh=function(n,e){const t=Kh(n,e.delimiters);if(t.length===1&&t[0].type==="text")return null;const r=document.createDocumentFragment();for(let o=0;o<t.length;o++)if(t[o].type==="text")r.appendChild(document.createTextNode(t[o].data));else{const i=document.createElement("span");let s=t[o].data;e.displayMode=t[o].display;try{e.preProcess&&(s=e.preProcess(s)),temml.render(s,i,e)}catch(a){if(!(a instanceof Q))throw a;e.errorCallback("Temml auto-render: Failed to parse `"+t[o].data+"` with ",a),r.appendChild(document.createTextNode(t[o].rawData));continue}r.appendChild(i)}return r},$c=function(n,e){for(let t=0;t<n.childNodes.length;t++){const r=n.childNodes[t];if(r.nodeType===3){const o=Xh(r.textContent,e);o&&(t+=o.childNodes.length-1,n.replaceChild(o,r))}else if(r.nodeType===1){const o=" "+r.className+" ";e.ignoredTags.indexOf(r.nodeName.toLowerCase())===-1&&e.ignoredClasses.every(s=>o.indexOf(" "+s+" ")===-1)&&$c(r,e)}}},Jh=function(n,e){if(!n)throw new Error("No element provided to render");const t={};for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);t.fences?t.delimiters=Zh(t.fences):t.delimiters=t.delimiters||Bc,t.ignoredTags=t.ignoredTags||["script","noscript","style","textarea","pre","code","option"],t.ignoredClasses=t.ignoredClasses||[],t.errorCallback=t.errorCallback||console.error,t.macros=t.macros||{},$c(n,t),Pc(n)};let qc=function(n,e,t={}){e.textContent="";const r=e.tagName.toLowerCase()==="math";r&&(t.wrap="none");const o=Gs(n,t);r?(e.textContent="",o.children.forEach(i=>{e.appendChild(i.toNode())})):o.children.length>1?(e.textContent="",o.children.forEach(i=>{e.appendChild(i.toNode())})):e.appendChild(o.toNode())};typeof document<"u"&&document.compatMode!=="CSS1Compat"&&(typeof console<"u"&&console.warn("Warning: Temml doesn't work in quirks mode. Make sure your website has a suitable doctype."),qc=function(){throw new Q("Temml doesn't work in quirks mode.")});const Qh=function(n,e){return Gs(n,e).toMarkup()},em=function(n,e){const t=new Ms(e);return Rc(n,t)},tm=function(n,e){const t=new Ms(e);if(t.macros={},!(typeof n=="string"||n instanceof String))throw new TypeError("Temml can only parse string typed expression");const r=new Go(n,t,!0);return delete r.gullet.macros.current["\\df@tag"],r.parse()},nm=function(n,e,t){if(t.throwOnError||!(n instanceof Q))throw n;const r=new lc(["temml-error"],[new hu(e+`

`+n.toString())]);return r.style.color=t.errorColor,r.style.whiteSpace="pre-line",r},Gs=function(n,e){const t=new Ms(e);try{const r=Rc(n,t),o=new Hs({level:t.displayMode?lt.DISPLAY:lt.TEXT,maxSize:t.maxSize});return Tu(r,n,o,t)}catch(r){return nm(r,n,t)}};var rm={version:jh,render:qc,renderToString:Qh,renderMathInElement:Jh,postProcess:Pc,ParseError:Q,definePreamble:tm,__parse:em,__renderToMathMLTree:Gs,__defineSymbol:c,__defineMacro:E},ut=(n=>(n.STORAGE_READ_FAILED="STORAGE_READ_FAILED",n.STORAGE_WRITE_FAILED="STORAGE_WRITE_FAILED",n.STORAGE_PARSE_FAILED="STORAGE_PARSE_FAILED",n.ELEMENT_NOT_FOUND="ELEMENT_NOT_FOUND",n.ELEMENT_QUERY_FAILED="ELEMENT_QUERY_FAILED",n.TIMELINE_INIT_FAILED="TIMELINE_INIT_FAILED",n.TIMELINE_RENDER_FAILED="TIMELINE_RENDER_FAILED",n.FOLDER_CREATE_FAILED="FOLDER_CREATE_FAILED",n.FOLDER_UPDATE_FAILED="FOLDER_UPDATE_FAILED",n.FOLDER_DELETE_FAILED="FOLDER_DELETE_FAILED",n.CONVERSATION_ADD_FAILED="CONVERSATION_ADD_FAILED",n.CONVERSATION_REMOVE_FAILED="CONVERSATION_REMOVE_FAILED",n.CONVERSATION_NAVIGATE_FAILED="CONVERSATION_NAVIGATE_FAILED",n.UNKNOWN_ERROR="UNKNOWN_ERROR",n.VALIDATION_ERROR="VALIDATION_ERROR",n))(ut||{});class An extends Error{constructor(e,t,r,o){super(t),this.code=e,this.context=r,this.originalError=o,this.name="AppError",Error.captureStackTrace&&Error.captureStackTrace(this,An)}toJSON(){return{name:this.name,code:this.code,message:this.message,context:this.context,stack:this.stack,originalError:this.originalError?.message}}}class Mt extends An{constructor(e,t,r,o){super(e,t,r,o),this.name="StorageError"}}var zc=(n=>(n[n.DEBUG=0]="DEBUG",n[n.INFO=1]="INFO",n[n.WARN=2]="WARN",n[n.ERROR=3]="ERROR",n[n.NONE=4]="NONE",n))(zc||{});class xn{static instance;config;constructor(e={}){this.config={level:e.level??2,prefix:e.prefix??"[GeminiVoyager]",enableTimestamp:e.enableTimestamp??!0,enableContext:e.enableContext??!0}}static getInstance(e){return xn.instance||(xn.instance=new xn(e)),xn.instance}createChild(e){return new xn({...this.config,prefix:`${this.config.prefix}:${e}`})}debug(e,t){this.log(0,e,t)}info(e,t){this.log(1,e,t)}warn(e,t){this.log(2,e,t)}error(e,t){this.log(3,e,t)}log(e,t,r){if(e<this.config.level)return;const o=this.config.enableTimestamp?new Date().toISOString():"",i=this.config.prefix,s=zc[e],l=[o,i,`[${s}]`,t].filter(Boolean).join(" "),d=this.getLogFunction(e);this.config.enableContext&&r?d(l,r):d(l)}getLogFunction(e){switch(e){case 0:return console.debug.bind(console);case 1:return console.info.bind(console);case 2:return console.warn.bind(console);case 3:return console.error.bind(console);default:return console.log.bind(console)}}setLevel(e){this.config.level=e}getLevel(){return this.config.level}}const hn=xn.getInstance();class Uc{get logger(){return hn.createChild(this.loggerName)}isContextInvalidated(e){return Ct(e)||!Ls()}async get(e){try{this.logger.debug(`Reading key: ${e}`);const r=(await new Promise((o,i)=>{this.storageArea.get([e],s=>{if(chrome.runtime.lastError){i(new Error(chrome.runtime.lastError.message));return}o(s)})}))[e];return r===void 0?(this.logger.debug(`Key not found: ${e}`),{success:!1,error:new Mt(ut.STORAGE_READ_FAILED,`Key not found: ${e}`,{key:e})}):(this.logger.debug(`Successfully read key: ${e}`),{success:!0,data:r})}catch(t){return this.isContextInvalidated(t)?(this.logger.debug(`Extension context invalidated while reading key: ${e}`),{success:!1,error:new Mt(ut.STORAGE_READ_FAILED,`Extension context invalidated while reading key: ${e}`,{key:e},t instanceof Error?t:void 0)}):(this.logger.error(`Failed to read key: ${e}`,{error:t}),{success:!1,error:new Mt(ut.STORAGE_READ_FAILED,`Failed to read key: ${e}`,{key:e},t instanceof Error?t:void 0)})}}async set(e,t){try{return this.logger.debug(`Writing key: ${e}`),await new Promise((r,o)=>{this.storageArea.set({[e]:t},()=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):r()})}),this.logger.debug(`Successfully wrote key: ${e}`),{success:!0,data:void 0}}catch(r){return this.isContextInvalidated(r)?(this.logger.debug(`Extension context invalidated while writing key: ${e}`),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,`Extension context invalidated while writing key: ${e}`,{key:e,value:t},r instanceof Error?r:void 0)}):(this.logger.error(`Failed to write key: ${e}`,{error:r}),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,`Failed to write key: ${e}`,{key:e,value:t},r instanceof Error?r:void 0)})}}async remove(e){try{return this.logger.debug(`Removing key: ${e}`),await new Promise((t,r)=>{this.storageArea.remove(e,()=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t()})}),this.logger.debug(`Successfully removed key: ${e}`),{success:!0,data:void 0}}catch(t){return this.isContextInvalidated(t)?(this.logger.debug(`Extension context invalidated while removing key: ${e}`),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,`Extension context invalidated while removing key: ${e}`,{key:e},t instanceof Error?t:void 0)}):(this.logger.error(`Failed to remove key: ${e}`,{error:t}),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,`Failed to remove key: ${e}`,{key:e},t instanceof Error?t:void 0)})}}async clear(){try{return this.logger.debug("Clearing all storage"),await new Promise((e,t)=>{this.storageArea.clear(()=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e()})}),this.logger.debug("Successfully cleared storage"),{success:!0,data:void 0}}catch(e){return this.isContextInvalidated(e)?(this.logger.debug("Extension context invalidated while clearing storage"),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,"Extension context invalidated while clearing storage",{},e instanceof Error?e:void 0)}):(this.logger.error("Failed to clear storage",{error:e}),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,"Failed to clear storage",{},e instanceof Error?e:void 0)})}}}class om extends Uc{storageArea=chrome.storage.sync;loggerName="ChromeStorage"}class im extends Uc{storageArea=chrome.storage.local;loggerName="ChromeLocalStorage"}class sm{logger=hn.createChild("LocalStorage");async get(e){try{this.logger.debug(`Reading key: ${e}`);const t=localStorage.getItem(e);if(t===null)return this.logger.debug(`Key not found: ${e}`),{success:!1,error:new Mt(ut.STORAGE_READ_FAILED,`Key not found: ${e}`,{key:e})};const r=JSON.parse(t);return this.logger.debug(`Successfully read key: ${e}`),{success:!0,data:r}}catch(t){return this.logger.error(`Failed to read/parse key: ${e}`,{error:t}),{success:!1,error:new Mt(ut.STORAGE_PARSE_FAILED,`Failed to read/parse key: ${e}`,{key:e},t instanceof Error?t:void 0)}}}async set(e,t){try{this.logger.debug(`Writing key: ${e}`);const r=JSON.stringify(t);return localStorage.setItem(e,r),this.logger.debug(`Successfully wrote key: ${e}`),{success:!0,data:void 0}}catch(r){return this.logger.error(`Failed to write key: ${e}`,{error:r}),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,`Failed to write key: ${e}`,{key:e,value:t},r instanceof Error?r:void 0)}}}async remove(e){try{return this.logger.debug(`Removing key: ${e}`),localStorage.removeItem(e),this.logger.debug(`Successfully removed key: ${e}`),{success:!0,data:void 0}}catch(t){return this.logger.error(`Failed to remove key: ${e}`,{error:t}),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,`Failed to remove key: ${e}`,{key:e},t instanceof Error?t:void 0)}}}async clear(){try{return this.logger.debug("Clearing all storage"),localStorage.clear(),this.logger.debug("Successfully cleared storage"),{success:!0,data:void 0}}catch(e){return this.logger.error("Failed to clear storage",{error:e}),{success:!1,error:new Mt(ut.STORAGE_WRITE_FAILED,"Failed to clear storage",{},e instanceof Error?e:void 0)}}}}class Hc{static create(e="sync"){if(typeof chrome<"u"&&chrome.storage){if(e==="local"&&chrome.storage.local)return hn.info("Using ChromeLocalStorageService"),new im;if(chrome.storage.sync)return hn.info("Using ChromeStorageService"),new om}return hn.info("Using LocalStorageService (fallback)"),new sm}}const Pn=Hc.create("sync"),js=Hc.create("local");class am{locks=new Map;lockHolders=new Map;async acquire(e,t=3e4){for(;this.locks.has(e);){const i=this.locks.get(e),s=new Promise((a,l)=>{setTimeout(()=>l(new Error(`Lock timeout for key: ${e}`)),t)});try{await Promise.race([i,s])}catch(a){throw this.forceRelease(e),a}}let r;const o=new Promise(i=>{r=i});return this.locks.set(e,o),this.lockHolders.set(e,Date.now()),()=>{this.release(e),r()}}tryAcquire(e){if(this.locks.has(e))return null;let t;const r=new Promise(o=>{t=o});return this.locks.set(e,r),this.lockHolders.set(e,Date.now()),()=>{this.release(e),t()}}release(e){this.locks.delete(e),this.lockHolders.delete(e)}forceRelease(e){this.release(e)}isLocked(e){return this.locks.has(e)}getLockDuration(e){const t=this.lockHolders.get(e);return t?Date.now()-t:null}async withLock(e,t,r){const o=await this.acquire(e,r);try{return await t()}finally{o()}}clearAll(){this.locks.clear(),this.lockHolders.clear()}}const lm=new am,cm={FOLDER_IMPORT:"folder:import"};class zt{static instance=null;static MATHML_NS="http://www.w3.org/1998/Math/MathML";logger;config;currentFormat="latex";handleStorageChange=(e,t)=>{if(t==="sync"&&e[ke.FORMULA_COPY_FORMAT]){const r=e[ke.FORMULA_COPY_FORMAT].newValue;(r==="latex"||r==="unicodemath"||r==="no-dollar")&&(this.currentFormat=r,this.logger.debug("Formula format changed",{format:r}))}};isInitialized=!1;copyToast=null;i18nMessages={};constructor(e={}){this.logger=hn.createChild("FormulaCopy"),this.config={toastDuration:e.toastDuration??2e3,toastOffsetY:e.toastOffsetY??40,maxTraversalDepth:e.maxTraversalDepth??10},this.currentFormat=e.format??"latex",this.loadI18nMessages(),this.loadFormatPreference()}static getInstance(e){return zt.instance||(zt.instance=new zt(e)),zt.instance}loadI18nMessages(){try{this.i18nMessages={copied:Ce.i18n.getMessage("formula_copied")||"âœ“ Formula copied",failed:Ce.i18n.getMessage("formula_copy_failed")||"âœ— Failed to copy"}}catch(e){this.logger.warn("Failed to load i18n messages, using defaults",{error:e}),this.i18nMessages={copied:"âœ“ Formula copied",failed:"âœ— Failed to copy"}}}async loadFormatPreference(){try{const t=(await Ce.storage.sync.get(ke.FORMULA_COPY_FORMAT))[ke.FORMULA_COPY_FORMAT];(t==="latex"||t==="unicodemath"||t==="no-dollar")&&(this.currentFormat=t,this.logger.debug("Loaded formula format preference",{format:t}))}catch(e){this.logger.warn("Failed to load format preference, using default",{error:e})}Ce.storage.onChanged.addListener(this.handleStorageChange)}initialize(){if(this.isInitialized){this.logger.warn("Service already initialized");return}document.addEventListener("click",this.handleClick,!0),this.isInitialized=!0,this.logger.info("Formula copy service initialized")}destroy(){try{Ce.storage.onChanged.removeListener(this.handleStorageChange)}catch(e){this.logger.warn("Failed to remove storage change listener",{error:e})}if(!this.isInitialized){this.logger.warn("Service not initialized, cannot destroy");return}document.removeEventListener("click",this.handleClick,!0),this.removeCopyToast(),this.isInitialized=!1,this.logger.info("Formula copy service destroyed")}handleClick=e=>{const t=e.target,r=this.findMathElement(t);if(!r)return;const o=this.extractLatexSource(r);if(!o){this.logger.warn("Math element found but no LaTeX source available");return}const i=this.isDisplayMode(r),{text:s,html:a}=this.wrapFormula(o,i);this.copyFormula(s,a,e.clientX,e.clientY),e.stopPropagation()};extractLatexSource(e){const t=e.getAttribute("data-math");if(t)return t;const r=e.querySelector('annotation[encoding="application/x-tex"]');if(r?.textContent)return r.textContent.trim();const o=e.querySelector("annotation");return o?.textContent?o.textContent.trim():null}async copyFormula(e,t,r,o){try{await this.copyToClipboard(e,t)?(this.showToast(this.i18nMessages.copied,r,o,!0),this.logger.debug("Formula copied successfully",{length:e.length,hasHtml:!!t})):(this.showToast(this.i18nMessages.failed,r,o,!1),this.logger.error("Failed to copy formula"))}catch(i){this.showToast(this.i18nMessages.failed,r,o,!1),this.logger.error("Error copying formula",{error:i})}}async copyToClipboard(e,t){if(navigator.clipboard?.write){const r={"text/plain":new Blob([e],{type:"text/plain"})};t&&(r["text/html"]=new Blob([t],{type:"text/html"}),t.includes(`xmlns:mml="${zt.MATHML_NS}"`)&&(r["application/mathml+xml"]=new Blob([e],{type:"application/mathml+xml"})));try{return await navigator.clipboard.write([new ClipboardItem(r)]),!0}catch(o){return this.isMathMLClipboardUnsupported(o)?this.copyToClipboardLegacy(e):(this.logger.error("Clipboard API failed, trying fallback",{error:o}),this.copyToClipboardLegacy(e))}}if(navigator.clipboard?.writeText&&!t)try{return await navigator.clipboard.writeText(e),!0}catch(r){return this.logger.error("Clipboard API failed, trying fallback",{error:r}),this.copyToClipboardLegacy(e)}return this.copyToClipboardLegacy(e)}copyToClipboardLegacy(e){try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",t.style.pointerEvents="none",document.body.appendChild(t),t.select();const r=document.execCommand("copy");return document.body.removeChild(t),r}catch(t){return this.logger.error("Legacy clipboard copy failed",{error:t}),!1}}isMathMLClipboardUnsupported(e){const t=this.getErrorName(e);if(!(t==="notallowederror"||t==="notsupportederror"))return!1;const o=this.getErrorMessage(e);if(!o)return!0;const i=o.toLowerCase();return i.includes("mathml")||i.includes("application/mathml+xml")}getErrorMessage(e){return e instanceof Error?e.message:typeof e=="string"?e:null}getErrorName(e){return e instanceof DOMException||e instanceof Error?e.name.toLowerCase():null}findMathElement(e){const t=e.closest("[data-math]");if(t instanceof HTMLElement)return t;const r=e.closest(".math-inline, .math-block");if(r instanceof HTMLElement)return this.findDataMathInSubtree(r);const o=e.closest("ms-katex");if(o instanceof HTMLElement)return o;const i=e.closest(".katex");if(i instanceof HTMLElement){const s=i.closest("ms-katex");if(s instanceof HTMLElement)return s}return null}isMathContainer(e){return e.classList.contains("math-inline")||e.classList.contains("math-block")}isDisplayMode(e){if(e.closest(".math-block")!==null||e.querySelector('math[display="block"]'))return!0;if(e.tagName.toLowerCase()==="ms-katex"){const r=window.getComputedStyle(e);if(r.display==="block"||r.display==="flex")return!0}return!1}wrapFormula(e,t){if(this.currentFormat==="unicodemath")try{const o=this.stripMathDelimiters(e),i=rm.renderToString(o,{displayMode:t,xml:!0,annotate:!1,throwOnError:!0,colorIsTextColor:!0,trust:!1}),s=this.stripMathMLAnnotations(i),a=this.ensureMathMLNamespace(s),l=this.toWordMathML(a),d=this.wrapMathMLForWordHtml(l);return{text:l,html:d}}catch(o){return this.logger.error("MathML conversion failed",{error:o}),{text:e}}return this.currentFormat==="no-dollar"?{text:e}:{text:t?`$$${e}$$`:`$${e}$`}}ensureMathMLNamespace(e){return e.includes("xmlns=")?e:e.replace("<math",`<math xmlns="${zt.MATHML_NS}"`)}toWordMathML(e){const t=new DOMParser().parseFromString(e,"application/xml");if(t.getElementsByTagName("parsererror").length>0)return this.stripMathMLAnnotations(e);const r=t.documentElement;if(r.localName!=="math")return this.stripMathMLAnnotations(e);for(const a of Array.from(r.getElementsByTagName("annotation")))a.parentNode?.removeChild(a);for(const a of Array.from(r.getElementsByTagName("annotation-xml")))a.parentNode?.removeChild(a);const o=Array.from(r.getElementsByTagName("semantics")).find(a=>a.parentElement===r);if(o){const a=o.firstElementChild;if(a){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(a)}}this.stripPresentationAttributes(r);const i=document.implementation.createDocument(zt.MATHML_NS,"mml:math",null),s=i.documentElement;for(const a of Array.from(r.attributes))a.name.startsWith("xmlns")||s.setAttribute(a.name,a.value);for(const a of Array.from(r.childNodes))s.appendChild(this.cloneNodeWithMathMLPrefix(i,a));return new XMLSerializer().serializeToString(s)}cloneNodeWithMathMLPrefix(e,t){if(t.nodeType===Node.TEXT_NODE)return e.createTextNode(t.nodeValue??"");if(t.nodeType!==Node.ELEMENT_NODE)return e.importNode(t,!0);const r=t,o=r.namespaceURI,i=r.localName,s=o===zt.MATHML_NS||o===null,a=s?`mml:${i}`:r.tagName,l=s?e.createElementNS(zt.MATHML_NS,a):e.createElement(a);for(const d of Array.from(r.attributes))d.name.startsWith("xmlns")||l.setAttribute(d.name,d.value);for(const d of Array.from(r.childNodes))l.appendChild(this.cloneNodeWithMathMLPrefix(e,d));return l}wrapMathMLForWordHtml(e){return[`<html xmlns:mml="${zt.MATHML_NS}">`,'<head><meta charset="utf-8"></head>',"<body><!--StartFragment-->",e,"<!--EndFragment--></body></html>"].join("")}stripMathMLAnnotations(e){return e.replace(/<annotation(?:-xml)?[\s\S]*?<\/annotation(?:-xml)?>/g,"").replace(/<semantics>\s*([\s\S]*?)\s*<\/semantics>/g,"$1")}stripPresentationAttributes(e){e.hasAttribute("class")&&e.removeAttribute("class"),e.hasAttribute("style")&&e.removeAttribute("style");for(const t of Array.from(e.getElementsByTagName("*")))t.hasAttribute("class")&&t.removeAttribute("class"),t.hasAttribute("style")&&t.removeAttribute("style")}stripMathDelimiters(e){const t=e.trim();return t.startsWith("$$")&&t.endsWith("$$")||t.startsWith("\\[")&&t.endsWith("\\]")||t.startsWith("\\(")&&t.endsWith("\\)")?t.slice(2,-2):t.startsWith("$")&&t.endsWith("$")?t.slice(1,-1):e}findDataMathInSubtree(e){const t=e.querySelector("[data-math]");return t instanceof HTMLElement?t:null}showToast(e,t,r,o){this.copyToast||(this.copyToast=this.createCopyToast()),this.copyToast.textContent=e,this.copyToast.style.left=`${t}px`,this.copyToast.style.top=`${r-this.config.toastOffsetY}px`,o?(this.copyToast.classList.remove("gv-copy-toast-error"),this.copyToast.classList.add("gv-copy-toast-success")):(this.copyToast.classList.remove("gv-copy-toast-success"),this.copyToast.classList.add("gv-copy-toast-error")),this.copyToast.classList.add("gv-copy-toast-show"),setTimeout(()=>{this.copyToast?.classList.remove("gv-copy-toast-show")},this.config.toastDuration)}createCopyToast(){const e=document.createElement("div");return e.className="gv-copy-toast",document.body.appendChild(e),e}removeCopyToast(){this.copyToast?.parentElement&&(this.copyToast.parentElement.removeChild(this.copyToast),this.copyToast=null)}isServiceInitialized(){return this.isInitialized}}const dm=n=>zt.getInstance(n);function za(){dm().initialize()}const Yi="gemini-voyager-chat-width",Cr=70,Ua=30,oi=100,um=1200;function hm(){return[".user-query-bubble-container",".user-query-container","user-query-content","user-query",'div[aria-label="User message"]','article[data-author="user"]','[data-message-author-role="user"]']}function mm(){return["model-response",".model-response","response-container",".response-container",".presented-response-container",'[aria-label="Gemini response"]','[data-message-author-role="assistant"]','[data-message-author-role="model"]','article[data-author="assistant"]']}const Ha=(n,e,t)=>Math.min(t,Math.max(e,Math.round(n))),Ki=(n,e)=>{if(!Number.isFinite(n))return e;if(n>oi){const t=n/um*100;return Ha(t,Ua,oi)}return Ha(n,Ua,oi)};function ii(n){const t=`${Ki(n,Cr)}vw`;let r=document.getElementById(Yi);r||(r=document.createElement("style"),r.id=Yi,document.head.appendChild(r));const o=hm(),i=mm(),s=o.map(d=>`${d}`).join(`,
    `),a=i.map(d=>`${d}`).join(`,
    `),l=10;r.textContent=`
    /* Remove width constraints from outer containers that contain conversations */
    .content-wrapper:has(chat-window),
    .main-content:has(chat-window),
    .content-container:has(chat-window),
    .content-container:has(.conversation-container) {
      max-width: none !important;
    }

    /* Remove width constraints from main and conversation containers, but not buttons */
    [role="main"]:has(chat-window),
    [role="main"]:has(.conversation-container) {
      max-width: none !important;
    }

    /* Target chat window and related containers; A small gap to account for scrollbars */
    chat-window,
    .chat-container,
    chat-window-content,
    .chat-history-scroll-container,
    .chat-history,
    .conversation-container {
      max-width: none !important;
      padding-right: ${l}px !important;
      box-sizing: border-box !important;
    }

    main > div:has(user-query),
    main > div:has(model-response),
    main > div:has(.conversation-container) {
      max-width: none !important;
      width: 100% !important;
    }

    /* Fallback for browsers without :has() support */
    @supports not selector(:has(*)) {
      .content-wrapper,
      .main-content,
      .content-container {
        max-width: none !important;
      }

      main > div:not(:has(button)):not(.main-menu-button) {
        max-width: none !important;
        width: 100% !important;
      }
    }

    /* User query containers */
    ${s} {
      max-width: ${t} !important;
      width: min(100%, ${t}) !important;
      margin-left: auto !important;
      margin-right: auto !important;
    }

    /* Model response containers */
    ${a} {
      max-width: ${t} !important;
      width: min(100%, ${t}) !important;
      margin-left: auto !important;
      margin-right: auto !important;
    }
    model-response:has(> .deferred-response-indicator),
    .response-container:has(img[src*="sparkle"]), 
    main > div:has(img[src*="sparkle"]) {
      max-width: ${t} !important;
      width: min(100%, ${t}) !important;
      margin-left: auto !important;
      margin-right: auto !important;
    }

    /* Additional deep targeting for nested elements */
    user-query,
    user-query > *,
    user-query > * > *,
    model-response,
    model-response > *,
    model-response > * > *,
    response-container,
    response-container > *,
    response-container > * > * {
      max-width: ${t} !important;
    }

    /* Target specific internal containers that might have fixed widths */
    .presented-response-container,
    [data-message-author-role] {
      max-width: ${t} !important;
    }

    /* Specific fix for user bubble background to fit content but respect max-width */
    .user-query-bubble-with-background {
      max-width: ${t} !important;
      width: fit-content !important;
    }
  `}function pm(){const n=document.getElementById(Yi);n&&n.remove()}function fm(){let n=Cr;chrome.storage?.sync?.get({geminiChatWidth:Cr},i=>{const s=i?.geminiChatWidth,a=Ki(s,Cr);if(n=a,ii(n),typeof s=="number"&&s!==a)try{chrome.storage?.sync?.set({geminiChatWidth:a})}catch(l){console.warn("[Gemini Voyager] Failed to migrate chat width to %:",l)}});const e=(i,s)=>{if(s==="sync"&&i.geminiChatWidth){const a=i.geminiChatWidth.newValue;if(typeof a=="number"){const l=Ki(a,Cr);if(n=l,ii(n),l!==a)try{chrome.storage?.sync?.set({geminiChatWidth:l})}catch(d){console.warn("[Gemini Voyager] Failed to migrate chat width to % on change:",d)}}}};chrome.storage?.onChanged?.addListener(e);let t=null;const r=new MutationObserver(()=>{t!==null&&clearTimeout(t),t=window.setTimeout(()=>{ii(n),t=null},200)}),o=document.querySelector("main");o&&r.observe(o,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{r.disconnect(),pm();try{chrome.storage?.onChanged?.removeListener(e)}catch(i){console.error("[Gemini Voyager] Failed to remove storage listener on unload:",i)}},{once:!0})}class Ws{static instance;DEFAULT_PORT=3030;constructor(){}static getInstance(){return this.instance||(this.instance=new Ws),this.instance}async getServerUrl(){return new Promise(e=>{chrome.storage.sync.get(["contextSyncPort"],t=>{const r=t.contextSyncPort||this.DEFAULT_PORT;e(`http://127.0.0.1:${r}/sync`)})})}async checkServerStatus(){let e;try{const t=await this.getServerUrl(),r=new AbortController;return e=setTimeout(()=>r.abort(),200),await fetch(t,{method:"GET",signal:r.signal}),!0}catch{return!1}finally{e&&clearTimeout(e)}}async syncToIDE(e){console.log("ğŸ“¡ Syncing to Code Editor server...",e);try{const t=await this.getServerUrl(),r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify(e)});if(!r.ok)throw new Error("Code Editor Server not responding.");return await r.json()}catch(t){throw new Error(t.message)}}}const si={"gemini.google.com":{user_selector:[".query-content"],ai_selector:[".response-content"]},default:{selectors:["div","p"],aiMarkers:["ai","assistant"],userMarkers:["user","human"]}};function gm(n){for(const e of Object.keys(si))if(n.includes(e))return si[e];return si.default}class Vs{static instance;constructor(){}static getInstance(){return this.instance||(this.instance=new Vs),this.instance}captureDialogue(){const e=window.location.hostname,t=gm(e),r=[];let o=[],i=[];t.user_selector&&t.ai_selector?(o=t.user_selector?Array.from(document.querySelectorAll(t.user_selector.join(","))):[],i=t.ai_selector?Array.from(document.querySelectorAll(t.ai_selector.join(","))):[]):t.selectors,console.log(`[ContextSync] Found ${o.length} queries and ${i.length} responses.`);const s=Math.max(o.length,i.length);for(let a=0;a<s;a++){if(a<o.length){const l=this.extractNodeInfo(o[a],"user");l&&r.push(l)}if(a<i.length){const l=this.extractNodeInfo(i[a],"assistant");l&&r.push(l)}}return r}convertTableToMarkdown(e){try{const t=Array.from(e.rows);if(t.length===0)return"";const r=t.map(a=>Array.from(a.cells).map(d=>d.innerText.trim().replace(/\|/g,"\\|").replace(/\n/g,"___BR___"))),o=r.reduce((a,l)=>Math.max(a,l.length),0);if(o===0)return"";let i=`

`;const s=r[0];for(;s.length<o;)s.push("");i+="| "+s.join(" | ")+` |
`,i+="| "+Array(o).fill("---").join(" | ")+` |
`;for(let a=1;a<r.length;a++){const l=r[a];for(;l.length<o;)l.push("");i+="| "+l.join(" | ")+` |
`}return i+`
`}catch(t){return console.error("Table conversion failed",t),e.innerText}}extractNodeInfo(e,t=null){if(e.offsetParent===null||["SCRIPT","STYLE","NAV","HEADER","FOOTER","SVG","PATH"].includes(e.tagName))return null;const r=e.cloneNode(!0);Array.from(r.querySelectorAll("table")).reverse().forEach(s=>{const a=this.convertTableToMarkdown(s);s.replaceWith(document.createTextNode(a))});let i=r.innerText.trim();return i.length<1?null:(i=i.replace(/</g,"&lt;").replace(/>/g,"&gt;"),i=i.replace(/___BR___/g,"<br>"),{url:window.location.hostname,className:e.className,text:i,is_ai_likely:t==="assistant",is_user_likely:t==="user",rect:{top:e.getBoundingClientRect().top,left:e.getBoundingClientRect().left,width:e.getBoundingClientRect().width}})}}function bm(){console.log("ğŸš€ AI Context Sync Feature Initialized"),chrome.runtime.onMessage.addListener((n,e,t)=>{if(n.action==="sync_to_ide")return vm(t),!0})}async function vm(n){try{const e=Vs.getInstance(),t=Ws.getInstance(),r=e.captureDialogue(),o=await t.syncToIDE(r);n({status:"success",data:o})}catch(e){console.error("Sync failed",e),n({status:"error",message:e.message})}}const ym="modulepreload",wm=function(n){return"/"+n},Ga={},Qe=function(e,t,r){let o=Promise.resolve();if(t&&t.length>0){let l=function(d){return Promise.all(d.map(u=>Promise.resolve(u).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),a=s?.nonce||s?.getAttribute("nonce");o=l(t.map(d=>{if(d=wm(d),d in Ga)return;Ga[d]=!0;const u=d.endsWith(".css"),m=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${m}`))return;const p=document.createElement("link");if(p.rel=u?"stylesheet":ym,u||(p.as="script"),p.crossOrigin="",p.href=d,a&&p.setAttribute("nonce",a),document.head.appendChild(p),u)return new Promise((f,g)=>{p.addEventListener("load",f),p.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(s){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=s,window.dispatchEvent(a),!a.defaultPrevented)throw s}return o.then(s=>{for(const a of s||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})};function oo(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ai={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/var ja;function xm(){return ja||(ja=1,(function(n,e){(function(t){n.exports=t()})(function(){return(function t(r,o,i){function s(d,u){if(!o[d]){if(!r[d]){var m=typeof oo=="function"&&oo;if(!u&&m)return m(d,!0);if(a)return a(d,!0);var p=new Error("Cannot find module '"+d+"'");throw p.code="MODULE_NOT_FOUND",p}var f=o[d]={exports:{}};r[d][0].call(f.exports,function(g){var b=r[d][1][g];return s(b||g)},f,f.exports,t,r,o,i)}return o[d].exports}for(var a=typeof oo=="function"&&oo,l=0;l<i.length;l++)s(i[l]);return s})({1:[function(t,r,o){var i=t("./utils"),s=t("./support"),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";o.encode=function(l){for(var d,u,m,p,f,g,b,w=[],v=0,S=l.length,C=S,L=i.getTypeOf(l)!=="string";v<l.length;)C=S-v,m=L?(d=l[v++],u=v<S?l[v++]:0,v<S?l[v++]:0):(d=l.charCodeAt(v++),u=v<S?l.charCodeAt(v++):0,v<S?l.charCodeAt(v++):0),p=d>>2,f=(3&d)<<4|u>>4,g=1<C?(15&u)<<2|m>>6:64,b=2<C?63&m:64,w.push(a.charAt(p)+a.charAt(f)+a.charAt(g)+a.charAt(b));return w.join("")},o.decode=function(l){var d,u,m,p,f,g,b=0,w=0,v="data:";if(l.substr(0,v.length)===v)throw new Error("Invalid base64 input, it looks like a data url.");var S,C=3*(l=l.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(l.charAt(l.length-1)===a.charAt(64)&&C--,l.charAt(l.length-2)===a.charAt(64)&&C--,C%1!=0)throw new Error("Invalid base64 input, bad content length.");for(S=s.uint8array?new Uint8Array(0|C):new Array(0|C);b<l.length;)d=a.indexOf(l.charAt(b++))<<2|(p=a.indexOf(l.charAt(b++)))>>4,u=(15&p)<<4|(f=a.indexOf(l.charAt(b++)))>>2,m=(3&f)<<6|(g=a.indexOf(l.charAt(b++))),S[w++]=d,f!==64&&(S[w++]=u),g!==64&&(S[w++]=m);return S}},{"./support":30,"./utils":32}],2:[function(t,r,o){var i=t("./external"),s=t("./stream/DataWorker"),a=t("./stream/Crc32Probe"),l=t("./stream/DataLengthProbe");function d(u,m,p,f,g){this.compressedSize=u,this.uncompressedSize=m,this.crc32=p,this.compression=f,this.compressedContent=g}d.prototype={getContentWorker:function(){var u=new s(i.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new l("data_length")),m=this;return u.on("end",function(){if(this.streamInfo.data_length!==m.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),u},getCompressedWorker:function(){return new s(i.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},d.createWorkerFrom=function(u,m,p){return u.pipe(new a).pipe(new l("uncompressedSize")).pipe(m.compressWorker(p)).pipe(new l("compressedSize")).withStreamInfo("compression",m)},r.exports=d},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,r,o){var i=t("./stream/GenericWorker");o.STORE={magic:"\0\0",compressWorker:function(){return new i("STORE compression")},uncompressWorker:function(){return new i("STORE decompression")}},o.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,r,o){var i=t("./utils"),s=(function(){for(var a,l=[],d=0;d<256;d++){a=d;for(var u=0;u<8;u++)a=1&a?3988292384^a>>>1:a>>>1;l[d]=a}return l})();r.exports=function(a,l){return a!==void 0&&a.length?i.getTypeOf(a)!=="string"?(function(d,u,m,p){var f=s,g=p+m;d^=-1;for(var b=p;b<g;b++)d=d>>>8^f[255&(d^u[b])];return-1^d})(0|l,a,a.length,0):(function(d,u,m,p){var f=s,g=p+m;d^=-1;for(var b=p;b<g;b++)d=d>>>8^f[255&(d^u.charCodeAt(b))];return-1^d})(0|l,a,a.length,0):0}},{"./utils":32}],5:[function(t,r,o){o.base64=!1,o.binary=!1,o.dir=!1,o.createFolders=!0,o.date=null,o.compression=null,o.compressionOptions=null,o.comment=null,o.unixPermissions=null,o.dosPermissions=null},{}],6:[function(t,r,o){var i=null;i=typeof Promise<"u"?Promise:t("lie"),r.exports={Promise:i}},{lie:37}],7:[function(t,r,o){var i=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",s=t("pako"),a=t("./utils"),l=t("./stream/GenericWorker"),d=i?"uint8array":"array";function u(m,p){l.call(this,"FlateWorker/"+m),this._pako=null,this._pakoAction=m,this._pakoOptions=p,this.meta={}}o.magic="\b\0",a.inherits(u,l),u.prototype.processChunk=function(m){this.meta=m.meta,this._pako===null&&this._createPako(),this._pako.push(a.transformTo(d,m.data),!1)},u.prototype.flush=function(){l.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},u.prototype.cleanUp=function(){l.prototype.cleanUp.call(this),this._pako=null},u.prototype._createPako=function(){this._pako=new s[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var m=this;this._pako.onData=function(p){m.push({data:p,meta:m.meta})}},o.compressWorker=function(m){return new u("Deflate",m)},o.uncompressWorker=function(){return new u("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,r,o){function i(f,g){var b,w="";for(b=0;b<g;b++)w+=String.fromCharCode(255&f),f>>>=8;return w}function s(f,g,b,w,v,S){var C,L,I=f.file,R=f.compression,F=S!==d.utf8encode,W=a.transformTo("string",S(I.name)),B=a.transformTo("string",d.utf8encode(I.name)),ne=I.comment,he=a.transformTo("string",S(ne)),D=a.transformTo("string",d.utf8encode(ne)),G=B.length!==I.name.length,x=D.length!==ne.length,Y="",re="",Z="",pe=I.dir,K=I.date,be={crc32:0,compressedSize:0,uncompressedSize:0};g&&!b||(be.crc32=f.crc32,be.compressedSize=f.compressedSize,be.uncompressedSize=f.uncompressedSize);var O=0;g&&(O|=8),F||!G&&!x||(O|=2048);var $=0,de=0;pe&&($|=16),v==="UNIX"?(de=798,$|=(function(ee,$e){var Ge=ee;return ee||(Ge=$e?16893:33204),(65535&Ge)<<16})(I.unixPermissions,pe)):(de=20,$|=(function(ee){return 63&(ee||0)})(I.dosPermissions)),C=K.getUTCHours(),C<<=6,C|=K.getUTCMinutes(),C<<=5,C|=K.getUTCSeconds()/2,L=K.getUTCFullYear()-1980,L<<=4,L|=K.getUTCMonth()+1,L<<=5,L|=K.getUTCDate(),G&&(re=i(1,1)+i(u(W),4)+B,Y+="up"+i(re.length,2)+re),x&&(Z=i(1,1)+i(u(he),4)+D,Y+="uc"+i(Z.length,2)+Z);var ie="";return ie+=`
\0`,ie+=i(O,2),ie+=R.magic,ie+=i(C,2),ie+=i(L,2),ie+=i(be.crc32,4),ie+=i(be.compressedSize,4),ie+=i(be.uncompressedSize,4),ie+=i(W.length,2),ie+=i(Y.length,2),{fileRecord:m.LOCAL_FILE_HEADER+ie+W+Y,dirRecord:m.CENTRAL_FILE_HEADER+i(de,2)+ie+i(he.length,2)+"\0\0\0\0"+i($,4)+i(w,4)+W+Y+he}}var a=t("../utils"),l=t("../stream/GenericWorker"),d=t("../utf8"),u=t("../crc32"),m=t("../signature");function p(f,g,b,w){l.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=b,this.encodeFileName=w,this.streamFiles=f,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}a.inherits(p,l),p.prototype.push=function(f){var g=f.meta.percent||0,b=this.entriesCount,w=this._sources.length;this.accumulate?this.contentBuffer.push(f):(this.bytesWritten+=f.data.length,l.prototype.push.call(this,{data:f.data,meta:{currentFile:this.currentFile,percent:b?(g+100*(b-w-1))/b:100}}))},p.prototype.openedSource=function(f){this.currentSourceOffset=this.bytesWritten,this.currentFile=f.file.name;var g=this.streamFiles&&!f.file.dir;if(g){var b=s(f,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:b.fileRecord,meta:{percent:0}})}else this.accumulate=!0},p.prototype.closedSource=function(f){this.accumulate=!1;var g=this.streamFiles&&!f.file.dir,b=s(f,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(b.dirRecord),g)this.push({data:(function(w){return m.DATA_DESCRIPTOR+i(w.crc32,4)+i(w.compressedSize,4)+i(w.uncompressedSize,4)})(f),meta:{percent:100}});else for(this.push({data:b.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},p.prototype.flush=function(){for(var f=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var b=this.bytesWritten-f,w=(function(v,S,C,L,I){var R=a.transformTo("string",I(L));return m.CENTRAL_DIRECTORY_END+"\0\0\0\0"+i(v,2)+i(v,2)+i(S,4)+i(C,4)+i(R.length,2)+R})(this.dirRecords.length,b,f,this.zipComment,this.encodeFileName);this.push({data:w,meta:{percent:100}})},p.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},p.prototype.registerPrevious=function(f){this._sources.push(f);var g=this;return f.on("data",function(b){g.processChunk(b)}),f.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),f.on("error",function(b){g.error(b)}),this},p.prototype.resume=function(){return!!l.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},p.prototype.error=function(f){var g=this._sources;if(!l.prototype.error.call(this,f))return!1;for(var b=0;b<g.length;b++)try{g[b].error(f)}catch{}return!0},p.prototype.lock=function(){l.prototype.lock.call(this);for(var f=this._sources,g=0;g<f.length;g++)f[g].lock()},r.exports=p},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,r,o){var i=t("../compressions"),s=t("./ZipFileWorker");o.generateWorker=function(a,l,d){var u=new s(l.streamFiles,d,l.platform,l.encodeFileName),m=0;try{a.forEach(function(p,f){m++;var g=(function(S,C){var L=S||C,I=i[L];if(!I)throw new Error(L+" is not a valid compression method !");return I})(f.options.compression,l.compression),b=f.options.compressionOptions||l.compressionOptions||{},w=f.dir,v=f.date;f._compressWorker(g,b).withStreamInfo("file",{name:p,dir:w,date:v,comment:f.comment||"",unixPermissions:f.unixPermissions,dosPermissions:f.dosPermissions}).pipe(u)}),u.entriesCount=m}catch(p){u.error(p)}return u}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,r,o){function i(){if(!(this instanceof i))return new i;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var s=new i;for(var a in this)typeof this[a]!="function"&&(s[a]=this[a]);return s}}(i.prototype=t("./object")).loadAsync=t("./load"),i.support=t("./support"),i.defaults=t("./defaults"),i.version="3.10.1",i.loadAsync=function(s,a){return new i().loadAsync(s,a)},i.external=t("./external"),r.exports=i},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,r,o){var i=t("./utils"),s=t("./external"),a=t("./utf8"),l=t("./zipEntries"),d=t("./stream/Crc32Probe"),u=t("./nodejsUtils");function m(p){return new s.Promise(function(f,g){var b=p.decompressed.getContentWorker().pipe(new d);b.on("error",function(w){g(w)}).on("end",function(){b.streamInfo.crc32!==p.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):f()}).resume()})}r.exports=function(p,f){var g=this;return f=i.extend(f||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:a.utf8decode}),u.isNode&&u.isStream(p)?s.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):i.prepareContent("the loaded zip file",p,!0,f.optimizedBinaryString,f.base64).then(function(b){var w=new l(f);return w.load(b),w}).then(function(b){var w=[s.Promise.resolve(b)],v=b.files;if(f.checkCRC32)for(var S=0;S<v.length;S++)w.push(m(v[S]));return s.Promise.all(w)}).then(function(b){for(var w=b.shift(),v=w.files,S=0;S<v.length;S++){var C=v[S],L=C.fileNameStr,I=i.resolve(C.fileNameStr);g.file(I,C.decompressed,{binary:!0,optimizedBinaryString:!0,date:C.date,dir:C.dir,comment:C.fileCommentStr.length?C.fileCommentStr:null,unixPermissions:C.unixPermissions,dosPermissions:C.dosPermissions,createFolders:f.createFolders}),C.dir||(g.file(I).unsafeOriginalName=L)}return w.zipComment.length&&(g.comment=w.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,r,o){var i=t("../utils"),s=t("../stream/GenericWorker");function a(l,d){s.call(this,"Nodejs stream input adapter for "+l),this._upstreamEnded=!1,this._bindStream(d)}i.inherits(a,s),a.prototype._bindStream=function(l){var d=this;(this._stream=l).pause(),l.on("data",function(u){d.push({data:u,meta:{percent:0}})}).on("error",function(u){d.isPaused?this.generatedError=u:d.error(u)}).on("end",function(){d.isPaused?d._upstreamEnded=!0:d.end()})},a.prototype.pause=function(){return!!s.prototype.pause.call(this)&&(this._stream.pause(),!0)},a.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},r.exports=a},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,r,o){var i=t("readable-stream").Readable;function s(a,l,d){i.call(this,l),this._helper=a;var u=this;a.on("data",function(m,p){u.push(m)||u._helper.pause(),d&&d(p)}).on("error",function(m){u.emit("error",m)}).on("end",function(){u.push(null)})}t("../utils").inherits(s,i),s.prototype._read=function(){this._helper.resume()},r.exports=s},{"../utils":32,"readable-stream":16}],14:[function(t,r,o){r.exports={isNode:typeof Buffer<"u",newBufferFrom:function(i,s){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(i,s);if(typeof i=="number")throw new Error('The "data" argument must not be a number');return new Buffer(i,s)},allocBuffer:function(i){if(Buffer.alloc)return Buffer.alloc(i);var s=new Buffer(i);return s.fill(0),s},isBuffer:function(i){return Buffer.isBuffer(i)},isStream:function(i){return i&&typeof i.on=="function"&&typeof i.pause=="function"&&typeof i.resume=="function"}}},{}],15:[function(t,r,o){function i(I,R,F){var W,B=a.getTypeOf(R),ne=a.extend(F||{},u);ne.date=ne.date||new Date,ne.compression!==null&&(ne.compression=ne.compression.toUpperCase()),typeof ne.unixPermissions=="string"&&(ne.unixPermissions=parseInt(ne.unixPermissions,8)),ne.unixPermissions&&16384&ne.unixPermissions&&(ne.dir=!0),ne.dosPermissions&&16&ne.dosPermissions&&(ne.dir=!0),ne.dir&&(I=v(I)),ne.createFolders&&(W=w(I))&&S.call(this,W,!0);var he=B==="string"&&ne.binary===!1&&ne.base64===!1;F&&F.binary!==void 0||(ne.binary=!he),(R instanceof m&&R.uncompressedSize===0||ne.dir||!R||R.length===0)&&(ne.base64=!1,ne.binary=!0,R="",ne.compression="STORE",B="string");var D=null;D=R instanceof m||R instanceof l?R:g.isNode&&g.isStream(R)?new b(I,R):a.prepareContent(I,R,ne.binary,ne.optimizedBinaryString,ne.base64);var G=new p(I,D,ne);this.files[I]=G}var s=t("./utf8"),a=t("./utils"),l=t("./stream/GenericWorker"),d=t("./stream/StreamHelper"),u=t("./defaults"),m=t("./compressedObject"),p=t("./zipObject"),f=t("./generate"),g=t("./nodejsUtils"),b=t("./nodejs/NodejsStreamInputAdapter"),w=function(I){I.slice(-1)==="/"&&(I=I.substring(0,I.length-1));var R=I.lastIndexOf("/");return 0<R?I.substring(0,R):""},v=function(I){return I.slice(-1)!=="/"&&(I+="/"),I},S=function(I,R){return R=R!==void 0?R:u.createFolders,I=v(I),this.files[I]||i.call(this,I,null,{dir:!0,createFolders:R}),this.files[I]};function C(I){return Object.prototype.toString.call(I)==="[object RegExp]"}var L={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(I){var R,F,W;for(R in this.files)W=this.files[R],(F=R.slice(this.root.length,R.length))&&R.slice(0,this.root.length)===this.root&&I(F,W)},filter:function(I){var R=[];return this.forEach(function(F,W){I(F,W)&&R.push(W)}),R},file:function(I,R,F){if(arguments.length!==1)return I=this.root+I,i.call(this,I,R,F),this;if(C(I)){var W=I;return this.filter(function(ne,he){return!he.dir&&W.test(ne)})}var B=this.files[this.root+I];return B&&!B.dir?B:null},folder:function(I){if(!I)return this;if(C(I))return this.filter(function(B,ne){return ne.dir&&I.test(B)});var R=this.root+I,F=S.call(this,R),W=this.clone();return W.root=F.name,W},remove:function(I){I=this.root+I;var R=this.files[I];if(R||(I.slice(-1)!=="/"&&(I+="/"),R=this.files[I]),R&&!R.dir)delete this.files[I];else for(var F=this.filter(function(B,ne){return ne.name.slice(0,I.length)===I}),W=0;W<F.length;W++)delete this.files[F[W].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(I){var R,F={};try{if((F=a.extend(I||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:s.utf8encode})).type=F.type.toLowerCase(),F.compression=F.compression.toUpperCase(),F.type==="binarystring"&&(F.type="string"),!F.type)throw new Error("No output type specified.");a.checkSupport(F.type),F.platform!=="darwin"&&F.platform!=="freebsd"&&F.platform!=="linux"&&F.platform!=="sunos"||(F.platform="UNIX"),F.platform==="win32"&&(F.platform="DOS");var W=F.comment||this.comment||"";R=f.generateWorker(this,F,W)}catch(B){(R=new l("error")).error(B)}return new d(R,F.type||"string",F.mimeType)},generateAsync:function(I,R){return this.generateInternalStream(I).accumulate(R)},generateNodeStream:function(I,R){return(I=I||{}).type||(I.type="nodebuffer"),this.generateInternalStream(I).toNodejsStream(R)}};r.exports=L},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,r,o){r.exports=t("stream")},{stream:void 0}],17:[function(t,r,o){var i=t("./DataReader");function s(a){i.call(this,a);for(var l=0;l<this.data.length;l++)a[l]=255&a[l]}t("../utils").inherits(s,i),s.prototype.byteAt=function(a){return this.data[this.zero+a]},s.prototype.lastIndexOfSignature=function(a){for(var l=a.charCodeAt(0),d=a.charCodeAt(1),u=a.charCodeAt(2),m=a.charCodeAt(3),p=this.length-4;0<=p;--p)if(this.data[p]===l&&this.data[p+1]===d&&this.data[p+2]===u&&this.data[p+3]===m)return p-this.zero;return-1},s.prototype.readAndCheckSignature=function(a){var l=a.charCodeAt(0),d=a.charCodeAt(1),u=a.charCodeAt(2),m=a.charCodeAt(3),p=this.readData(4);return l===p[0]&&d===p[1]&&u===p[2]&&m===p[3]},s.prototype.readData=function(a){if(this.checkOffset(a),a===0)return[];var l=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,l},r.exports=s},{"../utils":32,"./DataReader":18}],18:[function(t,r,o){var i=t("../utils");function s(a){this.data=a,this.length=a.length,this.index=0,this.zero=0}s.prototype={checkOffset:function(a){this.checkIndex(this.index+a)},checkIndex:function(a){if(this.length<this.zero+a||a<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+a+"). Corrupted zip ?")},setIndex:function(a){this.checkIndex(a),this.index=a},skip:function(a){this.setIndex(this.index+a)},byteAt:function(){},readInt:function(a){var l,d=0;for(this.checkOffset(a),l=this.index+a-1;l>=this.index;l--)d=(d<<8)+this.byteAt(l);return this.index+=a,d},readString:function(a){return i.transformTo("string",this.readData(a))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var a=this.readInt(4);return new Date(Date.UTC(1980+(a>>25&127),(a>>21&15)-1,a>>16&31,a>>11&31,a>>5&63,(31&a)<<1))}},r.exports=s},{"../utils":32}],19:[function(t,r,o){var i=t("./Uint8ArrayReader");function s(a){i.call(this,a)}t("../utils").inherits(s,i),s.prototype.readData=function(a){this.checkOffset(a);var l=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,l},r.exports=s},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,r,o){var i=t("./DataReader");function s(a){i.call(this,a)}t("../utils").inherits(s,i),s.prototype.byteAt=function(a){return this.data.charCodeAt(this.zero+a)},s.prototype.lastIndexOfSignature=function(a){return this.data.lastIndexOf(a)-this.zero},s.prototype.readAndCheckSignature=function(a){return a===this.readData(4)},s.prototype.readData=function(a){this.checkOffset(a);var l=this.data.slice(this.zero+this.index,this.zero+this.index+a);return this.index+=a,l},r.exports=s},{"../utils":32,"./DataReader":18}],21:[function(t,r,o){var i=t("./ArrayReader");function s(a){i.call(this,a)}t("../utils").inherits(s,i),s.prototype.readData=function(a){if(this.checkOffset(a),a===0)return new Uint8Array(0);var l=this.data.subarray(this.zero+this.index,this.zero+this.index+a);return this.index+=a,l},r.exports=s},{"../utils":32,"./ArrayReader":17}],22:[function(t,r,o){var i=t("../utils"),s=t("../support"),a=t("./ArrayReader"),l=t("./StringReader"),d=t("./NodeBufferReader"),u=t("./Uint8ArrayReader");r.exports=function(m){var p=i.getTypeOf(m);return i.checkSupport(p),p!=="string"||s.uint8array?p==="nodebuffer"?new d(m):s.uint8array?new u(i.transformTo("uint8array",m)):new a(i.transformTo("array",m)):new l(m)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,r,o){o.LOCAL_FILE_HEADER="PK",o.CENTRAL_FILE_HEADER="PK",o.CENTRAL_DIRECTORY_END="PK",o.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",o.ZIP64_CENTRAL_DIRECTORY_END="PK",o.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,r,o){var i=t("./GenericWorker"),s=t("../utils");function a(l){i.call(this,"ConvertWorker to "+l),this.destType=l}s.inherits(a,i),a.prototype.processChunk=function(l){this.push({data:s.transformTo(this.destType,l.data),meta:l.meta})},r.exports=a},{"../utils":32,"./GenericWorker":28}],25:[function(t,r,o){var i=t("./GenericWorker"),s=t("../crc32");function a(){i.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(a,i),a.prototype.processChunk=function(l){this.streamInfo.crc32=s(l.data,this.streamInfo.crc32||0),this.push(l)},r.exports=a},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,r,o){var i=t("../utils"),s=t("./GenericWorker");function a(l){s.call(this,"DataLengthProbe for "+l),this.propName=l,this.withStreamInfo(l,0)}i.inherits(a,s),a.prototype.processChunk=function(l){if(l){var d=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=d+l.data.length}s.prototype.processChunk.call(this,l)},r.exports=a},{"../utils":32,"./GenericWorker":28}],27:[function(t,r,o){var i=t("../utils"),s=t("./GenericWorker");function a(l){s.call(this,"DataWorker");var d=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,l.then(function(u){d.dataIsReady=!0,d.data=u,d.max=u&&u.length||0,d.type=i.getTypeOf(u),d.isPaused||d._tickAndRepeat()},function(u){d.error(u)})}i.inherits(a,s),a.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this.data=null},a.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,i.delay(this._tickAndRepeat,[],this)),!0)},a.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(i.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},a.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var l=null,d=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":l=this.data.substring(this.index,d);break;case"uint8array":l=this.data.subarray(this.index,d);break;case"array":case"nodebuffer":l=this.data.slice(this.index,d)}return this.index=d,this.push({data:l,meta:{percent:this.max?this.index/this.max*100:0}})},r.exports=a},{"../utils":32,"./GenericWorker":28}],28:[function(t,r,o){function i(s){this.name=s||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}i.prototype={push:function(s){this.emit("data",s)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(s){this.emit("error",s)}return!0},error:function(s){return!this.isFinished&&(this.isPaused?this.generatedError=s:(this.isFinished=!0,this.emit("error",s),this.previous&&this.previous.error(s),this.cleanUp()),!0)},on:function(s,a){return this._listeners[s].push(a),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(s,a){if(this._listeners[s])for(var l=0;l<this._listeners[s].length;l++)this._listeners[s][l].call(this,a)},pipe:function(s){return s.registerPrevious(this)},registerPrevious:function(s){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=s.streamInfo,this.mergeStreamInfo(),this.previous=s;var a=this;return s.on("data",function(l){a.processChunk(l)}),s.on("end",function(){a.end()}),s.on("error",function(l){a.error(l)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var s=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),s=!0),this.previous&&this.previous.resume(),!s},flush:function(){},processChunk:function(s){this.push(s)},withStreamInfo:function(s,a){return this.extraStreamInfo[s]=a,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var s in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,s)&&(this.streamInfo[s]=this.extraStreamInfo[s])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var s="Worker "+this.name;return this.previous?this.previous+" -> "+s:s}},r.exports=i},{}],29:[function(t,r,o){var i=t("../utils"),s=t("./ConvertWorker"),a=t("./GenericWorker"),l=t("../base64"),d=t("../support"),u=t("../external"),m=null;if(d.nodestream)try{m=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function p(g,b){return new u.Promise(function(w,v){var S=[],C=g._internalType,L=g._outputType,I=g._mimeType;g.on("data",function(R,F){S.push(R),b&&b(F)}).on("error",function(R){S=[],v(R)}).on("end",function(){try{var R=(function(F,W,B){switch(F){case"blob":return i.newBlob(i.transformTo("arraybuffer",W),B);case"base64":return l.encode(W);default:return i.transformTo(F,W)}})(L,(function(F,W){var B,ne=0,he=null,D=0;for(B=0;B<W.length;B++)D+=W[B].length;switch(F){case"string":return W.join("");case"array":return Array.prototype.concat.apply([],W);case"uint8array":for(he=new Uint8Array(D),B=0;B<W.length;B++)he.set(W[B],ne),ne+=W[B].length;return he;case"nodebuffer":return Buffer.concat(W);default:throw new Error("concat : unsupported type '"+F+"'")}})(C,S),I);w(R)}catch(F){v(F)}S=[]}).resume()})}function f(g,b,w){var v=b;switch(b){case"blob":case"arraybuffer":v="uint8array";break;case"base64":v="string"}try{this._internalType=v,this._outputType=b,this._mimeType=w,i.checkSupport(v),this._worker=g.pipe(new s(v)),g.lock()}catch(S){this._worker=new a("error"),this._worker.error(S)}}f.prototype={accumulate:function(g){return p(this,g)},on:function(g,b){var w=this;return g==="data"?this._worker.on(g,function(v){b.call(w,v.data,v.meta)}):this._worker.on(g,function(){i.delay(b,arguments,w)}),this},resume:function(){return i.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(i.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new m(this,{objectMode:this._outputType!=="nodebuffer"},g)}},r.exports=f},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,r,o){if(o.base64=!0,o.array=!0,o.string=!0,o.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",o.nodebuffer=typeof Buffer<"u",o.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")o.blob=!1;else{var i=new ArrayBuffer(0);try{o.blob=new Blob([i],{type:"application/zip"}).size===0}catch{try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);s.append(i),o.blob=s.getBlob("application/zip").size===0}catch{o.blob=!1}}}try{o.nodestream=!!t("readable-stream").Readable}catch{o.nodestream=!1}},{"readable-stream":16}],31:[function(t,r,o){for(var i=t("./utils"),s=t("./support"),a=t("./nodejsUtils"),l=t("./stream/GenericWorker"),d=new Array(256),u=0;u<256;u++)d[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;d[254]=d[254]=1;function m(){l.call(this,"utf-8 decode"),this.leftOver=null}function p(){l.call(this,"utf-8 encode")}o.utf8encode=function(f){return s.nodebuffer?a.newBufferFrom(f,"utf-8"):(function(g){var b,w,v,S,C,L=g.length,I=0;for(S=0;S<L;S++)(64512&(w=g.charCodeAt(S)))==55296&&S+1<L&&(64512&(v=g.charCodeAt(S+1)))==56320&&(w=65536+(w-55296<<10)+(v-56320),S++),I+=w<128?1:w<2048?2:w<65536?3:4;for(b=s.uint8array?new Uint8Array(I):new Array(I),S=C=0;C<I;S++)(64512&(w=g.charCodeAt(S)))==55296&&S+1<L&&(64512&(v=g.charCodeAt(S+1)))==56320&&(w=65536+(w-55296<<10)+(v-56320),S++),w<128?b[C++]=w:(w<2048?b[C++]=192|w>>>6:(w<65536?b[C++]=224|w>>>12:(b[C++]=240|w>>>18,b[C++]=128|w>>>12&63),b[C++]=128|w>>>6&63),b[C++]=128|63&w);return b})(f)},o.utf8decode=function(f){return s.nodebuffer?i.transformTo("nodebuffer",f).toString("utf-8"):(function(g){var b,w,v,S,C=g.length,L=new Array(2*C);for(b=w=0;b<C;)if((v=g[b++])<128)L[w++]=v;else if(4<(S=d[v]))L[w++]=65533,b+=S-1;else{for(v&=S===2?31:S===3?15:7;1<S&&b<C;)v=v<<6|63&g[b++],S--;1<S?L[w++]=65533:v<65536?L[w++]=v:(v-=65536,L[w++]=55296|v>>10&1023,L[w++]=56320|1023&v)}return L.length!==w&&(L.subarray?L=L.subarray(0,w):L.length=w),i.applyFromCharCode(L)})(f=i.transformTo(s.uint8array?"uint8array":"array",f))},i.inherits(m,l),m.prototype.processChunk=function(f){var g=i.transformTo(s.uint8array?"uint8array":"array",f.data);if(this.leftOver&&this.leftOver.length){if(s.uint8array){var b=g;(g=new Uint8Array(b.length+this.leftOver.length)).set(this.leftOver,0),g.set(b,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var w=(function(S,C){var L;for((C=C||S.length)>S.length&&(C=S.length),L=C-1;0<=L&&(192&S[L])==128;)L--;return L<0||L===0?C:L+d[S[L]]>C?L:C})(g),v=g;w!==g.length&&(s.uint8array?(v=g.subarray(0,w),this.leftOver=g.subarray(w,g.length)):(v=g.slice(0,w),this.leftOver=g.slice(w,g.length))),this.push({data:o.utf8decode(v),meta:f.meta})},m.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:o.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},o.Utf8DecodeWorker=m,i.inherits(p,l),p.prototype.processChunk=function(f){this.push({data:o.utf8encode(f.data),meta:f.meta})},o.Utf8EncodeWorker=p},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,r,o){var i=t("./support"),s=t("./base64"),a=t("./nodejsUtils"),l=t("./external");function d(b){return b}function u(b,w){for(var v=0;v<b.length;++v)w[v]=255&b.charCodeAt(v);return w}t("setimmediate"),o.newBlob=function(b,w){o.checkSupport("blob");try{return new Blob([b],{type:w})}catch{try{var v=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return v.append(b),v.getBlob(w)}catch{throw new Error("Bug : can't construct the Blob.")}}};var m={stringifyByChunk:function(b,w,v){var S=[],C=0,L=b.length;if(L<=v)return String.fromCharCode.apply(null,b);for(;C<L;)w==="array"||w==="nodebuffer"?S.push(String.fromCharCode.apply(null,b.slice(C,Math.min(C+v,L)))):S.push(String.fromCharCode.apply(null,b.subarray(C,Math.min(C+v,L)))),C+=v;return S.join("")},stringifyByChar:function(b){for(var w="",v=0;v<b.length;v++)w+=String.fromCharCode(b[v]);return w},applyCanBeUsed:{uint8array:(function(){try{return i.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}})(),nodebuffer:(function(){try{return i.nodebuffer&&String.fromCharCode.apply(null,a.allocBuffer(1)).length===1}catch{return!1}})()}};function p(b){var w=65536,v=o.getTypeOf(b),S=!0;if(v==="uint8array"?S=m.applyCanBeUsed.uint8array:v==="nodebuffer"&&(S=m.applyCanBeUsed.nodebuffer),S)for(;1<w;)try{return m.stringifyByChunk(b,v,w)}catch{w=Math.floor(w/2)}return m.stringifyByChar(b)}function f(b,w){for(var v=0;v<b.length;v++)w[v]=b[v];return w}o.applyFromCharCode=p;var g={};g.string={string:d,array:function(b){return u(b,new Array(b.length))},arraybuffer:function(b){return g.string.uint8array(b).buffer},uint8array:function(b){return u(b,new Uint8Array(b.length))},nodebuffer:function(b){return u(b,a.allocBuffer(b.length))}},g.array={string:p,array:d,arraybuffer:function(b){return new Uint8Array(b).buffer},uint8array:function(b){return new Uint8Array(b)},nodebuffer:function(b){return a.newBufferFrom(b)}},g.arraybuffer={string:function(b){return p(new Uint8Array(b))},array:function(b){return f(new Uint8Array(b),new Array(b.byteLength))},arraybuffer:d,uint8array:function(b){return new Uint8Array(b)},nodebuffer:function(b){return a.newBufferFrom(new Uint8Array(b))}},g.uint8array={string:p,array:function(b){return f(b,new Array(b.length))},arraybuffer:function(b){return b.buffer},uint8array:d,nodebuffer:function(b){return a.newBufferFrom(b)}},g.nodebuffer={string:p,array:function(b){return f(b,new Array(b.length))},arraybuffer:function(b){return g.nodebuffer.uint8array(b).buffer},uint8array:function(b){return f(b,new Uint8Array(b.length))},nodebuffer:d},o.transformTo=function(b,w){if(w=w||"",!b)return w;o.checkSupport(b);var v=o.getTypeOf(w);return g[v][b](w)},o.resolve=function(b){for(var w=b.split("/"),v=[],S=0;S<w.length;S++){var C=w[S];C==="."||C===""&&S!==0&&S!==w.length-1||(C===".."?v.pop():v.push(C))}return v.join("/")},o.getTypeOf=function(b){return typeof b=="string"?"string":Object.prototype.toString.call(b)==="[object Array]"?"array":i.nodebuffer&&a.isBuffer(b)?"nodebuffer":i.uint8array&&b instanceof Uint8Array?"uint8array":i.arraybuffer&&b instanceof ArrayBuffer?"arraybuffer":void 0},o.checkSupport=function(b){if(!i[b.toLowerCase()])throw new Error(b+" is not supported by this platform")},o.MAX_VALUE_16BITS=65535,o.MAX_VALUE_32BITS=-1,o.pretty=function(b){var w,v,S="";for(v=0;v<(b||"").length;v++)S+="\\x"+((w=b.charCodeAt(v))<16?"0":"")+w.toString(16).toUpperCase();return S},o.delay=function(b,w,v){setImmediate(function(){b.apply(v||null,w||[])})},o.inherits=function(b,w){function v(){}v.prototype=w.prototype,b.prototype=new v},o.extend=function(){var b,w,v={};for(b=0;b<arguments.length;b++)for(w in arguments[b])Object.prototype.hasOwnProperty.call(arguments[b],w)&&v[w]===void 0&&(v[w]=arguments[b][w]);return v},o.prepareContent=function(b,w,v,S,C){return l.Promise.resolve(w).then(function(L){return i.blob&&(L instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(L))!==-1)&&typeof FileReader<"u"?new l.Promise(function(I,R){var F=new FileReader;F.onload=function(W){I(W.target.result)},F.onerror=function(W){R(W.target.error)},F.readAsArrayBuffer(L)}):L}).then(function(L){var I=o.getTypeOf(L);return I?(I==="arraybuffer"?L=o.transformTo("uint8array",L):I==="string"&&(C?L=s.decode(L):v&&S!==!0&&(L=(function(R){return u(R,i.uint8array?new Uint8Array(R.length):new Array(R.length))})(L))),L):l.Promise.reject(new Error("Can't read the data of '"+b+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,r,o){var i=t("./reader/readerFor"),s=t("./utils"),a=t("./signature"),l=t("./zipEntry"),d=t("./support");function u(m){this.files=[],this.loadOptions=m}u.prototype={checkSignature:function(m){if(!this.reader.readAndCheckSignature(m)){this.reader.index-=4;var p=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+s.pretty(p)+", expected "+s.pretty(m)+")")}},isSignature:function(m,p){var f=this.reader.index;this.reader.setIndex(m);var g=this.reader.readString(4)===p;return this.reader.setIndex(f),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var m=this.reader.readData(this.zipCommentLength),p=d.uint8array?"uint8array":"array",f=s.transformTo(p,m);this.zipComment=this.loadOptions.decodeFileName(f)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var m,p,f,g=this.zip64EndOfCentralSize-44;0<g;)m=this.reader.readInt(2),p=this.reader.readInt(4),f=this.reader.readData(p),this.zip64ExtensibleData[m]={id:m,length:p,value:f}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var m,p;for(m=0;m<this.files.length;m++)p=this.files[m],this.reader.setIndex(p.localHeaderOffset),this.checkSignature(a.LOCAL_FILE_HEADER),p.readLocalPart(this.reader),p.handleUTF8(),p.processAttributes()},readCentralDir:function(){var m;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(a.CENTRAL_FILE_HEADER);)(m=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(m);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var m=this.reader.lastIndexOfSignature(a.CENTRAL_DIRECTORY_END);if(m<0)throw this.isSignature(0,a.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(m);var p=m;if(this.checkSignature(a.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===s.MAX_VALUE_16BITS||this.diskWithCentralDirStart===s.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===s.MAX_VALUE_16BITS||this.centralDirRecords===s.MAX_VALUE_16BITS||this.centralDirSize===s.MAX_VALUE_32BITS||this.centralDirOffset===s.MAX_VALUE_32BITS){if(this.zip64=!0,(m=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(m),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,a.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var f=this.centralDirOffset+this.centralDirSize;this.zip64&&(f+=20,f+=12+this.zip64EndOfCentralSize);var g=p-f;if(0<g)this.isSignature(p,a.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(m){this.reader=i(m)},load:function(m){this.prepareReader(m),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},r.exports=u},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,r,o){var i=t("./reader/readerFor"),s=t("./utils"),a=t("./compressedObject"),l=t("./crc32"),d=t("./utf8"),u=t("./compressions"),m=t("./support");function p(f,g){this.options=f,this.loadOptions=g}p.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(f){var g,b;if(f.skip(22),this.fileNameLength=f.readInt(2),b=f.readInt(2),this.fileName=f.readData(this.fileNameLength),f.skip(b),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=(function(w){for(var v in u)if(Object.prototype.hasOwnProperty.call(u,v)&&u[v].magic===w)return u[v];return null})(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+s.pretty(this.compressionMethod)+" unknown (inner file : "+s.transformTo("string",this.fileName)+")");this.decompressed=new a(this.compressedSize,this.uncompressedSize,this.crc32,g,f.readData(this.compressedSize))},readCentralPart:function(f){this.versionMadeBy=f.readInt(2),f.skip(2),this.bitFlag=f.readInt(2),this.compressionMethod=f.readString(2),this.date=f.readDate(),this.crc32=f.readInt(4),this.compressedSize=f.readInt(4),this.uncompressedSize=f.readInt(4);var g=f.readInt(2);if(this.extraFieldsLength=f.readInt(2),this.fileCommentLength=f.readInt(2),this.diskNumberStart=f.readInt(2),this.internalFileAttributes=f.readInt(2),this.externalFileAttributes=f.readInt(4),this.localHeaderOffset=f.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");f.skip(g),this.readExtraFields(f),this.parseZIP64ExtraField(f),this.fileComment=f.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var f=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),f==0&&(this.dosPermissions=63&this.externalFileAttributes),f==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var f=i(this.extraFields[1].value);this.uncompressedSize===s.MAX_VALUE_32BITS&&(this.uncompressedSize=f.readInt(8)),this.compressedSize===s.MAX_VALUE_32BITS&&(this.compressedSize=f.readInt(8)),this.localHeaderOffset===s.MAX_VALUE_32BITS&&(this.localHeaderOffset=f.readInt(8)),this.diskNumberStart===s.MAX_VALUE_32BITS&&(this.diskNumberStart=f.readInt(4))}},readExtraFields:function(f){var g,b,w,v=f.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});f.index+4<v;)g=f.readInt(2),b=f.readInt(2),w=f.readData(b),this.extraFields[g]={id:g,length:b,value:w};f.setIndex(v)},handleUTF8:function(){var f=m.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=d.utf8decode(this.fileName),this.fileCommentStr=d.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var b=s.transformTo(f,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(b)}var w=this.findExtraFieldUnicodeComment();if(w!==null)this.fileCommentStr=w;else{var v=s.transformTo(f,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(v)}}},findExtraFieldUnicodePath:function(){var f=this.extraFields[28789];if(f){var g=i(f.value);return g.readInt(1)!==1||l(this.fileName)!==g.readInt(4)?null:d.utf8decode(g.readData(f.length-5))}return null},findExtraFieldUnicodeComment:function(){var f=this.extraFields[25461];if(f){var g=i(f.value);return g.readInt(1)!==1||l(this.fileComment)!==g.readInt(4)?null:d.utf8decode(g.readData(f.length-5))}return null}},r.exports=p},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,r,o){function i(g,b,w){this.name=g,this.dir=w.dir,this.date=w.date,this.comment=w.comment,this.unixPermissions=w.unixPermissions,this.dosPermissions=w.dosPermissions,this._data=b,this._dataBinary=w.binary,this.options={compression:w.compression,compressionOptions:w.compressionOptions}}var s=t("./stream/StreamHelper"),a=t("./stream/DataWorker"),l=t("./utf8"),d=t("./compressedObject"),u=t("./stream/GenericWorker");i.prototype={internalStream:function(g){var b=null,w="string";try{if(!g)throw new Error("No output type specified.");var v=(w=g.toLowerCase())==="string"||w==="text";w!=="binarystring"&&w!=="text"||(w="string"),b=this._decompressWorker();var S=!this._dataBinary;S&&!v&&(b=b.pipe(new l.Utf8EncodeWorker)),!S&&v&&(b=b.pipe(new l.Utf8DecodeWorker))}catch(C){(b=new u("error")).error(C)}return new s(b,w,"")},async:function(g,b){return this.internalStream(g).accumulate(b)},nodeStream:function(g,b){return this.internalStream(g||"nodebuffer").toNodejsStream(b)},_compressWorker:function(g,b){if(this._data instanceof d&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var w=this._decompressWorker();return this._dataBinary||(w=w.pipe(new l.Utf8EncodeWorker)),d.createWorkerFrom(w,g,b)},_decompressWorker:function(){return this._data instanceof d?this._data.getContentWorker():this._data instanceof u?this._data:new a(this._data)}};for(var m=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],p=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},f=0;f<m.length;f++)i.prototype[m[f]]=p;r.exports=i},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,r,o){(function(i){var s,a,l=i.MutationObserver||i.WebKitMutationObserver;if(l){var d=0,u=new l(g),m=i.document.createTextNode("");u.observe(m,{characterData:!0}),s=function(){m.data=d=++d%2}}else if(i.setImmediate||i.MessageChannel===void 0)s="document"in i&&"onreadystatechange"in i.document.createElement("script")?function(){var b=i.document.createElement("script");b.onreadystatechange=function(){g(),b.onreadystatechange=null,b.parentNode.removeChild(b),b=null},i.document.documentElement.appendChild(b)}:function(){setTimeout(g,0)};else{var p=new i.MessageChannel;p.port1.onmessage=g,s=function(){p.port2.postMessage(0)}}var f=[];function g(){var b,w;a=!0;for(var v=f.length;v;){for(w=f,f=[],b=-1;++b<v;)w[b]();v=f.length}a=!1}r.exports=function(b){f.push(b)!==1||a||s()}}).call(this,typeof Jr<"u"?Jr:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,r,o){var i=t("immediate");function s(){}var a={},l=["REJECTED"],d=["FULFILLED"],u=["PENDING"];function m(v){if(typeof v!="function")throw new TypeError("resolver must be a function");this.state=u,this.queue=[],this.outcome=void 0,v!==s&&b(this,v)}function p(v,S,C){this.promise=v,typeof S=="function"&&(this.onFulfilled=S,this.callFulfilled=this.otherCallFulfilled),typeof C=="function"&&(this.onRejected=C,this.callRejected=this.otherCallRejected)}function f(v,S,C){i(function(){var L;try{L=S(C)}catch(I){return a.reject(v,I)}L===v?a.reject(v,new TypeError("Cannot resolve promise with itself")):a.resolve(v,L)})}function g(v){var S=v&&v.then;if(v&&(typeof v=="object"||typeof v=="function")&&typeof S=="function")return function(){S.apply(v,arguments)}}function b(v,S){var C=!1;function L(F){C||(C=!0,a.reject(v,F))}function I(F){C||(C=!0,a.resolve(v,F))}var R=w(function(){S(I,L)});R.status==="error"&&L(R.value)}function w(v,S){var C={};try{C.value=v(S),C.status="success"}catch(L){C.status="error",C.value=L}return C}(r.exports=m).prototype.finally=function(v){if(typeof v!="function")return this;var S=this.constructor;return this.then(function(C){return S.resolve(v()).then(function(){return C})},function(C){return S.resolve(v()).then(function(){throw C})})},m.prototype.catch=function(v){return this.then(null,v)},m.prototype.then=function(v,S){if(typeof v!="function"&&this.state===d||typeof S!="function"&&this.state===l)return this;var C=new this.constructor(s);return this.state!==u?f(C,this.state===d?v:S,this.outcome):this.queue.push(new p(C,v,S)),C},p.prototype.callFulfilled=function(v){a.resolve(this.promise,v)},p.prototype.otherCallFulfilled=function(v){f(this.promise,this.onFulfilled,v)},p.prototype.callRejected=function(v){a.reject(this.promise,v)},p.prototype.otherCallRejected=function(v){f(this.promise,this.onRejected,v)},a.resolve=function(v,S){var C=w(g,S);if(C.status==="error")return a.reject(v,C.value);var L=C.value;if(L)b(v,L);else{v.state=d,v.outcome=S;for(var I=-1,R=v.queue.length;++I<R;)v.queue[I].callFulfilled(S)}return v},a.reject=function(v,S){v.state=l,v.outcome=S;for(var C=-1,L=v.queue.length;++C<L;)v.queue[C].callRejected(S);return v},m.resolve=function(v){return v instanceof this?v:a.resolve(new this(s),v)},m.reject=function(v){var S=new this(s);return a.reject(S,v)},m.all=function(v){var S=this;if(Object.prototype.toString.call(v)!=="[object Array]")return this.reject(new TypeError("must be an array"));var C=v.length,L=!1;if(!C)return this.resolve([]);for(var I=new Array(C),R=0,F=-1,W=new this(s);++F<C;)B(v[F],F);return W;function B(ne,he){S.resolve(ne).then(function(D){I[he]=D,++R!==C||L||(L=!0,a.resolve(W,I))},function(D){L||(L=!0,a.reject(W,D))})}},m.race=function(v){var S=this;if(Object.prototype.toString.call(v)!=="[object Array]")return this.reject(new TypeError("must be an array"));var C=v.length,L=!1;if(!C)return this.resolve([]);for(var I=-1,R=new this(s);++I<C;)F=v[I],S.resolve(F).then(function(W){L||(L=!0,a.resolve(R,W))},function(W){L||(L=!0,a.reject(R,W))});var F;return R}},{immediate:36}],38:[function(t,r,o){var i={};(0,t("./lib/utils/common").assign)(i,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),r.exports=i},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,r,o){var i=t("./zlib/deflate"),s=t("./utils/common"),a=t("./utils/strings"),l=t("./zlib/messages"),d=t("./zlib/zstream"),u=Object.prototype.toString,m=0,p=-1,f=0,g=8;function b(v){if(!(this instanceof b))return new b(v);this.options=s.assign({level:p,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:f,to:""},v||{});var S=this.options;S.raw&&0<S.windowBits?S.windowBits=-S.windowBits:S.gzip&&0<S.windowBits&&S.windowBits<16&&(S.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new d,this.strm.avail_out=0;var C=i.deflateInit2(this.strm,S.level,S.method,S.windowBits,S.memLevel,S.strategy);if(C!==m)throw new Error(l[C]);if(S.header&&i.deflateSetHeader(this.strm,S.header),S.dictionary){var L;if(L=typeof S.dictionary=="string"?a.string2buf(S.dictionary):u.call(S.dictionary)==="[object ArrayBuffer]"?new Uint8Array(S.dictionary):S.dictionary,(C=i.deflateSetDictionary(this.strm,L))!==m)throw new Error(l[C]);this._dict_set=!0}}function w(v,S){var C=new b(S);if(C.push(v,!0),C.err)throw C.msg||l[C.err];return C.result}b.prototype.push=function(v,S){var C,L,I=this.strm,R=this.options.chunkSize;if(this.ended)return!1;L=S===~~S?S:S===!0?4:0,typeof v=="string"?I.input=a.string2buf(v):u.call(v)==="[object ArrayBuffer]"?I.input=new Uint8Array(v):I.input=v,I.next_in=0,I.avail_in=I.input.length;do{if(I.avail_out===0&&(I.output=new s.Buf8(R),I.next_out=0,I.avail_out=R),(C=i.deflate(I,L))!==1&&C!==m)return this.onEnd(C),!(this.ended=!0);I.avail_out!==0&&(I.avail_in!==0||L!==4&&L!==2)||(this.options.to==="string"?this.onData(a.buf2binstring(s.shrinkBuf(I.output,I.next_out))):this.onData(s.shrinkBuf(I.output,I.next_out)))}while((0<I.avail_in||I.avail_out===0)&&C!==1);return L===4?(C=i.deflateEnd(this.strm),this.onEnd(C),this.ended=!0,C===m):L!==2||(this.onEnd(m),!(I.avail_out=0))},b.prototype.onData=function(v){this.chunks.push(v)},b.prototype.onEnd=function(v){v===m&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=v,this.msg=this.strm.msg},o.Deflate=b,o.deflate=w,o.deflateRaw=function(v,S){return(S=S||{}).raw=!0,w(v,S)},o.gzip=function(v,S){return(S=S||{}).gzip=!0,w(v,S)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,r,o){var i=t("./zlib/inflate"),s=t("./utils/common"),a=t("./utils/strings"),l=t("./zlib/constants"),d=t("./zlib/messages"),u=t("./zlib/zstream"),m=t("./zlib/gzheader"),p=Object.prototype.toString;function f(b){if(!(this instanceof f))return new f(b);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},b||{});var w=this.options;w.raw&&0<=w.windowBits&&w.windowBits<16&&(w.windowBits=-w.windowBits,w.windowBits===0&&(w.windowBits=-15)),!(0<=w.windowBits&&w.windowBits<16)||b&&b.windowBits||(w.windowBits+=32),15<w.windowBits&&w.windowBits<48&&(15&w.windowBits)==0&&(w.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var v=i.inflateInit2(this.strm,w.windowBits);if(v!==l.Z_OK)throw new Error(d[v]);this.header=new m,i.inflateGetHeader(this.strm,this.header)}function g(b,w){var v=new f(w);if(v.push(b,!0),v.err)throw v.msg||d[v.err];return v.result}f.prototype.push=function(b,w){var v,S,C,L,I,R,F=this.strm,W=this.options.chunkSize,B=this.options.dictionary,ne=!1;if(this.ended)return!1;S=w===~~w?w:w===!0?l.Z_FINISH:l.Z_NO_FLUSH,typeof b=="string"?F.input=a.binstring2buf(b):p.call(b)==="[object ArrayBuffer]"?F.input=new Uint8Array(b):F.input=b,F.next_in=0,F.avail_in=F.input.length;do{if(F.avail_out===0&&(F.output=new s.Buf8(W),F.next_out=0,F.avail_out=W),(v=i.inflate(F,l.Z_NO_FLUSH))===l.Z_NEED_DICT&&B&&(R=typeof B=="string"?a.string2buf(B):p.call(B)==="[object ArrayBuffer]"?new Uint8Array(B):B,v=i.inflateSetDictionary(this.strm,R)),v===l.Z_BUF_ERROR&&ne===!0&&(v=l.Z_OK,ne=!1),v!==l.Z_STREAM_END&&v!==l.Z_OK)return this.onEnd(v),!(this.ended=!0);F.next_out&&(F.avail_out!==0&&v!==l.Z_STREAM_END&&(F.avail_in!==0||S!==l.Z_FINISH&&S!==l.Z_SYNC_FLUSH)||(this.options.to==="string"?(C=a.utf8border(F.output,F.next_out),L=F.next_out-C,I=a.buf2string(F.output,C),F.next_out=L,F.avail_out=W-L,L&&s.arraySet(F.output,F.output,C,L,0),this.onData(I)):this.onData(s.shrinkBuf(F.output,F.next_out)))),F.avail_in===0&&F.avail_out===0&&(ne=!0)}while((0<F.avail_in||F.avail_out===0)&&v!==l.Z_STREAM_END);return v===l.Z_STREAM_END&&(S=l.Z_FINISH),S===l.Z_FINISH?(v=i.inflateEnd(this.strm),this.onEnd(v),this.ended=!0,v===l.Z_OK):S!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),!(F.avail_out=0))},f.prototype.onData=function(b){this.chunks.push(b)},f.prototype.onEnd=function(b){b===l.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=b,this.msg=this.strm.msg},o.Inflate=f,o.inflate=g,o.inflateRaw=function(b,w){return(w=w||{}).raw=!0,g(b,w)},o.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,r,o){var i=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";o.assign=function(l){for(var d=Array.prototype.slice.call(arguments,1);d.length;){var u=d.shift();if(u){if(typeof u!="object")throw new TypeError(u+"must be non-object");for(var m in u)u.hasOwnProperty(m)&&(l[m]=u[m])}}return l},o.shrinkBuf=function(l,d){return l.length===d?l:l.subarray?l.subarray(0,d):(l.length=d,l)};var s={arraySet:function(l,d,u,m,p){if(d.subarray&&l.subarray)l.set(d.subarray(u,u+m),p);else for(var f=0;f<m;f++)l[p+f]=d[u+f]},flattenChunks:function(l){var d,u,m,p,f,g;for(d=m=0,u=l.length;d<u;d++)m+=l[d].length;for(g=new Uint8Array(m),d=p=0,u=l.length;d<u;d++)f=l[d],g.set(f,p),p+=f.length;return g}},a={arraySet:function(l,d,u,m,p){for(var f=0;f<m;f++)l[p+f]=d[u+f]},flattenChunks:function(l){return[].concat.apply([],l)}};o.setTyped=function(l){l?(o.Buf8=Uint8Array,o.Buf16=Uint16Array,o.Buf32=Int32Array,o.assign(o,s)):(o.Buf8=Array,o.Buf16=Array,o.Buf32=Array,o.assign(o,a))},o.setTyped(i)},{}],42:[function(t,r,o){var i=t("./common"),s=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch{s=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{a=!1}for(var l=new i.Buf8(256),d=0;d<256;d++)l[d]=252<=d?6:248<=d?5:240<=d?4:224<=d?3:192<=d?2:1;function u(m,p){if(p<65537&&(m.subarray&&a||!m.subarray&&s))return String.fromCharCode.apply(null,i.shrinkBuf(m,p));for(var f="",g=0;g<p;g++)f+=String.fromCharCode(m[g]);return f}l[254]=l[254]=1,o.string2buf=function(m){var p,f,g,b,w,v=m.length,S=0;for(b=0;b<v;b++)(64512&(f=m.charCodeAt(b)))==55296&&b+1<v&&(64512&(g=m.charCodeAt(b+1)))==56320&&(f=65536+(f-55296<<10)+(g-56320),b++),S+=f<128?1:f<2048?2:f<65536?3:4;for(p=new i.Buf8(S),b=w=0;w<S;b++)(64512&(f=m.charCodeAt(b)))==55296&&b+1<v&&(64512&(g=m.charCodeAt(b+1)))==56320&&(f=65536+(f-55296<<10)+(g-56320),b++),f<128?p[w++]=f:(f<2048?p[w++]=192|f>>>6:(f<65536?p[w++]=224|f>>>12:(p[w++]=240|f>>>18,p[w++]=128|f>>>12&63),p[w++]=128|f>>>6&63),p[w++]=128|63&f);return p},o.buf2binstring=function(m){return u(m,m.length)},o.binstring2buf=function(m){for(var p=new i.Buf8(m.length),f=0,g=p.length;f<g;f++)p[f]=m.charCodeAt(f);return p},o.buf2string=function(m,p){var f,g,b,w,v=p||m.length,S=new Array(2*v);for(f=g=0;f<v;)if((b=m[f++])<128)S[g++]=b;else if(4<(w=l[b]))S[g++]=65533,f+=w-1;else{for(b&=w===2?31:w===3?15:7;1<w&&f<v;)b=b<<6|63&m[f++],w--;1<w?S[g++]=65533:b<65536?S[g++]=b:(b-=65536,S[g++]=55296|b>>10&1023,S[g++]=56320|1023&b)}return u(S,g)},o.utf8border=function(m,p){var f;for((p=p||m.length)>m.length&&(p=m.length),f=p-1;0<=f&&(192&m[f])==128;)f--;return f<0||f===0?p:f+l[m[f]]>p?f:p}},{"./common":41}],43:[function(t,r,o){r.exports=function(i,s,a,l){for(var d=65535&i|0,u=i>>>16&65535|0,m=0;a!==0;){for(a-=m=2e3<a?2e3:a;u=u+(d=d+s[l++]|0)|0,--m;);d%=65521,u%=65521}return d|u<<16|0}},{}],44:[function(t,r,o){r.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,r,o){var i=(function(){for(var s,a=[],l=0;l<256;l++){s=l;for(var d=0;d<8;d++)s=1&s?3988292384^s>>>1:s>>>1;a[l]=s}return a})();r.exports=function(s,a,l,d){var u=i,m=d+l;s^=-1;for(var p=d;p<m;p++)s=s>>>8^u[255&(s^a[p])];return-1^s}},{}],46:[function(t,r,o){var i,s=t("../utils/common"),a=t("./trees"),l=t("./adler32"),d=t("./crc32"),u=t("./messages"),m=0,p=4,f=0,g=-2,b=-1,w=4,v=2,S=8,C=9,L=286,I=30,R=19,F=2*L+1,W=15,B=3,ne=258,he=ne+B+1,D=42,G=113,x=1,Y=2,re=3,Z=4;function pe(y,V){return y.msg=u[V],V}function K(y){return(y<<1)-(4<y?9:0)}function be(y){for(var V=y.length;0<=--V;)y[V]=0}function O(y){var V=y.state,z=V.pending;z>y.avail_out&&(z=y.avail_out),z!==0&&(s.arraySet(y.output,V.pending_buf,V.pending_out,z,y.next_out),y.next_out+=z,V.pending_out+=z,y.total_out+=z,y.avail_out-=z,V.pending-=z,V.pending===0&&(V.pending_out=0))}function $(y,V){a._tr_flush_block(y,0<=y.block_start?y.block_start:-1,y.strstart-y.block_start,V),y.block_start=y.strstart,O(y.strm)}function de(y,V){y.pending_buf[y.pending++]=V}function ie(y,V){y.pending_buf[y.pending++]=V>>>8&255,y.pending_buf[y.pending++]=255&V}function ee(y,V){var z,A,T=y.max_chain_length,N=y.strstart,X=y.prev_length,te=y.nice_match,q=y.strstart>y.w_size-he?y.strstart-(y.w_size-he):0,ae=y.window,me=y.w_mask,oe=y.prev,ge=y.strstart+ne,Oe=ae[N+X-1],Ae=ae[N+X];y.prev_length>=y.good_match&&(T>>=2),te>y.lookahead&&(te=y.lookahead);do if(ae[(z=V)+X]===Ae&&ae[z+X-1]===Oe&&ae[z]===ae[N]&&ae[++z]===ae[N+1]){N+=2,z++;do;while(ae[++N]===ae[++z]&&ae[++N]===ae[++z]&&ae[++N]===ae[++z]&&ae[++N]===ae[++z]&&ae[++N]===ae[++z]&&ae[++N]===ae[++z]&&ae[++N]===ae[++z]&&ae[++N]===ae[++z]&&N<ge);if(A=ne-(ge-N),N=ge-ne,X<A){if(y.match_start=V,te<=(X=A))break;Oe=ae[N+X-1],Ae=ae[N+X]}}while((V=oe[V&me])>q&&--T!=0);return X<=y.lookahead?X:y.lookahead}function $e(y){var V,z,A,T,N,X,te,q,ae,me,oe=y.w_size;do{if(T=y.window_size-y.lookahead-y.strstart,y.strstart>=oe+(oe-he)){for(s.arraySet(y.window,y.window,oe,oe,0),y.match_start-=oe,y.strstart-=oe,y.block_start-=oe,V=z=y.hash_size;A=y.head[--V],y.head[V]=oe<=A?A-oe:0,--z;);for(V=z=oe;A=y.prev[--V],y.prev[V]=oe<=A?A-oe:0,--z;);T+=oe}if(y.strm.avail_in===0)break;if(X=y.strm,te=y.window,q=y.strstart+y.lookahead,ae=T,me=void 0,me=X.avail_in,ae<me&&(me=ae),z=me===0?0:(X.avail_in-=me,s.arraySet(te,X.input,X.next_in,me,q),X.state.wrap===1?X.adler=l(X.adler,te,me,q):X.state.wrap===2&&(X.adler=d(X.adler,te,me,q)),X.next_in+=me,X.total_in+=me,me),y.lookahead+=z,y.lookahead+y.insert>=B)for(N=y.strstart-y.insert,y.ins_h=y.window[N],y.ins_h=(y.ins_h<<y.hash_shift^y.window[N+1])&y.hash_mask;y.insert&&(y.ins_h=(y.ins_h<<y.hash_shift^y.window[N+B-1])&y.hash_mask,y.prev[N&y.w_mask]=y.head[y.ins_h],y.head[y.ins_h]=N,N++,y.insert--,!(y.lookahead+y.insert<B)););}while(y.lookahead<he&&y.strm.avail_in!==0)}function Ge(y,V){for(var z,A;;){if(y.lookahead<he){if($e(y),y.lookahead<he&&V===m)return x;if(y.lookahead===0)break}if(z=0,y.lookahead>=B&&(y.ins_h=(y.ins_h<<y.hash_shift^y.window[y.strstart+B-1])&y.hash_mask,z=y.prev[y.strstart&y.w_mask]=y.head[y.ins_h],y.head[y.ins_h]=y.strstart),z!==0&&y.strstart-z<=y.w_size-he&&(y.match_length=ee(y,z)),y.match_length>=B)if(A=a._tr_tally(y,y.strstart-y.match_start,y.match_length-B),y.lookahead-=y.match_length,y.match_length<=y.max_lazy_match&&y.lookahead>=B){for(y.match_length--;y.strstart++,y.ins_h=(y.ins_h<<y.hash_shift^y.window[y.strstart+B-1])&y.hash_mask,z=y.prev[y.strstart&y.w_mask]=y.head[y.ins_h],y.head[y.ins_h]=y.strstart,--y.match_length!=0;);y.strstart++}else y.strstart+=y.match_length,y.match_length=0,y.ins_h=y.window[y.strstart],y.ins_h=(y.ins_h<<y.hash_shift^y.window[y.strstart+1])&y.hash_mask;else A=a._tr_tally(y,0,y.window[y.strstart]),y.lookahead--,y.strstart++;if(A&&($(y,!1),y.strm.avail_out===0))return x}return y.insert=y.strstart<B-1?y.strstart:B-1,V===p?($(y,!0),y.strm.avail_out===0?re:Z):y.last_lit&&($(y,!1),y.strm.avail_out===0)?x:Y}function Ee(y,V){for(var z,A,T;;){if(y.lookahead<he){if($e(y),y.lookahead<he&&V===m)return x;if(y.lookahead===0)break}if(z=0,y.lookahead>=B&&(y.ins_h=(y.ins_h<<y.hash_shift^y.window[y.strstart+B-1])&y.hash_mask,z=y.prev[y.strstart&y.w_mask]=y.head[y.ins_h],y.head[y.ins_h]=y.strstart),y.prev_length=y.match_length,y.prev_match=y.match_start,y.match_length=B-1,z!==0&&y.prev_length<y.max_lazy_match&&y.strstart-z<=y.w_size-he&&(y.match_length=ee(y,z),y.match_length<=5&&(y.strategy===1||y.match_length===B&&4096<y.strstart-y.match_start)&&(y.match_length=B-1)),y.prev_length>=B&&y.match_length<=y.prev_length){for(T=y.strstart+y.lookahead-B,A=a._tr_tally(y,y.strstart-1-y.prev_match,y.prev_length-B),y.lookahead-=y.prev_length-1,y.prev_length-=2;++y.strstart<=T&&(y.ins_h=(y.ins_h<<y.hash_shift^y.window[y.strstart+B-1])&y.hash_mask,z=y.prev[y.strstart&y.w_mask]=y.head[y.ins_h],y.head[y.ins_h]=y.strstart),--y.prev_length!=0;);if(y.match_available=0,y.match_length=B-1,y.strstart++,A&&($(y,!1),y.strm.avail_out===0))return x}else if(y.match_available){if((A=a._tr_tally(y,0,y.window[y.strstart-1]))&&$(y,!1),y.strstart++,y.lookahead--,y.strm.avail_out===0)return x}else y.match_available=1,y.strstart++,y.lookahead--}return y.match_available&&(A=a._tr_tally(y,0,y.window[y.strstart-1]),y.match_available=0),y.insert=y.strstart<B-1?y.strstart:B-1,V===p?($(y,!0),y.strm.avail_out===0?re:Z):y.last_lit&&($(y,!1),y.strm.avail_out===0)?x:Y}function Le(y,V,z,A,T){this.good_length=y,this.max_lazy=V,this.nice_length=z,this.max_chain=A,this.func=T}function Ue(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=S,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(2*F),this.dyn_dtree=new s.Buf16(2*(2*I+1)),this.bl_tree=new s.Buf16(2*(2*R+1)),be(this.dyn_ltree),be(this.dyn_dtree),be(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(W+1),this.heap=new s.Buf16(2*L+1),be(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(2*L+1),be(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Be(y){var V;return y&&y.state?(y.total_in=y.total_out=0,y.data_type=v,(V=y.state).pending=0,V.pending_out=0,V.wrap<0&&(V.wrap=-V.wrap),V.status=V.wrap?D:G,y.adler=V.wrap===2?0:1,V.last_flush=m,a._tr_init(V),f):pe(y,g)}function vt(y){var V=Be(y);return V===f&&(function(z){z.window_size=2*z.w_size,be(z.head),z.max_lazy_match=i[z.level].max_lazy,z.good_match=i[z.level].good_length,z.nice_match=i[z.level].nice_length,z.max_chain_length=i[z.level].max_chain,z.strstart=0,z.block_start=0,z.lookahead=0,z.insert=0,z.match_length=z.prev_length=B-1,z.match_available=0,z.ins_h=0})(y.state),V}function et(y,V,z,A,T,N){if(!y)return g;var X=1;if(V===b&&(V=6),A<0?(X=0,A=-A):15<A&&(X=2,A-=16),T<1||C<T||z!==S||A<8||15<A||V<0||9<V||N<0||w<N)return pe(y,g);A===8&&(A=9);var te=new Ue;return(y.state=te).strm=y,te.wrap=X,te.gzhead=null,te.w_bits=A,te.w_size=1<<te.w_bits,te.w_mask=te.w_size-1,te.hash_bits=T+7,te.hash_size=1<<te.hash_bits,te.hash_mask=te.hash_size-1,te.hash_shift=~~((te.hash_bits+B-1)/B),te.window=new s.Buf8(2*te.w_size),te.head=new s.Buf16(te.hash_size),te.prev=new s.Buf16(te.w_size),te.lit_bufsize=1<<T+6,te.pending_buf_size=4*te.lit_bufsize,te.pending_buf=new s.Buf8(te.pending_buf_size),te.d_buf=1*te.lit_bufsize,te.l_buf=3*te.lit_bufsize,te.level=V,te.strategy=N,te.method=z,vt(y)}i=[new Le(0,0,0,0,function(y,V){var z=65535;for(z>y.pending_buf_size-5&&(z=y.pending_buf_size-5);;){if(y.lookahead<=1){if($e(y),y.lookahead===0&&V===m)return x;if(y.lookahead===0)break}y.strstart+=y.lookahead,y.lookahead=0;var A=y.block_start+z;if((y.strstart===0||y.strstart>=A)&&(y.lookahead=y.strstart-A,y.strstart=A,$(y,!1),y.strm.avail_out===0)||y.strstart-y.block_start>=y.w_size-he&&($(y,!1),y.strm.avail_out===0))return x}return y.insert=0,V===p?($(y,!0),y.strm.avail_out===0?re:Z):(y.strstart>y.block_start&&($(y,!1),y.strm.avail_out),x)}),new Le(4,4,8,4,Ge),new Le(4,5,16,8,Ge),new Le(4,6,32,32,Ge),new Le(4,4,16,16,Ee),new Le(8,16,32,32,Ee),new Le(8,16,128,128,Ee),new Le(8,32,128,256,Ee),new Le(32,128,258,1024,Ee),new Le(32,258,258,4096,Ee)],o.deflateInit=function(y,V){return et(y,V,S,15,8,0)},o.deflateInit2=et,o.deflateReset=vt,o.deflateResetKeep=Be,o.deflateSetHeader=function(y,V){return y&&y.state?y.state.wrap!==2?g:(y.state.gzhead=V,f):g},o.deflate=function(y,V){var z,A,T,N;if(!y||!y.state||5<V||V<0)return y?pe(y,g):g;if(A=y.state,!y.output||!y.input&&y.avail_in!==0||A.status===666&&V!==p)return pe(y,y.avail_out===0?-5:g);if(A.strm=y,z=A.last_flush,A.last_flush=V,A.status===D)if(A.wrap===2)y.adler=0,de(A,31),de(A,139),de(A,8),A.gzhead?(de(A,(A.gzhead.text?1:0)+(A.gzhead.hcrc?2:0)+(A.gzhead.extra?4:0)+(A.gzhead.name?8:0)+(A.gzhead.comment?16:0)),de(A,255&A.gzhead.time),de(A,A.gzhead.time>>8&255),de(A,A.gzhead.time>>16&255),de(A,A.gzhead.time>>24&255),de(A,A.level===9?2:2<=A.strategy||A.level<2?4:0),de(A,255&A.gzhead.os),A.gzhead.extra&&A.gzhead.extra.length&&(de(A,255&A.gzhead.extra.length),de(A,A.gzhead.extra.length>>8&255)),A.gzhead.hcrc&&(y.adler=d(y.adler,A.pending_buf,A.pending,0)),A.gzindex=0,A.status=69):(de(A,0),de(A,0),de(A,0),de(A,0),de(A,0),de(A,A.level===9?2:2<=A.strategy||A.level<2?4:0),de(A,3),A.status=G);else{var X=S+(A.w_bits-8<<4)<<8;X|=(2<=A.strategy||A.level<2?0:A.level<6?1:A.level===6?2:3)<<6,A.strstart!==0&&(X|=32),X+=31-X%31,A.status=G,ie(A,X),A.strstart!==0&&(ie(A,y.adler>>>16),ie(A,65535&y.adler)),y.adler=1}if(A.status===69)if(A.gzhead.extra){for(T=A.pending;A.gzindex<(65535&A.gzhead.extra.length)&&(A.pending!==A.pending_buf_size||(A.gzhead.hcrc&&A.pending>T&&(y.adler=d(y.adler,A.pending_buf,A.pending-T,T)),O(y),T=A.pending,A.pending!==A.pending_buf_size));)de(A,255&A.gzhead.extra[A.gzindex]),A.gzindex++;A.gzhead.hcrc&&A.pending>T&&(y.adler=d(y.adler,A.pending_buf,A.pending-T,T)),A.gzindex===A.gzhead.extra.length&&(A.gzindex=0,A.status=73)}else A.status=73;if(A.status===73)if(A.gzhead.name){T=A.pending;do{if(A.pending===A.pending_buf_size&&(A.gzhead.hcrc&&A.pending>T&&(y.adler=d(y.adler,A.pending_buf,A.pending-T,T)),O(y),T=A.pending,A.pending===A.pending_buf_size)){N=1;break}N=A.gzindex<A.gzhead.name.length?255&A.gzhead.name.charCodeAt(A.gzindex++):0,de(A,N)}while(N!==0);A.gzhead.hcrc&&A.pending>T&&(y.adler=d(y.adler,A.pending_buf,A.pending-T,T)),N===0&&(A.gzindex=0,A.status=91)}else A.status=91;if(A.status===91)if(A.gzhead.comment){T=A.pending;do{if(A.pending===A.pending_buf_size&&(A.gzhead.hcrc&&A.pending>T&&(y.adler=d(y.adler,A.pending_buf,A.pending-T,T)),O(y),T=A.pending,A.pending===A.pending_buf_size)){N=1;break}N=A.gzindex<A.gzhead.comment.length?255&A.gzhead.comment.charCodeAt(A.gzindex++):0,de(A,N)}while(N!==0);A.gzhead.hcrc&&A.pending>T&&(y.adler=d(y.adler,A.pending_buf,A.pending-T,T)),N===0&&(A.status=103)}else A.status=103;if(A.status===103&&(A.gzhead.hcrc?(A.pending+2>A.pending_buf_size&&O(y),A.pending+2<=A.pending_buf_size&&(de(A,255&y.adler),de(A,y.adler>>8&255),y.adler=0,A.status=G)):A.status=G),A.pending!==0){if(O(y),y.avail_out===0)return A.last_flush=-1,f}else if(y.avail_in===0&&K(V)<=K(z)&&V!==p)return pe(y,-5);if(A.status===666&&y.avail_in!==0)return pe(y,-5);if(y.avail_in!==0||A.lookahead!==0||V!==m&&A.status!==666){var te=A.strategy===2?(function(q,ae){for(var me;;){if(q.lookahead===0&&($e(q),q.lookahead===0)){if(ae===m)return x;break}if(q.match_length=0,me=a._tr_tally(q,0,q.window[q.strstart]),q.lookahead--,q.strstart++,me&&($(q,!1),q.strm.avail_out===0))return x}return q.insert=0,ae===p?($(q,!0),q.strm.avail_out===0?re:Z):q.last_lit&&($(q,!1),q.strm.avail_out===0)?x:Y})(A,V):A.strategy===3?(function(q,ae){for(var me,oe,ge,Oe,Ae=q.window;;){if(q.lookahead<=ne){if($e(q),q.lookahead<=ne&&ae===m)return x;if(q.lookahead===0)break}if(q.match_length=0,q.lookahead>=B&&0<q.strstart&&(oe=Ae[ge=q.strstart-1])===Ae[++ge]&&oe===Ae[++ge]&&oe===Ae[++ge]){Oe=q.strstart+ne;do;while(oe===Ae[++ge]&&oe===Ae[++ge]&&oe===Ae[++ge]&&oe===Ae[++ge]&&oe===Ae[++ge]&&oe===Ae[++ge]&&oe===Ae[++ge]&&oe===Ae[++ge]&&ge<Oe);q.match_length=ne-(Oe-ge),q.match_length>q.lookahead&&(q.match_length=q.lookahead)}if(q.match_length>=B?(me=a._tr_tally(q,1,q.match_length-B),q.lookahead-=q.match_length,q.strstart+=q.match_length,q.match_length=0):(me=a._tr_tally(q,0,q.window[q.strstart]),q.lookahead--,q.strstart++),me&&($(q,!1),q.strm.avail_out===0))return x}return q.insert=0,ae===p?($(q,!0),q.strm.avail_out===0?re:Z):q.last_lit&&($(q,!1),q.strm.avail_out===0)?x:Y})(A,V):i[A.level].func(A,V);if(te!==re&&te!==Z||(A.status=666),te===x||te===re)return y.avail_out===0&&(A.last_flush=-1),f;if(te===Y&&(V===1?a._tr_align(A):V!==5&&(a._tr_stored_block(A,0,0,!1),V===3&&(be(A.head),A.lookahead===0&&(A.strstart=0,A.block_start=0,A.insert=0))),O(y),y.avail_out===0))return A.last_flush=-1,f}return V!==p?f:A.wrap<=0?1:(A.wrap===2?(de(A,255&y.adler),de(A,y.adler>>8&255),de(A,y.adler>>16&255),de(A,y.adler>>24&255),de(A,255&y.total_in),de(A,y.total_in>>8&255),de(A,y.total_in>>16&255),de(A,y.total_in>>24&255)):(ie(A,y.adler>>>16),ie(A,65535&y.adler)),O(y),0<A.wrap&&(A.wrap=-A.wrap),A.pending!==0?f:1)},o.deflateEnd=function(y){var V;return y&&y.state?(V=y.state.status)!==D&&V!==69&&V!==73&&V!==91&&V!==103&&V!==G&&V!==666?pe(y,g):(y.state=null,V===G?pe(y,-3):f):g},o.deflateSetDictionary=function(y,V){var z,A,T,N,X,te,q,ae,me=V.length;if(!y||!y.state||(N=(z=y.state).wrap)===2||N===1&&z.status!==D||z.lookahead)return g;for(N===1&&(y.adler=l(y.adler,V,me,0)),z.wrap=0,me>=z.w_size&&(N===0&&(be(z.head),z.strstart=0,z.block_start=0,z.insert=0),ae=new s.Buf8(z.w_size),s.arraySet(ae,V,me-z.w_size,z.w_size,0),V=ae,me=z.w_size),X=y.avail_in,te=y.next_in,q=y.input,y.avail_in=me,y.next_in=0,y.input=V,$e(z);z.lookahead>=B;){for(A=z.strstart,T=z.lookahead-(B-1);z.ins_h=(z.ins_h<<z.hash_shift^z.window[A+B-1])&z.hash_mask,z.prev[A&z.w_mask]=z.head[z.ins_h],z.head[z.ins_h]=A,A++,--T;);z.strstart=A,z.lookahead=B-1,$e(z)}return z.strstart+=z.lookahead,z.block_start=z.strstart,z.insert=z.lookahead,z.lookahead=0,z.match_length=z.prev_length=B-1,z.match_available=0,y.next_in=te,y.input=q,y.avail_in=X,z.wrap=N,f},o.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,r,o){r.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,r,o){r.exports=function(i,s){var a,l,d,u,m,p,f,g,b,w,v,S,C,L,I,R,F,W,B,ne,he,D,G,x,Y;a=i.state,l=i.next_in,x=i.input,d=l+(i.avail_in-5),u=i.next_out,Y=i.output,m=u-(s-i.avail_out),p=u+(i.avail_out-257),f=a.dmax,g=a.wsize,b=a.whave,w=a.wnext,v=a.window,S=a.hold,C=a.bits,L=a.lencode,I=a.distcode,R=(1<<a.lenbits)-1,F=(1<<a.distbits)-1;e:do{C<15&&(S+=x[l++]<<C,C+=8,S+=x[l++]<<C,C+=8),W=L[S&R];t:for(;;){if(S>>>=B=W>>>24,C-=B,(B=W>>>16&255)===0)Y[u++]=65535&W;else{if(!(16&B)){if((64&B)==0){W=L[(65535&W)+(S&(1<<B)-1)];continue t}if(32&B){a.mode=12;break e}i.msg="invalid literal/length code",a.mode=30;break e}ne=65535&W,(B&=15)&&(C<B&&(S+=x[l++]<<C,C+=8),ne+=S&(1<<B)-1,S>>>=B,C-=B),C<15&&(S+=x[l++]<<C,C+=8,S+=x[l++]<<C,C+=8),W=I[S&F];n:for(;;){if(S>>>=B=W>>>24,C-=B,!(16&(B=W>>>16&255))){if((64&B)==0){W=I[(65535&W)+(S&(1<<B)-1)];continue n}i.msg="invalid distance code",a.mode=30;break e}if(he=65535&W,C<(B&=15)&&(S+=x[l++]<<C,(C+=8)<B&&(S+=x[l++]<<C,C+=8)),f<(he+=S&(1<<B)-1)){i.msg="invalid distance too far back",a.mode=30;break e}if(S>>>=B,C-=B,(B=u-m)<he){if(b<(B=he-B)&&a.sane){i.msg="invalid distance too far back",a.mode=30;break e}if(G=v,(D=0)===w){if(D+=g-B,B<ne){for(ne-=B;Y[u++]=v[D++],--B;);D=u-he,G=Y}}else if(w<B){if(D+=g+w-B,(B-=w)<ne){for(ne-=B;Y[u++]=v[D++],--B;);if(D=0,w<ne){for(ne-=B=w;Y[u++]=v[D++],--B;);D=u-he,G=Y}}}else if(D+=w-B,B<ne){for(ne-=B;Y[u++]=v[D++],--B;);D=u-he,G=Y}for(;2<ne;)Y[u++]=G[D++],Y[u++]=G[D++],Y[u++]=G[D++],ne-=3;ne&&(Y[u++]=G[D++],1<ne&&(Y[u++]=G[D++]))}else{for(D=u-he;Y[u++]=Y[D++],Y[u++]=Y[D++],Y[u++]=Y[D++],2<(ne-=3););ne&&(Y[u++]=Y[D++],1<ne&&(Y[u++]=Y[D++]))}break}}break}}while(l<d&&u<p);l-=ne=C>>3,S&=(1<<(C-=ne<<3))-1,i.next_in=l,i.next_out=u,i.avail_in=l<d?d-l+5:5-(l-d),i.avail_out=u<p?p-u+257:257-(u-p),a.hold=S,a.bits=C}},{}],49:[function(t,r,o){var i=t("../utils/common"),s=t("./adler32"),a=t("./crc32"),l=t("./inffast"),d=t("./inftrees"),u=1,m=2,p=0,f=-2,g=1,b=852,w=592;function v(D){return(D>>>24&255)+(D>>>8&65280)+((65280&D)<<8)+((255&D)<<24)}function S(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new i.Buf16(320),this.work=new i.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function C(D){var G;return D&&D.state?(G=D.state,D.total_in=D.total_out=G.total=0,D.msg="",G.wrap&&(D.adler=1&G.wrap),G.mode=g,G.last=0,G.havedict=0,G.dmax=32768,G.head=null,G.hold=0,G.bits=0,G.lencode=G.lendyn=new i.Buf32(b),G.distcode=G.distdyn=new i.Buf32(w),G.sane=1,G.back=-1,p):f}function L(D){var G;return D&&D.state?((G=D.state).wsize=0,G.whave=0,G.wnext=0,C(D)):f}function I(D,G){var x,Y;return D&&D.state?(Y=D.state,G<0?(x=0,G=-G):(x=1+(G>>4),G<48&&(G&=15)),G&&(G<8||15<G)?f:(Y.window!==null&&Y.wbits!==G&&(Y.window=null),Y.wrap=x,Y.wbits=G,L(D))):f}function R(D,G){var x,Y;return D?(Y=new S,(D.state=Y).window=null,(x=I(D,G))!==p&&(D.state=null),x):f}var F,W,B=!0;function ne(D){if(B){var G;for(F=new i.Buf32(512),W=new i.Buf32(32),G=0;G<144;)D.lens[G++]=8;for(;G<256;)D.lens[G++]=9;for(;G<280;)D.lens[G++]=7;for(;G<288;)D.lens[G++]=8;for(d(u,D.lens,0,288,F,0,D.work,{bits:9}),G=0;G<32;)D.lens[G++]=5;d(m,D.lens,0,32,W,0,D.work,{bits:5}),B=!1}D.lencode=F,D.lenbits=9,D.distcode=W,D.distbits=5}function he(D,G,x,Y){var re,Z=D.state;return Z.window===null&&(Z.wsize=1<<Z.wbits,Z.wnext=0,Z.whave=0,Z.window=new i.Buf8(Z.wsize)),Y>=Z.wsize?(i.arraySet(Z.window,G,x-Z.wsize,Z.wsize,0),Z.wnext=0,Z.whave=Z.wsize):(Y<(re=Z.wsize-Z.wnext)&&(re=Y),i.arraySet(Z.window,G,x-Y,re,Z.wnext),(Y-=re)?(i.arraySet(Z.window,G,x-Y,Y,0),Z.wnext=Y,Z.whave=Z.wsize):(Z.wnext+=re,Z.wnext===Z.wsize&&(Z.wnext=0),Z.whave<Z.wsize&&(Z.whave+=re))),0}o.inflateReset=L,o.inflateReset2=I,o.inflateResetKeep=C,o.inflateInit=function(D){return R(D,15)},o.inflateInit2=R,o.inflate=function(D,G){var x,Y,re,Z,pe,K,be,O,$,de,ie,ee,$e,Ge,Ee,Le,Ue,Be,vt,et,y,V,z,A,T=0,N=new i.Buf8(4),X=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!D||!D.state||!D.output||!D.input&&D.avail_in!==0)return f;(x=D.state).mode===12&&(x.mode=13),pe=D.next_out,re=D.output,be=D.avail_out,Z=D.next_in,Y=D.input,K=D.avail_in,O=x.hold,$=x.bits,de=K,ie=be,V=p;e:for(;;)switch(x.mode){case g:if(x.wrap===0){x.mode=13;break}for(;$<16;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(2&x.wrap&&O===35615){N[x.check=0]=255&O,N[1]=O>>>8&255,x.check=a(x.check,N,2,0),$=O=0,x.mode=2;break}if(x.flags=0,x.head&&(x.head.done=!1),!(1&x.wrap)||(((255&O)<<8)+(O>>8))%31){D.msg="incorrect header check",x.mode=30;break}if((15&O)!=8){D.msg="unknown compression method",x.mode=30;break}if($-=4,y=8+(15&(O>>>=4)),x.wbits===0)x.wbits=y;else if(y>x.wbits){D.msg="invalid window size",x.mode=30;break}x.dmax=1<<y,D.adler=x.check=1,x.mode=512&O?10:12,$=O=0;break;case 2:for(;$<16;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(x.flags=O,(255&x.flags)!=8){D.msg="unknown compression method",x.mode=30;break}if(57344&x.flags){D.msg="unknown header flags set",x.mode=30;break}x.head&&(x.head.text=O>>8&1),512&x.flags&&(N[0]=255&O,N[1]=O>>>8&255,x.check=a(x.check,N,2,0)),$=O=0,x.mode=3;case 3:for(;$<32;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}x.head&&(x.head.time=O),512&x.flags&&(N[0]=255&O,N[1]=O>>>8&255,N[2]=O>>>16&255,N[3]=O>>>24&255,x.check=a(x.check,N,4,0)),$=O=0,x.mode=4;case 4:for(;$<16;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}x.head&&(x.head.xflags=255&O,x.head.os=O>>8),512&x.flags&&(N[0]=255&O,N[1]=O>>>8&255,x.check=a(x.check,N,2,0)),$=O=0,x.mode=5;case 5:if(1024&x.flags){for(;$<16;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}x.length=O,x.head&&(x.head.extra_len=O),512&x.flags&&(N[0]=255&O,N[1]=O>>>8&255,x.check=a(x.check,N,2,0)),$=O=0}else x.head&&(x.head.extra=null);x.mode=6;case 6:if(1024&x.flags&&(K<(ee=x.length)&&(ee=K),ee&&(x.head&&(y=x.head.extra_len-x.length,x.head.extra||(x.head.extra=new Array(x.head.extra_len)),i.arraySet(x.head.extra,Y,Z,ee,y)),512&x.flags&&(x.check=a(x.check,Y,ee,Z)),K-=ee,Z+=ee,x.length-=ee),x.length))break e;x.length=0,x.mode=7;case 7:if(2048&x.flags){if(K===0)break e;for(ee=0;y=Y[Z+ee++],x.head&&y&&x.length<65536&&(x.head.name+=String.fromCharCode(y)),y&&ee<K;);if(512&x.flags&&(x.check=a(x.check,Y,ee,Z)),K-=ee,Z+=ee,y)break e}else x.head&&(x.head.name=null);x.length=0,x.mode=8;case 8:if(4096&x.flags){if(K===0)break e;for(ee=0;y=Y[Z+ee++],x.head&&y&&x.length<65536&&(x.head.comment+=String.fromCharCode(y)),y&&ee<K;);if(512&x.flags&&(x.check=a(x.check,Y,ee,Z)),K-=ee,Z+=ee,y)break e}else x.head&&(x.head.comment=null);x.mode=9;case 9:if(512&x.flags){for(;$<16;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(O!==(65535&x.check)){D.msg="header crc mismatch",x.mode=30;break}$=O=0}x.head&&(x.head.hcrc=x.flags>>9&1,x.head.done=!0),D.adler=x.check=0,x.mode=12;break;case 10:for(;$<32;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}D.adler=x.check=v(O),$=O=0,x.mode=11;case 11:if(x.havedict===0)return D.next_out=pe,D.avail_out=be,D.next_in=Z,D.avail_in=K,x.hold=O,x.bits=$,2;D.adler=x.check=1,x.mode=12;case 12:if(G===5||G===6)break e;case 13:if(x.last){O>>>=7&$,$-=7&$,x.mode=27;break}for(;$<3;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}switch(x.last=1&O,$-=1,3&(O>>>=1)){case 0:x.mode=14;break;case 1:if(ne(x),x.mode=20,G!==6)break;O>>>=2,$-=2;break e;case 2:x.mode=17;break;case 3:D.msg="invalid block type",x.mode=30}O>>>=2,$-=2;break;case 14:for(O>>>=7&$,$-=7&$;$<32;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if((65535&O)!=(O>>>16^65535)){D.msg="invalid stored block lengths",x.mode=30;break}if(x.length=65535&O,$=O=0,x.mode=15,G===6)break e;case 15:x.mode=16;case 16:if(ee=x.length){if(K<ee&&(ee=K),be<ee&&(ee=be),ee===0)break e;i.arraySet(re,Y,Z,ee,pe),K-=ee,Z+=ee,be-=ee,pe+=ee,x.length-=ee;break}x.mode=12;break;case 17:for(;$<14;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(x.nlen=257+(31&O),O>>>=5,$-=5,x.ndist=1+(31&O),O>>>=5,$-=5,x.ncode=4+(15&O),O>>>=4,$-=4,286<x.nlen||30<x.ndist){D.msg="too many length or distance symbols",x.mode=30;break}x.have=0,x.mode=18;case 18:for(;x.have<x.ncode;){for(;$<3;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}x.lens[X[x.have++]]=7&O,O>>>=3,$-=3}for(;x.have<19;)x.lens[X[x.have++]]=0;if(x.lencode=x.lendyn,x.lenbits=7,z={bits:x.lenbits},V=d(0,x.lens,0,19,x.lencode,0,x.work,z),x.lenbits=z.bits,V){D.msg="invalid code lengths set",x.mode=30;break}x.have=0,x.mode=19;case 19:for(;x.have<x.nlen+x.ndist;){for(;Le=(T=x.lencode[O&(1<<x.lenbits)-1])>>>16&255,Ue=65535&T,!((Ee=T>>>24)<=$);){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(Ue<16)O>>>=Ee,$-=Ee,x.lens[x.have++]=Ue;else{if(Ue===16){for(A=Ee+2;$<A;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(O>>>=Ee,$-=Ee,x.have===0){D.msg="invalid bit length repeat",x.mode=30;break}y=x.lens[x.have-1],ee=3+(3&O),O>>>=2,$-=2}else if(Ue===17){for(A=Ee+3;$<A;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}$-=Ee,y=0,ee=3+(7&(O>>>=Ee)),O>>>=3,$-=3}else{for(A=Ee+7;$<A;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}$-=Ee,y=0,ee=11+(127&(O>>>=Ee)),O>>>=7,$-=7}if(x.have+ee>x.nlen+x.ndist){D.msg="invalid bit length repeat",x.mode=30;break}for(;ee--;)x.lens[x.have++]=y}}if(x.mode===30)break;if(x.lens[256]===0){D.msg="invalid code -- missing end-of-block",x.mode=30;break}if(x.lenbits=9,z={bits:x.lenbits},V=d(u,x.lens,0,x.nlen,x.lencode,0,x.work,z),x.lenbits=z.bits,V){D.msg="invalid literal/lengths set",x.mode=30;break}if(x.distbits=6,x.distcode=x.distdyn,z={bits:x.distbits},V=d(m,x.lens,x.nlen,x.ndist,x.distcode,0,x.work,z),x.distbits=z.bits,V){D.msg="invalid distances set",x.mode=30;break}if(x.mode=20,G===6)break e;case 20:x.mode=21;case 21:if(6<=K&&258<=be){D.next_out=pe,D.avail_out=be,D.next_in=Z,D.avail_in=K,x.hold=O,x.bits=$,l(D,ie),pe=D.next_out,re=D.output,be=D.avail_out,Z=D.next_in,Y=D.input,K=D.avail_in,O=x.hold,$=x.bits,x.mode===12&&(x.back=-1);break}for(x.back=0;Le=(T=x.lencode[O&(1<<x.lenbits)-1])>>>16&255,Ue=65535&T,!((Ee=T>>>24)<=$);){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(Le&&(240&Le)==0){for(Be=Ee,vt=Le,et=Ue;Le=(T=x.lencode[et+((O&(1<<Be+vt)-1)>>Be)])>>>16&255,Ue=65535&T,!(Be+(Ee=T>>>24)<=$);){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}O>>>=Be,$-=Be,x.back+=Be}if(O>>>=Ee,$-=Ee,x.back+=Ee,x.length=Ue,Le===0){x.mode=26;break}if(32&Le){x.back=-1,x.mode=12;break}if(64&Le){D.msg="invalid literal/length code",x.mode=30;break}x.extra=15&Le,x.mode=22;case 22:if(x.extra){for(A=x.extra;$<A;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}x.length+=O&(1<<x.extra)-1,O>>>=x.extra,$-=x.extra,x.back+=x.extra}x.was=x.length,x.mode=23;case 23:for(;Le=(T=x.distcode[O&(1<<x.distbits)-1])>>>16&255,Ue=65535&T,!((Ee=T>>>24)<=$);){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if((240&Le)==0){for(Be=Ee,vt=Le,et=Ue;Le=(T=x.distcode[et+((O&(1<<Be+vt)-1)>>Be)])>>>16&255,Ue=65535&T,!(Be+(Ee=T>>>24)<=$);){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}O>>>=Be,$-=Be,x.back+=Be}if(O>>>=Ee,$-=Ee,x.back+=Ee,64&Le){D.msg="invalid distance code",x.mode=30;break}x.offset=Ue,x.extra=15&Le,x.mode=24;case 24:if(x.extra){for(A=x.extra;$<A;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}x.offset+=O&(1<<x.extra)-1,O>>>=x.extra,$-=x.extra,x.back+=x.extra}if(x.offset>x.dmax){D.msg="invalid distance too far back",x.mode=30;break}x.mode=25;case 25:if(be===0)break e;if(ee=ie-be,x.offset>ee){if((ee=x.offset-ee)>x.whave&&x.sane){D.msg="invalid distance too far back",x.mode=30;break}$e=ee>x.wnext?(ee-=x.wnext,x.wsize-ee):x.wnext-ee,ee>x.length&&(ee=x.length),Ge=x.window}else Ge=re,$e=pe-x.offset,ee=x.length;for(be<ee&&(ee=be),be-=ee,x.length-=ee;re[pe++]=Ge[$e++],--ee;);x.length===0&&(x.mode=21);break;case 26:if(be===0)break e;re[pe++]=x.length,be--,x.mode=21;break;case 27:if(x.wrap){for(;$<32;){if(K===0)break e;K--,O|=Y[Z++]<<$,$+=8}if(ie-=be,D.total_out+=ie,x.total+=ie,ie&&(D.adler=x.check=x.flags?a(x.check,re,ie,pe-ie):s(x.check,re,ie,pe-ie)),ie=be,(x.flags?O:v(O))!==x.check){D.msg="incorrect data check",x.mode=30;break}$=O=0}x.mode=28;case 28:if(x.wrap&&x.flags){for(;$<32;){if(K===0)break e;K--,O+=Y[Z++]<<$,$+=8}if(O!==(4294967295&x.total)){D.msg="incorrect length check",x.mode=30;break}$=O=0}x.mode=29;case 29:V=1;break e;case 30:V=-3;break e;case 31:return-4;case 32:default:return f}return D.next_out=pe,D.avail_out=be,D.next_in=Z,D.avail_in=K,x.hold=O,x.bits=$,(x.wsize||ie!==D.avail_out&&x.mode<30&&(x.mode<27||G!==4))&&he(D,D.output,D.next_out,ie-D.avail_out)?(x.mode=31,-4):(de-=D.avail_in,ie-=D.avail_out,D.total_in+=de,D.total_out+=ie,x.total+=ie,x.wrap&&ie&&(D.adler=x.check=x.flags?a(x.check,re,ie,D.next_out-ie):s(x.check,re,ie,D.next_out-ie)),D.data_type=x.bits+(x.last?64:0)+(x.mode===12?128:0)+(x.mode===20||x.mode===15?256:0),(de==0&&ie===0||G===4)&&V===p&&(V=-5),V)},o.inflateEnd=function(D){if(!D||!D.state)return f;var G=D.state;return G.window&&(G.window=null),D.state=null,p},o.inflateGetHeader=function(D,G){var x;return D&&D.state?(2&(x=D.state).wrap)==0?f:((x.head=G).done=!1,p):f},o.inflateSetDictionary=function(D,G){var x,Y=G.length;return D&&D.state?(x=D.state).wrap!==0&&x.mode!==11?f:x.mode===11&&s(1,G,Y,0)!==x.check?-3:he(D,G,Y,Y)?(x.mode=31,-4):(x.havedict=1,p):f},o.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,r,o){var i=t("../utils/common"),s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],d=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];r.exports=function(u,m,p,f,g,b,w,v){var S,C,L,I,R,F,W,B,ne,he=v.bits,D=0,G=0,x=0,Y=0,re=0,Z=0,pe=0,K=0,be=0,O=0,$=null,de=0,ie=new i.Buf16(16),ee=new i.Buf16(16),$e=null,Ge=0;for(D=0;D<=15;D++)ie[D]=0;for(G=0;G<f;G++)ie[m[p+G]]++;for(re=he,Y=15;1<=Y&&ie[Y]===0;Y--);if(Y<re&&(re=Y),Y===0)return g[b++]=20971520,g[b++]=20971520,v.bits=1,0;for(x=1;x<Y&&ie[x]===0;x++);for(re<x&&(re=x),D=K=1;D<=15;D++)if(K<<=1,(K-=ie[D])<0)return-1;if(0<K&&(u===0||Y!==1))return-1;for(ee[1]=0,D=1;D<15;D++)ee[D+1]=ee[D]+ie[D];for(G=0;G<f;G++)m[p+G]!==0&&(w[ee[m[p+G]]++]=G);if(F=u===0?($=$e=w,19):u===1?($=s,de-=257,$e=a,Ge-=257,256):($=l,$e=d,-1),D=x,R=b,pe=G=O=0,L=-1,I=(be=1<<(Z=re))-1,u===1&&852<be||u===2&&592<be)return 1;for(;;){for(W=D-pe,ne=w[G]<F?(B=0,w[G]):w[G]>F?(B=$e[Ge+w[G]],$[de+w[G]]):(B=96,0),S=1<<D-pe,x=C=1<<Z;g[R+(O>>pe)+(C-=S)]=W<<24|B<<16|ne|0,C!==0;);for(S=1<<D-1;O&S;)S>>=1;if(S!==0?(O&=S-1,O+=S):O=0,G++,--ie[D]==0){if(D===Y)break;D=m[p+w[G]]}if(re<D&&(O&I)!==L){for(pe===0&&(pe=re),R+=x,K=1<<(Z=D-pe);Z+pe<Y&&!((K-=ie[Z+pe])<=0);)Z++,K<<=1;if(be+=1<<Z,u===1&&852<be||u===2&&592<be)return 1;g[L=O&I]=re<<24|Z<<16|R-b|0}}return O!==0&&(g[R+O]=D-pe<<24|64<<16|0),v.bits=re,0}},{"../utils/common":41}],51:[function(t,r,o){r.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,r,o){var i=t("../utils/common"),s=0,a=1;function l(T){for(var N=T.length;0<=--N;)T[N]=0}var d=0,u=29,m=256,p=m+1+u,f=30,g=19,b=2*p+1,w=15,v=16,S=7,C=256,L=16,I=17,R=18,F=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],W=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],B=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],ne=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],he=new Array(2*(p+2));l(he);var D=new Array(2*f);l(D);var G=new Array(512);l(G);var x=new Array(256);l(x);var Y=new Array(u);l(Y);var re,Z,pe,K=new Array(f);function be(T,N,X,te,q){this.static_tree=T,this.extra_bits=N,this.extra_base=X,this.elems=te,this.max_length=q,this.has_stree=T&&T.length}function O(T,N){this.dyn_tree=T,this.max_code=0,this.stat_desc=N}function $(T){return T<256?G[T]:G[256+(T>>>7)]}function de(T,N){T.pending_buf[T.pending++]=255&N,T.pending_buf[T.pending++]=N>>>8&255}function ie(T,N,X){T.bi_valid>v-X?(T.bi_buf|=N<<T.bi_valid&65535,de(T,T.bi_buf),T.bi_buf=N>>v-T.bi_valid,T.bi_valid+=X-v):(T.bi_buf|=N<<T.bi_valid&65535,T.bi_valid+=X)}function ee(T,N,X){ie(T,X[2*N],X[2*N+1])}function $e(T,N){for(var X=0;X|=1&T,T>>>=1,X<<=1,0<--N;);return X>>>1}function Ge(T,N,X){var te,q,ae=new Array(w+1),me=0;for(te=1;te<=w;te++)ae[te]=me=me+X[te-1]<<1;for(q=0;q<=N;q++){var oe=T[2*q+1];oe!==0&&(T[2*q]=$e(ae[oe]++,oe))}}function Ee(T){var N;for(N=0;N<p;N++)T.dyn_ltree[2*N]=0;for(N=0;N<f;N++)T.dyn_dtree[2*N]=0;for(N=0;N<g;N++)T.bl_tree[2*N]=0;T.dyn_ltree[2*C]=1,T.opt_len=T.static_len=0,T.last_lit=T.matches=0}function Le(T){8<T.bi_valid?de(T,T.bi_buf):0<T.bi_valid&&(T.pending_buf[T.pending++]=T.bi_buf),T.bi_buf=0,T.bi_valid=0}function Ue(T,N,X,te){var q=2*N,ae=2*X;return T[q]<T[ae]||T[q]===T[ae]&&te[N]<=te[X]}function Be(T,N,X){for(var te=T.heap[X],q=X<<1;q<=T.heap_len&&(q<T.heap_len&&Ue(N,T.heap[q+1],T.heap[q],T.depth)&&q++,!Ue(N,te,T.heap[q],T.depth));)T.heap[X]=T.heap[q],X=q,q<<=1;T.heap[X]=te}function vt(T,N,X){var te,q,ae,me,oe=0;if(T.last_lit!==0)for(;te=T.pending_buf[T.d_buf+2*oe]<<8|T.pending_buf[T.d_buf+2*oe+1],q=T.pending_buf[T.l_buf+oe],oe++,te===0?ee(T,q,N):(ee(T,(ae=x[q])+m+1,N),(me=F[ae])!==0&&ie(T,q-=Y[ae],me),ee(T,ae=$(--te),X),(me=W[ae])!==0&&ie(T,te-=K[ae],me)),oe<T.last_lit;);ee(T,C,N)}function et(T,N){var X,te,q,ae=N.dyn_tree,me=N.stat_desc.static_tree,oe=N.stat_desc.has_stree,ge=N.stat_desc.elems,Oe=-1;for(T.heap_len=0,T.heap_max=b,X=0;X<ge;X++)ae[2*X]!==0?(T.heap[++T.heap_len]=Oe=X,T.depth[X]=0):ae[2*X+1]=0;for(;T.heap_len<2;)ae[2*(q=T.heap[++T.heap_len]=Oe<2?++Oe:0)]=1,T.depth[q]=0,T.opt_len--,oe&&(T.static_len-=me[2*q+1]);for(N.max_code=Oe,X=T.heap_len>>1;1<=X;X--)Be(T,ae,X);for(q=ge;X=T.heap[1],T.heap[1]=T.heap[T.heap_len--],Be(T,ae,1),te=T.heap[1],T.heap[--T.heap_max]=X,T.heap[--T.heap_max]=te,ae[2*q]=ae[2*X]+ae[2*te],T.depth[q]=(T.depth[X]>=T.depth[te]?T.depth[X]:T.depth[te])+1,ae[2*X+1]=ae[2*te+1]=q,T.heap[1]=q++,Be(T,ae,1),2<=T.heap_len;);T.heap[--T.heap_max]=T.heap[1],(function(Ae,mt){var Yt,nt,Kt,He,j,se,ye=mt.dyn_tree,Se=mt.max_code,we=mt.stat_desc.static_tree,je=mt.stat_desc.has_stree,Te=mt.stat_desc.extra_bits,Re=mt.stat_desc.extra_base,Pe=mt.stat_desc.max_length,We=0;for(He=0;He<=w;He++)Ae.bl_count[He]=0;for(ye[2*Ae.heap[Ae.heap_max]+1]=0,Yt=Ae.heap_max+1;Yt<b;Yt++)Pe<(He=ye[2*ye[2*(nt=Ae.heap[Yt])+1]+1]+1)&&(He=Pe,We++),ye[2*nt+1]=He,Se<nt||(Ae.bl_count[He]++,j=0,Re<=nt&&(j=Te[nt-Re]),se=ye[2*nt],Ae.opt_len+=se*(He+j),je&&(Ae.static_len+=se*(we[2*nt+1]+j)));if(We!==0){do{for(He=Pe-1;Ae.bl_count[He]===0;)He--;Ae.bl_count[He]--,Ae.bl_count[He+1]+=2,Ae.bl_count[Pe]--,We-=2}while(0<We);for(He=Pe;He!==0;He--)for(nt=Ae.bl_count[He];nt!==0;)Se<(Kt=Ae.heap[--Yt])||(ye[2*Kt+1]!==He&&(Ae.opt_len+=(He-ye[2*Kt+1])*ye[2*Kt],ye[2*Kt+1]=He),nt--)}})(T,N),Ge(ae,Oe,T.bl_count)}function y(T,N,X){var te,q,ae=-1,me=N[1],oe=0,ge=7,Oe=4;for(me===0&&(ge=138,Oe=3),N[2*(X+1)+1]=65535,te=0;te<=X;te++)q=me,me=N[2*(te+1)+1],++oe<ge&&q===me||(oe<Oe?T.bl_tree[2*q]+=oe:q!==0?(q!==ae&&T.bl_tree[2*q]++,T.bl_tree[2*L]++):oe<=10?T.bl_tree[2*I]++:T.bl_tree[2*R]++,ae=q,Oe=(oe=0)===me?(ge=138,3):q===me?(ge=6,3):(ge=7,4))}function V(T,N,X){var te,q,ae=-1,me=N[1],oe=0,ge=7,Oe=4;for(me===0&&(ge=138,Oe=3),te=0;te<=X;te++)if(q=me,me=N[2*(te+1)+1],!(++oe<ge&&q===me)){if(oe<Oe)for(;ee(T,q,T.bl_tree),--oe!=0;);else q!==0?(q!==ae&&(ee(T,q,T.bl_tree),oe--),ee(T,L,T.bl_tree),ie(T,oe-3,2)):oe<=10?(ee(T,I,T.bl_tree),ie(T,oe-3,3)):(ee(T,R,T.bl_tree),ie(T,oe-11,7));ae=q,Oe=(oe=0)===me?(ge=138,3):q===me?(ge=6,3):(ge=7,4)}}l(K);var z=!1;function A(T,N,X,te){ie(T,(d<<1)+(te?1:0),3),(function(q,ae,me,oe){Le(q),de(q,me),de(q,~me),i.arraySet(q.pending_buf,q.window,ae,me,q.pending),q.pending+=me})(T,N,X)}o._tr_init=function(T){z||((function(){var N,X,te,q,ae,me=new Array(w+1);for(q=te=0;q<u-1;q++)for(Y[q]=te,N=0;N<1<<F[q];N++)x[te++]=q;for(x[te-1]=q,q=ae=0;q<16;q++)for(K[q]=ae,N=0;N<1<<W[q];N++)G[ae++]=q;for(ae>>=7;q<f;q++)for(K[q]=ae<<7,N=0;N<1<<W[q]-7;N++)G[256+ae++]=q;for(X=0;X<=w;X++)me[X]=0;for(N=0;N<=143;)he[2*N+1]=8,N++,me[8]++;for(;N<=255;)he[2*N+1]=9,N++,me[9]++;for(;N<=279;)he[2*N+1]=7,N++,me[7]++;for(;N<=287;)he[2*N+1]=8,N++,me[8]++;for(Ge(he,p+1,me),N=0;N<f;N++)D[2*N+1]=5,D[2*N]=$e(N,5);re=new be(he,F,m+1,p,w),Z=new be(D,W,0,f,w),pe=new be(new Array(0),B,0,g,S)})(),z=!0),T.l_desc=new O(T.dyn_ltree,re),T.d_desc=new O(T.dyn_dtree,Z),T.bl_desc=new O(T.bl_tree,pe),T.bi_buf=0,T.bi_valid=0,Ee(T)},o._tr_stored_block=A,o._tr_flush_block=function(T,N,X,te){var q,ae,me=0;0<T.level?(T.strm.data_type===2&&(T.strm.data_type=(function(oe){var ge,Oe=4093624447;for(ge=0;ge<=31;ge++,Oe>>>=1)if(1&Oe&&oe.dyn_ltree[2*ge]!==0)return s;if(oe.dyn_ltree[18]!==0||oe.dyn_ltree[20]!==0||oe.dyn_ltree[26]!==0)return a;for(ge=32;ge<m;ge++)if(oe.dyn_ltree[2*ge]!==0)return a;return s})(T)),et(T,T.l_desc),et(T,T.d_desc),me=(function(oe){var ge;for(y(oe,oe.dyn_ltree,oe.l_desc.max_code),y(oe,oe.dyn_dtree,oe.d_desc.max_code),et(oe,oe.bl_desc),ge=g-1;3<=ge&&oe.bl_tree[2*ne[ge]+1]===0;ge--);return oe.opt_len+=3*(ge+1)+5+5+4,ge})(T),q=T.opt_len+3+7>>>3,(ae=T.static_len+3+7>>>3)<=q&&(q=ae)):q=ae=X+5,X+4<=q&&N!==-1?A(T,N,X,te):T.strategy===4||ae===q?(ie(T,2+(te?1:0),3),vt(T,he,D)):(ie(T,4+(te?1:0),3),(function(oe,ge,Oe,Ae){var mt;for(ie(oe,ge-257,5),ie(oe,Oe-1,5),ie(oe,Ae-4,4),mt=0;mt<Ae;mt++)ie(oe,oe.bl_tree[2*ne[mt]+1],3);V(oe,oe.dyn_ltree,ge-1),V(oe,oe.dyn_dtree,Oe-1)})(T,T.l_desc.max_code+1,T.d_desc.max_code+1,me+1),vt(T,T.dyn_ltree,T.dyn_dtree)),Ee(T),te&&Le(T)},o._tr_tally=function(T,N,X){return T.pending_buf[T.d_buf+2*T.last_lit]=N>>>8&255,T.pending_buf[T.d_buf+2*T.last_lit+1]=255&N,T.pending_buf[T.l_buf+T.last_lit]=255&X,T.last_lit++,N===0?T.dyn_ltree[2*X]++:(T.matches++,N--,T.dyn_ltree[2*(x[X]+m+1)]++,T.dyn_dtree[2*$(N)]++),T.last_lit===T.lit_bufsize-1},o._tr_align=function(T){ie(T,2,3),ee(T,C,he),(function(N){N.bi_valid===16?(de(N,N.bi_buf),N.bi_buf=0,N.bi_valid=0):8<=N.bi_valid&&(N.pending_buf[N.pending++]=255&N.bi_buf,N.bi_buf>>=8,N.bi_valid-=8)})(T)}},{"../utils/common":41}],53:[function(t,r,o){r.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,r,o){(function(i){(function(s,a){if(!s.setImmediate){var l,d,u,m,p=1,f={},g=!1,b=s.document,w=Object.getPrototypeOf&&Object.getPrototypeOf(s);w=w&&w.setTimeout?w:s,l={}.toString.call(s.process)==="[object process]"?function(L){process.nextTick(function(){S(L)})}:(function(){if(s.postMessage&&!s.importScripts){var L=!0,I=s.onmessage;return s.onmessage=function(){L=!1},s.postMessage("","*"),s.onmessage=I,L}})()?(m="setImmediate$"+Math.random()+"$",s.addEventListener?s.addEventListener("message",C,!1):s.attachEvent("onmessage",C),function(L){s.postMessage(m+L,"*")}):s.MessageChannel?((u=new MessageChannel).port1.onmessage=function(L){S(L.data)},function(L){u.port2.postMessage(L)}):b&&"onreadystatechange"in b.createElement("script")?(d=b.documentElement,function(L){var I=b.createElement("script");I.onreadystatechange=function(){S(L),I.onreadystatechange=null,d.removeChild(I),I=null},d.appendChild(I)}):function(L){setTimeout(S,0,L)},w.setImmediate=function(L){typeof L!="function"&&(L=new Function(""+L));for(var I=new Array(arguments.length-1),R=0;R<I.length;R++)I[R]=arguments[R+1];var F={callback:L,args:I};return f[p]=F,l(p),p++},w.clearImmediate=v}function v(L){delete f[L]}function S(L){if(g)setTimeout(S,0,L);else{var I=f[L];if(I){g=!0;try{(function(R){var F=R.callback,W=R.args;switch(W.length){case 0:F();break;case 1:F(W[0]);break;case 2:F(W[0],W[1]);break;case 3:F(W[0],W[1],W[2]);break;default:F.apply(a,W)}})(I)}finally{v(L),g=!1}}}}function C(L){L.source===s&&typeof L.data=="string"&&L.data.indexOf(m)===0&&S(+L.data.slice(m.length))}})(typeof self>"u"?i===void 0?this:i:self)}).call(this,typeof Jr<"u"?Jr:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(ai)),ai.exports}var Sm=xm();const Gc=Bd(Sm);class Ht{static DEBUG=!1;static extractUserContent(e){const t={text:"",html:"",hasImages:!1,hasFormulas:!1,hasTables:!1,hasCode:!1},r=e.querySelectorAll("user-query-file-preview img, .preview-image");t.hasImages=r.length>0;const o=e.querySelectorAll(".query-text-line"),i=[];o.forEach(d=>{const u=this.normalizeText(d.textContent||"");u&&i.push(u)}),t.text=i.join(`
`);const s=[],a=[];r.forEach((d,u)=>{const m=d.src,p=d.alt||`Uploaded image ${u+1}`;s.push(`<img src="${m}" alt="${p}" />`),a.push(`![${p}](${m})`)});const l=[];return a.length>0&&l.push(a.join(`

`)),i.length>0&&l.push(i.join(`
`)),t.text=l.join(`

`),i.forEach(d=>{s.push(`<p>${this.escapeHtml(d)}</p>`)}),t.html=s.join(`
`),t}static extractAssistantContent(e){this.DEBUG&&console.log("[DOMContentExtractor] extractAssistantContent called, element:",e);const t={text:"",html:"",hasImages:!1,hasFormulas:!1,hasTables:!1,hasCode:!1};let r=e.querySelector("message-content");r||(r=e.querySelector(".markdown-main-panel, .markdown, .model-response-text")),r||(e.classList.contains("markdown")||e.tagName.toLowerCase()==="message-content")&&(r=e),r||(console.warn("[DOMContentExtractor] Response container not found, using element directly"),r=e),this.DEBUG&&console.log("[DOMContentExtractor] Using container:",r.tagName,r.className);const o=[],i=[],s=r.querySelector(".markdown, .markdown-main-panel");this.DEBUG&&(console.log("[DOMContentExtractor] messageContent tagName:",r.tagName),console.log("[DOMContentExtractor] messageContent className:",r.className),console.log("[DOMContentExtractor] markdownDiv found?",!!s)),s?(this.DEBUG&&(console.log("[DOMContentExtractor] markdownDiv tagName:",s.tagName),console.log("[DOMContentExtractor] markdownDiv className:",s.className),console.log("[DOMContentExtractor] markdownDiv innerHTML preview:",s.innerHTML.substring(0,300))),this.processNodes(s,o,i,t)):(this.DEBUG&&console.log("[DOMContentExtractor] No markdown div found, using fallback"),this.processNodes(r,o,i,t)),this.DEBUG&&(console.log("[DOMContentExtractor] Searching for code blocks in:",e.tagName,e.className),console.log("[DOMContentExtractor] Element HTML preview:",e.outerHTML.substring(0,200)));const l=((u,m)=>{const p=[];p.push(...Array.from(u.querySelectorAll(m)));const f=g=>{const b=g.shadowRoot;b&&(console.log("[DOMContentExtractor] Searching in Shadow DOM of",g.tagName),p.push(...Array.from(b.querySelectorAll(m)))),Array.from(g.children).forEach(f)};return f(u),p})(r,'pre > code, [data-test-id="code-content"]');this.DEBUG&&console.log("[DOMContentExtractor] Found",l.length,"raw code elements with alternative selector"),l.forEach((u,m)=>{if(u.processedByGV||u.closest&&u.closest("code-block"))return;this.DEBUG&&console.log(`[DOMContentExtractor] Processing raw code element ${m+1}/${l.length}`);const p=this.extractCodeFromCodeElement(u);p.text&&(u.processedByGV=!0,t.hasCode=!0,o.push(p.html),i.push(`
${p.text}
`))}),t.html=o.join(`
`);let d=i.join("").replace(/\n{3,}/g,`

`).trim();if(!d){const u=r||e.querySelector("message-content")||e;try{const m=u.innerText||u.textContent||"";d=this.normalizeText(m)}catch{}}return t.text=d,t}static processNodes(e,t,r,o){const i=Array.from(e.children);this.DEBUG&&console.log(`[DOMContentExtractor] processNodes: ${i.length} children in`,e.tagName,e.className);const s=e.shadowRoot;s&&(this.DEBUG&&console.log("[DOMContentExtractor] Found Shadow DOM! Processing shadow children"),this.processNodes(s,t,r,o));for(const a of i){const l=a.tagName.toLowerCase();if(this.DEBUG&&console.log("[DOMContentExtractor] Processing child:",l,a.className),this.shouldSkipElement(a)){this.DEBUG&&console.log("[DOMContentExtractor] Skipping element:",l);continue}if(l==="img"){const p=a,f=p.getAttribute("src")||p.src||"";if(f&&f!=="about:blank"){o.hasImages=!0;const b=(p.getAttribute("alt")||"").trim()||"Image";t.push(`<img src="${this.escapeHtmlAttribute(f)}" alt="${this.escapeHtmlAttribute(b)}" />`);const w=b.replace(/\]/g,"\\]");r.push(`
![${w}](${f})
`)}continue}if(a.classList.contains("math-block")||a.hasAttribute("data-math")){const p=a.getAttribute("data-math")||"";if(p){this.DEBUG&&console.log("[DOMContentExtractor] Found math-block, latex:",p),o.hasFormulas=!0;const f=a.cloneNode(!0);f.hasAttribute("data-math")||f.setAttribute("data-math",p),t.push(f.outerHTML),r.push(`
$$
${p}
$$
`);continue}}const d=a.querySelector("code-block");if(l==="code-block"||a.classList.contains("code-block")||d){this.DEBUG&&console.log("[DOMContentExtractor] Found code block!");const p=d||a,f=this.extractCodeBlock(p);this.DEBUG&&console.log("[DOMContentExtractor] Code content:",f.text),f.text&&(o.hasCode=!0,t.push(f.html),r.push(`
${f.text}
`));continue}const u=a.querySelector("table-block");if(l==="table-block"||u||a.querySelector("table")){this.DEBUG&&console.log("[DOMContentExtractor] Found table block!");const p=u||a,f=this.extractTable(p);this.DEBUG&&console.log("[DOMContentExtractor] Table content:",f.text),f.text&&(o.hasTables=!0,t.push(f.html),r.push(`
${f.text}
`));continue}{const p=a.querySelectorAll("generated-image img, single-image img, .attachment-container.generated-images img");if(p.length>0){for(const f of Array.from(p)){const g=f,b=g.src||g.getAttribute("src")||"";if(!b||b==="about:blank")continue;const w=g.alt||"Generated image";o.hasImages=!0,t.push(`<img src="${this.escapeHtmlAttribute(b)}" alt="${this.escapeHtmlAttribute(w)}" />`);const v=w.replace(/\]/g,"\\]");r.push(`
![${v}](${b})
`)}this.DEBUG&&console.log("[DOMContentExtractor] Extracted",p.length,"generated images");continue}}if(l==="hr"){t.push("<hr>"),r.push(`
---
`);continue}if(l==="p"){const p=this.processInlineContent(a);p.hasFormulas&&(o.hasFormulas=!0),t.push(`<p>${p.html}</p>`),r.push(`${p.text}
`);continue}if(/^h[1-6]$/.test(l)){const p=this.extractTextWithInlineFormulas(a),f=l[1];t.push(`<h${f}>${p.html}</h${f}>`),r.push(`
${"#".repeat(parseInt(f))} ${p.text}
`);continue}if(l==="ul"||l==="ol"){const p=this.extractList(a);t.push(p.html),r.push(`
${p.text}
`);continue}if(l==="response-element"||l==="div"||l==="section"||l==="article"||l==="generated-image"||l==="single-image"||a.classList.contains("horizontal-scroll-wrapper")||a.classList.contains("table-block-component")){this.DEBUG&&console.log("[DOMContentExtractor] Recursing into container:",l,a.className),this.processNodes(a,t,r,o);continue}const m=this.normalizeText(a.textContent||"");m&&(t.push(`<span>${this.escapeHtml(m)}</span>`),r.push(m))}}static shouldSkipElement(e){return!!(e.tagName==="BUTTON"||e.tagName==="MAT-ICON"||e.tagName==="SOURCES-CAROUSEL-INLINE"||e.tagName==="SOURCE-INLINE-CHIPS"||e.tagName==="SOURCE-INLINE-CHIP"||e.tagName==="SHARE-BUTTON"||e.tagName==="COPY-BUTTON"||e.tagName==="DOWNLOAD-GENERATED-IMAGE-BUTTON"||e.tagName==="MODEL-THOUGHTS"||e.classList.contains("model-thoughts")||e.classList.contains("copy-button")||e.classList.contains("action-button")||e.classList.contains("table-footer")||e.classList.contains("export-sheets-button")||e.classList.contains("thoughts-header")||e.classList.contains("source-inline-chip-container")||e.classList.contains("nanobanana-indicator")||e.classList.contains("generated-image-controls")||e.classList.contains("hide-from-message-actions"))}static processInlineContent(e){let t=!1;const r=[],o=[],i=s=>{if(s.nodeType===Node.TEXT_NODE){const a=s.textContent||"";a.trim()&&(r.push(this.escapeHtml(a)),o.push(a))}else if(s.nodeType===Node.ELEMENT_NODE){const a=s;if(this.shouldSkipElement(a))return;if(a.classList.contains("math-inline")||a.hasAttribute("data-math")){const l=a.getAttribute("data-math")||"";if(l){t=!0;const d=a.cloneNode(!0);d.hasAttribute("data-math")||d.setAttribute("data-math",l),r.push(d.outerHTML),o.push(`$${l}$`);return}}if(a.tagName==="I"||a.tagName==="EM"){const l=this.normalizeText(a.textContent||"");r.push(`<em>${this.escapeHtml(l)}</em>`),o.push(`*${l}*`);return}if(a.tagName==="B"||a.tagName==="STRONG"){const l=this.normalizeText(a.textContent||"");r.push(`<strong>${this.escapeHtml(l)}</strong>`),o.push(`**${l}**`);return}if(a.tagName==="CODE"&&!a.closest("pre")){const l=this.normalizeText(a.textContent||"");r.push(`<code>${this.escapeHtml(l)}</code>`),o.push(`\`${l}\``);return}if(a.tagName==="IMG"){const l=a,d=l.src||l.getAttribute("src")||"";if(d&&d!=="about:blank"){const u=l.alt||"Image";r.push(`<img src="${this.escapeHtmlAttribute(d)}" alt="${this.escapeHtmlAttribute(u)}" />`);const m=u.replace(/\]/g,"\\]");o.push(`![${m}](${d})`)}return}Array.from(a.childNodes).forEach(i)}};return Array.from(e.childNodes).forEach(i),{html:r.join(""),text:o.join(""),hasFormulas:t}}static extractTextWithInlineFormulas(e){const t=this.processInlineContent(e);return{html:t.html,text:t.text}}static extractCodeBlock(e){const r=e.querySelector('code[role="text"], code')?.textContent||"";let o="";const i=e.querySelector(".code-block-decoration");return i&&(o=this.normalizeText(i.textContent||"").toLowerCase()),{html:`<pre><code class="language-${o}">${this.escapeHtml(r)}</code></pre>`,text:`\`\`\`${o}
${r}
\`\`\``}}static extractCodeFromCodeElement(e){const t=e.textContent||"";let r="";const i=(e.getAttribute("class")||"").toLowerCase().match(/language-([a-z0-9]+)/i);if(i)r=i[1];else{const s=e.closest("code-block");if(s){const a=s.querySelector(".code-block-decoration");a&&(r=this.normalizeText(a.textContent||"").toLowerCase())}}return{html:`<pre><code class="language-${r}">${this.escapeHtml(t)}</code></pre>`,text:`\`\`\`${r}
${t}
\`\`\``}}static extractTable(e){let t=null;if(e.tagName&&e.tagName.toLowerCase()==="table"?t=e:t=e.querySelector("table"),!t)return{html:"",text:""};const r=t.cloneNode(!0);this.stripExportArtifacts(r);const o=[],i=Array.from(t.querySelectorAll("thead tr td, thead tr th"));i.length>0&&o.push(i.map(l=>this.normalizeText(l.textContent||""))),t.querySelectorAll("tbody tr").forEach(l=>{const d=Array.from(l.querySelectorAll("td, th"));o.push(d.map(u=>this.normalizeText(u.textContent||"")))});const a=[];if(o.length>0){a.push("| "+o[0].join(" | ")+" |"),a.push("| "+o[0].map(()=>"---").join(" | ")+" |");for(let l=1;l<o.length;l++)a.push("| "+o[l].join(" | ")+" |")}else{const l=t.querySelector("tbody tr");if(l){const d=Array.from(l.querySelectorAll("td, th")).map(u=>this.normalizeText(u.textContent||""));d.length>0&&(a.push("| "+d.join(" | ")+" |"),a.push("| "+d.map(()=>"---").join(" | ")+" |"),Array.from(t.querySelectorAll("tbody tr")).slice(1).forEach(m=>{const p=Array.from(m.querySelectorAll("td, th")).map(f=>this.normalizeText(f.textContent||""));a.push("| "+p.join(" | ")+" |")}))}}return{html:r.outerHTML,text:a.join(`
`)}}static extractList(e,t=0){const r=e.tagName==="OL",o=Array.from(e.querySelectorAll(":scope > li")),i="  ".repeat(t),s=[];o.forEach((l,d)=>{const u=document.createElement("div");Array.from(l.childNodes).forEach(w=>{if(w.nodeType===Node.TEXT_NODE)u.appendChild(w.cloneNode(!0));else if(w.nodeType===Node.ELEMENT_NODE){const v=w;v.tagName!=="UL"&&v.tagName!=="OL"&&u.appendChild(v.cloneNode(!0))}});const f=this.processInlineContent(u).text||this.normalizeText(u.textContent||""),g=r?`${d+1}. `:"- ";s.push(i+g+f),l.querySelectorAll(":scope > ul, :scope > ol").forEach(w=>{const v=this.extractList(w,t+1);v.text&&s.push(v.text)})});const a=e.cloneNode(!0);return this.stripExportArtifacts(a),{html:a.outerHTML,text:s.join(`
`)}}static stripExportArtifacts(e){const t=["button","mat-icon","model-thoughts","sources-carousel-inline","source-inline-chips","source-inline-chip","share-button","copy-button","download-generated-image-button",".model-thoughts",".copy-button",".action-button",".table-footer",".export-sheets-button",".thoughts-header",".source-inline-chip-container",".nanobanana-indicator",".generated-image-controls",".hide-from-message-actions"].join(",");e.querySelectorAll(t).forEach(r=>r.remove())}static normalizeText(e){return e.replace(/\s+/g," ").trim()}static escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}static escapeHtmlAttribute(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;")}}class Em{static PRINT_STYLES_ID="gv-deep-research-pdf-print-styles";static PRINT_CONTAINER_ID="gv-deep-research-pdf-print-container";static PRINT_BODY_CLASS="gv-deep-research-pdf-printing";static PRINT_SAFARI_BODY_CLASS="gv-deep-research-pdf-safari-printing";static CLEANUP_FALLBACK_DELAY_MS=6e4;static INLINE_FETCH_TIMEOUT_MS=2e3;static INLINE_DECODE_TIMEOUT_MS=1e3;static cleanupFallbackTimer=null;static originalDocumentTitle=null;static async export(e){this.cleanup();const t=this.createPrintContainer(e);document.body.appendChild(t),this.injectPrintStyles(),document.body.classList.add(this.PRINT_BODY_CLASS),this.originalDocumentTitle=document.title;const r=this.normalizeTitle(e.title)||"Deep Research Report";document.title=r;const o=en(),i=this.inlineImages(t).catch(()=>{});if(o){document.body.classList.add(this.PRINT_SAFARI_BODY_CLASS),this.forceStyleFlush(t),this.triggerPrint(),this.registerCleanupHandlers();return}await i,await this.delay(100),this.triggerPrint(),this.registerCleanupHandlers()}static triggerPrint(){try{window.print()}catch{}}static forceStyleFlush(e){try{e.getBoundingClientRect()}catch{}}static delay(e){return new Promise(t=>{this.setTimeoutUnref(t,e)})}static setTimeoutUnref(e,t){const r=setTimeout(e,t);return typeof r=="object"&&r!==null&&"unref"in r&&typeof r.unref=="function"&&r.unref(),r}static registerCleanupHandlers(){const e=()=>{this.cleanup()};try{window.addEventListener("afterprint",e,{once:!0})}catch{}this.cleanupFallbackTimer!==null&&clearTimeout(this.cleanupFallbackTimer),this.cleanupFallbackTimer=this.setTimeoutUnref(()=>{this.cleanup()},this.CLEANUP_FALLBACK_DELAY_MS)}static cleanup(){this.cleanupFallbackTimer!==null&&(clearTimeout(this.cleanupFallbackTimer),this.cleanupFallbackTimer=null);try{document.body.classList.remove(this.PRINT_BODY_CLASS),document.body.classList.remove(this.PRINT_SAFARI_BODY_CLASS)}catch{}const e=document.getElementById(this.PRINT_CONTAINER_ID);e&&e.remove();const t=document.getElementById(this.PRINT_STYLES_ID);if(t&&t.remove(),this.originalDocumentTitle!==null){try{document.title=this.originalDocumentTitle}catch{}this.originalDocumentTitle=null}}static createPrintContainer(e){const t=document.createElement("div");t.id=this.PRINT_CONTAINER_ID,t.className="gv-print-only gv-deep-research-print-only";const r=this.sanitizePrintableHtml(e.html),o=this.extractPlainTextFromHtml(e.html)||e.markdown.trim(),i=r||this.formatPlainTextAsHtml(o||"No content"),s=this.normalizeTitle(e.title)||"Deep Research Report",a=this.formatDate(e.exportedAt);return t.innerHTML=`
      <div class="gv-dr-print-document">
        <div class="gv-dr-print-cover-page">
          <div class="gv-dr-print-cover-content">
            <h1 class="gv-dr-print-cover-title">${this.escapeHTML(s)}</h1>
            <div class="gv-dr-print-meta">
              <p>${this.escapeHTML(a)}</p>
              <p><a href="${this.escapeAttribute(e.url)}">${this.escapeHTML(e.url)}</a></p>
              <p>Deep Research Report</p>
            </div>
          </div>
        </div>
        <div class="gv-dr-print-content">
          <div class="gv-dr-print-report">${i}</div>
        </div>
        <div class="gv-dr-print-footer">
          <p>Exported from <a href="https://github.com/Nagi-ovo/gemini-voyager">Gemini Voyager</a></p>
          <p>Generated on ${this.escapeHTML(a)}</p>
        </div>
      </div>
    `,t}static sanitizePrintableHtml(e){const t=e.trim();if(!t)return"";const r=document.createElement("div");return r.innerHTML=t,r.querySelectorAll("script, style, template").forEach(i=>i.remove()),Array.from(r.querySelectorAll("*")).forEach(i=>{Array.from(i.attributes).forEach(a=>{a.name.toLowerCase().startsWith("on")&&i.removeAttribute(a.name)})}),r.innerHTML.trim()}static extractPlainTextFromHtml(e){const t=e.trim();if(!t)return"";const r=document.createElement("div");return r.innerHTML=t,r.querySelectorAll("script, style, template").forEach(o=>o.remove()),this.normalizeWhitespace(r.textContent||"")}static normalizeWhitespace(e){return e.replace(/\r/g,"").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}static formatPlainTextAsHtml(e){return e.trim()?this.escapeHTML(e).split(`

`).map(r=>`<p>${r.replace(/\n/g,"<br>")}</p>`).join(`
`):""}static normalizeTitle(e){return e.trim().replace(/\s+-\s+Gemini$/i,"").replace(/\s+-\s+Google Gemini$/i,"").replace(/\s+/g," ").trim()}static formatDate(e){try{return new Date(e).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}static injectPrintStyles(){if(document.getElementById(this.PRINT_STYLES_ID))return;const e=document.createElement("style");e.id=this.PRINT_STYLES_ID,e.textContent=`
      .gv-deep-research-print-only {
        display: none;
      }

      @media print {
        body.${this.PRINT_BODY_CLASS} > *:not(#${this.PRINT_CONTAINER_ID}) {
          display: none !important;
          visibility: hidden !important;
        }

        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID} {
          display: block !important;
          visibility: visible !important;
        }

        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID},
        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID} * {
          visibility: visible !important;
        }

        html,
        body {
          background: #fff !important;
        }

        body.${this.PRINT_BODY_CLASS} {
          background: #fff !important;
        }

        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID} * {
          display: revert !important;
        }

        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID} {
          font-family: Georgia, 'Times New Roman', serif;
          color: #000;
          background: #fff;
        }

        @page {
          margin: 2cm;
          size: A4;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-cover-page {
          min-height: calc(297mm - 4cm);
          position: relative;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          page-break-after: always;
          margin: 0;
          padding: 0;
          border: none;
          text-align: center;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-cover-content {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 80%;
          max-width: 80%;
          box-sizing: border-box;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-cover-title {
          font-size: 36pt;
          font-weight: 800;
          letter-spacing: -0.02em;
          margin: 0 0 1.5em 0;
          color: oklch(0.7227 0.1920 149.5793);
          line-height: 1.2;
          word-wrap: break-word;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-meta {
          font-size: 12pt;
          color: #666;
          line-height: 2;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-meta p {
          margin: 0.3em 0;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-meta a {
          color: #666;
          text-decoration: none;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-meta a:after {
          content: none !important;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-content {
          margin: 2em 0;
          line-height: 1.65;
          font-size: 11pt;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report p {
          margin: 0.5em 0;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 0.75em 0;
          page-break-inside: avoid;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report pre,
        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report code {
          font-family: 'Courier New', monospace;
          font-size: 9pt;
          background: #f5f5f5;
          border-radius: 3px;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report pre {
          padding: 0.75em;
          border-left: 3px solid #d1d5db;
          overflow-x: auto;
          white-space: pre-wrap;
          word-wrap: break-word;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report .math-inline,
        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report .math-block,
        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report [data-math] {
          page-break-inside: avoid;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-footer {
          margin-top: 2em;
          padding-top: 1em;
          border-top: 1px solid #ccc;
          font-size: 9pt;
          color: #666;
          text-align: center;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-footer p {
          margin: 0.25em 0;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report sources-carousel-inline,
        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report source-inline-chips,
        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report source-inline-chip,
        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report .source-inline-chip-container {
          display: none !important;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report a {
          color: #2563eb;
          text-decoration: none;
        }

        body.${this.PRINT_BODY_CLASS} .gv-dr-print-report a[href]:after {
          content: " (" attr(href) ")";
          font-size: 9pt;
          color: #666;
        }

        body.${this.PRINT_BODY_CLASS}.${this.PRINT_SAFARI_BODY_CLASS} .gv-dr-print-cover-page {
          min-height: auto !important;
          position: static !important;
          display: block !important;
          padding: 0 0 1.25em 0 !important;
          border-bottom: 1px solid #e5e7eb !important;
          text-align: left !important;
        }

        body.${this.PRINT_BODY_CLASS}.${this.PRINT_SAFARI_BODY_CLASS} .gv-dr-print-cover-content {
          position: static !important;
          top: auto !important;
          left: auto !important;
          transform: none !important;
          width: 100% !important;
          max-width: 100% !important;
        }

        body.${this.PRINT_BODY_CLASS}.${this.PRINT_SAFARI_BODY_CLASS} .gv-dr-print-content {
          break-before: auto !important;
          page-break-before: auto !important;
        }
      }
    `,document.head.appendChild(e)}static async inlineImages(e){const t=Array.from(e.querySelectorAll("img"));if(t.length===0)return;const r=async o=>{const i=typeof AbortController<"u"?new AbortController:null,s=this.setTimeoutUnref(()=>{try{i?.abort()}catch{}},this.INLINE_FETCH_TIMEOUT_MS);try{const a={credentials:"include",mode:"cors"};i&&(a.signal=i.signal);const l=await fetch(o,a);if(!l.ok)return null;const d=await l.blob();return await new Promise((m,p)=>{try{const f=new FileReader;f.onerror=()=>p(new Error("readAsDataURL failed")),f.onload=()=>m(String(f.result||"")),f.readAsDataURL(d)}catch(f){p(f)}})}catch{return null}finally{clearTimeout(s)}};await Promise.all(t.map(async o=>{const i=o.getAttribute("src")||"";if(!/^(https?:\/\/|blob:)/i.test(i))return;const s=await r(i);if(s)try{o.src=s}catch{}})),await Promise.all(t.map(async o=>{const i=o.decode;if(typeof i=="function")try{await Promise.race([i.call(o).catch(()=>{}),this.delay(this.INLINE_DECODE_TIMEOUT_MS)])}catch{}}))}static escapeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}static escapeAttribute(e){return this.escapeHTML(e).replace(/"/g,"&quot;")}}function Cm(n,e){if(n.match(/^[a-z]+:\/\//i))return n;if(n.match(/^\/\//))return window.location.protocol+n;if(n.match(/^[a-z]+:/i))return n;const t=document.implementation.createHTMLDocument(),r=t.createElement("base"),o=t.createElement("a");return t.head.appendChild(r),t.body.appendChild(o),e&&(r.href=e),o.href=n,o.href}const Tm=(()=>{let n=0;const e=()=>`0000${(Math.random()*36**4<<0).toString(36)}`.slice(-4);return()=>(n+=1,`u${e()}${n}`)})();function Cn(n){const e=[];for(let t=0,r=n.length;t<r;t++)e.push(n[t]);return e}let Bn=null;function jc(n={}){return Bn||(n.includeStyleProperties?(Bn=n.includeStyleProperties,Bn):(Bn=Cn(window.getComputedStyle(document.documentElement)),Bn))}function No(n,e){const r=(n.ownerDocument.defaultView||window).getComputedStyle(n).getPropertyValue(e);return r?parseFloat(r.replace("px","")):0}function _m(n){const e=No(n,"border-left-width"),t=No(n,"border-right-width");return n.clientWidth+e+t}function km(n){const e=No(n,"border-top-width"),t=No(n,"border-bottom-width");return n.clientHeight+e+t}function Wc(n,e={}){const t=e.width||_m(n),r=e.height||km(n);return{width:t,height:r}}function Am(){let n,e;try{e=process}catch{}const t=e&&e.env?e.env.devicePixelRatio:null;return t&&(n=parseInt(t,10),Number.isNaN(n)&&(n=1)),n||window.devicePixelRatio||1}const Ot=16384;function Im(n){(n.width>Ot||n.height>Ot)&&(n.width>Ot&&n.height>Ot?n.width>n.height?(n.height*=Ot/n.width,n.width=Ot):(n.width*=Ot/n.height,n.height=Ot):n.width>Ot?(n.height*=Ot/n.width,n.width=Ot):(n.width*=Ot/n.height,n.height=Ot))}function Lm(n,e={}){return n.toBlob?new Promise(t=>{n.toBlob(t,e.type?e.type:"image/png",e.quality?e.quality:1)}):new Promise(t=>{const r=window.atob(n.toDataURL(e.type?e.type:void 0,e.quality?e.quality:void 0).split(",")[1]),o=r.length,i=new Uint8Array(o);for(let s=0;s<o;s+=1)i[s]=r.charCodeAt(s);t(new Blob([i],{type:e.type?e.type:"image/png"}))})}function Fo(n){return new Promise((e,t)=>{const r=new Image;r.onload=()=>{r.decode().then(()=>{requestAnimationFrame(()=>e(r))})},r.onerror=t,r.crossOrigin="anonymous",r.decoding="async",r.src=n})}async function Dm(n){return Promise.resolve().then(()=>new XMLSerializer().serializeToString(n)).then(encodeURIComponent).then(e=>`data:image/svg+xml;charset=utf-8,${e}`)}async function Mm(n,e,t){const r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg"),i=document.createElementNS(r,"foreignObject");return o.setAttribute("width",`${e}`),o.setAttribute("height",`${t}`),o.setAttribute("viewBox",`0 0 ${e} ${t}`),i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("x","0"),i.setAttribute("y","0"),i.setAttribute("externalResourcesRequired","true"),o.appendChild(i),i.appendChild(n),Dm(o)}const Nt=(n,e)=>{if(n instanceof e)return!0;const t=Object.getPrototypeOf(n);return t===null?!1:t.constructor.name===e.name||Nt(t,e)};function Nm(n){const e=n.getPropertyValue("content");return`${n.cssText} content: '${e.replace(/'|"/g,"")}';`}function Fm(n,e){return jc(e).map(t=>{const r=n.getPropertyValue(t),o=n.getPropertyPriority(t);return`${t}: ${r}${o?" !important":""};`}).join(" ")}function Om(n,e,t,r){const o=`.${n}:${e}`,i=t.cssText?Nm(t):Fm(t,r);return document.createTextNode(`${o}{${i}}`)}function Wa(n,e,t,r){const o=window.getComputedStyle(n,t),i=o.getPropertyValue("content");if(i===""||i==="none")return;const s=Tm();try{e.className=`${e.className} ${s}`}catch{return}const a=document.createElement("style");a.appendChild(Om(s,t,o,r)),e.appendChild(a)}function Rm(n,e,t){Wa(n,e,":before",t),Wa(n,e,":after",t)}const Va="application/font-woff",Ya="image/jpeg",Pm={woff:Va,woff2:Va,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:Ya,jpeg:Ya,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml",webp:"image/webp"};function Bm(n){const e=/\.([^./]*?)$/g.exec(n);return e?e[1]:""}function Ys(n){const e=Bm(n).toLowerCase();return Pm[e]||""}function $m(n){return n.split(/,/)[1]}function Zi(n){return n.search(/^(data:)/)!==-1}function qm(n,e){return`data:${e};base64,${n}`}async function Vc(n,e,t){const r=await fetch(n,e);if(r.status===404)throw new Error(`Resource "${r.url}" not found`);const o=await r.blob();return new Promise((i,s)=>{const a=new FileReader;a.onerror=s,a.onloadend=()=>{try{i(t({res:r,result:a.result}))}catch(l){s(l)}},a.readAsDataURL(o)})}const li={};function zm(n,e,t){let r=n.replace(/\?.*/,"");return t&&(r=n),/ttf|otf|eot|woff2?/i.test(r)&&(r=r.replace(/.*\//,"")),e?`[${e}]${r}`:r}async function Ks(n,e,t){const r=zm(n,e,t.includeQueryParams);if(li[r]!=null)return li[r];t.cacheBust&&(n+=(/\?/.test(n)?"&":"?")+new Date().getTime());let o;try{const i=await Vc(n,t.fetchRequestInit,({res:s,result:a})=>(e||(e=s.headers.get("Content-Type")||""),$m(a)));o=qm(i,e)}catch(i){o=t.imagePlaceholder||"";let s=`Failed to fetch resource: ${n}`;i&&(s=typeof i=="string"?i:i.message),s&&console.warn(s)}return li[r]=o,o}async function Um(n){const e=n.toDataURL();return e==="data:,"?n.cloneNode(!1):Fo(e)}async function Hm(n,e){if(n.currentSrc){const i=document.createElement("canvas"),s=i.getContext("2d");i.width=n.clientWidth,i.height=n.clientHeight,s?.drawImage(n,0,0,i.width,i.height);const a=i.toDataURL();return Fo(a)}const t=n.poster,r=Ys(t),o=await Ks(t,r,e);return Fo(o)}async function Gm(n,e){var t;try{if(!((t=n?.contentDocument)===null||t===void 0)&&t.body)return await jo(n.contentDocument.body,e,!0)}catch{}return n.cloneNode(!1)}async function jm(n,e){return Nt(n,HTMLCanvasElement)?Um(n):Nt(n,HTMLVideoElement)?Hm(n,e):Nt(n,HTMLIFrameElement)?Gm(n,e):n.cloneNode(Yc(n))}const Wm=n=>n.tagName!=null&&n.tagName.toUpperCase()==="SLOT",Yc=n=>n.tagName!=null&&n.tagName.toUpperCase()==="SVG";async function Vm(n,e,t){var r,o;if(Yc(e))return e;let i=[];return Wm(n)&&n.assignedNodes?i=Cn(n.assignedNodes()):Nt(n,HTMLIFrameElement)&&(!((r=n.contentDocument)===null||r===void 0)&&r.body)?i=Cn(n.contentDocument.body.childNodes):i=Cn(((o=n.shadowRoot)!==null&&o!==void 0?o:n).childNodes),i.length===0||Nt(n,HTMLVideoElement)||await i.reduce((s,a)=>s.then(()=>jo(a,t)).then(l=>{l&&e.appendChild(l)}),Promise.resolve()),e}function Ym(n,e,t){const r=e.style;if(!r)return;const o=window.getComputedStyle(n);o.cssText?(r.cssText=o.cssText,r.transformOrigin=o.transformOrigin):jc(t).forEach(i=>{let s=o.getPropertyValue(i);i==="font-size"&&s.endsWith("px")&&(s=`${Math.floor(parseFloat(s.substring(0,s.length-2)))-.1}px`),Nt(n,HTMLIFrameElement)&&i==="display"&&s==="inline"&&(s="block"),i==="d"&&e.getAttribute("d")&&(s=`path(${e.getAttribute("d")})`),r.setProperty(i,s,o.getPropertyPriority(i))})}function Km(n,e){Nt(n,HTMLTextAreaElement)&&(e.innerHTML=n.value),Nt(n,HTMLInputElement)&&e.setAttribute("value",n.value)}function Zm(n,e){if(Nt(n,HTMLSelectElement)){const t=e,r=Array.from(t.children).find(o=>n.value===o.getAttribute("value"));r&&r.setAttribute("selected","")}}function Xm(n,e,t){return Nt(e,Element)&&(Ym(n,e,t),Rm(n,e,t),Km(n,e),Zm(n,e)),e}async function Jm(n,e){const t=n.querySelectorAll?n.querySelectorAll("use"):[];if(t.length===0)return n;const r={};for(let i=0;i<t.length;i++){const a=t[i].getAttribute("xlink:href");if(a){const l=n.querySelector(a),d=document.querySelector(a);!l&&d&&!r[a]&&(r[a]=await jo(d,e,!0))}}const o=Object.values(r);if(o.length){const i="http://www.w3.org/1999/xhtml",s=document.createElementNS(i,"svg");s.setAttribute("xmlns",i),s.style.position="absolute",s.style.width="0",s.style.height="0",s.style.overflow="hidden",s.style.display="none";const a=document.createElementNS(i,"defs");s.appendChild(a);for(let l=0;l<o.length;l++)a.appendChild(o[l]);n.appendChild(s)}return n}async function jo(n,e,t){return!t&&e.filter&&!e.filter(n)?null:Promise.resolve(n).then(r=>jm(r,e)).then(r=>Vm(n,r,e)).then(r=>Xm(n,r,e)).then(r=>Jm(r,e))}const Kc=/url\((['"]?)([^'"]+?)\1\)/g,Qm=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ep=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function tp(n){const e=n.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${e})(['"]?\\))`,"g")}function np(n){const e=[];return n.replace(Kc,(t,r,o)=>(e.push(o),t)),e.filter(t=>!Zi(t))}async function rp(n,e,t,r,o){try{const i=t?Cm(e,t):e,s=Ys(e);let a;return o||(a=await Ks(i,s,r)),n.replace(tp(e),`$1${a}$3`)}catch{}return n}function op(n,{preferredFontFormat:e}){return e?n.replace(ep,t=>{for(;;){const[r,,o]=Qm.exec(t)||[];if(!o)return"";if(o===e)return`src: ${r};`}}):n}function Zc(n){return n.search(Kc)!==-1}async function Xc(n,e,t){if(!Zc(n))return n;const r=op(n,t);return np(r).reduce((i,s)=>i.then(a=>rp(a,s,e,t)),Promise.resolve(r))}async function $n(n,e,t){var r;const o=(r=e.style)===null||r===void 0?void 0:r.getPropertyValue(n);if(o){const i=await Xc(o,null,t);return e.style.setProperty(n,i,e.style.getPropertyPriority(n)),!0}return!1}async function ip(n,e){await $n("background",n,e)||await $n("background-image",n,e),await $n("mask",n,e)||await $n("-webkit-mask",n,e)||await $n("mask-image",n,e)||await $n("-webkit-mask-image",n,e)}async function sp(n,e){const t=Nt(n,HTMLImageElement);if(!(t&&!Zi(n.src))&&!(Nt(n,SVGImageElement)&&!Zi(n.href.baseVal)))return;const r=t?n.src:n.href.baseVal,o=await Ks(r,Ys(r),e);await new Promise((i,s)=>{n.onload=i,n.onerror=e.onImageErrorHandler?(...l)=>{try{i(e.onImageErrorHandler(...l))}catch(d){s(d)}}:s;const a=n;a.decode&&(a.decode=i),a.loading==="lazy"&&(a.loading="eager"),t?(n.srcset="",n.src=o):n.href.baseVal=o})}async function ap(n,e){const r=Cn(n.childNodes).map(o=>Jc(o,e));await Promise.all(r).then(()=>n)}async function Jc(n,e){Nt(n,Element)&&(await ip(n,e),await sp(n,e),await ap(n,e))}function lp(n,e){const{style:t}=n;e.backgroundColor&&(t.backgroundColor=e.backgroundColor),e.width&&(t.width=`${e.width}px`),e.height&&(t.height=`${e.height}px`);const r=e.style;return r!=null&&Object.keys(r).forEach(o=>{t[o]=r[o]}),n}const Ka={};async function Za(n){let e=Ka[n];if(e!=null)return e;const r=await(await fetch(n)).text();return e={url:n,cssText:r},Ka[n]=e,e}async function Xa(n,e){let t=n.cssText;const r=/url\(["']?([^"')]+)["']?\)/g,i=(t.match(/url\([^)]+\)/g)||[]).map(async s=>{let a=s.replace(r,"$1");return a.startsWith("https://")||(a=new URL(a,n.url).href),Vc(a,e.fetchRequestInit,({result:l})=>(t=t.replace(s,`url(${l})`),[s,l]))});return Promise.all(i).then(()=>t)}function Ja(n){if(n==null)return[];const e=[],t=/(\/\*[\s\S]*?\*\/)/gi;let r=n.replace(t,"");const o=new RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");for(;;){const l=o.exec(r);if(l===null)break;e.push(l[0])}r=r.replace(o,"");const i=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,s="((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})",a=new RegExp(s,"gi");for(;;){let l=i.exec(r);if(l===null){if(l=a.exec(r),l===null)break;i.lastIndex=a.lastIndex}else a.lastIndex=i.lastIndex;e.push(l[0])}return e}async function cp(n,e){const t=[],r=[];return n.forEach(o=>{if("cssRules"in o)try{Cn(o.cssRules||[]).forEach((i,s)=>{if(i.type===CSSRule.IMPORT_RULE){let a=s+1;const l=i.href,d=Za(l).then(u=>Xa(u,e)).then(u=>Ja(u).forEach(m=>{try{o.insertRule(m,m.startsWith("@import")?a+=1:o.cssRules.length)}catch(p){console.error("Error inserting rule from remote css",{rule:m,error:p})}})).catch(u=>{console.error("Error loading remote css",u.toString())});r.push(d)}})}catch(i){const s=n.find(a=>a.href==null)||document.styleSheets[0];o.href!=null&&r.push(Za(o.href).then(a=>Xa(a,e)).then(a=>Ja(a).forEach(l=>{s.insertRule(l,s.cssRules.length)})).catch(a=>{console.error("Error loading remote stylesheet",a)})),console.error("Error inlining remote css file",i)}}),Promise.all(r).then(()=>(n.forEach(o=>{if("cssRules"in o)try{Cn(o.cssRules||[]).forEach(i=>{t.push(i)})}catch(i){console.error(`Error while reading CSS rules from ${o.href}`,i)}}),t))}function dp(n){return n.filter(e=>e.type===CSSRule.FONT_FACE_RULE).filter(e=>Zc(e.style.getPropertyValue("src")))}async function up(n,e){if(n.ownerDocument==null)throw new Error("Provided element is not within a Document");const t=Cn(n.ownerDocument.styleSheets),r=await cp(t,e);return dp(r)}function Qc(n){return n.trim().replace(/["']/g,"")}function hp(n){const e=new Set;function t(r){(r.style.fontFamily||getComputedStyle(r).fontFamily).split(",").forEach(i=>{e.add(Qc(i))}),Array.from(r.children).forEach(i=>{i instanceof HTMLElement&&t(i)})}return t(n),e}async function mp(n,e){const t=await up(n,e),r=hp(n);return(await Promise.all(t.filter(i=>r.has(Qc(i.style.fontFamily))).map(i=>{const s=i.parentStyleSheet?i.parentStyleSheet.href:null;return Xc(i.cssText,s,e)}))).join(`
`)}async function pp(n,e){const t=e.fontEmbedCSS!=null?e.fontEmbedCSS:e.skipFonts?null:await mp(n,e);if(t){const r=document.createElement("style"),o=document.createTextNode(t);r.appendChild(o),n.firstChild?n.insertBefore(r,n.firstChild):n.appendChild(r)}}async function fp(n,e={}){const{width:t,height:r}=Wc(n,e),o=await jo(n,e,!0);return await pp(o,e),await Jc(o,e),lp(o,e),await Mm(o,t,r)}async function gp(n,e={}){const{width:t,height:r}=Wc(n,e),o=await fp(n,e),i=await Fo(o),s=document.createElement("canvas"),a=s.getContext("2d"),l=e.pixelRatio||Am(),d=e.canvasWidth||t,u=e.canvasHeight||r;return s.width=d*l,s.height=u*l,e.skipAutoScale||Im(s),s.style.width=`${d}`,s.style.height=`${u}`,e.backgroundColor&&(a.fillStyle=e.backgroundColor,a.fillRect(0,0,s.width,s.height)),a.drawImage(i,0,0,s.width,s.height),s}async function bp(n,e={}){const t=await gp(n,e);return await Lm(t)}class Qa{static async export(e,t,r){const o=r.filename.toLowerCase().endsWith(".png")?r.filename:`${r.filename}.png`,i=this.createRenderContainer(e,t,r.fontSize);document.body.appendChild(i);try{await this.inlineImages(i);const s=await this.renderWithSafariFallback(i);this.downloadBlob(s,o)}finally{try{i.remove()}catch{}}}static async exportDocument(e,t){const r=t.filename.toLowerCase().endsWith(".png")?t.filename:`${t.filename}.png`,o=this.createDocumentRenderContainer(e);document.body.appendChild(o);try{await this.inlineImages(o);const i=await this.renderWithSafariFallback(o);this.downloadBlob(i,r)}finally{try{o.remove()}catch{}}}static createRenderContainer(e,t,r){const o=document.createElement("div");o.className="gv-image-export-container",Object.assign(o.style,{position:"fixed",left:"-10000px",top:"0",width:"620px",background:"#ffffff",color:"#111827",zIndex:"-1",pointerEvents:"none"});const i=t.title||"Conversation",s=this.formatDate(t.exportedAt),a=`
      <header class="gv-image-export-header">
        <h1 class="gv-image-export-title">${this.escapeHTML(i)}</h1>
        <div class="gv-image-export-meta">
          <div>${this.escapeHTML(s)}</div>
          <div><a href="${this.escapeAttr(t.url)}">${this.escapeHTML(t.url)}</a></div>
          <div>${t.count} conversation turns</div>
        </div>
      </header>
    `,l=e.map((S,C)=>{const L=C+1,I=S.starred?" â­":"",R=S.userElement?Ht.extractUserContent(S.userElement).html:this.formatPlainTextAsHtml(S.user),F=S.assistantElement?Ht.extractAssistantContent(S.assistantElement).html:this.formatPlainTextAsHtml(S.assistant);if(!S.omitEmptySections)return`
          <article class="gv-image-export-turn">
            <div class="gv-image-export-turn-header">Turn ${L}${I}</div>
            <section class="gv-image-export-block">
              <div class="gv-image-export-label">User</div>
              <div class="gv-image-export-content">${R||"<em>No content</em>"}</div>
            </section>
            <section class="gv-image-export-block">
              <div class="gv-image-export-label">Assistant</div>
              <div class="gv-image-export-content">${F||"<em>No content</em>"}</div>
            </section>
          </article>
        `;const W=!!S.userElement||!!S.user.trim(),B=!!S.assistantElement||!!S.assistant.trim();return`
          <article class="gv-image-export-turn">
            <div class="gv-image-export-turn-header">Turn ${L}${I}</div>
            ${W?`
            <section class="gv-image-export-block">
              <div class="gv-image-export-label">User</div>
              <div class="gv-image-export-content">${R||"<em>No content</em>"}</div>
            </section>
            `:""}
            ${B?`
            <section class="gv-image-export-block">
              <div class="gv-image-export-label">Assistant</div>
              <div class="gv-image-export-content">${F||"<em>No content</em>"}</div>
            </section>
            `:""}
          </article>
        `}).join(`
`),d=`
      <footer class="gv-image-export-footer">
        <div>Exported from Gemini Voyager</div>
        <div>Generated on ${this.escapeHTML(s)}</div>
      </footer>
    `,u=r??20,m=Math.round(u*2.5),p=Math.max(u-2,10),f=Math.round(u*1.2),g=Math.max(u-2,10),b=Math.max(u-4,10),w=document.createElement("style");w.textContent=`
      .gv-image-export-doc {
        font-family: Georgia, 'Times New Roman', serif;
        font-size: ${u}px;
        line-height: 1.9;
        padding: 26px;
      }

      .gv-image-export-header {
        margin-bottom: 18px;
        padding-bottom: 14px;
        border-bottom: 1px solid rgba(0,0,0,0.12);
      }

      .gv-image-export-title {
        margin: 0;
        font-size: ${m}px;
        line-height: 1.2;
        color: #111827;
        word-break: break-word;
      }

      .gv-image-export-meta {
        margin-top: 10px;
        color: #6b7280;
        font-size: ${p}px;
        display: grid;
        gap: 8px;
      }

      .gv-image-export-turn {
        margin: 24px 0;
        padding: 20px 0;
        border-bottom: 1px solid rgba(0,0,0,0.08);
      }

      .gv-image-export-turn-header {
        font-weight: 700;
        font-size: ${f}px;
        color: #374151;
        margin-bottom: 14px;
      }

      .gv-image-export-block {
        margin: 16px 0;
      }

      .gv-image-export-label {
        font-weight: 700;
        font-size: ${u}px;
        margin-bottom: 10px;
        color: #111827;
      }

      .gv-image-export-content {
        font-size: ${u}px;
        padding-left: 16px;
        border-left: 3px solid rgba(0,0,0,0.10);
      }

      .gv-image-export-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 12px 0;
      }

      .gv-image-export-content pre {
        background: rgba(0,0,0,0.05);
        padding: 14px 16px;
        border-radius: 8px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: ${g}px;
        line-height: 1.8;
      }

      .gv-image-export-footer {
        margin-top: 24px;
        padding-top: 14px;
        border-top: 1px solid rgba(0,0,0,0.12);
        color: #6b7280;
        font-size: ${b}px;
        display: grid;
        gap: 8px;
      }
    `;const v=document.createElement("div");return v.className="gv-image-export-doc",v.innerHTML=`${a}${l}${d}`,o.appendChild(w),o.appendChild(v),o}static createDocumentRenderContainer(e){const t=document.createElement("div");t.className="gv-image-export-container",Object.assign(t.style,{position:"fixed",left:"-10000px",top:"0",width:"620px",background:"#ffffff",color:"#111827",zIndex:"-1",pointerEvents:"none"});const r=this.formatDate(e.exportedAt),o=e.html.trim()||this.formatPlainTextAsHtml(e.markdown),i=`
      <header class="gv-image-export-header">
        <h1 class="gv-image-export-title">${this.escapeHTML(e.title||"Deep Research Report")}</h1>
        <div class="gv-image-export-meta">
          <div>${this.escapeHTML(r)}</div>
          <div><a href="${this.escapeAttr(e.url)}">${this.escapeHTML(e.url)}</a></div>
        </div>
      </header>
    `,s=`
      <footer class="gv-image-export-footer">
        <div>Exported from Gemini Voyager</div>
        <div>Generated on ${this.escapeHTML(r)}</div>
      </footer>
    `,a=document.createElement("style");a.textContent=`
      .gv-image-export-doc {
        font-family: Georgia, 'Times New Roman', serif;
        font-size: 20px;
        line-height: 1.9;
        padding: 26px;
      }

      .gv-image-export-header {
        margin-bottom: 18px;
        padding-bottom: 14px;
        border-bottom: 1px solid rgba(0,0,0,0.12);
      }

      .gv-image-export-title {
        margin: 0;
        font-size: 50px;
        line-height: 1.2;
        color: #111827;
        word-break: break-word;
      }

      .gv-image-export-meta {
        margin-top: 10px;
        color: #6b7280;
        font-size: 18px;
        display: grid;
        gap: 8px;
      }

      .gv-image-export-report-content {
        margin: 18px 0 24px;
        color: #1a1a1a;
        font-size: 20px;
      }

      .gv-image-export-report-content p {
        margin: 12px 0;
      }

      .gv-image-export-report-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 12px 0;
      }

      .gv-image-export-report-content pre {
        background: rgba(0,0,0,0.05);
        padding: 14px 16px;
        border-radius: 8px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 18px;
        line-height: 1.8;
      }

      .gv-image-export-footer {
        margin-top: 24px;
        padding-top: 14px;
        border-top: 1px solid rgba(0,0,0,0.12);
        color: #6b7280;
        font-size: 16px;
        display: grid;
        gap: 8px;
      }
    `;const l=document.createElement("div");return l.className="gv-image-export-doc",l.innerHTML=`${i}<main class="gv-image-export-report-content">${o}</main>${s}`,t.appendChild(a),t.appendChild(l),t}static async inlineImages(e){const t=Array.from(e.querySelectorAll("img"));if(t.length===0)return;const r=async i=>{try{return await new Promise((s,a)=>{const l=new FileReader;l.onerror=()=>a(new Error("readAsDataURL failed")),l.onload=()=>s(String(l.result||"")),l.readAsDataURL(i)})}catch{return null}},o=async i=>{if(!/^https?:\/\//i.test(i))return null;try{const s=await fetch(i,{credentials:"include",mode:"cors"});if(s.ok){const a=await s.blob(),l=await r(a);if(l)return l}}catch{}try{const s=await new Promise(a=>{try{chrome.runtime?.sendMessage?.({type:"gv.fetchImage",url:i},l=>{if(l&&l.ok&&l.base64){const d=String(l.contentType||"application/octet-stream");a(`data:${d};base64,${l.base64}`)}else a(null)})}catch{a(null)}});if(s)return s}catch{}return null};await Promise.all(t.map(async i=>{const s=i.getAttribute("src")||"",a=await o(s);if(a)try{i.src=a}catch{}})),await Promise.all(t.map(i=>i.decode?.().catch(()=>{})))}static async renderWithSafariFallback(e){const t=e.querySelector(".gv-image-export-doc")||e;try{return await this.renderTargetToBlob(t)}catch(o){if(!en())throw o}const r=e.cloneNode(!0);r.querySelectorAll("img").forEach(o=>o.remove()),document.body.appendChild(r);try{const o=r.querySelector(".gv-image-export-doc")||r;return await this.renderTargetToBlob(o)}finally{try{r.remove()}catch{}}}static async renderTargetToBlob(e){const t=await bp(e,{cacheBust:!0,pixelRatio:1.2,backgroundColor:"#ffffff",skipFonts:!0});if(!t)throw new Error("Image render failed");return t}static downloadBlob(e,t){const r=URL.createObjectURL(e),o=document.createElement("a");o.href=r,o.download=t,document.body.appendChild(o),o.click(),setTimeout(()=>{try{document.body.removeChild(o)}catch{}URL.revokeObjectURL(r)},0)}static escapeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}static escapeAttr(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}static formatPlainTextAsHtml(e){const t=this.escapeHTML(e||"");return t.trim()?t.split(/\n\n+/).map(o=>o.replace(/\n/g,"<br>")).map(o=>`<p>${o}</p>`).join(""):"<em>No content</em>"}static formatDate(e){try{return new Date(e).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}}class qn{static async fetchAsDataURL(e){try{const t=await fetch(e,{credentials:"include",mode:"cors"});if(!t.ok||!t.body)return null;const r=await t.blob();return await new Promise((o,i)=>{try{const s=new FileReader;s.onerror=()=>i(new Error("readAsDataURL failed")),s.onload=()=>o(String(s.result||"")),s.readAsDataURL(r)}catch(s){i(s)}})}catch{return null}}static extractImageUrls(e){const t=/!\[[^\]]*\]\(((?:https?:\/\/|blob:)[^\s)]+)\)/g,r=new Set;let o;for(;(o=t.exec(e))!==null;)r.add(o[1]);return Array.from(r)}static rewriteImageUrls(e,t){const r=/!\[([^\]]*)\]\(((?:https?:\/\/|blob:)[^\s)]+)\)/g;return e.replace(r,(o,i,s)=>{const a=t.get(s);return a?`![${i}](${a})`:o})}static degradeImageMarkdownForSafari(e){const t=/!\[([^\]]*)\]\(((?:https?:\/\/|blob:)[^\s)]+)\)/g;return e.replace(t,(r,o)=>`[Image unavailable in Safari export: ${String(o||"").trim()||"image"}]`)}static async formatWithAssets(e,t){const r=this.format(e,t),o=this.extractImageUrls(r);if(o.length===0)return r;const i=new Map;return await Promise.all(o.map(async s=>{const a=await this.fetchAsDataURL(s);a&&i.set(s,a)})),i.size===0?r:this.rewriteImageUrls(r,i)}static format(e,t){const r=[];return r.push(this.formatHeader(t)),r.push(""),r.push("---"),r.push(""),e.forEach((o,i)=>{r.push(this.formatTurn(o,i+1)),r.push("")}),r.push("---"),r.push(""),r.push(this.formatFooter(t)),r.join(`
`)}static formatHeader(e){const t=[],r=e.title||this.extractTitleFromURL(e.url);return t.push(`# ${this.escapeMarkdown(r)}`),t.push(""),t.push(`**Date**: ${this.formatDate(e.exportedAt)}`),t.push(`**Turns**: ${e.count}`),t.push(`**Source**: [Gemini Chat](${e.url})`),t.join(`
`)}static formatTurn(e,t){const r=[];if(r.push(`## Turn ${t}${e.starred?" â­":""}`),r.push(""),!e.omitEmptySections){if(r.push("### ğŸ‘¤ User"),r.push(""),e.userElement){const d=Ht.extractUserContent(e.userElement);d.hasImages&&(r.push("*[This turn includes uploaded images]*"),r.push("")),r.push(d.text||"_No content_")}else r.push(this.formatContent(e.user)||"_No content_");if(r.push(""),r.push("### ğŸ¤– Assistant"),r.push(""),e.assistantElement){const d=Ht.extractAssistantContent(e.assistantElement),u=this.formatContent(e.assistant);r.push(d.text||u||"_No content_")}else r.push(this.formatContent(e.assistant)||"_No content_");return r.join(`
`)}let o=!1;const i=this.formatContent(e.user);if(!!e.userElement||!!i){if(r.push("### ğŸ‘¤ User"),r.push(""),e.userElement){const d=Ht.extractUserContent(e.userElement);d.hasImages&&(r.push("*[This turn includes uploaded images]*"),r.push("")),r.push(d.text||i||"_No content_")}else r.push(i||"_No content_");r.push(""),o=!0}const a=this.formatContent(e.assistant);if(!!e.assistantElement||!!a){if(r.push("### ğŸ¤– Assistant"),r.push(""),e.assistantElement){const d=Ht.extractAssistantContent(e.assistantElement);r.push(d.text||a||"_No content_")}else r.push(a||"_No content_");o=!0}return o||r.push("_No content_"),r.join(`
`)}static formatContent(e){return e?e.trim():""}static formatFooter(e){return["*Exported from [Gemini Voyager](https://github.com/Nagi-ovo/gemini-voyager)*",`*Generated on ${this.formatDate(e.exportedAt)}*`].join(`  
`)}static extractTitleFromURL(e){try{const o=new URL(e).pathname.match(/\/(app|chat)\/([^/]+)/);return o?`Gemini Conversation ${o[2].substring(0,8)}`:"Gemini Conversation"}catch{return"Gemini Conversation"}}static formatDate(e){try{return new Date(e).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}static escapeMarkdown(e){return e.replace(/([\\`*_{}[\]()#+\-.!])/g,"\\$1")}static generateFilename(){const e=d=>String(d).padStart(2,"0"),t=new Date,r=t.getFullYear(),o=e(t.getMonth()+1),i=e(t.getDate()),s=e(t.getHours()),a=e(t.getMinutes()),l=e(t.getSeconds());return`gemini-chat-${r}${o}${i}-${s}${a}${l}.md`}static download(e,t){const r=new Blob([e],{type:"text/markdown;charset=utf-8"}),o=URL.createObjectURL(r),i=document.createElement("a");i.href=o,i.download=t||this.generateFilename(),document.body.appendChild(i),i.click(),setTimeout(()=>{try{document.body.removeChild(i)}catch{}URL.revokeObjectURL(o)},0)}}class vp{static PRINT_STYLES_ID="gv-pdf-print-styles";static PRINT_CONTAINER_ID="gv-pdf-print-container";static PRINT_BODY_CLASS="gv-pdf-printing";static CLEANUP_FALLBACK_DELAY_MS=6e4;static INLINE_FETCH_TIMEOUT_MS=2e3;static INLINE_DECODE_TIMEOUT_MS=1e3;static cleanupFallbackTimer=null;static originalDocumentTitle=null;static async export(e,t,r){await this.exportInternal(e,t,!1,r?.fontSize)}static async exportDocument(e){const t={url:e.url,exportedAt:e.exportedAt,count:1,title:e.title},r=document.createElement("div");r.innerHTML=e.html.trim();const s=[{user:"",assistant:this.extractPlainTextFromHtml(e.html)||e.markdown.trim()||"No content",starred:!1,omitEmptySections:!0,assistantElement:r}];await this.exportInternal(s,t,!0)}static async exportInternal(e,t,r,o){this.cleanup();const i=this.createPrintContainer(e,t,r);document.body.appendChild(i);const s=document.getElementById(this.PRINT_STYLES_ID);s&&s.remove(),this.injectPrintStyles(o),document.body.classList.add(this.PRINT_BODY_CLASS),this.originalDocumentTitle=document.title;const a=this.getPrintDialogTitle(t,r);a&&(document.title=a);const l=en(),d=this.inlineImages(i).catch(()=>{});if(l){this.forceStyleFlush(i),this.triggerPrint(),this.registerCleanupHandlers();return}await d,await this.delay(100),this.triggerPrint(),this.registerCleanupHandlers()}static triggerPrint(){try{window.print()}catch{}}static forceStyleFlush(e){try{e.getBoundingClientRect()}catch{}}static delay(e){return new Promise(t=>{this.setTimeoutUnref(t,e)})}static registerCleanupHandlers(){const e=()=>{this.cleanup()};try{window.addEventListener("afterprint",e,{once:!0})}catch{}this.cleanupFallbackTimer!==null&&clearTimeout(this.cleanupFallbackTimer),this.cleanupFallbackTimer=this.setTimeoutUnref(()=>{this.cleanup()},this.CLEANUP_FALLBACK_DELAY_MS)}static setTimeoutUnref(e,t){const r=setTimeout(e,t);return typeof r=="object"&&r!==null&&"unref"in r&&typeof r.unref=="function"&&r.unref(),r}static createPrintContainer(e,t,r){const o=document.createElement("div");return o.id=this.PRINT_CONTAINER_ID,o.className="gv-print-only",o.innerHTML=`
      <div class="gv-print-document">
        ${this.renderHeader(t,r)}
        ${this.renderContent(e)}
        ${this.renderFooter(t)}
      </div>
    `,o}static extractPlainTextFromHtml(e){const t=e.trim();if(!t)return"";const r=document.createElement("div");return r.innerHTML=t,r.querySelectorAll("script, style, template").forEach(o=>o.remove()),this.normalizeWhitespace(r.textContent||"")}static normalizeWhitespace(e){return e.replace(/\r/g,"").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}static async inlineImages(e){const t=Array.from(e.querySelectorAll("img"));if(t.length===0)return;const r=async o=>{const i=typeof AbortController<"u"?new AbortController:null,s=this.setTimeoutUnref(()=>{try{i?.abort()}catch{}},this.INLINE_FETCH_TIMEOUT_MS);try{const a={credentials:"include",mode:"cors"};i&&(a.signal=i.signal);const l=await fetch(o,a);if(!l.ok)return null;const d=await l.blob();return await new Promise((m,p)=>{try{const f=new FileReader;f.onerror=()=>p(new Error("readAsDataURL failed")),f.onload=()=>m(String(f.result||"")),f.readAsDataURL(d)}catch(f){p(f)}})}catch{return null}finally{clearTimeout(s)}};await Promise.all(t.map(async o=>{const i=o.getAttribute("src")||"";if(!/^(https?:\/\/|blob:)/i.test(i))return;const s=await r(i);if(s)try{o.src=s}catch{}})),await Promise.all(t.map(async o=>{const i=o.decode;if(typeof i=="function")try{await Promise.race([i.call(o).catch(()=>{}),this.delay(this.INLINE_DECODE_TIMEOUT_MS)])}catch{}}))}static getConversationTitle(){try{const r=document.querySelector(".gv-folder-conversation.gv-folder-conversation-selected .gv-conversation-title")||document.querySelector(".gv-folder-conversation-selected .gv-conversation-title");if(r?.textContent?.trim())return r.textContent.trim()}catch(r){console.debug("[PDF Export] Failed to get title from Folder Manager:",r)}try{const r=this.extractConversationIdFromURL(window.location.href);if(r){const o=this.extractTitleFromNativeSidebarByConversationId(r);if(o)return o}}catch(r){console.debug("[PDF Export] Failed to get title from native sidebar by id:",r)}const e=document.querySelector("title");if(e){const r=e.textContent?.trim();if(this.isMeaningfulConversationTitle(r))return r}try{const r=["mat-list-item.mdc-list-item--activated [mat-line]",'mat-list-item[aria-current="page"] [mat-line]',".conversation-list-item.active .conversation-title",".active-conversation .title"];for(const o of r){const s=document.querySelector(o)?.textContent?.trim();if(this.isMeaningfulConversationTitle(s))return s}}catch(r){console.debug("[PDF Export] Failed to get title from sidebar:",r)}const t=this.extractConversationIdFromURL(window.location.href);return t?`Conversation ${t.slice(0,8)}`:"Untitled Conversation"}static isMeaningfulConversationTitle(e){const t=(e||"").trim();return!(!t||t==="Untitled Conversation"||t==="Gemini"||t==="Google Gemini"||t==="Google AI Studio"||t==="New chat"||t.startsWith("Gemini -")||t.startsWith("Google AI Studio -"))}static isGemLabel(e){const t=(e||"").trim().toLowerCase();return t==="gem"||t==="gems"}static extractConversationIdFromURL(e){try{const t=new URL(e),r=t.pathname.match(/\/app\/([^/?#]+)/);if(r?.[1])return r[1];const o=t.pathname.match(/\/gem\/[^/]+\/([^/?#]+)/);if(o?.[1])return o[1]}catch{}return null}static extractTitleFromLinkText(e){if(!e)return null;const t=(e.innerText||"").trim();if(!t)return null;const r=t.split(`
`).map(o=>o.trim()).filter(Boolean).filter(o=>!this.isGemLabel(o)).filter(o=>o.length>=2);return r.length===0?null:r.reduce((o,i)=>i.length>o.length?i:o,r[0])||null}static extractTitleFromConversationElement(e){const t=e.closest('[data-test-id="conversation"]')||e,o=t.querySelector('.gds-label-l, .conversation-title-text, [data-test-id="conversation-title"], h3')?.textContent?.trim();if(this.isMeaningfulConversationTitle(o)&&!this.isGemLabel(o))return o;const i=t.querySelector('a[href*="/app/"], a[href*="/gem/"]'),s=i?.getAttribute("aria-label")?.trim();if(this.isMeaningfulConversationTitle(s)&&!this.isGemLabel(s))return s;const a=i?.getAttribute("title")?.trim();if(this.isMeaningfulConversationTitle(a)&&!this.isGemLabel(a))return a;const l=this.extractTitleFromLinkText(i);if(this.isMeaningfulConversationTitle(l))return l;const u=t.querySelector(".gds-body-m, .gds-label-m, .subtitle")?.textContent?.trim();if(this.isMeaningfulConversationTitle(u)&&!this.isGemLabel(u))return u;const m=t.textContent?.trim()||"";if(!m)return null;const p=m.split(`
`).map(f=>f.trim()).filter(Boolean)[0]||m;return this.isMeaningfulConversationTitle(p)&&!this.isGemLabel(p)?p.slice(0,80):null}static extractTitleFromNativeSidebarByConversationId(e){const t=this.escapeCssAttributeValue(e),r=document.querySelector(`[data-test-id="conversation"][jslog*="c_${t}"]`);if(r){const i=this.extractTitleFromConversationElement(r);if(i)return i}const o=document.querySelector(`[data-test-id="conversation"] a[href*="${t}"]`);if(o){const i=this.extractTitleFromConversationElement(o);if(i)return i}return null}static renderHeader(e,t){const r=this.normalizeConversationTitle(e.title),o=this.normalizeConversationTitle(this.getConversationTitle()),i=t?r||o||"Untitled Conversation":o||r||"Untitled Conversation",s=this.extractTitleFromURL(e.url),a=this.formatDate(e.exportedAt),l=e.count;return`
      <div class="gv-print-header gv-print-cover-page">
        <div class="gv-print-cover-content">
          <h1 class="gv-print-cover-title">${this.escapeHTML(i)}</h1>
          <div class="gv-print-meta">
            <p>${a}</p>
            <p><a href="${this.escapeAttribute(e.url)}">${this.escapeHTML(s)}</a></p>
            <p>${l} conversation turns</p>
          </div>
        </div>
      </div>
    `}static renderContent(e){return`
      <div class="gv-print-content">
        ${e.map((t,r)=>this.renderTurn(t,r+1)).join(`
`)}
      </div>
    `}static renderTurn(e,t){const r=e.starred?"gv-print-turn-starred":"",o=e.userElement?Ht.extractUserContent(e.userElement).html||"<em>No content</em>":this.formatContent(e.user)||"<em>No content</em>",i=e.assistantElement?Ht.extractAssistantContent(e.assistantElement).html||"<em>No content</em>":this.formatContent(e.assistant)||"<em>No content</em>";if(!e.omitEmptySections)return`
      <div class="gv-print-turn ${r}">
        <div class="gv-print-turn-header">
          <span class="gv-print-turn-number">Turn ${t}</span>
          ${e.starred?'<span class="gv-print-star">â­</span>':""}
        </div>

        <div class="gv-print-turn-user">
          <div class="gv-print-turn-label">ğŸ‘¤ User</div>
          <div class="gv-print-turn-text">${o}</div>
        </div>

        <div class="gv-print-turn-assistant">
          <div class="gv-print-turn-label">ğŸ¤– Assistant</div>
          <div class="gv-print-turn-text">${i}</div>
        </div>
      </div>
    `;const s=!!e.userElement||!!e.user.trim(),a=!!e.assistantElement||!!e.assistant.trim();return`
      <div class="gv-print-turn ${r}">
        <div class="gv-print-turn-header">
          <span class="gv-print-turn-number">Turn ${t}</span>
          ${e.starred?'<span class="gv-print-star">â­</span>':""}
        </div>

        ${s?`
        <div class="gv-print-turn-user">
          <div class="gv-print-turn-label">ğŸ‘¤ User</div>
          <div class="gv-print-turn-text">${o}</div>
        </div>
        `:""}

        ${a?`
          <div class="gv-print-turn-assistant">
            <div class="gv-print-turn-label">ğŸ¤– Assistant</div>
            <div class="gv-print-turn-text">${i}</div>
          </div>
        `:""}
      </div>
    `}static formatContent(e){if(!e)return"<em>No content</em>";let t=this.escapeHTML(e);return t=t.split(`

`).map(r=>`<p>${r.replace(/\n/g,"<br>")}</p>`).join(""),t}static renderFooter(e){return`
      <div class="gv-print-footer">
        <p>Exported from <a href="https://github.com/Nagi-ovo/gemini-voyager">Gemini Voyager</a> â€¢ ${e.count} conversation turns</p>
        <p>Generated on ${this.formatDate(e.exportedAt)}</p>
      </div>
    `}static injectPrintStyles(e){if(document.getElementById(this.PRINT_STYLES_ID))return;const t=e??11,r=Math.max(t-2,6),o=Math.max(t-2,6),i=document.createElement("style");i.id=this.PRINT_STYLES_ID,i.textContent=`
      /* Hide print container on screen */
      .gv-print-only {
        display: none;
      }

      /* Show print container when printing */
      @media print {
        /* Hide everything except print container */
        body.${this.PRINT_BODY_CLASS} > *:not(#${this.PRINT_CONTAINER_ID}) {
          display: none !important;
          visibility: hidden !important;
        }

        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID} {
          display: block !important;
          visibility: visible !important;
        }

        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID},
        body.${this.PRINT_BODY_CLASS} #${this.PRINT_CONTAINER_ID} * {
          visibility: visible !important;
        }

        /* Force white print canvas to avoid dark-theme background leaks on trailing pages */
        html,
        body {
          background: #fff !important;
        }

        body.${this.PRINT_BODY_CLASS} {
          background: #fff !important;
        }

        /* Reset page styles */
        @page {
          margin: 2cm;
          size: A4;
        }

        /* Document container */
        .gv-print-document {
          font-family: Georgia, 'Times New Roman', serif;
          font-size: ${t}pt;
          line-height: 1.6;
          color: #000;
          background: #fff;
          max-width: 100%;
        }

        /* Cover Page Header */
        .gv-print-cover-page {
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          page-break-after: always;
          margin: 0;
          padding: 0;
          border: none;
        }

        .gv-print-cover-content {
          text-align: center;
          max-width: 80%;
        }

        .gv-print-cover-title {
          font-size: 36pt;
          font-weight: 800;
          letter-spacing: -0.02em;
          margin: 0 0 1.5em 0;
          color: oklch(0.7227 0.1920 149.5793);
          line-height: 1.2;
          word-wrap: break-word;
        }

        .gv-print-meta {
          font-size: 12pt;
          color: #666;
          line-height: 2;
          margin-top: 0.5em;
        }

        .gv-print-meta p {
          margin: 0.3em 0;
        }

        .gv-print-meta a {
          color: #666;
          text-decoration: none;
        }

        .gv-print-meta a:after {
          content: none !important;
        }

        /* Content */
        .gv-print-content {
          margin: 2em 0;
        }

        /* Turn */
        .gv-print-turn {
          margin-bottom: 2em;
          page-break-inside: avoid;
        }

        .gv-print-turn-header {
          display: flex;
          align-items: center;
          gap: 0.5em;
          margin-bottom: 0.5em;
          font-size: 12pt;
          font-weight: bold;
          color: #555;
        }

        .gv-print-turn-starred .gv-print-turn-header {
          color: #d97706;
        }

        .gv-print-star {
          font-size: 14pt;
        }

        /* Turn sections */
        .gv-print-turn-user,
        .gv-print-turn-assistant {
          margin: 1em 0;
        }

        .gv-print-turn-label {
          font-weight: 600;
          font-size: ${t}pt;
          margin-bottom: 0.5em;
          color: #222;
        }

        .gv-print-turn-text {
          padding-left: 1em;
          border-left: 3px solid #e5e7eb;
          color: #1a1a1a;
        }

        /* Constrain images to avoid oversized visuals */
        .gv-print-turn-text img {
          max-width: 60%;
          height: auto;
          display: block;
          margin: 0.5em 0;
          page-break-inside: avoid;
        }

        .gv-print-turn-assistant .gv-print-turn-text {
          border-left-color: #93c5fd;
        }

        .gv-print-turn-text p {
          margin: 0.5em 0;
        }

        .gv-print-turn-text em {
          color: #666;
        }

        /* Code blocks (if any) */
        .gv-print-turn-text code,
        .gv-print-turn-text pre {
          font-family: 'Courier New', monospace;
          font-size: ${r}pt;
          background: #f5f5f5;
          padding: 0.2em 0.4em;
          border-radius: 3px;
        }

        .gv-print-turn-text pre {
          padding: 0.75em;
          border-left: 3px solid #d1d5db;
          overflow-x: auto;
          white-space: pre-wrap;
          word-wrap: break-word;
        }

        /* Math formulas */
        .gv-print-turn-text .math-inline,
        .gv-print-turn-text .math-block,
        .gv-print-turn-text [data-math] {
          page-break-inside: avoid;
        }

        .gv-print-turn-text .math-block {
          display: block;
          margin: 1em 0;
          text-align: center;
          overflow-x: auto;
        }

        .gv-print-turn-text .math-inline {
          display: inline;
        }

        /* Footer */
        .gv-print-footer {
          margin-top: 2em;
          padding-top: 1em;
          border-top: 1px solid #ccc;
          font-size: ${o}pt;
          color: #666;
          text-align: center;
        }

        .gv-print-footer p {
          margin: 0.25em 0;
        }

        /* Links */
        a {
          color: #2563eb;
          text-decoration: none;
        }

        /* Hide Gemini inline source/citation chips (render as link icons) */
        sources-carousel-inline,
        source-inline-chips,
        source-inline-chip,
        .source-inline-chip-container {
          display: none !important;
        }

        a[href]:after {
          content: " (" attr(href) ")";
          font-size: ${o}pt;
          color: #666;
        }

        /* Utilities */
        strong {
          font-weight: 600;
        }
      }
    `,document.head.appendChild(i)}static cleanup(){if(this.cleanupFallbackTimer!==null){try{clearTimeout(this.cleanupFallbackTimer)}catch{}this.cleanupFallbackTimer=null}const e=document.getElementById(this.PRINT_CONTAINER_ID);e&&e.remove();try{document.body.classList.remove(this.PRINT_BODY_CLASS)}catch{}if(this.originalDocumentTitle!==null){try{document.title=this.originalDocumentTitle}catch{}this.originalDocumentTitle=null}}static extractTitleFromURL(e){try{const o=new URL(e).pathname.match(/\/(app|chat)\/([^/]+)/);return o?`Gemini Conversation ${o[2].substring(0,8)}`:"Gemini Conversation"}catch{return"Gemini Conversation"}}static formatDate(e){try{return new Date(e).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}static normalizeConversationTitle(e){if(!e)return"";const t=e.trim().replace(/\s+-\s+Gemini$/i,"").replace(/\s+-\s+Google Gemini$/i,"").replace(/\s+/g," ").trim();return this.isMeaningfulConversationTitle(t)?t:""}static getPrintDialogTitle(e,t){const r=this.normalizeConversationTitle(e.title),o=this.normalizeConversationTitle(this.getConversationTitle());if(t)return r||o||"Gemini Conversation";const i=o||r;return i?`${i} - Gemini`:"Gemini Conversation"}static escapeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}static escapeCssAttributeValue(e){const t=globalThis.CSS?.escape;return typeof t=="function"?t(e):e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}static escapeAttribute(e){return this.escapeHTML(e).replace(/"/g,"&quot;")}}class Zs{static REPORT_JSON_FORMAT="gemini-voyager.report.v1";static CHAT_JSON_FORMAT="gemini-voyager.chat.v1";static async export(e,t,r){try{if((r.layout??"conversation")==="document")return await this.exportDocument(e,t,r);switch(r.format){case"json":return this.exportJSON(e,t,r);case"markdown":return await this.exportMarkdown(e,t,r);case"pdf":return await this.exportPDF(e,t,r);case"image":return await this.exportImage(e,t,r);default:return{success:!1,format:r.format,error:`Unsupported format: ${r.format}`}}}catch(o){return{success:!1,format:r.format,error:o instanceof Error?o.message:String(o)}}}static async exportDocument(e,t,r){const o=this.extractDocumentContent(e);switch(r.format){case"json":return this.exportDocumentJSON(o,t,r);case"markdown":return await this.exportDocumentMarkdown(o,t,r);case"pdf":return await this.exportDocumentPDF(o,t,r);case"image":return await this.exportDocumentImage(o,t,r);default:return{success:!1,format:r.format,error:`Unsupported format: ${r.format}`}}}static exportJSON(e,t,r){const o=e.map(a=>{let l=a.user,d=a.assistant;if(a.userElement){const u=Ht.extractUserContent(a.userElement);u.text&&(l=u.text)}if(a.assistantElement){const u=Ht.extractAssistantContent(a.assistantElement);u.text&&(d=u.text)}return{user:l,assistant:d,starred:a.starred}}),i={format:this.CHAT_JSON_FORMAT,url:t.url,exportedAt:t.exportedAt,count:t.count,title:t.title,items:o},s=r.filename||this.generateFilename("json",t.title);return this.downloadJSON(i,s),{success:!0,format:"json",filename:s}}static async exportMarkdown(e,t,r){const o=qn.format(e,t),i=r.filename||this.generateFilename("md",t.title);return{success:!0,format:"markdown",filename:await this.downloadMarkdownOrZip(o,i,"chat.md")}}static async exportPDF(e,t,r){return await vp.export(e,t,{fontSize:r.fontSize}),{success:!0,format:"pdf",filename:r.filename||this.generateFilename("pdf",t.title)}}static async exportImage(e,t,r){const o=r.filename||this.generateFilename("png",t.title);return await Qa.export(e,t,{filename:o,fontSize:r.fontSize}),{success:!0,format:"image",filename:o}}static exportDocumentJSON(e,t,r){const o={format:this.REPORT_JSON_FORMAT,url:t.url,exportedAt:t.exportedAt,title:t.title,content:{markdown:e.markdown,html:e.html}},i=r.filename||this.generateFilename("json",t.title);return this.downloadJSON(o,i),{success:!0,format:"json",filename:i}}static async exportDocumentMarkdown(e,t,r){const o=this.composeDocumentMarkdown(e.markdown,t),i=r.filename||this.generateFilename("md",t.title),s=i.toLowerCase().endsWith(".md")&&i.split("/").pop()||"report.md";return{success:!0,format:"markdown",filename:await this.downloadMarkdownOrZip(o,i,s)}}static async exportDocumentPDF(e,t,r){return await Em.export({title:t.title||"Deep Research Report",url:t.url,exportedAt:t.exportedAt,markdown:e.markdown,html:e.html}),{success:!0,format:"pdf",filename:r.filename||this.generateFilename("pdf",t.title)}}static async exportDocumentImage(e,t,r){const o=r.filename||this.generateFilename("png",t.title);return await Qa.exportDocument({title:t.title||"Deep Research Report",url:t.url,exportedAt:t.exportedAt,markdown:e.markdown,html:e.html},{filename:o}),{success:!0,format:"image",filename:o}}static extractDocumentContent(e){const t=e.find(o=>o.assistantElement||o.assistant.trim())||e.find(o=>o.userElement||o.user.trim());if(!t)return{markdown:"",html:""};if(t.assistantElement){const o=Ht.extractAssistantContent(t.assistantElement);return{markdown:o.text||t.assistant,html:o.html||this.formatPlainTextAsHtml(o.text||t.assistant)}}if(t.userElement){const o=Ht.extractUserContent(t.userElement);return{markdown:o.text||t.user,html:o.html||this.formatPlainTextAsHtml(o.text||t.user)}}const r=t.assistant||t.user||"";return{markdown:r,html:this.formatPlainTextAsHtml(r)}}static composeDocumentMarkdown(e,t){const r=[],o=t.title?.trim()||"Deep Research Report",i=e.trim()||"_No content_";return this.hasLeadingMarkdownHeading(i)||(r.push(`# ${o}`),r.push("")),r.push(i),r.push(""),r.push("---"),r.push(""),r.push(`Source: ${t.url}`),r.push(`Exported at: ${t.exportedAt}`),r.join(`
`)}static hasLeadingMarkdownHeading(e){return/^#{1,6}\s+\S/m.test(e)&&/^#{1,6}\s+\S/.test(e)}static formatPlainTextAsHtml(e){return e.trim()?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").split(`

`).map(r=>`<p>${r.replace(/\n/g,"<br>")}</p>`).join(`
`):""}static async downloadMarkdownOrZip(e,t,r){const o=t.toLowerCase().endsWith(".md")?t:`${t}.md`;if(en()){const w=qn.degradeImageMarkdownForSafari(e);return qn.download(w,o),o}const i=qn.extractImageUrls(e);if(i.length===0)return qn.download(e,o),o;const s=new Gc,a=s.folder("assets"),l=new Map,d=await Promise.all(i.map(async w=>{const v=await this.fetchImageForMarkdownPackaging(w);return v?{url:w,blob:v.blob,contentType:v.contentType}:null}));let u=1;for(const w of d){if(!w)continue;const v=this.pickImageExtension(w.contentType,w.url),S=`img-${String(u++).padStart(3,"0")}.${v}`,C=await this.blobToBase64Payload(w.blob);C&&(a?.file(S,C,{base64:!0}),l.set(w.url,`assets/${S}`))}const m=qn.rewriteImageUrls(e,l);s.file(r,m);const p=await s.generateAsync({type:"blob"}),f=o.replace(/\.md$/i,".zip"),g=URL.createObjectURL(p),b=document.createElement("a");return b.href=g,b.download=f,document.body.appendChild(b),b.click(),setTimeout(()=>{try{document.body.removeChild(b)}catch{}URL.revokeObjectURL(g)},0),f}static pickImageExtension(e,t){const r={"image/png":"png","image/jpeg":"jpg","image/jpg":"jpg","image/webp":"webp","image/gif":"gif","image/svg+xml":"svg"};if(e&&r[e])return r[e];const o=t.split("?")[0].match(/\.(png|jpg|jpeg|gif|webp|svg)$/i);return o?o[1].toLowerCase()==="jpeg"?"jpg":o[1].toLowerCase():"bin"}static blobToBase64Payload(e){return new Promise(t=>{try{const r=new FileReader;r.onload=()=>{const o=String(r.result||""),i=o.indexOf(",");t(i>=0?o.slice(i+1):null)},r.onerror=()=>t(null),r.readAsDataURL(e)}catch{t(null)}})}static async fetchImageForMarkdownPackaging(e){try{const o=await fetch(e,{credentials:"include",mode:"cors"});if(o.ok)return{blob:await o.blob(),contentType:o.headers.get("Content-Type")}}catch{}const t=o=>{if(!(o&&o.ok&&typeof o.base64=="string"))return null;const i=String(o.contentType||"application/octet-stream"),s=atob(o.base64),a=s.length,l=new Uint8Array(a);for(let d=0;d<a;d++)l[d]=s.charCodeAt(d);return{blob:new Blob([l],{type:i}),contentType:i}},r=async o=>{const i=chrome.runtime?.sendMessage;return typeof i!="function"?null:await new Promise(s=>{try{i({type:o,url:e},a=>{s(a??null)})}catch{s(null)}})};try{const o=await r("gv.fetchImage"),i=t(o);if(i)return i}catch{}if(e.startsWith("blob:"))return null;try{const o=await r("gv.fetchImageViaPage"),i=t(o);if(i)return i}catch{}return null}static downloadJSON(e,t){const r=new Blob([JSON.stringify(e,null,2)],{type:"application/json;charset=utf-8"}),o=URL.createObjectURL(r),i=document.createElement("a");i.href=o,i.download=t,document.body.appendChild(i),i.click(),setTimeout(()=>{try{document.body.removeChild(i)}catch{}URL.revokeObjectURL(o)},0)}static generateFilename(e,t){const r=this.sanitizeFilenamePart(t);if(r)return`${r}.${e}`;const o=p=>String(p).padStart(2,"0"),i=new Date,s=i.getFullYear(),a=o(i.getMonth()+1),l=o(i.getDate()),d=o(i.getHours()),u=o(i.getMinutes()),m=o(i.getSeconds());return`gemini-chat-${s}${a}${l}-${d}${u}${m}.${e}`}static sanitizeFilenamePart(e){if(!e)return"";const t=e.trim().replace(/\s+/g," ");return t?t.replace(/[\\/:*?"<>|]/g,"").replace(/\s+/g,"-").replace(/\.+$/g,"").slice(0,80):""}static getAvailableFormats(){return[{format:"json",label:"JSON",description:"Machine-readable format for developers"},{format:"markdown",label:"Markdown",description:"Clean, portable text format (recommended)",recommended:!0},{format:"pdf",label:"PDF",description:"Print-friendly format via Save as PDF"},{format:"image",label:"Image",description:"Single PNG image for sharing"}]}}const el=11,yp=20,tl=8,nl=16,wp=14,xp=28;class ed{overlay=null;selectedFormat="markdown";fontSize=el;show(e){this.overlay=this.createDialog(e),document.body.appendChild(this.overlay),this.overlay.querySelector(".gv-export-dialog")?.focus()}hide(){this.overlay&&(this.overlay.remove(),this.overlay=null)}createDialog(e){const t=document.createElement("div");t.className="gv-export-dialog-overlay";const r=document.createElement("div");r.className="gv-export-dialog",r.tabIndex=-1;const o=document.createElement("div");o.className="gv-export-dialog-title",o.textContent=e.translations.title;const i=document.createElement("div");i.className="gv-export-dialog-subtitle",i.textContent=e.translations.selectFormat;const s=document.createElement("div");s.className="gv-export-format-list",Zs.getAvailableFormats().forEach(f=>{const g=e.translations.formatDescriptions[f.format]||f.description,b=this.createFormatOption({...f,description:g},e.translations.safariCmdpHint,e.translations.safariMarkdownHint);s.appendChild(b)});const l=this.createFontSizeSection(e),d=document.createElement("div");d.className="gv-export-dialog-buttons";const u=document.createElement("button");u.className="gv-export-dialog-btn gv-export-dialog-btn-secondary",u.textContent=e.translations.cancel,u.addEventListener("click",()=>{e.onCancel(),this.hide()});const m=document.createElement("button");if(m.className="gv-export-dialog-btn gv-export-dialog-btn-primary",m.textContent=e.translations.export,m.addEventListener("click",()=>{const f=this.selectedFormat==="pdf"||this.selectedFormat==="image";e.onExport(this.selectedFormat,f?this.fontSize:void 0),this.hide()}),d.appendChild(u),d.appendChild(m),r.appendChild(o),r.appendChild(i),e.translations.warning.trim()){const f=document.createElement("div");f.className="gv-export-dialog-warning",f.textContent=e.translations.warning,r.appendChild(f)}r.appendChild(s),r.appendChild(l),r.appendChild(d),t.appendChild(r),t.addEventListener("click",f=>{f.target===t&&(e.onCancel(),this.hide())});const p=f=>{f.key==="Escape"&&(e.onCancel(),this.hide(),document.removeEventListener("keydown",p))};return document.addEventListener("keydown",p),t}createFormatOption(e,t,r){const o=document.createElement("label");o.className="gv-export-format-option";const i=document.createElement("input");i.type="radio",i.name="export-format",i.value=e.format,i.checked=e.format==="markdown",i.checked&&(this.selectedFormat=e.format),i.addEventListener("change",()=>{i.checked&&(this.selectedFormat=e.format,this.updateFontSizeSection())});const s=document.createElement("div");s.className="gv-export-format-content";const a=document.createElement("div");if(a.className="gv-export-format-label",a.textContent=e.label,e.recommended){const u=document.createElement("span");u.className="gv-export-format-badge",u.textContent="Recommended",a.appendChild(u)}const l=document.createElement("div");l.className="gv-export-format-description";let d=e.description;return en()&&(e.format==="pdf"?d=`${e.description} ${t}`:(e.format==="markdown"||e.format==="image")&&(d=`${e.description} ${r}`)),l.textContent=d,s.appendChild(a),s.appendChild(l),o.appendChild(i),o.appendChild(s),o}createFontSizeSection(e){const t=document.createElement("div");t.className="gv-export-fontsize-section",t.style.display="none";const r=document.createElement("div");r.className="gv-export-fontsize-header";const o=document.createElement("span");o.className="gv-export-fontsize-label",o.textContent=e.translations.fontSizeLabel;const i=document.createElement("span");i.className="gv-export-fontsize-value",i.textContent=`${this.fontSize}pt`,r.appendChild(o),r.appendChild(i);const s=document.createElement("input");s.type="range",s.className="gv-export-fontsize-slider",s.min=String(tl),s.max=String(nl),s.step="1",s.value=String(this.fontSize);const a=document.createElement("div");return a.className="gv-export-fontsize-preview",a.textContent=e.translations.fontSizePreview,a.style.fontSize=`${this.fontSize}pt`,s.addEventListener("input",()=>{this.fontSize=Number(s.value);const l=this.selectedFormat==="image"?"px":"pt";i.textContent=`${this.fontSize}${l}`,a.style.fontSize=`${this.fontSize}${l}`}),t.appendChild(r),t.appendChild(s),t.appendChild(a),t}updateFontSizeSection(){if(!this.overlay)return;const e=this.overlay.querySelector(".gv-export-fontsize-section");if(!e)return;const t=this.selectedFormat==="pdf",r=this.selectedFormat==="image";if(!t&&!r){e.style.display="none";return}e.style.display="block";const o=e.querySelector(".gv-export-fontsize-slider"),i=e.querySelector(".gv-export-fontsize-value"),s=e.querySelector(".gv-export-fontsize-preview");t?(this.fontSize=el,o&&(o.min=String(tl),o.max=String(nl),o.value=String(this.fontSize)),i&&(i.textContent=`${this.fontSize}pt`),s&&(s.style.fontSize=`${this.fontSize}pt`)):(this.fontSize=yp,o&&(o.min=String(wp),o.max=String(xp),o.value=String(this.fontSize)),i&&(i.textContent=`${this.fontSize}px`),s&&(s.style.fontSize=`${this.fontSize}px`))}}const Sp=".gv-export-toast",Ep=300,Cp=2200;let io=null;function Tp(){const n=document.querySelector(Sp);if(n instanceof HTMLDivElement)return n;const e=document.createElement("div");return e.className="gv-notification gv-notification-info gv-export-toast",document.body.appendChild(e),e}function td(n,e){if(!n)return;const t=Tp();t.textContent=n,t.classList.add("show"),io&&(clearTimeout(io),io=null);const r=Math.max(e?.autoDismissMs??Cp,0);io=setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.classList.contains("show")||t.remove()},Ep)},r)}function st(n){if(!n||typeof n!="object")return{};const e=n,t=e.default&&typeof e.default=="object"?e.default:n,r={};for(const[o,i]of Object.entries(t)){if(!i||typeof i!="object")continue;const s=i.message;typeof s=="string"&&(r[o]=s)}return r}function _p(){const n=l=>String(l).padStart(2,"0"),e=new Date,t=e.getFullYear(),r=n(e.getMonth()+1),o=n(e.getDate()),i=n(e.getHours()),s=n(e.getMinutes()),a=n(e.getSeconds());return`deep-research-thinking-${t}${r}${o}-${i}${s}${a}.md`}function kp(n){try{const e=new Blob([n],{type:"text/markdown;charset=utf-8"}),t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download=_p(),document.body.appendChild(r),r.click(),setTimeout(()=>{try{document.body.removeChild(r)}catch(o){console.error("[Gemini Voyager] Error removing download link:",o)}URL.revokeObjectURL(t)},100),console.log("[Gemini Voyager] Deep Research thinking content downloaded successfully")}catch(e){console.error("[Gemini Voyager] Error downloading markdown:",e)}}function Ap(n){try{const e=n.querySelector(".thought-header"),t=n.querySelector(".gds-body-m.gds-italic:not(.thought-header)");if(!e||!t)return null;const r=e.textContent?.trim()||"",o=t.textContent?.trim()||"";return!r&&!o?null:{header:r,content:o}}catch(e){return console.error("[Gemini Voyager] Error extracting thought item:",e),null}}function Ip(n){try{const e=[];return n.querySelectorAll('browse-web-chip a[data-test-id="browse-chip-link"]').forEach(r=>{try{const o=r.getAttribute("href")||"",i=r.querySelector('[data-test-id="domain-name"]'),s=r.querySelector('[data-test-id="title"]'),a=i?.textContent?.trim()||"",l=s?.textContent?.trim()||"";o&&a&&e.push({url:o,domain:a,title:l})}catch(o){console.error("[Gemini Voyager] Error extracting browse chip:",o)}}),e}catch(e){return console.error("[Gemini Voyager] Error extracting browse chips:",e),[]}}function Lp(n){try{const e=[];return n.querySelectorAll(".item-container").forEach(r=>{const o=r.querySelector("thought-item");if(o){const s=Ap(o);s&&e.push({type:"thought",header:s.header,content:s.content})}const i=r.querySelector("browse-chip-list");if(i){const s=Ip(i);s.length>0&&e.push({type:"browse-chips",chips:s})}}),e.length===0?null:{items:e}}catch(e){return console.error("[Gemini Voyager] Error extracting thinking section:",e),null}}function Dp(){try{const n=document.querySelector("deep-research-immersive-panel");if(!n)return console.log("[Gemini Voyager] Not a Deep Research conversation"),null;const e=[];if(n.querySelectorAll("thinking-panel").forEach(o=>{const i=Lp(o);i&&e.push(i)}),e.length===0)return console.log("[Gemini Voyager] No thinking content found"),null;const r=Mp();return{sections:e,exportedAt:new Date().toISOString(),title:r}}catch(n){return console.error("[Gemini Voyager] Error extracting thinking panels:",n),null}}function Mp(){try{const n=document.querySelector("title");if(n){const t=n.textContent?.trim();if(t&&t!=="Gemini"&&t!=="Google Gemini"&&!t.startsWith("Gemini -")&&t.length>0)return t}const e=["mat-list-item.mdc-list-item--activated [mat-line]",'mat-list-item[aria-current="page"] [mat-line]',".conversation-list-item.active .conversation-title"];for(const t of e){const r=document.querySelector(t);if(r?.textContent?.trim()&&r.textContent.trim()!=="New chat")return r.textContent.trim()}}catch(n){console.error("[Gemini Voyager] Error getting conversation title:",n)}return"Deep Research Conversation"}function Np(n,e){if(!n&&!e)return"";const t=[];return n&&t.push(`### ${n}
`),e&&t.push(e),t.join(`
`)}function Fp(n){if(n.length===0)return"";const e=[`#### ç ”ç©¶ç½‘ç«™ / Researched Websites
`];return n.forEach(t=>{const r=t.title?` - ${t.title}`:"";e.push(`- [${t.domain}](${t.url})${r}`)}),e.join(`
`)}function Op(n){return n.type==="thought"?Np(n.header,n.content):n.type==="browse-chips"?Fp(n.chips):""}function Rp(n,e){const t=[];return t.push(`## æ€è€ƒé˜¶æ®µ ${e+1} / Thinking Phase ${e+1}
`),n.items.forEach(r=>{const o=Op(r);o&&(t.push(o),t.push(""))}),t.join(`
`)}function Pp(n){try{const e=new Date(n),t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");return`${t}-${r}-${o} ${i}:${s}:${a}`}catch(e){return console.error("[Gemini Voyager] Error formatting timestamp:",e),n}}function Bp(n){const e=[];return e.push(`# ${n.title}
`),e.push(`**å¯¼å‡ºæ—¶é—´ / Exported At:** ${Pp(n.exportedAt)}
`),e.push(`**æ€»æ€è€ƒé˜¶æ®µ / Total Phases:** ${n.sections.length}
`),e.push(`---
`),n.sections.forEach((t,r)=>{const o=Rp(t,r);o&&(e.push(o),r<n.sections.length-1&&e.push(`---
`))}),e.push(`
---
`),e.push("*Generated by [Gemini Voyager](https://github.com/Nagi-ovo/gemini-voyager)*"),e.join(`
`)}const $p=new Set(["Gemini","Google Gemini","Google AI Studio","New chat","Deep Research"]);function rl(n){const e=n.trim();return!(!e||$p.has(e)||e.startsWith("Gemini -")||e.startsWith("Google AI Studio -"))}function qp(n){return(n.textContent||"").trim().length}function zp(){const n=document.querySelector("deep-research-immersive-panel");if(!n)return null;const e=Array.from(n.querySelectorAll(".markdown, .markdown-main-panel, message-content")).filter(r=>!r.closest("thinking-panel"));let t=null;for(const r of e){const o=qp(r);o!==0&&(!t||o>t.score)&&(t={el:r,score:o})}return t?.el??null}function Up(n){const t=(n.querySelector("h1")||n.querySelector("h2")||n.querySelector('[role="heading"]'))?.textContent?.trim()||"";if(rl(t))return t;const r=document.title||"";return rl(r)?r.trim():"Deep Research Report"}function Hp(n,e=5e3){return new Promise(t=>{const r=document.querySelector(n);if(r)return t(r);const o=new MutationObserver(()=>{const i=document.querySelector(n);i&&(o.disconnect(),t(i))});o.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{o.disconnect(),t(null)},e)})}async function Gp(){try{const[n,e,t,r,o,i,s,a,l,d]=await Promise.all([Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.h),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.r),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.t),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.l),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.k),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.j),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.p),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.m),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.q),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.o),__vite__mapDeps([0,1]))]);return{en:st(n),zh:st(e),zh_TW:st(t),ja:st(r),fr:st(o),es:st(i),pt:st(s),ar:st(a),ru:st(l),ko:st(d)}}catch(n){return console.error("[Gemini Voyager] Error loading dictionaries:",n),{en:{},zh:{},zh_TW:{},ja:{},fr:{},es:{},pt:{},ar:{},ru:{},ko:{}}}}function ol(n,e,t){const r=a=>e[t]?.[a]??e.en?.[a]??a,o=r("deepResearchDownload"),i=r("deepResearchDownloadTooltip");n.title=i,n.setAttribute("aria-label",i);const s=n.querySelector(".mat-mdc-menu-item-text");s&&(s.textContent=` ${o}`)}function il(n,e,t){const r=a=>e[t]?.[a]??e.en?.[a]??a,o=r("deepResearchSaveReport"),i=r("deepResearchSaveReportTooltip");n.title=i,n.setAttribute("aria-label",i);const s=n.querySelector(".mat-mdc-menu-item-text");s&&(s.textContent=` ${o}`)}async function nd(){try{const n=await new Promise(r=>{try{const o=window;o.chrome?.storage?.sync?.get?o.chrome.storage.sync.get(ke.LANGUAGE,r):o.browser?.storage?.sync?.get?o.browser.storage.sync.get(ke.LANGUAGE).then(r).catch(()=>r({})):r({})}catch{r({})}}),e=n&&typeof n=="object"?n:{},t=typeof e[ke.LANGUAGE]=="string"?e[ke.LANGUAGE]:void 0;return Bo(t||navigator.language||"en")}catch{return"en"}}function jp(){try{console.log("[Gemini Voyager] Extracting Deep Research thinking content...");const n=Dp();if(!n){console.warn("[Gemini Voyager] No thinking content found");return}const e=Bp(n);kp(e)}catch(n){console.error("[Gemini Voyager] Error handling download:",n)}}function rd({text:n,tooltip:e,className:t,iconName:r,onClick:o}){const i=document.createElement("button");i.className=`mat-mdc-menu-item mat-focus-indicator menu-item-button ${t}`,i.setAttribute("mat-menu-item",""),i.setAttribute("role","menuitem"),i.setAttribute("tabindex","0"),i.setAttribute("aria-disabled","false"),i.setAttribute("aria-label",e),i.title=e;const s=document.createElement("mat-icon");s.className="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color",s.setAttribute("role","img"),s.setAttribute("fonticon",r),s.setAttribute("aria-hidden","true"),s.textContent=r;const a=document.createElement("span");a.className="mat-mdc-menu-item-text",a.textContent=` ${n}`;const l=document.createElement("div");return l.className="mat-ripple mat-mdc-menu-ripple",l.setAttribute("matripple",""),i.appendChild(s),i.appendChild(a),i.appendChild(l),i.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),o()}),i}function Wp(n,e){return rd({text:n,tooltip:e,className:"gv-deep-research-download",iconName:"download",onClick:jp})}function Vp(n){return n.trim().replace(/[\\/:*?"<>|]/g,"").replace(/\s+/g,"-").replace(/\.+$/g,"").slice(0,80)||"deep-research-report"}function Yp(n,e){const t=Vp(e||"deep-research-report");return n==="json"?`${t}.json`:n==="markdown"?`${t}.md`:n==="pdf"?`${t}.pdf`:`${t}.png`}function Kp(n){const e=document.createElement("div");e.className="gv-export-progress-overlay";const t=document.createElement("div");t.className="gv-export-progress-card";const r=document.createElement("div");r.className="gv-export-progress-spinner";const o=document.createElement("div");o.className="gv-export-progress-title",o.textContent=`${n("pm_export")}...`;const i=document.createElement("div");return i.className="gv-export-progress-desc",i.textContent=n("loading"),t.appendChild(r),t.appendChild(o),t.appendChild(i),e.appendChild(t),document.body.appendChild(e),()=>{try{e.remove()}catch{}}}function Zp(n,e){const t=zp();if(!t){console.warn("[Gemini Voyager] Report content root not found");return}const r=Up(t),o={url:location.href,exportedAt:new Date().toISOString(),count:1,title:r},i=[{user:"",assistant:"",starred:!1,omitEmptySections:!0,assistantElement:t}],s=l=>n[e]?.[l]??n.en?.[l]??l;new ed().show({onExport:async l=>{const d=Kp(s);try{const u=Yp(l,r),m=Zs.export(i,o,{format:l,filename:u,layout:"document"}),p=new Promise(g=>setTimeout(g,420)),[f]=await Promise.all([m,p]);f.success?l==="pdf"&&en()&&td(s("export_toast_safari_pdf_ready"),{autoDismissMs:5e3}):alert(`${s("export_dialog_warning")}: ${f.error}`)}catch(u){console.error("[Gemini Voyager] Report export error:",u),alert("Export error occurred.")}finally{d()}},onCancel:()=>{},translations:{title:s("deepResearchSaveReport"),selectFormat:s("export_dialog_select"),warning:"",safariCmdpHint:s("export_dialog_safari_cmdp_hint"),safariMarkdownHint:s("export_dialog_safari_markdown_hint"),cancel:s("pm_cancel"),export:s("pm_export"),fontSizeLabel:s("export_fontsize_label"),fontSizePreview:s("export_fontsize_preview"),formatDescriptions:{json:s("export_format_json_description"),markdown:s("export_format_markdown_description"),pdf:s("export_format_pdf_description"),image:s("export_format_image_description")}}})}function Xp(n,e,t){return rd({text:n,tooltip:e,className:"gv-deep-research-save-report",iconName:"description",onClick:()=>{nd().then(r=>{Zp(t,r)})}})}function Jp(){const n=window;return n.chrome?.storage??n.browser?.storage??null}async function Qp(){try{const n=await Gp(),e=await nd(),t=d=>n[e]?.[d]??n.en?.[d]??d,r=await Hp('.mat-mdc-menu-panel[role="menu"]');if(!r){console.log("[Gemini Voyager] Menu panel not found");return}const o=r.querySelector(".mat-mdc-menu-content");if(!o){console.log("[Gemini Voyager] Menu content not found");return}let i=r.querySelector(".gv-deep-research-download");i||(i=Wp(t("deepResearchDownload"),t("deepResearchDownloadTooltip")),o.appendChild(i));let s=r.querySelector(".gv-deep-research-save-report");s||(s=Xp(t("deepResearchSaveReport"),t("deepResearchSaveReportTooltip"),n),o.appendChild(s)),ol(i,n,e),il(s,n,e);const l=Jp()?.onChanged;if(l?.addListener&&l?.removeListener){let d=e;const u=(f,g)=>{if(g!=="sync")return;const b=f?.[ke.LANGUAGE]?.newValue;typeof b=="string"&&(d=Bo(b),ol(i,n,d),il(s,n,d))};l.addListener(u);const m=()=>{try{l.removeListener(u)}catch{}},p=new MutationObserver(()=>{const f=!document.contains(i),g=!document.contains(s);f&&g&&(m(),p.disconnect())});p.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{m();try{p.disconnect()}catch{}},{once:!0})}console.log("[Gemini Voyager] Deep Research menu buttons injected successfully")}catch(n){console.error("[Gemini Voyager] Error injecting Deep Research menu buttons:",n)}}function ef(){return!!document.querySelector("deep-research-immersive-panel")}function tf(){new MutationObserver(e=>{for(const t of e)t.addedNodes.forEach(r=>{r instanceof HTMLElement&&(r.matches('.mat-mdc-menu-panel[role="menu"]')||r.querySelector('.mat-mdc-menu-panel[role="menu"]'))&&ef()&&setTimeout(()=>{Qp()},50)})}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Gemini Voyager] Deep Research export observer initialized")}function nf(){try{if(location.hostname!=="gemini.google.com")return;console.log("[Gemini Voyager] Initializing Deep Research export feature"),tf()}catch(n){console.error("[Gemini Voyager] Error starting Deep Research export:",n)}}const rf=new Set(["56fdd199312815e2"]),of=["flash","2.0 flash","gemini 2.0 flash","fast","é«˜é€Ÿ","é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰"];class Wn{static instance;observer=null;checkTimer=null;isLocked=!1;currentDefaultModel=null;initialized=!1;pendingMenuPanelInjections=new WeakSet;menuPanelInjectAttempts=new WeakMap;started=!1;popStateHandler=null;originalPushState=null;originalReplaceState=null;lastCheckedPath=null;sidebarClickHandler=null;urlCheckTimer=null;autoSelectSessionId=null;consecutiveFailures=0;maxConsecutiveFailures=3;constructor(){}static getInstance(){return Wn.instance||(Wn.instance=new Wn),Wn.instance}async init(){if(this.started)return;this.started=!0;const e=await Pn.get(ke.DEFAULT_MODEL);this.currentDefaultModel=e.success?this.parseStoredDefaultModel(e.data):null,this.initialized=!0,this.initObserver(),this.checkAndLockModel(),this.popStateHandler=()=>{this.checkAndLockModelWithDelay()},window.addEventListener("popstate",this.popStateHandler),this.originalPushState||(this.originalPushState=history.pushState),this.originalReplaceState||(this.originalReplaceState=history.replaceState),history.pushState=(...t)=>{this.originalPushState?.apply(history,t),this.checkAndLockModelWithDelay()},history.replaceState=(...t)=>{this.originalReplaceState?.apply(history,t),this.checkAndLockModelWithDelay()},this.sidebarClickHandler=t=>{t.target.closest('a[href*="/app"]')&&this.checkAndLockModelWithDelay()},document.addEventListener("click",this.sidebarClickHandler,!0),this.urlCheckTimer=window.setInterval(()=>{const t=window.location.pathname;t!==this.lastCheckedPath&&this.isNewConversation()&&(this.lastCheckedPath=t,this.checkAndLockModel())},500)}destroy(){this.started&&(this.started=!1,this.observer&&(this.observer.disconnect(),this.observer=null),this.checkTimer&&(clearInterval(this.checkTimer),this.checkTimer=null),this.urlCheckTimer&&(clearInterval(this.urlCheckTimer),this.urlCheckTimer=null),this.popStateHandler&&(window.removeEventListener("popstate",this.popStateHandler),this.popStateHandler=null),this.sidebarClickHandler&&(document.removeEventListener("click",this.sidebarClickHandler,!0),this.sidebarClickHandler=null),this.originalPushState&&(history.pushState=this.originalPushState,this.originalPushState=null),this.originalReplaceState&&(history.replaceState=this.originalReplaceState,this.originalReplaceState=null),this.pendingMenuPanelInjections=new WeakSet,this.menuPanelInjectAttempts=new WeakMap)}initObserver(){this.observer=new MutationObserver(e=>{for(const t of e)for(const r of Array.from(t.addedNodes)){if(!(r instanceof HTMLElement))continue;const o=r.matches('.mat-mdc-menu-panel[role="menu"]')?r:r.querySelector('.mat-mdc-menu-panel[role="menu"]');o&&this.scheduleMenuPanelInjection(o)}}),this.observer.observe(document.body,{childList:!0,subtree:!0})}getModeSwitchMenuPanel(){return document.querySelector('.mat-mdc-menu-panel.gds-mode-switch-menu[role="menu"]')??document.querySelector('.mat-mdc-menu-panel[role="menu"]')}async waitForModeSwitchMenuPanel(e){const t=Date.now(),r=50;for(;Date.now()-t<e;){const o=this.getModeSwitchMenuPanel();if(o?.isConnected)return o;await new Promise(i=>window.setTimeout(i,r))}return null}scheduleMenuPanelInjection(e){if(this.pendingMenuPanelInjections.has(e))return;this.pendingMenuPanelInjections.add(e),window.setTimeout(()=>{this.started&&(this.pendingMenuPanelInjections.delete(e),this.injectStarButtons(e).then(r=>{if(r){this.menuPanelInjectAttempts.delete(e);return}if(!e.isConnected)return;const o=(this.menuPanelInjectAttempts.get(e)??0)+1;this.menuPanelInjectAttempts.set(e,o),o<10&&this.scheduleMenuPanelInjection(e)}))},50)}async injectStarButtons(e){const t=e.querySelectorAll('[role="menuitemradio"]');if(!t.length)return!1;if(!this.initialized){const o=await Pn.get(ke.DEFAULT_MODEL);this.currentDefaultModel=o.success?this.parseStoredDefaultModel(o.data):null,this.initialized=!0}const r=this.currentDefaultModel;return t.forEach(o=>{const i=this.getModelNameFromItem(o);if(!i)return;if(o.querySelector(".gv-default-star-btn")){this.updateStarState(o,i,r);return}const s=document.createElement("button");s.className="gv-default-star-btn",s.innerHTML=this.getStarIcon(!1),s.title=chrome.i18n.getMessage("setAsDefaultModel"),s.addEventListener("click",async l=>{l.stopPropagation(),l.preventDefault(),await this.handleStarClick(i,s)});const a=o.querySelector(".title-and-description");if(a){const l=a.querySelector(".mode-title");if(l){let d=a.querySelector(".gv-title-wrapper");d||(d=document.createElement("div"),d.className="gv-title-wrapper",d.style.cssText="display: flex; align-items: center; width: 100%;",a.insertBefore(d,l),d.appendChild(l)),d.appendChild(s)}else a.appendChild(s)}else o.appendChild(s);this.updateStarState(o,i,r)}),!0}getModelNameFromItem(e){return e.querySelector(".mode-title")?.textContent?.trim()||""}getModelIdFromItem(e){const t=e.getAttribute("data-mode-id")||e.dataset.modeId;if(typeof t!="string")return null;const r=t.trim();return r.length?r:null}isDefaultForItem(e,t,r){return e?e.kind==="id"?this.getModelIdFromItem(t)===e.id:e.name===r:!1}updateStarState(e,t,r){const o=e.querySelector(".gv-default-star-btn");if(!o)return;o.hasAttribute("data-event-bound")||(o.setAttribute("data-event-bound","true"),o.addEventListener("mousedown",s=>s.stopPropagation()),o.addEventListener("click",s=>s.stopPropagation())),this.isDefaultForItem(r,e,t)?(o.classList.add("is-default"),o.innerHTML=this.getStarIcon(!0),o.title=chrome.i18n.getMessage("cancelDefaultModel")):(o.classList.remove("is-default"),o.innerHTML=this.getStarIcon(!1),o.title=chrome.i18n.getMessage("setAsDefaultModel"))}getStarIcon(e){return e?'<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="currentColor"></path></svg>':'<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="none" stroke="currentColor" stroke-width="1.5"></path></svg>'}async handleStarClick(e,t){const r=t.closest('[role="menuitemradio"]'),o=r instanceof HTMLElement?r:null,i=o?this.getModelIdFromItem(o):null,s=o?this.isDefaultForItem(this.currentDefaultModel,o,e):this.currentDefaultModel?.kind==="name"?this.currentDefaultModel.name===e:!1,a=s?null:i?{kind:"id",id:i,name:e}:{kind:"name",name:e};this.currentDefaultModel=a,o&&this.updateStarState(o,e,a),a?this.showToast(chrome.i18n.getMessage("defaultModelSet",[e])):this.showToast(chrome.i18n.getMessage("defaultModelCleared"));const l=document.querySelector(".mat-mdc-menu-panel");if(l&&this.injectStarButtons(l),s)await Pn.remove(ke.DEFAULT_MODEL);else if(a?.kind==="id"){const d={id:a.id,name:a.name};await Pn.set(ke.DEFAULT_MODEL,d)}else await Pn.set(ke.DEFAULT_MODEL,e)}showToast(e){const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 10000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: opacity 0.3s;
    `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>t.remove(),300)},3e3)}async checkAndLockModelWithDelay(){await new Promise(e=>window.setTimeout(e,150)),this.checkAndLockModel()}async checkAndLockModel(){if(!this.isNewConversation())return;this.lastCheckedPath=window.location.pathname;const e=await Pn.get(ke.DEFAULT_MODEL),t=e.success?this.parseStoredDefaultModel(e.data):null;if(this.currentDefaultModel=t,this.initialized=!0,!t||this.isFastModel(t))return;const r=`${window.location.pathname}-${Date.now()}`;this.autoSelectSessionId=r,this.consecutiveFailures=0;let o=0;const i=20;this.checkTimer&&clearInterval(this.checkTimer),this.checkTimer=window.setInterval(async()=>{if(this.autoSelectSessionId!==r){this.checkTimer&&clearInterval(this.checkTimer);return}if(o++,o>i){this.checkTimer&&clearInterval(this.checkTimer);return}await this.tryLockToModel(t)},1e3)}isNewConversation(){const e=window.location.pathname;return/^\/(u\/\d+\/)?app\/?$/.test(e)}isFastModel(e){if(e.kind==="id")return rf.has(e.id);const t=e.name.toLowerCase().trim();return of.some(r=>t===r||t.includes(r))}async tryLockToModel(e){const t=d=>d.toLowerCase().trim(),r=d=>d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=t(e.name),i=new RegExp(`(^|\\b)${r(o)}(\\b|$)`,"i"),s=document.querySelector(".input-area-switch-label")||document.querySelector('[data-test-id="model-selector"]')||document.querySelector('button[aria-haspopup="menu"].mat-mdc-menu-trigger');if(!s)return;const a=s.textContent||"",l=t(a);if(i.test(l)||l===o){this.checkTimer&&clearInterval(this.checkTimer);return}if(!this.isLocked){this.isLocked=!0;try{s.click();const d=await this.waitForModeSwitchMenuPanel(1500);if(!d)return;const u=d.querySelectorAll('[role="menuitemradio"]');let m=!1;if(e.kind==="id"){const p=Array.from(u).find(f=>f instanceof HTMLElement?this.getModelIdFromItem(f)===e.id:!1);p instanceof HTMLElement&&(p.getAttribute("aria-checked")==="true"||p.classList.contains("is-selected")?document.body.click():p.click(),m=!0)}else for(const p of Array.from(u)){const f=this.getModelNameFromItem(p);if(t(f)===o){p.getAttribute("aria-checked")==="true"||p.classList.contains("is-selected")?document.body.click():p.click(),m=!0;break}}if(!m)for(const p of Array.from(u)){const f=p.textContent||"";if(i.test(t(f))){p.getAttribute("aria-checked")==="true"||p.classList.contains("is-selected")?document.body.click():p.click(),m=!0;break}}m&&this.checkTimer&&(clearInterval(this.checkTimer),this.consecutiveFailures=0),m||(document.body.click(),this.consecutiveFailures++,this.consecutiveFailures>=this.maxConsecutiveFailures&&this.checkTimer&&clearInterval(this.checkTimer))}catch(d){console.error("Auto lock failed",d)}finally{this.isLocked=!1}}}parseStoredDefaultModel(e){if(typeof e=="string"){const t=e.trim();return t.length?{kind:"name",name:t}:null}if(this.isStoredDefaultModelSetting(e)){const t=e.id.trim(),r=e.name.trim();return!t.length||!r.length?null:{kind:"id",id:t,name:r}}return null}isStoredDefaultModelSetting(e){if(typeof e!="object"||e===null)return!1;const t=e;return typeof t.id=="string"&&typeof t.name=="string"}}const Xi="gemini-voyager-edit-input-width",Tr=60,sl=30,ci=100,sf=1200,al=(n,e,t)=>Math.min(t,Math.max(e,Math.round(n))),Ji=(n,e)=>{if(!Number.isFinite(n))return e;if(n>ci){const t=n/sf*100;return al(t,sl,ci)}return al(n,sl,ci)};function af(){return[".query-content.edit-mode","div.edit-mode",'[class*="edit-mode"]']}function di(n){const t=`${Ji(n,Tr)}vw`;let r=document.getElementById(Xi);r||(r=document.createElement("style"),r.id=Xi,document.head.appendChild(r));const i=af().map(s=>`${s}`).join(`,
    `);r.textContent=`
    /* Remove width constraints from outer containers that contain edit mode (similar to chatWidth) */
    .content-wrapper:has(.edit-mode),
    .main-content:has(.edit-mode),
    .content-container:has(.edit-mode) {
      max-width: none !important;
    }

    /* Remove width constraints from main container when it has edit mode */
    [role="main"]:has(.edit-mode) {
      max-width: none !important;
    }

    main > div:has(.edit-mode) {
      max-width: none !important;
      width: 100% !important;
    }

    /* Target edit mode containers directly */
    ${i} {
      max-width: ${t} !important;
      width: min(100%, ${t}) !important;
    }

    /* Target the edit-container within edit-mode */
    .edit-mode .edit-container,
    .query-content.edit-mode .edit-container {
      max-width: ${t} !important;
      width: min(100%, ${t}) !important;
    }

    /* Target Material Design form field */
    .edit-mode .mat-mdc-form-field,
    .edit-container .mat-mdc-form-field,
    .edit-mode .edit-form {
      max-width: ${t} !important;
      width: 100% !important;
    }

    /* Target text field wrapper and flex container */
    .edit-mode .mat-mdc-text-field-wrapper,
    .edit-mode .mat-mdc-form-field-flex,
    .edit-mode .mdc-text-field {
      max-width: ${t} !important;
      width: 100% !important;
    }

    /* Target form field infix (contains the textarea) */
    .edit-mode .mat-mdc-form-field-infix {
      max-width: ${t} !important;
      width: 100% !important;
    }

    /* Target the textarea itself */
    .edit-mode textarea,
    .edit-container textarea,
    .edit-mode .mat-mdc-input-element,
    .edit-mode .cdk-textarea-autosize {
      max-width: ${t} !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    /* Fallback for browsers without :has() support */
    @supports not selector(:has(*)) {
      .content-wrapper,
      .main-content,
      .content-container {
        max-width: none !important;
      }
    }
  `}function lf(){const n=document.getElementById(Xi);n&&n.remove()}function cf(){let n=Tr;chrome.storage?.sync?.get({geminiEditInputWidth:Tr},o=>{const i=o?.geminiEditInputWidth,s=Ji(i,Tr);if(n=s,di(n),typeof i=="number"&&i!==s)try{chrome.storage?.sync?.set({geminiEditInputWidth:s})}catch(a){console.warn("[Gemini Voyager] Failed to migrate edit input width to %:",a)}}),chrome.storage?.onChanged?.addListener((o,i)=>{if(i==="sync"&&o.geminiEditInputWidth){const s=o.geminiEditInputWidth.newValue;if(typeof s=="number"){const a=Ji(s,Tr);if(n=a,di(n),a!==s)try{chrome.storage?.sync?.set({geminiEditInputWidth:a})}catch(l){console.warn("[Gemini Voyager] Failed to migrate edit input width to % on change:",l)}}}});let e=null;const t=new MutationObserver(()=>{e!==null&&clearTimeout(e),e=window.setTimeout(()=>{di(n),e=null},200)}),r=document.querySelector("main");r&&t.observe(r,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),window.addEventListener("beforeunload",()=>{t.disconnect(),lf()})}function df(n){const e=/^(.*):(u|a)$/.exec(n);return e?{turnId:e[1],roleHint:e[2]==="u"?"user":"assistant"}:{turnId:n,roleHint:null}}function uf(n){const e=new Map,t=[];for(const r of n){const{turnId:o,roleHint:i}=df(r.messageId),s=i??r.role;let a=e.get(o);a||(a={turnId:o,starred:!1},e.set(o,a),t.push(o)),s==="user"?a.user||(a.user=r):a.assistant||(a.assistant=r),a.starred=a.starred||r.starred}return t.map(r=>e.get(r))}function hf(n){let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return(e>>>0).toString(36)}function mf(n){try{return String(n||"").replace(/\s+/g," ").trim()}catch{return""}}function pf(n,e){const t=[];for(const r of n){const o=r.parentElement;o&&o.closest(e)||t.push(r)}return t}function Qi(n,e,t){const r=e.join(",");if(!r)return{signature:"",count:0};const o=Array.from(n.querySelectorAll(r)),i=pf(o,r),s=[];for(let l=0;l<i.length&&s.length<t;l++){const d=mf(i[l]?.textContent??"");d&&s.push(d)}return{signature:hf(s.join("|")),count:i.length}}const ff={timeoutMs:2e4,idleMs:550,minWaitMs:1200,pollIntervalMs:80,maxSamples:10};async function gf(n,e,t,r){const o={...ff,...r??{}},i=e.join(","),s=Date.now();let a=Date.now(),l=!1,d=t,u=null;const m=i&&n instanceof Node?new MutationObserver(()=>{l=!0,a=Date.now()}):null;if(m)try{m.observe(n,{childList:!0,subtree:!0,characterData:!0})}catch{}const p=()=>{try{m?.disconnect()}catch{}},f=g=>new Promise(b=>{setTimeout(b,g)});try{for(;Date.now()-s<o.timeoutMs;){await f(o.pollIntervalMs);const g=Qi(n,e,o.maxSamples),b=g.signature!==t.signature||g.count!==t.count;g.signature!==d.signature||g.count!==d.count?(d=g,u=null):u===null&&(u=Date.now());const w=Date.now()-s>=o.minWaitMs,v=u!==null&&Date.now()-u>=o.idleMs;if(!b){if(w&&v)return p(),{changed:!1,fingerprint:g};continue}const S=Date.now()-a>=o.idleMs;if(l&&S||v)return p(),{changed:!0,fingerprint:g}}return p(),{changed:!1,fingerprint:Qi(n,e,o.maxSamples)}}finally{p()}}const En="gv_export_pending";function od(n){let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return(e>>>0).toString(36)}function bf(n){return n==="json"||n==="markdown"||n==="pdf"||n==="image"}function es(n,e=6e3){return new Promise(t=>{const r=document.querySelector(n);if(r)return t(r);const o=new MutationObserver(()=>{const i=document.querySelector(n);if(i){try{o.disconnect()}catch{}t(i)}});try{o.observe(document.body,{childList:!0,subtree:!0})}catch{}e>0&&setTimeout(()=>{try{o.disconnect()}catch{}t(null)},e)})}function vf(n,e=1e4){return new Promise(t=>{for(const o of n){const i=document.querySelector(o);if(i)return t(i)}const r=new MutationObserver(()=>{for(const o of n){const i=document.querySelector(o);if(i){try{r.disconnect()}catch{}t(i);return}}});try{r.observe(document.body,{childList:!0,subtree:!0})}catch{}e>0&&setTimeout(()=>{try{r.disconnect()}catch{}t(null)},e)})}function Vn(n){try{return String(n||"").replace(/\s+/g," ").trim()}catch{return""}}function ts(n){const e=n.map(r=>r),t=[];for(let r=0;r<e.length;r++){const o=e[r];let i=!1;for(let s=0;s<e.length;s++){if(r===s)continue;if(e[s].contains(o)){i=!0;break}}i||t.push(o)}return t}function id(){return document.querySelector("main")||document.body}function yf(){const n=`${location.host}${location.pathname}${location.search}`;return`gemini:${od(n)}`}function Oo(){const n=(()=>{try{return localStorage.getItem("geminiTimelineUserTurnSelector")||localStorage.getItem("geminiTimelineUserTurnSelectorAuto")||""}catch{return""}})(),e=[".user-query-bubble-with-background",".user-query-bubble-container",".user-query-container","user-query-content .user-query-bubble-with-background",'div[aria-label="User message"]','article[data-author="user"]','article[data-turn="user"]','[data-message-author-role="user"]','div[role="listitem"][data-user="true"]'];return n?[n,...e.filter(t=>t!==n)]:e}function sd(){return['[aria-label="Gemini response"]','[data-message-author-role="assistant"]','[data-message-author-role="model"]','article[data-author="assistant"]','article[data-turn="assistant"]','article[data-turn="model"]',".model-response, model-response",".response-container",'div[role="listitem"]:not([data-user="true"])']}function wf(n,e){const t=new Set,r=[];for(const o of n){const i=(o.offsetTop||0)-e,s=`${Vn(o.textContent||"")}|${Math.round(i)}`;t.has(s)||(t.add(s),r.push(o))}return r}function xf(n,e){const t=n;let r=t.dataset&&t.dataset.turnId||"";if(!r){const o=Vn(t.textContent||"")||`user-${e}`;r=`u-${e}-${od(o)}`;try{t.dataset.turnId=r}catch{}}return r}function Sf(){const n=yf();try{const e=localStorage.getItem(`geminiTimelineStars:${n}`);if(!e)return new Set;const t=JSON.parse(e);return Array.isArray(t)?new Set(t.map(r=>String(r))):new Set}catch{return new Set}}function ll(n){try{const i=n.querySelector("message-content, .markdown, .markdown-main-panel");if(i){const s=i.textContent||i.innerText||"",a=Vn(s);if(a)return a}}catch{}const e=n.cloneNode(!0),t=i=>{const s=Vn(i).toLowerCase();return s?/^(show\s*(thinking|reasoning)|hide\s*(thinking|reasoning))$/i.test(s)||/^(æ˜¾ç¤º\s*(æ€è·¯|æ¨ç†)|éšè—\s*(æ€è·¯|æ¨ç†))$/u.test(s):!1},r=i=>{const s=(i.getAttribute("role")||"").toLowerCase(),a=(i.getAttribute("aria-label")||"").toLowerCase(),l=i.textContent||"";return!!(t(l)||s==="button"&&(/thinking|reasoning/i.test(l)||/æ€è·¯|æ¨ç†/u.test(l))||/thinking|reasoning/i.test(a)||/æ€è·¯|æ¨ç†/u.test(a))};try{e.querySelectorAll('button, [role="button"], [aria-label], span, div, a').forEach(s=>{const a=s;r(a)&&a.remove()})}catch{}return Vn(e.innerText||e.textContent||"")}function wo(){const n=id(),e=Oo(),t=sd(),r=n.querySelectorAll(e.join(","));if(!r||r.length===0)return[];let o=ts(Array.from(r));if(o.length===0)return[];const i=o[0].offsetTop||0;o=wf(o,i);const s=o.map(p=>p.offsetTop||0),a=Array.from(n.querySelectorAll(t.join(","))),l=ts(a),d=l.map(p=>p.offsetTop||0),u=Sf(),m=[];for(let p=0;p<o.length;p++){const f=o[p],g=Vn(f.innerText||f.textContent||""),b=s[p],w=p+1<s.length?s[p+1]:Number.POSITIVE_INFINITY;let v="",S=null,C=-1,L=Number.POSITIVE_INFINITY;for(let F=0;F<l.length;F++){const W=d[F];W>=b&&W<w&&W<L&&(L=W,C=F)}if(C>=0)S=l[C],v=ll(S);else{let F=f;for(let W=0;W<8&&F&&(F=F.nextElementSibling,!(!F||F.matches(e.join(","))));W++)if(F.matches(t.join(","))){S=F,v=ll(F);break}}const I=xf(f,p),R=!!I&&u.has(I);if(g||v){let F;S&&(F=S.querySelector("message-content")||S.querySelector(".markdown, .markdown-main-panel")||S.closest(".presented-response-container")||S.querySelector(".presented-response-container, .response-content")||S.querySelector("response-element")||S||void 0),m.push({turnId:I,user:g,assistant:v,starred:R,userElement:f,assistantElement:F,assistantHostElement:S||void 0})}}return m}function cl(n){const e=[];return n.forEach(t=>{t.userElement&&e.push({messageId:`${t.turnId}:u`,role:"user",hostElement:t.userElement,exportElement:t.userElement,text:t.user,starred:t.starred});const r=t.assistantHostElement;r&&e.push({messageId:`${t.turnId}:a`,role:"assistant",hostElement:r,exportElement:t.assistantElement||r,text:t.assistant,starred:t.starred})}),e}function Ef(n){const e=document.querySelector(".gv-logo-dropdown-wrapper");if(e)return e.querySelector(".gv-export-dropdown-btn");const t=n,r=t.parentElement;if(!r)return null;const o=document.createElement("div");o.className="gv-logo-dropdown-wrapper",r.insertBefore(o,t),o.appendChild(t);const i=document.createElement("div");i.className="gv-logo-dropdown";const s=document.createElement("button");s.className="gv-export-dropdown-btn",s.type="button",s.title="Export chat history",s.setAttribute("aria-label","Export chat history");const a=document.createElement("span");a.className="gv-export-dropdown-icon",s.appendChild(a);const l=document.createElement("span");return l.className="gv-export-dropdown-label",l.textContent="Export",s.appendChild(l),i.appendChild(s),o.appendChild(i),s}async function ad(){try{const[n,e,t,r,o,i,s,a,l,d]=await Promise.all([Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.h),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.r),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.t),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.l),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.k),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.j),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.p),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.m),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.q),__vite__mapDeps([0,1])),Qe(()=>import("./i18n-CcLr9W9q.js").then(u=>u.o),__vite__mapDeps([0,1]))]);return{en:st(n),zh:st(e),zh_TW:st(t),ja:st(r),fr:st(o),es:st(i),pt:st(s),ar:st(a),ru:st(l),ko:st(d)}}catch{return{en:{},zh:{},zh_TW:{},ja:{},fr:{},es:{},pt:{},ar:{},ru:{},ko:{}}}}function yn(n){const e=(n||"").trim();return!(!e||e==="Untitled Conversation"||e==="Gemini"||e==="Google Gemini"||e==="Google AI Studio"||e==="New chat"||e.startsWith("Gemini -")||e.startsWith("Google AI Studio -"))}function dl(){const n=window.location.pathname.match(/\/app\/([^/?#]+)/);if(n?.[1])return n[1];const e=window.location.pathname.match(/\/gem\/[^/]+\/([^/?#]+)/);return e?.[1]?e[1]:null}function jn(n){const e=(n||"").trim().toLowerCase();return e==="gem"||e==="gems"}function Cf(n){if(!n)return null;const e=(n.innerText||"").trim();if(!e)return null;const t=e.split(`
`).map(r=>r.trim()).filter(Boolean).filter(r=>!jn(r)).filter(r=>r.length>=2);return t.length===0?null:t.reduce((r,o)=>o.length>r.length?o:r,t[0])||null}function ul(n){const e=n.closest('[data-test-id="conversation"]')||n,r=e.querySelector('.gds-label-l, .conversation-title-text, [data-test-id="conversation-title"], h3')?.textContent?.trim();if(yn(r)&&!jn(r))return r;const o=e.querySelector('a[href*="/app/"], a[href*="/gem/"]'),i=o?.getAttribute("aria-label")?.trim();if(yn(i)&&!jn(i))return i;const s=o?.getAttribute("title")?.trim();if(yn(s)&&!jn(s))return s;const a=Cf(o);if(yn(a))return a;const d=e.querySelector(".gds-body-m, .gds-label-m, .subtitle")?.textContent?.trim();if(yn(d)&&!jn(d))return d;const u=e.textContent?.trim()||"";if(!u)return null;const m=u.split(`
`).map(p=>p.trim()).filter(Boolean)[0]||u;return yn(m)&&!jn(m)?m.slice(0,80):null}function Tf(n){const e=_f(n),t=document.querySelector(`[data-test-id="conversation"][jslog*="c_${e}"]`);if(t){const o=ul(t);if(o)return o}const r=document.querySelector(`[data-test-id="conversation"] a[href*="${e}"]`);if(r){const o=ul(r);if(o)return o}return null}function _f(n){const e=globalThis.CSS?.escape;return typeof e=="function"?e(n):n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function kf(){try{const t=document.querySelector(".gv-folder-conversation.gv-folder-conversation-selected .gv-conversation-title")||document.querySelector(".gv-folder-conversation-selected .gv-conversation-title");if(t?.textContent?.trim())return t.textContent.trim()}catch(t){try{console.debug("[Export] Failed to get title from Folder Manager:",t)}catch{}}try{const t=dl();if(t){const r=Tf(t);if(r)return r}}catch(t){try{console.debug("[Export] Failed to get title from native sidebar by conversation id:",t)}catch{}}const n=document.querySelector("title");if(n){const t=n.textContent?.trim();if(yn(t))return t}try{const t=["mat-list-item.mdc-list-item--activated [mat-line]",'mat-list-item[aria-current="page"] [mat-line]',".conversation-list-item.active .conversation-title",".active-conversation .title"];for(const r of t){const i=document.querySelector(r)?.textContent?.trim();if(yn(i))return i}}catch(t){try{console.debug("[Export] Failed to get title from sidebar:",t)}catch{}}const e=dl();return e?`Conversation ${e.slice(0,8)}`:"Untitled Conversation"}function ld(n){return Bo(n)}async function cd(){try{const n=await Promise.race([new Promise(r=>{try{window.chrome?.storage?.sync?.get?window.chrome.storage.sync.get(ke.LANGUAGE,r):window.browser?.storage?.sync?.get?window.browser.storage.sync.get(ke.LANGUAGE).then(r).catch(()=>r({})):r({})}catch{r({})}}),new Promise(r=>setTimeout(()=>r({}),1e3))]),e=n&&typeof n=="object"?n:{},t=typeof e[ke.LANGUAGE]=="string"?e[ke.LANGUAGE]:void 0;return ld(t||navigator.language||"en")}catch{return"en"}}function Af(){const n=Oo(),e=document.querySelectorAll(n.join(","));if(!e.length)return null;const t=ts(Array.from(e));return t.length>0?t[0]:null}async function Xs(n,e,t,r,o){const i=r||{format:n,fontSize:o,attempt:0,url:location.href,status:"clicking",timestamp:Date.now()};if(i.attempt>25){console.warn("[Gemini Voyager] Export aborted: too many attempts."),sessionStorage.removeItem(En),alert("Export stopped: Too many attempts detected.");return}if(i.attempt>0){console.log("[Gemini Voyager] Resuming export... waiting for content load.");const u=Oo();await vf(u,15e3)}let s=Af();if(!s){await es("body",2e3);const u=wo();u.length>0&&u[0].userElement&&(s=u[0].userElement)}if(!s){console.log("[Gemini Voyager] No top node found, proceeding to export directly."),sessionStorage.removeItem(En),await hl(n,e,t,i.fontSize);return}const a=[...Oo(),...sd()],l=Qi(document.body,a,10);console.log(`[Gemini Voyager] Simulating click on top node (Attempt ${i.attempt+1})...`),sessionStorage.setItem(En,JSON.stringify({...i,attempt:i.attempt+1,timestamp:Date.now()}));try{s.scrollIntoView({behavior:"auto",block:"center"});const u={bubbles:!0,cancelable:!0,view:window};s.dispatchEvent(new MouseEvent("mousedown",u)),s.dispatchEvent(new MouseEvent("mouseup",u)),s.click()}catch(u){console.error("[Gemini Voyager] Failed to click top node:",u)}const{changed:d}=await gf(document.body,a,l,{timeoutMs:25e3,minWaitMs:1600,idleMs:650,pollIntervalMs:90,maxSamples:10});if(d){console.log("[Gemini Voyager] History expanded (soft refresh). Clicking top node again..."),await Xs(n,e,t,{...i,attempt:i.attempt+1,timestamp:Date.now()});return}console.log("[Gemini Voyager] No refresh or update detected. Exporting..."),sessionStorage.removeItem(En),await hl(n,e,t,i.fontSize)}async function hl(n,e,t,r){const o=re=>e[t]?.[re]??e.en?.[re]??re;await new Promise(re=>setTimeout(re,400));const i=wo();if(cl(i).length===0){alert(o("export_dialog_warning"));return}const a=new Set;let l=[];const d=[],u=new Map,m=new Map,p=new Set;let f=!1;const g=()=>{d.forEach(re=>{try{re()}catch{}}),d.length=0},b=(re,Z)=>{Z?a.add(re):a.delete(re);const pe=m.get(re);pe&&(pe.setAttribute("aria-pressed",Z?"true":"false"),pe.dataset.selected=Z?"true":"false");const K=u.get(re);K&&(Z?K.classList.add("gv-export-msg-selected"):K.classList.remove("gv-export-msg-selected"))},w=re=>{const Z=re.querySelector('[data-gv-export-selection-count="true"]');Z&&(Z.textContent=o("export_select_mode_count").replace("{count}",String(a.size)));const pe=re.querySelector('[data-gv-export-action="export"]');pe&&(pe.disabled=a.size===0);const K=re.querySelector('[data-gv-export-action="selectAll"]');if(K){const be=l.length>0&&a.size===l.length;K.dataset.checked=be?"true":"false"}},v=re=>{if(p.has(re.messageId))return;p.add(re.messageId);const Z=re.hostElement;u.set(re.messageId,Z),Z.classList.add("gv-export-msg-host"),d.push(()=>Z.classList.remove("gv-export-msg-host"));const pe=document.createElement("div");pe.className="gv-export-msg-selector",pe.dataset.gvExportMessageId=re.messageId;const K=document.createElement("button");K.type="button",K.className="gv-export-msg-checkbox",K.setAttribute("aria-pressed","false"),K.title=o("export_select_mode_toggle");const be=document.createElement("span");be.className="gv-export-msg-checkbox-mark",K.appendChild(be);const O=$=>{try{$.preventDefault()}catch{}try{$.stopPropagation()}catch{}};K.addEventListener("click",$=>{O($),f=!1;const de=!a.has(re.messageId);b(re.messageId,de);const ie=document.querySelector('[data-gv-export-select-bar="true"]');ie&&w(ie)}),pe.appendChild(K),Z.appendChild(pe),d.push(()=>pe.remove()),m.set(re.messageId,K)},S=re=>{const pe=cl(re).map(K=>{const O=K.hostElement.getBoundingClientRect().top+window.scrollY;return{...K,absTop:O}});return pe.sort((K,be)=>K.absTop-be.absTop),pe},C=re=>{const Z=S(re);if(l=Z.map(pe=>pe.messageId),Z.forEach(pe=>v(pe)),f)for(const pe of l)b(pe,!0)};document.body.classList.add("gv-export-select-mode"),d.push(()=>document.body.classList.remove("gv-export-select-mode"));const L=document.createElement("div");L.className="gv-export-select-bar",L.dataset.gvExportSelectBar="true";const I=document.createElement("button");I.type="button",I.className="gv-export-select-all-toggle",I.dataset.gvExportAction="selectAll",I.textContent=o("export_select_mode_select_all");const R=document.createElement("div");R.className="gv-export-select-count",R.dataset.gvExportSelectionCount="true",R.textContent=o("export_select_mode_count").replace("{count}","0");const F=document.createElement("button");F.type="button",F.className="gv-export-select-export-btn",F.dataset.gvExportAction="export",F.textContent=o("pm_export"),F.disabled=!0;const W=document.createElement("button");W.type="button",W.className="gv-export-select-cancel-btn",W.title=o("pm_cancel"),W.textContent="Ã—",L.appendChild(I),L.appendChild(R),L.appendChild(F),L.appendChild(W),document.body.appendChild(L),d.push(()=>L.remove());const B=re=>{try{re.preventDefault()}catch{}try{re.stopPropagation()}catch{}};I.addEventListener("click",re=>{B(re),l.length>0&&a.size===l.length?(a.clear(),f=!1,l.forEach(pe=>b(pe,!1))):(a.clear(),f=!0,l.forEach(pe=>b(pe,!0))),w(L)});const ne=()=>{l.forEach(re=>b(re,!1)),a.clear(),f=!1,g()};W.addEventListener("click",re=>{B(re),ne()}),F.addEventListener("click",async re=>{if(B(re),a.size===0){alert(o("export_select_mode_empty"));return}const Z=wo(),K=S(Z).filter(ie=>a.has(ie.messageId)),O=uf(K).map(ie=>({user:ie.user?.text||"",assistant:ie.assistant?.text||"",starred:ie.starred,omitEmptySections:!0,userElement:ie.user?.exportElement,assistantElement:ie.assistant?.exportElement})).filter(ie=>ie.user.length>0||ie.assistant.length>0||!!ie.userElement||!!ie.assistantElement);ne();const $={url:location.href,exportedAt:new Date().toISOString(),count:O.length,title:kf()},de=If(o);try{const ie=Zs.export(O,$,{format:n,fontSize:r}),ee=new Promise(Ge=>setTimeout(Ge,420)),[$e]=await Promise.all([ie,ee]);$e.success?n==="pdf"&&en()&&td(o("export_toast_safari_pdf_ready"),{autoDismissMs:5e3}):alert(`${o("export_dialog_warning")}: ${$e.error}`)}catch(ie){console.error("[Gemini Voyager] Export error:",ie),alert("Export error occurred.")}finally{de()}});const he=id();let D=null;const G=()=>{D||(D=window.setTimeout(()=>{D=null;try{C(wo()),w(L)}catch{}},250))},x=new MutationObserver(()=>G());try{x.observe(he,{childList:!0,subtree:!0}),d.push(()=>x.disconnect())}catch{}const Y=re=>{re.key==="Escape"&&(ne(),document.removeEventListener("keydown",Y))};document.addEventListener("keydown",Y),d.push(()=>document.removeEventListener("keydown",Y)),C(i),w(L)}function If(n){const e=document.createElement("div");e.className="gv-export-progress-overlay";const t=document.createElement("div");t.className="gv-export-progress-card";const r=document.createElement("div");r.className="gv-export-progress-spinner";const o=document.createElement("div");o.className="gv-export-progress-title",o.textContent=`${n("pm_export")}...`;const i=document.createElement("div");return i.className="gv-export-progress-desc",i.textContent=n("loading"),t.appendChild(r),t.appendChild(o),t.appendChild(i),e.appendChild(t),document.body.appendChild(e),()=>{try{e.remove()}catch{}}}async function Lf(){try{const n=sessionStorage.getItem(En);if(!n)return;const e=JSON.parse(n);if(!bf(e.format)||typeof e.attempt!="number"||typeof e.url!="string"||e.status!=="clicking"||typeof e.timestamp!="number"){sessionStorage.removeItem(En);return}const t={format:e.format,fontSize:typeof e.fontSize=="number"?e.fontSize:void 0,attempt:e.attempt,url:e.url,status:e.status,timestamp:e.timestamp};if(t.url!==location.href){sessionStorage.removeItem(En);return}console.log("[Gemini Voyager] Resuming pending export sequence...");const r=await ad(),o=await cd();await Xs(t.format,r,o,t)}catch(n){console.error("[Gemini Voyager] Failed to resume pending export:",n),sessionStorage.removeItem(En)}}async function Df(){if(Lf(),location.hostname!=="gemini.google.com"&&location.hostname!=="aistudio.google.com"&&location.hostname!=="aistudio.google.cn")return;const n=await es('[data-test-id="logo"]',6e3)||await es(".logo",2e3);if(!n)return;const e=Ef(n);if(!e||e._gvBound)return;e._gvBound=!0;const t=u=>{try{u.preventDefault()}catch{}try{u.stopPropagation()}catch{}};["pointerdown","mousedown","pointerup","mouseup"].forEach(u=>{try{e.addEventListener(u,t,!0)}catch{}});const r=await ad();let o=await cd();const i=u=>r[o]?.[u]??r.en?.[u]??u,s=i("exportChatJson"),a=i("pm_export");e.title=s,e.setAttribute("aria-label",s);const l=e.querySelector(".gv-export-dropdown-label");l&&(l.textContent=a);const d=(u,m)=>{if(m!=="sync")return;const p=u[ke.LANGUAGE]?.newValue;if(typeof p=="string"){const f=ld(p);o=f;const g=r[f]?.exportChatJson??r.en?.exportChatJson??"Export chat history";e.title=g,e.setAttribute("aria-label",g);const b=e.querySelector(".gv-export-dropdown-label");b&&(b.textContent=r[f]?.pm_export??r.en?.pm_export??"Export")}};try{chrome.storage?.onChanged?.addListener(d),window.addEventListener("beforeunload",()=>{try{chrome.storage?.onChanged?.removeListener(d)}catch(u){console.error("[Gemini Voyager] Failed to remove storage listener on unload:",u)}},{once:!0})}catch{}e.addEventListener("click",u=>{t(u);try{Mf(r,o)}catch(m){try{console.error("Gemini Voyager export failed",m)}catch{}}})}async function Mf(n,e){const t=o=>n[e]?.[o]??n.en?.[o]??o;new ed().show({onExport:async(o,i)=>{try{await Xs(o,n,e,void 0,i)}catch(s){console.error("[Gemini Voyager] Export error:",s)}},onCancel:()=>{},translations:{title:t("export_dialog_title"),selectFormat:t("export_dialog_select"),warning:t("export_dialog_warning"),safariCmdpHint:t("export_dialog_safari_cmdp_hint"),safariMarkdownHint:t("export_dialog_safari_markdown_hint"),cancel:t("pm_cancel"),export:t("pm_export"),fontSizeLabel:t("export_fontsize_label"),fontSizePreview:t("export_fontsize_preview"),formatDescriptions:{json:t("export_format_json_description"),markdown:t("export_format_markdown_description"),pdf:t("export_format_pdf_description"),image:t("export_format_image_description")}}})}class dd{constructor(e,t=()=>!0){this.namespace=e,this.validateData=t,this.primaryKey=`gvBackup_${e}_primary`,this.emergencyKey=`gvBackup_${e}_emergency`,this.beforeUnloadKey=`gvBackup_${e}_beforeUnload`,this.metadataKey=`gvBackup_${e}_metadata`}primaryKey;emergencyKey;beforeUnloadKey;metadataKey;maxBackupAge=10080*60*1e3;beforeUnloadHandler=null;createPrimaryBackup(e){try{const t=this.createBackupData(e);return localStorage.setItem(this.primaryKey,JSON.stringify(t)),this.updateMetadata("primary",t.metadata),console.log(`[BackupService:${this.namespace}] Primary backup created`),!0}catch(t){return console.error(`[BackupService:${this.namespace}] Failed to create primary backup:`,t),!1}}createEmergencyBackup(e){try{const t=this.createBackupData(e);return localStorage.setItem(this.emergencyKey,JSON.stringify(t)),console.log(`[BackupService:${this.namespace}] Emergency backup created`),!0}catch(t){return console.error(`[BackupService:${this.namespace}] Failed to create emergency backup:`,t),!1}}createBeforeUnloadBackup(e){try{const t=this.createBackupData(e);return localStorage.setItem(this.beforeUnloadKey,JSON.stringify(t)),console.log(`[BackupService:${this.namespace}] BeforeUnload backup created`),!0}catch(t){return console.error(`[BackupService:${this.namespace}] Failed to create beforeUnload backup:`,t),!1}}setupBeforeUnloadBackup(e){this.beforeUnloadHandler&&window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=()=>{try{const t=e();this.createBeforeUnloadBackup(t)}catch(t){console.error(`[BackupService:${this.namespace}] BeforeUnload handler error:`,t)}},window.addEventListener("beforeunload",this.beforeUnloadHandler)}recoverFromBackup(){console.log(`[BackupService:${this.namespace}] Attempting data recovery...`);const e=this.loadBackup(this.primaryKey,"primary");if(e)return e;const t=this.loadBackup(this.emergencyKey,"emergency");if(t)return t;const r=this.loadBackup(this.beforeUnloadKey,"beforeUnload");return r||(console.error(`[BackupService:${this.namespace}] All backup recovery attempts failed`),null)}loadBackup(e,t){try{const r=localStorage.getItem(e);if(!r)return console.log(`[BackupService:${this.namespace}] No ${t} backup found`),null;const o=JSON.parse(r);return this.isBackupValid(o)?this.validateData(o.data)?(console.log(`[BackupService:${this.namespace}] Successfully loaded ${t} backup from ${o.metadata.timestamp}`),o.data):(console.warn(`[BackupService:${this.namespace}] ${t} backup data validation failed`),null):(console.warn(`[BackupService:${this.namespace}] ${t} backup is too old or invalid`),null)}catch(r){return console.error(`[BackupService:${this.namespace}] Failed to load ${t} backup:`,r),null}}createBackupData(e){const t=JSON.stringify(e),r=this.getItemCount(e);return{data:e,metadata:{timestamp:new Date().toISOString(),version:"1.0",dataSize:t.length,itemCount:r}}}isBackupValid(e){try{const t=new Date(e.metadata.timestamp).getTime(),r=Date.now()-t;return r<0?(console.warn(`[BackupService:${this.namespace}] Backup has future timestamp`),!1):r>this.maxBackupAge?(console.warn(`[BackupService:${this.namespace}] Backup is too old: ${Math.floor(r/(1440*60*1e3))} days`),!1):!0}catch{return!1}}getItemCount(e){try{return typeof e=="object"&&e!==null?"folders"in e&&Array.isArray(e.folders)?e.folders.length:Array.isArray(e)?e.length:Object.keys(e).length:0}catch{return 0}}updateMetadata(e,t){try{const r=this.getAllMetadata();r[e]=t,localStorage.setItem(this.metadataKey,JSON.stringify(r))}catch(r){console.warn(`[BackupService:${this.namespace}] Failed to update metadata:`,r)}}getAllMetadata(){try{const e=localStorage.getItem(this.metadataKey);return e?JSON.parse(e):{}}catch{return{}}}clearAllBackups(){try{localStorage.removeItem(this.primaryKey),localStorage.removeItem(this.emergencyKey),localStorage.removeItem(this.beforeUnloadKey),localStorage.removeItem(this.metadataKey),console.log(`[BackupService:${this.namespace}] All backups cleared`)}catch(e){console.error(`[BackupService:${this.namespace}] Failed to clear backups:`,e)}}destroy(){this.beforeUnloadHandler&&(window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null)}}class Ut{static instance=null;config;monitorIntervalId=null;lastWarningLevel=0;notificationCallback=null;static DEFAULT_CONFIG={enabled:!0,checkIntervalMs:6e4,warningThresholds:[.8,.9,.95],showNotifications:!0};constructor(e){this.config={...Ut.DEFAULT_CONFIG,...e}}static getInstance(e){return Ut.instance||(Ut.instance=new Ut(e)),Ut.instance}setNotificationCallback(e){this.notificationCallback=e}static isStorageApiAvailable(){return typeof navigator<"u"&&"storage"in navigator&&typeof navigator.storage.estimate=="function"}async checkQuota(){if(!Ut.isStorageApiAvailable())return console.warn("[StorageMonitor] Storage API not available"),null;try{const e=await navigator.storage.estimate(),t=e.usage||0,r=e.quota||0;if(r===0)return console.warn("[StorageMonitor] Storage quota is 0, API may not be fully supported"),null;const o=t/r,i=t/(1024*1024),s=r/(1024*1024);return{usage:t,quota:r,usagePercent:o,usageMB:i,quotaMB:s}}catch(e){return console.error("[StorageMonitor] Failed to check quota:",e),null}}async checkAndWarn(){const e=await this.checkQuota();if(!e)return null;const t=this.config.warningThresholds.filter(o=>e.usagePercent>=o);if(t.length===0)return this.lastWarningLevel=0,e;const r=Math.max(...t);if(r>this.lastWarningLevel){this.lastWarningLevel=r;const o=this.formatWarningMessage(e),i=this.getWarningLevel(e.usagePercent);console.warn(`[StorageMonitor] ${o}`),this.config.showNotifications&&this.showNotification(o,i)}return e}formatWarningMessage(e){const t=Math.round(e.usagePercent*100),r=e.usageMB.toFixed(2),o=e.quotaMB.toFixed(2);return`Storage usage is ${t}% (${r} MB / ${o} MB). Consider exporting and cleaning old data to free up space.`}getWarningLevel(e){return e>=.95?"error":e>=.9?"warning":"info"}showNotification(e,t){if(this.notificationCallback){this.notificationCallback(e,t);return}this.showDefaultNotification(e,t)}showDefaultNotification(e,t){try{const r=document.createElement("div");r.className=`gv-notification gv-notification-${t}`,r.textContent=`[Gemini Voyager] ${e}`;const o={info:"#2196F3",warning:"#FF9800",error:"#F44336"},i=r.style;i.position="fixed",i.top="20px",i.right="20px",i.padding="12px 20px",i.background=o[t],i.color="white",i.borderRadius="4px",i.boxShadow="0 2px 8px rgba(0,0,0,0.2)",i.zIndex=String(2147483647),i.maxWidth="400px",i.fontSize="14px",i.fontFamily="system-ui, -apple-system, sans-serif",i.lineHeight="1.4",document.body.appendChild(r),setTimeout(()=>{try{document.body.removeChild(r)}catch{}},t==="error"?1e4:5e3)}catch(r){console.error("[StorageMonitor] Failed to show notification:",r)}}startMonitoring(){if(!this.config.enabled){console.log("[StorageMonitor] Monitoring is disabled");return}if(!Ut.isStorageApiAvailable()){console.warn("[StorageMonitor] Storage API not available, cannot start monitoring");return}if(this.monitorIntervalId!==null){console.log("[StorageMonitor] Monitoring already started");return}console.log(`[StorageMonitor] Starting automatic monitoring (interval: ${this.config.checkIntervalMs}ms)`),this.checkAndWarn().catch(e=>{console.error("[StorageMonitor] Initial check failed:",e)}),this.monitorIntervalId=window.setInterval(()=>{this.checkAndWarn().catch(e=>{console.error("[StorageMonitor] Periodic check failed:",e)})},this.config.checkIntervalMs)}stopMonitoring(){this.monitorIntervalId!==null&&(console.log("[StorageMonitor] Stopping automatic monitoring"),window.clearInterval(this.monitorIntervalId),this.monitorIntervalId=null,this.lastWarningLevel=0)}updateConfig(e){const t=this.config.enabled;this.config={...this.config,...e},t!==this.config.enabled&&(this.config.enabled?this.startMonitoring():this.stopMonitoring())}getConfig(){return{...this.config}}async getFormattedInfo(){const e=await this.checkQuota();if(!e)return null;const t=Math.round(e.usagePercent*100),r=e.usageMB.toFixed(2),o=e.quotaMB.toFixed(2);return`Storage: ${r} MB / ${o} MB (${t}%)`}destroy(){this.stopMonitoring(),this.notificationCallback=null,this.lastWarningLevel=0}static resetInstance(){Ut.instance&&(Ut.instance.destroy(),Ut.instance=null)}}function ud(n){return Ut.getInstance(n)}function Nf(n,e=1e4){return new Promise(t=>{const r=document.querySelector(n);if(r)return t(r);const o=new MutationObserver(()=>{const i=document.querySelector(n);if(i){try{o.disconnect()}catch{}t(i)}});try{o.observe(document.body,{childList:!0,subtree:!0})}catch{}e>0&&setTimeout(()=>{try{o.disconnect()}catch{}t(null)},e)})}function cr(n){try{return String(n||"").replace(/\s+/g," ").trim()}catch{return""}}function Ff(n,e){const t=new Blob([JSON.stringify(n,null,2)],{type:"application/json;charset=utf-8"}),r=URL.createObjectURL(t),o=document.createElement("a");o.href=r,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{try{document.body.removeChild(o)}catch{}URL.revokeObjectURL(r)},0)}function bn(){return Date.now()}function ml(){return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2)}const Of=5e3;function zn(n){return n&&typeof n=="object"&&Array.isArray(n.folders)&&typeof n.folderContents=="object"}class Rf{t=e=>e;data={folders:[],folderContents:{}};container=null;historyRoot=null;cleanupFns=[];STORAGE_KEY=ke.FOLDER_DATA_AISTUDIO;folderEnabled=!0;backupService;sidebarWidth=360;SIDEBAR_WIDTH_KEY="gvAIStudioSidebarWidth";MIN_SIDEBAR_WIDTH=240;MAX_SIDEBAR_WIDTH=600;UNCATEGORIZED_KEY="__uncategorized__";createIcon(e){const t=document.createElement("span");t.className="google-symbols";try{t.dataset.icon=e}catch{}return t.textContent=e,t}async init(){await jr(),this.t=$d(),this.backupService=new dd("aistudio-folders",zn),this.backupService.setupBeforeUnloadBackup(()=>this.data);const e=ud({checkIntervalMs:12e4});e.setNotificationCallback((r,o)=>{this.showNotification(r,o)}),e.startMonitoring(),await this.migrateFromSyncToLocal(),(/^\/(prompts|library)(\/|$)/.test(location.pathname)||location.pathname==="/")&&(await this.loadFolderEnabledSetting(),await this.loadSidebarWidth(),this.setupStorageListener(),this.setupMessageListener(),this.folderEnabled&&await this.initializeFolderUI())}async migrateFromSyncToLocal(){try{const t=(await chrome.storage.sync.get(this.STORAGE_KEY))[this.STORAGE_KEY];if(t&&zn(t)){const o=(await chrome.storage.local.get(this.STORAGE_KEY))[this.STORAGE_KEY];if(!o||!zn(o))await chrome.storage.local.set({[this.STORAGE_KEY]:t}),console.log("[AIStudioFolderManager] Migrated folder data from sync to local storage");else{const i=this.mergeFolderData(o,t);await chrome.storage.local.set({[this.STORAGE_KEY]:i}),console.log("[AIStudioFolderManager] Merged sync and local folder data")}}}catch(e){console.warn("[AIStudioFolderManager] Migration from sync to local failed:",e)}}mergeFolderData(e,t){const r=[...e.folders],o=new Set(e.folders.map(s=>s.id));for(const s of t.folders)o.has(s.id)||r.push(s);const i={...e.folderContents};for(const[s,a]of Object.entries(t.folderContents))if(!i[s])i[s]=a;else{const l=new Set(i[s].map(d=>d.conversationId));for(const d of a)l.has(d.conversationId)||i[s].push(d)}return{folders:r,folderContents:i}}setupMessageListener(){Ce.runtime.onMessage.addListener((e,t,r)=>e?.type==="gv.sync.requestData"?(console.log("[AIStudioFolderManager] Received request for folder data from popup"),r({ok:!0,data:this.data}),!0):(e?.type==="gv.folders.reload"&&(console.log("[AIStudioFolderManager] Received reload request from sync"),this.load().then(()=>{this.render(),console.log("[AIStudioFolderManager] Folder data reloaded from sync")}),r({ok:!0})),!0))}async initializeFolderUI(){this.historyRoot=await Nf("ms-prompt-history-v3")||null;const e=/\/library(\/|$)/.test(location.pathname);if(!(!this.historyRoot&&!e)){try{document.documentElement.classList.add("gv-aistudio-root")}catch{}await this.load(),this.historyRoot&&(this.injectUI(),this.observePromptList(),this.bindDraggablesInPromptList(),this.highlightActiveConversation(),this.installRouteChangeListener(),this.applySidebarWidth(!0),this.addResizeHandle()),e&&(this.observeLibraryTable(),this.bindDraggablesInLibraryTable(),this.injectLibraryDropZone())}}async load(){try{const t=(await chrome.storage.local.get(this.STORAGE_KEY))[this.STORAGE_KEY];t&&zn(t)?(this.data=t,this.backupService.createPrimaryBackup(this.data)):(console.warn("[AIStudioFolderManager] Storage returned no data, attempting recovery from backup"),this.attemptDataRecovery(null))}catch(e){console.error("[AIStudioFolderManager] Load error:",e),this.attemptDataRecovery(e)}}async save(){try{this.backupService.createEmergencyBackup(this.data),await chrome.storage.local.set({[this.STORAGE_KEY]:this.data}),this.backupService.createPrimaryBackup(this.data)}catch(e){console.error("[AIStudioFolderManager] Save error:",e),this.showErrorNotification("Failed to save folder data. Changes may not be persisted.")}}injectUI(){if(this.container&&document.body.contains(this.container))return;const e=document.createElement("div");e.className="gv-folder-container gv-aistudio";const t=document.createElement("div");t.className="gv-folder-header";const r=document.createElement("div");r.className="gv-folder-title gds-label-l",r.textContent=this.t("folder_title"),t.appendChild(r);const o=document.createElement("div");if(o.className="gv-folder-header-actions",t.appendChild(o),!en()){const d=document.createElement("button");d.className="gv-folder-action-btn",d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#e3e3e3"><path d="M260-160q-91 0-155.5-63T40-377q0-78 47-139t123-78q25-92 100-149t170-57q117 0 198.5 81.5T760-520q69 8 114.5 59.5T920-340q0 75-52.5 127.5T740-160H520q-33 0-56.5-23.5T440-240v-206l-64 62-56-56 160-160 160 160-56 56-64-62v206h220q42 0 71-29t29-71q0-42-29-71t-71-29h-60v-80q0-83-58.5-141.5T480-720q-83 0-141.5 58.5T280-520h-20q-58 0-99 41t-41 99q0 58 41 99t99 41h100v80H260Zm220-280Z"/></svg>',d.title=this.t("folder_cloud_upload"),d.addEventListener("click",()=>this.handleCloudUpload()),d.addEventListener("mouseenter",async()=>{const m=await this.getCloudUploadTooltip();d.title=m}),o.appendChild(d);const u=document.createElement("button");u.className="gv-folder-action-btn",u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#e3e3e3"><path d="M260-160q-91 0-155.5-63T40-377q0-78 47-139t123-78q17-72 85-137t145-65q33 0 56.5 23.5T520-716v242l64-62 56 56-160 160-160-160 56-56 64 62v-242q-76 14-118 73.5T280-520h-20q-58 0-99 41t-41 99q0 58 41 99t99 41h480q42 0 71-29t29-71q0-42-29-71t-71-29h-60v-80q0-48-22-89.5T600-680v-93q74 35 117 103.5T760-520q69 8 114.5 59.5T920-340q0 75-52.5 127.5T740-160H260Zm220-358Z"/></svg>',u.title=this.t("folder_cloud_sync"),u.addEventListener("click",()=>this.handleCloudSync()),u.addEventListener("mouseenter",async()=>{const m=await this.getCloudSyncTooltip();u.title=m}),o.appendChild(u)}const i=document.createElement("button");i.className="gv-folder-add-btn",i.title=this.t("folder_create"),i.appendChild(this.createIcon("add")),i.addEventListener("click",()=>this.createFolder()),o.appendChild(i);const s=document.createElement("div");s.className="gv-folder-list",e.appendChild(t),e.appendChild(s);const a=this.historyRoot;if(!a)return;(a.parentElement??a).insertAdjacentElement("beforebegin",e),this.container=e,this.injectStyles(),this.render(),this.applyFolderEnabledSetting()}injectStyles(){const e="gv-aistudio-folder-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent=`
      .gv-folder-confirm-dialog.gv-aistudio-confirm {
        background: var(--gem-sys-color-surface, #fff);
        border: 1px solid var(--gem-sys-color-outline-variant, #e5e7eb);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 16px;
        min-width: 280px;
        font-family: 'Google Sans', 'Segoe UI', sans-serif;
        animation: gv-fade-in 0.2s ease-out;
      }
      
      .gv-confirm-message {
        margin-bottom: 16px;
        color: var(--gem-sys-color-on-surface, #1f2937);
        font-size: 14px;
        line-height: 1.5;
        font-weight: 500;
      }

      .gv-confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end; /* Default right align, but we override order */
      }

      .gv-confirm-btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        outline: none;
      }

      .gv-confirm-delete {
        background-color: #ef4444; /* Red color */
        color: white;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
      }
      
      .gv-confirm-delete:hover {
        background-color: #dc2626;
        box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
      }

      .gv-confirm-cancel {
        background-color: transparent;
        color: var(--gem-sys-color-on-surface-variant, #4b5563);
        border: 1px solid var(--gem-sys-color-outline, #d1d5db);
      }

      .gv-confirm-cancel:hover {
        background-color: var(--gem-sys-color-surface-container-high, #f3f4f6);
        color: var(--gem-sys-color-on-surface, #111827);
      }

      /* Hover effect for remove button in list */
      .gv-conversation-remove-btn:hover {
        background-color: rgba(239, 68, 68, 0.1) !important;
        color: #ef4444 !important;
      }

      .gv-conversation-remove-btn:hover span {
        font-variation-settings: 'FILL' 1, 'wght' 600 !important;
      }

      @keyframes gv-fade-in {
        from { opacity: 0; transform: translateY(4px); }
        to { opacity: 1; transform: translateY(0); }
      }
    `,document.head.appendChild(t)}render(){if(!this.container)return;const e=this.container.querySelector(".gv-folder-list");if(!e)return;e.innerHTML="";const t=this.data.folders.filter(i=>!i.parentId);t.sort((i,s)=>{const a=i.pinned?1:0,l=s.pinned?1:0;return a!==l?l-a:i.createdAt-s.createdAt});for(const i of t)e.appendChild(this.renderFolder(i));const r=document.createElement("div");r.className="gv-folder-root-drop",r.textContent="",this.bindDropZone(r,null),e.appendChild(r);const o=this.data.folderContents[this.UNCATEGORIZED_KEY]||[];if(o.length>0){const i=document.createElement("div");i.className="gv-folder-uncategorized";const s=document.createElement("div");s.className="gv-folder-uncategorized-header",s.innerHTML=`<span class="google-symbols" data-icon="inbox" style="margin-right: 6px;">inbox</span>${this.t("folder_uncategorized")||"Uncategorized"}`,i.appendChild(s);const a=document.createElement("div");a.className="gv-folder-uncategorized-content";for(const l of o)a.appendChild(this.renderConversation(this.UNCATEGORIZED_KEY,l));i.appendChild(a),e.appendChild(i)}this.highlightActiveConversation()}getCurrentPromptIdFromLocation(){try{const e=(location.pathname||"").match(/\/prompts\/([^/?#]+)/);return e?e[1]:null}catch{return null}}highlightActiveConversation(){if(!this.container)return;const e=this.getCurrentPromptIdFromLocation();this.container.querySelectorAll(".gv-folder-conversation").forEach(r=>{const o=e&&r.dataset.conversationId===e;r.classList.toggle("gv-folder-conversation-selected",!!o)})}installRouteChangeListener(){const e=()=>setTimeout(()=>this.highlightActiveConversation(),0);try{window.addEventListener("popstate",e)}catch{}try{const t=history,r=o=>{const i=t[o];t[o]=function(...s){const a=i.apply(this,s);try{e()}catch{}return a}};r("pushState"),r("replaceState")}catch{}try{let t=location.pathname;const r=window.setInterval(()=>{const o=location.pathname;o!==t&&(t=o,e())},400);this.cleanupFns.push(()=>{try{clearInterval(r)}catch{}})}catch{}}renderFolder(e,t=0){const r=document.createElement("div");r.className="gv-folder-item",r.dataset.folderId=e.id,r.dataset.pinned=e.pinned?"true":"false",r.dataset.level=String(t);const o=document.createElement("div");o.className="gv-folder-item-header",o.style.paddingLeft=`${t*16+8}px`,r.appendChild(o),this.bindDropZone(o,e.id);const i=document.createElement("button");i.className="gv-folder-expand-btn",i.appendChild(this.createIcon(e.isExpanded?"expand_more":"chevron_right")),i.addEventListener("click",()=>{e.isExpanded=!e.isExpanded,this.save().then(()=>this.render())}),o.appendChild(i);const s=document.createElement("span");s.className="gv-folder-icon google-symbols",s.dataset.icon="folder",s.textContent="folder",o.appendChild(s);const a=document.createElement("span");a.className="gv-folder-name gds-label-l",a.textContent=e.name,a.addEventListener("dblclick",()=>this.renameFolder(e.id)),o.appendChild(a);const l=document.createElement("button");l.className="gv-folder-pin-btn",l.title=e.pinned?this.t("folder_unpin"):this.t("folder_pin");try{l.dataset.state=e.pinned?"pinned":"unpinned"}catch{}l.appendChild(this.createIcon("push_pin")),l.addEventListener("click",()=>{e.pinned=!e.pinned,this.save().then(()=>this.render())}),o.appendChild(l);const d=document.createElement("button");if(d.className="gv-folder-actions-btn",d.appendChild(this.createIcon("more_vert")),d.addEventListener("click",u=>this.openFolderMenu(u,e.id)),o.appendChild(d),e.isExpanded){const u=document.createElement("div");u.className="gv-folder-content",this.bindDropZone(u,e.id);const m=this.data.folderContents[e.id]||[];for(const p of m){const f=this.renderConversation(e.id,p);f.style.paddingLeft=`${(t+1)*16+8}px`,u.appendChild(f)}if(t===0){const p=this.data.folders.filter(f=>f.parentId===e.id);p.sort((f,g)=>{const b=f.pinned?1:0,w=g.pinned?1:0;return b!==w?w-b:f.createdAt-g.createdAt});for(const f of p)u.appendChild(this.renderFolder(f,t+1))}r.appendChild(u)}return r}renderConversation(e,t){const r=document.createElement("div");r.className=t.starred?"gv-folder-conversation gv-starred":"gv-folder-conversation",r.dataset.folderId=e,r.dataset.conversationId=t.conversationId;const o=document.createElement("span");o.className="gv-conversation-icon google-symbols",o.dataset.icon="chat",o.textContent="chat",r.appendChild(o);const i=document.createElement("span");i.className="gv-conversation-title gds-label-l",i.textContent=t.title||this.t("conversation_untitled"),r.appendChild(i);const s=document.createElement("button");s.className=t.starred?"gv-conversation-star-btn starred":"gv-conversation-star-btn",s.appendChild(this.createIcon(t.starred?"star":"star_outline")),s.title=t.starred?this.t("conversation_unstar"):this.t("conversation_star"),s.addEventListener("click",l=>{l.stopPropagation(),t.starred=!t.starred,this.save().then(()=>this.render())}),r.appendChild(s);const a=document.createElement("button");return a.className="gv-conversation-remove-btn",a.appendChild(this.createIcon("close")),a.title=this.t("folder_remove_conversation"),a.addEventListener("click",l=>{l.stopPropagation(),this.confirmRemoveConversation(e,t.conversationId,t.title||"",l)}),r.appendChild(a),r.addEventListener("click",()=>this.navigateToPrompt(t.conversationId,t.url)),r.draggable=!0,r.addEventListener("dragstart",l=>{const d={type:"conversation",conversationId:t.conversationId,title:t.title,url:t.url,sourceFolderId:e};try{l.dataTransfer?.setData("application/json",JSON.stringify(d))}catch{}try{l.dataTransfer?.setDragImage(r,10,10)}catch{}}),r}openFolderMenu(e,t){e.stopPropagation();const r=this.data.folders.find(d=>d.id===t);if(!r)return;const o=document.createElement("div");if(o.className="gv-context-menu",!r.parentId){const d=document.createElement("button");d.textContent=this.t("folder_create_subfolder")||"Create Subfolder",d.addEventListener("click",()=>{this.createFolder(t);try{document.body.removeChild(o)}catch{}}),o.appendChild(d)}const i=document.createElement("button");i.textContent=this.t("folder_rename"),i.addEventListener("click",()=>{this.renameFolder(t);try{document.body.removeChild(o)}catch{}}),o.appendChild(i);const s=document.createElement("button");s.textContent=this.t("folder_delete"),s.addEventListener("click",()=>{this.deleteFolder(t);try{document.body.removeChild(o)}catch{}}),o.appendChild(s);const a=o.style;a.position="fixed",a.top=`${e.clientY}px`,a.left=`${e.clientX}px`,a.zIndex=String(2147483647),a.display="flex",a.flexDirection="column",document.body.appendChild(o);const l=d=>{if(d.target instanceof Node&&!o.contains(d.target)){try{document.body.removeChild(o)}catch{}window.removeEventListener("click",l,!0)}};window.addEventListener("click",l,!0)}async createFolder(e=null){const t=prompt(this.t("folder_name_prompt"));if(!t)return;const r={id:ml(),name:t.trim(),parentId:e||null,isExpanded:!0,createdAt:bn(),updatedAt:bn()};this.data.folders.push(r),this.data.folderContents[r.id]=[],await this.save(),this.render()}async renameFolder(e){const t=this.data.folders.find(o=>o.id===e);if(!t)return;const r=prompt(this.t("folder_rename_prompt"),t.name);r&&(t.name=r.trim(),t.updatedAt=bn(),await this.save(),this.render())}async deleteFolder(e){if(!confirm(this.t("folder_delete_confirm")))return;const t=[e],r=this.data.folders.filter(o=>o.parentId===e);for(const o of r)t.push(o.id);this.data.folders=this.data.folders.filter(o=>!t.includes(o.id));for(const o of t)delete this.data.folderContents[o];await this.save(),this.render()}removeConversationFromFolder(e,t){const r=this.data.folderContents[e]||[];this.data.folderContents[e]=r.filter(o=>o.conversationId!==t),this.save().then(()=>this.render())}confirmRemoveConversation(e,t,r,o){const i=document.createElement("div");i.className="gv-folder-confirm-dialog gv-aistudio-confirm";const s=o.currentTarget,a=s.getBoundingClientRect();i.style.position="fixed",i.style.zIndex="2147483647",i.style.top=`${a.bottom+4}px`,i.style.left=`${a.right-200}px`,parseInt(i.style.left)<10&&(i.style.left="10px");const l=document.createElement("div");l.className="gv-confirm-message",l.textContent=this.t("folder_remove_conversation_confirm").replace("{title}",r||this.t("conversation_untitled")),i.appendChild(l);const d=document.createElement("div");d.className="gv-confirm-actions";const u=document.createElement("button");u.className="gv-confirm-btn gv-confirm-delete",u.textContent=this.t("pm_delete")||"Delete",u.addEventListener("click",()=>{this.removeConversationFromFolder(e,t),i.remove(),document.removeEventListener("click",p)});const m=document.createElement("button");m.className="gv-confirm-btn gv-confirm-cancel",m.textContent=this.t("pm_cancel")||"Cancel",m.addEventListener("click",()=>{i.remove(),document.removeEventListener("click",p)}),d.appendChild(u),d.appendChild(m),i.appendChild(d),document.body.appendChild(i);const p=f=>{!i.contains(f.target)&&f.target!==s&&!s.contains(f.target)&&(i.remove(),document.removeEventListener("click",p))};setTimeout(()=>{document.addEventListener("click",p)},10)}bindDropZone(e,t){let r=0;e.addEventListener("dragenter",o=>{o.preventDefault(),o.stopPropagation(),r++,r===1&&e.classList.add("gv-folder-dragover")}),e.addEventListener("dragover",o=>{o.preventDefault(),o.stopPropagation();try{o.dataTransfer&&(o.dataTransfer.dropEffect="move")}catch{}}),e.addEventListener("dragleave",o=>{if(o.stopPropagation(),r--,r<=0){r=0;const i=o.relatedTarget;(!i||!e.contains(i))&&e.classList.remove("gv-folder-dragover")}}),e.addEventListener("drop",o=>{o.preventDefault(),o.stopPropagation(),r=0,e.classList.remove("gv-folder-dragover");let i=o.dataTransfer?.getData("application/json");if(!i)try{i=o.dataTransfer?.getData("text/plain")||""}catch{}if(!i)return;let s=null;try{s=JSON.parse(i)}catch{s=null}if(!s||s.type!=="conversation"||!s.conversationId)return;const a={conversationId:s.conversationId,title:cr(s.title)||this.t("conversation_untitled"),url:s.url||"",addedAt:bn()},l=t;if(!l||l===this.UNCATEGORIZED_KEY){Object.keys(this.data.folderContents).forEach(m=>{m!==this.UNCATEGORIZED_KEY&&(this.data.folderContents[m]=(this.data.folderContents[m]||[]).filter(p=>p.conversationId!==a.conversationId))});const d=this.data.folderContents[this.UNCATEGORIZED_KEY]||[];d.some(m=>m.conversationId===a.conversationId)||(d.push(a),this.data.folderContents[this.UNCATEGORIZED_KEY]=d)}else{const d=this.data.folderContents[l]||[];d.some(m=>m.conversationId===a.conversationId)||(d.push(a),this.data.folderContents[l]=d),Object.keys(this.data.folderContents).forEach(m=>{m!==l&&(this.data.folderContents[m]=(this.data.folderContents[m]||[]).filter(p=>p.conversationId!==a.conversationId))})}this.save().then(()=>this.render())})}observePromptList(){const e=this.historyRoot;if(!e)return;const t=new MutationObserver(()=>{this.bindDraggablesInPromptList(),this.highlightActiveConversation()});try{t.observe(e,{childList:!0,subtree:!0})}catch{}this.cleanupFns.push(()=>{try{t.disconnect()}catch{}});const r=o=>{const i=o.target;if(!i)return;const s=i.closest("a.prompt-link");s&&/\/prompts\//.test(s.getAttribute("href")||"")&&setTimeout(()=>this.highlightActiveConversation(),0)};try{e.addEventListener("click",r,!0)}catch{}this.cleanupFns.push(()=>{try{e.removeEventListener("click",r,!0)}catch{}})}bindDraggablesInPromptList(){document.querySelectorAll('ms-prompt-history-v3 a.prompt-link[href^="/prompts/"]').forEach(t=>{const r=t,i=r.closest("li")||r;i._gvDragBound||(i._gvDragBound=!0,i.draggable=!0,i.addEventListener("dragstart",s=>{const a=this.extractPromptId(r),l=cr(r.textContent||""),d=r.href||`${location.origin}${r.getAttribute("href")||""}`,u={type:"conversation",conversationId:a,title:l,url:d};try{s.dataTransfer&&(s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("application/json",JSON.stringify(u)),s.dataTransfer.setData("text/plain",JSON.stringify(u)))}catch{}try{s.dataTransfer?.setDragImage(i,10,10)}catch{}}))})}observeLibraryTable(){const e=document.querySelector("table.mat-mdc-table, mat-table");if(!e){const r=new MutationObserver(()=>{document.querySelector("table.mat-mdc-table, mat-table")&&this.bindDraggablesInLibraryTable()});try{r.observe(document.body,{childList:!0,subtree:!0})}catch{}this.cleanupFns.push(()=>{try{r.disconnect()}catch{}});return}const t=new MutationObserver(()=>{this.bindDraggablesInLibraryTable()});try{t.observe(e,{childList:!0,subtree:!0})}catch{}this.cleanupFns.push(()=>{try{t.disconnect()}catch{}})}bindDraggablesInLibraryTable(){document.querySelectorAll("tr.mat-mdc-row, tr[mat-row]").forEach(t=>{const r=t,o=r.querySelector('a[href^="/prompts/"], a.name-btn[href*="/prompts/"]');o&&(r._gvLibraryDragBound||(r._gvLibraryDragBound=!0,r.draggable=!0,r.style.cursor="grab",r.addEventListener("dragstart",i=>{i.stopPropagation();const s=this.extractPromptId(o),a=cr(o.textContent||""),l=o.getAttribute("href")||o.href||"",d=l.startsWith("http")?l:`${location.origin}${l.startsWith("/")?"":"/"}${l}`,u={type:"conversation",conversationId:s,title:a,url:d};try{if(i.dataTransfer){i.dataTransfer.effectAllowed="copyMove";const m=JSON.stringify(u);i.dataTransfer.setData("application/json",m),i.dataTransfer.setData("text/plain",m)}}catch{}try{i.dataTransfer?.setDragImage(r,10,10)}catch{}r.style.opacity="0.5"}),r.addEventListener("dragend",()=>{r.style.opacity=""})))})}injectLibraryDropZone(){const e=document.createElement("div");e.className="gv-library-drop-zone",e.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(32, 33, 36, 0.95);
      border: 2px dashed rgba(138, 180, 248, 0.5);
      border-radius: 12px;
      padding: 16px;
      min-width: 200px;
      max-width: 300px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 2147483646;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
      transform: translateY(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
    `;const t=document.createElement("div");t.style.cssText=`
      color: #e8eaed;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    `,t.innerHTML=`<span class="google-symbols" style="font-size: 18px;">folder</span>${this.t("folder_title")}`,e.appendChild(t);const r=document.createElement("div");r.className="gv-library-folder-list",e.appendChild(r),document.body.appendChild(e);const o=()=>{r.innerHTML="";const l=document.createElement("div");l.className="gv-library-folder-item gv-library-root-item",l.style.cssText=`
        padding: 10px 12px;
        margin: 4px 0 12px 0;
        background: rgba(138, 180, 248, 0.1);
        border-radius: 8px;
        color: #8ab4f8;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.15s, border-color 0.15s;
        border: 2px dashed rgba(138, 180, 248, 0.4);
      `,l.innerHTML=`<span class="google-symbols" data-icon="inbox">inbox</span>${this.t("folder_uncategorized")||"Uncategorized"}`;const d=p=>{p.preventDefault(),p.stopPropagation(),l.style.background="rgba(138, 180, 248, 0.2)",l.style.borderColor="#8ab4f8";let f=p.dataTransfer?.getData("application/json");if(!f)try{f=p.dataTransfer?.getData("text/plain")||""}catch{}if(!f)return;let g=null;try{g=JSON.parse(f)}catch{g=null}if(!g||g.type!=="conversation"||!g.conversationId)return;const b={conversationId:g.conversationId,title:cr(g.title)||this.t("conversation_untitled"),url:g.url||"",addedAt:bn()};Object.keys(this.data.folderContents).forEach(S=>{S!==this.UNCATEGORIZED_KEY&&(this.data.folderContents[S]=(this.data.folderContents[S]||[]).filter(C=>C.conversationId!==b.conversationId))});const w=this.data.folderContents[this.UNCATEGORIZED_KEY]||[];w.some(S=>S.conversationId===b.conversationId)||(w.push(b),this.data.folderContents[this.UNCATEGORIZED_KEY]=w),this.save(),this.showNotification(this.t("conversation_saved_to_root")||"Saved to Uncategorized","info")};if(l.addEventListener("dragenter",p=>{p.preventDefault(),p.stopPropagation(),l.style.background="rgba(138, 180, 248, 0.3)",l.style.borderColor="#8ab4f8"}),l.addEventListener("dragover",p=>{p.preventDefault(),p.stopPropagation();try{p.dataTransfer&&(p.dataTransfer.dropEffect="copy")}catch{}}),l.addEventListener("dragleave",p=>{p.stopPropagation(),l.style.background="rgba(138, 180, 248, 0.1)",l.style.borderColor="rgba(138, 180, 248, 0.4)"}),l.addEventListener("drop",d),r.appendChild(l),this.data.folders.length===0){const p={id:ml(),name:this.t("folder_default_name")||"My Folder",parentId:null,isExpanded:!0,createdAt:bn(),updatedAt:bn()};this.data.folders.push(p),this.data.folderContents[p.id]=[],this.save()}const u=this.data.folders.filter(p=>!p.parentId);u.sort((p,f)=>{const g=p.pinned?1:0,b=f.pinned?1:0;return g!==b?b-g:p.createdAt-f.createdAt});const m=(p,f)=>{const g=document.createElement("div");g.className="gv-library-folder-item",g.dataset.folderId=p.id;const b=f?"28px":"12px";g.style.cssText=`
          padding: 10px ${b};
          margin: 4px 0;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 8px;
          color: #e8eaed;
          font-size: 13px;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: background 0.15s, border-color 0.15s;
          border: 2px solid transparent;
        `;const w=f?"subdirectory_arrow_right":"folder";return g.innerHTML=`<span class="google-symbols" style="font-size: 16px; color: #8ab4f8;">${w}</span>${p.name}`,g.addEventListener("dragenter",v=>{v.preventDefault(),v.stopPropagation(),g.style.background="rgba(138, 180, 248, 0.2)",g.style.borderColor="#8ab4f8"}),g.addEventListener("dragover",v=>{v.preventDefault(),v.stopPropagation();try{v.dataTransfer&&(v.dataTransfer.dropEffect="move")}catch{}}),g.addEventListener("dragleave",v=>{v.stopPropagation(),g.style.background="rgba(255, 255, 255, 0.05)",g.style.borderColor="transparent"}),g.addEventListener("drop",v=>{v.preventDefault(),v.stopPropagation(),g.style.background="rgba(255, 255, 255, 0.05)",g.style.borderColor="transparent";let S=v.dataTransfer?.getData("application/json");if(!S)try{S=v.dataTransfer?.getData("text/plain")||""}catch{}if(!S)return;let C=null;try{C=JSON.parse(S)}catch{C=null}if(!C||C.type!=="conversation"||!C.conversationId)return;const L={conversationId:C.conversationId,title:cr(C.title)||this.t("conversation_untitled"),url:C.url||"",addedAt:bn()},I=this.data.folderContents[p.id]||[];I.some(F=>F.conversationId===L.conversationId)||(I.push(L),this.data.folderContents[p.id]=I),Object.keys(this.data.folderContents).forEach(F=>{F!==p.id&&(this.data.folderContents[F]=(this.data.folderContents[F]||[]).filter(W=>W.conversationId!==L.conversationId))}),this.save(),this.showNotification(`${this.t("conversation_added_to_folder")||"Added to"} "${p.name}"`,"info")}),g};u.forEach(p=>{r.appendChild(m(p,!1));const f=this.data.folders.filter(g=>g.parentId===p.id);f.sort((g,b)=>{const w=g.pinned?1:0,v=b.pinned?1:0;return w!==v?v-w:g.createdAt-b.createdAt}),f.forEach(g=>{r.appendChild(m(g,!0))})})},i=()=>{o(),e.style.opacity="1",e.style.pointerEvents="auto",e.style.transform="translateY(0)"},s=()=>{e.style.opacity="0",e.style.pointerEvents="none",e.style.transform="translateY(10px)"},a=l=>{const u=l.target.closest?.("tr.mat-mdc-row, tr[mat-row]");u&&u.querySelector('a[href*="/prompts/"]')&&setTimeout(i,0)};document.addEventListener("dragstart",a),document.addEventListener("dragend",()=>{setTimeout(s,100)}),this.cleanupFns.push(()=>{try{document.removeEventListener("dragstart",a),document.body.removeChild(e)}catch{}})}extractPromptId(e){const t=e.getAttribute("href")||e.href||"",r=t.match(/\/prompts\/([^\/?#]+)/);if(r&&r[1])return r[1];try{const i=(new URL(t,location.origin).pathname||"").split("/").filter(Boolean);return i.length>=2&&i[0]==="prompts"?i[1]:i[1]||t}catch{return t}}navigateToPrompt(e,t){const r=`ms-prompt-history-v3 a.prompt-link[href*="/prompts/${e}"]`,o=document.querySelector(r);if(o){o.click(),setTimeout(()=>this.highlightActiveConversation(),0);return}try{window.history.pushState({},"",t),window.dispatchEvent(new PopStateEvent("popstate")),setTimeout(()=>this.highlightActiveConversation(),0)}catch{location.href=t}}handleExport(){const e={format:"gemini-voyager.folders.v1",exportedAt:new Date().toISOString(),data:this.data};Ff(e,`gemini-voyager-folders-${this.timestamp()}.json`)}handleImport(){const e=document.createElement("input");e.type="file",e.accept="application/json",e.addEventListener("change",async()=>{const t=e.files&&e.files[0];if(t)try{const r=await t.text(),o=JSON.parse(r),i=o&&(o.data||o);if(!i||!Array.isArray(i.folders)||typeof i.folderContents!="object"){alert(this.t("folder_import_invalid_format")||"Invalid file format");return}const s=new Set(this.data.folders.map(a=>a.id));for(const a of i.folders)if(!s.has(a.id))this.data.folders.push(a),this.data.folderContents[a.id]=i.folderContents[a.id]||[];else{const l=this.data.folderContents[a.id]||[],d=i.folderContents[a.id]||[],u=new Set(l.map(m=>m.conversationId));for(const m of d)u.has(m.conversationId)||l.push(m);this.data.folderContents[a.id]=l}await this.save(),this.render(),alert(this.t("folder_import_success")||"Imported")}catch{alert(this.t("folder_import_error")||"Import failed")}},{once:!0}),e.click()}timestamp(){const e=new Date,t=r=>String(r).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())} -${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())} `}async loadFolderEnabledSetting(){try{const e=await Ce.storage.sync.get({geminiFolderEnabled:!0});this.folderEnabled=e.geminiFolderEnabled!==!1}catch(e){console.error("[AIStudioFolderManager] Failed to load folder enabled setting:",e),this.folderEnabled=!0}}setupStorageListener(){Ce.storage.onChanged.addListener((e,t)=>{if(t==="sync"&&(e.geminiFolderEnabled&&(this.folderEnabled=e.geminiFolderEnabled.newValue!==!1,this.applyFolderEnabledSetting()),e[this.SIDEBAR_WIDTH_KEY])){const r=e[this.SIDEBAR_WIDTH_KEY].newValue;if(typeof r=="number"){const o=Math.min(this.MAX_SIDEBAR_WIDTH,Math.max(this.MIN_SIDEBAR_WIDTH,Math.round(r)));this.sidebarWidth=o,this.applySidebarWidth()}}})}applyFolderEnabledSetting(){this.folderEnabled?this.container?this.container.style.display="":this.initializeFolderUI().catch(e=>{console.error("[AIStudioFolderManager] Failed to initialize folder UI:",e)}):this.container&&(this.container.style.display="none")}attemptDataRecovery(e){console.warn("[AIStudioFolderManager] Attempting data recovery after load failure");const t=this.backupService.recoverFromBackup();if(t&&zn(t)){this.data=t,console.warn("[AIStudioFolderManager] Data recovered from localStorage backup"),this.showNotification("Folder data recovered from backup","warning"),this.save();return}if(zn(this.data)&&this.data.folders.length>0){console.warn("[AIStudioFolderManager] Keeping existing in-memory data after load error"),this.showErrorNotification("Failed to load folder data, using cached version");return}console.error("[AIStudioFolderManager] All recovery attempts failed, initializing empty data"),this.data={folders:[],folderContents:{}},this.showErrorNotification("Failed to load folder data. All folders have been reset.")}showErrorNotification(e){this.showNotification(e,"error")}showNotification(e,t="error"){try{const r=document.createElement("div");r.className=`gv - notification gv - notification - ${t} `,r.textContent=`[Gemini Voyager] ${e} `;const o={info:"#2196F3",warning:"#FF9800",error:"#f44336"},i=r.style;i.position="fixed",i.top="20px",i.right="20px",i.padding="12px 20px",i.background=o[t],i.color="white",i.borderRadius="4px",i.boxShadow="0 2px 8px rgba(0,0,0,0.2)",i.zIndex=String(2147483647),i.maxWidth="400px",i.fontSize="14px",i.fontFamily="system-ui, -apple-system, sans-serif",i.lineHeight="1.4",document.body.appendChild(r),setTimeout(()=>{try{document.body.removeChild(r)}catch{}},t==="info"?3e3:t==="warning"?7e3:Of)}catch(r){console.error("[AIStudioFolderManager] Failed to show notification:",r)}}isExtensionContextValid(){try{return!!(Ce?.runtime?.id||chrome?.runtime?.id)}catch{return!1}}async loadSidebarWidth(){try{if(this.isExtensionContextValid()){const t=(await Ce.storage.sync.get({[this.SIDEBAR_WIDTH_KEY]:280}))[this.SIDEBAR_WIDTH_KEY];if(typeof t=="number"&&t>=this.MIN_SIDEBAR_WIDTH&&t<=this.MAX_SIDEBAR_WIDTH){this.sidebarWidth=t;return}}}catch(e){console.warn("[AIStudioFolderManager] Failed to load from sync storage, trying localStorage:",e)}try{const e=localStorage.getItem(this.SIDEBAR_WIDTH_KEY);if(e){const t=parseInt(e,10);typeof t=="number"&&t>=this.MIN_SIDEBAR_WIDTH&&t<=this.MAX_SIDEBAR_WIDTH&&(this.sidebarWidth=t)}}catch(e){console.error("[AIStudioFolderManager] Failed to load sidebar width from localStorage:",e)}}async saveSidebarWidth(){try{localStorage.setItem(this.SIDEBAR_WIDTH_KEY,String(this.sidebarWidth))}catch(e){console.error("[AIStudioFolderManager] Failed to save to localStorage:",e)}if(this.isExtensionContextValid())try{await Ce.storage.sync.set({[this.SIDEBAR_WIDTH_KEY]:this.sidebarWidth})}catch(e){e instanceof Error&&!e.message.includes("Extension context invalidated")&&console.error("[AIStudioFolderManager] Failed to save sidebar width:",e)}}applySidebarWidth(e=!1){const t=document.querySelector(".nav-content.v3-left-nav");if(!t)return;t.classList.contains("expanded")||e?(t.style.width=`${this.sidebarWidth}px`,t.style.minWidth=`${this.sidebarWidth}px`,t.style.maxWidth=`${this.sidebarWidth}px`,t.style.flex=`0 0 ${this.sidebarWidth}px`):(t.style.width="",t.style.minWidth="",t.style.maxWidth="",t.style.flex="")}addResizeHandle(){const e=document.querySelector(".nav-content.v3-left-nav");if(!e){console.warn("[AIStudioFolderManager] nav-content not found, resize handle not added");return}const t=document.createElement("div");t.className="gv-sidebar-resize-handle",t.title="Drag to resize sidebar";const r=t.style;r.position="absolute",r.top="0",r.right="-4px",r.width="8px",r.height="100%",r.cursor="ew-resize",r.zIndex="10000",r.backgroundColor="transparent",r.transition="background-color 0.2s",r.pointerEvents="auto",t.addEventListener("mouseenter",()=>{r.backgroundColor="rgba(66, 133, 244, 0.5)"}),t.addEventListener("mouseleave",()=>{r.backgroundColor="transparent"});let o=!1,i=0,s=0;const a=p=>{o=!0,i=p.clientX,s=this.sidebarWidth,p.preventDefault(),p.stopPropagation(),document.body.style.cursor="ew-resize",document.body.style.userSelect="none"},l=p=>{if(!o)return;const f=p.clientX-i,g=Math.max(this.MIN_SIDEBAR_WIDTH,Math.min(this.MAX_SIDEBAR_WIDTH,s+f));this.sidebarWidth=g,this.applySidebarWidth(!0)},d=()=>{o&&(o=!1,document.body.style.cursor="",document.body.style.userSelect="",this.saveSidebarWidth())};t.addEventListener("mousedown",a),document.addEventListener("mousemove",l),document.addEventListener("mouseup",d),e.style.position="relative",e.appendChild(t);const u=()=>{e.classList.contains("expanded")?r.display="block":r.display="none"},m=new MutationObserver(p=>{for(const f of p)if(f.type==="attributes"&&f.attributeName==="class"){u(),this.applySidebarWidth();break}});try{m.observe(e,{attributes:!0,attributeFilter:["class"]})}catch(p){console.error("[AIStudioFolderManager] Failed to observe nav-content:",p)}u(),this.cleanupFns.push(()=>{try{m.disconnect(),t.removeEventListener("mousedown",a),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",d),t.parentElement&&t.parentElement.removeChild(t)}catch{}})}async handleCloudUpload(){try{this.showNotification(this.t("uploadInProgress"),"info");const e=this.data;let t=[];try{const o=await chrome.storage.local.get(["gvPromptItems"]);o.gvPromptItems&&(t=o.gvPromptItems)}catch(o){console.warn("[AIStudioFolderManager] Could not get prompts for upload:",o)}console.log(`[AIStudioFolderManager] Uploading - folders: ${e.folders?.length||0}, prompts: ${t.length}`);const r=await Ce.runtime.sendMessage({type:"gv.sync.upload",payload:{folders:e,prompts:t,platform:"aistudio"}});if(r?.ok)this.showNotification(this.t("uploadSuccess"),"info");else{const o=r?.error||"Unknown error";this.showNotification(this.t("syncError").replace("{error}",o),"error")}}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error("[AIStudioFolderManager] Cloud upload failed:",e),this.showNotification(this.t("syncError").replace("{error}",t),"error")}}async handleCloudSync(){try{this.showNotification(this.t("downloadInProgress"),"info");const e=await Ce.runtime.sendMessage({type:"gv.sync.download",payload:{platform:"aistudio"}});if(!e?.ok){const u=e?.error||"Download failed";this.showNotification(this.t("syncError").replace("{error}",u),"error");return}if(!e.data){this.showNotification(this.t("syncNoData")||"No data in cloud","info");return}const t=e.data?.folders,r=e.data?.prompts,o=t?.data||{folders:[],folderContents:{}},i=r?.items||[];console.log(`[AIStudioFolderManager] Downloaded - folders: ${o.folders?.length||0}, prompts: ${i.length}`);let s=[];try{const u=await chrome.storage.local.get(["gvPromptItems"]);u.gvPromptItems&&(s=u.gvPromptItems)}catch(u){console.warn("[AIStudioFolderManager] Could not get local prompts for merge:",u)}const a=this.data,l=this.mergeFolderData(a,o),d=this.mergePromptsData(s,i);console.log(`[AIStudioFolderManager] Merged - folders: ${l.folders?.length||0}, prompts: ${d.length}`),this.data=l,await this.save();try{await chrome.storage.local.set({gvPromptItems:d})}catch(u){console.error("[AIStudioFolderManager] Failed to save merged prompts:",u)}this.render(),this.showNotification(this.t("downloadMergeSuccess"),"info")}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error("[AIStudioFolderManager] Cloud sync failed:",e),this.showNotification(this.t("syncError").replace("{error}",t),"error")}}mergePromptsData(e,t){const r=new Map;return e.forEach(o=>{o?.id&&r.set(o.id,o)}),t.forEach(o=>{if(!o?.id)return;const i=r.get(o.id);if(!i)r.set(o.id,o);else{const s=o.updatedAt||o.createdAt||0,a=i.updatedAt||i.createdAt||0;s>a&&r.set(o.id,o)}}),Array.from(r.values())}async getCloudUploadTooltip(){try{const e=await Ce.runtime.sendMessage({type:"gv.sync.getState"});if(e?.ok&&e.state){const t=e.state.lastUploadTime,r=this.formatRelativeTime(t??null),o=this.t("folder_cloud_upload");return t?`${o}
${this.t("lastUploaded").replace("{time}",r)}`:`${o}
${this.t("neverUploaded")}`}}catch(e){console.warn("[AIStudioFolderManager] Failed to get sync state for tooltip:",e)}return this.t("folder_cloud_upload")}async getCloudSyncTooltip(){try{const e=await Ce.runtime.sendMessage({type:"gv.sync.getState"});if(e?.ok&&e.state){const t=e.state.lastSyncTime,r=this.formatRelativeTime(t??null),o=this.t("folder_cloud_sync");return t?`${o}
${this.t("lastSynced").replace("{time}",r)}`:`${o}
${this.t("neverSynced")}`}}catch(e){console.warn("[AIStudioFolderManager] Failed to get sync state for tooltip:",e)}return this.t("folder_cloud_sync")}formatRelativeTime(e){if(!e)return"";const r=Date.now()-e,o=Math.floor(r/6e4),i=Math.floor(r/36e5),s=Math.floor(r/864e5);return o<1?this.t("justNow"):o<60?`${o} ${this.t("minutesAgo")}`:i<24?`${i} ${this.t("hoursAgo")}`:s===1?this.t("yesterday"):new Date(e).toLocaleDateString()}}async function Pf(){try{await new Rf().init()}catch(n){console.error("[AIStudioFolderManager] Start error:",n)}}var nn=(n=>(n.INVALID_FORMAT="INVALID_FORMAT",n.INVALID_VERSION="INVALID_VERSION",n.MISSING_DATA="MISSING_DATA",n.CORRUPTED_DATA="CORRUPTED_DATA",n))(nn||{});const pl="gemini-voyager.folders.v1";class dr{static exportToPayload(e){return{format:pl,exportedAt:new Date().toISOString(),version:Wd,data:{folders:e.folders,folderContents:e.folderContents}}}static validatePayload(e){if(!e||typeof e!="object")return{success:!1,error:{type:nn.INVALID_FORMAT,message:"Invalid payload: expected an object",details:e}};const t=e;if(typeof t.format!="string"||!Vd(t.format))return{success:!1,error:{type:nn.INVALID_VERSION,message:`Unsupported format: expected "${pl}", got "${t.format}"`,details:{format:t.format}}};if(typeof t.version=="string"){const o=Yd(t.version,t.format);if(!o.compatible)return{success:!1,error:{type:nn.INVALID_VERSION,message:o.reason||"Version incompatible",details:o}}}if(!t.data||typeof t.data!="object")return{success:!1,error:{type:nn.MISSING_DATA,message:'Missing or invalid "data" field',details:t}};const r=t.data;if(!Array.isArray(r.folders))return{success:!1,error:{type:nn.CORRUPTED_DATA,message:'Invalid "folders" field: expected an array',details:r.folders}};if(!r.folderContents||typeof r.folderContents!="object")return{success:!1,error:{type:nn.CORRUPTED_DATA,message:'Invalid "folderContents" field: expected an object',details:r.folderContents}};for(const o of r.folders){if(!o||typeof o!="object")return{success:!1,error:{type:nn.CORRUPTED_DATA,message:"Invalid folder object",details:o}};const i=o;if(!i.id||typeof i.id!="string")return{success:!1,error:{type:nn.CORRUPTED_DATA,message:'Folder missing valid "id" field',details:o}};if(!i.name||typeof i.name!="string")return{success:!1,error:{type:nn.CORRUPTED_DATA,message:'Folder missing valid "name" field',details:o}}}return{success:!0,data:e}}static mergeData(e,t){const r=new Set(e.folders.map(m=>m.id)),o=[];let i=0;for(const m of t.folders)r.has(m.id)?i++:o.push(m);const s={...e.folderContents};let a=0,l=0;for(const[m,p]of Object.entries(t.folderContents)){s[m]||(s[m]=[]);const f=new Set(s[m].map(g=>g.conversationId));for(const g of p)f.has(g.conversationId)?l++:(s[m].push(g),a++)}const d={folders:[...e.folders,...o],folderContents:s},u={foldersImported:o.length,conversationsImported:a,duplicatesFoldersSkipped:i,duplicatesConversationsSkipped:l};return{merged:d,stats:u}}static importFromPayloadInternal(e,t,r){try{const{strategy:o,createBackup:i=!0}=r;let s=e.data;const a=[];if(e.version)try{const m=Kd(e.data,e.version);s=m.data,a.push(...m.migrationsApplied),a.length>0&&console.log("Applied migrations:",a)}catch(m){console.warn("Migration failed, using original data:",m)}let l=null;i&&(l={folders:[...t.folders],folderContents:{...t.folderContents}});let d,u;if(o==="overwrite"){d={folders:[...s.folders],folderContents:{...s.folderContents}};const m=Object.values(s.folderContents).reduce((p,f)=>p+f.length,0);u={foldersImported:s.folders.length,conversationsImported:m,backupCreated:i}}else{const m=this.mergeData(t,s);d=m.merged,u={...m.stats,backupCreated:i}}if(l)try{sessionStorage.setItem(so,JSON.stringify(l)),sessionStorage.setItem(ui,new Date().toISOString())}catch(m){console.warn("Failed to store backup in sessionStorage",m)}return{success:!0,data:{data:d,stats:u}}}catch(o){return{success:!1,error:new An(ut.UNKNOWN_ERROR,"Import failed",{originalError:o})}}}static async importFromPayload(e,t,r){return await lm.withLock(cm.FOLDER_IMPORT,()=>Promise.resolve(this.importFromPayloadInternal(e,t,r)),3e4)}static generateExportFilename(){const e=d=>String(d).padStart(2,"0"),t=new Date,r=t.getFullYear(),o=e(t.getMonth()+1),i=e(t.getDate()),s=e(t.getHours()),a=e(t.getMinutes()),l=e(t.getSeconds());return`gemini-voyager-folders-${r}${o}${i}-${s}${a}${l}.json`}static downloadJSON(e,t){const r=JSON.stringify(e,null,2),o=new Blob([r],{type:"application/json;charset=utf-8"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download=t||this.generateExportFilename(),document.body.appendChild(s),s.click(),setTimeout(()=>{try{document.body.removeChild(s)}catch{}URL.revokeObjectURL(i)},0)}static async readJSONFile(e){try{const t=await e.text();return{success:!0,data:JSON.parse(t)}}catch(t){return{success:!1,error:new An(ut.VALIDATION_ERROR,"Failed to parse JSON file",{originalError:t})}}}static restoreFromBackup(){try{const e=sessionStorage.getItem(so);return e?{success:!0,data:JSON.parse(e)}:{success:!1,error:new An(ut.STORAGE_READ_FAILED,"No backup found")}}catch(e){return{success:!1,error:new An(ut.UNKNOWN_ERROR,"Failed to restore backup",{originalError:e})}}}static clearBackup(){try{sessionStorage.removeItem(so),sessionStorage.removeItem(ui)}catch{}}static hasBackup(){try{return sessionStorage.getItem(so)!==null}catch{return!1}}static getBackupTimestamp(){try{return sessionStorage.getItem(ui)}catch{return null}}}const hd=[{id:"default",nameKey:"folder_color_default",lightColor:"#6b7280",darkColor:"#9ca3af",priority:"neutral"},{id:"red",nameKey:"folder_color_red",lightColor:"#ef4444",darkColor:"#f87171",priority:"critical"},{id:"orange",nameKey:"folder_color_orange",lightColor:"#f97316",darkColor:"#fb923c",priority:"high"},{id:"yellow",nameKey:"folder_color_yellow",lightColor:"#eab308",darkColor:"#fbbf24",priority:"high"},{id:"green",nameKey:"folder_color_green",lightColor:"#22c55e",darkColor:"#4ade80",priority:"medium"},{id:"blue",nameKey:"folder_color_blue",lightColor:"#3b82f6",darkColor:"#60a5fa",priority:"medium"},{id:"purple",nameKey:"folder_color_purple",lightColor:"#a855f7",darkColor:"#c084fc",priority:"low"}];function fl(n,e){if(!n||n==="default")return e?"#9ca3af":"#6b7280";if(n.startsWith("#"))return n;if(n==="pink")return e?"#f472b6":"#ec4899";const t=hd.find(r=>r.id===n);return t?e?t.darkColor:t.lightColor:e?"#9ca3af":"#6b7280"}function gl(){return!!(document.documentElement.classList.contains("dark-mode")||document.documentElement.getAttribute("data-theme")==="dark"||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)}const md=[{id:"learning-coach",name:"Learning Coach",icon:"auto_stories"},{id:"brainstormer",name:"Brainstorm Buddy",icon:"lightbulb"},{id:"career-guide",name:"Career Guide",icon:"work"},{id:"coding-partner",name:"Coding Partner",icon:"code"},{id:"writing-editor",name:"Writing Editor",icon:"edit_note"},{id:"storybook",name:"Storybook",icon:"menu_book"},{id:"chess-champ",name:"Chess Champ",icon:"chess_pawn"},{id:"productivity-helper",name:"Productivity Helper",icon:"check_circle"},{id:"cricket",name:"Cricket",icon:"sports_cricket"}],Bf="stars",$f="chat_bubble";function qf(n){return md.find(e=>e.id===n)}function zf(n){return qf(n)?.icon||Bf}class Uf{async getItem(e){try{const r=(await Ce.storage.local.get(e))[e];return typeof r=="string"?r:null}catch(t){console.error("[SafariStorage] Failed to get item:",e,t);try{return localStorage.getItem(e)}catch{return null}}}async setItem(e,t){try{await Ce.storage.local.set({[e]:t})}catch(r){console.error("[SafariStorage] Failed to set item:",e,r);try{localStorage.setItem(e,t)}catch(o){throw console.error("[SafariStorage] Fallback to localStorage also failed:",o),r}}}async removeItem(e){try{await Ce.storage.local.remove(e)}catch(t){console.error("[SafariStorage] Failed to remove item:",e,t);try{localStorage.removeItem(e)}catch{}}}async migrateFromLocalStorage(e){try{const t=`${e}_migrated`;if(await this.getItem(t)==="true")return!0;const o=localStorage.getItem(e);return o?(await Ce.storage.local.get(e))[e]?(await this.setItem(t,"true"),!0):(await this.setItem(e,o),await this.setItem(t,"true"),console.log(`[SafariStorage] Successfully migrated ${e} from localStorage to browser.storage.local`),!0):(await this.setItem(t,"true"),!0)}catch(t){return console.error("[SafariStorage] Migration failed:",t),!1}}}const ur=new Uf;class Hf{async init(e){try{const t=localStorage.getItem(e);if(t&&!(await chrome.storage.local.get(e))[e]){const o=JSON.parse(t);await chrome.storage.local.set({[e]:o}),console.log("[LocalStorageFolderAdapter] Migrated folder data to chrome.storage.local")}}catch(t){console.warn("[LocalStorageFolderAdapter] Migration check failed:",t)}}async loadData(e){try{const t=await chrome.storage.local.get(e);if(t[e])return console.log("[LocalStorageFolderAdapter] Loaded data from chrome.storage.local"),localStorage.setItem(e,JSON.stringify(t[e])),t[e];const r=localStorage.getItem(e);return r?JSON.parse(r):null}catch(t){return console.error("[LocalStorageFolderAdapter] Failed to load data:",t),null}}async saveData(e,t){try{const r=JSON.stringify(t);if(localStorage.setItem(e,r),localStorage.getItem(e)!==r)throw new Error("Save verification failed - data mismatch");try{await chrome.storage.local.set({[e]:t})}catch(i){console.warn("[LocalStorageFolderAdapter] Failed to mirror to chrome.storage.local:",i)}return!0}catch(r){return console.error("[LocalStorageFolderAdapter] Failed to save data:",r),!1}}async removeData(e){try{localStorage.removeItem(e)}catch(t){console.error("[LocalStorageFolderAdapter] Failed to remove data:",t)}}getBackendName(){return"localStorage"}}class Gf{async init(e){await this.migrateFromLocalStorage(e)}async loadData(e){try{const t=await ur.getItem(e);return t?JSON.parse(t):null}catch(t){return console.error("[SafariFolderAdapter] Failed to load data:",t),null}}async saveData(e,t){try{const r=JSON.stringify(t);if(await ur.setItem(e,r),await ur.getItem(e)!==r)throw new Error("Save verification failed - data mismatch");return!0}catch(r){return console.error("[SafariFolderAdapter] Failed to save data:",r),!1}}async removeData(e){try{await ur.removeItem(e)}catch(t){console.error("[SafariFolderAdapter] Failed to remove data:",t)}}getBackendName(){return"browser.storage.local (Safari)"}async migrateFromLocalStorage(e){try{return await ur.migrateFromLocalStorage(e)}catch(t){return console.error("[SafariFolderAdapter] Migration failed:",t),!1}}}function pd(){return en()?(console.log("[FolderStorage] Using SafariFolderAdapter (browser.storage.local)"),new Gf):(console.log("[FolderStorage] Using LocalStorageFolderAdapter (localStorage)"),new Hf)}const hr="gvFolderData",bl=!1,mr="__root_conversations__",jf=1e4,so="gvFolderBackup",ui="gvFolderBackupTimestamp";function ao(n){return n&&typeof n=="object"&&Array.isArray(n.folders)&&typeof n.folderContents=="object"}class Wf{debug(...e){this.isDebugEnabled()&&console.log("[FolderManager]",...e)}debugWarn(...e){this.isDebugEnabled()&&console.warn("[FolderManager]",...e)}isDebugEnabled(){try{return bl||localStorage.getItem("gvFolderDebug")==="1"}catch{return bl}}storage;backupService;data={folders:[],folderContents:{}};containerElement=null;sidebarContainer=null;recentSection=null;tooltipElement=null;tooltipTimeout=null;sideNavObserver=null;conversationObserver=null;importInProgress=!1;exportInProgress=!1;selectedConversations=new Set;isMultiSelectMode=!1;multiSelectSource=null;multiSelectFolderId=null;longPressTimeout=null;longPressThreshold=500;folderEnabled=!0;hideArchivedConversations=!1;filterCurrentUserOnly=!1;navPoller=null;lastPathname=null;saveInProgress=!1;pendingTitleUpdates=new Map;pendingRemovals=new Map;removalCheckDelay=300;isDestroyed=!1;reinitializePromise=null;activeColorPicker=null;activeColorPickerFolderId=null;activeColorPickerCloseHandler=null;routeChangeCleanup=null;sidebarClickListener=null;nativeMenuObserver=null;outsideClickHandler=null;MAX_BATCH_DELETE_COUNT=50;batchDeleteInProgress=!1;batchDeleteProgressElement=null;BATCH_DELETE_CONFIG={DELAY_BETWEEN_DELETIONS:500,MENU_APPEAR_DELAY:300,DIALOG_APPEAR_DELAY:300,DELETION_COMPLETE_DELAY:500,MAX_BUTTON_WAIT_TIME:3e3,BUTTON_CHECK_INTERVAL:100,PAGE_REFRESH_DELAY:1500};cleanupTasks=[];constructor(){this.storage=pd(),this.debug(`Using storage backend: ${this.storage.getBackendName()}`),this.backupService=new dd("gemini-folders",ao),this.createTooltip(),jr().catch(e=>{this.debugWarn("Failed to initialize i18n:",e)})}async init(){try{await this.storage.init(hr),this.backupService.setupBeforeUnloadBackup(()=>this.data);const e=ud({checkIntervalMs:6e4});if(e.setNotificationCallback((t,r)=>{this.showNotificationByLevel(t,r)}),e.startMonitoring(),await this.loadData(),await this.loadFolderEnabledSetting(),await this.loadHideArchivedSetting(),await this.loadFilterUserSetting(),this.setupStorageListener(),this.setupMessageListener(),!this.folderEnabled){this.debug("Folder feature is disabled, skipping initialization");return}await this.initializeFolderUI(),this.debug("Initialized successfully")}catch(e){if(Ct(e))return;console.error("[FolderManager] Initialization error:",e)}}destroy(){this.debug("Destroying FolderManager - cleaning up resources"),this.isDestroyed=!0;let e=0;if(this.pendingRemovals.forEach((t,r)=>{clearTimeout(t),e++,this.debug(`Cleared pending removal timer for ${r}`)}),this.pendingRemovals.clear(),e>0&&this.debug(`Cleared ${e} pending removal timer(s)`),this.longPressTimeout&&(clearTimeout(this.longPressTimeout),this.longPressTimeout=null),this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null),this.navPoller&&(clearInterval(this.navPoller),this.navPoller=null),this.sideNavObserver&&(this.sideNavObserver.disconnect(),this.sideNavObserver=null),this.conversationObserver&&(this.conversationObserver.disconnect(),this.conversationObserver=null),this.nativeMenuObserver&&(this.nativeMenuObserver.disconnect(),this.nativeMenuObserver=null),this.routeChangeCleanup&&(this.routeChangeCleanup(),this.routeChangeCleanup=null),this.sidebarClickListener&&this.sidebarContainer){try{this.sidebarContainer.removeEventListener("click",this.sidebarClickListener,!0)}catch{}this.sidebarClickListener=null}this.removeOutsideClickHandler(),this.tooltipElement&&(this.tooltipElement.remove(),this.tooltipElement=null),this.activeColorPicker&&(this.activeColorPicker.remove(),this.activeColorPickerCloseHandler&&(document.removeEventListener("click",this.activeColorPickerCloseHandler),this.activeColorPickerCloseHandler=null),this.activeColorPicker=null,this.activeColorPickerFolderId=null),this.containerElement&&(this.containerElement.remove(),this.containerElement=null),this.cleanupTasks.forEach(t=>t()),this.cleanupTasks=[],this.debug("Cleanup complete")}addCleanupTask(e){this.cleanupTasks.push(e)}async initializeFolderUI(){if(await this.waitForSidebar(),this.findRecentSection(),!this.recentSection){this.debugWarn("Could not find Recent section");return}this.createFolderUI(),this.makeConversationsDraggable(),this.setupMutationObserver(),this.setupSideNavObserver(),this.updateVisibilityBasedOnSideNav(),this.setupConversationClickTracking(),this.setupNativeConversationMenuObserver()}async waitForSidebar(){return new Promise(e=>{const t=()=>{const r=document.querySelector('[data-test-id="overflow-container"]');r?(this.sidebarContainer=r,e()):setTimeout(t,500)};t()})}findRecentSection(){if(!this.sidebarContainer)return;let e=this.sidebarContainer.querySelector('[data-test-id="all-conversations"]');if(e||(e=this.sidebarContainer.querySelector(".chat-history")),!e){const t=this.sidebarContainer.querySelectorAll('[data-test-id="conversation"]');t.length>0&&(e=t[0].closest('.chat-history, [class*="conversation"]'))}e?this.recentSection=e:(this.debugWarn("Could not find Recent section - will retry"),setTimeout(()=>{this.findRecentSection(),this.recentSection&&!this.containerElement&&(this.createFolderUI(),this.makeConversationsDraggable(),this.setupMutationObserver())},2e3))}createFolderUI(){if(!this.recentSection)return;this.containerElement=document.createElement("div"),this.containerElement.className="gv-folder-container";const e=this.createMultiSelectIndicator();this.containerElement.appendChild(e);const t=this.createHeader();this.containerElement.appendChild(t);const r=this.createFoldersList();this.containerElement.appendChild(r),this.recentSection.parentElement?.insertBefore(this.containerElement,this.recentSection),this.highlightActiveConversationInFolders(),this.installRouteChangeListener(),this.installSidebarClickListener(),this.applyFolderEnabledSetting()}createMultiSelectIndicator(){const e=document.createElement("div");e.className="gv-multi-select-indicator",e.dataset.multiSelectIndicator="true",Object.assign(e.style,{position:"fixed",bottom:"24px",left:"50%",transform:"translateX(-50%)",zIndex:"9999",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",cursor:"move",transition:"opacity 0.2s ease, transform 0.1s ease",userSelect:"none",backgroundColor:"var(--gem-sys-color-surface-container, #f0f4f9)",borderRadius:"24px",padding:"8px 16px",alignItems:"center",gap:"12px",border:"1px solid var(--gem-sys-color-outline-variant, rgba(0,0,0,0.1))"});let t=!1,r,o,i,s,a=0,l=0;const d=v=>{v.target.closest("button")||(i=v.clientX-a,s=v.clientY-l,(v.target===e||e.contains(v.target))&&(t=!0,e.style.cursor="grabbing"))},u=()=>{t=!1,e.style.cursor="move"},m=v=>{t&&(v.preventDefault(),r=v.clientX-i,o=v.clientY-s,a=r,l=o,p(r,o,e))},p=(v,S,C)=>{C.style.transform=`translate3d(calc(-50% + ${v}px), ${S}px, 0)`};e.addEventListener("mousedown",d),document.addEventListener("mousemove",m),document.addEventListener("mouseup",u),this.addCleanupTask(()=>{e.removeEventListener("mousedown",d),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",u)});const f=document.createElement("div");f.className="gv-multi-select-indicator-content",f.style.pointerEvents="none";const g=document.createElement("mat-icon");g.className="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color",g.setAttribute("role","img"),g.setAttribute("aria-hidden","true"),g.textContent="check_circle";const b=document.createElement("span");b.className="gv-multi-select-indicator-text",b.textContent="0 selected",b.dataset.selectionCount="true",f.appendChild(g),f.appendChild(b),e.appendChild(f);const w=document.createElement("div");return w.className="gv-multi-select-actions",w.dataset.multiSelectActions="true",w.style.pointerEvents="auto",e.appendChild(w),e}createHeader(){const e=document.createElement("div");e.className="gv-folder-header";const t=document.createElement("div");t.className="title-container";const r=document.createElement("h1");r.className="title gds-label-l",r.textContent=this.t("folder_title"),r.style.visibility="visible",t.appendChild(r);const o=document.createElement("div");o.className="gv-folder-header-actions";const i=document.createElement("button");i.className="gv-folder-action-btn",i.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">person</mat-icon>',i.title=this.t("folder_filter_current_user"),this.filterCurrentUserOnly&&i.classList.add("gv-filter-active"),i.addEventListener("click",()=>this.toggleFilterCurrentUser());const s=document.createElement("button");if(s.className="gv-folder-action-btn",s.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">folder_managed</mat-icon>',s.title=this.t("folder_import_export"),s.addEventListener("click",l=>this.showImportExportMenu(l)),o.appendChild(i),o.appendChild(s),!en()){const l=document.createElement("button");l.className="gv-folder-action-btn",l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#e3e3e3"><path d="M260-160q-91 0-155.5-63T40-377q0-78 47-139t123-78q25-92 100-149t170-57q117 0 198.5 81.5T760-520q69 8 114.5 59.5T920-340q0 75-52.5 127.5T740-160H520q-33 0-56.5-23.5T440-240v-206l-64 62-56-56 160-160 160 160-56 56-64-62v206h220q42 0 71-29t29-71q0-42-29-71t-71-29h-60v-80q0-83-58.5-141.5T480-720q-83 0-141.5 58.5T280-520h-20q-58 0-99 41t-41 99q0 58 41 99t99 41h100v80H260Zm220-280Z"/></svg>',l.title=this.t("folder_cloud_upload"),l.addEventListener("click",()=>this.handleCloudUpload()),l.addEventListener("mouseenter",async()=>{const u=await this.getCloudUploadTooltip();l.title=u}),o.appendChild(l);const d=document.createElement("button");d.className="gv-folder-action-btn",d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#e3e3e3"><path d="M260-160q-91 0-155.5-63T40-377q0-78 47-139t123-78q17-72 85-137t145-65q33 0 56.5 23.5T520-716v242l64-62 56 56-160 160-160-160 56-56 64 62v-242q-76 14-118 73.5T280-520h-20q-58 0-99 41t-41 99q0 58 41 99t99 41h480q42 0 71-29t29-71q0-42-29-71t-71-29h-60v-80q0-48-22-89.5T600-680v-93q74 35 117 103.5T760-520q69 8 114.5 59.5T920-340q0 75-52.5 127.5T740-160H260Zm220-358Z"/></svg>',d.title=this.t("folder_cloud_sync"),d.addEventListener("click",()=>this.handleCloudSync()),d.addEventListener("mouseenter",async()=>{const u=await this.getCloudSyncTooltip();d.title=u}),o.appendChild(d)}const a=document.createElement("button");return a.className="gv-folder-add-btn",a.innerHTML='<mat-icon role="img" class="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">add</mat-icon>',a.title=this.t("folder_create"),a.addEventListener("click",()=>this.createFolder()),o.appendChild(a),e.appendChild(t),e.appendChild(o),this.setupRootDropZone(e),e}createFoldersList(){const e=document.createElement("div");e.className="gv-folder-list",this.setupRootDropZone(e);const t=this.data.folderContents[mr]||[],r=this.filterConversationsByCurrentUser(t);r.length>0&&r.forEach(s=>{const a=this.createConversationElement(s,mr,0);e.appendChild(a)});const o=this.data.folders.filter(s=>s.parentId===null);if(this.sortFolders(o).forEach(s=>{if(!this.hasVisibleContent(s.id))return;const a=this.createFolderElement(s);e.appendChild(a)}),o.length===0&&t.length===0){const s=document.createElement("div");s.className="gv-folder-empty",s.textContent=this.t("folder_empty"),e.appendChild(s)}return e}createFolderElement(e,t=0){const r=document.createElement("div");r.className="gv-folder-item",r.dataset.folderId=e.id,r.dataset.level=t.toString();const o=document.createElement("div");o.className="gv-folder-item-header",o.style.paddingLeft=`${t*16+8}px`;const i=document.createElement("button");i.className="gv-folder-expand-btn",i.innerHTML=e.isExpanded?'<span class="google-symbols">expand_more</span>':'<span class="google-symbols">chevron_right</span>',i.addEventListener("click",()=>this.toggleFolder(e.id));const s=document.createElement("span");if(s.className="gv-folder-icon google-symbols",s.textContent="folder",s.style.cursor="pointer",s.style.userSelect="none",e.color&&e.color!=="default"){const m=fl(e.color,gl());s.style.color=m}s.addEventListener("click",m=>{m.stopPropagation(),this.showColorPicker(e.id,m,!0)});const a=document.createElement("span");a.className="gv-folder-name gds-label-l",a.textContent=e.name,a.style.cursor="pointer",a.addEventListener("click",()=>this.toggleFolder(e.id)),a.addEventListener("dblclick",()=>this.renameFolder(e.id)),a.addEventListener("mouseenter",()=>this.showTooltip(a,e.name)),a.addEventListener("mouseleave",()=>this.hideTooltip());const l=document.createElement("button");l.className="gv-folder-pin-btn";const d=document.createElement("span");d.className="google-symbols",d.textContent="push_pin",e.pinned&&(d.style.fontVariationSettings="'FILL' 1"),l.appendChild(d),l.title=e.pinned?this.t("folder_unpin"):this.t("folder_pin"),l.addEventListener("click",m=>{m.stopPropagation(),this.togglePinFolder(e.id)});const u=document.createElement("button");if(u.className="gv-folder-actions-btn",u.innerHTML='<span class="google-symbols">more_vert</span>',u.addEventListener("click",m=>this.showFolderMenu(m,e.id)),o.appendChild(i),o.appendChild(s),o.appendChild(a),o.appendChild(l),o.appendChild(u),this.setupDropZone(o,e.id),r.appendChild(o),this.applyFolderDraggableBehavior(o,e),e.isExpanded){const m=document.createElement("div");m.className="gv-folder-content",this.setupDropZone(m,e.id);const p=this.data.folderContents[e.id]||[],f=this.filterConversationsByCurrentUser(p);this.sortConversations(f).forEach(v=>{const S=this.createConversationElement(v,e.id,t+1);m.appendChild(S)});const b=this.data.folders.filter(v=>v.parentId===e.id);this.sortFolders(b).forEach(v=>{if(!this.hasVisibleContent(v.id))return;const S=this.createFolderElement(v,t+1);m.appendChild(S)}),r.appendChild(m)}return r}createConversationElement(e,t,r){const o=document.createElement("div");o.className=e.starred?"gv-folder-conversation gv-starred":"gv-folder-conversation",o.dataset.conversationId=e.conversationId,o.dataset.folderId=t,o.style.paddingLeft=`${r*16+24}px`;let i=e.title;if(!e.customTitle&&!this.hideArchivedConversations){const g=this.syncConversationTitleFromNative(e.conversationId);g&&g!==e.title&&(e.title=g,i=g,this.pendingTitleUpdates.set(e.conversationId,g),this.debug("Buffered title update for:",e.conversationId))}o.draggable=!0,o.addEventListener("dragstart",g=>{g.stopPropagation(),this.selectedConversations.has(e.conversationId)||(this.clearSelection(),this.selectConversation(e.conversationId),this.updateConversationSelectionUI()),this.longPressTimeout&&(clearTimeout(this.longPressTimeout),this.longPressTimeout=null);const w={type:"conversation",conversations:this.getSelectedConversationsData(t),sourceFolderId:t};g.dataTransfer.setData("application/json",JSON.stringify(w)),this.selectedConversations.forEach(v=>{const S=this.containerElement?.querySelector(`[data-conversation-id="${v}"]`);S&&(S.style.opacity="0.5")})}),o.addEventListener("dragend",()=>{this.selectedConversations.forEach(g=>{const b=this.containerElement?.querySelector(`[data-conversation-id="${g}"]`);b&&(b.style.opacity="1")}),this.isMultiSelectMode||(this.clearSelection(),this.cleanupSelectionArtifacts())});const s=document.createElement("mat-icon");s.className="mat-icon notranslate gv-conversation-icon google-symbols mat-ligature-font mat-icon-no-color",s.setAttribute("role","img"),s.setAttribute("aria-hidden","true");let a=$f;e.isGem&&e.gemId&&(a=zf(e.gemId)),s.setAttribute("fonticon",a),s.textContent=a;const l=document.createElement("span");l.className="gv-conversation-title gds-label-l",l.textContent=i,l.addEventListener("mouseenter",()=>this.showTooltip(l,i)),l.addEventListener("mouseleave",()=>this.hideTooltip());const d=document.createElement("div");d.className="gv-conversation-actions";const u=document.createElement("button");u.className=e.starred?"gv-conversation-star-btn starred":"gv-conversation-star-btn";const m=e.starred?"star":"star_outline";u.innerHTML=`<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">${m}</mat-icon>`,u.title=e.starred?this.t("conversation_unstar"):this.t("conversation_star"),u.addEventListener("click",g=>{g.stopPropagation(),this.toggleConversationStar(t,e.conversationId)});const p=document.createElement("button");p.className="gv-conversation-remove-btn",p.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">close</mat-icon>',p.title=this.t("folder_remove_conversation"),p.addEventListener("click",g=>{g.stopPropagation(),this.confirmRemoveConversation(t,e.conversationId,i,g)}),d.appendChild(u),d.appendChild(p);let f=!1;return o.addEventListener("mousedown",g=>{g.button===0&&(f=!1,this.longPressTimeout=window.setTimeout(()=>{f=!0,this.enterMultiSelectMode(e.conversationId,"folder",t)},this.longPressThreshold))}),o.addEventListener("mouseup",()=>{this.longPressTimeout&&(clearTimeout(this.longPressTimeout),this.longPressTimeout=null)}),o.addEventListener("mouseleave",()=>{this.longPressTimeout&&(clearTimeout(this.longPressTimeout),this.longPressTimeout=null)}),o.addEventListener("click",g=>{if(f){f=!1;return}if(this.isMultiSelectMode){if(g.preventDefault(),g.stopPropagation(),this.multiSelectSource==="folder"&&this.multiSelectFolderId&&this.multiSelectFolderId!==t){this.showInvalidSelectionFeedback(o);return}this.toggleConversationSelection(e.conversationId),this.updateConversationSelectionUI()}else this.navigateToConversationById(t,e.conversationId)}),l.addEventListener("dblclick",g=>{g.stopPropagation(),this.renameConversation(t,e.conversationId,l)}),o.appendChild(s),o.appendChild(l),o.appendChild(d),o}setupDropZone(e,t){e.addEventListener("dragover",r=>{r.preventDefault(),r.stopPropagation(),e.classList.add("gv-folder-dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("gv-folder-dragover")}),e.addEventListener("drop",r=>{r.preventDefault(),r.stopPropagation(),e.classList.remove("gv-folder-dragover");const o=r.dataTransfer?.getData("application/json");if(o)try{const i=JSON.parse(o);this.selectedConversations.forEach(s=>{const a=this.findConversationElement(s);a&&(a.style.opacity="1")}),i.type==="folder"?(this.debug("Dropping folder into folder:",i.title,"â†’",t),this.addFolderToFolder(t,i)):i.conversations&&i.conversations.length>0?(this.debug("Dropping multiple conversations:",i.conversations.length),this.addConversationsToFolder(t,i.conversations,i.sourceFolderId)):this.addConversationToFolder(t,i),this.exitMultiSelectMode()}catch(i){console.error("[FolderManager] Drop error:",i)}})}setupRootDropZone(e){e.addEventListener("dragover",t=>{t.dataTransfer?.types.includes("application/json")&&(t.preventDefault(),t.stopPropagation(),e.classList.add("gv-folder-list-dragover"))}),e.addEventListener("dragleave",t=>{const r=e.getBoundingClientRect(),o=t.clientX,i=t.clientY;(o<=r.left||o>=r.right||i<=r.top||i>=r.bottom)&&e.classList.remove("gv-folder-list-dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("gv-folder-list-dragover");const r=t.dataTransfer?.getData("application/json");if(r)try{const o=JSON.parse(r);this.selectedConversations.forEach(i=>{const s=this.findConversationElement(i);s&&(s.style.opacity="1")}),o.type==="folder"?this.moveFolderToRoot(o):o.conversations&&o.conversations.length>0?(this.debug("Adding multiple conversations to root level:",o.conversations.length),this.addConversationsToFolder(mr,o.conversations,o.sourceFolderId)):(this.debug("Adding conversation to root level:",o.title),this.addConversationToFolder(mr,o)),this.exitMultiSelectMode()}catch(o){console.error("[FolderManager] Root drop error:",o)}})}makeConversationsDraggable(){if(!this.sidebarContainer)return;this.sidebarContainer.querySelectorAll('[data-test-id="conversation"]').forEach(t=>{this.makeConversationDraggable(t);const r=this.extractConversationId(t),o=this.isConversationInFolders(r);this.hideArchivedConversations&&o?t.classList.add("gv-conversation-archived"):t.classList.remove("gv-conversation-archived")})}canFolderBeDragged(e){return!this.data.folders.some(t=>t.parentId===e)}applyFolderDraggableBehavior(e,t){this.canFolderBeDragged(t.id)?this.enableFolderDragging(e,t):this.disableFolderDragging(e)}enableFolderDragging(e,t){if(e.draggable=!0,e.style.cursor="grab",e.dataset.dragListenersAttached==="true"){this.debug("Drag listeners already attached for folder:",t.name);return}const r=i=>{i.stopPropagation();const s={type:"folder",folderId:t.id,title:t.name};i.dataTransfer?.setData("application/json",JSON.stringify(s)),e.style.opacity="0.5",this.debug("Folder drag start:",t.name,"canBeDragged:",this.canFolderBeDragged(t.id))},o=()=>{e.style.opacity="1"};e._dragStartHandler=r,e._dragEndHandler=o,e.addEventListener("dragstart",r),e.addEventListener("dragend",o),e.dataset.dragListenersAttached="true"}disableFolderDragging(e){if(e.draggable=!1,e.style.cursor="",e.dataset.dragListenersAttached==="true"){const t=e._dragStartHandler,r=e._dragEndHandler;t&&(e.removeEventListener("dragstart",t),delete e._dragStartHandler),r&&(e.removeEventListener("dragend",r),delete e._dragEndHandler),delete e.dataset.dragListenersAttached}}makeConversationDraggable(e){e.draggable=!0,e.style.cursor="grab";let t=!1,r=null;const o=a=>{if(a.button!==0)return;t=!1;const l=this.extractConversationId(e);r=window.setTimeout(()=>{t=!0,this.enterMultiSelectMode(l,"native"),e.classList.add("gv-conversation-selected")},this.longPressThreshold)},i=()=>{r&&(clearTimeout(r),r=null)},s=()=>{r&&(clearTimeout(r),r=null)};e.addEventListener("mousedown",o),e.addEventListener("mouseup",i),e.addEventListener("mouseleave",s),e.onclick,e.addEventListener("click",a=>{if(t){a.preventDefault(),a.stopPropagation(),t=!1;return}if(this.isMultiSelectMode){a.preventDefault(),a.stopPropagation();const l=this.extractConversationId(e);this.toggleConversationSelection(l),this.selectedConversations.has(l)?e.classList.add("gv-conversation-selected"):e.classList.remove("gv-conversation-selected"),this.updateConversationSelectionUI();return}},!0),e.addEventListener("dragstart",a=>{const l=e.querySelector(".conversation-title")?.textContent?.trim()||"Untitled",d=this.extractConversationId(e),u=this.extractConversationData(e);if(this.selectedConversations.has(d)||(this.clearSelection(),this.selectConversation(d),e.classList.add("gv-conversation-selected"),this.updateConversationSelectionUI()),r&&(clearTimeout(r),r=null),this.selectedConversations.size>1){const m=[];this.selectedConversations.forEach(f=>{const g=this.findConversationElement(f);if(g){const b=g.querySelector(".conversation-title")?.textContent?.trim()||"Untitled",w=this.extractConversationData(g);m.push({conversationId:f,title:b,url:w.url,addedAt:Date.now(),isGem:w.isGem,gemId:w.gemId})}});const p={type:"conversation",title:`${m.length} conversations`,conversations:m};a.dataTransfer?.setData("application/json",JSON.stringify(p)),this.selectedConversations.forEach(f=>{const g=this.findConversationElement(f);g&&(g.style.opacity="0.5")})}else{this.debug("Drag start:",{title:l,isGem:u.isGem,gemId:u.gemId,url:u.url});const m={type:"conversation",conversationId:d,title:l,url:u.url,isGem:u.isGem,gemId:u.gemId};a.dataTransfer?.setData("application/json",JSON.stringify(m)),e.style.opacity="0.5"}}),e.addEventListener("dragend",()=>{this.selectedConversations.size>1?this.selectedConversations.forEach(a=>{const l=this.findConversationElement(a);l&&(l.style.opacity="1")}):e.style.opacity="1",this.isMultiSelectMode||(this.clearSelection(),this.cleanupSelectionArtifacts())})}findConversationElement(e){const t=this.containerElement?.querySelector(`[data-conversation-id="${e}"]`);if(t)return t;const r=this.sidebarContainer?.querySelectorAll('[data-test-id="conversation"]');if(r){for(const o of Array.from(r))if(this.extractConversationId(o)===e)return o}return null}extractConversationId(e){const t=e.getAttribute("jslog");if(t){const l=t.match(/[",\[]c_([a-f0-9]+)[",\]]/);if(l){const u=`c_${l[1]}`;return this.debug("Extracted conversation ID:",u,"from jslog:",t),u}const d=t.match(/c_[a-f0-9]+/);if(d)return this.debug("Extracted conversation ID (simple):",d[0]),d[0]}const r=e.querySelector('a[href*="/app/"], a[href*="/gem/"]');if(r){const l=r.href;let d=l.match(/\/app\/([^\/?#]+)/);if(d&&d[1])return`c_${d[1]}`;if(d=l.match(/\/gem\/[^/]+\/([^\/?#]+)/),d&&d[1])return`c_${d[1]}`}const o=e.querySelector(".conversation-title")?.textContent?.trim()||"",i=Array.from(e.parentElement?.children||[]).indexOf(e),s=`${o}_${i}_${Math.random()}_${Date.now()}`,a=`conv_${this.hashString(s)}`;return this.debugWarn("Could not extract ID from jslog or href, using fallback:",a),a}extractConversationData(e){const t=e.getAttribute("jslog");let r=null;if(t){const d=t.match(/[",\[]c_([a-f0-9]+)[",\]]/);d&&(r=d[1],this.debug("Extracted hex ID from jslog:",r))}if(!r){const d=e.querySelector('a[href*="/app/"], a[href*="/gem/"]');if(d){const u=d.href;let m=u.match(/\/app\/([^\/?#]+)/);m&&m[1]?r=m[1]:(m=u.match(/\/gem\/[^/]+\/([^\/?#]+)/),m&&m[1]&&(r=m[1]))}}if(!r)return{url:window.location.href,isGem:!1};const i=window.location.pathname.match(/\/u\/(\d+)\//);let s=window.location.origin;i&&(s+=`/u/${i[1]}`),s+=`/app/${r}`;const l=new URL(window.location.href).searchParams.toString();return l&&(s+=`?${l}`),this.debug("Built URL:",s),{url:s,isGem:!1,gemId:void 0}}extractConversationIdFromElement(e){const t=e.getAttribute("jslog");if(t){const o=t.match(/c_([a-f0-9]{8,})/i);if(o&&o[1])return o[1]}const r=e.querySelector('a[href*="/app/"], a[href*="/gem/"]');if(r){const o=r.href,i=o.match(/\/app\/([^\/?#]+)/),s=o.match(/\/gem\/[^/]+\/([^\/?#]+)/);return i?.[1]||s?.[1]}}setupMutationObserver(){this.sidebarContainer&&(this.conversationObserver&&(this.conversationObserver.disconnect(),this.conversationObserver=null),this.conversationObserver=new MutationObserver(e=>{if(e.forEach(o=>{o.addedNodes.forEach(i=>{i instanceof HTMLElement&&(i.matches('[data-test-id="conversation"]')&&(this.makeConversationDraggable(i),this.applyHideArchivedToConversation(i),this.cancelPendingRemovalForElement(i)),i.querySelectorAll('[data-test-id="conversation"]').forEach(a=>{const l=a;this.makeConversationDraggable(l),this.applyHideArchivedToConversation(l),this.cancelPendingRemovalForElement(l)}))})}),!navigator.onLine){this.debug("Network offline, ignoring conversation removals to prevent data loss");return}let t=0;const r=[];if(e.forEach(o=>{o.removedNodes.forEach(i=>{if(i instanceof HTMLElement){const s=i.matches('[data-test-id="conversation"]'),a=i.querySelectorAll('[data-test-id="conversation"]').length;s?(t++,r.push(i)):a>0&&(t+=a,r.push(i))}})}),t!==0){if(t>1&&!this.isMultiSelectMode){this.debugWarn(`Ignored bulk removal of ${t} conversations - likely UI refresh`);return}r.forEach(o=>{(o.matches('[data-test-id="conversation"]')?[o]:Array.from(o.querySelectorAll('[data-test-id="conversation"]'))).forEach(s=>{const a=this.extractConversationIdFromElement(s);a&&(this.debug("Detected potential conversation removal:",a),this.scheduleConversationRemovalCheck(a))})})}}),this.conversationObserver.observe(this.sidebarContainer,{childList:!0,subtree:!0}))}setupSideNavObserver(){const e=document.querySelector("#app-root");if(!e){this.debugWarn("Could not find #app-root element for sidebar monitoring");return}this.sideNavObserver=new MutationObserver(t=>{t.forEach(r=>{r.type==="attributes"&&r.attributeName==="class"&&this.updateVisibilityBasedOnSideNav()})}),this.sideNavObserver.observe(e,{attributes:!0,attributeFilter:["class"]}),this.debug("Side nav observer setup complete")}updateVisibilityBasedOnSideNav(){const e=document.querySelector("#app-root");if(!e)return;const t=e.classList.contains("side-nav-open");if(!this.containerElement||!document.body.contains(this.containerElement)){t&&(this.debug("Container element not in DOM, reinitializing folder UI"),this.reinitializeFolderUI());return}if(!this.sidebarContainer||!document.body.contains(this.sidebarContainer)){t&&(this.debug("Sidebar container not in DOM, reinitializing folder UI"),this.reinitializeFolderUI());return}t?(this.containerElement.style.display="",this.debug("Sidebar open - showing folder container")):(this.containerElement.style.display="none",this.debug("Sidebar closed - hiding folder container"))}reinitializeFolderUI(){if(this.reinitializePromise){this.debug("Reinitialization already in progress, skipping duplicate request");return}this.reinitializePromise=(async()=>{if(this.debug("Reinitializing folder UI..."),this.cleanupTasks.forEach(e=>e()),this.cleanupTasks=[],this.sideNavObserver&&(this.sideNavObserver.disconnect(),this.sideNavObserver=null),this.conversationObserver&&(this.conversationObserver.disconnect(),this.conversationObserver=null),this.nativeMenuObserver&&(this.nativeMenuObserver.disconnect(),this.nativeMenuObserver=null),this.routeChangeCleanup){try{this.routeChangeCleanup()}catch(e){this.debugWarn("Route change cleanup during reinit failed:",e)}this.routeChangeCleanup=null}if(this.sidebarClickListener&&this.sidebarContainer){try{this.sidebarContainer.removeEventListener("click",this.sidebarClickListener,!0)}catch(e){this.debugWarn("Sidebar click listener cleanup failed:",e)}this.sidebarClickListener=null}if(this.containerElement?.isConnected)try{this.containerElement.remove()}catch(e){this.debugWarn("Failed to remove existing folder container during reinit:",e)}this.containerElement=null,this.sidebarContainer=null,this.recentSection=null,await this.initializeFolderUI()})().catch(e=>{this.debugWarn("Failed to reinitialize folder UI:",e)}).finally(()=>{this.reinitializePromise=null})}createFolder(e=null){const t=document.createElement("div");t.className="gv-folder-inline-input";const r=document.createElement("input");r.type="text",r.className="gv-folder-name-input",r.placeholder=this.t("folder_name_prompt"),r.maxLength=50;const o=document.createElement("button");o.className="gv-folder-inline-btn gv-folder-inline-save",o.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">check</mat-icon>',o.title=this.t("pm_save");const i=document.createElement("button");i.className="gv-folder-inline-btn gv-folder-inline-cancel",i.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">close</mat-icon>',i.title=this.t("pm_cancel"),t.appendChild(r),t.appendChild(o),t.appendChild(i);const s=()=>{const d=r.value.trim();if(!d){t.remove();return}const u={id:this.generateId(),name:d,parentId:e,isExpanded:!0,createdAt:Date.now(),updatedAt:Date.now()};this.data.folders.push(u),this.data.folderContents[u.id]=[],this.saveData(),this.refresh()},a=()=>{t.remove()};o.addEventListener("click",s),i.addEventListener("click",a),r.addEventListener("keydown",d=>{d.key==="Enter"&&s(),d.key==="Escape"&&a()});const l=this.containerElement?.querySelector(".gv-folder-list");if(l){if(e){const d=l.querySelector(`[data-folder-id="${e}"]`);if(d){const u=d.querySelector(".gv-folder-content");u?u.insertBefore(t,u.firstChild):d.insertAdjacentElement("afterend",t)}else l.appendChild(t)}else l.insertBefore(t,l.firstChild);r.focus()}}renameFolder(e){const t=this.data.folders.find(p=>p.id===e);if(!t)return;const r=this.containerElement?.querySelector(`[data-folder-id="${e}"]`);if(!r)return;const o=r.querySelector(".gv-folder-name");if(!o)return;const i=document.createElement("span");i.className="gv-folder-rename-inline";const s=document.createElement("input");s.type="text",s.className="gv-folder-rename-input",s.value=t.name,s.maxLength=50;const a=document.createElement("button");a.className="gv-folder-inline-btn gv-folder-inline-save",a.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">check</mat-icon>';const l=document.createElement("button");l.className="gv-folder-inline-btn gv-folder-inline-cancel",l.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">close</mat-icon>',i.appendChild(s),i.appendChild(a),i.appendChild(l);const d=()=>{const p=s.value.trim();if(!p){u();return}t.name=p,t.updatedAt=Date.now(),this.saveData(),this.refresh()},u=()=>{o.textContent=t.name,i.remove(),o.classList.remove("gv-hidden")},m=()=>{u()};a.addEventListener("click",d),l.addEventListener("click",m),s.addEventListener("keydown",p=>{p.key==="Enter"&&d(),p.key==="Escape"&&m()}),o.classList.add("gv-hidden"),o.parentElement?.insertBefore(i,o.nextSibling),s.focus(),s.select()}deleteFolder(e,t){const r=document.createElement("div");r.className="gv-folder-confirm-dialog";const o=document.createElement("div");o.className="gv-folder-confirm-message",o.textContent=this.t("folder_delete_confirm");const i=document.createElement("div");i.className="gv-folder-confirm-actions";const s=document.createElement("button");s.className="gv-folder-confirm-btn gv-folder-confirm-yes",s.textContent=this.t("pm_delete");const a=document.createElement("button");a.className="gv-folder-confirm-btn gv-folder-confirm-no",a.textContent=this.t("pm_cancel"),i.appendChild(s),i.appendChild(a),r.appendChild(o),r.appendChild(i);const l=this.containerElement?.querySelector(`[data-folder-id="${e}"]`),d=l?.querySelector(".gv-folder-item-header");if(d){const m=d.getBoundingClientRect();r.style.position="fixed",r.style.top=`${m.bottom+4}px`,r.style.left=`${m.left+24}px`,r.style.zIndex="10002"}else if(l){const m=l.getBoundingClientRect();r.style.position="fixed",r.style.top=`${m.top+32}px`,r.style.left=`${m.left}px`,r.style.zIndex="10002"}document.body.appendChild(r);const u=()=>{r.remove()};s?.addEventListener("click",()=>{const m=this.getFolderAndDescendants(e);this.data.folders=this.data.folders.filter(p=>!m.includes(p.id)),m.forEach(p=>{delete this.data.folderContents[p]}),this.saveData(),this.refresh(),u()}),a?.addEventListener("click",u),setTimeout(()=>{const m=p=>{r.contains(p.target)||(u(),document.removeEventListener("click",m))};document.addEventListener("click",m)},0)}getFolderAndDescendants(e){const t=[e];return this.data.folders.filter(o=>o.parentId===e).forEach(o=>{t.push(...this.getFolderAndDescendants(o.id))}),t}toggleFolder(e){const t=this.data.folders.find(r=>r.id===e);t&&(t.isExpanded=!t.isExpanded,t.updatedAt=Date.now(),this.saveData(),this.refresh())}togglePinFolder(e){const t=this.data.folders.find(r=>r.id===e);t&&(t.pinned=!t.pinned,t.updatedAt=Date.now(),this.saveData(),this.refresh())}sortFolders(e){return[...e].sort((t,r)=>t.pinned&&!r.pinned?-1:!t.pinned&&r.pinned?1:t.name.localeCompare(r.name,void 0,{numeric:!0,sensitivity:"base"}))}sortConversations(e){return[...e].sort((t,r)=>t.starred&&!r.starred?-1:!t.starred&&r.starred?1:r.addedAt-t.addedAt)}addConversationToFolder(e,t){if(this.debug("Adding conversation to folder:",{folderId:e,dragData:t}),this.data.folderContents[e]||(this.data.folderContents[e]=[]),this.data.folderContents[e].some(i=>i.conversationId===t.conversationId)){this.debug("Conversation already in folder:",t.conversationId),this.debug("Existing conversations:",this.data.folderContents[e]);return}const o={conversationId:t.conversationId,title:t.title,url:t.url,addedAt:Date.now(),isGem:t.isGem,gemId:t.gemId};if(this.data.folderContents[e].push(o),this.debug("Conversation added. Total in folder:",this.data.folderContents[e].length),t.sourceFolderId&&t.sourceFolderId!==e){this.debug("Moving from folder:",t.sourceFolderId),this.removeConversationFromFolder(t.sourceFolderId,t.conversationId);return}this.saveData(),this.refresh()}addConversationsToFolder(e,t,r){this.debug("Adding multiple conversations to folder:",{folderId:e,count:t.length,sourceFolderId:r}),this.data.folderContents[e]||(this.data.folderContents[e]=[]);let o=0;const i=[];t.forEach(s=>{if(!this.data.folderContents[e].some(l=>l.conversationId===s.conversationId)){const l={...s,addedAt:Date.now()};this.data.folderContents[e].push(l),o++,r&&r!==e&&i.push(s.conversationId)}}),this.debug(`Added ${o} conversations. Total in folder:`,this.data.folderContents[e].length),r&&r!==e&&i.length>0&&(this.debug("Removing conversations from source folder:",r),i.forEach(s=>{this.data.folderContents[r]=this.data.folderContents[r].filter(a=>a.conversationId!==s)})),this.saveData(),this.refresh()}addFolderToFolder(e,t){const r=t.folderId;if(!r)return;if(this.debug("Moving folder to folder:",{draggedFolderId:r,targetFolderId:e}),r===e){this.debug("Cannot drop folder onto itself");return}if(this.isFolderDescendant(e,r)){this.debug("Cannot drop folder onto its descendant");return}const o=this.data.folders.find(i=>i.id===r);o&&(o.parentId=e,o.updatedAt=Date.now(),this.saveData(),this.refresh())}moveFolderToRoot(e){const t=e.folderId;if(!t)return;this.debug("Moving folder to root level:",t);const r=this.data.folders.find(o=>o.id===t);if(r){if(r.parentId===null){this.debug("Folder is already at root level");return}r.parentId=null,r.updatedAt=Date.now(),this.saveData(),this.refresh()}}isFolderDescendant(e,t){let r=e;for(;r;){if(r===t)return!0;r=this.data.folders.find(i=>i.id===r)?.parentId||null}return!1}toggleConversationStar(e,t){const r=this.data.folderContents[e];if(!r)return;const o=r.find(i=>i.conversationId===t);o&&(o.starred=!o.starred,this.saveData(),this.refresh(),this.debug("Toggled star for conversation:",t,"starred:",o.starred))}confirmRemoveConversation(e,t,r,o){const i=document.createElement("div");i.className="gv-folder-confirm-dialog";const s=document.createElement("div");s.className="gv-folder-confirm-message",s.textContent=this.t("folder_remove_conversation_confirm").replace("{title}",r);const a=document.createElement("div");a.className="gv-folder-confirm-actions";const l=document.createElement("button");l.className="gv-folder-confirm-btn gv-folder-confirm-yes",l.textContent=this.t("pm_delete");const d=document.createElement("button");d.className="gv-folder-confirm-btn gv-folder-confirm-no",d.textContent=this.t("pm_cancel"),a.appendChild(l),a.appendChild(d),i.appendChild(s),i.appendChild(a);const u=o.target.getBoundingClientRect();i.style.position="fixed",i.style.top=`${u.bottom+4}px`,i.style.left=`${Math.min(u.left,window.innerWidth-280)}px`,document.body.appendChild(i);const m=()=>{i.remove()};l?.addEventListener("click",()=>{this.removeConversationFromFolder(e,t),m()}),d?.addEventListener("click",m),setTimeout(()=>{const p=f=>{i.contains(f.target)||(m(),document.removeEventListener("click",p))};document.addEventListener("click",p)},0)}removeConversationFromFolder(e,t){this.data.folderContents[e]&&(this.data.folderContents[e]=this.data.folderContents[e].filter(r=>r.conversationId!==t),this.saveData(),this.refresh())}batchDeleteConversations(){if(!this.multiSelectFolderId||this.selectedConversations.size===0)return;const e=this.selectedConversations.size;if(!confirm(`Delete ${e} selected conversation${e>1?"s":""} from this folder?`))return;const r=this.multiSelectFolderId;this.data.folderContents[r]&&(this.data.folderContents[r]=this.data.folderContents[r].filter(o=>!this.selectedConversations.has(o.conversationId)),this.saveData(),this.exitMultiSelectMode(),this.refresh(),this.debug(`Batch deleted ${e} conversations from folder ${r}`))}async batchDeleteNativeConversations(){if(this.batchDeleteInProgress){this.debug("Batch delete already in progress");return}const e=this.selectedConversations.size;if(e===0)return;const t=this.t("batch_delete_confirm").replace("{count}",String(e));if(!confirm(t))return;this.batchDeleteInProgress=!0;const o=Array.from(this.selectedConversations);let i=0,s=0;try{this.showBatchDeleteProgress(0,e);for(let a=0;a<o.length;a++){const l=o[a];this.debug(`Deleting conversation ${a+1}/${e}: ${l}`),this.updateBatchDeleteProgress(a+1,e);try{await this.triggerNativeDeleteForConversation(l)?i++:(s++,this.debugWarn(`Failed to delete conversation: ${l}`))}catch(d){s++,console.error(`[FolderManager] Error deleting conversation ${l}:`,d)}a<o.length-1&&await this.delay(this.BATCH_DELETE_CONFIG.DELAY_BETWEEN_DELETIONS)}if(this.hideBatchDeleteProgress(),s===0){const a=this.t("batch_delete_success").replace("{count}",String(i));this.showNotification(a,"success")}else{const a=this.t("batch_delete_partial").replace("{success}",String(i)).replace("{failed}",String(s));this.showNotification(a,"info")}this.exitMultiSelectMode(),i>0&&(this.debug("Refreshing page after batch delete"),setTimeout(()=>{window.location.reload()},this.BATCH_DELETE_CONFIG.PAGE_REFRESH_DELAY))}finally{this.batchDeleteInProgress=!1}}async triggerNativeDeleteForConversation(e){try{const t=this.findNativeConversationElement(e);return t?await this.findAndClickMoreButton(t)?(await this.delay(this.BATCH_DELETE_CONFIG.MENU_APPEAR_DELAY),await this.waitForDeleteButtonAndClick()?(await this.delay(this.BATCH_DELETE_CONFIG.DIALOG_APPEAR_DELAY),await this.confirmDeleteIfNeeded(),await this.delay(this.BATCH_DELETE_CONFIG.DELETION_COMPLETE_DELAY),!0):(this.debugWarn(`Could not click delete button for: ${e}`),this.clickBackdropToCloseMenu(),!1)):(this.debugWarn(`Could not find more button for: ${e}`),!1):(this.debugWarn(`Could not find conversation element for: ${e}`),!1)}catch(t){return console.error("[FolderManager] Error in triggerNativeDeleteForConversation:",t),!1}}findNativeConversationElement(e){const t=this.sidebarContainer?.querySelectorAll('[data-test-id="conversation"]');if(!t)return null;for(const r of t)if(this.extractConversationId(r)===e)return r;return null}async findAndClickMoreButton(e){let t=null;const r=e.parentElement;if(r){const o=r.querySelector(".conversation-actions-container");o&&(t=o.querySelector('[data-test-id="actions-menu-button"]'))}if(t||(t=e.querySelector('[data-test-id="actions-menu-button"]')),!t){const o=e.closest("li");o&&(t=o.querySelector('[data-test-id="actions-menu-button"]'))}return t?(t.click(),this.debug("Clicked more button"),t):null}async waitForDeleteButtonAndClick(){const e=this.BATCH_DELETE_CONFIG.MAX_BUTTON_WAIT_TIME,t=this.BATCH_DELETE_CONFIG.BUTTON_CHECK_INTERVAL;let r=0;const o=this.getDeleteKeywords();for(;r<e;){const i=document.querySelector('[data-test-id="delete-button"]');if(i&&this.isVisibleElement(i))return i.click(),this.debug("Clicked delete button (by test-id)"),!0;const s=document.querySelectorAll('.cdk-overlay-container button, .cdk-overlay-container [role="menuitem"], .mat-mdc-menu-content button, .mat-menu-content button');for(const l of s){if(!this.isVisibleElement(l))continue;const d=l.textContent?.toLowerCase().trim()||"";if(d&&o.some(u=>d===u||d.includes(u)&&d.length<20))return l.click(),this.debug("Clicked delete button (by text):",d),!0}const a=document.querySelectorAll(".cdk-overlay-container mat-icon, .cdk-overlay-container .material-icons");for(const l of a){const d=l.textContent?.toLowerCase().trim()||"";if(d==="delete"||d==="delete_forever"||d==="delete_outline"){const u=l.closest('button, [role="menuitem"]');if(u&&this.isVisibleElement(u))return u.click(),this.debug("Clicked delete button (by icon)"),!0}}await this.delay(t),r+=t}return!1}async confirmDeleteIfNeeded(){const e=this.BATCH_DELETE_CONFIG.MAX_BUTTON_WAIT_TIME,t=this.BATCH_DELETE_CONFIG.BUTTON_CHECK_INTERVAL;let r=0;const o=this.getDeleteKeywords();for(;r<e;){const i=document.querySelector('[data-test-id*="confirm"], [data-test-id*="delete"]:not([data-test-id="delete-button"])');if(i&&this.isVisibleElement(i)){i.click(),this.debug("Clicked confirmation button (by test-id)");return}const s=document.querySelectorAll(`
        .mat-mdc-dialog-container button.mat-primary,
        .mat-mdc-dialog-container button.mat-accent,
        .mat-mdc-dialog-container .mat-mdc-dialog-actions button:last-child,
        .cdk-overlay-container .mat-mdc-dialog-actions button:last-child,
        .cdk-overlay-container button[color="primary"],
        .cdk-overlay-container button[color="warn"]
      `);for(const d of s)if(this.isVisibleElement(d)){const u=d.textContent?.toLowerCase().trim()||"";if(u&&o.some(m=>u.includes(m)||u===m)){d.click(),this.debug("Clicked confirmation button (primary button):",u);return}}const a=document.querySelectorAll(".cdk-overlay-container button, .mat-mdc-dialog-container button");for(const d of a){if(!this.isVisibleElement(d))continue;const u=d.textContent?.toLowerCase().trim()||"";if(u&&o.some(m=>u===m)){d.click(),this.debug("Clicked confirmation button (overlay button):",u);return}}const l=document.querySelector(".mat-mdc-dialog-actions, .cdk-overlay-container .mat-dialog-actions");if(l){const d=l.querySelectorAll("button");if(d.length>=2){const u=d[d.length-1];if(this.isVisibleElement(u)){u.click(),this.debug("Clicked last button in dialog actions");return}}}await this.delay(t),r+=t}this.debug("No confirmation dialog detected after",e,"ms")}getDeleteKeywords(){return(this.t("batch_delete_match_patterns")||"").split(",").map(t=>t.trim().toLowerCase()).filter(t=>t.length>0)}isVisibleElement(e){if(!e)return!1;const t=window.getComputedStyle(e);return t.display!=="none"&&t.visibility!=="hidden"&&t.opacity!=="0"&&e.offsetParent!==null}clickBackdropToCloseMenu(){const e=document.querySelector(".cdk-overlay-backdrop");e&&(e.click(),this.debug("Clicked backdrop to close menu"))}showBatchDeleteProgress(e,t){this.hideBatchDeleteProgress();const r=document.createElement("div");r.className="gv-batch-delete-progress",r.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(32, 33, 36, 0.95);
      color: #e8eaed;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 2147483647;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      font-size: 14px;
    `;const o=document.createElement("div");if(o.style.cssText=`
      width: 20px;
      height: 20px;
      border: 2px solid #8ab4f8;
      border-top-color: transparent;
      border-radius: 50%;
      animation: gv-spin 1s linear infinite;
    `,!document.querySelector("#gv-batch-delete-styles")){const s=document.createElement("style");s.id="gv-batch-delete-styles",s.textContent=`
        @keyframes gv-spin {
          to { transform: rotate(360deg); }
        }
      `,document.head.appendChild(s)}const i=document.createElement("span");i.className="gv-batch-delete-progress-text",i.textContent=this.t("batch_delete_in_progress").replace("{current}",String(e)).replace("{total}",String(t)),r.appendChild(o),r.appendChild(i),document.body.appendChild(r),this.batchDeleteProgressElement=r}updateBatchDeleteProgress(e,t){if(this.batchDeleteProgressElement){const r=this.batchDeleteProgressElement.querySelector(".gv-batch-delete-progress-text");r&&(r.textContent=this.t("batch_delete_in_progress").replace("{current}",String(e)).replace("{total}",String(t)))}}hideBatchDeleteProgress(){this.batchDeleteProgressElement&&(this.batchDeleteProgressElement.remove(),this.batchDeleteProgressElement=null)}delay(e){return new Promise(t=>setTimeout(t,e))}clearSelection(){this.selectedConversations.clear()}selectConversation(e){this.selectedConversations.add(e)}toggleConversationSelection(e){if(this.selectedConversations.has(e)){if(this.selectedConversations.delete(e),this.selectedConversations.size===0&&this.isMultiSelectMode){this.exitMultiSelectMode();return}}else{if(this.selectedConversations.size>=this.MAX_BATCH_DELETE_COUNT){const t=this.t("batch_delete_limit_reached").replace("{max}",String(this.MAX_BATCH_DELETE_COUNT));this.showNotification(t,"info");return}this.selectedConversations.add(e)}}updateConversationSelectionUI(){this.multiSelectSource==="folder"?this.containerElement?.querySelectorAll(".gv-folder-conversation")?.forEach(t=>{const r=t.dataset.conversationId,o=t.dataset.folderId;r&&(!this.multiSelectFolderId||o===this.multiSelectFolderId)&&(this.selectedConversations.has(r)?t.classList.add("gv-folder-conversation-selected"):t.classList.remove("gv-folder-conversation-selected"))}):this.multiSelectSource==="native"&&this.sidebarContainer?.querySelectorAll('[data-test-id="conversation"]')?.forEach(t=>{const r=this.extractConversationId(t);r&&(this.selectedConversations.has(r)?t.classList.add("gv-conversation-selected"):t.classList.remove("gv-conversation-selected"))}),this.updateMultiSelectModeUI()}enterMultiSelectMode(e,t="native",r){this.debug("Entering multi-select mode",{source:t,folderId:r}),this.isMultiSelectMode=!0,this.multiSelectSource=t,this.multiSelectFolderId=r||null,e&&this.selectConversation(e),this.updateMultiSelectModeUI(),this.updateConversationSelectionUI(),"vibrate"in navigator&&navigator.vibrate(50),this.setupOutsideClickHandler()}exitMultiSelectMode(){this.debug("Exiting multi-select mode"),this.isMultiSelectMode=!1,this.multiSelectSource=null,this.multiSelectFolderId=null,this.removeOutsideClickHandler(),this.updateConversationSelectionUI(),this.clearSelection(),this.updateMultiSelectModeUI(),this.cleanupSelectionArtifacts()}setupOutsideClickHandler(){this.removeOutsideClickHandler(),this.outsideClickHandler=e=>{const t=e.target,r=this.sidebarContainer?.contains(t),o=this.containerElement?.contains(t),i=t.closest(".cdk-overlay-container, .mat-mdc-dialog-container");!r&&!o&&!i&&(this.debug("Click outside sidebar detected, exiting multi-select mode"),this.exitMultiSelectMode())},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler,!0)},0)}removeOutsideClickHandler(){this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler,!0),this.outsideClickHandler=null)}cleanupSelectionArtifacts(){this.sidebarContainer?.querySelectorAll('[data-test-id="conversation"]')?.forEach(r=>{r.classList.remove("gv-conversation-selected"),r.style.opacity="1"}),this.containerElement?.querySelectorAll(".gv-folder-conversation")?.forEach(r=>{r.classList.remove("gv-folder-conversation-selected"),r.style.opacity="1"}),this.highlightActiveConversationInFolders()}showInvalidSelectionFeedback(e){e.classList.remove("gv-invalid-selection"),e.offsetWidth,e.classList.add("gv-invalid-selection"),e.addEventListener("animationend",()=>{e.classList.remove("gv-invalid-selection")},{once:!0}),"vibrate"in navigator&&navigator.vibrate([30,20,30])}updateMultiSelectModeUI(){this.isMultiSelectMode?this.containerElement?.classList.add("gv-multi-select-mode"):this.containerElement?.classList.remove("gv-multi-select-mode");const e=this.containerElement?.querySelector('[data-selection-count="true"]');if(e){const r=this.selectedConversations.size;e.textContent=`${r} selected`}const t=this.containerElement?.querySelector('[data-multi-select-actions="true"]');if(t&&this.isMultiSelectMode){if(t.innerHTML="",this.multiSelectSource==="folder"){const o=document.createElement("button");o.className="gv-multi-select-action-btn gv-multi-select-delete-btn",o.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">delete</mat-icon>',o.title=this.t("batch_delete_button"),o.addEventListener("click",()=>this.batchDeleteConversations()),t.appendChild(o)}else if(this.multiSelectSource==="native"){const o=document.createElement("button");o.className="gv-multi-select-action-btn gv-multi-select-delete-btn",o.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">delete</mat-icon>',o.title=this.t("batch_delete_button"),o.addEventListener("click",()=>this.batchDeleteNativeConversations()),t.appendChild(o)}const r=document.createElement("button");r.className="gv-multi-select-action-btn gv-multi-select-exit-btn",r.innerHTML='<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true">close</mat-icon>',r.title="Exit multi-select mode",r.addEventListener("click",()=>this.exitMultiSelectMode()),t.appendChild(r)}else t&&(t.innerHTML="")}getSelectedConversationsData(e){const t=[];for(const r in this.data.folderContents)this.data.folderContents[r].forEach(i=>{this.selectedConversations.has(i.conversationId)&&t.push(i)});return t}renameConversation(e,t,r){const o=this.data.folderContents[e]?.find(f=>f.conversationId===t);if(!o)return;const i=o.title,s=document.createElement("input");s.type="text",s.className="gv-folder-name-input gv-conversation-rename-input",s.value=i,s.style.width="100%";const a=r.parentElement;if(!a)return;r.style.display="none",a.insertBefore(s,r),s.focus(),s.select();let l=!1;const d=()=>{try{s.removeEventListener("blur",m)}catch(f){this.debug("Failed to remove blur listener:",f)}try{s.removeEventListener("keydown",p)}catch(f){this.debug("Failed to remove keydown listener:",f)}},u=f=>{if(!l){l=!0,d();try{if(f){const g=s.value.trim();g&&g!==i&&(o.title=g,o.customTitle=!0,o.updatedAt=Date.now(),this.saveData())}}catch(g){this.debug("Failed to save renamed conversation:",g)}try{s.isConnected&&s.remove()}catch(g){this.debug("Failed to remove input:",g)}try{r.style.display=""}catch(g){this.debug("Failed to restore title display:",g)}try{r.textContent=o.title}catch(g){this.debug("Failed to restore title text:",g)}}},m=()=>{requestAnimationFrame(()=>u(!0))},p=f=>{f.key==="Enter"?(f.preventDefault(),u(!0)):f.key==="Escape"&&(f.preventDefault(),u(!1))};s.addEventListener("blur",m),s.addEventListener("keydown",p)}showFolderMenu(e,t){e.stopPropagation();const r=this.data.folders.find(a=>a.id===t);if(!r)return;const o=document.createElement("div");o.className="gv-folder-menu",o.style.position="fixed",o.style.left=`${e.clientX}px`,o.style.top=`${e.clientY}px`,[{label:r.pinned?this.t("folder_unpin"):this.t("folder_pin"),action:()=>this.togglePinFolder(t)},{label:this.t("folder_create_subfolder"),action:()=>this.createFolder(t)},{label:this.t("folder_rename"),action:()=>this.renameFolder(t)},{label:this.t("folder_change_color"),action:()=>this.showColorPicker(t,e)},{label:this.t("folder_delete"),action:()=>this.deleteFolder(t)}].forEach(a=>{const l=document.createElement("button");l.className="gv-folder-menu-item",l.textContent=a.label,l.addEventListener("click",()=>{a.action(),o.remove()}),o.appendChild(l)}),document.body.appendChild(o);const s=a=>{o.contains(a.target)||(o.remove(),document.removeEventListener("click",s))};setTimeout(()=>document.addEventListener("click",s),0)}showColorPicker(e,t,r=!0){const o=this.data.folders.find(d=>d.id===e);if(!o)return;if(this.activeColorPicker){const d=this.activeColorPickerFolderId===e;if(this.activeColorPicker.remove(),this.activeColorPickerCloseHandler&&(document.removeEventListener("click",this.activeColorPickerCloseHandler),this.activeColorPickerCloseHandler=null),this.activeColorPicker=null,this.activeColorPickerFolderId=null,r&&d)return}const i=document.createElement("div");i.className="gv-color-picker-dialog",i.style.position="fixed",i.style.left=`${t.clientX+10}px`,i.style.top=`${t.clientY}px`,i.style.zIndex="10001",hd.forEach(d=>{const u=document.createElement("button");u.className="gv-color-picker-item",u.title=this.t(d.nameKey);const m=fl(d.id,gl());u.style.backgroundColor=m,(o.color===d.id||!o.color&&d.id==="default")&&u.classList.add("selected"),u.addEventListener("click",()=>{this.changeFolderColor(e,d.id),i.remove(),this.activeColorPickerCloseHandler&&(document.removeEventListener("click",this.activeColorPickerCloseHandler),this.activeColorPickerCloseHandler=null),this.activeColorPicker=null,this.activeColorPickerFolderId=null}),i.appendChild(u)});const s=document.createElement("button");s.className="gv-color-picker-item gv-color-picker-custom",s.title=this.t("folder_color_custom");const a=document.createElement("input");a.type="color",Object.assign(a.style,{position:"absolute",opacity:"0",width:"100%",height:"100%",top:"0",left:"0",cursor:"pointer"}),o.color&&o.color.startsWith("#")?(a.value=o.color,s.classList.add("selected"),s.style.background=o.color):s.style.background="conic-gradient(from 180deg at 50% 50%, #D9231E 0deg, #F06800 66.47deg, #E6A300 125.68deg, #2D9CDB 195.91deg, #9B51E0 262.24deg, #D9231E 360deg)",a.addEventListener("change",d=>{const u=d.target.value;this.changeFolderColor(e,u),i.remove(),this.activeColorPickerCloseHandler&&(document.removeEventListener("click",this.activeColorPickerCloseHandler),this.activeColorPickerCloseHandler=null),this.activeColorPicker=null,this.activeColorPickerFolderId=null}),s.addEventListener("click",d=>{d.stopPropagation(),d.target===s&&a.click()}),s.appendChild(a),i.appendChild(s),document.body.appendChild(i),this.activeColorPicker=i,this.activeColorPickerFolderId=e;const l=d=>{i.contains(d.target)||(i.remove(),this.activeColorPicker=null,this.activeColorPickerFolderId=null,this.activeColorPickerCloseHandler&&(document.removeEventListener("click",this.activeColorPickerCloseHandler),this.activeColorPickerCloseHandler=null))};this.activeColorPickerCloseHandler=l,setTimeout(()=>document.addEventListener("click",l),0)}changeFolderColor(e,t){const r=this.data.folders.find(o=>o.id===e);r&&(r.color=t,r.updatedAt=Date.now(),this.saveData(),this.refresh())}showMoveToFolderDialog(e,t,r,o,i){const s=document.createElement("div");s.className="gv-folder-dialog-overlay";const a=document.createElement("div");a.className="gv-folder-dialog";const l=document.createElement("div");l.className="gv-folder-dialog-title",l.textContent=this.t("conversation_move_to_folder_title");const d=document.createElement("div");d.className="gv-folder-dialog-list";const u=(p,f=0)=>{const g=this.data.folders.filter(w=>w.parentId===p);this.sortFolders(g).forEach(w=>{const v=document.createElement("button");v.className="gv-folder-dialog-item",v.style.paddingLeft=`${f*16+12}px`;const S=document.createElement("mat-icon");S.className="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color",S.setAttribute("role","img"),S.setAttribute("aria-hidden","true"),S.textContent="folder";const C=document.createElement("span");C.textContent=w.name,v.appendChild(S),v.appendChild(C),v.addEventListener("click",()=>{this.addConversationToFolderFromNative(w.id,e,t,r,o,i),s.remove()}),d.appendChild(v),u(w.id,f+1)})};u(null);const m=document.createElement("button");m.className="gv-folder-dialog-cancel",m.textContent=this.t("pm_cancel"),m.addEventListener("click",()=>s.remove()),a.appendChild(l),a.appendChild(d),a.appendChild(m),s.appendChild(a),document.body.appendChild(s),s.addEventListener("click",p=>{p.target===s&&s.remove()})}moveConversationToFolder(e,t,r){this.data.folderContents[e]&&(this.data.folderContents[e]=this.data.folderContents[e].filter(i=>i.conversationId!==r.conversationId)),this.data.folderContents[t]||(this.data.folderContents[t]=[]),this.data.folderContents[t].findIndex(i=>i.conversationId===r.conversationId)===-1&&this.data.folderContents[t].push({...r,addedAt:Date.now()}),this.saveData(),this.refresh()}addConversationToFolderFromNative(e,t,r,o,i,s){this.data.folderContents[e]||(this.data.folderContents[e]=[]),this.data.folderContents[e].findIndex(l=>l.conversationId===t)===-1&&this.data.folderContents[e].push({conversationId:t,title:r,url:o,addedAt:Date.now(),isGem:i,gemId:s}),this.saveData(),this.refresh()}setupNativeConversationMenuObserver(){this.nativeMenuObserver&&this.nativeMenuObserver.disconnect(),this.nativeMenuObserver=new MutationObserver(e=>{this.isDestroyed||e.forEach(t=>{t.addedNodes.forEach(r=>{if(r instanceof HTMLElement){const o=r.querySelector(".mat-mdc-menu-content");o&&!o.querySelector(".gv-move-to-folder-btn")?this.isConversationMenu(r)?(this.debug("Observer: conversation menu detected, preparing to inject"),this.injectMoveToFolderButton(o)):this.debug("Observer: non-conversation menu detected, skipping injection"):o&&this.debug("Observer: menu content detected but button already present")}}),t.removedNodes.forEach(r=>{r instanceof HTMLElement&&(r.classList?.contains("mat-mdc-menu-panel")||r.querySelector(".mat-mdc-menu-panel"))&&(this.debug("Observer: menu closed, clearing conversation state"),this.lastClickedConversation=null,this.lastClickedConversationInfo=null)})})}),this.nativeMenuObserver.observe(document.body,{childList:!0,subtree:!0})}isConversationMenu(e){if(e.querySelector(".mat-mdc-menu-panel")?.classList.contains("gds-mode-switch-menu"))return this.debug("isConversationMenu: detected model selection menu"),!1;if(e.querySelector(".bard-mode-list-button"))return this.debug("isConversationMenu: detected bard mode list menu"),!1;const r=e.querySelector(".mat-mdc-menu-content");if(!r)return!1;const o=r.querySelector('[data-test-id="pin-button"]'),i=r.querySelector('[data-test-id="rename-button"]'),s=r.querySelector('[data-test-id="share-button"]'),a=r.querySelector('[data-test-id="delete-button"]');return o||i||s||a?(this.debug("isConversationMenu: found conversation-specific buttons"),!0):this.lastClickedConversation?(this.debug("isConversationMenu: lastClickedConversation exists"),!0):(this.debug("isConversationMenu: could not determine menu type, defaulting to false"),!1)}injectMoveToFolderButton(e){this.debug("injectMoveToFolderButton: begin");let t=null,r=null,o=null;if(this.lastClickedConversationInfo)this.debug("Using pre-extracted conversation info"),t=this.lastClickedConversationInfo.id,r=this.lastClickedConversationInfo.title,o=this.lastClickedConversationInfo.url;else{this.debug("No pre-extracted info, falling back to extraction from element");const m=this.findConversationElementFromMenu();if(!m){this.debug("No conversation element found from menu");return}t=this.extractNativeConversationId(m),r=this.extractNativeConversationTitle(m),o=this.extractNativeConversationUrl(m)}if(!t){const m=this.extractHexIdFromMenu(e);if(m)t=m,this.debug("injectMoveToFolderButton: using id from menu jslog",t);else if(this.lastClickedConversation){const p=this.extractHexIdFromJslog(this.lastClickedConversation);p&&(t=p,this.debug("injectMoveToFolderButton: using id from conversation jslog",t))}}if(!o&&t&&(o=this.buildConversationUrlFromId(t),this.debug("injectMoveToFolderButton: built fallback URL from id",o)),(!r||r.trim()==="")&&this.lastClickedConversation&&(r=this.extractFallbackTitle(this.lastClickedConversation)||"Untitled",this.debug("injectMoveToFolderButton: using fallback title",r)),this.debug("Extracted conversation info:",{conversationId:t,title:r,url:o}),!t||!r||!o){this.debugWarn("Missing conversation info:",{conversationId:t,title:r,url:o});return}const i=document.createElement("button");i.className="mat-mdc-menu-item mat-focus-indicator gv-move-to-folder-btn",i.setAttribute("role","menuitem"),i.setAttribute("tabindex","0"),i.setAttribute("aria-disabled","false");const s=document.createElement("mat-icon");s.className="mat-icon notranslate gds-icon-l google-symbols mat-ligature-font mat-icon-no-color",s.setAttribute("role","img"),s.setAttribute("fonticon","folder_open"),s.setAttribute("aria-hidden","true"),s.textContent="folder_open";const a=document.createElement("span");a.className="mat-mdc-menu-item-text";const l=document.createElement("span");l.className="gds-body-m",l.textContent=this.t("conversation_move_to_folder"),a.appendChild(l);const d=document.createElement("div");d.className="mat-ripple mat-mdc-menu-ripple",d.setAttribute("matripple",""),i.appendChild(s),i.appendChild(a),i.appendChild(d),i.addEventListener("click",m=>{m.stopPropagation(),this.showMoveToFolderDialog(t,r,o);const p=document.querySelectorAll(".cdk-overlay-backdrop"),f=p.length>0?p[p.length-1]:null;if(f instanceof HTMLElement)this.debug("Closing menu by clicking backdrop"),f.click();else{this.debug("Backdrop not found, performing manual cleanup");const g=e.closest(".mat-mdc-menu-panel");g&&g.remove();const b=document.querySelector(".cdk-overlay-backdrop");b&&b.remove()}});const u=e.querySelector('[data-test-id="pin-button"]');u&&u.nextSibling?(this.debug("injectMoveToFolderButton: inserting after pin-button"),e.insertBefore(i,u.nextSibling)):(this.debug("injectMoveToFolderButton: inserting at beginning of menu"),e.insertBefore(i,e.firstChild))}findConversationElementFromMenu(){return this.lastClickedConversation?(this.debug("findConversationElementFromMenu: using lastClickedConversation"),this.lastClickedConversation):(this.debugWarn("findConversationElementFromMenu: no conversation element found (lastClickedConversation is null)"),null)}lastClickedConversation=null;lastClickedConversationInfo=null;setupConversationClickTracking(){document.addEventListener("click",e=>{const r=e.target.closest('[data-test-id="actions-menu-button"]');if(r){this.debug("More button clicked:",r);let o=null;const i=r.closest(".conversation-actions-container");if(i){this.debug("Found actions container, looking for sibling conversation...");let s=i.previousElementSibling;for(;s;){if(s.getAttribute("data-test-id")==="conversation"){o=s,this.debug("Found conversation as sibling:",o);break}s=s.previousElementSibling}}if(o||(this.debug("Trying closest with conversation selector..."),o=r.closest('[data-test-id="conversation"]')),o||(this.debug("Trying history-item selector..."),o=r.closest('[data-test-id^="history-item"]')),o||(this.debug("Trying conversation-card selector..."),o=r.closest(".conversation-card")),!o&&i&&i.parentElement){this.debug("Trying to find conversation in parent container...");const s=i.parentElement,a=s.querySelector('[data-test-id="conversation"]');if(a){const l=Array.from(s.children).indexOf(i),d=Array.from(s.children).indexOf(a);Math.abs(l-d)<=1&&(o=a,this.debug("Found conversation in parent container"))}}if(o||(this.debugWarn("Could not find precise conversation element, using broader fallback"),o=r.closest("[jslog]")),o){this.lastClickedConversation=o;const s=o.querySelectorAll('a[href*="/app/"], a[href*="/gem/"]').length,a=o.getAttribute("jslog"),l=o.getAttribute("data-test-id");this.debug("Tracked conversation element:",{element:o,linkCount:s,jslog:a,dataTestId:l});const d=this.extractNativeConversationId(o),u=this.extractNativeConversationTitle(o),m=this.extractNativeConversationUrl(o);d&&u&&m?(this.lastClickedConversationInfo={id:d,title:u,url:m},this.debug("âœ… Extracted conversation info on click:",this.lastClickedConversationInfo)):(this.debugWarn("âš ï¸ Failed to extract complete conversation info on click",{conversationId:d,title:u,url:m}),this.lastClickedConversationInfo=null);let p=0;const f=20,g=window.setInterval(()=>{p++;const b=document.querySelector(".mat-mdc-menu-panel .mat-mdc-menu-content");b?(this.debug("Overlay poll: menu content found on attempt",p),b.querySelector(".gv-move-to-folder-btn")||(this.debug("Overlay poll: injecting Move to Folder"),this.injectMoveToFolderButton(b)),window.clearInterval(g)):p>=f&&(this.debugWarn("Overlay poll: menu not found within attempts",f),window.clearInterval(g))},50)}}},!0)}extractNativeConversationId(e){const t=e.closest('[data-test-id="conversation"]')||e,r=t.querySelectorAll('a[href*="/app/"], a[href*="/gem/"]');if(r.length===0){this.debugWarn("extractId: no conversation link found under scope");const a=this.extractHexIdFromJslog(t);return a||null}let o;if(r.length>1){this.debugWarn(`extractId: found ${r.length} links, attempting to select the most appropriate one`);let a=1/0,l=r[0];for(const d of Array.from(r)){const u=d.getBoundingClientRect(),m=u.width*u.height;m>0&&m<a&&(a=m,l=d)}o=a<1/0?l:r[0],this.debug("extractId: selected link with area",a)}else o=r[0];const i=o.getAttribute("href")||"";this.debug("extractId: found link href",i);let s=i.match(/\/app\/([^\/?#]+)/);return s&&s[1]?(this.debug("extractId: extracted from /app/",s[1]),s[1]):(s=i.match(/\/gem\/[^/]+\/([^\/?#]+)/),s&&s[1]?(this.debug("extractId: extracted from /gem/",s[1]),s[1]):(this.debugWarn("extractId: failed to extract id from href"),null))}extractNativeConversationTitle(e){const t=e.closest('[data-test-id="conversation"]')||e;let o=t.querySelector('.gds-label-l, .conversation-title-text, [data-test-id="conversation-title"], h3')?.textContent?.trim()||null;if(o&&!this.isGemLabel(o))return this.debug("extractTitle(selectors):",o),o;const i=t.querySelector('a[href*="/app/"], a[href*="/gem/"]'),s=i?.getAttribute("aria-label")?.trim();if(s&&!this.isGemLabel(s))return this.debug("extractTitle(link aria-label):",s),s;const a=i?.getAttribute("title")?.trim();if(a&&!this.isGemLabel(a))return this.debug("extractTitle(link title attr):",a),a;const l=this.extractTitleFromLinkText(i||void 0);return l?(this.debug("extractTitle(link text):",l),l):(o=this.extractFallbackTitle(t),o&&!this.isGemLabel(o)?(this.debug("extractTitle(fallback):",o),o):(this.debug("extractTitle: null"),null))}syncConversationTitleFromNative(e){try{const t=document.querySelectorAll('[data-test-id="conversation"]');for(const r of Array.from(t)){const o=r.getAttribute("jslog");if(o&&o.includes(e)){const s=this.extractNativeConversationTitle(r);if(s)return this.debug("Synced title from native:",s),s}const i=r.querySelector('a[href*="/app/"], a[href*="/gem/"]');if(i&&i.href.includes(e)){const s=this.extractNativeConversationTitle(r);if(s)return this.debug("Synced title from native (by href):",s),s}}}catch(t){this.debug("Error syncing title from native:",t)}return null}updateConversationTitle(e,t){let r=!1;for(const o in this.data.folderContents){const i=this.data.folderContents[o];for(const s of i)(s.conversationId===e||s.url.includes(e))&&!s.customTitle&&(s.title=t,r=!0,this.debug(`Updated title for conversation ${e} in folder ${o}`))}r&&(this.saveData(),this.renderAllFolders())}scheduleConversationRemovalCheck(e){const t=this.pendingRemovals.get(e);t&&(clearTimeout(t),this.debug(`Cancelled previous removal timer for ${e}`));const r=window.setTimeout(()=>{this.confirmConversationRemoval(e)},this.removalCheckDelay);this.pendingRemovals.set(e,r),this.debug(`Scheduled removal check for ${e} (delay: ${this.removalCheckDelay}ms)`)}cancelPendingRemovalForElement(e){const t=this.extractConversationIdFromElement(e);if(t){const r=this.pendingRemovals.get(t);r&&(clearTimeout(r),this.pendingRemovals.delete(t),this.debug(`Cancelled removal for ${t} (conversation re-added to DOM)`))}}isConversationInDOM(e){if(!this.sidebarContainer)return this.debugWarn("Sidebar container not available for DOM check"),!0;try{return this.sidebarContainer.querySelector(`[data-test-id="conversation"][jslog*="c_${e}"]`)?(this.debug(`Found conversation ${e} in DOM by jslog`),!0):this.sidebarContainer.querySelector(`[data-test-id="conversation"] a[href*="${e}"]`)?(this.debug(`Found conversation ${e} in DOM by href`),!0):(this.debug(`Conversation ${e} not found in DOM`),!1)}catch(t){return this.debugWarn(`DOM check failed for ${e}:`,t),!0}}getCurrentConversationId(){const e=window.location.href,t=e.match(/\/app\/([^\/?#]+)/),r=e.match(/\/gem\/[^/]+\/([^\/?#]+)/);return t?.[1]||r?.[1]||null}confirmConversationRemoval(e){this.pendingRemovals.delete(e),this.debug(`
â•â•â• Confirming removal for conversation ${e} â•â•â•`),this.debug(`  Delay elapsed: ${this.removalCheckDelay}ms`);const t=this.getCurrentConversationId(),r=window.location.href;if(t===e){this.debug("  âœ“ SKIPPED: Currently active conversation"),this.debug(`    Current URL: ${r}`),this.debug(`    Matched ID: ${t}`),this.debug(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`);return}if(this.isConversationInDOM(e)){this.debug("  âœ“ SKIPPED: Conversation still exists in DOM"),this.debug("    Likely a UI refresh, not a deletion"),this.debug(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`);return}this.debug("  âœ— CONFIRMED DELETION: Removing from all folders"),this.debug("    Reason: Not in current URL and not found in DOM"),this.debug(`    Current URL: ${r}`),this.debug(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`),this.removeConversationFromAllFolders(e)}removeConversationFromAllFolders(e){let t=!1;for(const r in this.data.folderContents){const o=this.data.folderContents[r],i=o.length;this.data.folderContents[r]=o.filter(s=>s.conversationId!==e&&!s.url.includes(e)),this.data.folderContents[r].length<i&&(t=!0,this.debug(`Removed deleted conversation ${e} from folder ${r}`))}t&&(this.saveData(),this.renderAllFolders())}extractHexIdFromJslog(e){try{const t=i=>i&&i.match(/c_([a-f0-9]{8,})/i)?.[1]||null,r=t(e.getAttribute("jslog"));if(r)return this.debug("extractId(jslog self):",r),r;const o=e.querySelectorAll("[jslog]");for(const i of Array.from(o)){const s=t(i.getAttribute("jslog"));if(s)return this.debug("extractId(jslog descendant):",s),s}}catch(t){this.debugWarn("extractHexIdFromJslog error:",t)}return this.debugWarn("extractId(jslog): not found"),null}extractHexIdFromMenu(e){try{const t=e.querySelectorAll("[jslog]");for(const r of Array.from(t)){const o=r.getAttribute("jslog");if(!o)continue;const i=o.match(/c_([a-f0-9]{8,})/i);if(i&&i[1])return this.debug("extractId(menu jslog):",i[1]),i[1]}}catch(t){this.debugWarn("extractHexIdFromMenu error:",t)}return this.debugWarn("extractId(menu): not found"),null}buildConversationUrlFromId(e){try{const r=window.location.pathname.match(/\/gem\/([^\/]+)/);if(r&&r[1])return`https://gemini.google.com/gem/${r[1]}/${e}`}catch(t){this.debug("Failed to extract gem URL:",t)}return`https://gemini.google.com/app/${e}`}extractFallbackTitle(e){try{const t=e.closest('[data-test-id="conversation"]')||e,r=t.getAttribute("aria-label");if(r&&r.trim())return this.debug("fallbackTitle(aria-label):",r.trim()),r.trim();const o=t.getAttribute("title");if(o&&o.trim())return this.debug("fallbackTitle(title attr):",o.trim()),o.trim();const s=t.querySelector(".gds-body-m, .gds-label-m, .subtitle")?.textContent?.trim();if(s&&!this.isGemLabel(s))return this.debug("fallbackTitle(label-ish):",s),s;const a=t.textContent?.trim()||"";if(a){const d=(a.split(`
`).map(u=>u.trim()).filter(Boolean)[0]||a).slice(0,80);return this.debug("fallbackTitle(textContent):",d),d}}catch(t){this.debugWarn("extractFallbackTitle error:",t)}return null}isGemLabel(e){const t=(e||"").trim();if(!t)return!1;const r=t.toLowerCase();if(r==="gem"||r==="gems")return!0;for(const o of md)if(r===o.name.toLowerCase())return!0;return!1}extractTitleFromLinkText(e){if(!e)return null;const t=(e.innerText||"").trim();if(!t)return null;const r=t.split(`
`).map(i=>i.trim()).filter(Boolean).filter(i=>!this.isGemLabel(i)).filter(i=>i.length>=2);return this.debug("extractTitleFromLinkText parts:",r),r.length===0?null:r.reduce((i,s)=>s.length>i.length?s:i,r[0])||null}extractNativeConversationUrl(e){const t=e.closest('[data-test-id="conversation"]')||e,r=t.querySelector('a[href*="/app/"], a[href*="/gem/"]');if(!r){this.debugWarn("extractUrl: no conversation link found under scope");const s=this.extractHexIdFromJslog(t);if(s){const a=this.buildConversationUrlFromId(s);return this.debug("extractUrl(jslog fallback):",a),a}return null}const o=r.getAttribute("href");if(!o)return this.debugWarn("extractUrl: link has no href"),null;const i=o.startsWith("http")?o:`https://gemini.google.com${o}`;return this.debug("extractUrl:",i),i}refresh(){if(!this.containerElement)return;const e=this.containerElement.querySelector(".gv-folder-list");if(e){const t=this.createFoldersList();e.replaceWith(t)}this.applyHideArchivedSetting(),this.highlightActiveConversationInFolders(),this.pendingTitleUpdates.size>0&&(this.debug(`Flushing ${this.pendingTitleUpdates.size} pending title updates`),this.saveData().then(t=>{t?this.pendingTitleUpdates.clear():this.debugWarn("Save failed, retaining pending title updates for next attempt")}).catch(t=>{console.error("[FolderManager] Failed to save pending title updates:",t)}))}getCurrentHexIdFromLocation(){try{const t=(window.location.pathname||"").match(/\/(?:app|gem\/[^/]+)\/([a-f0-9]+)/i);return t?t[1]:null}catch(e){return this.debug("Failed to get current hex ID from location:",e),null}}highlightActiveConversationInFolders(){if(!this.containerElement)return;const e=this.getCurrentHexIdFromLocation(),t=e?`c_${e}`:null;this.containerElement.querySelectorAll(".gv-folder-conversation").forEach(o=>{const i=o,s=t&&i.dataset.conversationId===t;i.classList.toggle("gv-folder-conversation-selected",!!s)})}ensureDataIntegrity(){this.data.folderContents||(this.data.folderContents={},this.debugWarn("folderContents was missing, initialized")),this.data.folders||(this.data.folders=[],this.debugWarn("folders was missing, initialized")),this.data.folders.forEach(e=>{this.data.folderContents[e.id]||(this.data.folderContents[e.id]=[],this.debugWarn(`Initialized missing folderContents for folder: ${e.name}`))})}async loadData(){try{const e=await this.storage.loadData(hr);if(e&&ao(e)){this.data=e,this.ensureDataIntegrity();const t=new Set(this.data.folders.map(r=>r.id));t.add(mr),Object.keys(this.data.folderContents).forEach(r=>{t.has(r)||(this.debugWarn(`Removing orphaned folderContents for: ${r}`),delete this.data.folderContents[r])}),this.backupService.createPrimaryBackup(this.data),this.debug("Data loaded and validated successfully")}else e?(console.warn("[FolderManager] Storage returned invalid data structure, attempting recovery from backup"),this.attemptDataRecovery({reason:"corrupted",originalData:e})):(console.log("[FolderManager] No folder data found, initializing empty state (likely first-time user)"),this.data={folders:[],folderContents:{}})}catch(e){console.error("[FolderManager] Load data error:",e),this.attemptDataRecovery(e)}}attemptDataRecovery(e){console.warn("[FolderManager] Attempting data recovery after load failure");const t=this.backupService.recoverFromBackup();if(t&&ao(t)){this.data=t,this.ensureDataIntegrity(),console.warn("[FolderManager] Data recovered from localStorage backup"),this.showNotificationByLevel("Folder data has been recovered from a backup.","warning"),this.saveData();return}if(ao(this.data)&&this.data.folders.length>0){console.warn("[FolderManager] Keeping existing in-memory data after load error"),this.ensureDataIntegrity();return}console.error("[FolderManager] CRITICAL: Unable to recover data, initializing empty state"),console.error("[FolderManager] Original error:",e),this.data={folders:[],folderContents:{}},this.showDataLossNotification()}showDataLossNotification(){this.showNotificationByLevel(Ke("folderManager_dataLossWarning")||"Warning: Failed to load folder data. Please check your browser console for details.","error")}showNotificationByLevel(e,t="error"){try{const r={info:"#2196F3",warning:"#FF9800",error:"#f44336"},o=document.createElement("div");o.style.cssText=`
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${r[t]};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        max-width: 400px;
        line-height: 1.4;
      `,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{try{document.body.removeChild(o)}catch{}},t==="info"?3e3:t==="warning"?7e3:jf)}catch(r){console.error("[FolderManager] Failed to show notification:",r)}}async saveData(){if(this.saveInProgress)return this.debug("Save already in progress, skipping duplicate call"),!1;this.saveInProgress=!0;let e=!1;try{if(this.ensureDataIntegrity(),this.backupService.createEmergencyBackup(this.data),this.data.folders.length===0&&Object.keys(this.data.folderContents).length===0){const t=await this.storage.loadData(hr);t&&(t.folders.length>0||Object.keys(t.folderContents).length>0)&&(console.warn("[FolderManager] WARNING: Attempting to save empty data over existing non-empty data"),console.warn("[FolderManager] This may indicate a bug."))}e=await this.storage.saveData(hr,this.data),e||(console.warn("[FolderManager] Save failed, retrying once..."),e=await this.storage.saveData(hr,this.data)),e?(this.backupService.createPrimaryBackup(this.data),this.debug("Data saved successfully")):console.error("[FolderManager] Save failed after retry")}catch(t){console.error("[FolderManager] Save data error:",t),e=!1}finally{this.saveInProgress=!1}return e}async loadFolderEnabledSetting(){try{const e=await Ce.storage.sync.get({geminiFolderEnabled:!0});this.folderEnabled=e.geminiFolderEnabled!==!1,this.debug("Loaded folder enabled setting:",this.folderEnabled)}catch(e){console.error("[FolderManager] Failed to load folder enabled setting:",e),this.folderEnabled=!0}}async loadHideArchivedSetting(){try{const e=await Ce.storage.sync.get({geminiFolderHideArchivedConversations:!1});this.hideArchivedConversations=!!e.geminiFolderHideArchivedConversations,this.debug("Loaded hide archived setting:",this.hideArchivedConversations)}catch(e){console.error("[FolderManager] Failed to load hide archived setting:",e),this.hideArchivedConversations=!1}}async loadFilterUserSetting(){try{const e=await Ce.storage.sync.get({[ke.GV_FOLDER_FILTER_USER_ONLY]:!1});this.filterCurrentUserOnly=!!e[ke.GV_FOLDER_FILTER_USER_ONLY],this.debug("Loaded filter user setting:",this.filterCurrentUserOnly)}catch(e){console.error("[FolderManager] Failed to load filter user setting:",e),this.filterCurrentUserOnly=!1}}setupStorageListener(){Ce.storage.onChanged.addListener((e,t)=>{t==="sync"&&(e.geminiFolderEnabled&&(this.folderEnabled=e.geminiFolderEnabled.newValue!==!1,this.debug("Folder enabled setting changed:",this.folderEnabled),this.applyFolderEnabledSetting()),e.geminiFolderHideArchivedConversations&&(this.hideArchivedConversations=!!e.geminiFolderHideArchivedConversations.newValue,this.debug("Hide archived setting changed:",this.hideArchivedConversations),this.applyHideArchivedSetting()),e[ke.LANGUAGE]&&(this.debug("Language changed, updating UI text..."),this.updateHeaderLanguageText())),t==="local"&&e[ke.LANGUAGE]&&(this.debug("Language changed (local), updating UI text..."),this.updateHeaderLanguageText()),t==="local"&&e.gvFolderData&&(this.debug("Folder data changed in chrome.storage.local, reloading..."),this.reloadFoldersFromStorage())}),chrome.runtime.onMessage.addListener((e,t,r)=>(e?.type==="gv.folders.reload"&&(this.debug("Received folder reload message"),this.reloadFoldersFromStorage(),r({ok:!0})),!0)),this.performMigration()}async reloadFoldersFromStorage(){try{await this.loadData(),this.renderAllFolders(),this.debug("Folders reloaded from storage")}catch(e){console.error("[FolderManager] Failed to reload folders:",e)}}async performMigration(){try{(await chrome.storage.local.get("gvSyncMode")).gvSyncMode==="auto"&&(console.log('[FolderManager] Migrating legacy "auto" sync mode to "manual"'),await chrome.storage.local.set({gvSyncMode:"manual"}))}catch(e){console.error("[FolderManager] Migration failed:",e)}}mergeFolderDataForAutoSync(e,t){const r=new Map;e.folders.forEach(s=>{r.set(s.id,s)}),t.folders.forEach(s=>{const a=r.get(s.id);if(!a)r.set(s.id,s);else{const l=s.updatedAt||s.createdAt||0,d=a.updatedAt||a.createdAt||0;l>d&&r.set(s.id,s)}});const o={...e.folderContents};return new Set([...Object.keys(e.folderContents),...Object.keys(t.folderContents)]).forEach(s=>{const a=e.folderContents[s]||[],l=t.folderContents[s]||[],d=new Map;l.forEach(u=>d.set(u.conversationId,u)),a.forEach(u=>d.set(u.conversationId,u)),o[s]=Array.from(d.values())}),{folders:Array.from(r.values()),folderContents:o}}applyFolderEnabledSetting(){this.folderEnabled?this.containerElement?(this.containerElement.style.display="",this.debug("Folder feature enabled")):(this.debug("Folder feature enabled, initializing UI"),this.initializeFolderUI().catch(e=>{console.error("[FolderManager] Failed to initialize folder UI:",e)})):this.containerElement&&(this.containerElement.style.display="none",this.debug("Folder feature disabled"))}applyHideArchivedSetting(){if(!this.sidebarContainer)return;this.sidebarContainer.querySelectorAll('[data-test-id="conversation"]').forEach(t=>{this.applyHideArchivedToConversation(t)})}applyHideArchivedToConversation(e){const t=this.extractConversationId(e),r=this.isConversationInFolders(t);this.hideArchivedConversations&&r?e.classList.add("gv-conversation-archived"):e.classList.remove("gv-conversation-archived")}isConversationInFolders(e){for(const t in this.data.folderContents)if(this.data.folderContents[t].some(o=>{if(o.conversationId===e)return!0;const i=e.replace(/^c_/,""),s=o.conversationId.replace(/^c_/,"");return!!(i&&i===s||i&&i.length>8&&o.url.includes(i))}))return!0;return!1}generateId(){return`folder_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}hashString(e){let t=0;for(let r=0;r<e.length;r++){const o=e.charCodeAt(r);t=(t<<5)-t+o,t=t&t}return Math.abs(t).toString(36)}navigateToConversationById(e,t){const r=this.data.folderContents[e]?.find(o=>o.conversationId===t);if(!r){console.error("[FolderManager] Conversation not found:",t);return}this.debug("Navigating to conversation:",{title:r.title,url:r.url,isGem:r.isGem,gemId:r.gemId}),this.navigateToConversation(r.url,r)}navigateToConversation(e,t){try{const r=new URL(e),o=r.pathname.split("/"),i=o[o.length-1],s=document.querySelectorAll('[data-test-id="conversation"]');for(const l of Array.from(s)){const d=l.getAttribute("jslog");if(d&&d.includes(i)){l.click(),this.debug("Navigated by clicking sidebar element"),setTimeout(()=>this.highlightActiveConversationInFolders(),0),setTimeout(()=>{if(t){const u=this.syncConversationTitleFromNative(i);u&&u!==t.title&&(this.updateConversationTitle(i,u),this.debug("Updated conversation title after navigation:",u))}t&&!t.gemId?this.checkAndUpdateGemId(i):t?.gemId&&this.debug("Known gem conversation:",t.gemId)},300);return}}this.debug("Sidebar element not found, trying pushState"),window.history.pushState({},"",e);const a=new PopStateEvent("popstate",{state:{}});window.dispatchEvent(a),setTimeout(()=>this.highlightActiveConversationInFolders(),0),setTimeout(()=>{window.location.pathname!==r.pathname&&(this.debug("Falling back to page reload"),window.location.href=e)},200)}catch(r){console.error("[FolderManager] Navigation error:",r),window.location.href=e}}checkAndUpdateGemId(e){setTimeout(()=>{const t=window.location.pathname;if(this.debug("Checking URL after navigation:",t),t.includes("/gem/")){const r=t.match(/\/gem\/([^\/]+)/);if(r){const o=r[1];this.debug("Detected Gem after navigation:",o);let i=!1;for(const s in this.data.folderContents){const a=this.data.folderContents[s];for(const l of a)if(l.url.includes(e)){const d=l.url;l.isGem=!0,l.gemId=o,l.url=l.url.replace(/\/app\/([^/?]+)/,`/gem/${o}/$1`),i=!0,this.debug("Updated conversation:",l.title),this.debug("Old URL:",d),this.debug("New URL:",l.url),this.debug("Gem ID:",o)}}i&&(this.saveData(),this.renderAllFolders())}}},500)}renderAllFolders(){if(!this.containerElement)return;const e=this.containerElement.querySelector(".gv-folder-list");if(!e)return;const t=this.createFoldersList();e.replaceWith(t),this.debug("Re-rendered all folders"),this.highlightActiveConversationInFolders()}installRouteChangeListener(){const e=()=>{this.isDestroyed||setTimeout(()=>this.highlightActiveConversationInFolders(),0)},t=[];try{window.addEventListener("popstate",e),t.push(()=>window.removeEventListener("popstate",e))}catch(r){this.debug("Failed to add popstate listener:",r)}try{const r=history,o=r.pushState,i=r.replaceState,s=(a,l)=>{r[a]=function(...d){const u=l.apply(this,d);try{e()}catch{}return u}};s("pushState",o),s("replaceState",i),t.push(()=>{r.pushState=o,r.replaceState=i})}catch(r){this.debug("Failed to wrap history methods:",r)}try{this.lastPathname=window.location.pathname,this.navPoller=window.setInterval(()=>{if(this.isDestroyed){this.navPoller&&clearInterval(this.navPoller);return}const r=window.location.pathname;r!==this.lastPathname&&(this.lastPathname=r,e())},400)}catch(r){this.debug("Failed to setup navigation poller:",r)}this.routeChangeCleanup=()=>{t.forEach(r=>r()),this.navPoller&&(clearInterval(this.navPoller),this.navPoller=null)}}installSidebarClickListener(){const e=this.sidebarContainer;if(e){this.sidebarClickListener=t=>{if(this.isDestroyed)return;const r=t.target;if(!r)return;r.closest('a[href*="/app/"], a[href*="/gem/"]')&&setTimeout(()=>this.highlightActiveConversationInFolders(),0)};try{e.addEventListener("click",this.sidebarClickListener,!0)}catch(t){this.debug("Failed to add sidebar click listener:",t)}}}t(e){return qd(e)}updateHeaderLanguageText(){if(!this.containerElement)return;const e=this.containerElement.querySelector(".gv-folder-header .title");e&&(e.textContent=this.t("folder_title"));const t=this.containerElement.querySelector(".gv-folder-header-actions");t&&t.querySelectorAll("button").forEach(i=>{if(i.classList.contains("gv-folder-add-btn"))i.title=this.t("folder_create");else if(i.classList.contains("gv-folder-action-btn")){const s=i.querySelector("mat-icon");s?.textContent==="person"?i.title=this.t("folder_filter_current_user"):s?.textContent==="folder_managed"&&(i.title=this.t("folder_import_export"));const a=i.querySelector("svg");if(a){const l=a.querySelector("path")?.getAttribute("d")||"";l.includes("520q-33 0-56.5-23.5")?i.title=this.t("folder_cloud_upload"):l.includes("520-716v242")&&(i.title=this.t("folder_cloud_sync"))}}});const r=this.containerElement.querySelector(".gv-folder-empty");r&&(r.textContent=this.t("folder_empty")),this.debug("Header language text updated")}setupMessageListener(){Ce.runtime.onMessage.addListener((e,t,r)=>e.type==="gv.sync.requestData"?(this.debug("Received request for folder data from popup"),r({ok:!0,data:this.data}),!0):(e.type==="gv.folders.reload"&&(this.debug("Received reload request"),this.loadData().then(()=>{this.refresh();try{r({ok:!0})}catch{}})),!0))}createTooltip(){this.tooltipElement=document.createElement("div"),this.tooltipElement.className="gv-tooltip",document.body.appendChild(this.tooltipElement)}showTooltip(e,t){!this.tooltipElement||(this.tooltipTimeout&&clearTimeout(this.tooltipTimeout),!(e.scrollWidth>e.clientWidth))||(this.tooltipTimeout=window.setTimeout(()=>{if(!this.tooltipElement)return;this.tooltipElement.textContent=t;const o=e.getBoundingClientRect(),i=this.tooltipElement.getBoundingClientRect();let s=o.left,a=o.bottom+8;s+i.width>window.innerWidth&&(s=window.innerWidth-i.width-10),a+i.height>window.innerHeight&&(a=o.top-i.height-8),this.tooltipElement.style.left=`${s}px`,this.tooltipElement.style.top=`${a}px`,this.tooltipElement.offsetHeight,this.tooltipElement.classList.add("show")},200))}hideTooltip(){this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null),this.tooltipElement&&this.tooltipElement.classList.remove("show")}exportFolders(){if(this.exportInProgress){this.showNotification(this.t("folder_export_in_progress")||"Export already in progress","info");return}this.exportInProgress=!0;try{const e=dr.exportToPayload(this.data);dr.downloadJSON(e),this.showNotification(this.t("folder_export_success"),"success"),this.debug("Folders exported successfully")}catch(e){console.error("[FolderManager] Export error:",e),this.showNotification(this.t("folder_import_error").replace("{error}",String(e)),"error")}finally{this.exportInProgress=!1}}showImportDialog(){const e=document.createElement("div");e.className="gv-folder-dialog-overlay";const t=document.createElement("div");t.className="gv-folder-import-dialog";const r=document.createElement("div");r.className="gv-folder-dialog-title",r.textContent=this.t("folder_import_title");const o=document.createElement("div");o.className="gv-folder-import-strategy";const i=document.createElement("div");i.className="gv-folder-import-strategy-label",i.textContent=this.t("folder_import_strategy");const s=document.createElement("div");s.className="gv-folder-import-strategy-options";const a=this.createRadioOption("merge",this.t("folder_import_merge"),!0),l=this.createRadioOption("overwrite",this.t("folder_import_overwrite"),!1);s.appendChild(a),s.appendChild(l),o.appendChild(i),o.appendChild(s);const d=document.createElement("div");d.className="gv-folder-import-file-input";const u=document.createElement("input");u.type="file",u.accept=".json,application/json",u.style.display="none";const m=document.createElement("button");m.className="gv-folder-import-file-button",m.textContent=this.t("folder_import_select_file"),m.addEventListener("click",()=>u.click());const p=document.createElement("div");p.className="gv-folder-import-file-name",p.textContent="",u.addEventListener("change",()=>{u.files&&u.files[0]&&(p.textContent=u.files[0].name)}),d.appendChild(u),d.appendChild(m),d.appendChild(p);const f=document.createElement("div");f.className="gv-folder-dialog-buttons";const g=document.createElement("button");g.className="gv-folder-dialog-btn gv-folder-dialog-btn-primary",g.textContent=this.t("pm_import"),g.addEventListener("click",async()=>{const w=a.querySelector("input").checked?"merge":"overwrite";await this.handleImport(u,w),e.remove()});const b=document.createElement("button");b.className="gv-folder-dialog-btn gv-folder-dialog-btn-secondary",b.textContent=this.t("pm_cancel"),b.addEventListener("click",()=>e.remove()),f.appendChild(b),f.appendChild(g),t.appendChild(r),t.appendChild(o),t.appendChild(d),t.appendChild(f),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",w=>{w.target===e&&e.remove()})}createRadioOption(e,t,r){const o=document.createElement("label");o.className="gv-folder-import-radio-option";const i=document.createElement("input");i.type="radio",i.name="import-strategy",i.value=e,i.checked=r;const s=document.createElement("span");return s.textContent=t,o.appendChild(i),o.appendChild(s),o}async handleImport(e,t){if(this.importInProgress){this.showNotification(this.t("folder_import_in_progress")||"Import already in progress","info");return}this.importInProgress=!0;try{if(!e.files||e.files.length===0){this.showNotification(this.t("folder_import_select_file"),"error");return}const r=e.files[0];if(t==="overwrite"&&!confirm(this.t("folder_import_confirm_overwrite")))return;const o=await dr.readJSONFile(r);if(!o.success){this.showNotification(this.t("folder_import_invalid_format"),"error");return}const i=dr.validatePayload(o.data);if(!i.success){this.showNotification(this.t("folder_import_invalid_format")+": "+i.error.message,"error");return}const s=await dr.importFromPayload(i.data,this.data,{strategy:t,createBackup:!0});if(!s.success){this.showNotification(this.t("folder_import_error").replace("{error}",String(s.error)),"error");return}this.data=s.data.data,this.saveData(),this.refresh();const a=s.data.stats;let l=this.t("folder_import_success").replace("{folders}",String(a.foldersImported)).replace("{conversations}",String(a.conversationsImported));if(t==="merge"&&(a.duplicatesFoldersSkipped||a.duplicatesConversationsSkipped)){const d=(a.duplicatesFoldersSkipped||0)+(a.duplicatesConversationsSkipped||0);l=this.t("folder_import_success_skipped").replace("{folders}",String(a.foldersImported)).replace("{conversations}",String(a.conversationsImported)).replace("{skipped}",String(d))}this.showNotification(l,"success"),this.debug("Import successful:",a)}catch(r){console.error("[FolderManager] Import error:",r),this.showNotification(this.t("folder_import_error").replace("{error}",String(r)),"error")}finally{this.importInProgress=!1}}hasVisibleContent(e){if(!this.filterCurrentUserOnly)return!0;const t=this.data.folderContents[e]||[];if(this.filterConversationsByCurrentUser(t).length>0)return!0;const o=this.data.folders.filter(i=>i.parentId===e);for(const i of o)if(this.hasVisibleContent(i.id))return!0;return!1}filterConversationsByCurrentUser(e){if(!this.filterCurrentUserOnly)return e;const t=this.getCurrentUserId();return e.filter(r=>{const o=this.getUserIdFromUrl(r.url);return o===null?!0:o===t})}getCurrentUserId(){try{const t=window.location.pathname.match(/^\/u\/(\d+)\//);return t?t[1]:"0"}catch{return"0"}}getUserIdFromUrl(e){try{const r=new URL(e).pathname.match(/^\/u\/(\d+)\//);return r?r[1]:null}catch{return null}}toggleFilterCurrentUser(){if(this.filterCurrentUserOnly=!this.filterCurrentUserOnly,this.debug("Filter current user only:",this.filterCurrentUserOnly),Ce.storage.sync.set({[ke.GV_FOLDER_FILTER_USER_ONLY]:this.filterCurrentUserOnly}).catch(e=>console.error("Failed to save filter user setting:",e)),this.containerElement){const e=this.containerElement.querySelector(".gv-folder-header-actions button:first-child");e&&(this.filterCurrentUserOnly?e.classList.add("gv-filter-active"):e.classList.remove("gv-filter-active"))}this.refresh()}showNotification(e,t="info"){const r=document.createElement("div");r.className=`gv-notification gv-notification-${t}`,r.textContent=e,document.body.appendChild(r),setTimeout(()=>r.classList.add("show"),10),setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>r.remove(),300)},3e3)}showImportExportMenu(e){e.stopPropagation();const t=document.createElement("div");t.className="gv-folder-menu",t.style.position="fixed",t.style.left=`${e.clientX}px`,t.style.top=`${e.clientY}px`,[{label:this.t("folder_import"),icon:"upload",action:()=>this.showImportDialog()},{label:this.t("folder_export"),icon:"download",action:()=>this.exportFolders()}].forEach(i=>{const s=document.createElement("button");s.className="gv-folder-menu-item",s.style.display="flex",s.style.alignItems="center",s.innerHTML=`<mat-icon role="img" class="mat-icon notranslate google-symbols mat-ligature-font mat-icon-no-color" aria-hidden="true" style="font-size: 18px; margin-right: 8px;">${i.icon}</mat-icon>${i.label}`,s.addEventListener("click",()=>{i.action(),t.remove()}),t.appendChild(s)}),document.body.appendChild(t);const o=i=>{t.contains(i.target)||(t.remove(),document.removeEventListener("click",o))};setTimeout(()=>document.addEventListener("click",o),0)}async handleCloudUpload(){try{this.showNotification(this.t("uploadInProgress"),"info");const e=this.data;let t=[];try{const o=await chrome.storage.local.get(["gvPromptItems"]);o.gvPromptItems&&(t=o.gvPromptItems)}catch(o){console.warn("[FolderManager] Could not get prompts for upload:",o)}this.debug(`Uploading - folders: ${e.folders?.length||0}, prompts: ${t.length}`);const r=await Ce.runtime.sendMessage({type:"gv.sync.upload",payload:{folders:e,prompts:t,platform:"gemini"}});if(r?.ok)this.showNotification(this.t("uploadSuccess"),"success");else{const o=r?.error||"Unknown error";this.showNotification(this.t("syncError").replace("{error}",o),"error")}}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error("[FolderManager] Cloud upload failed:",e),this.showNotification(this.t("syncError").replace("{error}",t),"error")}}async handleCloudSync(){try{this.showNotification(this.t("downloadInProgress"),"info");const e=await Ce.runtime.sendMessage({type:"gv.sync.download",payload:{platform:"gemini"}});if(!e?.ok){const g=e?.error||"Download failed";this.showNotification(this.t("syncError").replace("{error}",g),"error");return}if(!e.data){this.showNotification(this.t("syncNoData")||"No data in cloud","info");return}const t=e.data?.folders,r=e.data?.prompts,o=e.data?.starred,i=t?.data||{folders:[],folderContents:{}},s=r?.items||[],a=o?.data||{messages:{}};this.debug(`Downloaded - folders: ${i.folders?.length||0}, prompts: ${s.length}, starred conversations: ${Object.keys(a.messages||{}).length}`);let l=[];try{const g=await chrome.storage.local.get(["gvPromptItems"]);g.gvPromptItems&&(l=g.gvPromptItems)}catch(g){console.warn("[FolderManager] Could not get local prompts for merge:",g)}let d={messages:{}};try{const g=await chrome.storage.local.get(["geminiTimelineStarredMessages"]);g.geminiTimelineStarredMessages&&(d=g.geminiTimelineStarredMessages)}catch(g){console.warn("[FolderManager] Could not get local starred messages for merge:",g)}const u=this.data,m=this.mergeFolderData(u,i),p=this.mergePrompts(l,s),f=this.mergeStarredMessages(d,a);this.debug(`Merged - folders: ${m.folders?.length||0}, prompts: ${p.length}, starred conversations: ${Object.keys(f.messages||{}).length}`),this.data=m,await this.saveData();try{await chrome.storage.local.set({gvPromptItems:p,geminiTimelineStarredMessages:f})}catch(g){console.error("[FolderManager] Failed to save merged prompts/starred:",g)}this.refresh(),this.showNotification(this.t("downloadMergeSuccess"),"success")}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error("[FolderManager] Cloud sync failed:",e),this.showNotification(this.t("syncError").replace("{error}",t),"error")}}mergePrompts(e,t){const r=new Map;return e.forEach(o=>{o?.id&&r.set(o.id,o)}),t.forEach(o=>{if(!o?.id)return;const i=r.get(o.id);if(!i)r.set(o.id,o);else{const s=o.updatedAt||o.createdAt||0,a=i.updatedAt||i.createdAt||0;s>a&&r.set(o.id,o)}}),Array.from(r.values())}mergeStarredMessages(e,t){const r=e?.messages||{},o=t?.messages||{},i=new Set([...Object.keys(r),...Object.keys(o)]),s={};return i.forEach(a=>{const l=r[a]||[],d=o[a]||[],u=new Map;d.forEach(p=>{p?.turnId&&u.set(p.turnId,p)}),l.forEach(p=>{if(!p?.turnId)return;const f=u.get(p.turnId);f?(p.starredAt||0)>=(f.starredAt||0)&&u.set(p.turnId,p):u.set(p.turnId,p)});const m=Array.from(u.values());m.length>0&&(s[a]=m)}),{messages:s}}mergeFolderData(e,t){const r=new Map;e.folders.forEach(i=>r.set(i.id,i)),t.folders.forEach(i=>{r.has(i.id)||r.set(i.id,i)});const o={...e.folderContents};return Object.entries(t.folderContents).forEach(([i,s])=>{if(!o[i])o[i]=s;else{const a=new Set(o[i].map(l=>l.conversationId));s.forEach(l=>{a.has(l.conversationId)||o[i].push(l)})}}),{folders:Array.from(r.values()),folderContents:o}}async getCloudUploadTooltip(){try{const e=await Ce.runtime.sendMessage({type:"gv.sync.getState"});if(e?.ok&&e.state){const t=e.state.lastUploadTime,r=this.formatRelativeTime(t??null),o=this.t("folder_cloud_upload");return t?`${o}
${this.t("lastUploaded").replace("{time}",r)}`:`${o}
${this.t("neverUploaded")}`}}catch(e){console.warn("[FolderManager] Failed to get sync state for tooltip:",e)}return this.t("folder_cloud_upload")}async getCloudSyncTooltip(){try{const e=await Ce.runtime.sendMessage({type:"gv.sync.getState"});if(e?.ok&&e.state){const t=e.state.lastSyncTime,r=this.formatRelativeTime(t??null),o=this.t("folder_cloud_sync");return t?`${o}
${this.t("lastSynced").replace("{time}",r)}`:`${o}
${this.t("neverSynced")}`}}catch(e){console.warn("[FolderManager] Failed to get sync state for tooltip:",e)}return this.t("folder_cloud_sync")}formatRelativeTime(e){if(!e)return"";const r=Date.now()-e,o=Math.floor(r/6e4),i=Math.floor(r/36e5),s=Math.floor(r/864e5);return o<1?this.t("justNow"):o<60?`${o} ${this.t("minutesAgo")}`:i<24?`${i} ${this.t("hoursAgo")}`:s===1?this.t("yesterday"):new Date(e).toLocaleDateString()}}async function Vf(){try{const n=new Wf;return await n.init(),n}catch(n){return console.error("[FolderManager] Start error:",n),null}}const ns="gv-folder-spacing-style",Yf={gemini:"gvFolderSpacing",aistudio:"gvAIStudioFolderSpacing"},rs=2,Kf=0,Zf=16;function os(n){return Number.isFinite(n)?Math.min(Zf,Math.max(Kf,Math.round(n))):rs}function Xf(n,e){const t=Math.max(4,Math.round(4+n*.5));e.textContent=`
    .gv-folder-list {
      gap: ${n}px !important;
    }
    .gv-folder-content {
      gap: ${n}px !important;
    }
    .gv-folder-item-header {
      padding-top: ${t}px !important;
      padding-bottom: ${t}px !important;
    }
    .gv-folder-conversation {
      padding-top: ${t}px !important;
      padding-bottom: ${t}px !important;
    }
  `}function Jf(n,e){const t=Math.max(3,Math.round(3+n*.45));e.textContent=`
    .gv-aistudio .gv-folder-list {
      gap: ${n}px !important;
    }
    .gv-aistudio .gv-folder-content {
      gap: ${n}px !important;
    }
    .gv-aistudio .gv-folder-item-header {
      padding-top: ${t}px !important;
      padding-bottom: ${t}px !important;
    }
    .gv-aistudio .gv-folder-conversation {
      padding-top: ${t}px !important;
      padding-bottom: ${t}px !important;
    }
    .gv-aistudio .gv-folder-uncategorized-content {
      gap: ${n}px !important;
    }
  `}function vl(n,e){const t=os(n);let r=document.getElementById(ns);r||(r=document.createElement("style"),r.id=ns,document.head.appendChild(r)),e==="aistudio"?Jf(t,r):Xf(t,r)}function Qf(){const n=document.getElementById(ns);n&&n.remove()}function yl(n="gemini"){const e=Yf[n];let t=rs;chrome.storage?.sync?.get({[e]:rs},o=>{const i=o?.[e];typeof i=="number"&&(t=os(i)),vl(t,n)});const r=(o,i)=>{if(i==="sync"&&o[e]){const s=o[e].newValue;typeof s=="number"&&(t=os(s),vl(t,n))}};chrome.storage?.onChanged?.addListener(r),window.addEventListener("beforeunload",()=>{Qf();try{chrome.storage?.onChanged?.removeListener(r)}catch{}},{once:!0})}const is="gv-gems-hider-style",Ur="gv-gems-hidden",Rt="gv-gems-peek-bar",wt="gv-gems-toggle-btn",Ir="gvGemsHidden",xo=".gems-list-container",fd='[data-test-id="arrow-icon"]';let ss=!1,Lr=null;function eg(){if(document.getElementById(is))return;const n=document.createElement("style");n.id=is,n.textContent=`
    /* Container for proper positioning */
    ${xo} {
      position: relative;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Toggle button - inline next to arrow icon */
    .${wt} {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--gm3-sys-color-on-surface-variant, #5f6368);
      vertical-align: middle;
      margin-right: 4px;
    }

    .${wt}:hover {
      background: var(--gm3-sys-color-surface-container-highest, rgba(0, 0, 0, 0.12));
      transform: scale(1.1);
    }

    .${wt}:active {
      transform: scale(0.95);
    }

    .${wt} svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
    }

    /* Show button when hovering near arrow area */
    ${fd}:hover .${wt},
    .${wt}:hover {
      opacity: 1;
      transform: scale(1);
    }

    /* Hidden state - collapse with smooth animation */
    .${Ur} {
      max-height: 0 !important;
      overflow: hidden !important;
      opacity: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      pointer-events: none !important;
    }

    /* Peek bar - minimal restore hint */
    .${Rt} {
      height: 6px;
      margin: 8px 16px;
      border-radius: 3px;
      background: linear-gradient(
        90deg,
        transparent 0%,
        var(--gm3-sys-color-outline-variant, rgba(0, 0, 0, 0.08)) 20%,
        var(--gm3-sys-color-outline-variant, rgba(0, 0, 0, 0.08)) 80%,
        transparent 100%
      );
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      display: none;
    }

    .${Rt}::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 4px;
      border-radius: 2px;
      background: var(--gm3-sys-color-primary, #1a73e8);
      opacity: 0;
      transition: all 0.2s ease;
    }

    .${Rt}:hover {
      height: 12px;
      background: linear-gradient(
        90deg,
        transparent 0%,
        var(--gm3-sys-color-primary-container, rgba(26, 115, 232, 0.12)) 15%,
        var(--gm3-sys-color-primary-container, rgba(26, 115, 232, 0.12)) 85%,
        transparent 100%
      );
    }

    .${Rt}:hover::after {
      opacity: 1;
      width: 60px;
    }

    /* Tooltip for peek bar */
    .${Rt}[data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-4px);
      padding: 6px 12px;
      background: var(--gm3-sys-color-inverse-surface, #303030);
      color: var(--gm3-sys-color-inverse-on-surface, #f5f5f5);
      font-family: 'Google Sans', Roboto, sans-serif;
      font-size: 12px;
      font-weight: 500;
      border-radius: 8px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
    }

    .${Rt}:hover[data-tooltip]::before {
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }

    /* Show peek bar when gems is hidden */
    .${Rt}.gv-visible {
      display: block;
    }

    /* Dark mode adjustments */
    @media (prefers-color-scheme: dark) {
      .${wt} {
        background: rgba(255, 255, 255, 0.08);
        color: #e8eaed;
      }
      .${wt}:hover {
        background: rgba(255, 255, 255, 0.14);
      }
      .${Rt} {
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.06) 20%,
          rgba(255, 255, 255, 0.06) 80%,
          transparent 100%
        );
      }
      .${Rt}:hover {
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(138, 180, 248, 0.15) 15%,
          rgba(138, 180, 248, 0.15) 85%,
          transparent 100%
        );
      }
      .${Rt}::after {
        background: #8ab4f8;
      }
    }

    /* Explicit dark theme support */
    body[data-theme="dark"] .${wt},
    body.dark-theme .${wt} {
      background: rgba(255, 255, 255, 0.08);
      color: #e8eaed;
    }
    body[data-theme="dark"] .${wt}:hover,
    body.dark-theme .${wt}:hover {
      background: rgba(255, 255, 255, 0.14);
    }
  `,document.head.appendChild(n)}function tg(){const n=document.createElement("button");return n.className=wt,n.setAttribute("aria-label",Ke("gemsHide")||"Hide Gems"),n.title=Ke("gemsHide")||"Hide Gems",n.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-41 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z"/>
    </svg>
  `,n}function ng(){const n=document.createElement("div");return n.className=Rt,n.setAttribute("data-tooltip",Ke("gemsShow")||"Show Gems"),n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.setAttribute("aria-label",Ke("gemsShow")||"Show Gems"),n}async function rg(){return new Promise(n=>{try{chrome.storage?.local?.get({[Ir]:!1},e=>{n(e?.[Ir]===!0)})}catch{n(localStorage.getItem(Ir)==="true")}})}async function hi(n){return new Promise(e=>{try{chrome.storage?.local?.set({[Ir]:n},()=>e())}catch{localStorage.setItem(Ir,String(n)),e()}})}function lo(n,e,t){t?(n.classList.add(Ur),e.classList.add("gv-visible")):(n.classList.remove(Ur),e.classList.remove("gv-visible"))}async function mi(n){if(document.querySelector(`.${wt}`))return;const e=n.querySelector(fd);if(!e)return;const t=tg(),r=ng();e.insertBefore(t,e.firstChild),n.parentElement?.insertBefore(r,n.nextSibling);const o=await rg();lo(n,r,o),t.addEventListener("click",async i=>{i.stopPropagation(),i.preventDefault(),await hi(!0),lo(n,r,!0)}),r.addEventListener("click",async()=>{await hi(!1),lo(n,r,!1)}),r.addEventListener("keydown",async i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),await hi(!1),lo(n,r,!1))})}function og(){document.querySelectorAll(`.${wt}`).forEach(n=>{const e=Ke("gemsHide")||"Hide Gems";n.setAttribute("aria-label",e),n.title=e}),document.querySelectorAll(`.${Rt}`).forEach(n=>{const e=Ke("gemsShow")||"Show Gems";n.setAttribute("data-tooltip",e),n.setAttribute("aria-label",e)})}function wl(){if(ss)return;ss=!0,eg(),document.querySelectorAll(xo).forEach(e=>mi(e)),Lr=new MutationObserver(e=>{for(const t of e)for(const r of Array.from(t.addedNodes))r instanceof HTMLElement&&(r.matches(xo)&&mi(r),r.querySelectorAll(xo).forEach(i=>mi(i)))}),Lr.observe(document.body,{childList:!0,subtree:!0}),Ce.storage.onChanged.addListener((e,t)=>{(t==="sync"||t==="local")&&e[ke.LANGUAGE]&&og()})}function ig(){Lr&&(Lr.disconnect(),Lr=null),document.getElementById(is)?.remove(),document.querySelectorAll(`.${wt}`).forEach(n=>n.remove()),document.querySelectorAll(`.${Rt}`).forEach(n=>n.remove()),document.querySelectorAll(`.${Ur}`).forEach(n=>{n.classList.remove(Ur)}),ss=!1}function sg(){return location.hostname!=="gemini.google.com"?()=>{}:(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",wl):setTimeout(wl,500),ig)}const as="gemini-voyager-input-collapse",bt="gv-input-collapsed",on="gv-collapse-placeholder";function ag(){const n=window.location.pathname;return/^\/(?:u\/\d+\/)?app\/?$/.test(n)}function lg(){const n=window.location.pathname;return/^\/(?:u\/\d+\/)?gems\/(?:create|edit)\/?/.test(n)}function ls(){return ag()||lg()}function cg(){if(document.getElementById(as))return;const n=document.createElement("style");n.id=as,n.textContent=`
    /* Transitions for the input container */
    .element-to-collapse {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 
     * Collapsed State Styles
     */
    .${bt} {
      /* Compact dimensions */
      height: 48px !important;
      min-height: 48px !important;
      max-height: 48px !important;
      
      /* Pill shape */
      border-radius: 24px !important;
      width: auto !important;
      min-width: 200px !important;
      max-width: 600px !important;
      margin-left: auto !important;
      margin-right: auto !important;
      padding: 0 24px !important;
      
      /* Hide overflow */
      overflow: hidden !important;
      
      /* Visual styling - Clean, no borders if possible to avoid "shadow edge" issues */
      background-color: var(--gm3-sys-color-surface-container, #f0f4f9) !important;
      /* Subtle shadow */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
      border: none !important;
      
      /* Center content */
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      
      /* Ensure it's clickable */
      cursor: pointer !important;
      position: relative !important;
      z-index: 999 !important;
      
      /* Reset layout */
      gap: 0 !important;
      transform: none !important;
    }

    /* Hiding Strategy:
       Target ALL descendants that are NOT our placeholder.
       Use opacity 0 to hide.
    */
    .${bt} > *:not(.${on}) {
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      position: absolute !important;
      pointer-events: none !important;
    }

    /* Placeholder Styling - HIDDEN by default */
    .${on} {
      /* Hidden by default when not collapsed */
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    /* Show placeholder ONLY when collapsed */
    .${bt} > .${on} {
      /* Force visibility */
      visibility: visible !important;
      opacity: 1 !important;
      display: flex !important;
      position: relative !important;
      
      /* Typography - Brighter color */
      color: var(--gm3-sys-color-on-surface, #1f1f1f);
      font-family: Google Sans, Roboto, sans-serif;
      font-size: 15px; 
      font-weight: 500;
      white-space: nowrap;
      
      align-items: center;
      gap: 10px;
      pointer-events: none;
    }

    /* Dark mode adjustments */
    @media (prefers-color-scheme: dark) {
      .${bt} {
        background-color: var(--gm3-sys-color-surface-container-high, #2b2b2b) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important; 
      }
      .${bt} > .${on} {
        color: var(--gm3-sys-color-on-surface, #e8eaed);
      }
    }
    
    body[data-theme="dark"] .${bt},
    body.dark-theme .${bt} {
        background-color: #2b2b2b !important;
    }
    body[data-theme="dark"] .${bt} > .${on},
    body.dark-theme .${bt} > .${on} {
        color: #e8eaed;
    }
  `,document.head.appendChild(n)}function _r(){const n=document.querySelector("rich-textarea");if(!n)return null;let e=n.parentElement,t=null;for(let r=0;r<8&&e;r++){const o=window.getComputedStyle(e),i=o.backgroundColor!=="rgba(0, 0, 0, 0)"&&o.backgroundColor!=="transparent";if(o.display.includes("flex"),i&&(t=e),e.tagName==="MAIN"||e.tagName==="BODY"||e.classList.contains("content-wrapper"))break;e=e.parentElement}return t||n.parentElement?.parentElement||n.parentElement}function dg(){const n=_r();n&&So(n)}function ug(n){const e=n.querySelector("rich-textarea")||n.querySelector("textarea")||n.querySelector('[contenteditable="true"]');return e?n.querySelector("uploader-file-preview")||n.querySelector(".file-preview-wrapper")?!1:(e.textContent?.trim()||"").length===0:!0}function hg(n){if(n.querySelector(`.${on}`))return;const e=document.createElement("div");e.className=on;let t=Ke("inputCollapsePlaceholder")||"Message Gemini";e.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor">
        <path d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/>
      </svg>
      <span>${t}</span>
    `,n.appendChild(e)}function mg(){chrome.storage?.sync?.get({gvInputCollapseEnabled:!1},n=>{if(n?.gvInputCollapseEnabled===!1){console.log("[Gemini Voyager] Input collapse is disabled");return}xl()}),chrome.storage?.onChanged?.addListener((n,e)=>{e==="sync"&&n.gvInputCollapseEnabled&&(n.gvInputCollapseEnabled.newValue===!1?pg():xl())})}let Dr=null,cs=!1,Mr=null;function pg(){Mr&&(Mr.abort(),Mr=null);const n=document.getElementById(as);n&&n.remove(),document.querySelectorAll(`.${bt}`).forEach(e=>{e.classList.remove(bt)}),document.querySelectorAll(".element-to-collapse").forEach(e=>{e.classList.remove("element-to-collapse")}),document.querySelectorAll(".gv-processed").forEach(e=>{e.classList.remove("gv-processed")}),document.querySelectorAll(`.${on}`).forEach(e=>{e.remove()}),Dr&&(Dr.disconnect(),Dr=null),cs=!1}function xl(){if(cs)return;cs=!0,cg();let n=window.location.pathname;Mr=new AbortController;const{signal:e}=Mr;document.addEventListener("dragenter",o=>{if(o.dataTransfer?.types.includes("Files")){const i=_r();i&&i.classList.contains(bt)&&So(i)}},{signal:e,capture:!0});const t=()=>{const o=window.location.pathname;if(o===n)return;n=o;const i=_r();i&&(ls()?i.classList.remove(bt):pi(i))};window.addEventListener("popstate",t,{signal:e}),Dr=new MutationObserver(()=>{t?.();const o=_r();o&&!o.classList.contains("gv-processed")&&(o.classList.add("gv-processed"),o.classList.add("element-to-collapse"),hg(o),o.addEventListener("click",()=>{So(o)},{signal:e}),o.addEventListener("focusin",()=>{So(o)},{signal:e}),o.addEventListener("focusout",i=>{const s=i.relatedTarget;s&&o.contains(s)||pi(o)},{signal:e}),ls()||pi(o))}),Dr.observe(document.body,{childList:!0,subtree:!0}),Ce.storage.onChanged.addListener((o,i)=>{(i==="sync"||i==="local")&&o[ke.LANGUAGE]&&document.querySelectorAll(`.${on}`).forEach(s=>{const a=s.querySelector("span");a&&(a.textContent=Ke("inputCollapsePlaceholder")||"Message Gemini")})});const r=_r();r&&r.classList.remove("gv-processed")}function So(n){if(n.classList.contains(bt)){n.classList.remove(bt);const e=n.querySelector(".ql-editor")||n.querySelector("[contenteditable]")||n.querySelector("rich-textarea");e&&e instanceof HTMLElement&&e.focus()}}function pi(n){setTimeout(()=>{if(ls()){n.classList.remove(bt);return}const e=document.activeElement;!n.contains(e)&&ug(n)&&n.classList.add(bt)},150)}const Sl=hn.createChild("KaTeXConfig");function fg(){try{const n=document.createElement("script");n.src=Ce.runtime.getURL("katex-config.js"),n.type="text/javascript",(document.head||document.documentElement).appendChild(n),Sl.info("KaTeX configuration script injected successfully")}catch(n){Sl.error("Failed to configure KaTeX",{error:n})}}function gg(){fg()}const ds=xn.getInstance().createChild("MarkdownPatcher");function El(n){const e=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null),t=[];let r;for(;r=e.nextNode();){const o=r.parentElement;o&&(o.tagName==="CODE"||o.tagName==="PRE"||o.tagName==="MATH-BLOCK"||o.tagName==="MATH-INLINE"||o.classList.contains("math-block")||o.classList.contains("math-inline")||o.closest("code")||o.closest("pre")||o.closest("code-block")||o.closest(".math-block")||o.closest(".math-inline"))||r.textContent?.includes("**")&&t.push(r)}for(const o of t){if(!o.isConnected)continue;let i=o;const s=i.textContent||"",a=Array.from(s.matchAll(/\*\*([^\s].*?[^\s]|[^\s])\*\*/g));if(a.length>0){const m=document.createDocumentFragment();let p=0,f=null;if(a.forEach(g=>{const b=g.index,w=b+g[0].length,v=g[1];b>p&&m.appendChild(document.createTextNode(s.slice(p,b)));const S=document.createElement("strong");S.textContent=v,m.appendChild(S),p=w}),p<s.length&&(f=document.createTextNode(s.slice(p)),m.appendChild(f)),i.parentNode&&i.parentNode.replaceChild(m,i),f)i=f;else continue}const l=i.textContent||"",d=l.lastIndexOf("**");if(d===-1)continue;const u=i.nextSibling;if(u&&u.nodeType===Node.ELEMENT_NODE&&u.hasAttribute("data-path-to-node")){const m=u,p=u.nextSibling;if(p&&p.nodeType===Node.TEXT_NODE&&p.textContent?.includes("**")){const f=p.textContent||"",g=f.indexOf("**");if(g!==-1)try{ds.info("Found broken markdown pattern due to injected node, applying fix...");const b=document.createElement("strong");i.parentNode&&i.parentNode.insertBefore(b,u);const w=l.substring(d+2);w&&b.appendChild(document.createTextNode(w)),b.appendChild(m);const v=f.substring(0,g);v&&b.appendChild(document.createTextNode(v)),i.textContent=l.substring(0,d),p.textContent=f.substring(g+2)}catch(b){ds.error("Failed to apply markdown fix",{error:b})}}}}}function bg(){ds.info("Starting Markdown Patcher"),El(document.body);const n=new MutationObserver(e=>{const t=[];for(const r of e)r.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&t.push(o)});t.length>0&&t.forEach(r=>El(r))});return n.observe(document.body,{childList:!0,subtree:!0}),()=>n.disconnect()}let co=null,Cl=!1;const gd=async()=>{if(co)return co;if(Cl)return null;try{return co=(await Qe(()=>import("./mermaid.core-GTuBGjEb.js").then(e=>e.bA),__vite__mapDeps([2,1,3]))).default,co}catch(n){return Cl=!0,console.error("[Gemini Voyager] Failed to load Mermaid library:",n),null}},vg=async()=>{const n=await gd();if(!n)return!1;const e=document.body.classList.contains("dark-theme")||document.body.getAttribute("data-theme")==="dark"||document.documentElement.classList.contains("dark")||window.matchMedia("(prefers-color-scheme: dark)").matches;return n.initialize({startOnLoad:!1,theme:e?"dark":"default",securityLevel:"loose",fontFamily:"Google Sans, Roboto, sans-serif",logLevel:5}),!0},yg=n=>{const e=n.trim();if(e.length<50)return!1;const t=["graph","flowchart","sequenceDiagram","classDiagram","stateDiagram","erDiagram","gantt","pie","gitGraph","journey","mindmap","timeline","zenuml","quadrantChart","requirementDiagram","requirement","sankey-beta","sankey","C4Context","C4Container","C4Component","C4Dynamic","C4Deployment","xychart-beta","xychart","block-beta","block","packet-beta","packet","architecture-beta","architecture","kanban","radar-beta","treemap"];if(!(e.startsWith("%%")||t.some(a=>e.toLowerCase().startsWith(a.toLowerCase()))))return!1;const o=e.split(`
`).filter(a=>a.trim().length>0);if(o.length<3)return!1;const i=o[o.length-1].trim();return!["-->","---","-.","==>",":::","[","(","{","|","&",","].some(a=>i.endsWith(a))},wg=()=>{if(document.getElementById("gv-mermaid-styles"))return;const n=document.createElement("style");n.id="gv-mermaid-styles",n.textContent=`
    .gv-mermaid-wrapper {
      position: relative;
    }
    
    .gv-mermaid-toggle {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
      display: flex;
      align-items: center; /* Center items vertically */
      gap: 4px;
      background: var(--gemini-surface-container, rgba(0,0,0,0.05));
      border-radius: 8px;
      padding: 2px;
      border: 1px solid var(--gemini-outline-variant, rgba(0,0,0,0.1));
    }
    
    .gv-mermaid-toggle button {
      padding: 4px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Google Sans', sans-serif;
      transition: all 0.2s ease;
      background: transparent;
      color: var(--gemini-on-surface-variant, #666);
    }
    
    .gv-mermaid-toggle button:hover {
      background: var(--gemini-surface-container-high, rgba(0,0,0,0.08));
    }
    
    .gv-mermaid-toggle button.active {
      background: var(--gemini-primary, #1a73e8);
      color: white;
    }
    
    .gv-mermaid-diagram {
      padding: 16px;
      text-align: center;
      overflow-x: auto;
      min-height: 100px;
      cursor: zoom-in;
    }
    
    .gv-mermaid-diagram svg {
      max-width: 100%;
      height: auto;
    }
    
    /* Fullscreen Modal */
    .gv-mermaid-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      z-index: 999999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .gv-mermaid-modal.visible {
      opacity: 1;
    }
    
    .gv-mermaid-modal-toolbar {
      position: fixed;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      z-index: 1000000;
    }
    
    .gv-mermaid-modal-toolbar button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .gv-mermaid-modal-toolbar button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .gv-mermaid-modal-content {
      position: relative;
      cursor: grab;
      user-select: none;
    }
    
    .gv-mermaid-modal-content.dragging {
      cursor: grabbing;
    }
    
    .gv-mermaid-modal-content svg {
      max-width: none;
      max-height: none;
    }
    
    .gv-mermaid-modal-hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      font-family: 'Google Sans', sans-serif;
      pointer-events: none;
    }
  `,document.head.appendChild(n)};let fi=null,Xt=1,pr=0,fr=0,gi=!1,Tl=0,_l=0;const xg=n=>{if(fi)return;Xt=1,pr=0,fr=0;const e=document.createElement("div");e.className="gv-mermaid-modal";const t=document.createElement("div");t.className="gv-mermaid-modal-toolbar";const r=document.createElement("button");r.innerHTML="+",r.title="Zoom In";const o=document.createElement("button");o.innerHTML="âˆ’",o.title="Zoom Out";const i=document.createElement("button");i.innerHTML="âŠ™",i.title="Reset";const s=document.createElement("button");s.innerHTML="âœ•",s.title="Close (ESC)",t.appendChild(r),t.appendChild(o),t.appendChild(i),t.appendChild(s);const a=document.createElement("div");a.className="gv-mermaid-modal-content",a.innerHTML=n;const l=document.createElement("div");l.className="gv-mermaid-modal-hint",l.textContent="Scroll to zoom â€¢ Drag to pan â€¢ ESC to close",e.appendChild(t),e.appendChild(a),e.appendChild(l),document.body.appendChild(e),fi=e;const d=()=>{a.style.transform=`translate(${pr}px, ${fr}px) scale(${Xt})`},u=()=>{Xt=Math.min(Xt*1.2,10),d()},m=()=>{Xt=Math.max(Xt/1.2,.1),d()},p=()=>{Xt=1,pr=0,fr=0,d()},f=()=>{e.classList.remove("visible"),setTimeout(()=>{e.remove(),fi=null},300)};r.addEventListener("click",u),o.addEventListener("click",m),i.addEventListener("click",p),s.addEventListener("click",f),e.addEventListener("click",b=>{b.target===e&&f()});const g=b=>{b.key==="Escape"&&(f(),document.removeEventListener("keydown",g))};document.addEventListener("keydown",g),e.addEventListener("wheel",b=>{b.preventDefault(),b.deltaY<0?Xt=Math.min(Xt*1.1,10):Xt=Math.max(Xt/1.1,.1),d()},{passive:!1}),a.addEventListener("mousedown",b=>{gi=!0,Tl=b.clientX-pr,_l=b.clientY-fr,a.classList.add("dragging")}),document.addEventListener("mousemove",b=>{gi&&(pr=b.clientX-Tl,fr=b.clientY-_l,d())}),document.addEventListener("mouseup",()=>{gi=!1,a.classList.remove("dragging")}),requestAnimationFrame(()=>{e.classList.add("visible")})},Sg=n=>n.replace(/[\u00A0\u2002\u2003\u2009\u3000]/g," ").replace(/[\u200B\u200C\u200D\uFEFF]/g,""),kl=async(n,e)=>{const t=Sg(e);if(n.dataset.mermaidCode!==t&&n.dataset.mermaidProcessing!=="true"){n.dataset.mermaidProcessing="true";try{const r=n.closest("code-block");if(!r){n.dataset.mermaidProcessing="false";return}const o=await gd();if(!o){n.dataset.mermaidProcessing="false";return}const i=`mermaid-${Math.random().toString(36).substr(2,9)}`;let s,a=!1;try{const u=await o.render(i,t);s=typeof u=="string"?u:u.svg}catch(u){a=!0;const m=document.getElementById(i);m&&m.remove(),document.querySelectorAll('[id^="d"]').forEach(g=>{(g.textContent?.includes("Syntax error")||g.querySelector(".error-icon"))&&g.remove()});const p=u instanceof Error?u.message:"Unknown error";s=`
                <div style="padding: 24px; text-align: center; color: var(--gemini-on-surface-variant, #666);">
                    <div style="font-size: 32px; margin-bottom: 12px;">âš ï¸</div>
                    <div style="font-weight: 500; margin-bottom: 8px;">Mermaid Syntax Error</div>
                    <div style="font-size: 12px; opacity: 0.7; font-family: monospace; max-width: 400px; margin: 0 auto; word-break: break-word;">${p.length>100?p.substring(0,100)+"...":p}</div>
                    <div style="margin-top: 12px; font-size: 13px;">Click <b>"&lt;/&gt; Code"</b> to view source</div>
                </div>
            `}let l=r.parentElement;if(!l?.classList.contains("gv-mermaid-wrapper")){l=document.createElement("div"),l.className="gv-mermaid-wrapper",r.parentElement?.insertBefore(l,r),l.appendChild(r);const u=document.createElement("div");u.className="gv-mermaid-toggle";const m=l?.parentElement||r.parentElement,p=m?.querySelector(".buttons")||m?.querySelector(".copy-button");p&&(p.style.position="static",p.style.top="auto",p.style.right="auto",p.style.marginTop="0",u.appendChild(p));const f=document.createElement("button");f.textContent="ğŸ“Š Diagram",f.className="active",f.dataset.view="diagram";const g=document.createElement("button");g.textContent="</> Code",g.dataset.view="code",u.appendChild(f),u.appendChild(g),l.appendChild(u);const b=document.createElement("div");b.className="gv-mermaid-diagram",l.appendChild(b),r.style.display="none";const w=v=>{v==="diagram"?(r.style.display="none",b.style.display="block",f.classList.add("active"),g.classList.remove("active")):(r.style.display="",b.style.display="none",f.classList.remove("active"),g.classList.add("active"))};f.addEventListener("click",()=>w("diagram")),g.addEventListener("click",()=>w("code")),b.addEventListener("click",()=>{b.querySelector("svg")&&xg(b.innerHTML)})}const d=l.querySelector(".gv-mermaid-diagram");if(!d){n.dataset.mermaidProcessing="false";return}d.innerHTML=s,n.dataset.mermaidCode=t,n.dataset.mermaidProcessing="false",console.log("[Gemini Voyager] Mermaid diagram rendered:",i)}catch{n.dataset.mermaidProcessing="false";const o=n.closest("code-block");o&&(o.style.display="")}}},Eg=n=>{const e=n.closest(".code-block, code-block");if(!e)return null;const t=e.querySelector(".code-block-decoration");if(!t)return null;const r=t.querySelector(":scope > span");return r&&r.textContent?.trim().toLowerCase()||null},Cg=new Set(["ä»£ç æ®µ","ä»£ç ","ä»£ç å—","ç¤ºä¾‹","ç¤ºä¾‹ä»£ç ","code","code snippet","snippet","example","code example","sample","text","plain","plaintext","raw","output","result"]),Tg=n=>n?Cg.has(n.toLowerCase()):!0,Al=()=>{document.querySelectorAll('code[data-test-id="code-content"]').forEach(e=>{const t=e.textContent||"",r=Eg(e);if(r==="mermaid"){kl(e,t);return}r&&!Tg(r)||yg(t)&&kl(e,t)})};let kr=!0,Yn=null;const _g=()=>{chrome.storage?.sync?.get({gvMermaidEnabled:!0},n=>{kr=n?.gvMermaidEnabled!==!1,kr?Il():console.log("[Gemini Voyager] Mermaid rendering is disabled")}),chrome.storage?.onChanged?.addListener((n,e)=>{e==="sync"&&n.gvMermaidEnabled&&(kr=n.gvMermaidEnabled.newValue!==!1,kr?(Il(),console.log("[Gemini Voyager] Mermaid rendering enabled")):(Yn&&(Yn.disconnect(),Yn=null),console.log("[Gemini Voyager] Mermaid rendering disabled")))})},Il=async()=>{if(wg(),!await vg()){console.warn("[Gemini Voyager] Mermaid library failed to load, diagrams will show as code");return}if(Al(),!Yn){let e;const t=()=>{kr&&(clearTimeout(e),e=setTimeout(Al,1e3))};Yn=new MutationObserver(()=>{t()}),Yn.observe(document.body,{childList:!0,subtree:!0,characterData:!0})}console.log("[Gemini Voyager] Mermaid integration started")};/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */const{entries:bd,setPrototypeOf:Ll,isFrozen:kg,getPrototypeOf:Ag,getOwnPropertyDescriptor:Ig}=Object;let{freeze:Tt,seal:jt,create:us}=Object,{apply:hs,construct:ms}=typeof Reflect<"u"&&Reflect;Tt||(Tt=function(e){return e});jt||(jt=function(e){return e});hs||(hs=function(e,t){for(var r=arguments.length,o=new Array(r>2?r-2:0),i=2;i<r;i++)o[i-2]=arguments[i];return e.apply(t,o)});ms||(ms=function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];return new e(...r)});const uo=_t(Array.prototype.forEach),Lg=_t(Array.prototype.lastIndexOf),Dl=_t(Array.prototype.pop),gr=_t(Array.prototype.push),Dg=_t(Array.prototype.splice),Eo=_t(String.prototype.toLowerCase),bi=_t(String.prototype.toString),vi=_t(String.prototype.match),br=_t(String.prototype.replace),Mg=_t(String.prototype.indexOf),Ng=_t(String.prototype.trim),Jt=_t(Object.prototype.hasOwnProperty),St=_t(RegExp.prototype.test),vr=Fg(TypeError);function _t(n){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,r=new Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];return hs(n,e,r)}}function Fg(n){return function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return ms(n,t)}}function Ne(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Eo;Ll&&Ll(n,null);let r=e.length;for(;r--;){let o=e[r];if(typeof o=="string"){const i=t(o);i!==o&&(kg(e)||(e[r]=i),o=i)}n[o]=!0}return n}function Og(n){for(let e=0;e<n.length;e++)Jt(n,e)||(n[e]=null);return n}function dn(n){const e=us(null);for(const[t,r]of bd(n))Jt(n,t)&&(Array.isArray(r)?e[t]=Og(r):r&&typeof r=="object"&&r.constructor===Object?e[t]=dn(r):e[t]=r);return e}function yr(n,e){for(;n!==null;){const r=Ig(n,e);if(r){if(r.get)return _t(r.get);if(typeof r.value=="function")return _t(r.value)}n=Ag(n)}function t(){return null}return t}const Ml=Tt(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),yi=Tt(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),wi=Tt(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Rg=Tt(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),xi=Tt(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Pg=Tt(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Nl=Tt(["#text"]),Fl=Tt(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Si=Tt(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Ol=Tt(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),ho=Tt(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Bg=jt(/\{\{[\w\W]*|[\w\W]*\}\}/gm),$g=jt(/<%[\w\W]*|[\w\W]*%>/gm),qg=jt(/\$\{[\w\W]*/gm),zg=jt(/^data-[\-\w.\u00B7-\uFFFF]+$/),Ug=jt(/^aria-[\-\w]+$/),vd=jt(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Hg=jt(/^(?:\w+script|data):/i),Gg=jt(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),yd=jt(/^html$/i),jg=jt(/^[a-z][.\w]*(-[.\w]+)+$/i);var Rl=Object.freeze({__proto__:null,ARIA_ATTR:Ug,ATTR_WHITESPACE:Gg,CUSTOM_ELEMENT:jg,DATA_ATTR:zg,DOCTYPE_NAME:yd,ERB_EXPR:$g,IS_ALLOWED_URI:vd,IS_SCRIPT_OR_DATA:Hg,MUSTACHE_EXPR:Bg,TMPLIT_EXPR:qg});const wr={element:1,text:3,progressingInstruction:7,comment:8,document:9},Wg=function(){return typeof window>"u"?null:window},Vg=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let r=null;const o="data-tt-policy-suffix";t&&t.hasAttribute(o)&&(r=t.getAttribute(o));const i="dompurify"+(r?"#"+r:"");try{return e.createPolicy(i,{createHTML(s){return s},createScriptURL(s){return s}})}catch{return console.warn("TrustedTypes policy "+i+" could not be created."),null}},Pl=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function wd(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Wg();const e=xe=>wd(xe);if(e.version="3.3.0",e.removed=[],!n||!n.document||n.document.nodeType!==wr.document||!n.Element)return e.isSupported=!1,e;let{document:t}=n;const r=t,o=r.currentScript,{DocumentFragment:i,HTMLTemplateElement:s,Node:a,Element:l,NodeFilter:d,NamedNodeMap:u=n.NamedNodeMap||n.MozNamedAttrMap,HTMLFormElement:m,DOMParser:p,trustedTypes:f}=n,g=l.prototype,b=yr(g,"cloneNode"),w=yr(g,"remove"),v=yr(g,"nextSibling"),S=yr(g,"childNodes"),C=yr(g,"parentNode");if(typeof s=="function"){const xe=t.createElement("template");xe.content&&xe.content.ownerDocument&&(t=xe.content.ownerDocument)}let L,I="";const{implementation:R,createNodeIterator:F,createDocumentFragment:W,getElementsByTagName:B}=t,{importNode:ne}=r;let he=Pl();e.isSupported=typeof bd=="function"&&typeof C=="function"&&R&&R.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:D,ERB_EXPR:G,TMPLIT_EXPR:x,DATA_ATTR:Y,ARIA_ATTR:re,IS_SCRIPT_OR_DATA:Z,ATTR_WHITESPACE:pe,CUSTOM_ELEMENT:K}=Rl;let{IS_ALLOWED_URI:be}=Rl,O=null;const $=Ne({},[...Ml,...yi,...wi,...xi,...Nl]);let de=null;const ie=Ne({},[...Fl,...Si,...Ol,...ho]);let ee=Object.seal(us(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),$e=null,Ge=null;const Ee=Object.seal(us(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Le=!0,Ue=!0,Be=!1,vt=!0,et=!1,y=!0,V=!1,z=!1,A=!1,T=!1,N=!1,X=!1,te=!0,q=!1;const ae="user-content-";let me=!0,oe=!1,ge={},Oe=null;const Ae=Ne({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let mt=null;const Yt=Ne({},["audio","video","img","source","image","track"]);let nt=null;const Kt=Ne({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),He="http://www.w3.org/1998/Math/MathML",j="http://www.w3.org/2000/svg",se="http://www.w3.org/1999/xhtml";let ye=se,Se=!1,we=null;const je=Ne({},[He,j,se],bi);let Te=Ne({},["mi","mo","mn","ms","mtext"]),Re=Ne({},["annotation-xml"]);const Pe=Ne({},["title","style","font","a","script"]);let We=null;const Ye=["application/xhtml+xml","text/html"],Ze="text/html";let ze=null,Ft=null;const At=t.createElement("form"),fn=function(M){return M instanceof RegExp||M instanceof Function},Je=function(){let M=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Ft&&Ft===M)){if((!M||typeof M!="object")&&(M={}),M=dn(M),We=Ye.indexOf(M.PARSER_MEDIA_TYPE)===-1?Ze:M.PARSER_MEDIA_TYPE,ze=We==="application/xhtml+xml"?bi:Eo,O=Jt(M,"ALLOWED_TAGS")?Ne({},M.ALLOWED_TAGS,ze):$,de=Jt(M,"ALLOWED_ATTR")?Ne({},M.ALLOWED_ATTR,ze):ie,we=Jt(M,"ALLOWED_NAMESPACES")?Ne({},M.ALLOWED_NAMESPACES,bi):je,nt=Jt(M,"ADD_URI_SAFE_ATTR")?Ne(dn(Kt),M.ADD_URI_SAFE_ATTR,ze):Kt,mt=Jt(M,"ADD_DATA_URI_TAGS")?Ne(dn(Yt),M.ADD_DATA_URI_TAGS,ze):Yt,Oe=Jt(M,"FORBID_CONTENTS")?Ne({},M.FORBID_CONTENTS,ze):Ae,$e=Jt(M,"FORBID_TAGS")?Ne({},M.FORBID_TAGS,ze):dn({}),Ge=Jt(M,"FORBID_ATTR")?Ne({},M.FORBID_ATTR,ze):dn({}),ge=Jt(M,"USE_PROFILES")?M.USE_PROFILES:!1,Le=M.ALLOW_ARIA_ATTR!==!1,Ue=M.ALLOW_DATA_ATTR!==!1,Be=M.ALLOW_UNKNOWN_PROTOCOLS||!1,vt=M.ALLOW_SELF_CLOSE_IN_ATTR!==!1,et=M.SAFE_FOR_TEMPLATES||!1,y=M.SAFE_FOR_XML!==!1,V=M.WHOLE_DOCUMENT||!1,T=M.RETURN_DOM||!1,N=M.RETURN_DOM_FRAGMENT||!1,X=M.RETURN_TRUSTED_TYPE||!1,A=M.FORCE_BODY||!1,te=M.SANITIZE_DOM!==!1,q=M.SANITIZE_NAMED_PROPS||!1,me=M.KEEP_CONTENT!==!1,oe=M.IN_PLACE||!1,be=M.ALLOWED_URI_REGEXP||vd,ye=M.NAMESPACE||se,Te=M.MATHML_TEXT_INTEGRATION_POINTS||Te,Re=M.HTML_INTEGRATION_POINTS||Re,ee=M.CUSTOM_ELEMENT_HANDLING||{},M.CUSTOM_ELEMENT_HANDLING&&fn(M.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(ee.tagNameCheck=M.CUSTOM_ELEMENT_HANDLING.tagNameCheck),M.CUSTOM_ELEMENT_HANDLING&&fn(M.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(ee.attributeNameCheck=M.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),M.CUSTOM_ELEMENT_HANDLING&&typeof M.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(ee.allowCustomizedBuiltInElements=M.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),et&&(Ue=!1),N&&(T=!0),ge&&(O=Ne({},Nl),de=[],ge.html===!0&&(Ne(O,Ml),Ne(de,Fl)),ge.svg===!0&&(Ne(O,yi),Ne(de,Si),Ne(de,ho)),ge.svgFilters===!0&&(Ne(O,wi),Ne(de,Si),Ne(de,ho)),ge.mathMl===!0&&(Ne(O,xi),Ne(de,Ol),Ne(de,ho))),M.ADD_TAGS&&(typeof M.ADD_TAGS=="function"?Ee.tagCheck=M.ADD_TAGS:(O===$&&(O=dn(O)),Ne(O,M.ADD_TAGS,ze))),M.ADD_ATTR&&(typeof M.ADD_ATTR=="function"?Ee.attributeCheck=M.ADD_ATTR:(de===ie&&(de=dn(de)),Ne(de,M.ADD_ATTR,ze))),M.ADD_URI_SAFE_ATTR&&Ne(nt,M.ADD_URI_SAFE_ATTR,ze),M.FORBID_CONTENTS&&(Oe===Ae&&(Oe=dn(Oe)),Ne(Oe,M.FORBID_CONTENTS,ze)),me&&(O["#text"]=!0),V&&Ne(O,["html","head","body"]),O.table&&(Ne(O,["tbody"]),delete $e.tbody),M.TRUSTED_TYPES_POLICY){if(typeof M.TRUSTED_TYPES_POLICY.createHTML!="function")throw vr('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof M.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw vr('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');L=M.TRUSTED_TYPES_POLICY,I=L.createHTML("")}else L===void 0&&(L=Vg(f,o)),L!==null&&typeof I=="string"&&(I=L.createHTML(""));Tt&&Tt(M),Ft=M}},rt=Ne({},[...yi,...wi,...Rg]),gn=Ne({},[...xi,...Pg]),On=function(M){let ce=C(M);(!ce||!ce.tagName)&&(ce={namespaceURI:ye,tagName:"template"});const ve=Eo(M.tagName),Xe=Eo(ce.tagName);return we[M.namespaceURI]?M.namespaceURI===j?ce.namespaceURI===se?ve==="svg":ce.namespaceURI===He?ve==="svg"&&(Xe==="annotation-xml"||Te[Xe]):!!rt[ve]:M.namespaceURI===He?ce.namespaceURI===se?ve==="math":ce.namespaceURI===j?ve==="math"&&Re[Xe]:!!gn[ve]:M.namespaceURI===se?ce.namespaceURI===j&&!Re[Xe]||ce.namespaceURI===He&&!Te[Xe]?!1:!gn[ve]&&(Pe[ve]||!rt[ve]):!!(We==="application/xhtml+xml"&&we[M.namespaceURI]):!1},It=function(M){gr(e.removed,{element:M});try{C(M).removeChild(M)}catch{w(M)}},qt=function(M,ce){try{gr(e.removed,{attribute:ce.getAttributeNode(M),from:ce})}catch{gr(e.removed,{attribute:null,from:ce})}if(ce.removeAttribute(M),M==="is")if(T||N)try{It(ce)}catch{}else try{ce.setAttribute(M,"")}catch{}},Zr=function(M){let ce=null,ve=null;if(A)M="<remove></remove>"+M;else{const ot=vi(M,/^[\r\n\t ]+/);ve=ot&&ot[0]}We==="application/xhtml+xml"&&ye===se&&(M='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+M+"</body></html>");const Xe=L?L.createHTML(M):M;if(ye===se)try{ce=new p().parseFromString(Xe,We)}catch{}if(!ce||!ce.documentElement){ce=R.createDocument(ye,"template",null);try{ce.documentElement.innerHTML=Se?I:Xe}catch{}}const yt=ce.body||ce.documentElement;return M&&ve&&yt.insertBefore(t.createTextNode(ve),yt.childNodes[0]||null),ye===se?B.call(ce,V?"html":"body")[0]:V?ce.documentElement:yt},or=function(M){return F.call(M.ownerDocument||M,M,d.SHOW_ELEMENT|d.SHOW_COMMENT|d.SHOW_TEXT|d.SHOW_PROCESSING_INSTRUCTION|d.SHOW_CDATA_SECTION,null)},ir=function(M){return M instanceof m&&(typeof M.nodeName!="string"||typeof M.textContent!="string"||typeof M.removeChild!="function"||!(M.attributes instanceof u)||typeof M.removeAttribute!="function"||typeof M.setAttribute!="function"||typeof M.namespaceURI!="string"||typeof M.insertBefore!="function"||typeof M.hasChildNodes!="function")},Xr=function(M){return typeof a=="function"&&M instanceof a};function Lt(xe,M,ce){uo(xe,ve=>{ve.call(e,M,ce,Ft)})}const sr=function(M){let ce=null;if(Lt(he.beforeSanitizeElements,M,null),ir(M))return It(M),!0;const ve=ze(M.nodeName);if(Lt(he.uponSanitizeElement,M,{tagName:ve,allowedTags:O}),y&&M.hasChildNodes()&&!Xr(M.firstElementChild)&&St(/<[/\w!]/g,M.innerHTML)&&St(/<[/\w!]/g,M.textContent)||M.nodeType===wr.progressingInstruction||y&&M.nodeType===wr.comment&&St(/<[/\w]/g,M.data))return It(M),!0;if(!(Ee.tagCheck instanceof Function&&Ee.tagCheck(ve))&&(!O[ve]||$e[ve])){if(!$e[ve]&&tn(ve)&&(ee.tagNameCheck instanceof RegExp&&St(ee.tagNameCheck,ve)||ee.tagNameCheck instanceof Function&&ee.tagNameCheck(ve)))return!1;if(me&&!Oe[ve]){const Xe=C(M)||M.parentNode,yt=S(M)||M.childNodes;if(yt&&Xe){const ot=yt.length;for(let Dt=ot-1;Dt>=0;--Dt){const cn=b(yt[Dt],!0);cn.__removalCount=(M.__removalCount||0)+1,Xe.insertBefore(cn,v(M))}}}return It(M),!0}return M instanceof l&&!On(M)||(ve==="noscript"||ve==="noembed"||ve==="noframes")&&St(/<\/no(script|embed|frames)/i,M.innerHTML)?(It(M),!0):(et&&M.nodeType===wr.text&&(ce=M.textContent,uo([D,G,x],Xe=>{ce=br(ce,Xe," ")}),M.textContent!==ce&&(gr(e.removed,{element:M.cloneNode()}),M.textContent=ce)),Lt(he.afterSanitizeElements,M,null),!1)},ar=function(M,ce,ve){if(te&&(ce==="id"||ce==="name")&&(ve in t||ve in At))return!1;if(!(Ue&&!Ge[ce]&&St(Y,ce))){if(!(Le&&St(re,ce))){if(!(Ee.attributeCheck instanceof Function&&Ee.attributeCheck(ce,M))){if(!de[ce]||Ge[ce]){if(!(tn(M)&&(ee.tagNameCheck instanceof RegExp&&St(ee.tagNameCheck,M)||ee.tagNameCheck instanceof Function&&ee.tagNameCheck(M))&&(ee.attributeNameCheck instanceof RegExp&&St(ee.attributeNameCheck,ce)||ee.attributeNameCheck instanceof Function&&ee.attributeNameCheck(ce,M))||ce==="is"&&ee.allowCustomizedBuiltInElements&&(ee.tagNameCheck instanceof RegExp&&St(ee.tagNameCheck,ve)||ee.tagNameCheck instanceof Function&&ee.tagNameCheck(ve))))return!1}else if(!nt[ce]){if(!St(be,br(ve,pe,""))){if(!((ce==="src"||ce==="xlink:href"||ce==="href")&&M!=="script"&&Mg(ve,"data:")===0&&mt[M])){if(!(Be&&!St(Z,br(ve,pe,"")))){if(ve)return!1}}}}}}}return!0},tn=function(M){return M!=="annotation-xml"&&vi(M,K)},lr=function(M){Lt(he.beforeSanitizeAttributes,M,null);const{attributes:ce}=M;if(!ce||ir(M))return;const ve={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:de,forceKeepAttr:void 0};let Xe=ce.length;for(;Xe--;){const yt=ce[Xe],{name:ot,namespaceURI:Dt,value:cn}=yt,Rn=ze(ot),Ko=cn;let gt=ot==="value"?Ko:Ng(Ko);if(ve.attrName=Rn,ve.attrValue=gt,ve.keepAttr=!0,ve.forceKeepAttr=void 0,Lt(he.uponSanitizeAttribute,M,ve),gt=ve.attrValue,q&&(Rn==="id"||Rn==="name")&&(qt(ot,M),gt=ae+gt),y&&St(/((--!?|])>)|<\/(style|title|textarea)/i,gt)){qt(ot,M);continue}if(Rn==="attributename"&&vi(gt,"href")){qt(ot,M);continue}if(ve.forceKeepAttr)continue;if(!ve.keepAttr){qt(ot,M);continue}if(!vt&&St(/\/>/i,gt)){qt(ot,M);continue}et&&uo([D,G,x],ra=>{gt=br(gt,ra," ")});const na=ze(M.nodeName);if(!ar(na,Rn,gt)){qt(ot,M);continue}if(L&&typeof f=="object"&&typeof f.getAttributeType=="function"&&!Dt)switch(f.getAttributeType(na,Rn)){case"TrustedHTML":{gt=L.createHTML(gt);break}case"TrustedScriptURL":{gt=L.createScriptURL(gt);break}}if(gt!==Ko)try{Dt?M.setAttributeNS(Dt,ot,gt):M.setAttribute(ot,gt),ir(M)?It(M):Dl(e.removed)}catch{qt(ot,M)}}Lt(he.afterSanitizeAttributes,M,null)},Pd=function xe(M){let ce=null;const ve=or(M);for(Lt(he.beforeSanitizeShadowDOM,M,null);ce=ve.nextNode();)Lt(he.uponSanitizeShadowNode,ce,null),sr(ce),lr(ce),ce.content instanceof i&&xe(ce.content);Lt(he.afterSanitizeShadowDOM,M,null)};return e.sanitize=function(xe){let M=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},ce=null,ve=null,Xe=null,yt=null;if(Se=!xe,Se&&(xe="<!-->"),typeof xe!="string"&&!Xr(xe))if(typeof xe.toString=="function"){if(xe=xe.toString(),typeof xe!="string")throw vr("dirty is not a string, aborting")}else throw vr("toString is not a function");if(!e.isSupported)return xe;if(z||Je(M),e.removed=[],typeof xe=="string"&&(oe=!1),oe){if(xe.nodeName){const cn=ze(xe.nodeName);if(!O[cn]||$e[cn])throw vr("root node is forbidden and cannot be sanitized in-place")}}else if(xe instanceof a)ce=Zr("<!---->"),ve=ce.ownerDocument.importNode(xe,!0),ve.nodeType===wr.element&&ve.nodeName==="BODY"||ve.nodeName==="HTML"?ce=ve:ce.appendChild(ve);else{if(!T&&!et&&!V&&xe.indexOf("<")===-1)return L&&X?L.createHTML(xe):xe;if(ce=Zr(xe),!ce)return T?null:X?I:""}ce&&A&&It(ce.firstChild);const ot=or(oe?xe:ce);for(;Xe=ot.nextNode();)sr(Xe),lr(Xe),Xe.content instanceof i&&Pd(Xe.content);if(oe)return xe;if(T){if(N)for(yt=W.call(ce.ownerDocument);ce.firstChild;)yt.appendChild(ce.firstChild);else yt=ce;return(de.shadowroot||de.shadowrootmode)&&(yt=ne.call(r,yt,!0)),yt}let Dt=V?ce.outerHTML:ce.innerHTML;return V&&O["!doctype"]&&ce.ownerDocument&&ce.ownerDocument.doctype&&ce.ownerDocument.doctype.name&&St(yd,ce.ownerDocument.doctype.name)&&(Dt="<!DOCTYPE "+ce.ownerDocument.doctype.name+`>
`+Dt),et&&uo([D,G,x],cn=>{Dt=br(Dt,cn," ")}),L&&X?L.createHTML(Dt):Dt},e.setConfig=function(){let xe=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Je(xe),z=!0},e.clearConfig=function(){Ft=null,z=!1},e.isValidAttribute=function(xe,M,ce){Ft||Je({});const ve=ze(xe),Xe=ze(M);return ar(ve,Xe,ce)},e.addHook=function(xe,M){typeof M=="function"&&gr(he[xe],M)},e.removeHook=function(xe,M){if(M!==void 0){const ce=Lg(he[xe],M);return ce===-1?void 0:Dg(he[xe],ce,1)[0]}return Dl(he[xe])},e.removeHooks=function(xe){he[xe]=[]},e.removeAllHooks=function(){he=Pl()},e}var Bl=wd();async function Yg(n,e,t={}){const r=hn.createChild("StorageMigration"),o={success:!0,migratedKeys:[],skippedKeys:[],errors:[]},{deleteAfterMigration:i=!1,skipExisting:s=!0}=t;for(const a of n)try{if(s&&(await e.get(a)).success){r.info(`Skipping key "${a}" - already exists in target storage`),o.skippedKeys.push(a);continue}const l=localStorage.getItem(a);if(l===null){r.info(`Skipping key "${a}" - not found in localStorage`),o.skippedKeys.push(a);continue}let d;try{d=JSON.parse(l)}catch(m){r.error(`Failed to parse localStorage value for key "${a}"`,{parseError:m}),o.errors.push({key:a,error:"Failed to parse JSON"}),o.success=!1;continue}const u=await e.set(a,d);if(!u.success){r.error(`Failed to write to target storage for key "${a}"`,{error:u.error}),o.errors.push({key:a,error:u.error?.message||"Failed to write to target storage"}),o.success=!1;continue}if(r.info(`Successfully migrated key "${a}"`),o.migratedKeys.push(a),i)try{localStorage.removeItem(a),r.info(`Deleted key "${a}" from localStorage`)}catch(m){r.warn(`Failed to delete key "${a}" from localStorage`,{deleteError:m})}}catch(l){r.error(`Unexpected error migrating key "${a}"`,{error:l}),o.errors.push({key:a,error:l instanceof Error?l.message:"Unexpected error"}),o.success=!1}return r.info("Migration completed",{migratedCount:o.migratedKeys.length,skippedCount:o.skippedKeys.length,errorCount:o.errors.length}),o}const pt={items:ke.PROMPT_ITEMS,locked:ke.PROMPT_PANEL_LOCKED,position:ke.PROMPT_PANEL_POSITION,triggerPos:ke.PROMPT_TRIGGER_POSITION,language:ke.LANGUAGE},xr={trigger:"gv-pm-trigger",panel:"gv-pm-panel"},Ei="gvLatestVersionCache",Kg=1e3*60*60*6;function $l(n){try{return Ce.runtime.getURL(n)}catch{return window.chrome?.runtime?.getURL?.(n)||n}}function Zg(n,e){try{return JSON.parse(n)}catch{return e}}function Xg(){return{t:n=>Ke(n),set:async n=>{try{if(!Ce.runtime?.id)return;jd(n),await Ce.storage.sync.set({language:n});return}catch(e){try{await Ce.storage.local.set({language:n});return}catch(t){if(Ct(e)||Ct(t))return;console.warn("[PromptManager] Failed to set language:",e,t)}}},get:async()=>await Gd()}}function ql(){const n=`${Date.now()}-${Math.random().toString(36).slice(2)}`;let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return(e>>>0).toString(36)}const rn=hn.createChild("PromptManager"),zl=n=>{if(!n)return null;const e=n.trim();return e?e.replace(/^v/i,""):null},Ul=n=>{if(!n)return null;const e=n.trim();return e?e.startsWith("v")?e:`v${e}`:null};async function Un(n,e){const t=await js.get(n);return t.success?t.data:(rn.debug(`Key not found: ${n}, using fallback`),e)}async function vn(n,e){const t=await js.set(n,e);t.success||rn.error(`Failed to write key: ${n}`,{error:t.error?.message||"Unknown error",errorDetails:t.error})}async function Jg(){try{if(!Ce.runtime?.id)return null;const n=Date.now(),t=(await Ce.storage.local.get(Ei))?.[Ei];if(t&&t.version&&t.fetchedAt&&n-t.fetchedAt<Kg)return t.version;const r=await fetch("https://api.github.com/repos/Nagi-ovo/gemini-voyager/releases/latest",{headers:{Accept:"application/vnd.github+json"}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const o=await r.json(),i=typeof o.tag_name=="string"?o.tag_name:typeof o.name=="string"?o.name:null;if(i)return await Ce.storage.local.set({[Ei]:{version:i,fetchedAt:n}}),i}catch(n){rn.debug("Latest version check failed",{error:n})}return null}function De(n,e){const t=document.createElement(n);return e&&(t.className=e),t}function Qg(n){const e=document.createElement("template");return e.innerHTML=n.trim(),e.content.firstElementChild}function mo(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ci(n){const e=new Set,t=[];for(const r of n){const o=r.trim().toLowerCase();o&&(e.has(o)||(e.add(o),t.push(o)))}return t}function eb(n){const e=new Set;for(const t of n)for(const r of t.tags||[])e.add(String(r).toLowerCase());return Array.from(e).sort()}function tb(n){try{return navigator.clipboard.writeText(n)}catch{return new Promise(e=>{const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}t.remove(),e()})}}function Hl(n,e){const t=n.getBoundingClientRect(),r=window.innerWidth,o=8,i=Math.min(380,Math.max(300,e.getBoundingClientRect().width||320)),s=Math.min(r-i-o,Math.max(o,t.left+t.width-i));return{top:Math.max(o,t.top-(e.getBoundingClientRect().height||360)-10),left:Math.round(s)}}async function Ti(){let n;try{let e=function(){try{const j=Array.from(document.querySelectorAll("span.mat-mdc-button-touch-target"));if(!j.length)return;const se=window.innerWidth,ye=window.innerHeight,Se=j.map(Ye=>({el:Ye,r:Ye.getBoundingClientRect()})).filter(Ye=>Ye.r.width>0&&Ye.r.height>0).sort((Ye,Ze)=>Ye.r.bottom+Ye.r.right-(Ze.r.bottom+Ze.r.right)).reduce((Ye,Ze)=>Ze,void 0);if(!Se)return;const we=Se.r,je=v.getBoundingClientRect().width||36,Te=v.getBoundingClientRect().height||36,Pe=Math.max(6,Math.round(se-we.left+10)),We=Math.max(6,Math.round(ye-(we.top+we.height/2+Te/2)));v.style.right=`${Pe}px`,v.style.bottom=`${We}px`}catch{}},t=function(){try{const j=window.innerWidth,se=window.innerHeight,ye=v.getBoundingClientRect(),Se=ye.width||44,we=ye.height||44,je=6,Te=parseFloat(v.style.right||"18")||18,Re=parseFloat(v.style.bottom||"18")||18,Pe=j-Se-je,We=se-we-je,Ye=Math.max(je,Math.min(Te,Pe)),Ze=Math.max(je,Math.min(Re,We));v.style.right=`${Math.round(Ye)}px`,v.style.bottom=`${Math.round(Ze)}px`}catch{}},r=function(j,se="ok"){V.textContent=j||"",V.classList.toggle("ok",se==="ok"),V.classList.toggle("err",se==="err"),j&&window.setTimeout(()=>{V.textContent===j&&(V.textContent="")},1800)},o=function(j,se="err"){const ye=y.querySelector(".gv-pm-inline-hint");ye&&(ye.textContent=j||"",ye.classList.toggle("ok",se==="ok"),ye.classList.toggle("err",se==="err"))},i=function(){const j=eb(z);be.innerHTML="";const se=De("button","gv-pm-tag");se.textContent=w.t("pm_all_tags")||"All",se.classList.toggle("active",T.size===0),se.addEventListener("click",()=>{T=new Set,i(),s()}),be.appendChild(se);for(const ye of j){const Se=De("button","gv-pm-tag");Se.textContent=ye,Se.classList.toggle("active",T.has(ye)),Se.addEventListener("click",()=>{T.has(ye)?T.delete(ye):T.add(ye),i(),s()}),be.appendChild(Se)}},s=function(){const j=(K.value||"").trim().toLowerCase(),se=Array.from(T),ye=z.filter(we=>se.length===0||se.every(Te=>we.tags.includes(Te))?j?we.text.toLowerCase().includes(j)||we.tags.some(Te=>Te.includes(j)):!0:!1);if(O.innerHTML="",ye.length===0){const we=De("div","gv-pm-empty");we.textContent=w.t("pm_empty")||"No prompts yet",O.appendChild(we);return}const Se=document.createDocumentFragment();for(const we of ye){const je=De("div","gv-pm-item"),Te=De("div","gv-pm-item-text-container"),Re=De("button","gv-pm-item-text"),Pe=document.createElement("div");Pe.className="gv-md";const We=ge.has(we.id);We||Pe.classList.add("gv-md-collapsed"),Re.appendChild(Pe),requestAnimationFrame(()=>{try{const Je=n.parse(we.text);typeof Je=="string"?Pe.innerHTML=Bl.sanitize(Je):Je.then(rt=>{Pe.innerHTML=Bl.sanitize(rt)}).catch(()=>{Pe.textContent=we.text})}catch{Pe.textContent=we.text}}),Re.title=w.t("pm_copy")||"Copy",Re.addEventListener("click",async Je=>{Je.target.closest(".gv-pm-expand-btn")||(await tb(we.text),r(w.t("pm_copied")||"Copied","ok"))});const Ye=De("button","gv-pm-expand-btn");Ye.innerHTML=We?"â–²":"â–¼",Ye.title=We?w.t("pm_collapse")||"Collapse":w.t("pm_expand")||"Expand",Ye.addEventListener("click",Je=>{Je.stopPropagation(),ge.has(we.id)?ge.delete(we.id):ge.add(we.id),s()}),Te.appendChild(Re),Te.appendChild(Ye);const Ze=De("button","gv-pm-edit");Ze.setAttribute("aria-label",w.t("pm_edit")||"Edit"),Ze.addEventListener("click",async Je=>{Je.stopPropagation(),y.querySelector(".gv-pm-input-text").value=we.text,y.querySelector(".gv-pm-input-tags").value=(we.tags||[]).join(", "),y.classList.remove("gv-hidden"),y.querySelector(".gv-pm-input-text").focus(),oe=we.id});const ze=De("div","gv-pm-bottom"),Ft=De("div","gv-pm-item-meta");for(const Je of we.tags){const rt=De("span","gv-pm-chip");rt.textContent=Je,rt.addEventListener("click",()=>{T.has(Je)?T.delete(Je):T.add(Je),i(),s()}),Ft.appendChild(rt)}const At=De("div","gv-pm-actions"),fn=De("button","gv-pm-del");fn.title=w.t("pm_delete")||"Delete",fn.addEventListener("click",async Je=>{if(Je.stopPropagation(),document.body.querySelector(".gv-pm-confirm"))return;const rt=document.createElement("div");rt.className="gv-pm-confirm";const gn=document.createElement("span");gn.textContent=w.t("pm_delete_confirm")||"Delete this prompt?";const On=document.createElement("button");On.className="gv-pm-confirm-yes",On.textContent=w.t("pm_delete")||"Delete";const It=document.createElement("button");It.textContent=w.t("pm_cancel")||"Cancel",rt.appendChild(gn),rt.appendChild(On),rt.appendChild(It),document.body.appendChild(rt);const qt=fn.getBoundingClientRect(),Zr=window.innerWidth,or=qt.right+220>Zr?"left":"right",ir=Math.max(8,qt.top+window.scrollY-6),Xr=or==="right"?qt.right+window.scrollX+10:qt.left+window.scrollX-rt.offsetWidth-10;rt.style.top=`${Math.round(ir)}px`,rt.style.left=`${Math.round(Math.max(8,Xr))}px`,rt.setAttribute("data-side",or);const Lt=()=>{try{rt.remove()}catch{}window.removeEventListener("keydown",ar),window.removeEventListener("click",sr,!0)},sr=tn=>{tn.target.closest(".gv-pm-confirm")||Lt()},ar=tn=>{tn.key==="Escape"&&Lt()};window.addEventListener("click",sr,!0),window.addEventListener("keydown",ar,{passive:!0}),It.addEventListener("click",tn=>{tn.stopPropagation(),Lt()}),On.addEventListener("click",async tn=>{tn.stopPropagation(),z=z.filter(lr=>lr.id!==we.id),await vn(pt.items,z),Lt(),i(),s(),r(w.t("pm_deleted")||"Deleted","ok")})}),je.appendChild(Te),At.appendChild(Ze),At.appendChild(fn),ze.appendChild(Ft),ze.appendChild(At),je.appendChild(ze),Se.appendChild(je)}O.appendChild(Se)},a=function(){if(A=!0,C.classList.remove("gv-hidden"),N&&X)C.style.left=`${Math.round(X.left)}px`,C.style.top=`${Math.round(X.top)}px`;else{const j=Hl(v,C);C.style.left=`${j.left}px`,C.style.top=`${j.top}px`}},l=function(){A=!1,C.classList.add("gv-hidden")},d=function(){re.classList.toggle("active",N),re.setAttribute("aria-pressed",N?"true":"false"),re.setAttribute("data-icon",N?"ğŸ”’":"ğŸ”“"),re.title=N?w.t("pm_unlock")||"Unlock":w.t("pm_lock")||"Lock",C.classList.toggle("gv-locked",N)},u=function(){W.textContent="Gemini Voyager",Z.textContent=w.t("pm_add"),K.placeholder=w.t("pm_search_placeholder"),Ee.textContent=w.t("pm_import"),Le.textContent=w.t("pm_export"),ie.textContent="ğŸ’¾ "+w.t("pm_backup"),ie.title=w.t("pm_backup_tooltip"),ee.textContent="ğŸŒ "+w.t("officialDocs"),w.get().then(se=>{ee.href=se==="zh"?"https://voyager.nagi.fun/guide/sponsor":`https://voyager.nagi.fun/${se}/guide/sponsor`}),Ue.textContent=w.t("pm_settings"),Ue.title=w.t("pm_settings_tooltip"),Be.title=w.t("starProject");const j=Be.querySelector(".gv-pm-gh-text");j&&(j.textContent=w.t("starProject")),y.querySelector(".gv-pm-input-text").placeholder=w.t("pm_prompt_placeholder"),y.querySelector(".gv-pm-input-tags").placeholder=w.t("pm_tags_placeholder"),y.querySelector(".gv-pm-save").textContent=w.t("pm_save"),y.querySelector(".gv-pm-cancel").textContent=w.t("pm_cancel"),d(),i(),s()},m=function(){if(!A||N)return;const j=Hl(v,C);C.style.left=`${j.left}px`,C.style.top=`${j.top}px`},p=function(j){if(N)return;te=!0;const se=C.getBoundingClientRect();ae={x:j.clientX-se.left,y:j.clientY-se.top},q={x:j.clientX,y:j.clientY};try{C.setPointerCapture?.(j.pointerId)}catch{}},f=function(j){if(te){const se=j.clientX-ae.x,ye=j.clientY-ae.y;C.style.left=`${Math.round(se)}px`,C.style.top=`${Math.round(ye)}px`}else if(me){const se=window.innerWidth,ye=window.innerHeight,Se=v.getBoundingClientRect(),we=Se.width||36,je=Se.height||36,Te=Math.max(6,Math.min(se-6-we,se-j.clientX-we/2)),Re=Math.max(6,Math.min(ye-6-je,ye-j.clientY-je/2));v.style.right=`${Math.round(Te)}px`,v.style.bottom=`${Math.round(Re)}px`}};try{if((await Ce.storage.sync.get({gvHidePromptManager:!1}))?.gvHidePromptManager===!0)return rn.info("Prompt Manager is hidden by user settings"),{destroy:()=>{}}}catch(j){rn.warn("Failed to check hide prompt manager setting, continuing with default behavior",{error:j})}const g=console.warn;console.warn=function(...j){const se=j[0];if(!(typeof se=="string"&&(se.includes("KaTeX doesn't work in quirks mode")||se.includes("unicodeTextInMathMode")||se.includes("LaTeX-incompatible input and strict mode"))))return g.apply(console,j)};try{const j=[pt.items,pt.locked,pt.position,pt.triggerPos],se=await Yg(j,js,{deleteAfterMigration:!1,skipExisting:!0});se.migratedKeys.length>0&&rn.info("Migrated prompt data from localStorage to chrome.storage.local",{migratedKeys:se.migratedKeys}),se.errors.length>0&&rn.warn("Some keys failed to migrate",{errors:se.errors})}catch(j){rn.error("Migration failed, continuing with current storage",{migrationError:j})}n=(await Qe(async()=>{const{marked:j}=await import("./marked.esm-DKsjQqph.js");return{marked:j}},[])).marked;const{default:b}=await Qe(async()=>{const{default:j}=await import("./index-Blnr25Sc.js");return{default:j}},__vite__mapDeps([4,5]));try{n.use(b({throwOnError:!1,output:"html",trust:!0,strict:!1})),n.setOptions({breaks:!0})}catch{}await jr();const w=Xg();if(document.getElementById(xr.trigger))return{destroy:()=>{}};const v=De("button","gv-pm-trigger");v.id=xr.trigger,v.setAttribute("aria-label","Prompt Manager");const S=document.createElement("img");S.width=24,S.height=24,S.alt="pm",S.src=$l("icon-32.png"),S.addEventListener("error",()=>{const j=$l("icon-32.png");S.src!==j&&(S.src=j)},{once:!0}),v.appendChild(S),document.body.appendChild(v);try{const j=await Un(pt.triggerPos,null);j&&Number.isFinite(j.bottom)&&Number.isFinite(j.right)?(v.style.bottom=`${Math.max(6,Math.round(j.bottom))}px`,v.style.right=`${Math.max(6,Math.round(j.right))}px`,requestAnimationFrame(t)):(e(),requestAnimationFrame(e),window.setTimeout(e,350))}catch{e()}const C=De("div","gv-pm-panel gv-hidden");C.id=xr.panel,C.setAttribute("role","dialog"),C.setAttribute("aria-modal","false"),document.body.appendChild(C);const L=De("div","gv-pm-header"),I=De("div","gv-pm-drag"),R=De("div","gv-pm-title-row"),F=De("div","gv-pm-title"),W=document.createElement("span");W.textContent="Gemini Voyager",F.appendChild(W);const B=chrome?.runtime?.getManifest?.()?.version,ne=zl(B),he=Ul(B),D=B?`https://github.com/Nagi-ovo/gemini-voyager/releases/tag/${he??`v${B}`}`:"https://github.com/Nagi-ovo/gemini-voyager/releases",G=document.createElement("a");G.className="gv-pm-version",G.href=D,G.target="_blank",G.rel="noreferrer",G.title=B?`${w.t("extensionVersion")} ${B}`:w.t("extensionVersion"),G.textContent=B??"...",R.appendChild(F),R.appendChild(G),(async()=>{const j=await Jg(),se=zl(j);if(!(ne&&se?Zd(se,ne)>0:!1)||!se)return;const Se=Ul(j),we=Se?`https://github.com/Nagi-ovo/gemini-voyager/releases/tag/${Se}`:"https://github.com/Nagi-ovo/gemini-voyager/releases/latest";G.classList.add("gv-pm-version-outdated"),G.href=we,G.title=`${w.t("latestVersionLabel")}: v${se}`})();const x=De("div","gv-pm-controls"),Y=De("select","gv-pm-lang");for(const j of zd){const se=De("option");se.value=j,se.textContent=Ud[j],Y.appendChild(se)}w.get().then(j=>{Y.value=j}).catch(()=>{Y.value="en"});const re=De("button","gv-pm-lock");re.setAttribute("aria-pressed","false"),re.setAttribute("data-icon","ğŸ”“"),re.title=w.t("pm_lock");const Z=De("button","gv-pm-add");Z.textContent=w.t("pm_add"),x.appendChild(Y),x.appendChild(Z),x.appendChild(re),L.appendChild(I),L.appendChild(R),L.appendChild(x);const pe=De("div","gv-pm-search"),K=De("input");K.type="search",K.placeholder=w.t("pm_search_placeholder"),pe.appendChild(K);const be=De("div","gv-pm-tags"),O=De("div","gv-pm-list"),$=De("div","gv-pm-footer"),de=De("input");de.type="file",de.accept=".json,application/json",de.className="gv-pm-import-input";const ie=De("button","gv-pm-backup-btn");ie.textContent="ğŸ’¾ "+w.t("pm_backup"),ie.title=w.t("pm_backup_tooltip");const ee=De("a","gv-pm-website-btn");ee.target="_blank",ee.rel="noreferrer";const $e=De("div","gv-pm-footer-actions");$e.appendChild(ie),$e.appendChild(ee);const Ge=De("div","gv-pm-footer-secondary"),Ee=De("button","gv-pm-import-btn");Ee.textContent=w.t("pm_import");const Le=De("button","gv-pm-export-btn");Le.textContent=w.t("pm_export");const Ue=De("button","gv-pm-settings");Ue.textContent=w.t("pm_settings"),Ue.title=w.t("pm_settings_tooltip");const Be=document.createElement("a");Be.className="gv-pm-gh",Be.href="https://github.com/Nagi-ovo/gemini-voyager",Be.target="_blank",Be.rel="noreferrer",Be.title=w.t("starProject");const vt=document.createElement("span");vt.className="gv-pm-gh-icon";const et=document.createElement("span");et.className="gv-pm-gh-text",et.textContent=w.t("starProject"),Be.appendChild(vt),Be.appendChild(et),Ge.appendChild(Ee),Ge.appendChild(Le),Ge.appendChild(Ue),Ge.appendChild(Be),$.appendChild($e),$.appendChild(Ge),$.appendChild(de);const y=Qg(`<form class="gv-pm-add-form gv-hidden">
        <textarea class="gv-pm-input-text" placeholder="${mo(w.t("pm_prompt_placeholder")||"Prompt text")}" rows="3"></textarea>
        <input class="gv-pm-input-tags" type="text" placeholder="${mo(w.t("pm_tags_placeholder")||"Tags (comma separated)")}" />
        <div class="gv-pm-add-actions">
          <span class="gv-pm-inline-hint" aria-live="polite"></span>
          <button type="submit" class="gv-pm-save">${mo(w.t("pm_save")||"Save")}</button>
          <button type="button" class="gv-pm-cancel">${mo(w.t("pm_cancel")||"Cancel")}</button>
        </div>
      </form>`),V=De("div","gv-pm-notice");C.appendChild(L),C.appendChild(pe),C.appendChild(be),C.appendChild(y),C.appendChild(O),C.appendChild($),C.appendChild(V);let z=await Un(pt.items,[]),A=!1,T=new Set,N=!!await Un(pt.locked,!1),X=await Un(pt.position,null),te=!1,q={x:0,y:0},ae={x:0,y:0},me=!1,oe=null,ge=new Set;async function Oe(j){if(!te)return;te=!1;const se=C.getBoundingClientRect();X={left:se.left,top:se.top},await vn(pt.position,X)}v.addEventListener("click",()=>{A?l():(a(),i(),s())});const Ae=()=>{t(),m()};window.addEventListener("resize",Ae,{passive:!0}),window.addEventListener("scroll",m,{passive:!0});const mt=j=>{if(!A)return;const se=j.target;se&&(se.closest(`#${xr.panel}`)||se.closest(`#${xr.trigger}`)||se.closest(".gv-pm-confirm")||l())};window.addEventListener("pointerdown",mt,{capture:!0});const Yt=j=>{A&&j.key==="Escape"&&l()};window.addEventListener("keydown",Yt,{passive:!0}),re.addEventListener("click",async j=>{j.preventDefault(),j.stopPropagation(),N=!N,await vn(pt.locked,N),d();try{j.currentTarget?.blur?.()}catch{}if(N){const se=C.getBoundingClientRect();X={left:se.left,top:se.top},await vn(pt.position,X)}else m()}),C.addEventListener("pointerdown",j=>{j.target.closest(".gv-pm-drag")&&p(j)}),window.addEventListener("pointermove",f,{passive:!0}),window.addEventListener("pointerup",Oe,{passive:!0});let nt=null;v.addEventListener("pointerdown",j=>{if(!(typeof j.button=="number"&&j.button!==0)){me=!0,nt={x:j.clientX,y:j.clientY};try{v.setPointerCapture?.(j.pointerId)}catch{}}});const Kt=async j=>{if(me){if(me=!1,nt){const se=Math.abs(j.clientX-nt.x),ye=Math.abs(j.clientY-nt.y);if(se>5||ye>5){const Se=parseFloat((v.style.right||"").replace("px",""))||18,we=parseFloat((v.style.bottom||"").replace("px",""))||18;await vn(pt.triggerPos,{right:Se,bottom:we})}}nt=null}};window.addEventListener("pointerup",Kt,{passive:!0}),Y.addEventListener("change",async()=>{const j=Y.value;Hd(j)&&(await w.set(j),u())});const He=(j,se)=>{const ye=j[ke.LANGUAGE]?.newValue;if(se==="sync"&&typeof ye=="string"){try{Y.value=Bo(ye)}catch{}u()}if(se==="sync"&&j?.gvHidePromptManager){const Se=j.gvHidePromptManager.newValue===!0;rn.info("Hide prompt manager setting changed",{shouldHide:Se}),Se?(v.style.display="none",C.classList.add("gv-hidden"),A=!1):v.style.display=""}if(se==="local"&&j?.gvPromptItems){rn.info("Prompt data changed in chrome.storage.local, reloading...");const Se=j.gvPromptItems.newValue;Array.isArray(Se)&&(z=Se,i(),s(),r(w.t("syncSuccess")||"Synced","ok"))}};try{Ce.storage.onChanged.addListener(He)}catch{}return Z.addEventListener("click",j=>{j.preventDefault(),j.stopPropagation(),oe=null,y.classList.remove("gv-hidden"),y.querySelector(".gv-pm-input-text")?.focus()}),Ue.addEventListener("click",async j=>{j.preventDefault(),j.stopPropagation();try{if(!Ce.runtime?.id){r(w.t("pm_settings_fallback")||"è¯·ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ‰©å±•å›¾æ ‡æ‰“å¼€è®¾ç½®","err");return}(await Ce.runtime.sendMessage({type:"gv.openPopup"}))?.ok||r(w.t("pm_settings_fallback")||"è¯·ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ‰©å±•å›¾æ ‡æ‰“å¼€è®¾ç½®","err")}catch(se){if(Ct(se)){r(w.t("pm_settings_fallback")||"è¯·ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ‰©å±•å›¾æ ‡æ‰“å¼€è®¾ç½®","err");return}console.warn("[PromptManager] Failed to open settings:",se),r(w.t("pm_settings_fallback")||"è¯·ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ‰©å±•å›¾æ ‡æ‰“å¼€è®¾ç½®","err")}}),y.querySelector(".gv-pm-cancel").addEventListener("click",j=>{j.preventDefault(),j.stopPropagation(),oe=null,y.classList.add("gv-hidden")}),y.addEventListener("submit",async j=>{j.preventDefault();const se=y.querySelector(".gv-pm-input-text").value.trim(),ye=y.querySelector(".gv-pm-input-tags").value,Se=Ci((ye||"").split(",").map(we=>we.trim()));if(se){if(oe){if(z.some(Te=>Te.id!==oe&&Te.text.trim().toLowerCase()===se.toLowerCase())){o(w.t("pm_duplicate")||"Duplicate prompt","err");return}const je=z.find(Te=>Te.id===oe);je&&(je.text=se,je.tags=Se,je.updatedAt=Date.now(),await vn(pt.items,z),r(w.t("pm_saved")||"Saved","ok")),oe=null}else{if(z.some(Te=>Te.text.trim().toLowerCase()===se.toLowerCase())){o(w.t("pm_duplicate")||"Duplicate prompt","err");return}z=[{id:ql(),text:se,tags:Se,createdAt:Date.now()},...z],await vn(pt.items,z)}y.querySelector(".gv-pm-input-text").value="",y.querySelector(".gv-pm-input-tags").value="",o(""),y.classList.add("gv-hidden"),i(),s()}}),K.addEventListener("input",()=>s()),Le.addEventListener("click",async()=>{try{const j=await Un(pt.items,[]),se={format:"gemini-voyager.prompts.v1",exportedAt:new Date().toISOString(),items:j},ye=new Blob([JSON.stringify(se,null,2)],{type:"application/json"}),Se=URL.createObjectURL(ye),we=document.createElement("a");we.href=Se,we.download=`prompts-${Date.now()}.json`,document.body.appendChild(we),we.click(),we.remove(),URL.revokeObjectURL(Se)}catch{r("Export failed","err")}}),ie.addEventListener("click",async()=>{try{const j=await Un(pt.items,[]),se={format:"gemini-voyager.prompts.v1",exportedAt:new Date().toISOString(),items:j},Se=await pd().loadData("gvFolderData")||{folders:[],folderContents:{}},we={format:"gemini-voyager.folders.v1",exportedAt:new Date().toISOString(),version:"0.9.3",data:{folders:Se.folders||[],folderContents:Se.folderContents||{}}},je=Object.values(Se.folderContents||{}).reduce((Ze,ze)=>Ze+(Array.isArray(ze)?ze.length:0),0),Te={version:"0.9.3",timestamp:new Date().toISOString(),includesPrompts:!0,includesFolders:!0,promptCount:j.length,folderCount:Se.folders?.length||0,conversationCount:je},Re=Ze=>String(Ze).padStart(2,"0"),Pe=new Date,Ye=`backup-${`${Pe.getFullYear()}${Re(Pe.getMonth()+1)}${Re(Pe.getDate())}-${Re(Pe.getHours())}${Re(Pe.getMinutes())}${Re(Pe.getSeconds())}`}`;if("showDirectoryPicker"in window){const Ze=await window.showDirectoryPicker({mode:"readwrite"});if(!Ze){r(w.t("pm_backup_cancelled")||"Backup cancelled","err");return}const ze=await Ze.getDirectoryHandle(Ye,{create:!0}),At=await(await ze.getFileHandle("prompts.json",{create:!0})).createWritable();await At.write(JSON.stringify(se,null,2)),await At.close();const Je=await(await ze.getFileHandle("folders.json",{create:!0})).createWritable();await Je.write(JSON.stringify(we,null,2)),await Je.close();const gn=await(await ze.getFileHandle("metadata.json",{create:!0})).createWritable();await gn.write(JSON.stringify(Te,null,2)),await gn.close(),r(`âœ“ Backed up ${j.length} prompts, ${Se.folders?.length||0} folders`,"ok")}else{const Ze=new Gc;Ze.file("prompts.json",JSON.stringify(se,null,2)),Ze.file("folders.json",JSON.stringify(we,null,2)),Ze.file("metadata.json",JSON.stringify(Te,null,2));const ze=await Ze.generateAsync({type:"blob"}),Ft=URL.createObjectURL(ze),At=document.createElement("a");At.href=Ft,At.download=`${Ye}.zip`,document.body.appendChild(At),At.click(),At.remove(),URL.revokeObjectURL(Ft),r(`âœ“ Downloaded ${Ye}.zip (${j.length} prompts, ${Se.folders?.length||0} folders)`,"ok")}}catch(j){j instanceof Error&&j.name==="AbortError"?r(w.t("pm_backup_cancelled")||"Backup cancelled","err"):(console.error("[PromptManager] Backup failed:",j),r(w.t("pm_backup_error")||"âœ— Backup failed","err"))}}),Ee.addEventListener("click",()=>de.click()),de.addEventListener("change",async()=>{const j=de.files&&de.files[0];if(j)try{const se=await j.text(),ye=Zg(se,null);if(!ye||ye.format!=="gemini-voyager.prompts.v1"&&!Array.isArray(ye.items)){r(w.t("pm_import_invalid")||"Invalid file format","err");return}const Se=Array.isArray(ye)?ye:Array.isArray(ye.items)?ye.items:[],we=[],je=new Set;for(const Te of Se){const Re=String(Te&&Te.text||"").trim();if(!Re)continue;const Pe=Array.isArray(Te.tags)?Te.tags.map(Ye=>String(Ye)):[],We=`${Re.toLowerCase()}|${Pe.sort().join(",")}`;je.has(We)||(je.add(We),we.push({id:ql(),text:Re,tags:Ci(Pe),createdAt:Date.now()}))}if(we.length){const Te=new Map;for(const Re of z)Te.set(Re.text.toLowerCase(),Re);for(const Re of we){const Pe=Re.text.toLowerCase();if(Te.has(Pe)){const We=Te.get(Pe),Ye=Ci([...We.tags||[],...Re.tags||[]]);We.tags=Ye,We.updatedAt=Date.now(),Te.set(Pe,We)}else Te.set(Pe,Re)}z=Array.from(Te.values()).sort((Re,Pe)=>(Pe.createdAt||0)-(Re.createdAt||0)),await vn(pt.items,z),r((w.t("pm_import_success")||"Imported").replace("{count}",String(we.length)),"ok"),i(),s()}else r(w.t("pm_import_invalid")||"Invalid file format","err")}catch{r(w.t("pm_import_invalid")||"Invalid file format","err")}finally{de.value=""}}),u(),{destroy:()=>{try{window.removeEventListener("resize",Ae),window.removeEventListener("scroll",m),window.removeEventListener("pointerdown",mt,{capture:!0}),window.removeEventListener("keydown",Yt),window.removeEventListener("pointermove",f),window.removeEventListener("pointerup",Oe),window.removeEventListener("pointerup",Kt),chrome.storage?.onChanged?.removeListener(He),v.remove(),C.remove(),document.querySelectorAll(".gv-pm-confirm").forEach(j=>j.remove())}catch(j){console.error("[PromptManager] Destroy error:",j)}}}}catch(e){try{if(Ct(e))return{destroy:()=>{}};window.console?.error?.("Prompt Manager init failed",e)}catch{}return{destroy:()=>{}}}}const po={BUTTON:"gv-quote-btn",HIDDEN:"gv-hidden"},_i={INSERTION_DELAY_MS:200,FOCUS_RETRY_DELAY_MS:50,SELECTION_DEBOUNCE_MS:10},ki={MIN_EDGE_OFFSET_PX:10,BUTTON_SELECTION_GAP_PX:10},nb='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"></path><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"></path></svg>',ps="gemini-voyager-quote-reply-style";function rb(){if(document.getElementById(ps))return;const n=document.createElement("style");n.id=ps,n.textContent=`
    .gv-quote-btn {
      position: fixed;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background-color: #1e1e1e;
      color: #fff;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid rgba(255,255,255,0.1);
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }
    .gv-quote-btn:hover {
      background-color: #2d2d2d;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .gv-quote-btn svg {
      width: 14px;
      height: 14px;
      opacity: 0.9;
    }
    .gv-quote-btn.gv-hidden {
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
      visibility: hidden;
    }
    /* Light mode support */
    @media (prefers-color-scheme: light) {
      .gv-quote-btn {
        background-color: #fff;
        color: #1f1f1f;
        border: 1px solid rgba(0,0,0,0.08);
      }
      .gv-quote-btn:hover {
        background-color: #f5f5f5;
      }
    }
    /* Check for specific theme attributes if Gemini uses them */
    body[data-theme="light"] .gv-quote-btn {
      background-color: #fff;
      color: #1f1f1f;
      border: 1px solid rgba(0,0,0,0.08);
    }
    body[data-theme="light"] .gv-quote-btn:hover {
       background-color: #f5f5f5;
    }
  `,document.head.appendChild(n)}function ob(){const n=['rich-textarea [contenteditable="true"]','div[contenteditable="true"][role="textbox"]',".input-area textarea",'textarea[placeholder*="Ask"]',"textarea"];for(const e of n){const t=document.querySelectorAll(e);for(const r of Array.from(t))if(r.getBoundingClientRect().height>0)return r}return null}function ib(){rb();let n=null,e=null,t=!1;function r(){if(n)return;n=document.createElement("div"),n.className=`${po.BUTTON} ${po.HIDDEN}`;const u=Ke("quoteReply");n.innerHTML=`${nb}<span>${u}</span>`,n.addEventListener("mousedown",m=>{m.preventDefault(),m.stopPropagation(),t=!0,o()}),document.body.appendChild(n)}function o(){if(!e)return;const u=e.toString().trim();if(!u)return;const m=ob();if(m){dg();const p=u.split(`
`).map(g=>`> ${g}`).join(`
`);m.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{m.focus();const w=(m instanceof HTMLTextAreaElement?m.value:m.textContent||"").trim().length===0?`${p}
`:`
${p}
`;if(m instanceof HTMLTextAreaElement)m.value+=w,m.selectionStart=m.selectionEnd=m.value.length,m.dispatchEvent(new Event("input",{bubbles:!0}));else{const v=window.getSelection();if(v){const L=document.createRange();L.selectNodeContents(m),L.collapse(!1),v.removeAllRanges(),v.addRange(L)}const S=document.createTextNode(w);if(v&&v.rangeCount>0){const L=v.getRangeAt(0);L.insertNode(S),L.setStartAfter(S),L.setEndAfter(S),v.removeAllRanges(),v.addRange(L)}else m.appendChild(S);const C=document.createRange();C.selectNodeContents(m),C.collapse(!1),v?.removeAllRanges(),v?.addRange(C),m.dispatchEvent(new Event("input",{bubbles:!0}))}m.focus(),setTimeout(()=>m.focus(),_i.FOCUS_RETRY_DELAY_MS)},_i.INSERTION_DELAY_MS),s(),window.getSelection()?.removeAllRanges()}else console.warn("[Gemini Voyager] Could not find chat input.")}function i(u){if(n||r(),!n)return;n.classList.remove(po.HIDDEN);const m=n.getBoundingClientRect(),p=u.top-m.height-ki.BUTTON_SELECTION_GAP_PX+window.scrollY,f=u.left+u.width/2-m.width/2+window.scrollX;n.style.top=`${Math.max(ki.MIN_EDGE_OFFSET_PX,p)}px`,n.style.left=`${Math.max(ki.MIN_EDGE_OFFSET_PX,f)}px`}function s(){n&&n.classList.add(po.HIDDEN)}function a(){setTimeout(()=>{const u=window.getSelection();if(!u||u.rangeCount===0||u.isCollapsed){s(),e=null;return}if(!u.toString().trim()){s(),e=null;return}const p=u.anchorNode;if(!p)return;const f=p.nodeType===Node.TEXT_NODE?p.parentElement:p,g=document.querySelector("main");if(g&&!g.contains(f)){s();return}if(f?.closest("nav")||f?.closest('[role="navigation"]')||f?.closest(".sidebar")||f?.closest(".mat-drawer")){s();return}if(f?.closest('[contenteditable="true"]')){s();return}const b=u.getRangeAt(0);e=b;const w=b.getBoundingClientRect();w.width===0&&w.height===0||i(w)},_i.SELECTION_DEBOUNCE_MS)}function l(u){if(t){t=!1;return}a()}function d(){if(n){const u=n.querySelector("span");u&&(u.textContent=Ke("quoteReply"))}}return document.addEventListener("mouseup",l),document.addEventListener("keyup",u=>{(u.key==="Shift"||u.key.startsWith("Arrow"))&&a()}),Ce.storage.onChanged.addListener((u,m)=>{(m==="sync"||m==="local")&&u[ke.LANGUAGE]&&d()}),()=>{document.removeEventListener("mouseup",l),n&&n.remove();const u=document.getElementById(ps);u&&u.remove()}}const fs="gv-recents-hider-style",Hr="gv-recents-hidden",Pt="gv-recents-peek-bar",Et="gv-recents-toggle-btn",Nr="gvRecentsHidden",Ai=".my-stuff-recents-preview";let gs=!1,Fr=null;function sb(){if(document.getElementById(fs))return;const n=document.createElement("style");n.id=fs,n.textContent=`
    /* Container for proper positioning */
    .my-stuff-recents-preview {
      position: relative;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Toggle button - appears on hover */
    .${Et} {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: var(--gm3-sys-color-surface-container-high, rgba(0, 0, 0, 0.06));
      backdrop-filter: blur(8px);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      color: var(--gm3-sys-color-on-surface-variant, #5f6368);
    }

    .${Et}:hover {
      background: var(--gm3-sys-color-surface-container-highest, rgba(0, 0, 0, 0.12));
      transform: scale(1.1);
    }

    .${Et}:active {
      transform: scale(0.95);
    }

    .${Et} svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
    }

    /* Show button on container hover */
    .my-stuff-recents-preview:hover .${Et} {
      opacity: 1;
      transform: scale(1);
    }

    /* Hidden state - collapse with smooth animation */
    .${Hr} {
      max-height: 0 !important;
      overflow: hidden !important;
      opacity: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      pointer-events: none !important;
    }

    /* Peek bar - minimal restore hint */
    .${Pt} {
      height: 6px;
      margin: 8px 16px;
      border-radius: 3px;
      background: linear-gradient(
        90deg,
        transparent 0%,
        var(--gm3-sys-color-outline-variant, rgba(0, 0, 0, 0.08)) 20%,
        var(--gm3-sys-color-outline-variant, rgba(0, 0, 0, 0.08)) 80%,
        transparent 100%
      );
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      display: none;
    }

    .${Pt}::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 4px;
      border-radius: 2px;
      background: var(--gm3-sys-color-primary, #1a73e8);
      opacity: 0;
      transition: all 0.2s ease;
    }

    .${Pt}:hover {
      height: 12px;
      background: linear-gradient(
        90deg,
        transparent 0%,
        var(--gm3-sys-color-primary-container, rgba(26, 115, 232, 0.12)) 15%,
        var(--gm3-sys-color-primary-container, rgba(26, 115, 232, 0.12)) 85%,
        transparent 100%
      );
    }

    .${Pt}:hover::after {
      opacity: 1;
      width: 60px;
    }

    /* Tooltip for peek bar */
    .${Pt}[data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-4px);
      padding: 6px 12px;
      background: var(--gm3-sys-color-inverse-surface, #303030);
      color: var(--gm3-sys-color-inverse-on-surface, #f5f5f5);
      font-family: 'Google Sans', Roboto, sans-serif;
      font-size: 12px;
      font-weight: 500;
      border-radius: 8px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
    }

    .${Pt}:hover[data-tooltip]::before {
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }

    /* Show peek bar when recents is hidden */
    .${Pt}.gv-visible {
      display: block;
    }

    /* Dark mode adjustments */
    @media (prefers-color-scheme: dark) {
      .${Et} {
        background: rgba(255, 255, 255, 0.08);
        color: #e8eaed;
      }
      .${Et}:hover {
        background: rgba(255, 255, 255, 0.14);
      }
      .${Pt} {
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.06) 20%,
          rgba(255, 255, 255, 0.06) 80%,
          transparent 100%
        );
      }
      .${Pt}:hover {
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(138, 180, 248, 0.15) 15%,
          rgba(138, 180, 248, 0.15) 85%,
          transparent 100%
        );
      }
      .${Pt}::after {
        background: #8ab4f8;
      }
    }

    /* Explicit dark theme support */
    body[data-theme="dark"] .${Et},
    body.dark-theme .${Et} {
      background: rgba(255, 255, 255, 0.08);
      color: #e8eaed;
    }
    body[data-theme="dark"] .${Et}:hover,
    body.dark-theme .${Et}:hover {
      background: rgba(255, 255, 255, 0.14);
    }
  `,document.head.appendChild(n)}function ab(){const n=document.createElement("button");return n.className=Et,n.setAttribute("aria-label",Ke("recentsHide")||"Hide recent items"),n.title=Ke("recentsHide")||"Hide recent items",n.innerHTML=`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
      <path d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-41 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z"/>
    </svg>
  `,n}function lb(){const n=document.createElement("div");return n.className=Pt,n.setAttribute("data-tooltip",Ke("recentsShow")||"Show recent items"),n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.setAttribute("aria-label",Ke("recentsShow")||"Show recent items"),n}async function cb(){return new Promise(n=>{try{chrome.storage?.local?.get({[Nr]:!1},e=>{n(e?.[Nr]===!0)})}catch{n(localStorage.getItem(Nr)==="true")}})}async function Ii(n){return new Promise(e=>{try{chrome.storage?.local?.set({[Nr]:n},()=>e())}catch{localStorage.setItem(Nr,String(n)),e()}})}function fo(n,e,t){t?(n.classList.add(Hr),e.classList.add("gv-visible")):(n.classList.remove(Hr),e.classList.remove("gv-visible"))}async function Li(n){if(n.querySelector(`.${Et}`))return;const e=ab(),t=lb();n.appendChild(e),n.parentElement?.insertBefore(t,n.nextSibling);const r=await cb();fo(n,t,r),e.addEventListener("click",async o=>{o.stopPropagation(),o.preventDefault(),await Ii(!0),fo(n,t,!0)}),t.addEventListener("click",async()=>{await Ii(!1),fo(n,t,!1)}),t.addEventListener("keydown",async o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),await Ii(!1),fo(n,t,!1))})}function db(){document.querySelectorAll(`.${Et}`).forEach(n=>{const e=Ke("recentsHide")||"Hide recent items";n.setAttribute("aria-label",e),n.title=e}),document.querySelectorAll(`.${Pt}`).forEach(n=>{const e=Ke("recentsShow")||"Show recent items";n.setAttribute("data-tooltip",e),n.setAttribute("aria-label",e)})}function Gl(){if(gs)return;gs=!0,sb(),document.querySelectorAll(Ai).forEach(e=>Li(e)),Fr=new MutationObserver(e=>{for(const t of e)for(const r of Array.from(t.addedNodes))r instanceof HTMLElement&&(r.matches(Ai)&&Li(r),r.querySelectorAll(Ai).forEach(i=>Li(i)))}),Fr.observe(document.body,{childList:!0,subtree:!0}),Ce.storage.onChanged.addListener((e,t)=>{(t==="sync"||t==="local")&&e[ke.LANGUAGE]&&db()})}function ub(){Fr&&(Fr.disconnect(),Fr=null),document.getElementById(fs)?.remove(),document.querySelectorAll(`.${Et}`).forEach(n=>n.remove()),document.querySelectorAll(`.${Pt}`).forEach(n=>n.remove()),document.querySelectorAll(`.${Hr}`).forEach(n=>{n.classList.remove(Hr)}),gs=!1}function hb(){return location.hostname!=="gemini.google.com"?()=>{}:(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Gl):setTimeout(Gl,500),ub)}function mb(n){const e=window.getSelection();if(!e||e.rangeCount===0)return null;const t=e.getRangeAt(0),r=t.cloneRange();return r.selectNodeContents(n),r.setEnd(t.endContainer,t.endOffset),r.toString().length}function jl(n,e){const t=window.getSelection();if(!t)return;const r=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null);let o=0,i=!1;for(;r.nextNode();){const s=r.currentNode,a=s.textContent?.length||0;if(o+a>=e){const l=document.createRange(),d=e-o;l.setStart(s,d),l.collapse(!0),t.removeAllRanges(),t.addRange(l),i=!0;break}o+=a}if(!i){const s=document.createRange();s.selectNodeContents(n),s.collapse(!1),t.removeAllRanges(),t.addRange(s)}}const pb=[".update-button",'button[aria-label*="Send"]','button[aria-label*="send"]','button[data-tooltip*="Send"]','button[data-tooltip*="send"]','button mat-icon[fonticon="send"]',"[data-send-button]",".send-button",'button[aria-label*="Update"]','button[aria-label*="Save"]','button[aria-label*="æ›´æ–°"]'],xd='[contenteditable="true"], [role="textbox"], textarea',rr="[SendBehavior]";let Dn=!1,Kn=null,bs=[],Zn=null;const Di=new WeakSet;function fb(n){let e=n.parentElement,t=0;const r=5;for(;e&&t<r;){const i=e.querySelector(".update-button");if(i instanceof HTMLElement&&i.offsetParent!==null)return i.closest("button")??i;const s=/update|save|confirm|submit|æ›´æ–°|ä¿å­˜|æäº¤|ä¿®æ”¹/i,a=Array.from(e.querySelectorAll("button")),l=a.find(d=>{const u=d.getAttribute("aria-label")||d.getAttribute("data-tooltip")||d.textContent||"";return s.test(u)&&d.offsetParent!==null});if(l)return l;if(t<=2){const d=a.find(u=>(u.querySelector('mat-icon[fonticon="send"]')||u.querySelector(".material-symbols-outlined")?.textContent==="send")&&u.offsetParent!==null);if(d)return d}e=e.parentElement,t++}for(const i of pb)try{const s=document.querySelector(i);if(s){const a=s.closest("button")??s;if(a instanceof HTMLElement&&a.offsetParent!==null)return a}}catch{}const o=document.querySelectorAll("button");for(const i of o)if(i.querySelector(".material-symbols-outlined, mat-icon")?.textContent?.trim().toLowerCase()==="send")return i;return null}function gb(n){const e=mb(n);if(document.execCommand("insertLineBreak",!1)){if(e!==null){const i=e+1;jl(n,i),requestAnimationFrame(()=>{jl(n,i)})}n.dispatchEvent(new Event("input",{bubbles:!0}));return}if(document.execCommand("insertHTML",!1,"<br><br>")){n.dispatchEvent(new Event("input",{bubbles:!0}));return}const o=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,shiftKey:!0,bubbles:!0,cancelable:!0});n.dispatchEvent(o)}function bb(n){const e=n.selectionStart,t=n.selectionEnd,r=n.value;n.value=r.substring(0,e)+`
`+r.substring(t),n.selectionStart=n.selectionEnd=e+1,n.dispatchEvent(new Event("input",{bubbles:!0}))}function Wl(n){if(!Dn||n.key!=="Enter")return;const e=n.target,t=e.isContentEditable||e.getAttribute("contenteditable")==="true",r=e.tagName==="TEXTAREA";if(!(!t&&!r)){if(n.ctrlKey||n.metaKey){const o=fb(e);o&&(n.preventDefault(),n.stopPropagation(),o.click());return}n.shiftKey||(n.preventDefault(),n.stopPropagation(),t?gb(e):r&&bb(e))}}function vs(n){Di.has(n)||(n.addEventListener("keydown",Wl,{capture:!0}),Di.add(n),bs.push(()=>{n.removeEventListener("keydown",Wl,{capture:!0}),Di.delete(n)}))}function vb(){document.querySelectorAll(xd).forEach(vs)}function yb(){Kn||(Kn=new MutationObserver(n=>{for(const e of n)for(const t of e.addedNodes){if(!(t instanceof HTMLElement))continue;(t.isContentEditable||t.getAttribute("role")==="textbox"||t.tagName==="TEXTAREA")&&vs(t),t.querySelectorAll(xd).forEach(vs)}}),Kn.observe(document.body,{childList:!0,subtree:!0}))}function wb(){Kn&&(Kn.disconnect(),Kn=null)}function Sd(){Dn||(Dn=!0,vb(),yb(),console.log(rr,"Feature enabled"))}function Ed(){Dn&&(Dn=!1,bs.forEach(n=>n()),bs=[],wb(),console.log(rr,"Feature disabled"))}async function xb(){return new Promise(n=>{try{if(!chrome.storage?.sync?.get){n(!1);return}chrome.storage.sync.get({[ke.CTRL_ENTER_SEND]:!1},e=>{const t=e?.[ke.CTRL_ENTER_SEND]===!0;n(t)})}catch(e){if(Ct(e)){n(!1);return}console.warn(rr,"Failed to load settings:",e),n(!1)}})}function Sb(){if(!Zn){Zn=(n,e)=>{if(e!=="sync"||!(ke.CTRL_ENTER_SEND in n))return;const t=n[ke.CTRL_ENTER_SEND].newValue===!0;t&&!Dn?Sd():!t&&Dn&&Ed()};try{chrome.storage?.onChanged?.addListener(Zn)}catch(n){if(Ct(n))return;console.warn(rr,"Failed to setup storage listener:",n)}}}function Eb(){if(Ed(),Zn){try{chrome.storage?.onChanged?.removeListener(Zn)}catch{}Zn=null}console.log(rr,"Cleanup complete")}async function Cb(){return Sb(),await xb()?Sd():console.log(rr,"Feature disabled, skipping initialization"),Eb}const ys="gv-sidebar-auto-hide-style",go="gvSidebarAutoHide",Tb=500,_b=1e3,kb=200,Mi=1500,Cd=[".gv-folder-dialog",".gv-folder-dialog-overlay",".gv-folder-confirm-dialog",".gv-folder-import-dialog",".gv-folder-menu",".gv-color-picker-dialog"];let Gt=!1,sn=null,xt=null,Xn=null,Jn=null,In=null,Or=null,Qn=null,Mn=!1,Wo=0;function Ni(n){const e=window.getComputedStyle(n);if(e.display==="none"||e.visibility==="hidden")return!1;const t=n.getBoundingClientRect();return t.width>0||t.height>0}function Ab(){return`
    /* Smooth transition for sidebar auto-hide */
    bard-sidenav,
    bard-sidenav side-navigation-content,
    bard-sidenav side-navigation-content > div {
      transition: width 0.25s ease, transform 0.25s ease !important;
    }
  `}function Ib(){if(document.getElementById(ys))return;const n=document.createElement("style");n.id=ys,n.textContent=Ab(),document.documentElement.appendChild(n)}function Lb(){const n=document.getElementById(ys);n&&n.remove()}function Db(){const n=document.querySelector('button[data-test-id="side-nav-menu-button"]');if(n)return n;const e=document.querySelector("side-nav-menu-button");return e?e.querySelector("button"):null}function Js(){if(document.body.classList.contains("mat-sidenav-opened"))return!1;if(document.querySelector("bard-sidenav side-navigation-content > div")?.classList.contains("collapsed"))return!0;const e=document.querySelector("bard-sidenav");return!!(e&&e.getBoundingClientRect().width<80)}function Td(){const n=document.querySelector("bard-sidenav");if(!n)return!1;const e=n.getBoundingClientRect();return e.width>0&&e.height>0}function Mb(){return Date.now()<Wo}function Fi(n){Wo=Date.now()+n}function _d(){const n=document.querySelectorAll(".mat-mdc-dialog-container");for(const t of n)if(Ni(t))return!0;const e=document.querySelectorAll(".mat-mdc-menu-panel");for(const t of e)if(Ni(t))return!0;for(const t of Cd){const r=document.querySelectorAll(t);for(const o of r)if(Ni(o))return!0}return!1}function Nb(){if(xt?.matches(":hover"))return!0;const n=document.querySelectorAll(".mat-mdc-dialog-container");for(const t of n)if(t.matches(":hover"))return!0;const e=document.querySelectorAll(".mat-mdc-menu-panel");for(const t of e)if(t.matches(":hover"))return!0;for(const t of Cd){const r=document.querySelectorAll(t);for(const o of r)if(o.matches(":hover"))return!0}return!1}function Fb(n){if(!Gt)return;const e=n.target;if(e.closest('[role="menuitem"], [role="menuitemradio"], .mat-mdc-menu-item')){Fi(Mi);return}if(e.closest('bard-sidenav button, bard-sidenav [role="button"]')){Fi(Mi);return}if(e.closest('[data-test-id*="options"], [aria-label*="é€‰é¡¹"], [aria-label*="Options"], [aria-label*="More"]')){Fi(Mi);return}}function Qs(){const n=Db();return n?(n.click(),!0):!1}function kd(){Mb()||_d()||Nb()||Js()||Qs()&&(Mn=!0)}function Ob(){Js()&&Mn&&(Qs(),Mn=!1)}function ws(){Gt&&(sn!==null&&(window.clearTimeout(sn),sn=null),Ob())}function xs(){Gt&&(sn!==null&&window.clearTimeout(sn),sn=window.setTimeout(()=>{sn=null,Gt&&kd()},Tb))}function Ad(){return document.querySelector("bard-sidenav")}function Id(){const n=Ad();return!n||!Td()?!1:(n===xt||(xt&&(xt.removeEventListener("mouseenter",ws),xt.removeEventListener("mouseleave",xs)),xt=n,n.addEventListener("mouseenter",ws),n.addEventListener("mouseleave",xs)),!0)}function Rb(){xt&&(xt.removeEventListener("mouseenter",ws),xt.removeEventListener("mouseleave",xs),xt=null)}function ea(){if(!Gt)return;const n=Ad();xt&&!xt.isConnected&&(xt=null,Mn=!1),n&&Td()&&n!==xt&&Id()}function Pb(){Gt&&(In!==null&&window.clearTimeout(In),In=window.setTimeout(()=>{In=null,ea()},kb))}function Bb(){Or===null&&(Or=window.setInterval(()=>{ea()},_b))}function $b(){Or!==null&&(window.clearInterval(Or),Or=null)}function Vl(){Gt||(Gt=!0,Mn=!1,Wo=0,Ib(),Id(),Xn||(Xn=new MutationObserver(()=>{Gt&&ea()}),Xn.observe(document.body,{childList:!0,subtree:!0})),Jn||(Jn=Pb,window.addEventListener("resize",Jn)),Qn||(Qn=Fb,document.addEventListener("click",Qn,!0)),Bb(),setTimeout(()=>{Gt&&xt&&!xt.matches(":hover")&&!_d()&&kd()},500))}function Yl(){Gt&&(Gt=!1,sn!==null&&(window.clearTimeout(sn),sn=null),In!==null&&(window.clearTimeout(In),In=null),$b(),Mn&&Js()&&Qs(),Mn=!1,Wo=0,Rb(),Lb(),Xn&&(Xn.disconnect(),Xn=null),Jn&&(window.removeEventListener("resize",Jn),Jn=null),Qn&&(document.removeEventListener("click",Qn,!0),Qn=null))}function qb(){try{chrome.storage?.sync?.get({[go]:!1},n=>{n?.[go]===!0&&Vl()})}catch(n){console.error("[Gemini Voyager] Failed to get sidebar auto-hide setting:",n)}try{chrome.storage?.onChanged?.addListener((n,e)=>{e==="sync"&&n[go]&&(n[go].newValue===!0?Vl():Yl())})}catch(n){console.error("[Gemini Voyager] Failed to add storage listener for sidebar auto-hide:",n)}window.addEventListener("beforeunload",()=>{Yl()})}const Ss="gv-sidebar-width-style",Ld=26,Es=15,Rr=45,Vo=1200,Ro=Math.round(Ld/100*Vo),zb=Math.round(Es/100*Vo),Ub=Math.round(Rr/100*Vo),Cs=(n,e,t)=>Math.min(t,Math.max(e,Math.round(n))),Hb=(n,e)=>{if(!Number.isFinite(n))return e;if(n>Rr){const t=n/Vo*100;return Cs(t,Es,Rr)}return Cs(n,Es,Rr)},Gb=(n,e)=>Number.isFinite(n)?Cs(n,zb,Ub):e;function Ts(n){return Number.isFinite(n)?n>Rr?{normalized:Gb(n,Ro),unit:"px"}:{normalized:Hb(n,Ld),unit:"percent"}:{normalized:Ro,unit:"px"}}function jb(n){const{normalized:e,unit:t}=Ts(n),r=t==="px"?`${e}px`:`clamp(200px, ${e}vw, 800px)`,i=`max(0px, calc(${r} - var(--bard-sidenav-closed-width, 72px)))`;return`
    :root {
      --bard-sidenav-open-width: ${r} !important;
      --bard-sidenav-open-closed-width-diff: ${i} !important;
      --gv-sidenav-shift: ${i} !important;
    }

    /* When sidenav is collapsed, zero out the shift */
    #app-root:has(side-navigation-content > div.collapsed) {
      --gv-sidenav-shift: 0px !important;
    }

    bard-sidenav {
      --bard-sidenav-open-width: ${r} !important;
      --bard-sidenav-open-closed-width-diff: ${i} !important;
    }

    /* Keep top-level mode switcher (header) aligned when sidebar grows/shrinks */
    #app-root > main > div > bard-mode-switcher {
      transform: translateX(var(--gv-sidenav-shift)) !important;
      pointer-events: none !important;
    }

    /* Re-enable clicks for the actual switcher contents */
    #app-root > main > div > bard-mode-switcher * {
      pointer-events: auto;
    }

    /* Keep top bar aligned with sidebar width so it doesn't cover the nav */
    #app-root > main > top-bar-actions,
    #app-root > main > .top-bar-actions {
      transform: translateX(var(--gv-sidenav-shift)) !important;
      width: calc(100% - var(--gv-sidenav-shift)) !important;
      max-width: calc(100% - var(--gv-sidenav-shift)) !important;
    }

    /* Pin center-section near 35% of viewport; clamp to avoid overlapping mode switcher on small screens */
    #app-root > main > top-bar-actions > div > div.center-section,
    #app-root > main > .top-bar-actions > div > div.center-section {
      position: absolute !important;
      left: clamp(
        calc(var(--gv-sidenav-shift) + 120px),
        calc(0.5 * var(--gv-top-bar-width, 100vw) - var(--gv-sidenav-shift)),
        calc(0.6 * var(--gv-top-bar-width, 100vw))
      ) !important;
      transform: translateX(-50%) !important;
    }

    /* Keep right-section's second child (e.g., profile/settings) fixed in original position */
    /* Parent has transform which offsets this element, so we compensate with margin-right */
    #app-root > main > top-bar-actions > div > div.right-section > div:nth-child(2),
    #app-root > main > .top-bar-actions > div > div.right-section > div:nth-child(2) {
      position: fixed !important;
      top: 4px !important;
      right: 150px !important;
      z-index: 1000 !important;
      /* When sidebar expands, parent moves right, so we add positive margin to pull element left */
      margin-right: var(--gv-sidenav-shift, 0px) !important;
    }

  `}function Wb(){let n=document.getElementById(Ss);return n||(n=document.createElement("style"),n.id=Ss,document.documentElement.appendChild(n)),n}function Oi(n){const e=Wb();e.textContent=jb(n)}function Vb(){const n=document.getElementById(Ss);n&&n.remove()}function Yb(){let n=Ro,e=null;const t=()=>{try{const r=document.querySelector("#app-root > main > top-bar-actions")||document.querySelector("#app-root > main > .top-bar-actions");if(!r)return;const o=r.getBoundingClientRect().width;Number.isFinite(o)&&o>0&&document.documentElement.style.setProperty("--gv-top-bar-width",`${Math.round(o)}px`)}catch(r){console.warn("[Gemini Voyager] Failed to measure top bar width:",r)}};try{chrome.storage?.sync?.get({geminiSidebarWidth:Ro},r=>{const o=Number(r?.geminiSidebarWidth),{normalized:i}=Ts(o);if(n=i,Oi(n),Number.isFinite(o)&&o!==i)try{chrome.storage?.sync?.set({geminiSidebarWidth:i})}catch(s){console.warn("[Gemini Voyager] Failed to migrate sidebar width to %:",s)}})}catch(r){console.error("[Gemini Voyager] Failed to get sidebar width from storage:",r),Oi(n)}try{chrome.storage?.onChanged?.addListener((r,o)=>{if(o==="sync"&&r.geminiSidebarWidth){const i=Number(r.geminiSidebarWidth.newValue);if(Number.isFinite(i)){const{normalized:s}=Ts(i);if(n=s,Oi(n),s!==i)try{chrome.storage?.sync?.set({geminiSidebarWidth:s})}catch(a){console.warn("[Gemini Voyager] Failed to migrate sidebar width to % on change:",a)}}}})}catch(r){console.error("[Gemini Voyager] Failed to add storage listener for sidebar width:",r)}try{const r=document.querySelector("#app-root > main > top-bar-actions")||document.querySelector("#app-root > main > .top-bar-actions");r&&"ResizeObserver"in window&&(e=new ResizeObserver(()=>t()),e.observe(r)),t()}catch(r){console.warn("[Gemini Voyager] Failed to observe top bar width:",r)}window.addEventListener("beforeunload",()=>{if(Vb(),e){try{e.disconnect()}catch{}e=null}})}function Kl(n){let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return(e>>>0).toString(36)}class Kb{scrollContainer=null;conversationContainer=null;markers=[];activeTurnId=null;ui={timelineBar:null,tooltip:null};isScrolling=!1;mutationObserver=null;resizeObserver=null;intersectionObserver=null;visibleUserTurns=new Set;onTimelineBarClick=null;onScroll=null;onTimelineWheel=null;onWindowResize=null;onTimelineBarOver=null;onTimelineBarOut=null;scrollRafId=null;lastActiveChangeTime=0;minActiveChangeInterval=120;pendingActiveId=null;activeChangeTimer=null;tooltipHideDelay=100;scrollMode="flow";hideContainer=!1;runnerRing=null;flowAnimating=!1;tooltipHideTimer=null;measureEl=null;measureCanvas=null;measureCtx=null;showRafId=null;scale=1;contentHeight=0;yPositions=[];markerTops=[];visibleRange={start:0,end:-1};firstUserTurnOffset=0;contentSpanPx=1;usePixelTop=!1;_cssVarTopSupported=null;sliderDragging=!1;sliderFadeTimer=null;sliderFadeDelay=1e3;sliderAlwaysVisible=!1;onSliderDown=null;onSliderMove=null;onSliderUp=null;sliderStartClientY=0;sliderStartTop=0;markersVersion=0;resizeIdleTimer=null;resizeIdleDelay=140;resizeIdleRICId=null;onVisualViewportResize=null;zeroTurnsTimer=null;onStorage=null;onChromeStorageChanged=null;starred=new Set;markerMap=new Map;conversationId=null;userTurnSelector="";markerLevels=new Map;collapsedMarkers=new Set;markerLevelEnabled=!1;contextMenu=null;onContextMenu=null;onDocumentClick=null;onPointerDown=null;onPointerMove=null;onPointerUp=null;onPointerCancel=null;onPointerLeave=null;pressTargetDot=null;pressStartPos=null;longPressTimer=null;longPressTriggered=!1;suppressClickUntil=0;longPressDuration=550;longPressMoveTolerance=6;onBarEnter=null;onBarLeave=null;onSliderEnter=null;onSliderLeave=null;draggable=!1;barDragging=!1;barStartPos={x:0,y:0};barStartOffset={x:0,y:0};onBarPointerDown=null;onBarPointerMove=null;onBarPointerUp=null;eventBusUnsubscribers=[];shortcutUnsubscribe=null;navigationQueue=[];isNavigating=!1;async init(){if(await jr(),!!await this.findCriticalElements()){this.injectTimelineUI(),this.setupEventListeners(),this.setupObservers(),this.conversationId=this.computeConversationId(),await this.loadStars(),await this.syncStarredFromService(),this.loadMarkerLevels(),this.loadCollapsedMarkers(),this.recalculateAndRenderMarkers(),this.handleStarredMessageNavigation(),await this.initKeyboardShortcuts();try{const t=globalThis,r={geminiTimelineScrollMode:"flow",geminiTimelineHideContainer:!1,geminiTimelineDraggable:!1,geminiTimelineMarkerLevel:!1,geminiTimelinePosition:null};let o=null;if(t.chrome?.storage?.sync||t.browser?.storage?.sync)o=await new Promise(a=>{t.chrome?.storage?.sync?.get?t.chrome.storage.sync.get(r,l=>{t.chrome.runtime.lastError?(console.error(`[Timeline] chrome.storage.get failed: ${t.chrome.runtime.lastError.message}`),a(null)):a(l)}):t.browser.storage.sync.get(r).then(a).catch(l=>{console.error(`[Timeline] browser.storage.get failed: ${l.message}`),a(null)})});else{const a=localStorage.getItem("geminiTimelineScrollMode");(a==="flow"||a==="jump")&&(o={geminiTimelineScrollMode:a})}const i=o?.geminiTimelineScrollMode;(i==="flow"||i==="jump")&&(this.scrollMode=i),this.hideContainer=!!o?.geminiTimelineHideContainer,this.applyContainerVisibility(),this.toggleDraggable(!!o?.geminiTimelineDraggable),this.toggleMarkerLevel(!!o?.geminiTimelineMarkerLevel);const s=o?.geminiTimelinePosition;if(s){const a=window.innerWidth,l=window.innerHeight;if(s.version===2&&s.topPercent!==void 0&&s.leftPercent!==void 0){const d=s.topPercent/100*l,u=s.leftPercent/100*a;this.applyPosition(d,u)}else if(s.top!==void 0&&s.left!==void 0){this.applyPosition(s.top,s.left);const d={version:2,topPercent:s.top/l*100,leftPercent:s.left/a*100};(t.chrome?.storage?.sync||t.browser?.storage?.sync)?.set?.({geminiTimelinePosition:d})}}try{const a=t.chrome?.storage?.onChanged||t.browser?.storage?.onChanged;a&&a.addListener((l,d)=>{if(d==="sync"){if(l?.geminiTimelineScrollMode){const u=l.geminiTimelineScrollMode.newValue;(u==="flow"||u==="jump")&&(this.scrollMode=u)}l?.geminiTimelineHideContainer&&(this.hideContainer=!!l.geminiTimelineHideContainer.newValue,this.applyContainerVisibility()),l?.geminiTimelineDraggable&&this.toggleDraggable(!!l.geminiTimelineDraggable.newValue),l?.geminiTimelineMarkerLevel&&this.toggleMarkerLevel(!!l.geminiTimelineMarkerLevel.newValue),l?.geminiTimelinePosition&&!l.geminiTimelinePosition.newValue&&this.ui.timelineBar&&(this.ui.timelineBar.style.top="",this.ui.timelineBar.style.left="")}})}catch{}}catch(t){console.error("[Timeline] Init storage error:",t)}}}computeElementTopsInScrollContainer(e){if(!this.scrollContainer||e.length===0)return[];const t=this.scrollContainer.getBoundingClientRect(),r=this.scrollContainer.scrollTop,o=e[0],i=o.offsetParent,s=o.offsetTop,a=o.getBoundingClientRect().top-t.top+r,l=i!==null&&e.every(u=>u.offsetParent===i),d=e.map(u=>l?a+(u.offsetTop-s):u.getBoundingClientRect().top-t.top+r);for(let u=1;u<d.length;u++)if(d[u]<d[u-1])return[];return d}updateIntersectionObserverTargetsFromMarkers(){this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.markers.forEach(e=>this.intersectionObserver.observe(e.element)))}applyContainerVisibility(){this.ui.timelineBar&&this.ui.timelineBar.classList.toggle("timeline-no-container",!!this.hideContainer)}computeConversationId(){const e=`${location.host}${location.pathname}${location.search}`;return`gemini:${Kl(e)}`}getStarsStorageKey(){return this.conversationId?`geminiTimelineStars:${this.conversationId}`:null}safeLocalStorageGet(e){try{return localStorage.getItem(e)}catch(t){return console.warn("[Timeline] Failed to read from localStorage:",t),null}}safeLocalStorageSet(e,t){try{return localStorage.setItem(e,t),!0}catch(r){return console.warn("[Timeline] Failed to write to localStorage:",r),!1}}areStarredSetsEqual(e,t){if(e.size!==t.size)return!1;for(const r of e)if(!t.has(r))return!1;return!0}applyStarredIdSet(e,t=!0){if(!this.areStarredSetsEqual(this.starred,e)){this.starred=new Set(e),t&&this.saveStars();for(const r of this.markers){const o=this.starred.has(r.id);r.starred!==o&&(r.starred=o,r.dotElement&&(r.dotElement.classList.toggle("starred",o),r.dotElement.setAttribute("aria-pressed",o?"true":"false")))}if(this.ui.tooltip?.classList.contains("visible")){const r=this.ui.timelineBar?.querySelector(".timeline-dot:hover, .timeline-dot:focus");r&&this.refreshTooltipForDot(r)}}}applySharedStarredData(e){if(!this.conversationId)return;const t=e?.messages?.[this.conversationId],r=Array.isArray(t)?t:[],o=new Set(r.map(i=>String(i.turnId)));this.applyStarredIdSet(o)}async syncStarredFromService(){if(this.conversationId)try{const e=await Zo.getStarredMessagesForConversation(this.conversationId),t=new Set(e.map(r=>String(r.turnId)));this.applyStarredIdSet(t)}catch(e){console.warn("[Timeline] Failed to sync starred messages from shared storage:",e)}}getConversationTitle(){const e=o=>{const i=o?.textContent?.trim();return i&&i.length>0?i:null};try{const o=document.querySelector(".gv-folder-conversation-selected .gv-conversation-title"),i=e(o);if(i)return i}catch(o){console.debug("[Timeline] Failed to get title from selected folder conversation:",o)}const t=document.querySelector("title");if(t){const o=t.textContent?.trim();if(o&&o!=="Gemini"&&o!=="Google Gemini"&&o!=="Google AI Studio"&&!o.startsWith("Gemini -")&&!o.startsWith("Google AI Studio -")&&o.length>0)return o}try{const o=["mat-list-item.mdc-list-item--activated [mat-line]",'mat-list-item[aria-current="page"] [mat-line]',".conversation-list-item.active .conversation-title",".active-conversation .title"];for(const i of o){const s=document.querySelector(i);if(s&&s.textContent){const a=s.textContent.trim();if(a&&a.length>0&&a!=="New chat")return a}}}catch(o){console.debug("[Timeline] Failed to get title from sidebar:",o)}const r=this.markers[0];if(r&&r.summary){const o=r.summary.slice(0,50);return o.length<r.summary.length?`${o}...`:o}try{const i=window.location.pathname.match(/\/app\/([a-zA-Z0-9_-]+)/);if(i&&i[1])return`Conversation ${i[1].slice(0,8)}...`}catch(o){console.debug("[Timeline] Failed to extract from URL:",o)}return"Untitled Conversation"}waitForElement(e,t=5e3){return new Promise(r=>{const o=document.querySelector(e);if(o)return r(o);const i=new MutationObserver(()=>{const s=document.querySelector(e);if(s){try{i.disconnect()}catch{}r(s)}});try{i.observe(document.body,{childList:!0,subtree:!0})}catch{}t>0&&setTimeout(()=>{try{i.disconnect()}catch{}r(null)},t)})}waitForAnyElement(e,t=5e3){return new Promise(r=>{for(const i of e){const s=document.querySelector(i);if(s)return r({element:s,selector:i})}const o=new MutationObserver(()=>{for(const i of e){const s=document.querySelector(i);if(s){try{o.disconnect()}catch{}r({element:s,selector:i});return}}});try{o.observe(document.body,{childList:!0,subtree:!0})}catch{}t>0&&setTimeout(()=>{try{o.disconnect()}catch{}r(null)},t)})}async findCriticalElements(){const e=this.getConfiguredUserTurnSelector();let t="",r="";try{t=localStorage.getItem("geminiTimelineUserTurnSelector")||"",r=localStorage.getItem("geminiTimelineUserTurnSelectorAuto")||""}catch{}const o=[".user-query-bubble-with-background",".user-query-bubble-container",".user-query-container","user-query-content .user-query-bubble-with-background",'div[aria-label="User message"]','article[data-author="user"]','article[data-turn="user"]','[data-message-author-role="user"]','div[role="listitem"][data-user="true"]'];let i=[...o];if(t.length)i=[t,...o.filter(u=>u!==t)];else{const u=r||e;u&&!i.includes(u)&&i.push(u)}let s=null,a="";const l=await this.waitForAnyElement(i,4e3);if(l&&(s=l.element,a=l.selector,this.userTurnSelector=a),!s)this.conversationContainer=document.querySelector("main")||document.body,this.userTurnSelector=o.join(",");else{const u=/user-query/i.test(a||"");if(t&&a===t||u)this.conversationContainer=document.querySelector("main")||document.body;else{const m=s.parentElement;if(!m)return!1;this.conversationContainer=m}if(!t&&a)try{localStorage.setItem("geminiTimelineUserTurnSelectorAuto",a)}catch{}if(t&&a&&a!==t)try{localStorage.removeItem("geminiTimelineUserTurnSelector")}catch{}}let d=s||this.conversationContainer;for(;d&&d!==document.body;){const u=getComputedStyle(d);if(u.overflowY==="auto"||u.overflowY==="scroll"){this.scrollContainer=d;break}d=d.parentElement}return this.scrollContainer||(this.scrollContainer=document.scrollingElement||document.documentElement||document.body),!0}getConfiguredUserTurnSelector(){try{const e=localStorage.getItem("geminiTimelineUserTurnSelector");if(e&&typeof e=="string")return e;const t=localStorage.getItem("geminiTimelineUserTurnSelectorAuto");return t&&typeof t=="string"?t:""}catch{return""}}injectTimelineUI(){let e=document.querySelector(".gemini-timeline-bar");e||(e=document.createElement("div"),e.className="gemini-timeline-bar",document.body.appendChild(e)),this.ui.timelineBar=e;let t=e.querySelector(".timeline-track");t||(t=document.createElement("div"),t.className="timeline-track",e.appendChild(t));let r=t.querySelector(".timeline-track-content");r||(r=document.createElement("div"),r.className="timeline-track-content",t.appendChild(r)),this.ui.track=t,this.ui.trackContent=r;let o=document.querySelector(".timeline-left-slider");if(!o){o=document.createElement("div"),o.className="timeline-left-slider";const i=document.createElement("div");i.className="timeline-left-handle",o.appendChild(i),document.body.appendChild(o)}if(this.ui.slider=o,this.ui.sliderHandle=o.querySelector(".timeline-left-handle"),!this.ui.tooltip){const i=document.createElement("div");if(i.className="timeline-tooltip",i.id="gemini-timeline-tooltip",document.body.appendChild(i),this.ui.tooltip=i,!this.measureEl){const s=document.createElement("div");s.setAttribute("aria-hidden","true"),Object.assign(s.style,{position:"fixed",left:"-9999px",top:"0",visibility:"hidden",pointerEvents:"none"});const a=getComputedStyle(i);Object.assign(s.style,{backgroundColor:a.backgroundColor,color:a.color,fontFamily:a.fontFamily,fontSize:a.fontSize,lineHeight:a.lineHeight,padding:a.padding,border:a.border,borderRadius:a.borderRadius,whiteSpace:"normal",wordBreak:"break-word",maxWidth:"none",display:"block"}),document.body.appendChild(s),this.measureEl=s}this.measureCanvas||(this.measureCanvas=document.createElement("canvas"),this.measureCtx=this.measureCanvas.getContext("2d"))}}updateIntersectionObserverTargets(){if(!this.intersectionObserver||!this.conversationContainer||!this.userTurnSelector)return;this.intersectionObserver.disconnect(),this.visibleUserTurns.clear();const e=this.conversationContainer.querySelectorAll(this.userTurnSelector);this.filterTopLevel(Array.from(e)).forEach(r=>this.intersectionObserver.observe(r))}normalizeText(e){try{return String(e||"").replace(/\s+/g," ").trim()}catch{return""}}filterTopLevel(e){const t=e.map(i=>i);if(t.length===0)return t;const r=new Set,o=t.slice().sort((i,s)=>{let a=0,l=0,d=i;for(;d.parentElement;)a++,d=d.parentElement;for(d=s;d.parentElement;)l++,d=d.parentElement;return a-l});for(let i=0;i<o.length;i++){const s=o[i];for(let a=0;a<i;a++)if(o[a].contains(s)){r.add(s);break}}return t.filter(i=>!r.has(i))}dedupeByTextAndOffset(e,t){const r=new Set,o=[],i=new Map;for(const s of e){let a=i.get(s);a===void 0&&(a=this.normalizeText(s.textContent||""),i.set(s,a));const l=(s.offsetTop||0)-t,d=`${a}|${Math.round(l)}`;r.has(d)||(r.add(d),o.push(s))}return o}getCSSVarNumber(e,t,r){const o=getComputedStyle(e).getPropertyValue(t).trim(),i=parseFloat(o);return Number.isFinite(i)?i:r}getTrackPadding(){return this.ui.timelineBar?this.getCSSVarNumber(this.ui.timelineBar,"--timeline-track-padding",12):12}getMinGap(){return this.ui.timelineBar?this.getCSSVarNumber(this.ui.timelineBar,"--timeline-min-gap",12):12}ensureTurnId(e,t){const r=e;let o=r.dataset&&r.dataset.turnId||"";if(!o){const i=this.normalizeText(r.textContent||"")||`user-${t}`;o=`u-${Kl(i)}`;try{r.dataset.turnId=o}catch{}}return o}detectCssVarTopSupport(e,t){try{const r=document.createElement("button");r.className="timeline-dot",r.style.visibility="hidden",r.setAttribute("aria-hidden","true"),r.style.setProperty("--n","0.5"),this.ui.trackContent.appendChild(r);const o=getComputedStyle(r),i=parseFloat(o.top||"");r.remove();const s=e+.5*t;return Number.isFinite(i)&&Math.abs(i-s)<=2}catch{return!1}}updateTimelineGeometry(){if(!this.ui.timelineBar||!this.ui.trackContent)return;const e=this.ui.timelineBar.clientHeight||0,t=this.getTrackPadding(),r=this.getMinGap(),o=this.markers.length,i=this.getHiddenMarkerIndices(),s=o-i.size,a=Math.max(e,s>0?2*t+Math.max(0,s-1)*r:e);this.contentHeight=Math.ceil(a),this.scale=e>0?this.contentHeight/e:1,this.ui.trackContent.style.height=`${this.contentHeight}px`;const l=Math.max(1,this.contentHeight-2*t),{desiredY:d}=this.calculateCollapsedPositions(i,t,l),u=new Array(o).fill(1),m=this.applyMinGapWithHidden(d,t,t+l,r,i,u);this.yPositions=m;for(let f=0;f<o;f++){if(i.has(f)){this.markers[f].n=-1;continue}const b=(m[f]-t)/l;this.markers[f].n=Math.max(0,Math.min(1,b));const w=this.markers[f].dotElement;w&&!this.usePixelTop&&w.style.setProperty("--n",String(this.markers[f].n))}this._cssVarTopSupported===null&&(this._cssVarTopSupported=this.detectCssVarTopSupport(t,l),this.usePixelTop=!this._cssVarTopSupported),this.updateSlider();const p=this.ui.timelineBar.clientHeight||0;this.sliderAlwaysVisible=this.contentHeight>p+1,this.sliderAlwaysVisible&&this.showSlider()}applyMinGapWithHidden(e,t,r,o,i,s){const a=e.length;if(a===0)return e;const l=e.slice();let d=-1;for(let m=0;m<a;m++)if(!i.has(m)){if(d===-1)l[m]=Math.max(t,Math.min(e[m],r));else{const p=o*s[m],f=l[d]+p;l[m]=Math.max(e[m],f)}d=m}let u=-1;for(let m=a-1;m>=0;m--)if(!i.has(m)){u=m;break}if(u>=0&&l[u]>r){l[u]=r;let m=u;for(let p=u-1;p>=0;p--){if(i.has(p))continue;const f=o*s[m],g=l[m]-f;l[p]=Math.min(l[p],g),m=p}}for(let m=0;m<a;m++)i.has(m)||(l[m]<t&&(l[m]=t),l[m]>r&&(l[m]=r));return l}applyMinGap(e,t,r,o){const i=e.length;if(i===0)return e;const s=e.slice();s[0]=Math.max(t,Math.min(e[0],r));for(let a=1;a<i;a++){const l=s[a-1]+o;s[a]=Math.max(e[a],l)}if(s[i-1]>r){s[i-1]=r;for(let a=i-2;a>=0;a--){const l=s[a+1]-o;s[a]=Math.min(s[a],l)}if(s[0]<t){s[0]=t;for(let a=1;a<i;a++){const l=s[a-1]+o;s[a]=Math.max(s[a],l)}}}for(let a=0;a<i;a++)s[a]<t&&(s[a]=t),s[a]>r&&(s[a]=r);return s}recalculateAndRenderMarkers=()=>{if(!this.conversationContainer||!this.ui.timelineBar||!this.scrollContainer||!this.userTurnSelector)return;const e=this.conversationContainer.querySelectorAll(this.userTurnSelector);if(this.visibleRange={start:0,end:-1},e.length===0){this.zeroTurnsTimer||(this.zeroTurnsTimer=window.setTimeout(()=>{this.zeroTurnsTimer=null,this.recalculateAndRenderMarkers()},200));return}this.zeroTurnsTimer&&(clearTimeout(this.zeroTurnsTimer),this.zeroTurnsTimer=null),(this.ui.trackContent||this.ui.timelineBar).querySelectorAll(".timeline-dot").forEach(i=>i.remove());let t=Array.from(e);if(t=this.filterTopLevel(t),t.length===0)return;const r=t[0].offsetTop;t=this.dedupeByTextAndOffset(t,r),this.markerTops=this.computeElementTopsInScrollContainer(t);let o;t.length<2?o=1:o=t[t.length-1].offsetTop-r,o<=0&&(o=1),this.firstUserTurnOffset=r,this.contentSpanPx=o,this.markerMap.clear(),this.markers=Array.from(t).map((i,s)=>{const a=i;let d=(a.offsetTop-r)/o;d=Math.max(0,Math.min(1,d));const u=this.ensureTurnId(a,s),m={id:u,element:a,summary:this.normalizeText(a.textContent||""),n:d,baseN:d,dotElement:null,starred:this.starred.has(u)};return this.markerMap.set(u,m),m}),this.markersVersion++,this.updateTimelineGeometry(),!this.activeTurnId&&this.markers.length>0&&(this.activeTurnId=this.markers[this.markers.length-1].id),this.updateIntersectionObserverTargetsFromMarkers(),this.syncTimelineTrackToMain(),this.updateVirtualRangeAndRender(),this.updateActiveDotUI(),this.scheduleScrollSync()};setupObservers(){this.mutationObserver=new MutationObserver(()=>{this.debouncedRecalc()}),this.conversationContainer&&this.mutationObserver.observe(this.conversationContainer,{childList:!0,subtree:!0}),this.resizeObserver=new ResizeObserver(()=>{this.updateTimelineGeometry(),this.syncTimelineTrackToMain(),this.updateVirtualRangeAndRender()}),this.ui.timelineBar&&this.resizeObserver.observe(this.ui.timelineBar),this.intersectionObserver=new IntersectionObserver(()=>{this.scheduleScrollSync()},{root:this.scrollContainer,threshold:.1,rootMargin:"-40% 0px -59% 0px"})}setupEventListeners(){this.onTimelineBarClick=e=>{const t=e.target.closest(".timeline-dot");if(!t)return;if(Date.now()<(this.suppressClickUntil||0)){e.preventDefault(),e.stopPropagation();return}const o=t.dataset.markerIndex;let i=null,s=-1;if(o){s=parseInt(o,10);const a=this.markers[s];a&&(i=a.element)}if(!i){const a=t.dataset.targetTurnId;i=this.conversationContainer.querySelector(`[data-turn-id="${a}"]`)||this.markers.find(l=>l.id===a)?.element||null,s=this.markers.findIndex(l=>l.id===a)}if(i){const a=this.getActiveIndex(),l=this.computeFlowDuration(a,s);this.scrollMode==="flow"&&a>=0&&s>=0&&a!==s&&(this.activeTurnId=null,this.updateActiveDotUI(),this.startRunner(a,s,l)),this.smoothScrollTo(i,l)}},this.ui.timelineBar.addEventListener("click",this.onTimelineBarClick),this.onScroll=()=>this.scheduleScrollSync(),this.scrollContainer.addEventListener("scroll",this.onScroll,{passive:!0}),this.onTimelineWheel=e=>{e.preventDefault();const t=e.deltaY||0;this.scrollContainer.scrollTop+=t,this.scheduleScrollSync(),this.showSlider()},this.ui.timelineBar.addEventListener("wheel",this.onTimelineWheel,{passive:!1}),this.onTimelineBarOver=e=>{const t=e.target.closest(".timeline-dot");t&&this.showTooltipForDot(t)},this.onTimelineBarOut=e=>{const t=e.target.closest(".timeline-dot"),r=e.relatedTarget?.closest?.(".timeline-dot");t&&!r&&this.hideTooltip()},this.ui.timelineBar.addEventListener("mouseover",this.onTimelineBarOver),this.ui.timelineBar.addEventListener("mouseout",this.onTimelineBarOut),this.onContextMenu=e=>{if(!this.markerLevelEnabled)return;const t=e.target.closest(".timeline-dot");t&&(e.preventDefault(),e.stopPropagation(),this.showContextMenu(t,e.clientX,e.clientY))},this.ui.timelineBar.addEventListener("contextmenu",this.onContextMenu),this.onDocumentClick=e=>{this.contextMenu&&!this.contextMenu.contains(e.target)&&this.hideContextMenu()},document.addEventListener("click",this.onDocumentClick),this.onPointerDown=e=>{const t=e.target.closest(".timeline-dot");t&&(typeof e.button=="number"&&e.button!==0||(this.cancelLongPress(),this.pressTargetDot=t,this.pressStartPos={x:e.clientX,y:e.clientY},t.classList.add("holding"),this.longPressTriggered=!1,this.longPressTimer=window.setTimeout(()=>{if(this.longPressTimer=null,!this.pressTargetDot)return;const r=this.pressTargetDot.dataset.targetTurnId;this.toggleStar(r),this.longPressTriggered=!0,this.suppressClickUntil=Date.now()+350,this.refreshTooltipForDot(this.pressTargetDot),this.pressTargetDot.classList.remove("holding")},this.longPressDuration)))},this.onPointerMove=e=>{if(!this.pressTargetDot||!this.pressStartPos)return;const t=e.clientX-this.pressStartPos.x,r=e.clientY-this.pressStartPos.y;t*t+r*r>this.longPressMoveTolerance*this.longPressMoveTolerance&&this.cancelLongPress()},this.onPointerUp=()=>this.cancelLongPress(),this.onPointerCancel=()=>this.cancelLongPress(),this.onPointerLeave=e=>{const t=e.target.closest(".timeline-dot");t&&t===this.pressTargetDot&&this.cancelLongPress()},this.ui.timelineBar.addEventListener("pointerdown",this.onPointerDown),window.addEventListener("pointermove",this.onPointerMove,{passive:!0}),window.addEventListener("pointerup",this.onPointerUp,{passive:!0}),window.addEventListener("pointercancel",this.onPointerCancel,{passive:!0}),this.ui.timelineBar.addEventListener("pointerleave",this.onPointerLeave),this.onWindowResize=()=>{if(this.ui.tooltip?.classList.contains("visible")){const e=this.ui.timelineBar.querySelector(".timeline-dot:hover, .timeline-dot:focus");e&&this.refreshTooltipForDot(e)}this.updateTimelineGeometry(),this.syncTimelineTrackToMain(),this.updateVirtualRangeAndRender(),this.reapplyPosition()},window.addEventListener("resize",this.onWindowResize),window.visualViewport&&(this.onVisualViewportResize=()=>{this.updateTimelineGeometry(),this.syncTimelineTrackToMain(),this.updateVirtualRangeAndRender(),this.reapplyPosition()},window.visualViewport.addEventListener("resize",this.onVisualViewportResize)),this.onSliderDown=e=>{if(!this.ui.sliderHandle)return;try{this.ui.sliderHandle.setPointerCapture(e.pointerId)}catch{}this.sliderDragging=!0,this.showSlider(),this.sliderStartClientY=e.clientY;const t=this.ui.sliderHandle.getBoundingClientRect();this.sliderStartTop=t.top,this.onSliderMove=r=>this.handleSliderDrag(r),this.onSliderUp=r=>this.endSliderDrag(r),window.addEventListener("pointermove",this.onSliderMove),window.addEventListener("pointerup",this.onSliderUp,{once:!0})},this.ui.sliderHandle?.addEventListener("pointerdown",this.onSliderDown),this.onBarEnter=()=>this.showSlider(),this.onBarLeave=()=>this.hideSliderDeferred(),this.onSliderEnter=()=>this.showSlider(),this.onSliderLeave=()=>this.hideSliderDeferred(),this.ui.timelineBar.addEventListener("pointerenter",this.onBarEnter),this.ui.timelineBar.addEventListener("pointerleave",this.onBarLeave),this.ui.slider?.addEventListener("pointerenter",this.onSliderEnter),this.ui.slider?.addEventListener("pointerleave",this.onSliderLeave),this.onBarPointerDown=e=>{if(e.target.closest(".timeline-dot, .timeline-thumb"))return;this.barDragging=!0,this.barStartPos={x:e.clientX,y:e.clientY};const t=this.ui.timelineBar.getBoundingClientRect();this.barStartOffset={x:t.left,y:t.top},this.ui.timelineBar.setPointerCapture(e.pointerId),this.onBarPointerMove=r=>this.handleBarDrag(r),this.onBarPointerUp=r=>this.endBarDrag(r),window.addEventListener("pointermove",this.onBarPointerMove),window.addEventListener("pointerup",this.onBarPointerUp,{once:!0})},this.onStorage=e=>{if(!e||e.storageArea!==localStorage)return;const t=this.getStarsStorageKey();if(!t||e.key!==t)return;let r=[];try{r=JSON.parse(e.newValue||"[]")||[]}catch{r=[]}const o=new Set(r.map(String));this.applyStarredIdSet(o,!1)},window.addEventListener("storage",this.onStorage),typeof chrome<"u"&&chrome.storage?.onChanged&&(this.onChromeStorageChanged=(e,t)=>{if(t!=="local")return;const r=e[ke.TIMELINE_STARRED_MESSAGES];r&&this.applySharedStarredData(r.newValue)},chrome.storage.onChanged.addListener(this.onChromeStorageChanged)),this.eventBusUnsubscribers.push(oa.on("starred:removed",({conversationId:e,turnId:t})=>{if(e===this.conversationId&&this.starred.has(t)){this.starred.delete(t),this.saveStars();const r=this.markerMap.get(t);r&&r.dotElement&&(r.starred=!1,r.dotElement.classList.remove("starred"),r.dotElement.setAttribute("aria-pressed","false")),console.log("[Timeline] Starred removed via EventBus:",t)}})),this.eventBusUnsubscribers.push(oa.on("starred:added",({conversationId:e,turnId:t})=>{if(e===this.conversationId&&!this.starred.has(t)){this.starred.add(t),this.saveStars();const r=this.markerMap.get(t);r&&r.dotElement&&(r.starred=!0,r.dotElement.classList.add("starred"),r.dotElement.setAttribute("aria-pressed","true")),console.log("[Timeline] Starred added via EventBus:",t)}}))}smoothScrollTo(e,t=600){const r=this.scrollContainer.getBoundingClientRect(),i=e.getBoundingClientRect().top-r.top+this.scrollContainer.scrollTop,s=this.scrollContainer.scrollTop,a=i-s;let l=null;if(this.scrollMode==="jump"){this.scrollContainer.scrollTop=i;return}const d=u=>{this.isScrolling=!0,l===null&&(l=u);const m=u-l,p=this.easeInOutQuad(m,s,a,t);this.scrollContainer.scrollTop=p,m<t?requestAnimationFrame(d):(this.scrollContainer.scrollTop=i,this.isScrolling=!1)};requestAnimationFrame(d)}easeInOutQuad(e,t,r,o){const i=(()=>{try{return localStorage.getItem("geminiTimelineSpring")||"ios"}catch{return"ios"}})(),s=f=>Math.max(0,Math.min(1,f)),a=s(e/o);if(i==="snappy"){const g=a<.6?a/.6:1+(.6-a)*.15;return t+r*s(g*1.15-(1.15-1))}if(i==="gentle")return t+r*(a<.5?4*a*a*a:1-Math.pow(-2*a+2,3)/2);const l=.42,d=.58,u=a*a*(3-2*a),p=((f,g,b)=>f+(g-f)*b)(Math.pow(a,l),Math.pow(a,d),.5)*.15+u*.85;return t+r*s(p)}updateActiveDotUI(){this.markers.forEach(e=>{e.dotElement?.classList.toggle("active",e.id===this.activeTurnId)})}debouncedRecalc=this.debounce(()=>this.recalculateAndRenderMarkers(),200);debounce(e,t){let r=null;return((...o)=>{r&&clearTimeout(r),r=window.setTimeout(()=>e.apply(this,o),t)})}getActiveIndex(){return this.activeTurnId?this.markers.findIndex(e=>e.id===this.activeTurnId):-1}getFlowDurationMs(){try{const e=parseInt(localStorage.getItem("geminiTimelineFlowDurationMs")||"650",10);return Math.max(300,Math.min(1800,Number.isFinite(e)?e:650))}catch{return 650}}computeFlowDuration(e,t){const r=this.getFlowDurationMs();if(e<0||t<0)return r;const o=Math.abs(this.yPositions[t]-this.yPositions[e]),i=Math.max(1,this.ui.timelineBar?.clientHeight||1),s=Math.max(.6,Math.min(1.6,o/i));return Math.round(r*s)}ensureRunnerRing(){if(this.ui.trackContent&&!this.runnerRing){const e=document.createElement("div");e.className="timeline-runner-ring",Object.assign(e.style,{position:"absolute",left:"50%",width:"20px",height:"20px",transform:"translate(-50%, -50%)",borderRadius:"9999px",boxShadow:"0 0 0 2px var(--timeline-dot-active-color), 0 0 12px rgba(59,130,246,.45)",background:"transparent",pointerEvents:"none",zIndex:"4",opacity:"0",transition:"opacity 120ms ease"}),this.ui.trackContent.appendChild(e),this.runnerRing=e}}startRunner(e,t,r){if(this.ensureRunnerRing(),!this.runnerRing)return;const o=Math.round(this.yPositions[e]),i=Math.round(this.yPositions[t]),s=typeof performance<"u"&&performance.now?performance.now():Date.now();this.runnerRing.style.opacity="1";const a=()=>{const l=typeof performance<"u"&&performance.now?performance.now():Date.now(),d=Math.min(1,(l-s)/Math.max(1,r)),u=(()=>{try{return localStorage.getItem("geminiTimelineSpring")||"ios"}catch{return"ios"}})();let m;u==="snappy"?m=Math.min(1,d+.08*Math.sin(d*8)):u==="gentle"?m=d*d*(3-2*d):m=d*d*(3-2*d)*.85+d*.15;const p=Math.round(o+(i-o)*m);this.runnerRing&&(this.runnerRing.style.top=`${p}px`),d<1?(this.flowAnimating=!0,requestAnimationFrame(a)):(this.flowAnimating=!1,this.runnerRing&&(this.runnerRing.style.opacity="0"))};a()}truncateToThreeLines(e,t){if(!this.measureEl||!this.ui.tooltip)return{text:e,height:0};const r=this.ui.tooltip,o=this.getCSSVarNumber(r,"--timeline-tooltip-lh",18),i=this.getCSSVarNumber(r,"--timeline-tooltip-pad-y",10),s=this.getCSSVarNumber(r,"--timeline-tooltip-border-w",1),a=Math.round(3*o+2*i+2*s),l="â€¦",d=this.measureEl;d.style.width=`${Math.max(0,Math.floor(t))}px`,d.textContent=String(e||"").replace(/\s+/g," ").trim();let u=d.offsetHeight;if(u<=a)return{text:d.textContent,height:u};const m=d.textContent;let p=0,f=m.length,g=0;for(;p<=f;){const w=p+f>>1;d.textContent=m.slice(0,w).trimEnd()+l,u=d.offsetHeight,u<=a?(g=w,p=w+1):f=w-1}const b=g>=m.length?m:m.slice(0,g).trimEnd()+l;return d.textContent=b,u=d.offsetHeight,{text:b,height:Math.min(u,a)}}computePlacementInfo(e){const t=this.ui.tooltip||document.body,r=e.getBoundingClientRect(),o=window.innerWidth,i=this.getCSSVarNumber(t,"--timeline-tooltip-arrow-outside",6),s=this.getCSSVarNumber(t,"--timeline-tooltip-gap-visual",12),a=this.getCSSVarNumber(t,"--timeline-tooltip-gap-box",8),l=s+Math.max(0,i)+Math.max(0,a),d=8,u=this.getCSSVarNumber(t,"--timeline-tooltip-max",288),m=160,p=Math.max(0,r.left-l-d),f=Math.max(0,o-r.right-l-d);let g=f>p?"right":"left",b=g==="right"?f:p;const w=[280,240,200,160],v=Math.max(m,Math.min(u,Math.floor(b)));let S=w.find(C=>C<=v)||Math.max(m,Math.min(v,160));if(S<m&&g==="left"&&f>p){g="right",b=f;const C=Math.max(m,Math.min(u,Math.floor(b)));S=w.find(L=>L<=C)||Math.max(120,Math.min(C,m))}else if(S<m&&g==="right"&&p>=f){g="left",b=p;const C=Math.max(m,Math.min(u,Math.floor(b)));S=w.find(L=>L<=C)||Math.max(120,Math.min(C,m))}return S=Math.max(120,Math.min(S,u)),{placement:g,width:S}}showTooltipForDot(e){if(!this.ui.tooltip)return;this.tooltipHideTimer&&(clearTimeout(this.tooltipHideTimer),this.tooltipHideTimer=null);const t=this.ui.tooltip;t.classList.remove("visible");let r=(e.getAttribute("aria-label")||"").trim();const o=e.dataset.targetTurnId;o&&this.starred.has(o)&&(r=`â˜… ${r}`);const i=this.computePlacementInfo(e),s=this.truncateToThreeLines(r,i.width);t.textContent=s.text,this.placeTooltipAt(e,i.placement,i.width,s.height),t.setAttribute("aria-hidden","false"),this.showRafId!==null&&(cancelAnimationFrame(this.showRafId),this.showRafId=null),this.showRafId=requestAnimationFrame(()=>{this.showRafId=null,t.classList.add("visible")})}placeTooltipAt(e,t,r,o){if(!this.ui.tooltip)return;const i=this.ui.tooltip,s=e.getBoundingClientRect(),a=window.innerWidth,l=window.innerHeight,d=this.getCSSVarNumber(i,"--timeline-tooltip-arrow-outside",6),u=this.getCSSVarNumber(i,"--timeline-tooltip-gap-visual",12),m=this.getCSSVarNumber(i,"--timeline-tooltip-gap-box",8),p=u+Math.max(0,d)+Math.max(0,m),f=8;let g;if(t==="left"){if(g=Math.round(s.left-p-r),g<f){const v=Math.round(s.right+p);if(v+r<=a-f)t="right",g=v;else{const S=Math.max(120,a-f-v);g=v,r=S}}}else if(g=Math.round(s.right+p),g+r>a-f){const v=Math.round(s.left-p-r);v>=f?(t="left",g=v):r=Math.max(120,a-f-g)}i.style.width=`${Math.floor(r)}px`;const b=!o||o<=0?i.offsetHeight:o;let w=Math.round(s.top+s.height/2-b/2);w=Math.max(f,Math.min(l-o-f,w)),i.style.left=`${g}px`,i.style.top=`${w}px`,i.setAttribute("data-placement",t)}refreshTooltipForDot(e){if(!this.ui.tooltip)return;const t=this.ui.tooltip;if(!t.classList.contains("visible"))return;let r=(e.getAttribute("aria-label")||"").trim();const o=e.dataset.targetTurnId;o&&this.starred.has(o)&&(r=`â˜… ${r}`);const i=this.computePlacementInfo(e),s=this.truncateToThreeLines(r,i.width);t.textContent=s.text,this.placeTooltipAt(e,i.placement,i.width,s.height)}scheduleScrollSync(){this.scrollRafId===null&&(this.scrollRafId=requestAnimationFrame(()=>{this.scrollRafId=null,this.syncTimelineTrackToMain(),this.updateVirtualRangeAndRender(),this.computeActiveByScroll(),this.updateSlider()}))}computeActiveByScroll(){if(this.isScrolling||!this.scrollContainer||this.markers.length===0)return;const e=this.scrollContainer.scrollTop,t=e+this.scrollContainer.clientHeight*.45;let r=this.markers[0].id;if(this.markerTops.length===this.markers.length&&this.markerTops.length>0){const o=Math.max(0,Math.min(this.markers.length-1,this.upperBound(this.markerTops,t)));r=this.markers[o].id}else{const o=this.scrollContainer.getBoundingClientRect();for(let i=0;i<this.markers.length;i++){const s=this.markers[i];if(s.element.getBoundingClientRect().top-o.top+e<=t)r=s.id;else break}}if(this.activeTurnId!==r){const o=typeof performance<"u"&&performance.now?performance.now():Date.now(),i=o-this.lastActiveChangeTime;if(i<this.minActiveChangeInterval){if(this.pendingActiveId=r,!this.activeChangeTimer){const s=Math.max(this.minActiveChangeInterval-i,0);this.activeChangeTimer=window.setTimeout(()=>{this.activeChangeTimer=null,this.pendingActiveId&&this.pendingActiveId!==this.activeTurnId&&(this.activeTurnId=this.pendingActiveId,this.updateActiveDotUI(),this.lastActiveChangeTime=typeof performance<"u"&&performance.now?performance.now():Date.now()),this.pendingActiveId=null},s)}}else this.activeTurnId=r,this.updateActiveDotUI(),this.lastActiveChangeTime=o}}syncTimelineTrackToMain(){if(this.sliderDragging||!this.ui.track||!this.scrollContainer||!this.contentHeight)return;const t=this.scrollContainer.scrollTop+this.scrollContainer.clientHeight*.45,r=Math.max(1,this.contentSpanPx||1),o=Math.max(0,Math.min(1,(t-(this.firstUserTurnOffset||0))/r)),i=Math.max(0,this.contentHeight-(this.ui.track.clientHeight||0)),s=Math.round(o*i);Math.abs((this.ui.track.scrollTop||0)-s)>1&&(this.ui.track.scrollTop=s)}lowerBound(e,t){let r=0,o=e.length;for(;r<o;){const i=r+o>>1;e[i]<t?r=i+1:o=i}return r}upperBound(e,t){let r=0,o=e.length;for(;r<o;){const i=r+o>>1;e[i]<=t?r=i+1:o=i}return r-1}updateVirtualRangeAndRender(){const e=this.markersVersion;if(!this.ui.track||!this.ui.trackContent||this.markers.length===0)return;const t=this.ui.track.scrollTop||0,r=this.ui.track.clientHeight||0,o=Math.max(100,r),i=t-o,s=t+r+o,a=this.lowerBound(this.yPositions,i),l=Math.max(a-1,this.upperBound(this.yPositions,s)),d=this.getHiddenMarkerIndices();let u=this.visibleRange.start,m=this.visibleRange.end;const p=this.markers.length;if(p>0&&(u=Math.max(0,Math.min(u,p-1)),m=Math.max(-1,Math.min(m,p-1))),m>=u){for(let g=u;g<Math.min(a,m+1);g++){const b=this.markers[g];b&&b.dotElement&&(b.dotElement.remove(),b.dotElement=null)}for(let g=Math.max(l+1,u);g<=m;g++){const b=this.markers[g];b&&b.dotElement&&(b.dotElement.remove(),b.dotElement=null)}}else(this.ui.trackContent||this.ui.timelineBar).querySelectorAll(".timeline-dot").forEach(g=>g.remove()),this.markers.forEach(g=>{g.dotElement=null});const f=document.createDocumentFragment();for(let g=a;g<=l;g++){const b=this.markers[g];if(!b)continue;if(d.has(g)){b.dotElement&&(b.dotElement.remove(),b.dotElement=null);continue}const w=this.isMarkerCollapsed(b.id);if(b.dotElement){b.dotElement.dataset.markerIndex=String(g),b.dotElement.style.setProperty("--n",String(b.n||0)),this.usePixelTop&&(b.dotElement.style.top=`${Math.round(this.yPositions[g])}px`),b.dotElement.classList.toggle("starred",!!b.starred),b.dotElement.classList.toggle("collapsed",w),b.dotElement.setAttribute("aria-pressed",b.starred?"true":"false"),b.dotElement.setAttribute("aria-expanded",w?"false":"true");const v=this.getMarkerLevel(b.id);b.dotElement.setAttribute("data-level",String(v))}else{const v=document.createElement("button");v.className="timeline-dot",v.dataset.targetTurnId=b.id,v.dataset.markerIndex=String(g),v.setAttribute("aria-label",b.summary),v.setAttribute("tabindex","0"),v.setAttribute("aria-describedby","gemini-timeline-tooltip"),v.style.setProperty("--n",String(b.n||0)),this.usePixelTop&&(v.style.top=`${Math.round(this.yPositions[g])}px`),v.classList.toggle("active",b.id===this.activeTurnId),v.classList.toggle("starred",!!b.starred),v.classList.toggle("collapsed",w),v.setAttribute("aria-pressed",b.starred?"true":"false"),v.setAttribute("aria-expanded",w?"false":"true");const S=this.getMarkerLevel(b.id);v.setAttribute("data-level",String(S)),b.dotElement=v,f.appendChild(v)}}e===this.markersVersion&&(f.childNodes.length&&this.ui.trackContent.appendChild(f),this.visibleRange={start:a,end:l},this.updateSlider())}updateSlider(){if(!this.ui.slider||!this.ui.sliderHandle||!this.contentHeight||!this.ui.timelineBar||!this.ui.track)return;const e=this.ui.timelineBar.getBoundingClientRect(),t=e.height||0,r=this.getTrackPadding(),o=Math.max(0,t-2*r);if(this.contentHeight<=t+1||o<=0){this.sliderAlwaysVisible=!1,this.ui.slider.classList.remove("visible"),this.ui.slider.style.opacity="";return}this.sliderAlwaysVisible=!0;const i=Math.max(120,Math.min(240,Math.floor(t*.45))),s=Math.round(e.top+r+(o-i)/2),d=Math.round(e.left-8-12);this.ui.slider.style.left=`${d}px`,this.ui.slider.style.top=`${s}px`,this.ui.slider.style.height=`${i}px`;const u=22,m=Math.max(0,i-u),p=Math.max(1,this.contentHeight-t),f=this.ui.track.scrollTop||0,g=Math.max(0,Math.min(1,f/p)),b=Math.round(g*m);this.ui.sliderHandle.style.height=`${u}px`,this.ui.sliderHandle.style.top=`${b}px`,this.ui.slider.classList.add("visible"),this.ui.slider.style.opacity=""}showSlider(){this.ui.slider&&(this.ui.slider.classList.add("visible"),this.sliderFadeTimer&&(clearTimeout(this.sliderFadeTimer),this.sliderFadeTimer=null),this.updateSlider())}hideSliderDeferred(){this.sliderDragging||this.sliderAlwaysVisible||(this.sliderFadeTimer&&clearTimeout(this.sliderFadeTimer),this.sliderFadeTimer=window.setTimeout(()=>{this.sliderFadeTimer=null,this.ui.slider?.classList.remove("visible")},this.sliderFadeDelay))}handleSliderDrag(e){if(!this.sliderDragging||!this.ui.timelineBar||!this.ui.track)return;const r=this.ui.timelineBar.getBoundingClientRect().height||0,o=parseFloat(this.ui.slider.style.height||"0")||Math.max(120,Math.min(240,Math.floor(r*.45))),i=this.ui.sliderHandle.getBoundingClientRect().height||22,s=Math.max(0,o-i),a=e.clientY-this.sliderStartClientY;let l=Math.max(0,Math.min(s,this.sliderStartTop+a-(parseFloat(this.ui.slider.style.top)||0)));const d=s>0?l/s:0,u=Math.max(1,this.contentHeight-r);this.ui.track.scrollTop=Math.round(d*u),this.updateVirtualRangeAndRender(),this.showSlider(),this.updateSlider()}endSliderDrag(e){this.sliderDragging=!1;try{window.removeEventListener("pointermove",this.onSliderMove)}catch{}this.onSliderMove=null,this.onSliderUp=null,this.hideSliderDeferred()}toggleDraggable(e){this.draggable=e,!(!this.ui.timelineBar||!this.onBarPointerDown)&&(this.draggable?(this.ui.timelineBar.addEventListener("pointerdown",this.onBarPointerDown),this.ui.timelineBar.style.cursor="move"):(this.ui.timelineBar.removeEventListener("pointerdown",this.onBarPointerDown),this.ui.timelineBar.style.cursor="default"))}toggleMarkerLevel(e){this.markerLevelEnabled=e,e||this.hideContextMenu(),this.updateTimelineGeometry(),this.updateVirtualRangeAndRender()}handleBarDrag(e){if(!this.barDragging)return;const t=e.clientX-this.barStartPos.x,r=e.clientY-this.barStartPos.y;this.ui.timelineBar.style.left=`${this.barStartOffset.x+t}px`,this.ui.timelineBar.style.top=`${this.barStartOffset.y+r}px`}endBarDrag(e){this.barDragging=!1,this.savePosition(),window.removeEventListener("pointermove",this.onBarPointerMove)}savePosition(){if(!this.ui.timelineBar)return;const e=this.ui.timelineBar.getBoundingClientRect(),t=window.innerWidth,r=window.innerHeight,o={version:2,topPercent:e.top/r*100,leftPercent:e.left/t*100},i=globalThis;i.chrome?.storage?.sync?.set?i.chrome.storage.sync.set({geminiTimelinePosition:o}):i.browser?.storage?.sync?.set&&i.browser.storage.sync.set({geminiTimelinePosition:o})}applyPosition(e,t){if(!this.ui.timelineBar)return;const r=this.ui.timelineBar.offsetWidth||24,o=this.ui.timelineBar.offsetHeight||100,i=window.innerWidth,s=window.innerHeight,a=10,l=Math.max(a,Math.min(e,s-o-a)),d=Math.max(a,Math.min(t,i-r-a));this.ui.timelineBar.style.top=`${l}px`,this.ui.timelineBar.style.left=`${d}px`}async reapplyPosition(){if(!this.ui.timelineBar)return;const e=globalThis;if(!e.chrome?.storage?.sync&&!e.browser?.storage?.sync)return;let t=null;try{t=await new Promise(s=>{e.chrome?.storage?.sync?.get?e.chrome.storage.sync.get(["geminiTimelinePosition"],a=>{e.chrome.runtime?.lastError?(console.error(`[Timeline] chrome.storage.get failed: ${e.chrome.runtime.lastError.message}`),s(null)):s(a)}):e.browser.storage.sync.get(["geminiTimelinePosition"]).then(s).catch(a=>{console.error(`[Timeline] browser.storage.get failed: ${a.message}`),s(null)})})}catch(s){console.error("[Timeline] reapplyPosition storage access failed:",s);return}const r=t?.geminiTimelinePosition;if(!r)return;const o=window.innerWidth,i=window.innerHeight;if(r.version===2&&r.topPercent!==void 0&&r.leftPercent!==void 0){const s=r.topPercent/100*i,a=r.leftPercent/100*o;this.applyPosition(s,a)}else r.top!==void 0&&r.left!==void 0&&this.applyPosition(r.top,r.left)}hideTooltip(e=!1){if(!this.ui.tooltip)return;const t=()=>{this.ui.tooltip.classList.remove("visible"),this.ui.tooltip.setAttribute("aria-hidden","true"),this.tooltipHideTimer=null};if(e)return t();this.tooltipHideTimer&&clearTimeout(this.tooltipHideTimer),this.tooltipHideTimer=window.setTimeout(t,this.tooltipHideDelay)}async toggleStar(e){const t=String(e||"");if(!t)return;const r=this.starred.has(t);if(r?this.starred.delete(t):this.starred.add(t),this.saveStars(),r)await Zo.removeStarredMessage(this.conversationId,t);else{const i=this.markerMap.get(t);if(i){const s=this.getConversationTitle(),a={turnId:t,content:i.summary,conversationId:this.conversationId,conversationUrl:window.location.href,conversationTitle:s,starredAt:Date.now()};await Zo.addStarredMessage(a)}}const o=this.starred.has(t);this.markers.forEach(i=>{i.id===t&&(i.starred=o,i.dotElement&&(i.dotElement.classList.toggle("starred",o),i.dotElement.setAttribute("aria-pressed",o?"true":"false"),this.refreshTooltipForDot(i.dotElement)))})}saveStars(){const e=this.getStarsStorageKey();e&&this.safeLocalStorageSet(e,JSON.stringify(Array.from(this.starred)))}async loadStars(){this.starred.clear();const e=this.getStarsStorageKey();if(!e)return;const t=this.safeLocalStorageGet(e);if(t)try{const r=JSON.parse(t);Array.isArray(r)&&r.forEach(o=>this.starred.add(String(o)))}catch(r){console.warn("[Timeline] Failed to parse starred messages:",r)}}getLevelsStorageKey(){return this.conversationId?`geminiTimelineLevels:${this.conversationId}`:null}loadMarkerLevels(){this.markerLevels.clear();const e=this.getLevelsStorageKey();if(!e)return;const t=this.safeLocalStorageGet(e);if(t)try{const r=JSON.parse(t);r&&typeof r=="object"&&Object.entries(r).forEach(([o,i])=>{typeof i=="number"&&i>=1&&i<=4&&this.markerLevels.set(o,i)})}catch(r){console.warn("[Timeline] Failed to parse marker levels:",r)}}saveMarkerLevels(){const e=this.getLevelsStorageKey();if(!e)return;const t={};this.markerLevels.forEach((r,o)=>{t[o]=r}),this.safeLocalStorageSet(e,JSON.stringify(t))}getCollapsedStorageKey(){return this.conversationId?`geminiTimelineCollapsed:${this.conversationId}`:null}loadCollapsedMarkers(){this.collapsedMarkers.clear();const e=this.getCollapsedStorageKey();if(!e)return;const t=this.safeLocalStorageGet(e);if(t)try{const r=JSON.parse(t);Array.isArray(r)&&r.forEach(o=>this.collapsedMarkers.add(String(o)))}catch(r){console.warn("[Timeline] Failed to parse collapsed markers:",r)}}saveCollapsedMarkers(){const e=this.getCollapsedStorageKey();e&&this.safeLocalStorageSet(e,JSON.stringify(Array.from(this.collapsedMarkers)))}isMarkerCollapsed(e){return this.collapsedMarkers.has(e)}toggleCollapse(e){this.collapsedMarkers.has(e)?this.collapsedMarkers.delete(e):this.collapsedMarkers.add(e),this.saveCollapsedMarkers(),this.updateTimelineGeometry(),this.updateVirtualRangeAndRender()}getHiddenMarkerIndices(){const e=new Set;if(!this.markerLevelEnabled)return e;for(let t=0;t<this.markers.length;t++){if(e.has(t))continue;const r=this.markers[t],o=this.getMarkerLevel(r.id);if(this.collapsedMarkers.has(r.id))for(let i=t+1;i<this.markers.length;i++){const s=this.markers[i];if(this.getMarkerLevel(s.id)<=o)break;e.add(i)}}return e}calculateEffectiveBaseN(e,t){const r=this.markers[e];if(!r)return 0;const o=r.baseN??r.n??0;if(!this.collapsedMarkers.has(r.id))return o;const i=this.getMarkerLevel(r.id);let s=0;for(let a=e+1;a<this.markers.length;a++){const l=this.markers[a],d=this.getMarkerLevel(l.id);if(d<=i)break;const u=l.baseN??l.n??0,m=a>0?this.markers[a-1].baseN??this.markers[a-1].n??0:0,p=u-m,f=d-i;s+=p*Math.pow(.5,f)}return o+s}calculateCollapsedPositions(e,t,r){const o=this.markers.length,i=new Array(o).fill(-1),s=new Array(o).fill(0),a=[];for(let m=0;m<o;m++){if(e.has(m))continue;const p=this.calculateEffectiveBaseN(m,e);s[m]=p,a.push({index:m,effectiveN:p})}if(a.sort((m,p)=>m.effectiveN-p.effectiveN),a.length===0)return{desiredY:i,effectiveBaseNs:s};const l=a[0].effectiveN,u=a[a.length-1].effectiveN-l;for(const m of a){let p;u>0?p=(m.effectiveN-l)/u:p=a.indexOf(m)/Math.max(1,a.length-1),i[m.index]=t+p*r}return{desiredY:i,effectiveBaseNs:s}}canCollapseMarker(e){const t=this.markers.findIndex(s=>s.id===e);if(t<0||t>=this.markers.length-1)return!1;const r=this.getMarkerLevel(e),o=this.markers[t+1];return o?this.getMarkerLevel(o.id)>r:!1}getMarkerLevel(e){return this.markerLevels.get(e)||1}setMarkerLevel(e,t){t===1?this.markerLevels.delete(e):this.markerLevels.set(e,t),this.saveMarkerLevels(),this.markers.forEach(r=>{r.id===e&&r.dotElement&&r.dotElement.setAttribute("data-level",String(t))})}showContextMenu(e,t,r){this.hideContextMenu();const o=e.dataset.targetTurnId;if(!o)return;const i=this.getMarkerLevel(o),s=this.isMarkerCollapsed(o),a=this.canCollapseMarker(o),l=document.createElement("div");l.className="timeline-context-menu";const d=document.createElement("div");if(d.className="timeline-context-menu-title",d.textContent=Ke("timelineLevelTitle"),l.appendChild(d),[{level:1,label:Ke("timelineLevel1")},{level:2,label:Ke("timelineLevel2")},{level:3,label:Ke("timelineLevel3")}].forEach(({level:v,label:S})=>{const C=document.createElement("button");C.className="timeline-context-menu-item",v===i&&C.classList.add("active"),C.setAttribute("data-level",String(v));const L=document.createElement("span");L.className="level-indicator";const I=document.createElement("span");I.className="level-dot",L.appendChild(I),C.appendChild(L);const R=document.createElement("span");if(R.textContent=S,C.appendChild(R),v===i){const F=document.createElement("span");F.className="check-icon",F.textContent="âœ“",C.appendChild(F)}C.addEventListener("click",F=>{F.preventDefault(),F.stopPropagation(),this.setMarkerLevel(o,v),this.hideContextMenu()}),l.appendChild(C)}),a||s){const v=document.createElement("div");v.className="timeline-context-menu-separator",l.appendChild(v);const S=document.createElement("button");S.className="timeline-context-menu-item collapse-item";const C=document.createElement("span");C.className="collapse-icon",C.textContent=s?"â–¶":"â–¼",S.appendChild(C);const L=document.createElement("span");L.textContent=s?Ke("timelineExpand"):Ke("timelineCollapse"),S.appendChild(L),S.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation(),this.toggleCollapse(o),this.hideContextMenu()}),l.appendChild(S)}const m=window.innerWidth,p=window.innerHeight;document.body.appendChild(l),this.contextMenu=l;const f=l.offsetWidth,g=l.offsetHeight;let b=t,w=r;b+f>m-10&&(b=m-f-10),w+g>p-10&&(w=p-g-10),l.style.left=`${b}px`,l.style.top=`${w}px`,document.body.appendChild(l),this.contextMenu=l}hideContextMenu(){this.contextMenu&&(this.contextMenu.remove(),this.contextMenu=null)}cancelLongPress(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.pressTargetDot&&this.pressTargetDot.classList.remove("holding"),this.pressTargetDot=null,this.pressStartPos=null,this.longPressTriggered=!1}async initKeyboardShortcuts(){try{await ia.init(),this.shortcutUnsubscribe=ia.on((e,t)=>{e==="timeline:previous"?this.enqueueNavigation("previous",t.repeat):e==="timeline:next"&&this.enqueueNavigation("next",t.repeat)})}catch(e){console.warn("[Timeline] Failed to initialize keyboard shortcuts:",e)}}enqueueNavigation(e,t=!1){t&&this.navigationQueue.length>0||this.navigationQueue.length>=3||this.canEnqueueNavigation(e)&&(this.navigationQueue.push(e),this.processNavigationQueue())}canEnqueueNavigation(e){if(this.markers.length===0)return!1;const t=this.getActiveIndex();if(t<0)return!0;const r=t===0,o=t===this.markers.length-1;return e==="previous"&&r||e==="next"&&o?this.shouldAttemptRefreshForNavigation():!0}shouldAttemptRefreshForNavigation(){if(!this.userTurnSelector)return!1;const e=document.querySelectorAll(this.userTurnSelector).length;return(this.conversationContainer?!this.conversationContainer.isConnected:!0)||(this.scrollContainer?!this.scrollContainer.isConnected:!0)||e>this.markers.length}async processNavigationQueue(){if(this.isNavigating||this.navigationQueue.length===0)return;this.isNavigating=!0,this.navigationQueue.shift()==="previous"?await this.navigateToPreviousNode():await this.navigateToNextNode(),this.isNavigating=!1,this.navigationQueue.length>0&&this.processNavigationQueue()}async performNodeNavigation(e,t){if(e<0||e>=this.markers.length)return;this.activeChangeTimer&&(clearTimeout(this.activeChangeTimer),this.activeChangeTimer=null,this.pendingActiveId=null);const r=this.markers[e];if(r?.element){if(this.scrollMode==="flow"&&t>=0){const o=this.computeFlowDuration(t,e);this.startRunner(t,e,o),this.smoothScrollTo(r.element,o),await new Promise(i=>setTimeout(i,o))}else this.smoothScrollTo(r.element,0);this.activeTurnId=r.id,this.updateActiveDotUI()}}async navigateToPreviousNode(){if(this.markers.length===0)return;this.maybeRefreshMarkersForNavigation("previous");const e=this.getActiveIndex(),t=e<=0?0:e-1;await this.performNodeNavigation(t,e)}async navigateToNextNode(){if(this.markers.length===0)return;this.maybeRefreshMarkersForNavigation("next");const e=this.getActiveIndex(),t=e<0?0:Math.min(e+1,this.markers.length-1);await this.performNodeNavigation(t,e)}maybeRefreshMarkersForNavigation(e){if(!this.userTurnSelector)return;const t=this.getActiveIndex(),r=t===0,o=t>=0&&t===this.markers.length-1;!(e==="previous"&&r||e==="next"&&o)||!this.shouldAttemptRefreshForNavigation()||!this.refreshCriticalElementsFromDocument()||this.recalculateAndRenderMarkers()}refreshCriticalElementsFromDocument(){if(!this.userTurnSelector)return!1;const e=document.querySelector(this.userTurnSelector);if(!e)return!1;const t=document.querySelector("main")||document.body;this.conversationContainer=t;let r=null,o=e;for(;o&&o!==document.body;){const s=getComputedStyle(o);if(s.overflowY==="auto"||s.overflowY==="scroll"){r=o;break}o=o.parentElement}if(r||(r=document.scrollingElement||document.documentElement||document.body),this.scrollContainer!==r){if(this.scrollContainer&&this.onScroll)try{this.scrollContainer.removeEventListener("scroll",this.onScroll)}catch{}this.scrollContainer=r,this.scrollContainer&&this.onScroll&&this.scrollContainer.addEventListener("scroll",this.onScroll,{passive:!0})}if(this.mutationObserver&&this.conversationContainer)try{this.mutationObserver.disconnect(),this.mutationObserver.observe(this.conversationContainer,{childList:!0,subtree:!0})}catch{}if(this.intersectionObserver&&this.scrollContainer)try{this.intersectionObserver.disconnect(),this.intersectionObserver=new IntersectionObserver(()=>{this.scheduleScrollSync()},{root:this.scrollContainer,threshold:.1,rootMargin:"-40% 0px -59% 0px"})}catch{}return!0}handleStarredMessageNavigation(){try{const e=window.location.hash;if(!e.startsWith("#gv-turn-"))return;const t=e.replace("#gv-turn-","");if(!t)return;console.log("[Timeline] Handling starred message navigation, turnId:",t);let r=0;const o=20,i=()=>{if(this.markers.length===0)return!1;const a=this.markerMap.get(t);return a&&a.element?(console.log("[Timeline] Found target marker, scrolling"),setTimeout(()=>{this.smoothScrollTo(a.element,800),setTimeout(()=>{window.history.replaceState(null,"",window.location.pathname+window.location.search)},900)},100),!0):!1},s=()=>{if(i())return;if(r++,r>=o){console.warn("[Timeline] Failed to find starred message"),window.history.replaceState(null,"",window.location.pathname+window.location.search);return}const a=Math.min(r*100,300);setTimeout(s,a)};if(this.markers.length>0&&i())return;setTimeout(s,200)}catch(e){console.error("[Timeline] Failed to handle starred message navigation:",e)}}destroy(){if(this.shortcutUnsubscribe)try{this.shortcutUnsubscribe(),this.shortcutUnsubscribe=null}catch(e){console.error("[Timeline] Failed to unsubscribe from keyboard shortcuts:",e)}this.navigationQueue=[],this.isNavigating=!1,this.eventBusUnsubscribers.forEach(e=>{try{e()}catch(t){console.error("[Timeline] Failed to unsubscribe from EventBus:",t)}}),this.eventBusUnsubscribers=[];try{this.toggleDraggable(!1)}catch{}try{this.onBarPointerMove&&window.removeEventListener("pointermove",this.onBarPointerMove)}catch{}try{this.onBarPointerUp&&window.removeEventListener("pointerup",this.onBarPointerUp)}catch{}try{this.mutationObserver?.disconnect()}catch{}try{this.resizeObserver?.disconnect()}catch{}try{this.intersectionObserver?.disconnect()}catch{}if(this.visibleUserTurns.clear(),this.ui.timelineBar&&this.onTimelineBarClick)try{this.ui.timelineBar.removeEventListener("click",this.onTimelineBarClick)}catch{}try{window.removeEventListener("storage",this.onStorage)}catch{}if(this.onChromeStorageChanged&&typeof chrome<"u"&&chrome.storage?.onChanged){try{chrome.storage.onChanged.removeListener(this.onChromeStorageChanged)}catch{}this.onChromeStorageChanged=null}this.hideContextMenu();try{this.ui.timelineBar?.removeEventListener("contextmenu",this.onContextMenu)}catch{}try{document.removeEventListener("click",this.onDocumentClick)}catch{}try{this.ui.timelineBar?.removeEventListener("pointerdown",this.onPointerDown)}catch{}try{window.removeEventListener("pointermove",this.onPointerMove)}catch{}try{window.removeEventListener("pointerup",this.onPointerUp)}catch{}try{window.removeEventListener("pointercancel",this.onPointerCancel)}catch{}try{this.ui.timelineBar?.removeEventListener("pointerleave",this.onPointerLeave)}catch{}if(this.scrollContainer&&this.onScroll)try{this.scrollContainer.removeEventListener("scroll",this.onScroll)}catch{}if(this.ui.timelineBar){try{this.ui.timelineBar.removeEventListener("wheel",this.onTimelineWheel)}catch{}try{this.ui.timelineBar.removeEventListener("pointerenter",this.onBarEnter)}catch{}try{this.ui.timelineBar.removeEventListener("pointerleave",this.onBarLeave)}catch{}try{this.ui.slider?.removeEventListener("pointerenter",this.onSliderEnter)}catch{}try{this.ui.slider?.removeEventListener("pointerleave",this.onSliderLeave)}catch{}}try{this.ui.sliderHandle?.removeEventListener("pointerdown",this.onSliderDown)}catch{}try{window.removeEventListener("resize",this.onWindowResize)}catch{}if(this.onVisualViewportResize&&window.visualViewport){try{window.visualViewport.removeEventListener("resize",this.onVisualViewportResize)}catch{}this.onVisualViewportResize=null}if(this.scrollRafId!==null){try{cancelAnimationFrame(this.scrollRafId)}catch{}this.scrollRafId=null}try{this.ui.timelineBar?.remove()}catch{}try{this.ui.tooltip?.remove()}catch{}try{this.measureEl?.remove()}catch{}try{this.ui.slider&&(this.ui.slider.style.pointerEvents="none",this.ui.slider.remove());const e=document.querySelector(".timeline-left-slider");e&&(e.style.pointerEvents="none",e.remove())}catch{}this.ui.slider=null,this.ui.sliderHandle=null,this.ui={timelineBar:null,tooltip:null},this.markers=[],this.markerTops=[],this.activeTurnId=null,this.scrollContainer=null,this.conversationContainer=null,this.activeChangeTimer&&(clearTimeout(this.activeChangeTimer),this.activeChangeTimer=null),this.tooltipHideTimer&&(clearTimeout(this.tooltipHideTimer),this.tooltipHideTimer=null),this.resizeIdleTimer&&(clearTimeout(this.resizeIdleTimer),this.resizeIdleTimer=null);try{this.resizeIdleRICId&&window.cancelIdleCallback&&(window.cancelIdleCallback(this.resizeIdleRICId),this.resizeIdleRICId=null)}catch{}this.sliderFadeTimer&&(clearTimeout(this.sliderFadeTimer),this.sliderFadeTimer=null),this.pendingActiveId=null}}function Dd(n=location.pathname){return/^\/(?:u\/\d+\/)?(app|gem)(\/|$)/.test(n)}let un=null,_s=location.href,Zl=location.pathname+location.search,Co=null,ks=!1,Pr=[],Po=[],bo=!1,Sr=null,Er=null;function Md(){if(un){try{un.destroy()}catch{}un=null}try{document.querySelector(".gemini-timeline-bar")?.remove()}catch{}try{document.querySelector(".timeline-left-slider")?.remove()}catch{}try{document.getElementById("gemini-timeline-tooltip")?.remove()}catch{}un=new Kb,un.init().catch(n=>console.error("Timeline initialization failed:",n))}let Sn=null;function _n(){if(location.href===_s)return;const n=location.pathname+location.search,e=n!==Zl;if(_s=location.href,!e){console.log("[Timeline] Only hash changed, keeping existing timeline");return}if(Zl=n,Sn&&(clearTimeout(Sn),Sn=null),Dd())console.log("[Timeline] URL changed to conversation route, scheduling initialization"),Sn=window.setTimeout(()=>{console.log("[Timeline] Initializing timeline after URL change"),Md(),Sn=null},500);else{if(console.log("[Timeline] URL changed to non-conversation route, cleaning up"),un){try{un.destroy()}catch{}un=null}try{document.querySelector(".gemini-timeline-bar")?.remove()}catch{}try{document.querySelector(".timeline-left-slider")?.remove()}catch{}try{document.getElementById("gemini-timeline-tooltip")?.remove()}catch{}}}function Zb(){if(!bo)try{Sr=history.pushState,Er=history.replaceState,history.pushState=(...n)=>{Sr?.apply(history,n),_n()},history.replaceState=(...n)=>{Er?.apply(history,n),_n()},bo=!0,Po.push(()=>{bo&&(Sr&&(history.pushState=Sr),Er&&(history.replaceState=Er),bo=!1,Sr=null,Er=null)})}catch(n){console.warn("[Timeline] Failed to patch history API:",n)}}function Xb(){ks||(ks=!0,Zb(),window.addEventListener("popstate",_n),window.addEventListener("hashchange",_n),Co=window.setInterval(()=>{location.href!==_s&&_n()},800),Po.push(()=>{window.removeEventListener("popstate",_n),window.removeEventListener("hashchange",_n)}))}function Xl(){Sn&&(clearTimeout(Sn),Sn=null),Pr.forEach(n=>{try{n.disconnect()}catch(e){console.error("[Gemini Voyager] Failed to disconnect observer during cleanup:",e)}}),Pr=[],Co!==null&&(clearInterval(Co),Co=null),Po.forEach(n=>{try{n()}catch(e){console.error("[Gemini Voyager] Failed to run cleanup handler:",e)}}),Po=[],ks=!1}function Jb(){const n=()=>{Xb(),Dd()&&!un&&Md()};if(document.body)n();else{const e=new MutationObserver(()=>{document.body&&(e.disconnect(),Pr=Pr.filter(t=>t!==e),n())});Pr.push(e),e.observe(document.documentElement||document.body,{childList:!0,subtree:!0})}window.addEventListener("beforeunload",Xl,{once:!0}),typeof chrome<"u"&&chrome.runtime&&chrome.runtime.onSuspend?.addListener?.(Xl)}let To="",Ri="",Hn=null;async function Qb(){const{gvTabTitleUpdateEnabled:n}=await chrome.storage.sync.get({gvTabTitleUpdateEnabled:!0});if(!n)return;Ri=location.href;let e=null;const t=()=>{e||(e=setTimeout(()=>{e=null,Pi()},500))},r=()=>{location.href!==Ri&&(Ri=location.href,To="",o(),Pi())},o=()=>{Hn&&Hn.disconnect();const a=document.querySelector("top-bar-actions")||document.querySelector(".conversation-title-container")||document.querySelector("header");if(!a){Hn=new MutationObserver(()=>{(document.querySelector("top-bar-actions")||document.querySelector("header"))&&o()}),Hn.observe(document.body,{childList:!0,subtree:!0});return}Hn=new MutationObserver(t),Hn.observe(a,{childList:!0,subtree:!0,characterData:!0})},i=history.pushState.bind(history),s=history.replaceState.bind(history);history.pushState=(...a)=>{i(...a),r()},history.replaceState=(...a)=>{s(...a),r()},window.addEventListener("popstate",r),o(),Pi()}function Pi(){const n=ev();if(!n){document.title!=="Google Gemini"&&(document.title="Google Gemini",To="");return}n!==To&&(document.title=`${n} - Gemini`,To=n)}function ev(){if(!/^(?:\/u\/\d+)?\/(?:app|gem\/[a-zA-Z0-9%\-_]+)\/[a-zA-Z0-9%\-_]+/.test(location.pathname))return null;const n=document.querySelector(".conversation-title-container .conversation-title.gds-title-m, top-bar-actions .conversation-title.gds-title-m, .top-bar-actions .conversation-title.gds-title-m");if(n){const e=n.textContent?.trim();if(e&&e!=="New chat"&&e!=="Gemini"&&e!=="Google Gemini")return e}return null}const As='mat-icon[fonticon="download"], .google-symbols[data-mat-icon-name="download"]',tv="generated-image, .generated-image-container";function nv(n){return n.closest(tv)!==null}function rv(n){if(!(n instanceof Element)||!nv(n))return null;const e=n.closest('button[data-test-id="download-generated-image-button"]');if(e)return e;const t=n.closest("download-generated-image-button button");if(t)return t;const o=n.closest(As)?.closest("button");if(o)return o;const i=n.closest("button");return i&&i.querySelector(As)?i:null}const Jl="gv-status-toast-style",ov="gv-status-toast-container",iv=["info","warning","success","error"];function sv(n={}){const e=n.containerId??ov,t=n.anchorTtlMs??8e3,r=n.maxToasts??4,o=[];let i=null,s=0,a=null;const l=()=>{if(document.getElementById(Jl))return;const I=document.createElement("style");I.id=Jl,I.textContent=`
.gv-status-toast-container {
  position: fixed;
  z-index: 2147483647;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
  max-width: min(380px, calc(100vw - 32px));
  /* Ensure it floats above everything */
  isolation: isolate;
}

.gv-status-toast {
  pointer-events: auto;
  font-family: "Google Sans", Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 14px;
  font-weight: 500;
  line-height: 1.5;
  padding: 12px 16px;
  border-radius: 12px;
  
  /* Light Mode Default */
  background: rgba(255, 255, 255, 0.95);
  color: #1f2937;
  border: 1px solid rgba(226, 232, 240, 0.8);
  box-shadow: 
    0 4px 6px -1px rgba(0, 0, 0, 0.1), 
    0 2px 4px -1px rgba(0, 0, 0, 0.06),
    0 0 0 1px rgba(0,0,0,0.02);
  
  opacity: 0;
  transform: translateY(8px) scale(0.98);
  transition: 
    opacity 200ms cubic-bezier(0.16, 1, 0.3, 1), 
    transform 200ms cubic-bezier(0.16, 1, 0.3, 1),
    background-color 200ms, border-color 200ms, color 200ms;
    
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  
  display: flex;
  align-items: center;
  gap: 12px;
  width: fit-content;
}

.gv-status-toast.show {
  opacity: 1;
  transform: translateY(0) scale(1);
}

/* Status Indicators via Left Border & Emoji */
.gv-status-toast--info {
  border-left: 4px solid #3b82f6; 
}
.gv-status-toast--info::before {
  content: "â„¹ï¸";
}

.gv-status-toast--warning {
  border-left: 4px solid #f59e0b;
}
.gv-status-toast--warning::before {
  content: "âš ï¸";
}

.gv-status-toast--success {
  border-left: 4px solid #22c55e;
}
.gv-status-toast--success::before {
  content: "âœ…";
}

.gv-status-toast--error {
  border-left: 4px solid #ef4444;
}
.gv-status-toast--error::before {
  content: "âŒ";
}

/* Dark Mode Support (System & Class-based) */
@media (prefers-color-scheme: dark) {
  .gv-status-toast {
    background: rgba(30, 41, 59, 0.95);
    color: #f1f5f9;
    border-color: rgba(51, 65, 85, 0.8);
    box-shadow: 
      0 10px 15px -3px rgba(0, 0, 0, 0.5), 
      0 4px 6px -4px rgba(0, 0, 0, 0.5),
      0 0 0 1px rgba(255,255,255,0.05);
  }
}

/* Explicit .dark class support (if Gemini adds it to body) */
body.dark .gv-status-toast, 
html.dark .gv-status-toast {
  background: rgba(30, 41, 59, 0.95);
  color: #f1f5f9;
  border-color: rgba(51, 65, 85, 0.8);
  box-shadow: 
    0 10px 15px -3px rgba(0, 0, 0, 0.5), 
    0 4px 6px -4px rgba(0, 0, 0, 0.5),
    0 0 0 1px rgba(255,255,255,0.05);
}
`,document.head.appendChild(I)},d=()=>{const I=document.getElementById(e);if(I instanceof HTMLDivElement)return I;const R=document.createElement("div");return R.id=e,R.className="gv-status-toast-container",document.body.appendChild(R),R},u=()=>!i||!i.isConnected||Date.now()-s>t?null:i.getBoundingClientRect(),m=()=>{a===null&&(a=window.requestAnimationFrame(()=>{a=null,p()}))},p=()=>{const I=d(),R=u();if(!R){I.style.right="24px",I.style.bottom="80px",I.style.left="auto",I.style.top="auto";return}const F=I.getBoundingClientRect(),W=52,B=F.width||I.offsetWidth||300,ne=F.height||I.offsetHeight||Math.max(W,o.length*W+(o.length-1)*10),he=14,D=12;let G=R.right+he;G+B+D>window.innerWidth&&(G=R.left-he-B),G=Math.max(D,Math.min(G,window.innerWidth-B-D));let Y=R.top+R.height/2-ne/2;Y=Math.max(D,Math.min(Y,window.innerHeight-ne-D)),I.style.left=`${G}px`,I.style.top=`${Y}px`,I.style.right="auto",I.style.bottom="auto"},f=(I,R)=>{I.classList.remove(...iv.map(F=>`gv-status-toast--${F}`)),I.classList.add(`gv-status-toast--${R}`)},g=I=>{I.timeoutId&&(clearTimeout(I.timeoutId),I.timeoutId=null),I.element.remove();const R=o.findIndex(F=>F.id===I.id);R>=0&&o.splice(R,1),m()},b=(I,R)=>{I.timeoutId&&clearTimeout(I.timeoutId),I.timeoutId=setTimeout(()=>g(I),R)};return{addToast:(I,R,F={})=>{l();const W=d(),B=document.createElement("div");B.className="gv-status-toast",B.textContent=I,f(B,R),W.appendChild(B);const ne=`gv-toast-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,he={id:ne,element:B,isFinal:!F.pending,timeoutId:null};return o.push(he),B.addEventListener("click",()=>g(he)),o.length>r&&g(o[0]),window.requestAnimationFrame(()=>B.classList.add("show")),m(),F.autoDismissMs&&F.autoDismissMs>0&&b(he,F.autoDismissMs),ne},removeToast:I=>{const R=o.find(F=>F.id===I);return R?(g(R),!0):!1},updateToast:(I,R,F,W={})=>{const B=o.find(ne=>ne.id===I);return B?(B.element.textContent=R,f(B.element,F),W.markFinal&&(B.isFinal=!0),W.autoDismissMs&&W.autoDismissMs>0&&b(B,W.autoDismissMs),m(),!0):!1},updateLatestPending:(I,R,F={})=>{const W=[...o].reverse().find(B=>!B.isFinal);return W?(W.element.textContent=I,f(W.element,R),F.markFinal&&(W.isFinal=!0),F.autoDismissMs&&F.autoDismissMs>0&&b(W,F.autoDismissMs),m(),!0):!1},setAnchorElement:I=>{I&&(i=I,s=Date.now(),m())},getToastElements:()=>o.map(I=>I.element)}}function av(n){const{width:e,height:t,data:r}=n,o=new Float32Array(e*t);for(let i=0;i<o.length;i++){const s=i*4,a=r[s],l=r[s+1],d=r[s+2],u=Math.max(a,l,d);o[i]=u/255}return o}const lv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAGVElEQVR4nMVYvXIbNxD+FvKMWInXmd2dK7MTO7sj9QKWS7qy/Ab2o/gNmCp0JyZ9dHaldJcqTHfnSSF1R7kwlYmwKRYA93BHmkrseMcjgzgA++HbH2BBxhhmBiB/RYgo+hkGSFv/ZOY3b94w89u3b6HEL8JEYCYATCAi2JYiQ8xMDADGWsvMbfVagm6ZLxKGPXr0qN/vJ0mSpqn0RzuU//Wu9MoyPqxmtqmXJYwxxpiAQzBF4x8/fiyN4XDYoZLA5LfEhtg0+glMIGZY6wABMMbs4CaiR8brkYIDwGg00uuEMUTQ1MYqPBRRYZjZ+q42nxEsaYiV5VOapkmSSLvX62VZprUyM0DiQACIGLCAESIAEINAAAEOcQdD4a+2FJqmhDd/YEVkMpmEtrU2igCocNHW13swRBQYcl0enxbHpzEhKo0xSZJEgLIsC4Q5HJaJ2Qg7kKBjwMJyCDciBBcw7fjSO4tQapdi5vF43IZ+cnISdh9Y0At2RoZWFNtLsxr8N6CUTgCaHq3g+Pg4TVO1FACSaDLmgMhYC8sEQzCu3/mQjNEMSTvoDs4b+nXny5cvo4lBJpNJmKj9z81VrtNhikCgTsRRfAklmurxeKx9JZIsy548eeITKJgAQwzXJlhDTAwDgrXkxxCD2GfqgEPa4rnBOlApFUC/39fR1CmTyWQwGAQrR8TonMRNjjYpTmPSmUnC8ODgQHqSJDk7O9uNBkCv15tOp4eHh8SQgBICiCGu49YnSUJOiLGJcG2ydmdwnRcvXuwwlpYkSabTaZS1vyimc7R2Se16z58/f/jw4Z5LA8iy7NmzZ8J76CQ25F2UGsEAJjxo5194q0fn9unp6fHx8f5oRCQ1nJ+fbxtA3HAjAmCMCaGuAQWgh4eH0+k0y7LGvPiU3CVXV1fz+by+WQkCJYaImKzL6SEN6uMpjBVMg8FgOp3GfnNPQADqup79MLv59AlWn75E/vAlf20ibmWg0Pn06dPJZNLr9e6nfLu8//Ahv/gFAEdcWEsgZnYpR3uM9KRpOplMGmb6SlLX9Ww2q29WyjH8+SI+pD0GQJIkJycn/8J/I4mWjaQoijzPb25uJJsjmAwqprIsG4/HbVZ2L/1fpCiKoijKqgTRBlCWZcPhcDQafUVfuZfUdb1cLpfL5cePf9Lr16/3zLz/g9T1quNy+F2FiYjSNB0Oh8Ph8HtRtV6vi6JYLpdVVbmb8t3dnSAbjUbRNfmbSlmWeZ6XHytEUQafEo0xR0dHUdjvG2X3Sd/Fb0We56t6BX8l2mTq6BCVnqOjo7Ozs29hRGGlqqrOr40CIKqeiGg8Hn/xcri/rG/XeZ7/evnrjjGbC3V05YC/BSRJ8urVq36/3zX7Hjaq63o+n19fX/upUqe5VxFok7UBtQ+T6XQ6GAz2Vd6Ssizn8/nt7a3ay1ZAYbMN520XkKenpx0B2E2SLOo+FEWxWPwMgMnC3/adejZMYLLS42r7oH4LGodpsVgURdHQuIcURbFYLDYlVKg9sCk5wpWNiHym9pUAEQGG6EAqSxhilRQWi0VZVmrz23yI5cPV1dX5TwsmWGYrb2TW36OJGjdXhryKxEeHvjR2Fgzz+bu6XnVgaHEmXhytEK0W1aUADJPjAL6CtPZv5rsGSvUKtv7r8/zdj+v1uoOUpsxms7qunT6+g1/TvTQCxE6XR2kBqxjyZo6K66gsAXB1fZ3neQdJSvI8X61WpNaMWCFuKNrkGuGGmMm95fhpvPkn/f6lAgAuLy/LstyGpq7r9+8d4rAr443qaln/ehHt1siv3dvt2B/RDpJms5lGE62gEy9az0XGcQCK3DL4DTPr0pPZEjPAZVlusoCSoihWqzpCHy7ODRXhbUTJly9oDr4fKDaV9NZJUrszPOjsI0a/FzfwNt4eHH+BSyICqK7rqqo0u0VRrFYridyN87L3pBYf7qvq3wqc3DMldJmiK06pgi8uLqQjAAorRG+p+zLUxks+z7rOkOzlIUy8yrAcQFVV3a4/ywBPmJsVMcTM3l/h9xDlLga4I1PDGaD7UNBPuCKBleUfy2gd+DOrPWubGHJJyD+L+LCTjEXEgH//2uSxhu1/Xzocy+VSL+2cUhrqLVZ/jTYL0IMtQEklT3/iWCutzUljDDNXVSVHRFWW7SOtccHag6V/AF1/slVRyOkZAAAAAElFTkSuQmCC",cv="/assets/bg_96-C2FFcR6-.png",dv=.002,uv=.99,hv=255;function mv(n,e,t){const{x:r,y:o,width:i,height:s}=t;for(let a=0;a<s;a++)for(let l=0;l<i;l++){const d=((o+a)*n.width+(r+l))*4,u=a*i+l;let m=e[u];if(m<dv)continue;m=Math.min(m,uv);const p=1-m;for(let f=0;f<3;f++){const b=(n.data[d+f]-m*hv)/p;n.data[d+f]=Math.max(0,Math.min(255,Math.round(b)))}}}const Ql=n=>{if(n.startsWith("data:"))return n;try{const e=n.split("/").pop()||n;return chrome.runtime.getURL(`assets/${e}`)}catch{return n}};function ec(n,e){return n>1024&&e>1024?{logoSize:96,marginRight:64,marginBottom:64}:{logoSize:48,marginRight:32,marginBottom:32}}function tc(n,e,t){const{logoSize:r,marginRight:o,marginBottom:i}=t;return{x:n-o-r,y:e-i-r,width:r,height:r}}class ta{bgCaptures;alphaMaps;constructor(e){this.bgCaptures=e,this.alphaMaps={}}static async create(){const e=new Image,t=new Image,r=Ql(lv),o=Ql(cv);return console.log("[Gemini Voyager] Loading watermark assets:",{bg48Path:r,bg96Path:o}),await Promise.all([new Promise((i,s)=>{e.onload=()=>i(),e.onerror=a=>s(new Error(`Failed to load bg_48.png from ${r}: ${a instanceof Event?"Image load error":a}`)),e.crossOrigin="anonymous",e.src=r}),new Promise((i,s)=>{t.onload=()=>i(),t.onerror=a=>s(new Error(`Failed to load bg_96.png from ${o}: ${a instanceof Event?"Image load error":a}`)),t.crossOrigin="anonymous",t.src=o})]),new ta({bg48:e,bg96:t})}async getAlphaMap(e){if(this.alphaMaps[e])return this.alphaMaps[e];const t=e===48?this.bgCaptures.bg48:this.bgCaptures.bg96,r=document.createElement("canvas");r.width=e,r.height=e;const o=r.getContext("2d");if(!o)throw new Error("Failed to get canvas 2d context");o.drawImage(t,0,0);const i=o.getImageData(0,0,e,e),s=av(i);return this.alphaMaps[e]=s,s}async removeWatermarkFromImage(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const r=t.getContext("2d");if(!r)throw new Error("Failed to get canvas 2d context");r.drawImage(e,0,0);const o=r.getImageData(0,0,t.width,t.height),i=ec(t.width,t.height),s=tc(t.width,t.height,i),a=await this.getAlphaMap(i.logoSize);return mv(o,a,s),r.putImageData(o,0,0),t}getWatermarkInfo(e,t){const r=ec(e,t),o=tc(e,t,r);return{size:r.logoSize,position:o,config:r}}}let Gr=null;const Bi=new Set,pv=(n,e)=>{let t=null;return((...r)=>{t&&clearTimeout(t),t=setTimeout(()=>n(...r),e)})},fv=async n=>new Promise((e,t)=>{chrome.runtime.sendMessage({type:"gv.fetchImage",url:n},r=>{if(chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}if(!r||!r.ok){t(new Error(r?.error||"Failed to fetch image"));return}const o=new Image;o.onload=()=>e(o),o.onerror=()=>t(new Error("Failed to decode image")),o.crossOrigin="anonymous",o.src=`data:${r.contentType};base64,${r.base64}`})}),gv=(n,e="image/png")=>new Promise((t,r)=>{n.toBlob(o=>{o?t(o):r(new Error("Failed to convert canvas to blob"))},e)}),bv=(n,e="image/png")=>n.toDataURL(e),vv=n=>n.closest("generated-image,.generated-image-container")!==null,yv=()=>[...document.querySelectorAll('img[src*="googleusercontent.com"]')].filter(n=>vv(n)&&n.dataset.watermarkProcessed!=="true"),wv=n=>n.replace(/=s\d+(?=[-?#]|$)/,"=s0");function Nd(n){const e=n.closest("generated-image,.generated-image-container");if(!e)return;const r=e.querySelector(As)?.closest("button");if(!r||e.querySelector(".nanobanana-indicator"))return;const o=document.createElement("span");o.className="nanobanana-indicator",o.textContent="ğŸŒ",o.title=chrome.i18n.getMessage("nanobananaDownloadTooltip")||"NanoBanana: Downloads will have watermark removed",Object.assign(o.style,{position:"absolute",top:"-4px",right:"-4px",fontSize:"12px",pointerEvents:"none",zIndex:"10",filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.3))"});const i=r.parentElement;i&&(getComputedStyle(i).position==="static"&&(i.style.position="relative"),i.appendChild(o))}async function xv(n){if(!Gr||Bi.has(n))return;Bi.add(n),n.dataset.watermarkProcessed="processing";const e=n.src;try{const t=wv(e),r=await fv(t),o=await Gr.removeWatermarkFromImage(r),i=await gv(o),s=URL.createObjectURL(i);n.src=s,n.dataset.watermarkProcessed="true",n.dataset.processedUrl=s,console.log("[Gemini Voyager] Watermark removed from preview image"),Nd(n)}catch(t){console.warn("[Gemini Voyager] Failed to process image for watermark removal:",t),n.dataset.watermarkProcessed="failed"}finally{Bi.delete(n)}}const Fd=()=>{yv().forEach(xv),document.querySelectorAll('img[data-watermark-processed="true"]').forEach(t=>{Nd(t)})},Sv=()=>{const n=pv(Fd,100);new MutationObserver(n).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","src"]}),console.log("[Gemini Voyager] Watermark remover MutationObserver active")},nc="gv-watermark-bridge";function Yo(){let n=document.getElementById(nc);return n||(n=document.createElement("div"),n.id=nc,n.style.display="none",document.documentElement.appendChild(n)),n}function Ev(n){const e=Yo();e.dataset.enabled=String(n)}function Cv(){const n=Yo();new MutationObserver(async()=>{const t=n.dataset.request;if(t){n.removeAttribute("data-request");try{const{requestId:r,base64:o}=JSON.parse(t);await Tv(r,o,n)}catch(r){console.error("[Gemini Voyager] Failed to parse request:",r)}}}).observe(n,{attributes:!0,attributeFilter:["data-request"]}),console.log("[Gemini Voyager] Fetch interceptor bridge ready")}async function Tv(n,e,t){if(!Gr){t.dataset.response=JSON.stringify({requestId:n,error:"Watermark engine not initialized"});return}try{const r=new Image;await new Promise((s,a)=>{r.onload=()=>s(),r.onerror=()=>a(new Error("Failed to load image")),r.crossOrigin="anonymous",r.src=e});const o=await Gr.removeWatermarkFromImage(r),i=bv(o);t.dataset.response=JSON.stringify({requestId:n,base64:i})}catch(r){console.error("[Gemini Voyager] Failed to process image:",r),t.dataset.response=JSON.stringify({requestId:n,error:String(r)})}}async function _v(){try{Yo();const e=(await chrome.storage?.sync?.get({geminiWatermarkRemoverEnabled:!0}))?.geminiWatermarkRemoverEnabled!==!1;if(Ev(e),!e){console.log("[Gemini Voyager] Watermark remover is disabled");return}Dv(),Lv(),console.log("[Gemini Voyager] Initializing watermark remover..."),Gr=await ta.create(),Cv(),Fd(),Sv(),console.log("[Gemini Voyager] Watermark remover ready")}catch(n){if(Ct(n))return;console.error("[Gemini Voyager] Watermark remover initialization failed:",n)}}let $i=null,rc=!1,oc=0,kv=0;const Av=8e3,Od=35e3;let Me=null;const Rd=()=>($i||($i=sv({maxToasts:4,anchorTtlMs:3e4})),$i),wn=(n,e)=>{const t=Ke(n);return t===n?e:t};function Iv(n){const e=Date.now();if(e-oc<300)return;oc=e;const t=Rd();t.setAnchorElement(n);const r=wn("downloadingOriginal","æ­£åœ¨ä¸‹è½½åŸå§‹å›¾ç‰‡"),o=wn("downloadProcessing","æ­£åœ¨å¤„ç†æ°´å°ä¸­");Me?.processingTimer&&clearTimeout(Me.processingTimer);const i=++kv,s=t.addToast(r,"info",{autoDismissMs:3e3}),a=setTimeout(()=>{!Me||Me.id!==i||(Me.downloadToastId&&(t.removeToast(Me.downloadToastId),Me.downloadToastId=null),Me.processingToastId||(Me.processingToastId=t.addToast(o,"info",{pending:!0,autoDismissMs:Od})))},3e3);Me={id:i,downloadToastId:s,warningToastId:null,processingToastId:null,processingTimer:a}}function Lv(){if(rc)return;rc=!0;const n=e=>{const t=rv(e.target);t&&Iv(t)};document.addEventListener("pointerdown",n,!0),document.addEventListener("click",n,!0)}function Dv(){const n=Yo(),e=Rd(),t=wn("downloadingOriginal","æ­£åœ¨ä¸‹è½½åŸå§‹å›¾ç‰‡"),r=wn("downloadingOriginalLarge","æ­£åœ¨ä¸‹è½½åŸå§‹å›¾ç‰‡ï¼ˆå¤§æ–‡ä»¶ï¼‰"),o=wn("downloadLargeWarning","å¤§æ–‡ä»¶è­¦å‘Š"),i=wn("downloadProcessing","æ­£åœ¨å¤„ç†æ°´å°ä¸­"),s=wn("downloadSuccess","æ­£åœ¨ä¸‹è½½"),a=wn("downloadError","å¤±è´¥"),l=(m,p)=>{Me?.processingTimer&&(clearTimeout(Me.processingTimer),Me.processingTimer=null),Me?.warningToastId&&(e.removeToast(Me.warningToastId),Me.warningToastId=null),Me?.downloadToastId&&(e.removeToast(Me.downloadToastId),Me.downloadToastId=null),!(Me?.processingToastId&&e.updateToast(Me.processingToastId,p,m,{autoDismissMs:m==="success"?2500:4e3,markFinal:!0}))&&(e.updateLatestPending(p,m,{autoDismissMs:m==="success"?2500:4e3,markFinal:!0})||e.addToast(p,m,{autoDismissMs:m==="success"?2500:4e3}))},d=m=>{if(console.log("[Gemini Voyager] Status data received:",m),!!m)try{const{type:p,message:f}=JSON.parse(m);switch(n.removeAttribute("data-status"),p){case"DOWNLOADING":Me&&(Me.warningToastId&&(e.removeToast(Me.warningToastId),Me.warningToastId=null),Me.downloadToastId||(Me.downloadToastId=e.addToast(t,"info",{autoDismissMs:3e3})));break;case"DOWNLOADING_LARGE":Me&&(Me.downloadToastId?e.updateToast(Me.downloadToastId,r,"info"):Me.downloadToastId=e.addToast(r,"info",{autoDismissMs:3e3}),Me.warningToastId||(Me.warningToastId=e.addToast(o,"warning",{autoDismissMs:Av})));break;case"PROCESSING":if(Me?.processingToastId){e.updateToast(Me.processingToastId,i,"info");break}if(!Me?.processingTimer){const g=e.addToast(i,"info",{pending:!0,autoDismissMs:Od});Me&&(Me.processingToastId=g)}break;case"SUCCESS":l("success",s);break;case"ERROR":l("error",`${a}: ${f}`);break}}catch(p){console.error("[Gemini Voyager] Failed to parse status:",p)}};new MutationObserver(()=>{const m=n.dataset.status;m&&d(m)}).observe(n,{attributes:!0,attributeFilter:["data-status"]}),n.dataset.status&&d(n.dataset.status)}window.addEventListener("vite:preloadError",n=>{n.preventDefault()});const vo=100,it=50,ic=3e3,Mv=8e3;let Is=!1,Br=null,_o=null,er=null,ko=null,Ao=null;async function Nv(){try{const n=await chrome.storage?.sync?.get({gvPromptCustomWebsites:[]}),e=Array.isArray(n?.gvPromptCustomWebsites)?n.gvPromptCustomWebsites:[],t=location.hostname.toLowerCase().replace(/^www\./,"");console.log("[Gemini Voyager] Checking custom websites:",{currentHost:t,customWebsites:e,hostname:location.hostname});const r=e.some(o=>{const i=o.toLowerCase().replace(/^www\./,""),s=t===i||t.endsWith("."+i);return console.log("[Gemini Voyager] Comparing:",{currentHost:t,normalizedWebsite:i,matches:s}),s});return console.log("[Gemini Voyager] Is custom website:",r),r}catch(n){return Ct(n)||console.error("[Gemini Voyager] Error checking custom websites:",n),!1}}async function Io(){if(!Is){Is=!0;try{if(!Ls())return;const n=r=>new Promise(o=>setTimeout(o,r));if(await Nv()){console.log("[Gemini Voyager] Custom website detected, starting Prompt Manager only"),er=await Ti();return}if(console.log("[Gemini Voyager] Not a custom website, checking for Gemini/AI Studio"),ru({hostname:location.hostname,pathname:location.pathname,search:location.search,hash:location.hash},document)){console.log("[Gemini Voyager] Gemini Enterprise detected, starting Prompt Manager only"),er=await Ti();return}location.hostname==="gemini.google.com"&&(Jb(),await n(vo),_o=await Vf(),await n(vo),yl("gemini"),await n(it),fm(),await n(it),cf(),await n(it),Yb(),await n(it),qb(),await n(it),mg(),await n(it),za(),await n(it),(await new Promise(o=>{try{chrome.storage?.sync?.get({gvQuoteReplyEnabled:!0},o)}catch{o({gvQuoteReplyEnabled:!0})}})).gvQuoteReplyEnabled!==!1&&(ko=ib()),await n(it),en()||_v(),await n(it),Qb(),await n(it),nf(),await n(it),bm(),await n(it),Ao=await Cb(),await n(it),hb(),await n(it),sg(),await n(it),bg(),await n(it),Wn.getInstance().init(),await n(it)),(location.hostname==="gemini.google.com"||location.hostname==="aistudio.google.com"||location.hostname==="aistudio.google.cn")&&(er=await Ti(),await n(vo),_g(),await n(it)),(location.hostname==="aistudio.google.com"||location.hostname==="aistudio.google.cn")&&(Pf(),await n(vo),yl("aistudio"),await n(it),za(),await n(it)),Df()}catch(n){if(Ct(n))return;console.error("[Gemini Voyager] Initialization error:",n)}}}function Fv(){if(document.visibilityState==="visible")return console.log("[Gemini Voyager] Foreground tab detected, initializing immediately"),0;{const e=Mv-ic,t=ic+Math.random()*e;return console.log(`[Gemini Voyager] Background tab detected, delaying initialization by ${Math.round(t)}ms`),t}}function Ov(){document.visibilityState==="visible"&&!Is&&(Br!==null&&(clearTimeout(Br),Br=null,console.log("[Gemini Voyager] Tab became visible, initializing immediately")),Io())}(function(){try{if(!Ls())return;const n=i=>{Ct(i.reason)&&i.preventDefault()},e=i=>{Ct(i.error??i.message)&&i.preventDefault()};window.addEventListener("unhandledrejection",n),window.addEventListener("error",e);const t=location.hostname.toLowerCase(),r=t.includes("gemini.google.com")||t.includes("business.gemini.google")||t.includes("aistudio.google.com")||t.includes("aistudio.google.cn");if(r&&(gg(),jr().catch(i=>console.error("[Gemini Voyager] i18n init error:",i))),!r){chrome.storage?.sync?.get({gvPromptCustomWebsites:[]},i=>{const s=Array.isArray(i?.gvPromptCustomWebsites)?i.gvPromptCustomWebsites:[],a=t.replace(/^www\./,"");s.some(d=>{const u=d.toLowerCase().replace(/^www\./,"");return a===u||a.endsWith("."+u)})?(console.log("[Gemini Voyager] Custom website detected:",t),Io()):console.log("[Gemini Voyager] Not a supported website, skipping initialization")});return}const o=Fv();o===0?Io():Br=window.setTimeout(()=>{Br=null,Io()},o),document.addEventListener("visibilitychange",Ov),window.addEventListener("beforeunload",()=>{try{window.removeEventListener("unhandledrejection",n),window.removeEventListener("error",e),_o&&(_o.destroy(),_o=null),er&&(er.destroy(),er=null),ko&&(ko(),ko=null),Ao&&(Ao(),Ao=null)}catch(i){if(Ct(i))return;console.error("[Gemini Voyager] Cleanup error:",i)}})}catch(n){if(Ct(n))return;console.error("[Gemini Voyager] Fatal initialization error:",n)}})();export{Qe as _,Bl as p};
